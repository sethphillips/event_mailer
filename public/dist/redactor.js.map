{"version":3,"sources":["_redactor.js","all.js","codemirror.js","filemanager.js","fullscreen.js","imagemanager.js","inlinestyle.js","source.js","table.js"],"names":[],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC74UA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC7hXA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACpNA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AChEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC9JA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC3DA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACjEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACpMA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"redactor.js","sourcesContent":["/*\n\tRedactor II\n\tVersion 1.3.1\n\tUpdated: October 24, 2016\n\n\thttp://imperavi.com/redactor/\n\n\tCopyright (c) 2009-2016, Imperavi Oy.\n\tLicense: http://imperavi.com/redactor/license/\n\n\tUsage: $('#content').redactor();\n*/\n\n(function($)\n{\n\t'use strict';\n\n\tif (!Function.prototype.bind)\n\t{\n\t\tFunction.prototype.bind = function(scope)\n\t\t{\n\t\t\tvar fn = this;\n\t\t\treturn function()\n\t\t\t{\n\t\t\t\treturn fn.apply(scope);\n\t\t\t};\n\t\t};\n\t}\n\n\tvar uuid = 0;\n\n\t// Plugin\n\t$.fn.redactor = function(options)\n\t{\n\t\tvar val = [];\n\t\tvar args = Array.prototype.slice.call(arguments, 1);\n\n\t\tif (typeof options === 'string')\n\t\t{\n\t\t\tthis.each(function()\n\t\t\t{\n\t\t\t\tvar instance = $.data(this, 'redactor');\n\t\t\t\tvar func;\n\n\t\t\t\tif (options.search(/\\./) !== '-1')\n\t\t\t\t{\n\t\t\t\t\tfunc = options.split('.');\n\t\t\t\t\tif (typeof instance[func[0]] !== 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\tfunc = instance[func[0]][func[1]];\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tfunc = instance[options];\n\t\t\t\t}\n\n\t\t\t\tif (typeof instance !== 'undefined' && $.isFunction(func))\n\t\t\t\t{\n\t\t\t\t\tvar methodVal = func.apply(instance, args);\n\t\t\t\t\tif (methodVal !== undefined && methodVal !== instance)\n\t\t\t\t\t{\n\t\t\t\t\t\tval.push(methodVal);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t$.error('No such method \"' + options + '\" for Redactor');\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.each(function()\n\t\t\t{\n\t\t\t\t$.data(this, 'redactor', {});\n\t\t\t\t$.data(this, 'redactor', Redactor(this, options));\n\t\t\t});\n\t\t}\n\n\t\tif (val.length === 0)\n\t\t{\n\t\t\treturn this;\n\t\t}\n\t\telse if (val.length === 1)\n\t\t{\n\t\t\treturn val[0];\n\t\t}\n\t\telse\n\t\t{\n\t\t\treturn val;\n\t\t}\n\n\t};\n\n\t// Initialization\n\tfunction Redactor(el, options)\n\t{\n\t\treturn new Redactor.prototype.init(el, options);\n\t}\n\n\t// Options\n\t$.Redactor = Redactor;\n\t$.Redactor.VERSION = '1.3.1';\n\t$.Redactor.modules = ['air', 'autosave', 'block', 'buffer', 'build', 'button', 'caret', 'clean', 'code', 'core', 'detect', 'dropdown',\n\t\t\t\t\t\t  'events', 'file', 'focus', 'image', 'indent', 'inline', 'insert', 'keydown', 'keyup',\n\t\t\t\t\t\t  'lang', 'line', 'link', 'linkify', 'list', 'marker', 'modal', 'observe', 'offset', 'paragraphize', 'paste', 'placeholder',\n\t\t\t\t\t\t  'progress', 'selection', 'shortcuts', 'storage', 'toolbar', 'upload', 'uploads3', 'utils',\n\n\t\t\t\t\t\t  'browser' // deprecated\n\t\t\t\t\t\t  ];\n\n\t$.Redactor.settings = {};\n\t$.Redactor.opts = {\n\n\t\t// settings\n\t\tanimation: false,\n\t\tlang: 'en',\n\t\tdirection: 'ltr',\n\t\tspellcheck: true,\n\n\t\tfocus: false,\n\t\tfocusEnd: false,\n\n\t\tclickToEdit: false,\n\t\tstructure: false,\n\n\t\ttabindex: false,\n\n\t\tminHeight: false, // string\n\t\tmaxHeight: false, // string\n\n\t\tmaxWidth: false, // string\n\n\t\tplugins: false, // array\n\t\tcallbacks: {},\n\n\t\tplaceholder: false,\n\n\t\tlinkify: true,\n\t\tenterKey: true,\n\n\t\tpastePlainText: false,\n\t\tpasteImages: true,\n\t\tpasteLinks: true,\n\t\tpasteBlockTags: ['pre', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'table', 'tbody', 'thead', 'tfoot', 'th', 'tr', 'td', 'ul', 'ol', 'li', 'blockquote', 'p', 'figure', 'figcaption'],\n\t\tpasteInlineTags: ['br', 'strong', 'ins', 'code', 'del', 'span', 'samp', 'kbd', 'sup', 'sub', 'mark', 'var', 'cite', 'small', 'b', 'u', 'em', 'i'],\n\n\t\tpreClass: false, // string\n\t\tpreSpaces: 4, // or false\n\t\ttabAsSpaces: false, // true or number of spaces\n\t\ttabKey: true,\n\n\t\tautosave: false, // false or url\n\t\tautosaveName: false,\n\t\tautosaveFields: false,\n\n\t\timageUpload: null,\n\t\timageUploadParam: 'file',\n\t\timageUploadFields: false,\n\t\timageUploadForms: false,\n        imageTag: 'figure',\n        imageEditable: true,\n\t\timageCaption: true,\n\n\t\timagePosition: false,\n\t\timageResizable: false,\n\t\timageFloatMargin: '10px',\n\n\t\tdragImageUpload: true,\n\t\tmultipleImageUpload: true,\n\t\tclipboardImageUpload: true,\n\n\t\tfileUpload: null,\n\t\tfileUploadParam: 'file',\n\t\tfileUploadFields: false,\n\t\tfileUploadForms: false,\n\t\tdragFileUpload: true,\n\n\t\ts3: false,\n\n        linkNewTab: false,\n\t\tlinkTooltip: true,\n\t\tlinkNofollow: false,\n\t\tlinkSize: 30,\n\t\tpasteLinkTarget: false,\n\n\t\tvideoContainerClass: 'video-container',\n\n\t\ttoolbar: true,\n\t\ttoolbarFixed: true,\n\t\ttoolbarFixedTarget: document,\n\t\ttoolbarFixedTopOffset: 0, // pixels\n\t\ttoolbarExternal: false, // ID selector\n\n\t\tair: false,\n\t\tairWidth: false,\n\n\t\tformatting: ['p', 'blockquote', 'pre', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6'],\n\t\tformattingAdd: false,\n\n\t\tbuttons: ['format', 'bold', 'italic', 'deleted', 'lists', 'image', 'file', 'link'], // + 'horizontalrule', 'underline', 'ol', 'ul', 'indent', 'outdent'\n\n\t\tbuttonsHide: [],\n\t\tbuttonsHideOnMobile: [],\n\n\t\tscript: true,\n\t\tremoveComments: true,\n\t\treplaceTags: {\n\t\t\t'b': 'strong',\n\t\t\t'i': 'em',\n\t\t\t'strike': 'del'\n\t\t},\n\n\t\t// shortcuts\n\t\tshortcuts: {\n\t\t\t'ctrl+shift+m, meta+shift+m': { func: 'inline.removeFormat' },\n\t\t\t'ctrl+b, meta+b': { func: 'inline.format', params: ['bold'] },\n\t\t\t'ctrl+i, meta+i': { func: 'inline.format', params: ['italic'] },\n\t\t\t'ctrl+h, meta+h': { func: 'inline.format', params: ['superscript'] },\n\t\t\t'ctrl+l, meta+l': { func: 'inline.format', params: ['subscript'] },\n\t\t\t'ctrl+k, meta+k': { func: 'link.show' },\n\t\t\t'ctrl+shift+7':   { func: 'list.toggle', params: ['orderedlist'] },\n\t\t\t'ctrl+shift+8':   { func: 'list.toggle', params: ['unorderedlist'] }\n\t\t},\n\t\tshortcutsAdd: false,\n\n\t\tactiveButtons: ['deleted', 'italic', 'bold'],\n\t\tactiveButtonsStates: {\n\t\t\tb: 'bold',\n\t\t\tstrong: 'bold',\n\t\t\ti: 'italic',\n\t\t\tem: 'italic',\n\t\t\tdel: 'deleted',\n\t\t\tstrike: 'deleted'\n\t\t},\n\n\t\t// private lang\n\t\tlangs: {\n\t\t\ten: {\n\n\t\t\t\t\"format\": \"Format\",\n\t\t\t\t\"image\": \"Image\",\n\t\t\t\t\"file\": \"File\",\n\t\t\t\t\"link\": \"Link\",\n\t\t\t\t\"bold\": \"Bold\",\n\t\t\t\t\"italic\": \"Italic\",\n\t\t\t\t\"deleted\": \"Strikethrough\",\n\t\t\t\t\"underline\": \"Underline\",\n\t\t\t\t\"bold-abbr\": \"B\",\n\t\t\t\t\"italic-abbr\": \"I\",\n\t\t\t\t\"deleted-abbr\": \"S\",\n\t\t\t\t\"underline-abbr\": \"U\",\n\t\t\t\t\"lists\": \"Lists\",\n\t\t\t\t\"link-insert\": \"Insert link\",\n\t\t\t\t\"link-edit\": \"Edit link\",\n\t\t\t\t\"link-in-new-tab\": \"Open link in new tab\",\n\t\t\t\t\"unlink\": \"Unlink\",\n\t\t\t\t\"cancel\": \"Cancel\",\n\t\t\t\t\"close\": \"Close\",\n\t\t\t\t\"insert\": \"Insert\",\n\t\t\t\t\"save\": \"Save\",\n\t\t\t\t\"delete\": \"Delete\",\n\t\t\t\t\"text\": \"Text\",\n\t\t\t\t\"edit\": \"Edit\",\n\t\t\t\t\"title\": \"Title\",\n\t\t\t\t\"paragraph\": \"Normal text\",\n\t\t\t\t\"quote\": \"Quote\",\n\t\t\t\t\"code\": \"Code\",\n\t\t\t\t\"heading1\": \"Heading 1\",\n\t\t\t\t\"heading2\": \"Heading 2\",\n\t\t\t\t\"heading3\": \"Heading 3\",\n\t\t\t\t\"heading4\": \"Heading 4\",\n\t\t\t\t\"heading5\": \"Heading 5\",\n\t\t\t\t\"heading6\": \"Heading 6\",\n\t\t\t\t\"filename\": \"Name\",\n\t\t\t\t\"optional\": \"optional\",\n\t\t\t\t\"unorderedlist\": \"Unordered List\",\n\t\t\t\t\"orderedlist\": \"Ordered List\",\n\t\t\t\t\"outdent\": \"Outdent\",\n\t\t\t\t\"indent\": \"Indent\",\n\t\t\t\t\"horizontalrule\": \"Line\",\n\t\t\t\t\"upload-label\": \"Drop file here or \",\n\t\t\t\t\"caption\": \"Caption\",\n\n\t\t\t\t\"bulletslist\": \"Bullets\",\n\t\t\t\t\"numberslist\": \"Numbers\",\n\n\t\t\t\t\"image-position\": \"Position\",\n\t\t\t\t\"none\": \"None\",\n\t\t\t\t\"left\": \"Left\",\n\t\t\t\t\"right\": \"Right\",\n\t\t\t\t\"center\": \"Center\",\n\n\t\t\t\t\"accessibility-help-label\": \"Rich text editor\"\n\t\t\t}\n\t\t},\n\n\t\t// private\n\t\ttype: 'textarea', // textarea, div, inline, pre\n\t\tinline: false,\n\t\tbuffer: [],\n\t\trebuffer: [],\n\t\tinlineTags: ['a', 'span', 'strong', 'strike', 'b', 'u', 'em', 'i', 'code', 'del', 'ins', 'samp', 'kbd', 'sup', 'sub', 'mark', 'var', 'cite', 'small'],\n\t\tblockTags: ['pre', 'ul', 'ol', 'li', 'p', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6',  'dl', 'dt', 'dd', 'div', 'td', 'blockquote', 'output', 'figcaption', 'figure', 'address', 'section', 'header', 'footer', 'aside', 'article', 'iframe'],\n\t\tparagraphize: true,\n\t\tparagraphizeBlocks: ['table', 'div', 'pre', 'form', 'ul', 'ol', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'dl', 'blockquote', 'figcaption',\n\t\t\t\t\t\t\t'address', 'section', 'header', 'footer', 'aside', 'article', 'object', 'style', 'script', 'iframe', 'select', 'input', 'textarea',\n\t\t\t\t\t\t\t'button', 'option', 'map', 'area', 'math', 'hr', 'fieldset', 'legend', 'hgroup', 'nav', 'figure', 'details', 'menu', 'summary', 'p'],\n\t\temptyHtml: '<p>&#x200b;</p>',\n\t\tinvisibleSpace: '&#x200b;',\n\t\timageTypes: ['image/png', 'image/jpeg', 'image/gif'],\n\t\tuserAgent: navigator.userAgent.toLowerCase(),\n\t\tobserve: {\n\t\t\tdropdowns: []\n\t\t},\n\t\tregexps: {\n\t\t\tlinkyoutube: /https?:\\/\\/(?:[0-9A-Z-]+\\.)?(?:youtu\\.be\\/|youtube\\.com\\S*[^\\w\\-\\s])([\\w\\-]{11})(?=[^\\w\\-]|$)(?![?=&+%\\w.\\-]*(?:['\"][^<>]*>|<\\/a>))[?=&+%\\w.-]*/ig,\n\t\t\tlinkvimeo: /https?:\\/\\/(www\\.)?vimeo.com\\/(\\d+)($|\\/)/,\n\t\t\tlinkimage: /((https?|www)[^\\s]+\\.)(jpe?g|png|gif)(\\?[^\\s-]+)?/ig,\n\t\t\turl: /(https?:\\/\\/(?:www\\.|(?!www))[^\\s\\.]+\\.[^\\s]{2,}|www\\.[^\\s]+\\.[^\\s]{2,})/ig\n\t\t}\n\n\t};\n\n\t// Functionality\n\tRedactor.fn = $.Redactor.prototype = {\n\n\t\tkeyCode: {\n\t\t\tBACKSPACE: 8,\n\t\t\tDELETE: 46,\n\t\t\tUP: 38,\n\t\t\tDOWN: 40,\n\t\t\tENTER: 13,\n\t\t\tSPACE: 32,\n\t\t\tESC: 27,\n\t\t\tTAB: 9,\n\t\t\tCTRL: 17,\n\t\t\tMETA: 91,\n\t\t\tSHIFT: 16,\n\t\t\tALT: 18,\n\t\t\tRIGHT: 39,\n\t\t\tLEFT: 37,\n\t\t\tLEFT_WIN: 91\n\t\t},\n\n\t\t// =init\n\t\tinit: function(el, options)\n\t\t{\n\t\t\tthis.$element = $(el);\n\t\t\tthis.uuid = uuid++;\n\n\t\t\tthis.loadOptions(options);\n\t\t\tthis.loadModules();\n\n\t\t\t// click to edit\n\t\t\tif (this.opts.clickToEdit && !this.$element.hasClass('redactor-click-to-edit'))\n\t\t\t{\n\t\t\t\treturn this.loadToEdit(options);\n\t\t\t}\n\t\t\telse if (this.$element.hasClass('redactor-click-to-edit'))\n\t\t\t{\n\t\t\t\tthis.$element.removeClass('redactor-click-to-edit');\n\t\t\t}\n\n\t\t\t// block & inline test tag regexp\n\t\t\tthis.reIsBlock = new RegExp('^(' + this.opts.blockTags.join('|' ).toUpperCase() + ')$', 'i');\n\t\t\tthis.reIsInline = new RegExp('^(' + this.opts.inlineTags.join('|' ).toUpperCase() + ')$', 'i');\n\n\t\t\t// set up drag upload\n\t\t\tthis.opts.dragImageUpload = (this.opts.imageUpload === null) ? false : this.opts.dragImageUpload;\n\t\t\tthis.opts.dragFileUpload = (this.opts.fileUpload === null) ? false : this.opts.dragFileUpload;\n\n\t\t\t// formatting storage\n\t\t\tthis.formatting = {};\n\n\t\t\t// load lang\n\t\t\tthis.lang.load();\n\n\t\t\t// extend shortcuts\n\t\t\t$.extend(this.opts.shortcuts, this.opts.shortcutsAdd);\n\n\t\t\t// set editor\n\t\t\tthis.$editor = this.$element;\n\n\t\t\t// detect type of editor\n\t\t\tthis.detectType();\n\n\t\t\t// start callback\n\t\t\tthis.core.callback('start');\n\t\t\tthis.core.callback('startToEdit');\n\n\t\t\t// build\n\t\t\tthis.start = true;\n\t\t\tthis.build.start();\n\n\t\t},\n\t\tdetectType: function()\n\t\t{\n\t\t\tif (this.build.isInline() || this.opts.inline)\n\t\t\t{\n\t\t\t\tthis.opts.type = 'inline';\n\t\t\t}\n\t\t\telse if (this.build.isTag('DIV'))\n\t\t\t{\n\t\t\t\tthis.opts.type = 'div';\n\t\t\t}\n\t\t\telse if (this.build.isTag('PRE'))\n\t\t\t{\n\t\t\t\tthis.opts.type = 'pre';\n\t\t\t}\n\t\t},\n\t\tloadToEdit: function(options)\n\t\t{\n\n\t\t\tthis.$element.on('click.redactor-click-to-edit', $.proxy(function()\n\t\t\t{\n\t\t\t\tthis.initToEdit(options);\n\n\t\t\t}, this));\n\n\t\t\tthis.$element.addClass('redactor-click-to-edit');\n\n\t\t\treturn;\n\t\t},\n\t\tinitToEdit: function(options)\n\t\t{\n\t\t\t$.extend(options.callbacks,  {\n\t\t\t\tstartToEdit: function()\n\t\t\t\t{\n\t\t\t\t\tthis.insert.node(this.marker.get(), false);\n\t\t\t\t},\n\t\t\t\tinitToEdit: function()\n\t\t\t\t{\n\t\t\t\t\tthis.selection.restore();\n\t\t\t\t\tthis.clickToCancelStorage = this.code.get();\n\n\t\t\t\t\t// cancel\n\t\t\t\t\t$(this.opts.clickToCancel).off('.redactor-click-to-edit');\n\t\t\t\t\t$(this.opts.clickToCancel).show().on('click.redactor-click-to-edit', $.proxy(function(e)\n\t\t\t\t\t{\n\t\t\t\t\t\te.preventDefault();\n\n\t\t\t\t\t\tthis.core.destroy();\n\t\t\t\t\t\tthis.events.syncFire = false;\n\t\t\t\t\t\tthis.$element.html(this.clickToCancelStorage);\n\t\t\t\t\t\tthis.core.callback('cancel', this.clickToCancelStorage);\n\t\t\t\t\t\tthis.events.syncFire = true;\n\t\t\t\t\t\tthis.clickToCancelStorage = '';\n\t\t\t\t\t\t$(this.opts.clickToCancel).hide();\n\t\t\t\t\t\t$(this.opts.clickToSave).hide();\n\n\t\t\t\t\t\tthis.$element.on('click.redactor-click-to-edit', $.proxy(function()\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.initToEdit(options);\n\t\t\t\t\t\t}, this));\n\n\t\t\t\t\t\tthis.$element.addClass('redactor-click-to-edit');\n\n\t\t\t\t\t}, this));\n\n\t\t\t\t\t// save\n\t\t\t\t\t$(this.opts.clickToSave).off('.redactor-click-to-edit');\n\t\t\t\t\t$(this.opts.clickToSave).show().on('click.redactor-click-to-edit', $.proxy(function(e)\n\t\t\t\t\t{\n\t\t\t\t\t\te.preventDefault();\n\n\t\t\t\t\t\tthis.core.destroy();\n\t\t\t\t\t\tthis.core.callback('save', this.code.get());\n\t\t\t\t\t\t$(this.opts.clickToCancel).hide();\n\t\t\t\t\t\t$(this.opts.clickToSave).hide();\n\t\t\t\t\t\tthis.$element.on('click.redactor-click-to-edit', $.proxy(function()\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.initToEdit(options);\n\t\t\t\t\t\t}, this));\n\t\t\t\t\t\tthis.$element.addClass('redactor-click-to-edit');\n\n\t\t\t\t\t}, this));\n\t\t\t\t}\n\n\t\t\t});\n\n\t\t\tthis.$element.redactor(options);\n\t\t\tthis.$element.off('.redactor-click-to-edit');\n\n\t\t},\n\t\tloadOptions: function(options)\n\t\t{\n\t\t\tvar settings = {};\n\n\t\t\t// check namespace\n\t\t\tif (typeof $.Redactor.settings.namespace !== 'undefined')\n\t\t\t{\n\t\t\t\t if (this.$element.hasClass($.Redactor.settings.namespace))\n\t\t\t\t {\n\t\t\t\t\t settings = $.Redactor.settings;\n\t\t\t\t }\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tsettings = $.Redactor.settings;\n\t\t\t}\n\n\t\t\tthis.opts = $.extend(\n\t\t\t\t{},\n\t\t\t\t$.extend(true, {}, $.Redactor.opts),\n\t\t\t\t$.extend(true, {}, settings),\n\t\t\t\tthis.$element.data(),\n\t\t\t\toptions\n\t\t\t);\n\n\t\t},\n\t\tgetModuleMethods: function(object)\n\t\t{\n\t\t\treturn Object.getOwnPropertyNames(object).filter(function(property)\n\t\t\t{\n\t\t\t\treturn typeof object[property] === 'function';\n\t\t\t});\n\t\t},\n\t\tloadModules: function()\n\t\t{\n\t\t\tvar len = $.Redactor.modules.length;\n\t\t\tfor (var i = 0; i < len; i++)\n\t\t\t{\n\t\t\t\tthis.bindModuleMethods($.Redactor.modules[i]);\n\t\t\t}\n\t\t},\n\t\tbindModuleMethods: function(module)\n\t\t{\n\t\t\tif (typeof this[module] === 'undefined')\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// init module\n\t\t\tthis[module] = this[module]();\n\n\t\t\tvar methods = this.getModuleMethods(this[module]);\n\t\t\tvar len = methods.length;\n\n\t\t\t// bind methods\n\t\t\tfor (var z = 0; z < len; z++)\n\t\t\t{\n\t\t\t\tthis[module][methods[z]] = this[module][methods[z]].bind(this);\n\t\t\t}\n\t\t},\n\n\t\t// =air\n\t\tair: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tenabled: false,\n\t\t\t\tcollapsed: function()\n\t\t\t\t{\n\t\t\t\t\tif (this.opts.air)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.selection.get().collapseToStart();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tcollapsedEnd: function()\n\t\t\t\t{\n\t\t\t\t\tif (this.opts.air)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.selection.get().collapseToEnd();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tbuild: function()\n\t\t\t\t{\n\t\t\t\t\tif (this.detect.isMobile())\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.button.hideButtons();\n\t\t\t\t\tthis.button.hideButtonsOnMobile();\n\n\t\t\t\t\tif (this.opts.buttons.length === 0)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.$air = this.air.createContainer();\n\n\t\t\t\t\tif (this.opts.airWidth !== false)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.$air.css('width', this.opts.airWidth);\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.air.append();\n\t\t\t\t\tthis.button.$toolbar = this.$air;\n\t\t\t\t\tthis.button.setFormatting();\n\t\t\t\t\tthis.button.load(this.$air);\n\n\t\t\t\t\tthis.core.editor().on('mouseup.redactor', this, $.proxy(function(e)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (this.selection.text() !== '')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.air.show(e);\n\t\t\t\t\t\t}\n\t\t\t\t\t}, this));\n\n\t\t\t\t},\n\t\t\t\tappend: function()\n\t\t\t\t{\n\t\t\t\t\tthis.$air.appendTo('body');\n\t\t\t\t},\n\t\t\t\tcreateContainer: function()\n\t\t\t\t{\n\t\t\t\t\treturn $('<ul>').addClass('redactor-air').attr({ 'id': 'redactor-air-' + this.uuid, 'role': 'toolbar' }).hide();\n\t\t\t\t},\n\t\t\t\tshow: function (e)\n\t\t\t\t{\n\t\t\t\t\tthis.marker.remove();\n\t\t\t\t\tthis.selection.save();\n\t\t\t\t\tthis.selection.restore(false);\n\n\t\t\t\t\t$('.redactor-air').hide();\n\n\t\t\t\t\tvar leftFix = 0;\n\t\t\t\t\tvar width = this.$air.innerWidth();\n\n\t\t\t\t\tif ($(window).width() < (e.clientX + width))\n\t\t\t\t\t{\n\t\t\t\t\t\tleftFix = 200;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.$air.css({\n\t\t\t\t\t\tleft: (e.clientX - leftFix) + 'px',\n\t\t\t\t\t\ttop: (e.clientY + 10 + $(document).scrollTop()) + 'px'\n\t\t\t\t\t}).show();\n\n\t\t\t\t\tthis.air.enabled = true;\n\t\t\t\t\tthis.air.bindHide();\n\t\t\t\t},\n\t\t\t\tbindHide: function()\n\t\t\t\t{\n\t\t\t\t\t$(document).on('mousedown.redactor-air.' + this.uuid, $.proxy(function(e)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar dropdown = $(e.target).closest('.redactor-dropdown').length;\n\n\t\t\t\t\t\tif ($(e.target).closest(this.$air).length === 0 && dropdown === 0)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar hide = this.air.hide(e);\n\t\t\t\t\t\t\tif (hide !== false)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tthis.marker.remove();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}, this)).on('keydown.redactor-air.' + this.uuid, $.proxy(function(e)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar key = e.which;\n\t\t\t\t\t\tif ((!this.utils.isRedactorParent(e.target) && !$(e.target).hasClass('redactor-in')) || $(e.target).closest('#redactor-modal').length !== 0)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (key === this.keyCode.ESC)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.selection.get().collapseToStart();\n\t\t\t\t\t\t\tthis.marker.remove();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (key === this.keyCode.BACKSPACE || key === this.keyCode.DELETE)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar sel = this.selection.get();\n\t\t\t\t\t\t\tvar range = this.selection.range(sel);\n\t\t\t\t\t\t\trange.deleteContents();\n\t\t\t\t\t\t\tthis.marker.remove();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (key === this.keyCode.ENTER)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.selection.get().collapseToEnd();\n\t\t\t\t\t\t\tthis.marker.remove();\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (this.air.enabled)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.air.hide(e);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.selection.get().collapseToStart();\n\t\t\t\t\t\t\tthis.marker.remove();\n\t\t\t\t\t\t}\n\n\n\t\t\t\t\t}, this));\n\t\t\t\t},\n\t\t\t\thide: function(e)\n\t\t\t\t{\n\t\t\t\t\tvar ctrl = e.ctrlKey || e.metaKey || (e.shiftKey && e.altKey);\n\t\t\t\t\tif (ctrl)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.button.setInactiveAll();\n\t\t\t\t\tthis.$air.fadeOut(100);\n\t\t\t\t\tthis.air.enabled = false;\n\t\t\t\t\t$(document).off('mousedown.redactor-air.' + this.uuid);\n\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =autosave\n\t\tautosave: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tenabled: false,\n\t\t\t\thtml: false,\n\t\t\t\tinit: function()\n\t\t\t\t{\n\t\t\t\t\tif (!this.opts.autosave)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.autosave.enabled = true;\n\t\t\t\t\tthis.autosave.name = (this.opts.autosaveName) ? this.opts.autosaveName : this.$textarea.attr('name');\n\n\t\t\t\t},\n\t\t\t\tis: function()\n\t\t\t\t{\n\t\t\t\t\treturn this.autosave.enabled;\n\t\t\t\t},\n\t\t\t\tsend: function()\n\t\t\t\t{\n\t\t\t\t\tif (!this.opts.autosave)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.autosave.source = this.code.get();\n\n\t\t\t\t\tif (this.autosave.html === this.autosave.source)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\t// data\n\t\t\t\t\tvar data = {};\n\t\t\t\t\tdata.name = this.autosave.name;\n\t\t\t\t\tdata[this.autosave.name] = this.autosave.source;\n\t\t\t\t\tdata = this.autosave.getHiddenFields(data);\n\n\t\t\t\t\t// ajax\n\t\t\t\t\tvar jsxhr = $.ajax({\n\t\t\t\t\t\turl: this.opts.autosave,\n\t\t\t\t\t\ttype: 'post',\n\t\t\t\t\t\tdata: data\n\t\t\t\t\t});\n\n\t\t\t\t\tjsxhr.done(this.autosave.success);\n\t\t\t\t},\n\t\t\t\tgetHiddenFields: function(data)\n\t\t\t\t{\n\t\t\t\t\tif (this.opts.autosaveFields === false || typeof this.opts.autosaveFields !== 'object')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn data;\n\t\t\t\t\t}\n\n\t\t\t\t\t$.each(this.opts.autosaveFields, $.proxy(function(k, v)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (v !== null && v.toString().indexOf('#') === 0)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tv = $(v).val();\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tdata[k] = v;\n\n\t\t\t\t\t}, this));\n\n\t\t\t\t\treturn data;\n\n\t\t\t\t},\n\t\t\t\tsuccess: function(data)\n\t\t\t\t{\n\t\t\t\t\tvar json;\n\t\t\t\t\ttry\n\t\t\t\t\t{\n\t\t\t\t\t\tjson = $.parseJSON(data);\n\t\t\t\t\t}\n\t\t\t\t\tcatch(e)\n\t\t\t\t\t{\n\t\t\t\t\t\t//data has already been parsed\n\t\t\t\t\t\tjson = data;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar callbackName = (typeof json.error === 'undefined') ? 'autosave' :  'autosaveError';\n\n\t\t\t\t\tthis.core.callback(callbackName, this.autosave.name, json);\n\t\t\t\t\tthis.autosave.html = this.autosave.source;\n\t\t\t\t},\n\t\t\t\tdisable: function()\n\t\t\t\t{\n\t\t\t\t\tthis.autosave.enabled = false;\n\n\t\t\t\t\tclearInterval(this.autosaveTimeout);\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =block\n\t\tblock: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tformat: function(tag, attr, value, type)\n\t\t\t\t{\n\t\t\t\t\ttag = (tag === 'quote') ? 'blockquote' : tag;\n\n\t\t\t\t\tthis.block.tags = ['p', 'blockquote', 'pre', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'div', 'figure'];\n\t\t\t\t\tif ($.inArray(tag, this.block.tags) === -1)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (tag === 'p' && typeof attr === 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\t// remove all\n\t\t\t\t\t\tattr = 'class';\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.placeholder.hide();\n\t\t\t\t\tthis.buffer.set();\n\n\t\t\t\t\treturn (this.utils.isCollapsed()) ? this.block.formatCollapsed(tag, attr, value, type) : this.block.formatUncollapsed(tag, attr, value, type);\n\t\t\t\t},\n\t\t\t\tformatCollapsed: function(tag, attr, value, type)\n\t\t\t\t{\n\t\t\t\t\tthis.selection.save();\n\n\t\t\t\t\tvar block = this.selection.block();\n\t\t\t\t\tvar currentTag = block.tagName.toLowerCase();\n\t\t\t\t\tif ($.inArray(currentTag, this.block.tags) === -1)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.selection.restore();\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (currentTag === tag)\n\t\t\t\t\t{\n\t\t\t\t\t\ttag = 'p';\n\t\t\t\t\t}\n\n\t\t\t\t\tvar replaced = this.utils.replaceToTag(block, tag);\n\n\t\t\t\t\tif (typeof attr === 'object')\n\t\t\t\t\t{\n\t\t\t\t\t\ttype = value;\n\t\t\t\t\t\tfor (var key in attr)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treplaced = this.block.setAttr(replaced, key, attr[key], type);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\treplaced = this.block.setAttr(replaced, attr, value, type);\n\t\t\t\t\t}\n\n\n\t\t\t\t\t// trim pre\n\t\t\t\t\tif (tag === 'pre' && replaced.length === 1)\n\t\t\t\t\t{\n\t\t\t\t\t\t$(replaced).html($.trim($(replaced).html()));\n\t\t\t\t\t}\n\n\n\t\t\t\t\tthis.selection.restore();\n\t\t\t\t\tthis.block.removeInlineTags(replaced);\n\n\t\t\t\t\treturn replaced;\n\t\t\t\t},\n\t\t\t\tformatUncollapsed: function(tag, attr, value, type)\n\t\t\t\t{\n\t\t\t\t\tthis.selection.save();\n\n\t\t\t\t\tvar replaced = [];\n\t\t\t\t\tvar blocks = this.selection.blocks();\n\n                    if (blocks[0] && $(blocks[0]).hasClass('redactor-in'))\n                    {\n                        blocks = $(blocks[0]).find(this.opts.blockTags.join(', '));\n\t\t\t\t\t}\n\n\t\t\t\t\tvar len = blocks.length;\n\t\t\t\t\tfor (var i = 0; i < len; i++)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar currentTag = blocks[i].tagName.toLowerCase();\n\n\t\t\t\t\t\tif ($.inArray(currentTag, this.block.tags) !== -1 && currentTag !== 'figure')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar block = this.utils.replaceToTag(blocks[i], tag);\n\n\t\t\t\t\t\t\tif (typeof attr === 'object')\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\ttype = value;\n\t\t\t\t\t\t\t\tfor (var key in attr)\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tblock = this.block.setAttr(block, key, attr[key], type);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tblock = this.block.setAttr(block, attr, value, type);\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\treplaced.push(block);\n\t\t\t\t\t\t\tthis.block.removeInlineTags(block);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.selection.restore();\n\n\t\t\t\t\t// combine pre\n\t\t\t\t\tif (tag === 'pre' && replaced.length !== 0)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar first = replaced[0];\n\t\t\t\t\t\t$.each(replaced, function(i,s)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tif (i !== 0)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t$(first).append(\"\\n\" + $.trim(s.html()));\n\t\t\t\t\t\t\t\t$(s).remove();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\treplaced = [];\n\t\t\t\t\t\treplaced.push(first);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn replaced;\n\t\t\t\t},\n\t\t\t\tremoveInlineTags: function(node)\n\t\t\t\t{\n\t\t\t\t\tnode = node[0] || node;\n\n\t\t\t\t\tvar tags = this.opts.inlineTags;\n\t\t\t\t\tvar blocks = ['PRE', 'H1', 'H2', 'H3', 'H4', 'H5', 'H6'];\n\n\t\t\t\t\tif ($.inArray(node.tagName, blocks) === - 1)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (node.tagName !== 'PRE')\n\t\t\t\t\t{\n\t\t\t\t\t\tvar index = tags.indexOf('a');\n\t\t\t\t\t\ttags.splice(index, 1);\n\t\t\t\t\t}\n\n\t\t\t\t\t$(node).find(tags.join(',')).not('.redactor-selection-marker').contents().unwrap();\n\t\t\t\t},\n\t\t\t\tsetAttr: function(block, attr, value, type)\n\t\t\t\t{\n\t\t\t\t\tif (typeof attr === 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn block;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar func = (typeof type === 'undefined') ? 'replace' : type;\n\n\t\t\t\t\tif (attr === 'class')\n\t\t\t\t\t{\n\t\t\t\t\t\tblock = this.block[func + 'Class'](value, block);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tif (func === 'remove')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tblock = this.block[func + 'Attr'](attr, block);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (func === 'removeAll')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tblock = this.block[func + 'Attr'](attr, block);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tblock = this.block[func + 'Attr'](attr, value, block);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\treturn block;\n\n\t\t\t\t},\n\t\t\t\tgetBlocks: function(block)\n\t\t\t\t{\n\t\t\t\t\treturn (typeof block === 'undefined') ? this.selection.blocks() : block;\n\t\t\t\t},\n\t\t\t\treplaceClass: function(value, block)\n\t\t\t\t{\n\t\t\t\t\treturn $(this.block.getBlocks(block)).removeAttr('class').addClass(value)[0];\n\t\t\t\t},\n\t\t\t\ttoggleClass: function(value, block)\n\t\t\t\t{\n\t\t\t\t\treturn $(this.block.getBlocks(block)).toggleClass(value)[0];\n\t\t\t\t},\n\t\t\t\taddClass: function(value, block)\n\t\t\t\t{\n\t\t\t\t\treturn $(this.block.getBlocks(block)).addClass(value)[0];\n\t\t\t\t},\n\t\t\t\tremoveClass: function(value, block)\n\t\t\t\t{\n\t\t\t\t\treturn $(this.block.getBlocks(block)).removeClass(value)[0];\n\t\t\t\t},\n\t\t\t\tremoveAllClass: function(block)\n\t\t\t\t{\n\t\t\t\t\treturn $(this.block.getBlocks(block)).removeAttr('class')[0];\n\t\t\t\t},\n\t\t\t\treplaceAttr: function(attr, value, block)\n\t\t\t\t{\n\t\t\t\t\tblock = this.block.removeAttr(attr, block);\n\n\t\t\t\t\treturn $(block).attr(attr, value)[0];\n\t\t\t\t},\n\t\t\t\ttoggleAttr: function(attr, value, block)\n\t\t\t\t{\n\t\t\t\t\tblock = this.block.getBlocks(block);\n\n\t\t\t\t\tvar self = this;\n\t\t\t\t\tvar returned = [];\n\t\t\t\t\t$.each(block, function(i,s)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar $el = $(s);\n\t\t\t\t\t\tif ($el.attr(attr))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturned.push(self.block.removeAttr(attr, s));\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturned.push(self.block.addAttr(attr, value, s));\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\n\t\t\t\t\treturn returned;\n\n\t\t\t\t},\n\t\t\t\taddAttr: function(attr, value, block)\n\t\t\t\t{\n\t\t\t\t\treturn $(this.block.getBlocks(block)).attr(attr, value)[0];\n\t\t\t\t},\n\t\t\t\tremoveAttr: function(attr, block)\n\t\t\t\t{\n\t\t\t\t\treturn $(this.block.getBlocks(block)).removeAttr(attr)[0];\n\t\t\t\t},\n\t\t\t\tremoveAllAttr: function(block)\n\t\t\t\t{\n\t\t\t\t\tblock = this.block.getBlocks(block);\n\n\t\t\t\t\tvar returned = [];\n\t\t\t\t\t$.each(block, function(i,s)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (typeof s.attributes === 'undefined')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturned.push(s);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tvar $el = $(s);\n\t\t\t\t\t\tvar len = s.attributes.length;\n\t\t\t\t\t\tfor (var z = 0; z < len; z++)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$el.removeAttr(s.attributes[z].name);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturned.push($el[0]);\n\t\t\t\t\t});\n\n\t\t\t\t\treturn returned;\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// buffer\n\t\tbuffer: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tset: function(type)\n\t\t\t\t{\n    \t\t\t\tif (typeof type === 'undefined')\n                    {\n                        this.buffer.clear();\n                    }\n\n\t\t\t\t\tif (typeof type === 'undefined' || type === 'undo')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.buffer.setUndo();\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.buffer.setRedo();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tsetUndo: function()\n\t\t\t\t{\n\t\t\t\t\tthis.selection.save();\n\n\t\t\t\t\tvar last = this.opts.buffer[this.opts.buffer.length-1];\n\t\t\t\t\tvar current = this.core.editor().html();\n\t\t\t\t\tif (last !== current)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.opts.buffer.push(current);\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.selection.restore();\n\t\t\t\t},\n\t\t\t\tsetRedo: function()\n\t\t\t\t{\n\t\t\t\t\tthis.selection.save();\n\t\t\t\t\tthis.opts.rebuffer.push(this.core.editor().html());\n\t\t\t\t\tthis.selection.restore();\n\t\t\t\t},\n\t\t\t\tgetUndo: function()\n\t\t\t\t{\n\t\t\t\t\tthis.core.editor().html(this.opts.buffer.pop());\n\t\t\t\t},\n\t\t\t\tgetRedo: function()\n\t\t\t\t{\n\t\t\t\t\tthis.core.editor().html(this.opts.rebuffer.pop());\n\t\t\t\t},\n\t\t\t\tadd: function()\n\t\t\t\t{\n\t\t\t\t\tthis.opts.buffer.push(this.core.editor().html());\n\t\t\t\t},\n\t\t\t\tundo: function()\n\t\t\t\t{\n\t\t\t\t\tif (this.opts.buffer.length === 0)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.buffer.set('redo');\n\t\t\t\t\tthis.buffer.getUndo();\n\n\t\t\t\t\tthis.selection.restore();\n\t\t\t\t},\n\t\t\t\tredo: function()\n\t\t\t\t{\n\t\t\t\t\tif (this.opts.rebuffer.length === 0)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.buffer.set('undo');\n\t\t\t\t\tthis.buffer.getRedo();\n\n\t\t\t\t\tthis.selection.restore();\n\t\t\t\t},\n\t\t\t\tclear: function()\n\t\t\t\t{\n    \t\t\t\tthis.opts.rebuffer = [];\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =build\n\t\tbuild: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tstart: function()\n\t\t\t\t{\n\t\t\t\t\tif (this.opts.type === 'inline')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.opts.type = 'inline';\n\t\t\t\t\t}\n\t\t\t\t\telse if (this.opts.type === 'div')\n\t\t\t\t\t{\n\t\t\t\t\t\t// empty\n\t\t\t\t\t\tvar html = $.trim(this.$editor.html());\n\t\t\t\t\t\tif (html === '')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.$editor.html(this.opts.emptyHtml);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse if (this.opts.type === 'textarea')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.build.startTextarea();\n\t\t\t\t\t}\n\n\t\t\t\t\t// set in\n\t\t\t\t\tthis.build.setIn();\n\n\t\t\t\t\t// set id\n\t\t\t\t\tthis.build.setId();\n\n\t\t\t\t\t// enable\n\t\t\t\t\tthis.build.enableEditor();\n\n\t\t\t\t\t// options\n\t\t\t\t\tthis.build.setOptions();\n\n\t\t\t\t\t// call\n\t\t\t\t\tthis.build.callEditor();\n\n\t\t\t\t},\n\t\t\t\tcreateContainerBox: function()\n\t\t\t\t{\n\t\t\t\t\tthis.$box = $('<div class=\"redactor-box\" role=\"application\" />');\n\t\t\t\t},\n\t\t\t\tsetIn: function()\n\t\t\t\t{\n\t\t\t\t\tthis.core.editor().addClass('redactor-in');\n\t\t\t\t},\n\t\t\t\tsetId: function()\n\t\t\t\t{\n\t\t\t\t\tvar id = (this.opts.type === 'textarea') ? 'redactor-uuid-' + this.uuid : this.$element.attr('id');\n\n\t\t\t\t\tthis.core.editor().attr('id', (typeof id === 'undefined') ? 'redactor-uuid-' + this.uuid : id);\n\t\t\t\t},\n\t\t\t\tgetName: function()\n\t\t\t\t{\n\t\t\t\t\tvar name = this.$element.attr('name');\n\n\t\t\t\t\treturn (typeof name === 'undefined') ? 'content-' + this.uuid : name;\n\t\t\t\t},\n\t\t\t\tloadFromTextarea: function()\n\t\t\t\t{\n\t\t\t\t\tthis.$editor = $('<div />');\n\n\t\t\t\t\t// textarea\n\t\t\t\t\tthis.$textarea = this.$element;\n\t\t\t\t\tthis.$element.attr('name', this.build.getName());\n\n\t\t\t\t\t// place\n\t\t\t\t\tthis.$box.insertAfter(this.$element).append(this.$editor).append(this.$element);\n\t\t\t\t\tthis.$editor.addClass('redactor-editor');\n\t\t\t\t\tthis.$element.hide();\n\n\t\t\t\t\tthis.$box.prepend('<span class=\"redactor-voice-label\" id=\"redactor-voice-' + this.uuid +'\" aria-hidden=\"false\">' + this.lang.get('accessibility-help-label') + '</span>');\n\t\t\t\t\tthis.$editor.attr({ 'aria-labelledby': 'redactor-voice-' + this.uuid, 'role': 'presentation' });\n\t\t\t\t},\n\t\t\t\tstartTextarea: function()\n\t\t\t\t{\n\t\t\t\t\tthis.build.createContainerBox();\n\n\t\t\t\t\t// load\n\t\t\t\t\tthis.build.loadFromTextarea();\n\n\t\t\t\t\t// set code\n\t\t\t\t\tthis.code.start(this.core.textarea().val());\n\n\t\t\t\t\t// set value\n\t\t\t\t\tthis.core.textarea().val(this.clean.onSync(this.$editor.html()));\n\t\t\t\t},\n\t\t\t\tisTag: function(tag)\n\t\t\t\t{\n\t\t\t\t\treturn (this.$element[0].tagName === tag);\n\t\t\t\t},\n\t\t\t\tisInline: function()\n\t\t\t\t{\n\t\t\t\t\treturn (!this.build.isTag('TEXTAREA') && !this.build.isTag('DIV') && !this.build.isTag('PRE'));\n\t\t\t\t},\n\t\t\t\tenableEditor: function()\n\t\t\t\t{\n\t\t\t\t\tthis.core.editor().attr({ 'contenteditable': true });\n\t\t\t\t},\n\t\t\t\tsetOptions: function()\n\t\t\t\t{\n\t\t\t\t\t// inline\n\t\t\t\t\tif (this.opts.type === 'inline')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.opts.enterKey = false;\n\t\t\t\t\t}\n\n\t\t\t\t\t// inline & pre\n\t\t\t\t\tif (this.opts.type === 'inline' || this.opts.type === 'pre')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.opts.toolbarMobile = false;\n\t\t\t\t\t\tthis.opts.toolbar = false;\n\t\t\t\t\t\tthis.opts.air = false;\n\t\t\t\t\t\tthis.opts.linkify = false;\n\n\t\t\t\t\t}\n\n\t\t\t\t\t// spellcheck\n\t\t\t\t\tthis.core.editor().attr('spellcheck', this.opts.spellcheck);\n\n\t\t\t\t\t// structure\n\t\t\t\t\tif (this.opts.structure)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.editor().addClass('redactor-structure');\n\t\t\t\t\t}\n\n\t\t\t\t\t// options sets only in textarea mode\n\t\t\t\t\tif (this.opts.type !== 'textarea')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\t// direction\n\t\t\t\t\tthis.core.box().attr('dir', this.opts.direction);\n\t\t\t\t\tthis.core.editor().attr('dir', this.opts.direction);\n\n\t\t\t\t\t// tabindex\n\t\t\t\t\tif (this.opts.tabindex)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.editor().attr('tabindex', this.opts.tabindex);\n\t\t\t\t\t}\n\n\t\t\t\t\t// min height\n\t\t\t\t\tif (this.opts.minHeight)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.editor().css('min-height', this.opts.minHeight);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.editor().css('min-height', '40px');\n\t\t\t\t\t}\n\n\t\t\t\t\t// max height\n\t\t\t\t\tif (this.opts.maxHeight)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.editor().css('max-height', this.opts.maxHeight);\n\t\t\t\t\t}\n\n\t\t\t\t\t// max width\n\t\t\t\t\tif (this.opts.maxWidth)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.editor().css({ 'max-width': this.opts.maxWidth, 'margin': 'auto' });\n\t\t\t\t\t}\n\n\t\t\t\t},\n\t\t\t\tcallEditor: function()\n\t\t\t\t{\n\t\t\t\t\tthis.build.disableBrowsersEditing();\n\n\t\t\t\t\tthis.events.init();\n\t\t\t\t\tthis.build.setHelpers();\n\n\t\t\t\t\t// init buttons\n\t\t\t\t\tif (this.opts.toolbar || this.opts.air)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.toolbarsButtons = this.button.init();\n\t\t\t\t\t}\n\n\t\t\t\t\t// load toolbar\n\t\t\t\t\tif (this.opts.air)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.air.build();\n\t\t\t\t\t}\n\t\t\t\t\telse if (this.opts.toolbar)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.toolbar.build();\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.detect.isMobile() && this.opts.toolbarMobile && this.opts.air)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.opts.toolbar = true;\n\t\t\t\t\t\tthis.toolbar.build();\n\t\t\t\t\t}\n\n\t\t\t\t\t// observe dropdowns\n\t\t\t\t\tif (this.opts.air || this.opts.toolbar)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.editor().on('mouseup.redactor-observe.' + this.uuid + ' keyup.redactor-observe.' + this.uuid + ' focus.redactor-observe.' + this.uuid + ' touchstart.redactor-observe.' + this.uuid, $.proxy(this.observe.toolbar, this));\n\t\t\t\t\t\tthis.core.element().on('blur.callback.redactor', $.proxy(function()\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.button.setInactiveAll();\n\n\t\t\t\t\t\t}, this));\n\t\t\t\t\t}\n\n\t\t\t\t\t// modal templates init\n\t\t\t\t\tthis.modal.templates();\n\n\t\t\t\t\t// plugins\n\t\t\t\t\tthis.build.plugins();\n\n\t\t\t\t\t// autosave\n\t\t\t\t\tthis.autosave.init();\n\n\t\t\t\t\t// sync code\n\t\t\t\t\tthis.code.html = this.code.cleaned(this.core.editor().html());\n\n\t\t\t\t\t// init callback\n\t\t\t\t\tthis.core.callback('init');\n\t\t\t\t\tthis.core.callback('initToEdit');\n\n\t\t\t\t\t// get images & files list\n\t\t\t\t\tthis.storage.observe();\n\n\t\t\t\t\t// started\n\t\t\t\t\tthis.start = false;\n\n\t\t\t\t},\n\t\t\t\tsetHelpers: function()\n\t\t\t\t{\n\t\t\t\t\t// linkify\n\t\t\t\t\tif (this.opts.linkify)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.linkify.format();\n\t\t\t\t\t}\n\n\t\t\t\t\t// placeholder\n\t\t\t\t\tthis.placeholder.init();\n\n\t\t\t\t\t// focus\n\t\t\t\t\tif (this.opts.focus)\n\t\t\t\t\t{\n\t\t\t\t\t\tsetTimeout(this.focus.start, 100);\n\t\t\t\t\t}\n\t\t\t\t\telse if (this.opts.focusEnd)\n\t\t\t\t\t{\n\t\t\t\t\t\tsetTimeout(this.focus.end, 100);\n\t\t\t\t\t}\n\n\t\t\t\t},\n\t\t\t\tdisableBrowsersEditing: function()\n\t\t\t\t{\n\t\t\t\t\ttry {\n\t\t\t\t\t\t// FF fix\n\t\t\t\t\t\tdocument.execCommand('enableObjectResizing', false, false);\n\t\t\t\t\t\tdocument.execCommand('enableInlineTableEditing', false, false);\n\t\t\t\t\t\t// IE prevent converting links\n\t\t\t\t\t\tdocument.execCommand(\"AutoUrlDetect\", false, false);\n\t\t\t\t\t} catch (e) {}\n\t\t\t\t},\n\t\t\t\tplugins: function()\n\t\t\t\t{\n\t\t\t\t\tif (!this.opts.plugins)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\t$.each(this.opts.plugins, $.proxy(function(i, s)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar func = (typeof RedactorPlugins !== 'undefined' && typeof RedactorPlugins[s] !== 'undefined') ? RedactorPlugins : Redactor.fn;\n\n\t\t\t\t\t\tif (!$.isFunction(func[s]))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tthis[s] = func[s]();\n\n\t\t\t\t\t\t// get methods\n\t\t\t\t\t\tvar methods = this.getModuleMethods(this[s]);\n\t\t\t\t\t\tvar len = methods.length;\n\n\t\t\t\t\t\t// bind methods\n\t\t\t\t\t\tfor (var z = 0; z < len; z++)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis[s][methods[z]] = this[s][methods[z]].bind(this);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// append lang\n\t\t\t\t\t\tif (typeof this[s].langs !== 'undefined')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar lang = {};\n\t\t\t\t\t\t\tif (typeof this[s].langs[this.opts.lang] !== 'undefined')\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tlang = this[s].langs[this.opts.lang];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse if (typeof this[s].langs[this.opts.lang] === 'undefined' && typeof this[s].langs.en !== 'undefined')\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tlang = this[s].langs.en;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t// extend\n\t\t\t\t\t\t\tvar self = this;\n\t\t\t\t\t\t\t$.each(lang, function(i,s)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tif (typeof self.opts.curLang[i] === 'undefined')\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tself.opts.curLang[i] = s;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// init\n\t\t\t\t\t\tif ($.isFunction(this[s].init))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis[s].init();\n\t\t\t\t\t\t}\n\n\n\t\t\t\t\t}, this));\n\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =button\n\t\tbutton: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\ttoolbar: function()\n\t\t\t\t{\n\t\t\t\t\treturn (typeof this.button.$toolbar === 'undefined' || !this.button.$toolbar) ? this.$toolbar : this.button.$toolbar;\n\t\t\t\t},\n\t\t\t\tinit: function()\n\t\t\t\t{\n\t\t\t\t\treturn {\n\t\t\t\t\t\tformat:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: this.lang.get('format'),\n\t\t\t\t\t\t\tdropdown:\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tp:\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\ttitle: this.lang.get('paragraph'),\n\t\t\t\t\t\t\t\t\tfunc: 'block.format'\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\tblockquote:\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\ttitle: this.lang.get('quote'),\n\t\t\t\t\t\t\t\t\tfunc: 'block.format'\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\tpre:\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\ttitle: this.lang.get('code'),\n\t\t\t\t\t\t\t\t\tfunc: 'block.format'\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\th1:\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\ttitle: this.lang.get('heading1'),\n\t\t\t\t\t\t\t\t\tfunc: 'block.format'\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\th2:\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\ttitle: this.lang.get('heading2'),\n\t\t\t\t\t\t\t\t\tfunc: 'block.format'\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\th3:\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\ttitle: this.lang.get('heading3'),\n\t\t\t\t\t\t\t\t\tfunc: 'block.format'\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\th4:\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\ttitle: this.lang.get('heading4'),\n\t\t\t\t\t\t\t\t\tfunc: 'block.format'\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\th5:\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\ttitle: this.lang.get('heading5'),\n\t\t\t\t\t\t\t\t\tfunc: 'block.format'\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\th6:\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\ttitle: this.lang.get('heading6'),\n\t\t\t\t\t\t\t\t\tfunc: 'block.format'\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},\n\t\t\t\t\t\tbold:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: this.lang.get('bold-abbr'),\n\t\t\t\t\t\t\tlabel: this.lang.get('bold'),\n\t\t\t\t\t\t\tfunc: 'inline.format'\n\t\t\t\t\t\t},\n\t\t\t\t\t\titalic:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: this.lang.get('italic-abbr'),\n\t\t\t\t\t\t\tlabel: this.lang.get('italic'),\n\t\t\t\t\t\t\tfunc: 'inline.format'\n\t\t\t\t\t\t},\n\t\t\t\t\t\tdeleted:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: this.lang.get('deleted-abbr'),\n\t\t\t\t\t\t\tlabel: this.lang.get('deleted'),\n\t\t\t\t\t\t\tfunc: 'inline.format'\n\t\t\t\t\t\t},\n\t\t\t\t\t\tunderline:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: this.lang.get('underline-abbr'),\n\t\t\t\t\t\t\tlabel: this.lang.get('underline'),\n\t\t\t\t\t\t\tfunc: 'inline.format'\n\t\t\t\t\t\t},\n\t\t\t\t\t\tlists:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: this.lang.get('lists'),\n\t\t\t\t\t\t\tdropdown:\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tunorderedlist:\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\ttitle: '&bull; ' + this.lang.get('unorderedlist'),\n\t\t\t\t\t\t\t\t\tfunc: 'list.toggle'\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\torderedlist:\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\ttitle: '1. ' + this.lang.get('orderedlist'),\n\t\t\t\t\t\t\t\t\tfunc: 'list.toggle'\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\toutdent:\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\ttitle: '< ' + this.lang.get('outdent'),\n\t\t\t\t\t\t\t\t\tfunc: 'indent.decrease',\n\t\t\t\t\t\t\t\t\tobserve: {\n\t\t\t\t\t\t\t\t\t\telement: 'li',\n\t\t\t\t\t\t\t\t\t\tout: {\n\t\t\t\t\t\t\t\t\t\t\tattr: {\n\t\t\t\t\t\t\t\t\t\t\t\t'class': 'redactor-dropdown-link-inactive',\n\t\t\t\t\t\t\t\t\t\t\t\t'aria-disabled': true\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\tindent:\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\ttitle: '> ' + this.lang.get('indent'),\n\t\t\t\t\t\t\t\t\tfunc: 'indent.increase',\n\t\t\t\t\t\t\t\t\tobserve: {\n\t\t\t\t\t\t\t\t\t\telement: 'li',\n\t\t\t\t\t\t\t\t\t\tout: {\n\t\t\t\t\t\t\t\t\t\t\tattr: {\n\t\t\t\t\t\t\t\t\t\t\t\t'class': 'redactor-dropdown-link-inactive',\n\t\t\t\t\t\t\t\t\t\t\t\t'aria-disabled': true\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},\n\t\t\t\t\t\tul:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: '&bull; ' + this.lang.get('bulletslist'),\n\t\t\t\t\t\t\tfunc: 'list.toggle'\n\t\t\t\t\t\t},\n\t\t\t\t\t\tol:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: '1. ' + this.lang.get('numberslist'),\n\t\t\t\t\t\t\tfunc: 'list.toggle'\n\t\t\t\t\t\t},\n\t\t\t\t\t\toutdent:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: this.lang.get('outdent'),\n\t\t\t\t\t\t\tfunc: 'indent.decrease'\n\t\t\t\t\t\t},\n\t\t\t\t\t\tindent:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: this.lang.get('indent'),\n\t\t\t\t\t\t\tfunc: 'indent.increase'\n\t\t\t\t\t\t},\n\t\t\t\t\t\timage:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: this.lang.get('image'),\n\t\t\t\t\t\t\tfunc: 'image.show'\n\t\t\t\t\t\t},\n\t\t\t\t\t\tfile:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: this.lang.get('file'),\n\t\t\t\t\t\t\tfunc: 'file.show'\n\t\t\t\t\t\t},\n\t\t\t\t\t\tlink:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: this.lang.get('link'),\n\t\t\t\t\t\t\tdropdown:\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tlink:\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\ttitle: this.lang.get('link-insert'),\n\t\t\t\t\t\t\t\t\tfunc: 'link.show',\n\t\t\t\t\t\t\t\t\tobserve: {\n\t\t\t\t\t\t\t\t\t\telement: 'a',\n\t\t\t\t\t\t\t\t\t\tin: {\n\t\t\t\t\t\t\t\t\t\t\ttitle: this.lang.get('link-edit'),\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\tout: {\n\t\t\t\t\t\t\t\t\t\t\ttitle: this.lang.get('link-insert')\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\tunlink:\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\ttitle: this.lang.get('unlink'),\n\t\t\t\t\t\t\t\t\tfunc: 'link.unlink',\n\t\t\t\t\t\t\t\t\tobserve: {\n\t\t\t\t\t\t\t\t\t\telement: 'a',\n\t\t\t\t\t\t\t\t\t\tout: {\n\t\t\t\t\t\t\t\t\t\t\tattr: {\n\t\t\t\t\t\t\t\t\t\t\t\t'class': 'redactor-dropdown-link-inactive',\n\t\t\t\t\t\t\t\t\t\t\t\t'aria-disabled': true\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},\n\t\t\t\t\t\thorizontalrule:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: this.lang.get('horizontalrule'),\n\t\t\t\t\t\t\tfunc: 'line.insert'\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\t\t\t\t},\n\t\t\t\tsetFormatting: function()\n\t\t\t\t{\n\t\t\t\t\t$.each(this.toolbarsButtons.format.dropdown, $.proxy(function (i, s)\n\t\t\t\t\t{\n\t\t\t\t\t\tif ($.inArray(i, this.opts.formatting) === -1)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tdelete this.toolbarsButtons.format.dropdown[i];\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}, this));\n\n\t\t\t\t},\n\t\t\t\thideButtons: function()\n\t\t\t\t{\n\t\t\t\t\tif (this.opts.buttonsHide.length !== 0)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.button.hideButtonsSlicer(this.opts.buttonsHide);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\thideButtonsOnMobile: function()\n\t\t\t\t{\n\t\t\t\t\tif (this.detect.isMobile() && this.opts.buttonsHideOnMobile.length !== 0)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.button.hideButtonsSlicer(this.opts.buttonsHideOnMobile);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\thideButtonsSlicer: function(buttons)\n\t\t\t\t{\n\t\t\t\t\t$.each(buttons, $.proxy(function(i, s)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar index = this.opts.buttons.indexOf(s);\n\t\t\t\t\t\tif (index !== -1)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t    this.opts.buttons.splice(index, 1);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}, this));\n\t\t\t\t},\n\t\t\t\tload: function($toolbar)\n\t\t\t\t{\n\t\t\t\t\tthis.button.buttons = [];\n\n\t\t\t\t\t$.each(this.opts.buttons, $.proxy(function(i, btnName)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (!this.toolbarsButtons[btnName]\n\t\t\t\t\t\t\t|| (btnName === 'file' && !this.file.is())\n\t\t\t\t\t\t\t|| (btnName === 'image' && !this.image.is()))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t$toolbar.append($('<li>').append(this.button.build(btnName, this.toolbarsButtons[btnName])));\n\n\t\t\t\t\t}, this));\n\t\t\t\t},\n\t\t\t\tbuild: function(btnName, btnObject)\n\t\t\t\t{\n\t\t\t\t\tif (this.opts.toolbar === false)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar $button = $('<a href=\"javascript:void(null);\" class=\"re-button re-' + btnName + '\" title=\"' + btnObject.title + '\" rel=\"' + btnName + '\" />').html(btnObject.title);\n\t\t\t\t\t$button.attr({ 'role': 'button', 'aria-label': btnObject.title, 'tabindex': '-1' });\n\n\t\t\t\t\tif (typeof btnObject.label !== 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\t$button.attr('aria-label', btnObject.label);\n\t\t\t\t\t\t$button.attr('title', btnObject.label);\n\t\t\t\t\t}\n\n\t\t\t\t\t// click\n\t\t\t\t\tif (btnObject.func || btnObject.command || btnObject.dropdown)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.button.setEvent($button, btnName, btnObject);\n\t\t\t\t\t}\n\n\t\t\t\t\t// dropdown\n\t\t\t\t\tif (btnObject.dropdown)\n\t\t\t\t\t{\n\t\t\t\t\t\t$button.addClass('redactor-toolbar-link-dropdown').attr('aria-haspopup', true);\n\n\t\t\t\t\t\tvar $dropdown = $('<ul class=\"redactor-dropdown redactor-dropdown-' + this.uuid + ' redactor-dropdown-box-' + btnName + '\" style=\"display: none;\">');\n\t\t\t\t\t\t$button.data('dropdown', $dropdown);\n\t\t\t\t\t\tthis.dropdown.build(btnName, $dropdown, btnObject.dropdown);\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.button.buttons.push($button);\n\n\t\t\t\t\treturn $button;\n\t\t\t\t},\n\t\t\t\tgetButtons: function()\n\t\t\t\t{\n\t\t\t\t\treturn this.button.toolbar().find('a.re-button');\n\t\t\t\t},\n\t\t\t\tgetButtonsKeys: function()\n\t\t\t\t{\n\t\t\t\t\treturn this.button.buttons;\n\t\t\t\t},\n\t\t\t\tsetEvent: function($button, btnName, btnObject)\n\t\t\t\t{\n\t\t\t\t\t$button.on('mousedown', $.proxy(function(e)\n\t\t\t\t\t{\n\t\t\t\t\t\te.preventDefault();\n\n\t\t\t\t\t\tif ($button.hasClass('redactor-button-disabled'))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tvar type = 'func';\n\t\t\t\t\t\tvar callback = btnObject.func;\n\n\t\t\t\t\t\tif (btnObject.command)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttype = 'command';\n\t\t\t\t\t\t\tcallback = btnObject.command;\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (btnObject.dropdown)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttype = 'dropdown';\n\t\t\t\t\t\t\tcallback = false;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tthis.button.toggle(e, btnName, type, callback);\n\n\t\t\t\t\t\treturn false;\n\n\t\t\t\t\t}, this));\n\t\t\t\t},\n\t\t\t\ttoggle: function(e, btnName, type, callback, args)\n\t\t\t\t{\n\n\t\t\t\t\tif (this.detect.isIe() || !this.detect.isDesktop())\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.utils.freezeScroll();\n\t\t\t\t\t\te.returnValue = false;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (type === 'command')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.inline.format(callback);\n\t\t\t\t\t}\n\t\t\t\t\telse if (type === 'dropdown')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.dropdown.show(e, btnName);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.button.clickCallback(e, callback, btnName, args);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (type !== 'dropdown')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.dropdown.hideAll(false);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.opts.air && type !== 'dropdown')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.air.hide(e);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.detect.isIe() || !this.detect.isDesktop())\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.utils.unfreezeScroll();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tclickCallback: function(e, callback, btnName, args)\n\t\t\t\t{\n\t\t\t\t\tvar func;\n\n\t\t\t\t\targs = (typeof args === 'undefined') ? btnName : args;\n\n\t\t\t\t\tif ($.isFunction(callback))\n\t\t\t\t\t{\n\t\t\t\t\t\tcallback.call(this, btnName);\n\t\t\t\t\t}\n\t\t\t\t\telse if (callback.search(/\\./) !== '-1')\n\t\t\t\t\t{\n\t\t\t\t\t\tfunc = callback.split('.');\n\t\t\t\t\t\tif (typeof this[func[0]] === 'undefined')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (typeof args === 'object')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis[func[0]][func[1]].apply(this, args);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis[func[0]][func[1]].call(this, args);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\n\t\t\t\t\t\tif (typeof args === 'object')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis[callback].apply(this, args);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis[callback].call(this, args);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.observe.buttons(e, btnName);\n\n\t\t\t\t},\n\t\t\t\tall: function()\n\t\t\t\t{\n\t\t\t\t\treturn this.button.buttons;\n\t\t\t\t},\n\t\t\t\tget: function(key)\n\t\t\t\t{\n\t\t\t\t\tif (this.opts.toolbar === false)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn this.button.toolbar().find('a.re-' + key);\n\t\t\t\t},\n\t\t\t\tset: function(key, title)\n\t\t\t\t{\n\t\t\t\t\tif (this.opts.toolbar === false)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar $btn = this.button.toolbar().find('a.re-' + key);\n\n\t\t\t\t\t$btn.html(title).attr('aria-label', title);\n\n\t\t\t\t\treturn $btn;\n\t\t\t\t},\n\t\t\t\tadd: function(key, title)\n\t\t\t\t{\n\t\t\t\t\tif (this.button.isAdded(key) !== true)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn $();\n\t\t\t\t\t}\n\n\t\t\t\t\tvar btn = this.button.build(key, { title: title });\n\n\t\t\t\t\tthis.button.toolbar().append($('<li>').append(btn));\n\n\t\t\t\t\treturn btn;\n\t\t\t\t},\n\t\t\t\taddFirst: function(key, title)\n\t\t\t\t{\n\t\t\t\t\tif (this.button.isAdded(key) !== true)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn $();\n\t\t\t\t\t}\n\n\t\t\t\t\tvar btn = this.button.build(key, { title: title });\n\n\t\t\t\t\tthis.button.toolbar().prepend($('<li>').append(btn));\n\n\t\t\t\t\treturn btn;\n\t\t\t\t},\n\t\t\t\taddAfter: function(afterkey, key, title)\n\t\t\t\t{\n\t\t\t\t\tif (this.button.isAdded(key) !== true)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn $();\n\t\t\t\t\t}\n\n\t\t\t\t\tvar btn = this.button.build(key, { title: title });\n\t\t\t\t\tvar $btn = this.button.get(afterkey);\n\n\t\t\t\t\tif ($btn.length !== 0)\n\t\t\t\t\t{\n\t\t\t\t\t\t$btn.parent().after($('<li>').append(btn));\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.button.toolbar().append($('<li>').append(btn));\n\t\t\t\t\t}\n\n\t\t\t\t\treturn btn;\n\t\t\t\t},\n\t\t\t\taddBefore: function(beforekey, key, title)\n\t\t\t\t{\n\t\t\t\t\tif (this.button.isAdded(key) !== true)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn $();\n\t\t\t\t\t}\n\n\t\t\t\t\tvar btn = this.button.build(key, { title: title });\n\t\t\t\t\tvar $btn = this.button.get(beforekey);\n\n\t\t\t\t\tif ($btn.length !== 0)\n\t\t\t\t\t{\n\t\t\t\t\t\t$btn.parent().before($('<li>').append(btn));\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.button.toolbar().append($('<li>').append(btn));\n\t\t\t\t\t}\n\n\t\t\t\t\treturn btn;\n\t\t\t\t},\n\t\t\t\tisAdded: function(key)\n\t\t\t\t{\n\t                var index = this.opts.buttonsHideOnMobile.indexOf(key);\n                    if (this.opts.toolbar === false || (index !== -1 && this.detect.isMobile()))\n                    {\n\t\t\t\t\t    return false;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t\tsetIcon: function($btn, icon)\n\t\t\t\t{\n\t\t\t\t\t$btn.html(icon);\n\t\t\t\t},\n\t\t\t\taddCallback: function($btn, callback)\n\t\t\t\t{\n\t\t\t\t\tif (typeof $btn === 'undefined' || this.opts.toolbar === false)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar type = (callback === 'dropdown') ? 'dropdown' : 'func';\n\t\t\t\t\tvar key = $btn.attr('rel');\n\t\t\t\t\t$btn.on('mousedown', $.proxy(function(e)\n\t\t\t\t\t{\n\t\t\t\t\t\tif ($btn.hasClass('redactor-button-disabled'))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tthis.button.toggle(e, key, type, callback);\n\n\t\t\t\t\t}, this));\n\t\t\t\t},\n\t\t\t\taddDropdown: function($btn, dropdown)\n\t\t\t\t{\n\t\t\t\t\tif (this.opts.toolbar === false)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\t$btn.addClass('redactor-toolbar-link-dropdown').attr('aria-haspopup', true);\n\n\t\t\t\t\tvar key = $btn.attr('rel');\n\t\t\t\t\tthis.button.addCallback($btn, 'dropdown');\n\n\t\t\t\t\tvar $dropdown = $('<div class=\"redactor-dropdown redactor-dropdown-' + this.uuid + ' redactor-dropdown-box-' + key + '\" style=\"display: none;\">');\n\t\t\t\t\t$btn.data('dropdown', $dropdown);\n\n\t\t\t\t\t// build dropdown\n\t\t\t\t\tif (dropdown)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.dropdown.build(key, $dropdown, dropdown);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn $dropdown;\n\t\t\t\t},\n\t\t\t\tsetActive: function(key)\n\t\t\t\t{\n\t\t\t\t\tthis.button.get(key).addClass('redactor-act');\n\t\t\t\t},\n\t\t\t\tsetInactive: function(key)\n\t\t\t\t{\n\t\t\t\t\tthis.button.get(key).removeClass('redactor-act');\n\t\t\t\t},\n\t\t\t\tsetInactiveAll: function(key)\n\t\t\t\t{\n\t\t\t\t\tvar $btns = this.button.toolbar().find('a.re-button');\n\n\t\t\t\t\tif (typeof key !== 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\t$btns = $btns.not('.re-' + key);\n\t\t\t\t\t}\n\n\t\t\t\t\t$btns.removeClass('redactor-act');\n\t\t\t\t},\n\t\t\t\tdisable: function(key)\n\t\t\t\t{\n\t\t\t\t\tthis.button.get(key).addClass('redactor-button-disabled');\n\t\t\t\t},\n\t\t\t\tenable: function(key)\n\t\t\t\t{\n\t\t\t\t\tthis.button.get(key).removeClass('redactor-button-disabled');\n\t\t\t\t},\n\t\t\t\tdisableAll: function(key)\n\t\t\t\t{\n\t\t\t\t\tvar $btns = this.button.toolbar().find('a.re-button');\n\t\t\t\t\tif (typeof key !== 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\t$btns = $btns.not('.re-' + key);\n\t\t\t\t\t}\n\n\t\t\t\t\t$btns.addClass('redactor-button-disabled');\n\t\t\t\t},\n\t\t\t\tenableAll: function()\n\t\t\t\t{\n\t\t\t\t\tthis.button.toolbar().find('a.re-button').removeClass('redactor-button-disabled');\n\t\t\t\t},\n\t\t\t\tremove: function(key)\n\t\t\t\t{\n\t\t\t\t\tthis.button.get(key).remove();\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =caret\n\t\tcaret: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tset: function(node1, node2, end)\n\t\t\t\t{\n\t\t\t\t\tthis.core.editor().focus();\n\n\t\t\t\t\tend = (typeof end === 'undefined') ? 0 : 1;\n\n\t\t\t\t\tnode1 = node1[0] || node1;\n\t\t\t\t\tnode2 = node2[0] || node2;\n\n\t\t\t\t\tvar sel = this.selection.get();\n\t\t\t\t\tvar range = this.selection.range(sel);\n\n\t\t\t\t\ttry\n\t\t\t\t\t{\n\t\t\t\t\t\trange.setStart(node1, 0);\n\t\t\t\t\t\trange.setEnd(node2, end);\n\t\t\t\t\t}\n\t\t\t\t\tcatch (e) {}\n\n\t\t\t\t\tthis.selection.update(sel, range);\n\t\t\t\t},\n\t\t\t\tprepare: function(node)\n\t\t\t\t{\n\t\t\t\t\t// firefox focus\n\t\t\t\t\tif (this.detect.isFirefox() && typeof this.start !== 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.editor().focus();\n\t\t\t\t\t}\n\n\t\t\t\t\treturn node[0] || node;\n\t\t\t\t},\n\t\t\t\tstart: function(node)\n\t\t\t\t{\n\n\t\t\t\t\tvar sel, range;\n\t\t\t\t\tnode = this.caret.prepare(node);\n\n\t\t\t\t\tif (!node)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (node.tagName === 'BR')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn this.caret.before(node);\n\t\t\t\t\t}\n\n\t\t\t\t\t// empty or inline tag\n\t\t\t\t\tvar inline = this.utils.isInlineTag(node.tagName);\n\t\t\t\t\tif (node.innerHTML === '' || inline)\n\t\t\t\t\t{\n                        sel = window.getSelection();\n\t\t\t\t\t    range = document.createRange();\n\t\t\t\t\t\tvar textNode = document.createTextNode('\\u200B');\n\n\t\t\t\t\t\trange.setStart(node, 0);\n\t\t\t\t\t\trange.insertNode(textNode);\n\t\t\t\t\t\trange.setStartAfter(textNode);\n\t\t\t\t\t\trange.collapse(true);\n\n\t\t\t\t\t\tsel.removeAllRanges();\n\t\t\t\t\t\tsel.addRange(range);\n\n\t\t\t\t\t\t// remove invisible text node\n\t\t\t\t\t\tif (!inline)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.core.editor().on('keydown.redactor-remove-textnode', function()\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t$(textNode).remove();\n\t\t\t\t\t\t\t\t$(this).off('keydown.redactor-remove-textnode');\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t// block tag\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tsel = window.getSelection();\n\t\t\t\t\t\tsel.removeAllRanges();\n\n\t\t\t\t\t\trange = document.createRange();\n\t\t\t\t\t\trange.selectNodeContents(node);\n\t\t\t\t\t\trange.collapse(true);\n\t\t\t\t\t\tsel.addRange(range);\n\t\t\t\t\t}\n\n\n\t\t\t\t},\n\t\t\t\tend: function(node)\n\t\t\t\t{\n\t\t\t\t\tvar sel, range;\n\t\t\t\t\tnode = this.caret.prepare(node);\n\n\t\t\t\t\tif (!node)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\t// empty node\n\t\t\t\t\tif (node.tagName !== 'BR' && node.innerHTML === '')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn this.caret.start(node);\n\t\t\t\t\t}\n\n\t\t\t\t\t// br\n\t\t\t\t\tif (node.tagName === 'BR')\n\t\t\t\t\t{\n\t\t\t\t\t\tvar space = document.createElement('span');\n\t\t\t\t\t\tspace.className = 'redactor-invisible-space';\n\t\t\t\t\t\tspace.innerHTML = '&#x200b;';\n\n\t\t\t\t\t\t$(node).after(space);\n\n\t\t\t\t\t\tsel = window.getSelection();\n\t\t\t\t\t\tsel.removeAllRanges();\n\n\t\t\t\t\t\trange = document.createRange();\n\n\t\t\t\t\t\trange.setStartBefore(space);\n\t\t\t\t\t\trange.setEndBefore(space);\n\t\t\t\t\t\tsel.addRange(range);\n\n\t\t\t\t\t\t$(space).replaceWith(function()\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn $(this).contents();\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (node.lastChild && node.lastChild.nodeType === 1)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn this.caret.after(node.lastChild);\n\t\t\t\t\t}\n\n\t\t\t\t\tsel = window.getSelection();\n\t\t\t\t\tsel.removeAllRanges();\n\n\t\t\t\t\trange = document.createRange();\n\t\t\t\t\trange.selectNodeContents(node);\n\t\t\t\t\trange.collapse(false);\n\t\t\t\t\tsel.addRange(range);\n\t\t\t\t},\n\t\t\t\tafter: function(node)\n\t\t\t\t{\n\t\t\t\t\tvar sel, range;\n\t\t\t\t\tnode = this.caret.prepare(node);\n\n\n\t\t\t\t\tif (!node)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (node.tagName === 'BR')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn this.caret.end(node);\n\t\t\t\t\t}\n\n\t\t\t\t\t// block tag\n\t\t\t\t\tif (this.utils.isBlockTag(node.tagName))\n\t\t\t\t\t{\n\t\t\t\t\t\tvar next = this.caret.next(node);\n\n\t\t\t\t\t\tif (typeof next === 'undefined')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.caret.end(node);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t// table\n\t\t\t\t\t\t\tif (next.tagName === 'TABLE')\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tnext = $(next).find('th, td').first()[0];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t// list\n\t\t\t\t\t\t\telse if (next.tagName === 'UL' || next.tagName === 'OL')\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tnext = $(next).find('li').first()[0];\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tthis.caret.start(next);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\t// inline tag\n\t\t\t\t\tvar textNode = document.createTextNode('\\u200B');\n\n\t\t\t\t\tsel = window.getSelection();\n\t\t\t\t\tsel.removeAllRanges();\n\n\t\t\t\t\trange = document.createRange();\n\t\t\t\t\trange.setStartAfter(node);\n\t\t\t\t\trange.insertNode(textNode);\n\t\t\t\t\trange.setStartAfter(textNode);\n\t\t\t\t\trange.collapse(true);\n\n\t\t\t\t\tsel.addRange(range);\n\n\t\t\t\t},\n\t\t\t\tbefore: function(node)\n\t\t\t\t{\n\t\t\t\t\tvar sel, range;\n\t\t\t\t\tnode = this.caret.prepare(node);\n\n\n\t\t\t\t\tif (!node)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\t// block tag\n\t\t\t\t\tif (this.utils.isBlockTag(node.tagName))\n\t\t\t\t\t{\n\t\t\t\t\t\tvar prev = this.caret.prev(node);\n\n\t\t\t\t\t\tif (typeof prev === 'undefined')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.caret.start(node);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t// table\n\t\t\t\t\t\t\tif (prev.tagName === 'TABLE')\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tprev = $(prev).find('th, td').last()[0];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t// list\n\t\t\t\t\t\t\telse if (prev.tagName === 'UL' || prev.tagName === 'OL')\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tprev = $(prev).find('li').last()[0];\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tthis.caret.end(prev);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\t// inline tag\n\t\t\t\t\tsel = window.getSelection();\n\t\t\t\t\tsel.removeAllRanges();\n\n\t\t\t\t\trange = document.createRange();\n\n\t\t\t        range.setStartBefore(node);\n\t\t\t        range.collapse(true);\n\n\t\t\t        sel.addRange(range);\n\t\t\t\t},\n\t\t\t\tnext: function(node)\n\t\t\t\t{\n\t\t\t\t\tvar $next = $(node).next();\n\t\t\t\t\tif ($next.hasClass('redactor-script-tag, redactor-selection-marker'))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn $next.next()[0];\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\treturn $next[0];\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tprev: function(node)\n\t\t\t\t{\n\t\t\t\t\tvar $prev = $(node).prev();\n\t\t\t\t\tif ($prev.hasClass('redactor-script-tag, redactor-selection-marker'))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn $prev.prev()[0];\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\treturn $prev[0];\n\t\t\t\t\t}\n\t\t\t\t},\n\n\t\t\t\t// #backward\n\t\t\t\toffset: function(node)\n\t\t\t\t{\n\t\t\t\t\treturn this.offset.get(node);\n\t\t\t\t}\n\n\t\t\t};\n\t\t},\n\n\t\t// =clean\n\t\tclean: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tonSet: function(html)\n\t\t\t\t{\n\t\t\t\t\thtml = this.clean.savePreCode(html);\n\t\t\t\t\thtml = this.clean.saveFormTags(html);\n\n\t\t\t\t\t// convert script tag\n\t\t\t\t\tif (this.opts.script)\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = html.replace(/<script(.*?[^>]?)>([\\w\\W]*?)<\\/script>/gi, '<pre class=\"redactor-script-tag\" $1>$2</pre>');\n\t\t\t\t\t}\n\n\t\t\t\t\t// converting entity\n\t\t\t\t\thtml = html.replace(/\\$/g, '&#36;');\n\t\t\t\t\thtml = html.replace(/&amp;/g, '&');\n\n\t\t\t\t\t// replace special characters in links\n\t\t\t\t\thtml = html.replace(/<a href=\"(.*?[^>]?)(.*?[^>]?)\">/gi, '<a href=\"$1&reg$2\">');\n\n\t\t\t\t\t// save markers\n\t\t\t\t\thtml = html.replace(/<span(.*?[^>]?)id=\"selection-marker-1\"(.*?[^>]?)><\\/span>/gi, '[[[marker1]]]');\n\t\t\t\t\thtml = html.replace(/<span(.*?[^>]?)id=\"selection-marker-2\"(.*?[^>]?)><\\/span>/gi, '[[[marker2]]]');\n\n\t\t\t\t\t// replace tags\n\t\t\t\t\tvar self = this;\n\t\t\t\t\tvar $div = $(\"<div/>\").html($.parseHTML(html, document, true));\n\n\t\t\t\t\tvar replacement = this.opts.replaceTags;\n\t\t\t\t\tif (replacement)\n\t\t\t\t\t{\n                        var keys = Object.keys(this.opts.replaceTags);\n    \t\t\t\t\t$div.find(keys.join(',')).each(function(i,s)\n    \t\t\t\t\t{\n    \t\t\t\t\t\tself.utils.replaceToTag(s, replacement[s.tagName.toLowerCase()]);\n    \t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\thtml = $div.html();\n\n\t\t\t\t\t// remove tags\n\t\t\t\t\tvar tags = ['font', 'html', 'head', 'link', 'body', 'meta', 'applet'];\n\t\t\t\t\tif (!this.opts.script)\n\t\t\t\t\t{\n\t\t\t\t\t\ttags.push('script');\n\t\t\t\t\t}\n\n\t\t\t\t\thtml = this.clean.stripTags(html, tags);\n\n\t\t\t\t\t// remove html comments\n\t\t\t\t\tif (this.opts.removeComments)\n\t\t\t\t\t{\n\t\t\t\t\t    html = html.replace(/<!--[\\s\\S]*?-->/gi, '');\n\t\t\t\t\t}\n\n\t\t\t\t\t// paragraphize\n\t\t\t\t\thtml = this.paragraphize.load(html);\n\n\t\t\t\t\t// restore markers\n\t\t\t\t\thtml = html.replace('[[[marker1]]]', '<span id=\"selection-marker-1\" class=\"redactor-selection-marker\"></span>');\n\t\t\t\t\thtml = html.replace('[[[marker2]]]', '<span id=\"selection-marker-2\" class=\"redactor-selection-marker\"></span>');\n\n\t\t\t\t\t// empty\n\t\t\t\t\tif (html.search(/^(||\\s||<br\\s?\\/?>||&nbsp;)$/i) !== -1)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn this.opts.emptyHtml;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn html;\n\t\t\t\t},\n\t\t\t\tonGet: function(html)\n\t\t\t\t{\n\t\t\t\t\treturn this.clean.onSync(html);\n\t\t\t\t},\n\t\t\t\tonSync: function(html)\n\t\t\t\t{\n\t\t\t\t\t// remove invisible spaces\n\t\t\t\t\thtml = html.replace(/\\u200B/g, '');\n\t\t\t\t\thtml = html.replace(/&#x200b;/gi, '');\n\t\t\t\t\t//html = html.replace(/&nbsp;&nbsp;/gi, '&nbsp;');\n\n\t\t\t\t\tif (html.search(/^<p>(||\\s||<br\\s?\\/?>||&nbsp;)<\\/p>$/i) !== -1)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn '';\n\t\t\t\t\t}\n\n\n\t\t\t\t\t// remove image resize\n\t\t\t\t\thtml = html.replace(/<span(.*?)id=\"redactor-image-box\"(.*?[^>])>([\\w\\W]*?)<img(.*?)><\\/span>/gi, '$3<img$4>');\n\t\t\t\t\thtml = html.replace(/<span(.*?)id=\"redactor-image-resizer\"(.*?[^>])>(.*?)<\\/span>/gi, '');\n\t\t\t\t\thtml = html.replace(/<span(.*?)id=\"redactor-image-editter\"(.*?[^>])>(.*?)<\\/span>/gi, '');\n\t\t\t\t\thtml = html.replace(/<img(.*?)style=\"(.*?)opacity: 0\\.5;(.*?)\"(.*?)>/gi, '<img$1style=\"$2$3\"$4>');\n\n\t\t\t\t\tvar $div = $(\"<div/>\").html($.parseHTML(html, document, true));\n\n\t\t\t\t\t// remove empty atributes\n\t\t\t\t\t$div.find('*[style=\"\"]').removeAttr('style');\n\t\t\t\t\t$div.find('*[class=\"\"]').removeAttr('class');\n\t\t\t\t\t$div.find('*[rel=\"\"]').removeAttr('rel');\n\n\t\t\t\t\t// remove markers\n\t\t\t\t\t$div.find('.redactor-invisible-space').each(function()\n\t\t\t\t\t{\n\t\t\t\t\t\t$(this).contents().unwrap();\n\t\t\t\t\t});\n\n\t\t\t\t\t// remove span without attributes\n\t\t\t\t    $div.find('span').each(function()\n\t\t\t\t\t{\n    \t\t\t\t\tif (this.attributes.length === 0)\n    \t\t\t\t\t{\n\t\t\t\t\t\t    $(this).contents().unwrap();\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\n\t\t\t\t\t// remove rel attribute from img\n\t\t\t\t\t$div.find('img').removeAttr('rel');\n\n\t\t\t\t\t$div.find('.redactor-selection-marker, #redactor-insert-marker').remove();\n\n\t\t\t\t\thtml = $div.html();\n\n\t\t\t\t\t// reconvert script tag\n\t\t\t\t\tif (this.opts.script)\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = html.replace(/<pre class=\"redactor-script-tag\"(.*?[^>]?)>([\\w\\W]*?)<\\/pre>/gi, '<script$1>$2</script>');\n\t\t\t\t\t}\n\n\t\t\t\t\t// restore form tag\n\t\t\t\t\thtml = this.clean.restoreFormTags(html);\n\n\t\t\t\t\t// remove br in|of li/header tags\n\t\t\t\t\thtml = html.replace(new RegExp('<br\\\\s?/?></h', 'gi'), '</h');\n\t\t\t\t\thtml = html.replace(new RegExp('<br\\\\s?/?></li>', 'gi'), '</li>');\n\t\t\t\t\thtml = html.replace(new RegExp('</li><br\\\\s?/?>', 'gi'), '</li>');\n\n\n\t\t\t\t\t// pre class\n\t\t\t\t\thtml = html.replace(/<pre>/gi, \"<pre>\\n\");\n\t\t\t\t\tif (this.opts.preClass)\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = html.replace(/<pre>/gi, '<pre class=\"' + this.opts.preClass + '\">');\n\t\t\t\t\t}\n\n\t\t\t\t\t// link nofollow\n\t\t\t\t\tif (this.opts.linkNofollow)\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = html.replace(/<a(.*?)rel=\"nofollow\"(.*?[^>])>/gi, '<a$1$2>');\n\t\t\t\t\t\thtml = html.replace(/<a(.*?[^>])>/gi, '<a$1 rel=\"nofollow\">');\n\t\t\t\t\t}\n\n\t\t\t\t\t// replace special characters\n\t\t\t\t\tvar chars = {\n\t\t\t\t\t\t'\\u2122': '&trade;',\n\t\t\t\t\t\t'\\u00a9': '&copy;',\n\t\t\t\t\t\t'\\u2026': '&hellip;',\n\t\t\t\t\t\t'\\u2014': '&mdash;',\n\t\t\t\t\t\t'\\u2010': '&dash;'\n\t\t\t\t\t};\n\n\t\t\t\t\t$.each(chars, function(i,s)\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = html.replace(new RegExp(i, 'g'), s);\n\t\t\t\t\t});\n\n\t\t\t\t\thtml = html.replace(/&amp;/g, '&');\n\n\t\t\t\t\t// remove empty paragpraphs\n\t\t\t\t\thtml = html.replace(/<p><\\/p>/gi, \"\");\n\n\t\t\t\t\t// remove new lines\n                    html = html.replace(/\\n{2,}/g, \"\\n\");\n\n\t\t\t\t\treturn html;\n\t\t\t\t},\n\t\t\t\tonPaste: function(html, data, insert)\n\t\t\t\t{\n\t\t\t\t\t// if paste event\n\t\t\t\t\tif (insert !== true)\n\t\t\t\t\t{\n    \t\t\t\t\t// remove google docs markers\n                        html = html.replace(/<b\\sid=\"internal-source-marker(.*?)\">([\\w\\W]*?)<\\/b>/gi, \"$2\");\n    \t\t\t\t\thtml = html.replace(/<b(.*?)id=\"docs-internal-guid(.*?)\">([\\w\\W]*?)<\\/b>/gi, \"$3\");\n\n                        // google docs styles\n                        html = html.replace(/<span[^>]*(font-style: italic; font-weight: bold|font-weight: bold; font-style: italic)[^>]*>([\\w\\W]*?)<\\/span>/gi, '<b><i>$2</i></b>');\n                        html = html.replace(/<span[^>]*(font-style: italic; font-weight: 700|font-weight: 700; font-style: italic)[^>]*>([\\w\\W]*?)<\\/span>/gi, '<b><i>$2</i></b>');\n                        html = html.replace(/<span[^>]*font-style: italic[^>]*>([\\w\\W]*?)<\\/span>/gi, '<i>$1</i>');\n                        html = html.replace(/<span[^>]*font-weight: bold[^>]*>([\\w\\W]*?)<\\/span>/gi, '<b>$1</b>');\n                        html = html.replace(/<span[^>]*font-weight: 700[^>]*>([\\w\\W]*?)<\\/span>/gi, '<b>$1</b>');\n\n\t\t\t\t\t\tvar msword = this.clean.isHtmlMsWord(html);\n\t\t\t\t\t\tif (msword)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\thtml = this.clean.cleanMsWord(html);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\thtml = $.trim(html);\n\n\t\t\t\t\tif (data.pre)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (this.opts.preSpaces)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\thtml = html.replace(/\\t/g, new Array(this.opts.preSpaces + 1).join(' '));\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = this.clean.replaceBrToNl(html);\n\t\t\t\t\t\thtml = this.clean.removeTagsInsidePre(html);\n\t\t\t\t\t}\n\n\t\t\t\t\t// if paste event\n\t\t\t\t\tif (insert !== true)\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = this.clean.removeSpans(html);\n\t\t\t\t\t\thtml = this.clean.removeEmptyInlineTags(html);\n\n\n\t\t\t\t\t\tif (data.encode === false)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\thtml = html.replace(/&/g, '&amp;');\n\t\t\t\t\t\t\thtml = this.clean.convertTags(html, data);\n\t\t\t\t\t\t\thtml = this.clean.getPlainText(html);\n\t\t\t\t\t\t\thtml = this.clean.reconvertTags(html, data);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}\n\n\t\t\t\t\tif (data.text)\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = this.clean.replaceNbspToSpaces(html);\n\t\t\t\t\t\thtml = this.clean.getPlainText(html);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (data.lists)\n\t\t\t\t\t{\n    \t\t\t\t\thtml = html.replace(\"\\n\", '<br>');\n    \t\t\t\t}\n\n\t\t\t\t\tif (data.encode)\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = this.clean.encodeHtml(html);\n\t\t\t\t\t}\n\n\n\t\t\t\t\tif (data.paragraphize)\n\t\t\t\t\t{\n\n\t\t\t\t\t\thtml = this.paragraphize.load(html);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn html;\n\n\t\t\t\t},\n\t\t\t\tgetCurrentType: function(html, insert)\n\t\t\t\t{\n\t\t\t\t\tvar blocks = this.selection.blocks();\n\n\t\t\t\t\tvar data = {\n\t\t\t\t\t\ttext: false,\n\t\t\t\t\t\tencode: false,\n\t\t\t\t\t\tparagraphize: true,\n\t\t\t\t\t\tline: this.clean.isHtmlLine(html),\n\t\t\t\t\t\tblocks: this.clean.isHtmlBlocked(html),\n\t\t\t\t\t\tpre: false,\n\t\t\t\t\t\tlists: false,\n\t\t\t\t\t\tblock: true,\n\t\t\t\t\t\tinline: true,\n\t\t\t\t\t\tlinks: true,\n\t\t\t\t\t\timages: true\n\t\t\t\t\t};\n\n\t\t\t\t\tif (blocks.length === 1 && this.utils.isCurrentOrParent(['h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'a', 'figcaption']))\n\t\t\t\t\t{\n\t\t\t\t\t\tdata.text = true;\n\t\t\t\t\t\tdata.paragraphize = false;\n\t\t\t\t\t\tdata.inline = false;\n\t\t\t\t\t\tdata.images = false;\n\t\t\t\t\t\tdata.links = false;\n\t\t\t\t\t\tdata.line = true;\n\t\t\t\t\t}\n\t\t\t\t\telse if (this.opts.type === 'inline' || this.opts.enterKey === false)\n\t\t\t\t\t{\n\t\t\t\t\t\tdata.paragraphize = false;\n\t\t\t\t\t\tdata.block = false;\n\t\t\t\t\t\tdata.line = true;\n\t\t\t\t\t}\n\t\t\t\t\telse if (blocks.length === 1 && this.utils.isCurrentOrParent(['li']))\n\t\t\t\t\t{\n\t\t\t\t\t\tdata.lists = true;\n\t\t\t\t\t\tdata.block = false;\n\t\t\t\t\t\tdata.paragraphize = false;\n\t\t\t\t\t\tdata.images = false;\n\t\t\t\t\t}\n\t\t\t\t\telse if (blocks.length === 1 && this.utils.isCurrentOrParent(['th', 'td', 'blockquote']))\n\t\t\t\t\t{\n\t\t\t\t\t\tdata.block = false;\n\t\t\t\t\t\tdata.paragraphize = false;\n\n\t\t\t\t\t}\n\t\t\t\t\telse if (this.opts.type === 'pre' || (blocks.length === 1 && this.utils.isCurrentOrParent('pre')))\n\t\t\t\t\t{\n\t\t\t\t\t\tdata.inline = false;\n\t\t\t\t\t\tdata.block = false;\n\t\t\t\t\t\tdata.encode = true;\n\t\t\t\t\t\tdata.pre = true;\n\t\t\t\t\t\tdata.paragraphize = false;\n\t\t\t\t\t\tdata.images = false;\n\t\t\t\t\t\tdata.links = false;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (data.line === true)\n\t\t\t\t\t{\n\t\t\t\t\t\tdata.paragraphize = false;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (insert === true)\n\t\t\t\t\t{\n\t\t\t\t\t\tdata.text = false;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn data;\n\n\t\t\t\t},\n\t\t\t\tisHtmlBlocked: function(html)\n\t\t\t\t{\n\t\t\t\t\tvar match1 = html.match(new RegExp('</(' + this.opts.blockTags.join('|' ).toUpperCase() + ')>', 'gi'));\n\t\t\t\t\tvar match2 = html.match(new RegExp('<hr(.*?[^>])>', 'gi'));\n\n\t\t\t\t\treturn (match1 === null && match2 === null) ? false : true;\n\t\t\t\t},\n\t\t\t\tisHtmlLine: function(html)\n\t\t\t\t{\n\t\t\t\t\tif (this.clean.isHtmlBlocked(html))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar matchBR = html.match(/<br\\s?\\/?>/gi);\n\t\t\t\t\tvar matchNL = html.match(/\\n/gi);\n\n\t\t\t\t\treturn (!matchBR && !matchNL) ? true : false;\n\t\t\t\t},\n\t\t\t\tisHtmlMsWord: function(html)\n\t\t\t\t{\n\t\t\t\t\treturn html.match(/class=\"?Mso|style=\"[^\"]*\\bmso-|style='[^'']*\\bmso-|w:WordDocument/i);\n\t\t\t\t},\n\t\t\t\tremoveEmptyInlineTags: function(html)\n\t\t\t\t{\n\t\t\t\t\tvar tags = this.opts.inlineTags;\n\t\t\t\t\tvar len = tags.length;\n\t\t\t\t\tfor (var i = 0; i < len; i++)\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = html.replace(new RegExp('<' + tags[i] + '[^>]*>(\\s\\n|\\t)?</' + tags[i] + '>', 'gi'), '');\n\t\t\t\t\t}\n\n\t\t\t\t\treturn html;\n\t\t\t\t},\n\t\t\t\tremoveSpans: function(html)\n\t\t\t\t{\n\t\t\t\t\thtml = html.replace(/<\\/span>/gi, '');\n\t\t\t\t\thtml = html.replace(/<span[^>]*>/gi, '');\n\n\t\t\t\t\treturn html;\n\t\t\t\t},\n\t\t\t\tcleanMsWord: function(html)\n\t\t\t\t{\n    \t\t\t\thtml = html.replace(/<!--[\\s\\S]*?-->/g, \"\");\n    \t\t\t\thtml = html.replace(/<o:p>[\\s\\S]*?<\\/o:p>/gi, '');\n\t\t\t\t\thtml = html.replace(/\\n/g, \" \");\n\t\t\t\t\thtml = html.replace(/<br\\s?\\/?>|<\\/p>|<\\/div>|<\\/li>|<\\/td>/gi, '\\n\\n');\n\n\t\t\t\t\t// lists\n\t\t\t\t\tvar $div = $(\"<div/>\").html(html);\n\n\t\t\t\t\tvar lastList = false;\n\t\t\t\t\tvar lastLevel = 1;\n\t\t\t\t\tvar listsIds = [];\n\n\t\t\t\t\t$div.find(\"p[style]\").each(function()\n\t\t\t\t\t{\n\t\t\t\t\t\tvar matches = $(this).attr('style').match(/mso\\-list\\:l([0-9]+)\\slevel([0-9]+)/);\n\n\t\t\t\t\t\tif (matches)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar currentList = parseInt(matches[1]);\n\t\t\t\t\t\t\tvar currentLevel = parseInt(matches[2]);\n\t\t\t\t\t\t\tvar listType = $(this).html().match(/^[\\w]+\\./) ? \"ol\" : \"ul\";\n\n\t\t\t\t\t\t\tvar $li = $(\"<li/>\").html($(this).html());\n\n\t\t\t\t\t\t\t$li.html($li.html().replace(/^([\\w\\.]+)</, '<'));\n\t\t\t\t\t\t\t$li.find(\"span:first\").remove();\n\n\t\t\t\t\t\t\tif (currentLevel == 1 && $.inArray(currentList, listsIds) == -1)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tvar $list = $(\"<\" + listType + \"/>\").attr({\"data-level\": currentLevel, \"data-list\": currentList}).html($li);\n\t\t\t\t\t\t\t\t$(this).replaceWith($list);\n\n\t\t\t\t\t\t\t\tlastList = currentList;\n\t\t\t\t\t\t\t\tlistsIds.push(currentList);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tif (currentLevel > lastLevel)\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tvar $prevList = $div.find('[data-level=\"' + lastLevel + '\"][data-list=\"' + lastList + '\"]');\n\t\t\t\t\t\t\t\t\tvar $lastList = $prevList;\n\n\t\t\t\t\t\t\t\t\tfor(var i = lastLevel; i < currentLevel; i++)\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t$list = $(\"<\" + listType + \"/>\");\n\t\t\t\t\t\t\t\t\t\t$list.appendTo($lastList.find(\"li\").last());\n\n\t\t\t\t\t\t\t\t\t\t$lastList = $list;\n\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t$lastList.attr({\"data-level\": currentLevel, \"data-list\": currentList}).html($li);\n\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tvar $prevList = $div.find('[data-level=\"' + currentLevel + '\"][data-list=\"' + currentList + '\"]').last();\n\n\t\t\t\t\t\t\t\t\t$prevList.append($li);\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tlastLevel = currentLevel;\n\t\t\t\t\t\t\t\tlastList = currentList;\n\n\t\t\t\t\t\t\t\t$(this).remove();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\n\t\t\t\t\t$div.find('[data-level][data-list]').removeAttr('data-level data-list');\n\t\t\t\t\thtml = $div.html();\n\n\t\t\t\t\treturn html;\n\t\t\t\t},\n\t\t\t\treplaceNbspToSpaces: function(html)\n\t\t\t\t{\n\t\t\t\t\treturn html.replace('&nbsp;', ' ');\n\t\t\t\t},\n\t\t\t\treplaceBrToNl: function(html)\n\t\t\t\t{\n\t\t\t\t\treturn html.replace(/<br\\s?\\/?>/gi, '\\n');\n\t\t\t\t},\n\t\t\t\treplaceNlToBr: function(html)\n\t\t\t\t{\n\t\t\t\t\treturn html.replace(/\\n/g, '<br />');\n\t\t\t\t},\n\t\t\t\tconvertTags: function(html, data)\n\t\t\t\t{\n                    var $div = $('<div>').html(html);\n\n                    // remove iframe\n\t\t\t\t\t$div.find('iframe').remove();\n\n\t\t\t\t\t// link target & attrs\n\t\t\t\t\tvar $links = $div.find('a');\n\t\t\t\t\t$links.removeAttr('style');\n\t\t\t\t\tif (this.opts.pasteLinkTarget !== false)\n\t\t\t\t\t{\n    \t\t\t\t\t$links.attr('target', this.opts.pasteLinkTarget);\n\t\t\t\t\t}\n\n\t\t\t\t\thtml = $div.html();\n\n\n                    // links & images\n\t\t\t\t\tif (data.links && this.opts.pasteLinks)\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = html.replace(/<a(.*?)href=\"(.*?[^>])\"(.*?[^>])>(.*?)<\\/a>/gi, '##%a$1href=\"$2\"$3%##$4##%/a%##');\n\t\t\t\t\t}\n\n\t\t\t\t\tif (data.images && this.opts.pasteImages)\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = html.replace(/<img(.*?)src=\"(.*?)\"(.*?[^>])>/gi, '##%img$1src=\"$2\"$3%##');\n\t\t\t\t\t}\n\n\t\t\t\t\t// plain text\n\t\t\t\t\tif (this.opts.pastePlainText)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn html;\n\t\t\t\t\t}\n\n\n\n\t\t\t\t\t// all tags\n\t\t\t\t\tvar blockTags = (data.lists) ? ['ul', 'ol', 'li'] : this.opts.pasteBlockTags;\n\n\t\t\t\t\tvar tags;\n\t\t\t\t\tif (data.block || data.lists)\n\t\t\t\t\t{\n\t\t\t\t\t\ttags = (data.inline) ? blockTags.concat(this.opts.pasteInlineTags) : blockTags;\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\ttags = (data.inline) ? this.opts.pasteInlineTags : [];\n\t\t\t\t\t}\n\n\n\t\t\t\t\tvar len = tags.length;\n\t\t\t\t\tfor (var i = 0; i < len; i++)\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = html.replace(new RegExp('<\\/' + tags[i] + '>', 'gi'), '###/' + tags[i] + '###');\n\n\t\t\t\t\t\tif (tags[i] === 'td' || tags[i] === 'th')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\thtml = html.replace(new RegExp('<' + tags[i] + '(.*?[^>])((colspan|rowspan)=\"(.*?[^>])\")?(.*?[^>])>', 'gi'), '###' + tags[i] + ' $2###');\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\thtml = html.replace(new RegExp('<' + tags[i] + '[^>]*>', 'gi'), '###' + tags[i] + '###');\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\treturn html;\n\n\t\t\t\t},\n\t\t\t\treconvertTags: function(html, data)\n\t\t\t\t{\n\t\t\t\t\t// links & images\n\t\t\t\t\tif ((data.links && this.opts.pasteLinks) || (data.images && this.opts.pasteImages))\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = html.replace(new RegExp('##%', 'gi'), '<');\n\t\t\t\t\t\thtml = html.replace(new RegExp('%##', 'gi'), '>');\n                    }\n\n\t\t\t\t\t// plain text\n\t\t\t\t\tif (this.opts.pastePlainText)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn html;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar blockTags = (data.lists) ? ['ul', 'ol', 'li'] : this.opts.pasteBlockTags;\n\n\t\t\t\t\tvar tags;\n\t\t\t\t\tif (data.block || data.lists)\n\t\t\t\t\t{\n\t\t\t\t\t\ttags = (data.inline) ? blockTags.concat(this.opts.pasteInlineTags) : blockTags;\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\ttags = (data.inline) ? this.opts.pasteInlineTags : [];\n\t\t\t\t\t}\n\n\t\t\t\t\tvar len = tags.length;\n\t\t\t\t\tfor (var i = 0; i < len; i++)\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = html.replace(new RegExp('###\\/' + tags[i] + '###', 'gi'), '</' + tags[i] + '>');\n\t\t\t\t\t\thtml = html.replace(new RegExp('###' + tags[i] + '###', 'gi'), '<' + tags[i] + '>');\n                    }\n\n\t\t\t\t\tfor (var i = 0; i < len; i++)\n\t\t\t\t\t{\n                        if (tags[i] === 'td' || tags[i] === 'th')\n                        {\n\t\t\t\t\t\t    html = html.replace(new RegExp('###' + tags[i] + '\\s?(.*?[^#])###', 'gi'), '<' + tags[i] + '$1>');\n                        }\n                    }\n\n\t\t\t\t\treturn html;\n\n\t\t\t\t},\n\t\t\t\tcleanPre: function(block)\n\t\t\t\t{\n\t\t\t\t\tblock = (typeof block === 'undefined') ? $(this.selection.block()).closest('pre', this.core.editor()[0]) : block;\n\n\t\t\t\t\t$(block).find('br').replaceWith(function()\n\t\t\t\t\t{\n\t\t\t\t\t\treturn document.createTextNode('\\n');\n\t\t\t\t\t});\n\n\t\t\t\t\t$(block).find('p').replaceWith(function()\n\t\t\t\t\t{\n\t\t\t\t\t\treturn $(this).contents();\n\t\t\t\t\t});\n\n\t\t\t\t},\n\t\t\t\tremoveTagsInsidePre: function(html)\n\t\t\t\t{\n\t\t\t\t\tvar $div = $('<div />').append(html);\n\t\t\t\t\t$div.find('pre').replaceWith(function()\n\t\t\t\t\t{\n\t\t\t\t\t\tvar str = $(this).html();\n\t\t\t\t\t\tstr = str.replace(/<br\\s?\\/?>|<\\/p>|<\\/div>|<\\/li>|<\\/td>/gi, '\\n');\n\t\t\t\t\t\tstr = str.replace(/(<([^>]+)>)/gi, '');\n\n\t\t\t\t\t\treturn $('<pre />').append(str);\n\t\t\t\t\t});\n\n\t\t\t\t\thtml = $div.html();\n\t\t\t\t\t$div.remove();\n\n\t\t\t\t\treturn html;\n\n\t\t\t\t},\n\t\t\t\tgetPlainText: function(html)\n\t\t\t\t{\n\t\t\t\t\thtml = html.replace(/<!--[\\s\\S]*?-->/gi, '');\n\t\t\t\t\thtml = html.replace(/<style[\\s\\S]*?style>/gi, '');\n\t\t\t\t\thtml = html.replace(/<\\/p>|<\\/div>|<\\/li>|<\\/td>/gi, '\\n');\n\t\t\t\t\thtml = html.replace(/<\\/H[1-6]>/gi, '\\n\\n');\n\n\t\t\t\t\tvar tmp = document.createElement('div');\n\t\t\t\t\ttmp.innerHTML = html;\n\t\t\t\t\thtml = tmp.textContent || tmp.innerText;\n\n\t\t\t\t\treturn $.trim(html);\n\t\t\t\t},\n\t\t\t\tsavePreCode: function(html)\n\t\t\t\t{\n\t\t\t\t\thtml = this.clean.savePreFormatting(html);\n\t\t\t\t\thtml = this.clean.saveCodeFormatting(html);\n\t\t\t\t\thtml = this.clean.restoreSelectionMarkers(html);\n\n\t\t\t\t\treturn html;\n\t\t\t\t},\n\t\t\t\tsavePreFormatting: function(html)\n\t\t\t\t{\n\t\t\t\t\tvar pre = html.match(/<pre(.*?)>([\\w\\W]*?)<\\/pre>/gi);\n\t\t\t\t\tif (pre === null)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn html;\n\t\t\t\t\t}\n\n\t\t\t\t\t$.each(pre, $.proxy(function(i,s)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar arr = s.match(/<pre(.*?)>([\\w\\W]*?)<\\/pre>/i);\n\n\t\t\t\t\t\tarr[2] = arr[2].replace(/<br\\s?\\/?>/g, '\\n');\n\t\t\t\t\t\tarr[2] = arr[2].replace(/&nbsp;/g, ' ');\n\n\t\t\t\t\t\tif (this.opts.preSpaces)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tarr[2] = arr[2].replace(/\\t/g, new Array(this.opts.preSpaces + 1).join(' '));\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tarr[2] = this.clean.encodeEntities(arr[2]);\n\n\t\t\t\t\t\t// $ fix\n\t\t\t\t\t\tarr[2] = arr[2].replace(/\\$/g, '&#36;');\n\n\t\t\t\t\t\thtml = html.replace(s, '<pre' + arr[1] + '>' + arr[2] + '</pre>');\n\n\t\t\t\t\t}, this));\n\n\t\t\t\t\treturn html;\n\t\t\t\t},\n\t\t\t\tsaveCodeFormatting: function(html)\n\t\t\t\t{\n\t\t\t\t\tvar code = html.match(/<code(.*?)>([\\w\\W]*?)<\\/code>/gi);\n\t\t\t\t\tif (code === null)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn html;\n\t\t\t\t\t}\n\n\t\t\t\t\t$.each(code, $.proxy(function(i,s)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar arr = s.match(/<code(.*?)>([\\w\\W]*?)<\\/code>/i);\n\n\t\t\t\t\t\tarr[2] = arr[2].replace(/&nbsp;/g, ' ');\n\t\t\t\t\t\tarr[2] = this.clean.encodeEntities(arr[2]);\n\t\t\t\t\t\tarr[2] = arr[2].replace(/\\$/g, '&#36;');\n\n\t\t\t\t\t\thtml = html.replace(s, '<code' + arr[1] + '>' + arr[2] + '</code>');\n\n\t\t\t\t\t}, this));\n\n\t\t\t\t\treturn html;\n\t\t\t\t},\n\t\t\t\trestoreSelectionMarkers: function(html)\n\t\t\t\t{\n\t\t\t\t\thtml = html.replace(/&lt;span id=&quot;selection-marker-([0-9])&quot; class=&quot;redactor-selection-marker&quot;&gt;&lt;\\/span&gt;/g, '<span id=\"selection-marker-$1\" class=\"redactor-selection-marker\"></span>');\n\n\t\t\t\t\treturn html;\n\t\t\t\t},\n\t\t\t\tsaveFormTags: function(html)\n\t\t\t\t{\n\t\t\t\t\treturn html.replace(/<form(.*?)>([\\w\\W]*?)<\\/form>/gi, '<section$1 rel=\"redactor-form-tag\">$2</section>');\n\t\t\t\t},\n\t\t\t\trestoreFormTags: function(html)\n\t\t\t\t{\n\t\t\t\t\treturn html.replace(/<section(.*?) rel=\"redactor-form-tag\"(.*?)>([\\w\\W]*?)<\\/section>/gi, '<form$1$2>$3</form>');\n\t\t\t\t},\n\t\t\t\tencodeHtml: function(html)\n\t\t\t\t{\n\t\t\t\t\thtml = html.replace(//g, '\"');\n\t\t\t\t\thtml = html.replace(//g, '\"');\n\t\t\t\t\thtml = html.replace(//g, '\\'');\n\t\t\t\t\thtml = html.replace(//g, '\\'');\n\t\t\t\t\thtml = this.clean.encodeEntities(html);\n\n\t\t\t\t\treturn html;\n\t\t\t\t},\n\t\t\t\tencodeEntities: function(str)\n\t\t\t\t{\n\t\t\t\t\tstr = String(str).replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&quot;/g, '\"');\n\t\t\t\t\tstr = str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\"/g, '&quot;');\n\n\t\t\t\t\treturn str;\n\t\t\t\t},\n\t\t\t\tstripTags: function(input, denied)\n\t\t\t\t{\n\t\t\t\t\tif (typeof denied === 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn input.replace(/(<([^>]+)>)/gi, '');\n\t\t\t\t\t}\n\n\t\t\t\t    var tags = /<\\/?([a-z][a-z0-9]*)\\b[^>]*>/gi;\n\n\t\t\t\t    return input.replace(tags, function ($0, $1)\n\t\t\t\t    {\n\t\t\t\t        return denied.indexOf($1.toLowerCase()) === -1 ? $0 : '';\n\t\t\t\t    });\n\t\t\t\t},\n\t\t\t\tremoveMarkers: function(html)\n\t\t\t\t{\n\t\t\t\t\treturn html.replace(/<span(.*?[^>]?)class=\"redactor-selection-marker\"(.*?[^>]?)>([\\w\\W]*?)<\\/span>/gi, '');\n\t\t\t\t},\n\t\t\t\tremoveSpaces: function(html)\n\t\t\t\t{\n\t\t\t\t\thtml = $.trim(html);\n\t\t\t\t\thtml = html.replace(/\\n/g, '');\n\t\t\t\t\thtml = html.replace(/[\\t]*/g, '');\n\t\t\t\t\thtml = html.replace(/\\n\\s*\\n/g, \"\\n\");\n\t\t\t\t\thtml = html.replace(/^[\\s\\n]*/g, ' ');\n\t\t\t\t\thtml = html.replace(/[\\s\\n]*$/g, ' ');\n\t\t\t\t\thtml = html.replace( />\\s{2,}</g, '> <'); // between inline tags can be only one space\n\t\t\t\t\thtml = html.replace(/\\n\\n/g, \"\\n\");\n\t\t\t\t\thtml = html.replace(/\\u200B/g, '');\n\n\t\t\t\t\treturn html;\n\t\t\t\t},\n\t\t\t\tremoveSpacesHard: function(html)\n\t\t\t\t{\n\t\t\t\t\thtml = $.trim(html);\n\t\t\t\t\thtml = html.replace(/\\n/g, '');\n\t\t\t\t\thtml = html.replace(/[\\t]*/g, '');\n\t\t\t\t\thtml = html.replace(/\\n\\s*\\n/g, \"\\n\");\n\t\t\t\t\thtml = html.replace(/^[\\s\\n]*/g, '');\n\t\t\t\t\thtml = html.replace(/[\\s\\n]*$/g, '');\n\t\t\t\t\thtml = html.replace( />\\s{2,}</g, '><');\n\t\t\t\t\thtml = html.replace(/\\n\\n/g, \"\\n\");\n\t\t\t\t\thtml = html.replace(/\\u200B/g, '');\n\n\t\t\t\t\treturn html;\n\t\t\t\t},\n\t\t\t\tnormalizeCurrentHeading: function()\n\t\t\t\t{\n\t\t\t\t\tvar heading = this.selection.block();\n\t\t\t\t\tif (this.utils.isCurrentOrParentHeader() && heading)\n\t\t\t\t\t{\n\t\t\t\t\t\theading.normalize();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =code\n\t\tcode: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tsyncFire: true,\n\t\t\t\thtml: false,\n\t\t\t\tstart: function(html)\n\t\t\t\t{\n\t\t\t\t\thtml = $.trim(html);\n\t\t\t\t\thtml = html.replace(/^(<span id=\"selection-marker-1\" class=\"redactor-selection-marker\"><\\/span>)/, '');\n\n\t\t\t\t\t// clean\n\t\t\t\t\tif (this.opts.type === 'textarea')\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = this.clean.onSet(html);\n\t\t\t\t\t}\n\t\t\t\t\telse if (this.opts.type === 'div' && html === '')\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = this.opts.emptyHtml;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.events.stopDetectChanges();\n\t\t\t\t\tthis.core.editor().html(html);\n\t\t\t\t\tthis.observe.load();\n\t\t\t\t\tthis.events.startDetectChanges();\n\t\t\t\t},\n\t\t\t\tset: function(html, options)\n\t\t\t\t{\n\t\t\t\t\thtml = $.trim(html);\n\n\n                    options = options || {};\n\n                    // start\n                    if (options.start)\n                    {\n                        this.start = options.start;\n                    }\n\n\t\t\t\t\t// clean\n\t\t\t\t\tif (this.opts.type === 'textarea')\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = this.clean.onSet(html);\n\t\t\t\t\t}\n\t\t\t\t\telse if (this.opts.type === 'div' && html === '')\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = this.opts.emptyHtml;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.core.editor().html(html);\n\n\t\t\t\t\tif (this.opts.type === 'textarea')\n\t\t\t\t\t{\n    \t\t\t\t\tthis.code.sync();\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.placeholder.enable();\n\t\t\t\t},\n\t\t\t\tget: function()\n\t\t\t\t{\n\t\t\t\t\tif (this.opts.type === 'textarea')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn this.core.textarea().val();\n                    }\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tvar html = this.core.editor().html();\n\n\t\t\t\t\t\t// clean\n\t\t\t\t\t\thtml = this.clean.onGet(html);\n\n\t\t\t\t\t\treturn html;\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tsync: function()\n\t\t\t\t{\n\t\t\t\t\tif (!this.code.syncFire)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar html = this.core.editor().html();\n\t\t\t\t\tvar htmlCleaned = this.code.cleaned(html);\n\n\t\t\t\t\t// is there a need to synchronize\n\t\t\t\t\tif (this.code.isSync(htmlCleaned))\n\t\t\t\t\t{\n\t\t\t\t\t\t// do not sync\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\t// save code\n\t\t\t\t\tthis.code.html = htmlCleaned;\n\n\t\t\t\t\tif (this.opts.type !== 'textarea')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.callback('sync', html);\n\t\t\t\t\t\tthis.core.callback('change', html);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.opts.type === 'textarea')\n\t\t\t\t\t{\n\t\t\t\t\t\tsetTimeout($.proxy(function()\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.code.startSync(html);\n\n\t\t\t\t\t\t}, this), 10);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tstartSync: function(html)\n\t\t\t\t{\n\t\t\t\t\t// before clean callback\n\t\t\t\t\thtml = this.core.callback('syncBefore', html);\n\n\t\t\t\t\t// clean\n\t\t\t\t\thtml = this.clean.onSync(html);\n\n\t\t\t\t\t// set code\n\t\t\t\t\tthis.core.textarea().val(html);\n\n\t\t\t\t\t// after sync callback\n\t\t\t\t\tthis.core.callback('sync', html);\n\n\t\t\t\t\t// change callback\n\t\t\t\t\tif (this.start === false)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.callback('change', html);\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.start = false;\n\t\t\t\t},\n\t\t\t\tisSync: function(htmlCleaned)\n\t\t\t\t{\n\t\t\t\t\tvar html = (this.code.html !== false) ? this.code.html : false;\n\n\t\t\t\t\treturn (html !== false && html === htmlCleaned);\n\t\t\t\t},\n\t\t\t\tcleaned: function(html)\n\t\t\t\t{\n\t\t\t\t\thtml = html.replace(/\\u200B/g, '');\n\t\t\t\t\treturn this.clean.removeMarkers(html);\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =core\n\t\tcore: function()\n\t\t{\n\t\t\treturn {\n\n\t\t\t\tid: function()\n\t\t\t\t{\n\t\t\t\t\treturn this.$editor.attr('id');\n\t\t\t\t},\n\t\t\t\telement: function()\n\t\t\t\t{\n\t\t\t\t\treturn this.$element;\n\t\t\t\t},\n\t\t\t\teditor: function()\n\t\t\t\t{\n\t\t\t\t\treturn (typeof this.$editor === 'undefined') ? $() : this.$editor;\n\t\t\t\t},\n\t\t\t\ttextarea: function()\n\t\t\t\t{\n\t\t\t\t\treturn this.$textarea;\n\t\t\t\t},\n\t\t\t\tbox: function()\n\t\t\t\t{\n\t\t\t\t\treturn (this.opts.type === 'textarea') ? this.$box : this.$element;\n\t\t\t\t},\n\t\t\t\ttoolbar: function()\n\t\t\t\t{\n\t\t\t\t\treturn (this.$toolbar) ? this.$toolbar : false;\n\t\t\t\t},\n\t\t\t\tair: function()\n\t\t\t\t{\n\t\t\t\t\treturn (this.$air) ? this.$air : false;\n\t\t\t\t},\n\t\t\t\tobject: function()\n\t\t\t\t{\n\t\t\t\t\treturn $.extend({}, this);\n\t\t\t\t},\n\t\t\t\tstructure: function()\n\t\t\t\t{\n\t\t\t\t\tthis.core.editor().toggleClass('redactor-structure');\n\t\t\t\t},\n\t\t\t\taddEvent: function(name)\n\t\t\t\t{\n\t\t\t\t\tthis.core.event = name;\n\t\t\t\t},\n\t\t\t\tgetEvent: function()\n\t\t\t\t{\n\t\t\t\t\treturn this.core.event;\n\t\t\t\t},\n\t\t\t\tcallback: function(type, e, data)\n\t\t\t\t{\n\t\t\t\t\tvar eventNamespace = 'redactor';\n\t\t\t\t\tvar returnValue = false;\n\t\t\t\t\tvar events = $._data(this.core.element()[0], 'events');\n\n\t\t\t\t\t// on callback\n\t\t\t\t\tif (typeof events !== 'undefined' && typeof events[type] !== 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\tvar len = events[type].length;\n\t\t\t\t\t\tfor (var i = 0; i < len; i++)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar namespace = events[type][i].namespace;\n\t\t\t\t\t\t\tif (namespace === 'callback.' + eventNamespace)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tvar handler = events[type][i].handler;\n\t\t\t\t\t\t\t\tvar args = (typeof data === 'undefined') ? [e] : [e, data];\n\t\t\t\t\t\t\t\treturnValue = (typeof args === 'undefined') ? handler.call(this, e) : handler.call(this, e, args);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (returnValue)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn returnValue;\n\t\t\t\t\t}\n\n\t\t\t\t\t// no callback\n\t\t\t\t\tif (typeof this.opts.callbacks[type] === 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn (typeof data === 'undefined') ? e : data;\n\t\t\t\t\t}\n\n\t\t\t\t\t// callback\n\t\t\t\t\tvar callback = this.opts.callbacks[type];\n\n\t\t\t\t\tif ($.isFunction(callback))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn (typeof data === 'undefined') ? callback.call(this, e) : callback.call(this, e, data);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\treturn (typeof data === 'undefined') ? e : data;\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tdestroy: function()\n\t\t\t\t{\n\t\t\t\t\tthis.opts.destroyed = true;\n\n\t\t\t\t\tthis.core.callback('destroy');\n\n\t\t\t\t\t// placeholder\n\t\t\t\t\tthis.placeholder.destroy();\n\n\t\t\t\t\t// progress\n\t\t\t\t\tthis.progress.destroy();\n\n\t\t\t\t\t// help label\n\t\t\t\t\t$('#redactor-voice-' + this.uuid).remove();\n\n\t\t\t\t\tthis.core.editor().removeClass('redactor-in redactor-structure redactor-editor-img-edit');\n\n\t\t\t\t\t// caret service\n\t\t\t\t\tthis.core.editor().off('keydown.redactor-remove-textnode');\n\n\t\t\t\t\t// observer\n\t\t\t\t\tthis.core.editor().off('.redactor-observe.' + this.uuid);\n\n\t\t\t\t\t// off events and remove data\n\t\t\t\t\tthis.$element.off('.redactor').removeData('redactor');\n\t\t\t\t\tthis.core.editor().off('.redactor');\n\n\t\t\t\t\t$(document).off('.redactor-dropdown');\n\t\t\t\t\t$(document).off('.redactor-air.' + this.uuid);\n\t\t\t\t\t$(document).off('mousedown.redactor-blur.' + this.uuid);\n\t\t\t\t\t$(document).off('mousedown.redactor.' + this.uuid);\n\t\t\t\t\t$(document).off('touchstart.redactor.' + this.uuid + ' click.redactor.' + this.uuid);\n\t\t\t\t\t$(window).off('.redactor-toolbar.' + this.uuid);\n\t\t\t\t\t$(window).off('touchmove.redactor.' + this.uuid);\n\t\t\t\t\t$(\"body\").off('scroll.redactor.' + this.uuid);\n\n\t\t\t\t\t$(this.opts.toolbarFixedTarget).off('scroll.redactor.' + this.uuid);\n\n\t\t\t\t\t// plugins events\n\t\t\t\t\tvar self = this;\n\t\t\t\t\tif (this.opts.plugins !== false)\n\t\t\t\t\t{\n\t\t\t\t\t\t$.each(this.opts.plugins, function(i,s)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$(window).off('.redactor-plugin-' + s);\n\t\t\t\t\t\t\t$(document).off('.redactor-plugin-' + s);\n\t\t\t\t\t\t\t$(\"body\").off('.redactor-plugin-' + s);\n\t\t\t\t\t\t\tself.core.editor().off('.redactor-plugin-' + s);\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\t// click to edit\n\t\t\t\t\tthis.$element.off('click.redactor-click-to-edit');\n\t\t\t\t\tthis.$element.removeClass('redactor-click-to-edit');\n\n\t\t\t\t\t// common\n\t\t\t\t\tthis.core.editor().removeClass('redactor-editor');\n\t\t\t\t\tthis.core.editor().removeAttr('contenteditable');\n\n\t\t\t\t\tvar html = this.code.get();\n\n\t\t\t\t\tif (this.opts.toolbar && this.$toolbar)\n\t\t\t\t\t{\n\t\t\t\t\t\t// dropdowns off\n\t\t\t\t\t\tthis.$toolbar.find('a').each(function()\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar $el = $(this);\n\t\t\t\t\t\t\tif ($el.data('dropdown'))\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t$el.data('dropdown').remove();\n\t\t\t\t\t\t\t\t$el.data('dropdown', {});\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.opts.type === 'textarea')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.$box.after(this.$element);\n\t\t\t\t\t\tthis.$box.remove();\n\t\t\t\t\t\tthis.$element.val(html).show();\n\t\t\t\t\t}\n\n\t\t\t\t\t// air\n\t\t\t\t\tif (this.opts.air)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.$air.remove();\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.opts.toolbar && this.$toolbar)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.$toolbar.remove();\n\t\t\t\t\t}\n\n\t\t\t\t\t// modal\n\t\t\t\t\tif (this.$modalBox)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.$modalBox.remove();\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.$modalOverlay)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.$modalOverlay.remove();\n\t\t\t\t\t}\n\n\t\t\t\t\t// hide link's tooltip\n\t\t\t\t\t$('.redactor-link-tooltip').remove();\n\n\t\t\t\t\t// autosave\n\t\t\t\t\tclearInterval(this.autosaveTimeout);\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =detect\n\t\tdetect: function()\n\t\t{\n\t\t\treturn {\n\n\t\t\t\t// public\n\t\t\t\tisWebkit: function()\n\t\t\t\t{\n\t\t\t\t\treturn /webkit/.test(this.opts.userAgent);\n\t\t\t\t},\n\t\t\t\tisFirefox: function()\n\t\t\t\t{\n\t\t\t\t\treturn this.opts.userAgent.indexOf('firefox') > -1;\n\t\t\t\t},\n\t\t\t\tisIe: function(v)\n\t\t\t\t{\n                    if (document.documentMode || /Edge/.test(navigator.userAgent))\n                    {\n                        return 'edge';\n                    }\n\n\t\t\t\t\tvar ie;\n\t\t\t\t\tie = RegExp('msie' + (!isNaN(v)?('\\\\s'+v):''), 'i').test(navigator.userAgent);\n\n\t\t\t\t\tif (!ie)\n\t\t\t\t\t{\n\t\t\t\t\t\tie = !!navigator.userAgent.match(/Trident.*rv[ :]*11\\./);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn ie;\n\t\t\t\t},\n\t\t\t\tisMobile: function()\n\t\t\t\t{\n\t\t\t\t\treturn /(iPhone|iPod|BlackBerry|Android)/.test(navigator.userAgent);\n\t\t\t\t},\n\t\t\t\tisDesktop: function()\n\t\t\t\t{\n\t\t\t\t\treturn !/(iPhone|iPod|iPad|BlackBerry|Android)/.test(navigator.userAgent);\n\t\t\t\t},\n\t\t\t\tisIpad: function()\n\t\t\t\t{\n\t\t\t\t\treturn /iPad/.test(navigator.userAgent);\n\t\t\t\t}\n\n\t\t\t};\n\t\t},\n\n\t\t// =dropdown\n\t\tdropdown: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tactive: false,\n\t\t\t\tbutton: false,\n\t\t\t\tkey: false,\n\t\t\t\tposition: [],\n\t\t\t\tgetDropdown: function()\n\t\t\t\t{\n\t\t\t\t\treturn this.dropdown.active;\n\t\t\t\t},\n\t\t\t\tbuild: function(name, $dropdown, dropdownObject)\n\t\t\t\t{\n\t\t\t\t\tdropdownObject = this.dropdown.buildFormatting(name, dropdownObject);\n\n\t\t\t\t\t$.each(dropdownObject, $.proxy(function(btnName, btnObject)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar $item = this.dropdown.buildItem(btnName, btnObject);\n\n\t\t\t\t\t\tthis.observe.addDropdown($item, btnName, btnObject);\n\t\t\t\t\t\t$dropdown.attr('rel', name).append($item);\n\n\t\t\t\t\t}, this));\n\t\t\t\t},\n\t\t\t\tbuildFormatting: function(name, dropdownObject)\n\t\t\t\t{\n\t\t\t\t\tif (name !== 'format' || this.opts.formattingAdd === false)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn dropdownObject;\n\t\t\t\t\t}\n\n\t\t\t\t\t$.each(this.opts.formattingAdd, $.proxy(function(i,s)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar type = (this.utils.isBlockTag(s.args[0])) ? 'block' : 'inline';\n\n\t\t\t\t\t\tdropdownObject[i] = {\n\t\t\t\t\t\t\tfunc: (type === 'block') ? 'block.format' : 'inline.format',\n\t\t\t\t\t\t\targs: s.args,\n\t\t\t\t\t\t\ttitle: s.title\n\t\t\t\t\t\t};\n\n\t\t\t\t\t}, this));\n\n\t\t\t\t\treturn dropdownObject;\n\t\t\t\t},\n\t\t\t\tbuildItem: function(btnName, btnObject)\n\t\t\t\t{\n\t\t\t\t\tvar $itemContainer = $('<li />');\n\t\t\t\t\tif (typeof btnObject.classname !== 'undefined')\n\t\t\t\t\t{\n    \t\t\t\t\t$itemContainer.addClass(btnObject.classname);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (btnName.search(/^divider/i) !== -1)\n\t\t\t\t\t{\n    \t\t\t\t\t$itemContainer.addClass('redactor-dropdown-divider');\n\n    \t\t\t\t\treturn $itemContainer;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar $item = $('<a href=\"#\" class=\"redactor-dropdown-' + btnName + '\" role=\"button\" />');\n\t\t\t\t\tvar $itemSpan = $('<span />').html(btnObject.title);\n\n\t\t\t\t\t$item.append($itemSpan);\n\t\t\t\t\t$item.on('mousedown', $.proxy(function(e)\n\t\t\t\t\t{\n\t\t\t\t\t\te.preventDefault();\n\n\t\t\t\t\t\tthis.dropdown.buildClick(e, btnName, btnObject);\n\n\t\t\t\t\t}, this));\n\n\t\t\t\t\t$itemContainer.append($item);\n\n\t\t\t\t\treturn $itemContainer;\n\n\t\t\t\t},\n\t\t\t\tbuildClick: function(e, btnName, btnObject)\n\t\t\t\t{\n\t\t\t\t\tif ($(e.target).hasClass('redactor-dropdown-link-inactive'))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar command = this.dropdown.buildCommand(btnObject);\n\n\t\t\t\t\tif (typeof btnObject.args !== ' undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.button.toggle(e, btnName, command.type, command.callback, btnObject.args);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.button.toggle(e, btnName, command.type, command.callback);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tbuildCommand: function(btnObject)\n\t\t\t\t{\n\t\t\t\t\tvar command = {};\n\t\t\t\t\tcommand.type = 'func';\n\t\t\t\t\tcommand.callback = btnObject.func;\n\n\t\t\t\t\tif (btnObject.command)\n\t\t\t\t\t{\n\t\t\t\t\t\tcommand.type = 'command';\n\t\t\t\t\t\tcommand.callback = btnObject.command;\n\t\t\t\t\t}\n\t\t\t\t\telse if (btnObject.dropdown)\n\t\t\t\t\t{\n\t\t\t\t\t\tcommand.type = 'dropdown';\n\t\t\t\t\t\tcommand.callback = btnObject.dropdown;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn command;\n\t\t\t\t},\n\t\t\t\tshow: function(e, key)\n\t\t\t\t{\n\t\t\t\t\tif (this.detect.isDesktop())\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.editor().focus();\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.dropdown.hideAll(false, key);\n\n\t\t\t\t\tthis.dropdown.key = key;\n\t\t\t\t\tthis.dropdown.button = this.button.get(this.dropdown.key);\n\n\t\t\t\t\tif (this.dropdown.button.hasClass('dropact'))\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.dropdown.hide();\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\t// re append\n\t\t\t\t\tthis.dropdown.active = this.dropdown.button.data('dropdown').appendTo(document.body);\n\n\t\t\t\t\t// callback\n\t\t\t\t\tthis.core.callback('dropdownShow', { dropdown: this.dropdown.active, key: this.dropdown.key, button: this.dropdown.button });\n\n\t\t\t\t\t// set button\n\t\t\t\t\tthis.button.setActive(this.dropdown.key);\n\t\t\t\t\tthis.dropdown.button.addClass('dropact');\n\n\t\t\t\t\t// position\n\t\t\t\t\tthis.dropdown.getButtonPosition();\n\n\t\t\t\t\t// show\n\t\t\t\t\tif (this.button.toolbar().hasClass('toolbar-fixed-box') && this.detect.isDesktop())\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.dropdown.showIsFixedToolbar();\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.dropdown.showIsUnFixedToolbar();\n\t\t\t\t\t}\n\n\t\t\t\t\t// disable scroll whan dropdown scroll\n\t\t\t\t\tif (this.detect.isDesktop() && !this.detect.isFirefox())\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.dropdown.active.on('mouseover.redactor-dropdown', $.proxy(this.utils.disableBodyScroll, this));\n\t\t\t\t\t\tthis.dropdown.active.on('mousedown.redactor-dropdown', $.proxy(this.utils.enableBodyScroll, this));\n\t\t\t\t\t}\n\n\t\t\t\t\te.stopPropagation();\n\n\t\t\t\t},\n\t\t\t\tshowIsFixedToolbar: function()\n\t\t\t\t{\n\t\t\t\t\tvar top = this.dropdown.button.position().top + this.dropdown.button.innerHeight() + this.opts.toolbarFixedTopOffset;\n\n\t\t\t\t\tvar position = 'fixed';\n\t\t\t\t\tif (this.opts.toolbarFixedTarget !== document)\n\t\t\t\t\t{\n\t\t\t\t\t\ttop = (this.dropdown.button.innerHeight() + this.$toolbar.offset().top) + this.opts.toolbarFixedTopOffset;\n\t\t\t\t\t\tposition = 'absolute';\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.dropdown.active.css({\n\n\t\t\t\t\t\tposition: position,\n\t\t\t\t\t\tleft: this.dropdown.position.left + 'px',\n\t\t\t\t\t\ttop: top + 'px'\n\n\t\t\t\t\t}).show();\n\n\t\t\t\t\t// animate\n\t\t\t\t\tthis.dropdown.active.redactorAnimation('slideDown', { duration: 0.2 }, $.proxy(function()\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.dropdown.enableCallback();\n\t\t\t\t\t\tthis.dropdown.enableEvents();\n\n\t\t\t\t\t}, this));\n\t\t\t\t},\n\t\t\t\tshowIsUnFixedToolbar: function()\n\t\t\t\t{\n\t\t\t\t\tthis.dropdown.active.css({\n\n\t\t\t\t\t\tposition: 'absolute',\n\t\t\t\t\t\tleft: this.dropdown.position.left + 'px',\n\t\t\t\t\t\ttop: (this.dropdown.button.innerHeight() + this.dropdown.position.top) + 'px'\n\n\t\t\t\t\t}).show();\n\n\t\t\t\t\t// animate\n\t\t\t\t\tthis.dropdown.active.redactorAnimation(((this.opts.animation) ? 'slideDown' : 'show'), { duration: 0.2 }, $.proxy(function()\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.dropdown.enableCallback();\n\t\t\t\t\t\tthis.dropdown.enableEvents();\n\n\t\t\t\t\t}, this));\n\t\t\t\t},\n\t\t\t\tenableEvents: function()\n\t\t\t\t{\n\t\t\t\t\t$(document).on('mousedown.redactor-dropdown', $.proxy(this.dropdown.hideAll, this));\n\t\t\t\t\tthis.core.editor().on('touchstart.redactor-dropdown', $.proxy(this.dropdown.hideAll, this));\n\t\t\t\t\t$(document).on('keyup.redactor-dropdown', $.proxy(this.dropdown.closeHandler, this));\n\t\t\t\t},\n\t\t\t\tenableCallback: function()\n\t\t\t\t{\n\t\t\t\t\tthis.core.callback('dropdownShown', { dropdown: this.dropdown.active, key: this.dropdown.key, button: this.dropdown.button });\n\t\t\t\t},\n\t\t\t\tgetButtonPosition: function()\n\t\t\t\t{\n\t\t\t\t\tthis.dropdown.position = this.dropdown.button.offset();\n\n\t\t\t\t\t// fix right placement\n\t\t\t\t\tvar dropdownWidth = this.dropdown.active.width();\n\t\t\t\t\tif ((this.dropdown.position.left + dropdownWidth) > $(document).width())\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.dropdown.position.left = Math.max(0, this.dropdown.position.left - dropdownWidth + parseInt(this.dropdown.button.innerWidth()));\n\t\t\t\t\t}\n\n\t\t\t\t},\n\t\t\t\tcloseHandler: function(e)\n\t\t\t\t{\n\t\t\t\t\tif (e.which !== this.keyCode.ESC)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.dropdown.hideAll(e);\n\t\t\t\t\tthis.core.editor().focus();\n\t\t\t\t},\n\t\t\t\thideAll: function(e, key)\n\t\t\t\t{\n\t\t\t\t\tif (this.detect.isDesktop())\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.utils.enableBodyScroll();\n\t\t\t\t\t}\n\n\t\t\t\t\tif (e !== false && $(e.target).closest('.redactor-dropdown').length !== 0)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar $buttons = (typeof key === 'undefined') ? this.button.toolbar().find('a.dropact') : this.button.toolbar().find('a.dropact').not('.re-' + key);\n\t\t\t\t\tvar $elements = (typeof key === 'undefined') ? $('.redactor-dropdown-' + this.uuid) : $('.redactor-dropdown-' + this.uuid).not('.redactor-dropdown-box-' + key);\n\n\t\t\t\t\tif ($elements.length !== 0)\n\t\t\t\t\t{\n\t\t\t\t\t\t$(document).off('.redactor-dropdown');\n\t\t\t\t\t\tthis.core.editor().off('.redactor-dropdown');\n\n\t\t\t\t\t\t$.each($elements, $.proxy(function(i,s)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar $el = $(s);\n\n\t\t\t\t\t\t\tthis.core.callback('dropdownHide', $el);\n\n\t\t\t\t\t\t\t$el.hide();\n\t\t\t\t\t\t\t$el.off('mouseover mouseout').off('.redactor-dropdown');\n\n\t\t\t\t\t\t}, this));\n\n\t\t\t\t\t\t$buttons .removeClass('redactor-act dropact');\n\t\t\t\t\t}\n\n\t\t\t\t},\n\t\t\t\thide: function ()\n\t\t\t\t{\n\t\t\t\t\tif (this.dropdown.active === false)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.detect.isDesktop())\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.utils.enableBodyScroll();\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.dropdown.active.redactorAnimation(((this.opts.animation) ? 'slideUp' : 'hide'), { duration: 0.2 }, $.proxy(function()\n\t\t\t\t\t{\n\t\t\t\t\t\t$(document).off('.redactor-dropdown');\n\t\t\t\t\t\tthis.core.editor().off('.redactor-dropdown');\n\n\t\t\t\t\t\tthis.dropdown.hideOut();\n\n\n\t\t\t\t\t}, this));\n\t\t\t\t},\n\t\t\t\thideOut: function()\n\t\t\t\t{\n\t\t\t\t\tthis.core.callback('dropdownHide', this.dropdown.active);\n\n\t\t\t\t\tthis.dropdown.button.removeClass('redactor-act dropact');\n\t\t\t\t\tthis.dropdown.active.off('mouseover mouseout').off('.redactor-dropdown');\n\t\t\t\t\tthis.dropdown.button = false;\n\t\t\t\t\tthis.dropdown.key = false;\n\t\t\t\t\tthis.dropdown.active = false;\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =events\n\t\tevents: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tfocused: false,\n\t\t\t\tblured: true,\n\t\t\t\tdropImage: false,\n\t\t\t\tstopChanges: false,\n\t\t\t\tstopDetectChanges: function()\n\t\t\t\t{\n\t\t\t\t\tthis.events.stopChanges = true;\n\t\t\t\t},\n\t\t\t\tstartDetectChanges: function()\n\t\t\t\t{\n\t\t\t\t\tvar self = this;\n\t\t\t\t\tsetTimeout(function()\n\t\t\t\t\t{\n\t\t\t\t\t\tself.events.stopChanges = false;\n\t\t\t\t\t}, 1);\n\t\t\t\t},\n\t\t\t\tdragover: function(e)\n\t\t\t\t{\n\t\t\t\t\te.preventDefault();\n\t\t\t\t\te.stopPropagation();\n\n\t\t\t\t\tif (e.target.tagName === 'IMG')\n\t\t\t\t\t{\n\t\t\t\t\t\t$(e.target).addClass('redactor-image-dragover');\n\t\t\t\t\t}\n\n\t\t\t\t},\n\t\t\t\tdragleave: function(e)\n\t\t\t\t{\n\t\t\t\t\t// remove image dragover\n\t\t\t\t\tthis.core.editor().find('img').removeClass('redactor-image-dragover');\n\t\t\t\t},\n\t\t\t\tdrop: function(e)\n\t\t\t\t{\n\t\t\t\t\te = e.originalEvent || e;\n\n\t\t\t\t\t// remove image dragover\n\t\t\t\t\tthis.core.editor().find('img').removeClass('redactor-image-dragover');\n\n\t\t\t\t\tif (this.opts.type === 'inline' || this.opts.type === 'pre')\n\t\t\t\t\t{\n\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (window.FormData === undefined || !e.dataTransfer)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (e.dataTransfer.files.length === 0)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn this.events.onDrop(e);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.events.onDropUpload(e);\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.core.callback('drop', e);\n\n\t\t\t\t},\n\t\t\t\tclick: function(e)\n\t\t\t\t{\n\t\t\t\t\tvar event = this.core.getEvent();\n\t\t\t\t\tvar type = (event === 'click' || event === 'arrow') ? false : 'click';\n\n\t\t\t\t\tthis.core.addEvent(type);\n\t\t\t\t\tthis.utils.disableSelectAll();\n\t\t\t\t\tthis.core.callback('click', e);\n\t\t\t\t},\n\t\t\t\tfocus: function(e)\n\t\t\t\t{\n\t\t\t\t\tif (this.rtePaste)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.events.isCallback('focus'))\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.callback('focus', e);\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.events.focused = true;\n\t\t\t\t\tthis.events.blured = false;\n\n\t\t\t\t\t// tab\n\t\t\t\t\tif (this.selection.current() === false)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar sel = this.selection.get();\n\t\t\t\t\t\tvar range = this.selection.range(sel);\n\n\t\t\t\t\t\trange.setStart(this.core.editor()[0], 0);\n\t\t\t\t\t\trange.setEnd(this.core.editor()[0], 0);\n\t\t\t\t\t\tthis.selection.update(sel, range);\n\t\t\t\t\t}\n\n\t\t\t\t},\n\t\t\t\tblur: function(e)\n\t\t\t\t{\n\t\t\t\t\tif (this.start || this.rtePaste)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif ($(e.target).closest('#' + this.core.id() + ', .redactor-toolbar, .redactor-dropdown, #redactor-modal-box').length !== 0)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!this.events.blured && this.events.isCallback('blur'))\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.callback('blur', e);\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.events.focused = false;\n\t\t\t\t\tthis.events.blured = true;\n\t\t\t\t},\n\t\t\t\ttouchImageEditing: function()\n\t\t\t\t{\n\t\t\t\t\tvar scrollTimer = -1;\n\t\t\t\t\tthis.events.imageEditing = false;\n\t\t\t\t\t$(window).on('touchmove.redactor.' + this.uuid, $.proxy(function()\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.events.imageEditing = true;\n\t\t\t\t\t\tif (scrollTimer !== -1)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tclearTimeout(scrollTimer);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tscrollTimer = setTimeout($.proxy(function()\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.events.imageEditing = false;\n\n\t\t\t\t\t\t}, this), 500);\n\n\t\t\t\t\t}, this));\n\t\t\t\t},\n\t\t\t\tinit: function()\n\t\t\t\t{\n\t\t\t\t\tthis.core.editor().on('dragover.redactor dragenter.redactor', $.proxy(this.events.dragover, this));\n\t\t\t\t\tthis.core.editor().on('dragleave.redactor', $.proxy(this.events.dragleave, this));\n\t\t\t\t\tthis.core.editor().on('drop.redactor', $.proxy(this.events.drop, this));\n\t\t\t\t\tthis.core.editor().on('click.redactor', $.proxy(this.events.click, this));\n\t\t\t\t\tthis.core.editor().on('paste.redactor', $.proxy(this.paste.init, this));\n\t\t\t\t\tthis.core.editor().on('keydown.redactor', $.proxy(this.keydown.init, this));\n\t\t\t\t\tthis.core.editor().on('keyup.redactor', $.proxy(this.keyup.init, this));\n\t\t\t\t\tthis.core.editor().on('focus.redactor', $.proxy(this.events.focus, this));\n\n\t\t\t\t\t$(document).on('mousedown.redactor-blur.' + this.uuid, $.proxy(this.events.blur, this));\n\n\t\t\t\t\tthis.events.touchImageEditing();\n\n\t\t\t\t\tthis.events.createObserver();\n\t\t\t\t\tthis.events.setupObserver();\n\n\t\t\t\t},\n\t\t\t\tcreateObserver: function()\n\t\t\t\t{\n\t\t\t\t\tvar self = this;\n\t\t\t\t\tthis.events.observer = new MutationObserver(function(mutations)\n\t\t\t\t\t{\n\t\t\t\t\t\tmutations.forEach($.proxy(self.events.iterateObserver, self));\n\t\t\t\t\t});\n\n\t\t\t\t},\n\t\t\t\titerateObserver: function(mutation)\n\t\t\t\t{\n\n\t\t\t\t\tvar stop = false;\n\n\t\t\t\t\t// target\n\t\t\t\t\tif (((this.opts.type === 'textarea' || this.opts.type === 'div')\n\t\t\t\t\t    && (!this.detect.isFirefox() && mutation.target === this.core.editor()[0]))\n\t\t\t\t\t    || (mutation.attributeName === 'class' && mutation.target === this.core.editor()[0])\n                    )\n\t\t\t\t\t{\n\t\t\t\t\t\tstop = true;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!stop)\n\t\t\t\t\t{\n    \t\t\t\t\tthis.observe.load();\n\t\t\t\t\t\tthis.events.changeHandler();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tsetupObserver: function()\n\t\t\t\t{\n\t\t\t\t\tthis.events.observer.observe(this.core.editor()[0], {\n\t\t\t\t\t\t attributes: true,\n\t\t\t\t\t\t subtree: true,\n\t\t\t\t\t\t childList: true,\n\t\t\t\t\t\t characterData: true,\n\t\t\t\t\t\t characterDataOldValue: true\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t\tchangeHandler: function()\n\t\t\t\t{\n\t\t\t\t\tif (this.events.stopChanges)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.code.sync();\n\n\t\t\t\t\t// autosave\n\t\t\t\t\tif (this.autosave.is())\n\t\t\t\t\t{\n\t\t\t\t\t\tclearTimeout(this.autosaveTimeout);\n\t\t\t\t\t\tthis.autosaveTimeout = setTimeout($.proxy(this.autosave.send, this), 300);\n\t\t\t\t\t}\n\n\t\t\t\t},\n\t\t\t\tonDropUpload: function(e)\n\t\t\t\t{\n\t\t\t\t\te.preventDefault();\n\t\t\t\t\te.stopPropagation();\n\n\t\t\t\t\tif ((!this.opts.dragImageUpload && !this.opts.dragFileUpload) || (this.opts.imageUpload === null && this.opts.fileUpload === null))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (e.target.tagName === 'IMG')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.events.dropImage = e.target;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar files = e.dataTransfer.files;\n\t\t\t\t\tthis.upload.directUpload(files[0], e);\n\t\t\t\t},\n\t\t\t\tonDrop: function(e)\n\t\t\t\t{\n\t\t\t\t\tthis.core.callback('drop', e);\n\t\t\t\t},\n\t\t\t\tisCallback: function(name)\n\t\t\t\t{\n\t\t\t\t\treturn (typeof this.opts.callbacks[name] !== 'undefined' && $.isFunction(this.opts.callbacks[name]));\n\t\t\t\t},\n\n\t\t\t\t// #backward\n\t\t\t\tstopDetect: function()\n\t\t\t\t{\n\t\t\t\t\tthis.events.stopDetectChanges();\n\t\t\t\t},\n\t\t\t\tstartDetect: function()\n\t\t\t\t{\n\t\t\t\t\tthis.events.startDetectChanges();\n\t\t\t\t}\n\n\t\t\t};\n\t\t},\n\n\t\t// =file\n\t\tfile: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tis: function()\n\t\t\t\t{\n\t\t\t\t\treturn !(!this.opts.fileUpload || !this.opts.fileUpload && !this.opts.s3);\n\t\t\t\t},\n\t\t\t\tshow: function()\n\t\t\t\t{\n\t\t\t\t\t// build modal\n\t\t\t\t\tthis.modal.load('file', this.lang.get('file'), 700);\n\n\t\t\t\t\t// build upload\n\t\t\t\t\tthis.upload.init('#redactor-modal-file-upload', this.opts.fileUpload, this.file.insert);\n\n\t\t\t\t\t// set selected text\n\t\t\t\t\t$('#redactor-filename').val(this.selection.get().toString());\n\n\t\t\t\t\t// show\n\t\t\t\t\tthis.modal.show();\n\t\t\t\t},\n\t\t\t\tinsert: function(json, direct, e)\n\t\t\t\t{\n\t\t\t\t\t// error callback\n\t\t\t\t\tif (typeof json.error !== 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.modal.close();\n\t\t\t\t\t\tthis.core.callback('fileUploadError', json);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.file.release(e, direct);\n\n\t\t\t\t\t// prepare\n\t\t\t\t\tthis.buffer.set();\n\t\t\t\t\tthis.air.collapsed();\n\n\t\t\t\t\t// get\n\t\t\t\t\tvar text = this.file.text(json);\n\t\t\t\t\tvar $link = $('<a />').attr('href', json.url).text(text);\n\t\t\t\t\tvar id = (typeof json.id === 'undefined') ? '' : json.id;\n\t\t\t\t\tvar type = (typeof json.s3 === 'undefined') ? 'file' : 's3';\n\n\t\t\t\t\t// set id\n\t\t\t\t\t$link.attr('data-' + type, id);\n\n\t\t\t\t\t// insert\n\t\t\t\t\t$link = $(this.insert.node($link));\n\n\t\t\t\t\t// focus\n\t\t\t\t\tthis.caret.after($link);\n\n\t\t\t\t\t// callback\n\t\t\t\t\tthis.storage.add({ type: type, node: $link[0], url: $link[0].href, id: id });\n\n\t\t\t\t\tif (direct !== null)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.callback('fileUpload', $link, json);\n\t\t\t\t\t}\n\n\t\t\t\t},\n\t\t\t\trelease: function(e, direct)\n\t\t\t\t{\n\t\t\t\t\tif (direct)\n\t\t\t\t\t{\n\t\t\t\t\t\t// drag and drop upload\n\t\t\t\t\t\tthis.marker.remove();\n\t\t\t\t\t\tthis.insert.nodeToPoint(e, this.marker.get());\n\t\t\t\t\t\tthis.selection.restore();\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\t// upload from modal\n\t\t\t\t\t\tthis.modal.close();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\ttext: function(json)\n\t\t\t\t{\n\t\t\t\t\tvar text = $('#redactor-filename').val();\n\n\t\t\t\t\treturn (typeof text === 'undefined' || text === '') ? json.name : text;\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =focus\n\t\tfocus: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tstart: function()\n\t\t\t\t{\n\t\t\t\t\tthis.core.editor().focus();\n\n\t\t\t\t\tif (this.opts.type === 'inline')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar $first = this.focus.first();\n\t\t\t\t\tif ($first !== false)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.caret.start($first);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tend: function()\n\t\t\t\t{\n\t\t\t\t\tthis.core.editor().focus();\n\n\t\t\t\t\tvar last = (this.opts.inline) ? this.core.editor() : this.focus.last();\n\t\t\t\t\tif (last.length === 0)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\t// get inline last node\n\t\t\t\t\tvar lastNode = this.focus.lastChild(last);\n\t\t\t\t\tif (!this.detect.isWebkit() && lastNode !== false)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.caret.end(lastNode);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tvar sel = this.selection.get();\n\t\t\t\t\t\tvar range = this.selection.range(sel);\n\n\t\t\t\t\t\tif (range !== null)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\trange.selectNodeContents(last[0]);\n\t\t\t\t\t\t\trange.collapse(false);\n\n\t\t\t\t\t\t\tthis.selection.update(sel, range);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.caret.end(last);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t},\n\t\t\t\tfirst: function()\n\t\t\t\t{\n\t\t\t\t\tvar $first = this.core.editor().children().first();\n\t\t\t\t\tif ($first.length === 0 && ($first[0].length === 0 || $first[0].tagName === 'BR' || $first[0].tagName === 'HR' || $first[0].nodeType === 3))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tif ($first[0].tagName === 'UL' || $first[0].tagName === 'OL')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn $first.find('li').first();\n\t\t\t\t\t}\n\n\t\t\t\t\treturn $first;\n\n\t\t\t\t},\n\t\t\t\tlast: function()\n\t\t\t\t{\n\t\t\t\t\treturn this.core.editor().children().last();\n\t\t\t\t},\n\t\t\t\tlastChild: function(last)\n\t\t\t\t{\n\t\t\t\t\tvar lastNode = last[0].lastChild;\n\n\t\t\t\t\treturn (lastNode !== null && this.utils.isInlineTag(lastNode.tagName)) ? lastNode : false;\n\t\t\t\t},\n\t\t\t\tis: function()\n\t\t\t\t{\n\t\t\t\t\treturn (this.core.editor()[0] === document.activeElement);\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =image\n\t\timage: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tis: function()\n\t\t\t\t{\n\t\t\t\t\treturn !(!this.opts.imageUpload || !this.opts.imageUpload && !this.opts.s3);\n\t\t\t\t},\n\t\t\t\tshow: function()\n\t\t\t\t{\n\t\t\t\t\t// build modal\n\t\t\t\t\tthis.modal.load('image', this.lang.get('image'), 700);\n\n\t\t\t\t\t// build upload\n\t\t\t\t\tthis.upload.init('#redactor-modal-image-droparea', this.opts.imageUpload, this.image.insert);\n\t\t\t\t\tthis.modal.show();\n\n\t\t\t\t},\n\t\t\t\tinsert: function(json, direct, e)\n\t\t\t\t{\n\t\t\t\t\tvar $img;\n\n\t\t\t\t\t// error callback\n\t\t\t\t\tif (typeof json.error !== 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.modal.close();\n\t\t\t\t\t\tthis.events.dropImage = false;\n\t\t\t\t\t\tthis.core.callback('imageUploadError', json, e);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\t// change image\n\t\t\t\t\tif (this.events.dropImage !== false)\n\t\t\t\t\t{\n\t\t\t\t\t\t$img = $(this.events.dropImage);\n\n\t\t\t\t\t\tthis.core.callback('imageDelete', $img[0].src, $img);\n\n\t\t\t\t\t\t$img.attr('src', json.url);\n\n\t\t\t\t\t\tthis.events.dropImage = false;\n\t\t\t\t\t\tthis.core.callback('imageUpload', $img, json);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.placeholder.hide();\n\t\t\t\t\tvar $figure = $('<' + this.opts.imageTag + '>');\n\n\t\t\t\t\t$img = $('<img>');\n\t\t\t\t\t$img.attr('src', json.url);\n\n\t\t\t\t\t// set id\n\t\t\t\t\tvar id = (typeof json.id === 'undefined') ? '' : json.id;\n\t\t\t\t\tvar type = (typeof json.s3 === 'undefined') ? 'image' : 's3';\n\t\t\t\t\t$img.attr('data-' + type, id);\n\n\t\t\t\t\t$figure.append($img);\n\n\t\t\t\t\tvar pre = this.utils.isTag(this.selection.current(), 'pre');\n\n\t\t\t\t\tif (direct)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.air.collapsed();\n\t\t\t\t\t\tthis.marker.remove();\n\n\t\t\t\t\t\tvar node = this.insert.nodeToPoint(e, this.marker.get());\n\t\t\t\t\t\tvar $next = $(node).next();\n\n\t\t\t\t\t\tthis.selection.restore();\n\n\t\t\t\t\t\t// buffer\n\t\t\t\t\t\tthis.buffer.set();\n\n\t\t\t\t\t\t// insert\n\t\t\t\t\t\tif (typeof $next !== 'undefined' && $next.length !== 0 && $next[0].tagName === 'IMG')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t// delete callback\n\t\t\t\t\t\t\tthis.core.callback('imageDelete', $next[0].src, $next);\n\n\t\t\t\t\t\t\t// replace\n\t\t\t\t\t\t\t$next.closest('figure, p', this.core.editor()[0]).replaceWith($figure);\n\t\t\t\t\t\t\tthis.caret.after($figure);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tif (pre)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t$(pre).after($figure);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tthis.insert.node($figure);\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tthis.caret.after($figure);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.modal.close();\n\n\t\t\t\t\t\t// buffer\n\t\t\t\t\t\tthis.buffer.set();\n\n\t\t\t\t\t\t// insert\n\t\t\t\t\t\tthis.air.collapsed();\n\n\t\t\t\t\t\tif (pre)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$(pre).after($figure);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.insert.node($figure);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tthis.caret.after($figure);\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.events.dropImage = false;\n\n\t\t\t\t\tthis.storage.add({ type: type, node: $img[0], url: $img[0].src, id: id });\n\n\t\t\t\t\tif (direct !== null)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.callback('imageUpload', $img, json);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tsetEditable: function($image)\n\t\t\t\t{\n\t\t\t\t\t$image.on('dragstart', function(e)\n\t\t\t\t\t{\n\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t});\n\n                    if (this.opts.imageResizable)\n                    {\n    \t\t\t\t\tvar handler = $.proxy(function(e)\n    \t\t\t\t\t{\n    \t\t\t\t\t\tthis.observe.image = $image;\n    \t\t\t\t\t\tthis.image.resizer = this.image.loadEditableControls($image);\n\n    \t\t\t\t\t\t$(document).on('mousedown.redactor-image-resize-hide.' + this.uuid, $.proxy(this.image.hideResize, this));\n                            this.image.resizer.on('mousedown.redactor touchstart.redactor', $.proxy(function(e)\n    \t\t\t\t\t\t{\n    \t\t\t\t\t\t\tthis.image.setResizable(e, $image);\n    \t\t\t\t\t\t}, this));\n\n    \t\t\t\t\t}, this);\n\n    \t\t\t\t\t$image.off('mousedown.redactor').on('mousedown.redactor', $.proxy(this.image.hideResize, this));\n    \t\t\t\t\t$image.off('click.redactor touchstart.redactor').on('click.redactor touchstart.redactor', handler);\n                    }\n                    else\n                    {\n    \t\t\t\t\t$image.off('click.redactor touchstart.redactor').on('click.redactor touchstart.redactor', $.proxy(function(e)\n    \t\t\t\t\t{\n    \t\t\t\t\t\tsetTimeout($.proxy(function()\n    \t\t\t\t\t\t{\n    \t\t\t\t\t\t\tthis.image.showEdit($image);\n\n    \t\t\t\t\t\t}, this), 200);\n\n    \t\t\t\t\t}, this));\n                    }\n\n\t\t\t\t},\n\t\t\t\tsetResizable: function(e, $image)\n\t\t\t\t{\n\t\t\t\t\te.preventDefault();\n\n\t\t\t\t    this.image.resizeHandle = {\n\t\t\t\t        x : e.pageX,\n\t\t\t\t        y : e.pageY,\n\t\t\t\t        el : $image,\n\t\t\t\t        ratio: $image.width() / $image.height(),\n\t\t\t\t        h: $image.height()\n\t\t\t\t    };\n\n\t\t\t\t    e = e.originalEvent || e;\n\n\t\t\t\t    if (e.targetTouches)\n\t\t\t\t    {\n\t\t\t\t         this.image.resizeHandle.x = e.targetTouches[0].pageX;\n\t\t\t\t         this.image.resizeHandle.y = e.targetTouches[0].pageY;\n\t\t\t\t    }\n\n\t\t\t\t\tthis.image.startResize();\n\n\n\t\t\t\t},\n\t\t\t\tstartResize: function()\n\t\t\t\t{\n\t\t\t\t\t$(document).on('mousemove.redactor-image-resize touchmove.redactor-image-resize', $.proxy(this.image.moveResize, this));\n\t\t\t\t\t$(document).on('mouseup.redactor-image-resize touchend.redactor-image-resize', $.proxy(this.image.stopResize, this));\n\t\t\t\t},\n\t\t\t\tmoveResize: function(e)\n\t\t\t\t{\n\t\t\t\t\te.preventDefault();\n\n\t\t\t\t\te = e.originalEvent || e;\n\n\t\t\t\t\tvar height = this.image.resizeHandle.h;\n\n\t\t            if (e.targetTouches) height += (e.targetTouches[0].pageY -  this.image.resizeHandle.y);\n\t\t            else height += (e.pageY -  this.image.resizeHandle.y);\n\n\t\t\t\t\tvar width = Math.round(height * this.image.resizeHandle.ratio);\n\n\t\t\t\t\tif (height < 50 || width < 100) return;\n\n\t\t\t\t\tvar height = Math.round(this.image.resizeHandle.el.width() / this.image.resizeHandle.ratio);\n\n\t\t\t\t\tthis.image.resizeHandle.el.attr({width: width, height: height});\n\t\t            this.image.resizeHandle.el.width(width);\n\t\t            this.image.resizeHandle.el.height(height);\n\n\t\t            this.code.sync();\n\t\t\t\t},\n\t\t\t\tstopResize: function()\n\t\t\t\t{\n\t\t\t\t\tthis.handle = false;\n\t\t\t\t\t$(document).off('.redactor-image-resize');\n\n\t\t\t\t\tthis.image.hideResize();\n\t\t\t\t},\n                hideResize: function(e)\n\t\t\t\t{\n\t\t\t\t\tif (e && $(e.target).closest('#redactor-image-box', this.$editor[0]).length !== 0) return;\n\t\t\t\t\tif (e && e.target.tagName == 'IMG')\n\t\t\t\t\t{\n\t\t\t\t\t\tvar $image = $(e.target);\n\t\t\t\t\t}\n\n\t\t\t\t\tvar imageBox = this.$editor.find('#redactor-image-box');\n\t\t\t\t\tif (imageBox.length === 0) return;\n\n\t\t\t\t\t$('#redactor-image-editter').remove();\n\t\t\t\t\t$('#redactor-image-resizer').remove();\n\n\t\t\t\t\timageBox.find('img').css({\n\t\t\t\t\t\tmarginTop: imageBox[0].style.marginTop,\n\t\t\t\t\t\tmarginBottom: imageBox[0].style.marginBottom,\n\t\t\t\t\t\tmarginLeft: imageBox[0].style.marginLeft,\n\t\t\t\t\t\tmarginRight: imageBox[0].style.marginRight\n\t\t\t\t\t});\n\n\t\t\t\t\timageBox.css('margin', '');\n\t\t\t\t\timageBox.find('img').css('opacity', '');\n\t\t\t\t\timageBox.replaceWith(function()\n\t\t\t\t\t{\n\t\t\t\t\t\treturn $(this).contents();\n\t\t\t\t\t});\n\n\t\t\t\t\t$(document).off('mousedown.redactor-image-resize-hide.' + this.uuid);\n\n\n\t\t\t\t\tif (typeof this.image.resizeHandle !== 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.image.resizeHandle.el.attr('rel', this.image.resizeHandle.el.attr('style'));\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tloadResizableControls: function($image, imageBox)\n\t\t\t\t{\n\t\t\t\t\tif (this.opts.imageResizable && !this.detect.isMobile())\n\t\t\t\t\t{\n\t\t\t\t\t\tvar imageResizer = $('<span id=\"redactor-image-resizer\" data-redactor=\"verified\"></span>');\n\n\t\t\t\t\t\tif (!this.detect.isDesktop())\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\timageResizer.css({ width: '15px', height: '15px' });\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\timageResizer.attr('contenteditable', false);\n\t\t\t\t\t\timageBox.append(imageResizer);\n\t\t\t\t\t\timageBox.append($image);\n\n\t\t\t\t\t\treturn imageResizer;\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\timageBox.append($image);\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tloadEditableControls: function($image)\n\t\t\t\t{\n\t\t\t\t\tvar imageBox = $('<span id=\"redactor-image-box\" data-redactor=\"verified\">');\n\t\t\t\t\timageBox.css('float', $image.css('float')).attr('contenteditable', false);\n\n\t\t\t\t\tif ($image[0].style.margin != 'auto')\n\t\t\t\t\t{\n\t\t\t\t\t\timageBox.css({\n\t\t\t\t\t\t\tmarginTop: $image[0].style.marginTop,\n\t\t\t\t\t\t\tmarginBottom: $image[0].style.marginBottom,\n\t\t\t\t\t\t\tmarginLeft: $image[0].style.marginLeft,\n\t\t\t\t\t\t\tmarginRight: $image[0].style.marginRight\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\t$image.css('margin', '');\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\timageBox.css({ 'display': 'block', 'margin': 'auto' });\n\t\t\t\t\t}\n\n\t\t\t\t\t$image.css('opacity', '.5').after(imageBox);\n\n\n\t\t\t\t\tif (this.opts.imageEditable)\n\t\t\t\t\t{\n\t\t\t\t\t\t// editter\n\t\t\t\t\t\tthis.image.editter = $('<span id=\"redactor-image-editter\" data-redactor=\"verified\">' + this.lang.get('edit') + '</span>');\n\t\t\t\t\t\tthis.image.editter.attr('contenteditable', false);\n\t\t\t\t\t\tthis.image.editter.on('click', $.proxy(function()\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.image.showEdit($image);\n\t\t\t\t\t\t}, this));\n\n\t\t\t\t\t\timageBox.append(this.image.editter);\n\n\t\t\t\t\t\t// position correction\n\t\t\t\t\t\tvar editerWidth = this.image.editter.innerWidth();\n\t\t\t\t\t\tthis.image.editter.css('margin-left', '-' + editerWidth/2 + 'px');\n\t\t\t\t\t}\n\n\t\t\t\t\treturn this.image.loadResizableControls($image, imageBox);\n\n\t\t\t\t},\n\t\t\t\tshowEdit: function($image)\n\t\t\t\t{\n\t\t\t\t\tif (this.events.imageEditing)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.observe.image = $image;\n\n\t\t\t\t\tvar $link = $image.closest('a', this.$editor[0]);\n\n\t\t\t\t\tthis.modal.load('image-edit', this.lang.get('edit'), 705);\n\n\t\t\t\t\tthis.image.buttonDelete = this.modal.getDeleteButton().text(this.lang.get('delete'));\n\t\t\t\t\tthis.image.buttonSave = this.modal.getActionButton().text(this.lang.get('save'));\n\n\t\t\t\t\tthis.image.buttonDelete.on('click', $.proxy(this.image.remove, this));\n\t\t\t\t\tthis.image.buttonSave.on('click', $.proxy(this.image.update, this));\n\n\t\t\t\t\tif (this.opts.imageCaption === false)\n\t\t\t\t\t{\n\t\t\t\t\t\t$('#redactor-image-caption').val('').hide().prev().hide();\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tvar $parent = $image.closest(this.opts.imageTag, this.$editor[0]);\n\t\t\t\t\t\tvar $ficaption = $parent.find('figcaption');\n\t\t\t\t\t\tif ($ficaption !== 0)\n\t\t\t\t\t\t{\n\n\t\t\t\t\t\t\t$('#redactor-image-caption').val($ficaption.text()).show();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!this.opts.imagePosition)\n\t\t\t\t\t{\n    \t\t\t\t\t$('.redactor-image-position-option').hide();\n    \t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tvar floatValue = ($image.css('display') == 'block' && $image.css('float') == 'none') ? 'center' : $image.css('float');\n\t\t\t\t\t\t$('#redactor-image-align').val(floatValue);\n\t\t\t\t\t}\n\n\t\t\t\t\t$('#redactor-image-preview').html($('<img src=\"' + $image.attr('src') + '\" style=\"max-width: 100%;\">'));\n\t\t\t\t\t$('#redactor-image-title').val($image.attr('alt'));\n\n\t\t\t\t\tvar $redactorImageLink = $('#redactor-image-link');\n\t\t\t\t\t$redactorImageLink.attr('href', $image.attr('src'));\n\t\t\t\t\tif ($link.length !== 0)\n\t\t\t\t\t{\n\t\t\t\t\t\t$redactorImageLink.val($link.attr('href'));\n\t\t\t\t\t\tif ($link.attr('target') === '_blank')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$('#redactor-image-link-blank').prop('checked', true);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\t// hide link's tooltip\n\t\t\t\t\t$('.redactor-link-tooltip').remove();\n\n\t\t\t\t\tthis.modal.show();\n\n\t\t\t\t\t// focus\n\t\t\t\t\tif (this.detect.isDesktop())\n\t\t\t\t\t{\n\t\t\t\t\t\t$('#redactor-image-title').focus();\n\t\t\t\t\t}\n\n\t\t\t\t},\n\t\t\t\tupdate: function()\n\t\t\t\t{\n\t\t\t\t\tvar $image = this.observe.image;\n\t\t\t\t\tvar $link = $image.closest('a', this.core.editor()[0]);\n\n\t\t\t\t\tvar title = $('#redactor-image-title').val().replace(/(<([^>]+)>)/ig,\"\");\n\t\t\t\t\t$image.attr('alt', title).attr('title', title);\n\n                    this.image.setFloating($image);\n\n\t\t\t\t\t// as link\n\t\t\t\t\tvar link = $.trim($('#redactor-image-link').val()).replace(/(<([^>]+)>)/ig,\"\");\n\t\t\t\t\tif (link !== '')\n\t\t\t\t\t{\n\t\t\t\t\t\t// test url (add protocol)\n\t\t\t\t\t\tvar pattern = '((xn--)?[a-z0-9]+(-[a-z0-9]+)*\\\\.)+[a-z]{2,}';\n\t\t\t\t\t\tvar re = new RegExp('^(http|ftp|https)://' + pattern, 'i');\n\t\t\t\t\t\tvar re2 = new RegExp('^' + pattern, 'i');\n\n\t\t\t\t\t\tif (link.search(re) === -1 && link.search(re2) === 0 && this.opts.linkProtocol)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tlink = this.opts.linkProtocol + '://' + link;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tvar target = ($('#redactor-image-link-blank').prop('checked')) ? true : false;\n\n\t\t\t\t\t\tif ($link.length === 0)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar a = $('<a href=\"' + link + '\" id=\"redactor-img-tmp\">' + this.utils.getOuterHtml($image) + '</a>');\n\t\t\t\t\t\t\tif (target)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\ta.attr('target', '_blank');\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t$image = $image.replaceWith(a);\n\t\t\t\t\t\t\t$link = this.core.editor().find('#redactor-img-tmp');\n\t\t\t\t\t\t\t$link.removeAttr('id');\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$link.attr('href', link);\n\t\t\t\t\t\t\tif (target)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t$link.attr('target', '_blank');\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t$link.removeAttr('target');\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse if ($link.length !== 0)\n\t\t\t\t\t{\n\t\t\t\t\t\t$link.replaceWith(this.utils.getOuterHtml($image));\n\t\t\t\t\t}\n\n                    this.image.addCaption($image, $link);\n\t\t\t\t\tthis.modal.close();\n\n\t\t\t\t\t// buffer\n\t\t\t\t\tthis.buffer.set();\n\n\t\t\t\t},\n\t\t\t\tsetFloating: function($image)\n\t\t\t\t{\n\t\t\t\t\tvar floating = $('#redactor-image-align').val();\n\n\t\t\t\t\tvar imageFloat = '';\n\t\t\t\t\tvar imageDisplay = '';\n\t\t\t\t\tvar imageMargin = '';\n\n\t\t\t\t\tswitch (floating)\n\t\t\t\t\t{\n\t\t\t\t\t\tcase 'left':\n\t\t\t\t\t\t\timageFloat = 'left';\n\t\t\t\t\t\t\timageMargin = '0 ' + this.opts.imageFloatMargin + ' ' + this.opts.imageFloatMargin + ' 0';\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t\tcase 'right':\n\t\t\t\t\t\t\timageFloat = 'right';\n\t\t\t\t\t\t\timageMargin = '0 0 ' + this.opts.imageFloatMargin + ' ' + this.opts.imageFloatMargin;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t\tcase 'center':\n\t\t\t\t\t\t\timageDisplay = 'block';\n\t\t\t\t\t\t\timageMargin = 'auto';\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\n\t\t\t\t\t$image.css({ 'float': imageFloat, display: imageDisplay, margin: imageMargin });\n\t\t\t\t\t$image.attr('rel', $image.attr('style'));\n\t\t\t\t},\n\t\t\t\taddCaption: function($image, $link)\n\t\t\t\t{\n                    var caption = $('#redactor-image-caption').val();\n\n                    var $target = ($link.length !== 0) ? $link : $image;\n\t\t\t\t\tvar $figcaption = $target.next();\n\n\t\t\t\t\tif ($figcaption.length === 0 || $figcaption[0].tagName !== 'FIGCAPTION')\n\t\t\t\t\t{\n\t\t\t\t\t\t$figcaption = false;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (caption !== '')\n\t\t\t\t\t{\n\t\t\t\t\t\tif ($figcaption === false)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$figcaption = $('<figcaption />').text(caption);\n\t\t\t\t\t\t\t$target.after($figcaption);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$figcaption.text(caption);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse if ($figcaption !== false)\n\t\t\t\t\t{\n\t\t\t\t\t\t$figcaption.remove();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tremove: function(e, $image, index)\n\t\t\t\t{\n\t\t\t\t\t$image = (typeof $image === 'undefined') ? $(this.observe.image) : $image;\n\n\t\t\t\t\t// delete from modal\n\t\t\t\t\tif (typeof e !== 'boolean')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.buffer.set();\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.events.stopDetectChanges();\n\n\t\t\t\t\tvar $link = $image.closest('a', this.core.editor()[0]);\n\t\t\t\t\tvar $figure = $image.closest(this.opts.imageTag, this.core.editor()[0]);\n\t\t\t\t\tvar $parent = $image.parent();\n\n\t\t\t\t\tif ($('#redactor-image-box').length !== 0)\n\t\t\t\t\t{\n\t\t\t\t\t\t$parent = $('#redactor-image-box').parent();\n\t\t\t\t\t}\n\n\t\t\t\t\tvar $next;\n\t\t\t\t\tif ($figure.length !== 0)\n\t\t\t\t\t{\n\t\t\t\t\t\t$next = $figure.next();\n\t\t\t\t\t\t$figure.remove();\n\t\t\t\t\t}\n\t\t\t\t\telse if ($link.length !== 0)\n\t\t\t\t\t{\n\t\t\t\t\t\t$parent = $link.parent();\n\t\t\t\t\t\t$link.remove();\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\t$image.remove();\n\t\t\t\t\t}\n\n\t\t\t\t\t$('#redactor-image-box').remove();\n\n\t\t\t\t\tif (e !== false)\n\t\t\t\t\t{\n\t\t\t\t\t\tif ($figure.length !== 0 && $next.length !== 0)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.caret.start($next);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if ($parent.length !== 0)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.caret.start($parent);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (typeof e !== 'boolean')\n\t\t\t\t\t{\n\n\t\t\t\t\t\tthis.modal.close();\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.utils.restoreScroll();\n\t\t\t\t\tthis.observe.image = false;\n\t\t\t\t\tthis.events.startDetectChanges();\n\t\t\t\t\tthis.placeholder.enable();\n\t\t\t\t\tthis.code.sync();\n\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =indent\n\t\tindent: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tincrease: function()\n\t\t\t\t{\n\t\t\t\t\tif (!this.list.get())\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar $current = $(this.selection.current()).closest('li');\n\t\t\t\t\tvar $list = $current.closest('ul, ol', this.core.editor()[0]);\n\n\t\t\t\t\tvar $li = $current.closest('li');\n\t\t\t\t\tvar $prev = $li.prev();\n\t\t\t\t\tif ($prev.length === 0 || $prev[0].tagName !== 'LI')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.buffer.set();\n\n\n\t\t\t\t\tif (this.utils.isCollapsed())\n\t\t\t\t\t{\n\t\t\t\t\t\tvar listTag = $list[0].tagName;\n\t\t\t\t\t\tvar $newList = $('<' + listTag + ' />');\n\n\t\t\t\t\t\tthis.selection.save();\n\n\t\t\t\t\t\t$newList.append($current);\n\t\t\t\t\t\t$prev.append($newList);\n\n\t\t\t\t\t\tthis.selection.restore();\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tdocument.execCommand('indent');\n\n\t\t\t\t\t\t// normalize\n\t\t\t\t\t\tthis.selection.save();\n\t\t\t\t\t\tthis.indent.removeEmpty();\n\t\t\t\t\t\tthis.indent.normalize();\n\t\t\t\t\t\tthis.selection.restore();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tdecrease: function()\n\t\t\t\t{\n\t\t\t\t\tif (!this.list.get())\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar $current = $(this.selection.current()).closest('li');\n\t\t\t\t\tvar $list = $current.closest('ul, ol', this.core.editor()[0]);\n\n\t\t\t\t\tthis.buffer.set();\n\n\t\t\t\t\tdocument.execCommand('outdent');\n\n\n\t\t\t\t\tvar $item = $(this.selection.current()).closest('li', this.core.editor()[0]);\n\n\t\t\t\t\tif (this.utils.isCollapsed())\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.indent.repositionItem($item);\n\t\t\t\t\t}\n\n\n\t\t\t\t\tif ($item.length === 0)\n\t\t\t\t\t{\n\t\t\t\t\t\tdocument.execCommand('formatblock', false, 'p');\n\t\t\t\t\t\t$item = $(this.selection.current());\n\t\t\t\t\t\tvar $next = $item.next();\n\t\t\t\t\t\tif ($next.length !== 0 && $next[0].tagName === 'BR')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$next.remove();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\t// normalize\n\t\t\t\t\tthis.selection.save();\n\t\t\t\t\tthis.indent.removeEmpty();\n\t\t\t\t\tthis.indent.normalize();\n\t\t\t\t\tthis.selection.restore();\n\n\t\t\t\t},\n\t\t\t\trepositionItem: function($item)\n\t\t\t\t{\n\t\t\t\t\tvar $prev = $item.prev();\n\t\t\t\t\tif ($prev.length !== 0 && $prev[0].tagName !== 'LI')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.selection.save();\n\t\t\t\t\t\tvar $li = $item.parents('li', this.core.editor()[0]);\n\t\t\t\t\t\t$li.after($item);\n\t\t\t\t\t\tthis.selection.restore();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tnormalize: function()\n\t\t\t\t{\n\t\t\t\t\tthis.core.editor().find('li').each($.proxy(function(i,s)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar $el = $(s);\n\n\t\t\t\t\t\t// remove style\n\t\t\t\t\t\t$el.find(this.opts.inlineTags.join(',')).each(function()\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$(this).removeAttr('style');\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\tvar $parent = $el.parent();\n\t\t\t\t\t\tif ($parent.length !== 0 && $parent[0].tagName === 'LI')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$parent.after($el);\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tvar $next = $el.next();\n\t\t\t\t\t\tif ($next.length !== 0 && ($next[0].tagName === 'UL' || $next[0].tagName === 'OL'))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$el.append($next);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}, this));\n\n\t\t\t\t},\n\t\t\t\tremoveEmpty: function($list)\n\t\t\t\t{\n\t\t\t\t\tvar $lists = this.core.editor().find('ul, ol');\n\t\t\t\t\tvar $items = this.core.editor().find('li');\n\n\t\t\t\t\t$items.each($.proxy(function(i, s)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.indent.removeItemEmpty(s);\n\n\t\t\t\t\t}, this));\n\n\t\t\t\t\t$lists.each($.proxy(function(i, s)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.indent.removeItemEmpty(s);\n\n\t\t\t\t\t}, this));\n\n\t\t\t\t\t$items.each($.proxy(function(i, s)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.indent.removeItemEmpty(s);\n\n\t\t\t\t\t}, this));\n\t\t\t\t},\n\t\t\t\tremoveItemEmpty: function(s)\n\t\t\t\t{\n\t\t\t\t\tvar html = s.innerHTML.replace(/[\\t\\s\\n]/g, '');\n\t\t\t\t\thtml = html.replace(/<span><\\/span>/g, '');\n\n\t\t\t\t\tif (html === '')\n\t\t\t\t\t{\n\t\t\t\t\t\t$(s).remove();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =inline\n\t\tinline: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tformat: function(tag, attr, value, type)\n\t\t\t\t{\n\t\t\t\t\ttag = tag.toLowerCase();\n\n\t\t\t\t\t// Stop formatting pre\n\t\t\t\t\tif (this.utils.isCurrentOrParent(['PRE']))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar tags = ['b', 'bold', 'i', 'italic', 'underline', 'strikethrough', 'deleted', 'superscript', 'subscript'];\n\t\t\t\t\tvar replaced = ['strong', 'strong', 'em', 'em', 'u', 'del', 'del', 'sup', 'sub'];\n\n\t\t\t\t\tfor (var i = 0; i < tags.length; i++)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (tag === tags[i])\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttag = replaced[i];\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.placeholder.hide();\n\t\t\t\t\tthis.buffer.set();\n\n\t\t\t\t\tif (this.utils.isCollapsed())\n\t\t\t\t\t{\n    \t\t\t\t\tthis.inline.formatCollapsed(tag, attr, value, type);\n    \t\t\t\t}\n    \t\t\t\telse\n    \t\t\t\t{\n    \t\t\t\t\tthis.inline.formatUncollapsed(tag, attr, value, type);\n    \t\t\t\t}\n\t\t\t\t},\n\t\t\t\tformatUncollapsed: function(tag, attr, value, type)\n\t\t\t\t{\n    \t\t\t\tvar self = this;\n    \t\t\t\tvar inlines = this.inline.inlines();\n    \t\t\t\tvar current = this.selection.current();\n    \t\t\t\tif (current)\n    \t\t\t\t{\n    \t\t\t\t    inlines.push(current);\n    \t\t\t\t}\n\n    \t\t\t\tthis.selection.save();\n\n\t\t\t\t\t// save del tag\n\t\t\t\t\tif (tag !== 'del')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.editor().find('del').each(function(i,s)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tself.utils.replaceToTag(s, 'deline');\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\t// save u tag\n\t\t\t\t\tif (tag !== 'u')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.editor().find('u').each(function(i,s)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tself.utils.replaceToTag(s, 'inline');\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n    \t\t\t\t$.each(inlines, function()\n    \t\t\t\t{\n        \t\t\t\tif (this.nodeType === 1)\n        \t\t\t\t{\n            \t\t\t\tvar currentTag = this.tagName.toLowerCase();\n            \t\t\t\tif (currentTag === tag)\n            \t\t\t\t{\n                                var $el = self.utils.replaceToTag(this, 'strike');\n                                $el.addClass('redactor-converted');\n              \t\t\t\t}\n          \t\t\t\t}\n    \t\t\t\t});\n\n    \t\t\t\tthis.selection.restore();\n\n    \t\t\t\tdocument.execCommand('strikethrough');\n\n    \t\t\t\tvar formatting = true;\n    \t\t\t\tvar parent = this.selection.parent();\n    \t\t\t\tif (parent === false || parent.tagName !== 'STRIKE')\n    \t\t\t\t{\n                        formatting = false;\n    \t\t\t\t}\n\n                    this.selection.save();\n                    if (tag !== 'u')\n    \t\t\t\t{\n        \t\t\t\tthis.core.editor().find('u').replaceWith(function()\n    \t\t\t\t\t{\n    \t\t\t\t\t\treturn $(this).contents();\n    \t\t\t\t\t});\n    \t\t\t\t}\n    \t\t\t\tthis.core.editor().find('strike').each(function()\n    \t\t\t\t{\n        \t\t\t\tvar $el = self.utils.replaceToTag(this, tag);\n        \t\t\t\tif (formatting)\n        \t\t\t\t{\n                            self.inline.setAttr($el, attr, value, type);\n                        }\n    \t\t\t\t});\n                    this.core.editor().find('.redactor-converted').each(function()\n    \t\t\t\t{\n        \t\t\t\tvar currentTag = this.tagName.toLowerCase();\n                        if (currentTag !== tag || formatting === false)\n                        {\n                            $(this).replaceWith(function()\n        \t\t\t\t\t{\n        \t\t\t\t\t\treturn $(this).contents();\n        \t\t\t\t\t});\n                        }\n                        $(this).removeClass('redactor-converted');\n    \t\t\t\t});\n                    // restore del tag\n\t\t\t\t\tif (tag !== 'del')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.editor().find('deline').each(function(i,s)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tself.utils.replaceToTag(s, 'del');\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n                    // restore u tag\n\t\t\t\t\tif (tag !== 'u')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.editor().find('inline').each(function(i,s)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tself.utils.replaceToTag(s, 'u');\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n    \t\t\t\tthis.selection.restore();\n\n                },\n                inlines: function()\n                {\n        \t\t\tvar inlines = [];\n        \t\t\tvar nodes = this.inline.nodes();\n\n        \t\t\t$.each(nodes, $.proxy(function(i,node)\n        \t\t\t{\n        \t\t\t\tif (this.utils.isInline(node))\n        \t\t\t\t{\n        \t\t\t\t\tinlines.push(node);\n        \t\t\t\t}\n\n        \t\t\t}, this));\n\n        \t\t\tvar inline = this.selection.inline();\n        \t\t\tif (inline === false && inlines.length === 0)\n        \t\t\t{\n        \t\t\t\treturn [];\n        \t\t\t}\n        \t\t\telse if (inline !== false && inlines.length === 0)\n        \t\t\t{\n        \t\t\t\treturn [inline];\n        \t\t\t}\n        \t\t\telse\n        \t\t\t{\n        \t\t\t\treturn inlines;\n        \t\t\t}\n                },\n                nodes: function()\n                {\n                    var sel = document.getSelection();\n\n                    if (!sel.rangeCount || sel.isCollapsed || !sel.getRangeAt(0).commonAncestorContainer)\n                    {\n                        return [];\n                    }\n\n                    var range = sel.getRangeAt(0);\n\n                    if (range.commonAncestorContainer.nodeType === 3)\n                    {\n                        var toRet = [];\n                        var currNode = range.commonAncestorContainer;\n                        while (currNode.parentNode && currNode.parentNode.childNodes.length === 1)\n                        {\n                            toRet.push(currNode.parentNode);\n                            currNode = currNode.parentNode;\n                        }\n\n                        return toRet;\n                    }\n\n                    return [].filter.call(range.commonAncestorContainer.getElementsByTagName('*'), function (el)\n                    {\n                        return (typeof sel.containsNode === 'function') ? sel.containsNode(el, true) : true;\n                    });\n                },\n\t\t\t\tformatCollapsed: function(tag, attr, value, type)\n\t\t\t\t{\n    \t\t\t\tvar inline = this.selection.inline();\n    \t\t\t\tif (inline)\n\t\t\t\t\t{\n                        var currentTag = inline.tagName.toLowerCase();\n                        if (currentTag === tag)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t// empty = remove\n\t\t\t\t\t\t\tif (this.utils.isEmpty(inline.innerHTML))\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tthis.caret.after(inline);\n\t\t\t\t\t\t\t\t$(inline).remove();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t// not empty = break\n\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tvar $first = this.inline.insertBreakpoint(inline, currentTag);\n\t\t\t\t\t\t\t\tthis.caret.after($first);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n                        else if ($(inline).closest(tag).length === 0)\n                        {\n\t\t\t\t\t\t\tthis.inline.insertInline(tag, attr, value, type);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n    \t\t\t\t\t\tthis.caret.start(inline);\n\t\t\t\t\t\t}\n    \t\t\t\t}\n    \t\t\t\telse\n    \t\t\t\t{\n                        this.inline.insertInline(tag, attr, value, type);\n    \t\t\t\t}\n\n\t\t\t\t},\n                insertBreakpoint: function(inline, currentTag)\n\t\t\t\t{\n\t\t\t\t\tvar breakpoint = document.createElement('span');\n\t\t\t\t\tbreakpoint.id = 'redactor-inline-breakpoint';\n\t\t\t\t\tbreakpoint = this.insert.node(breakpoint);\n\n\t\t\t\t\tvar end = this.utils.isEndOfElement(inline);\n\t\t\t\t\tvar code = this.utils.getOuterHtml(inline);\n\t\t\t\t\tvar endTag = (end) ? '' : '<' + currentTag + '>';\n\n\t\t\t\t\tcode = code.replace(/<span\\sid=\"redactor-inline-breakpoint\"><\\/span>/i, '</' + currentTag + '>' + endTag);\n\t\t\t\t\tvar $code = $(code);\n\t\t\t\t\t$(inline).replaceWith($code);\n\n\t\t\t\t\tif (endTag !== '')\n\t\t\t\t\t{\n    \t\t\t\t\tthis.utils.cloneAttributes(inline, $code.last());\n\t\t\t\t\t}\n\n\t\t\t\t\treturn $code.first();\n\t\t\t\t},\n\t\t\t\tinsertInline: function(tag, attr, value, type)\n\t\t\t\t{\n\t\t\t\t\tvar node = document.createElement(tag);\n\t\t\t\t\tnode = this.inline.setAttr(node, attr, value, type);\n\n\t\t\t\t\tthis.insert.node(node);\n\t\t\t\t\tthis.caret.start(node);\n\t\t\t\t},\n                setAttr: function(inline, attr, value, type)\n\t\t\t\t{\n\t\t\t\t\tif (typeof attr === 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn inline;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar func = (typeof type === 'undefined') ? 'toggle' : type;\n\n\t\t\t\t\tif (attr === 'class')\n\t\t\t\t\t{\n\t\t\t\t\t\tinline = this.inline[func + 'Class'](value, inline);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tif (func === 'remove')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tinline = this.inline[func + 'Attr'](attr, inline);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (func === 'removeAll')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tinline = this.inline[func + 'Attr'](inline);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tinline = this.inline[func + 'Attr'](attr, value, inline);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\treturn inline;\n\t\t\t\t},\n                getInlines: function(inline)\n\t\t\t\t{\n\t\t\t\t\treturn (typeof inline === 'undefined') ? this.selection.inlines() : inline;\n\t\t\t\t},\n\t\t\t\tupdate: function(tag, attr, value, type)\n\t\t\t\t{\n\t\t\t\t\tvar inlines = this.selection.inlines();\n\t\t\t\t\tvar result = [];\n\t\t\t\t\tvar self = this;\n\n\t\t\t\t\t$.each(inlines, function(i,s)\n\t\t\t\t\t{\n\t\t\t\t\t\tif ($.isArray(tag))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tif ($.inArray(s.tagName.toLowerCase(), tag) === -1)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tif (tag !== '*' && s.tagName.toLowerCase() !== tag)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tresult.push(self.inline.setAttr(s, attr, value, type));\n\n\t\t\t\t\t});\n\n\t\t\t\t\treturn result;\n\n\t\t\t\t},\n\t\t\t\treplaceClass: function(value, inline)\n\t\t\t\t{\n\t\t\t\t\treturn $(this.inline.getInlines(inline)).removeAttr('class').addClass(value)[0];\n\t\t\t\t},\n\t\t\t\ttoggleClass: function(value, inline)\n\t\t\t\t{\n\t\t\t\t\treturn $(this.inline.getInlines(inline)).toggleClass(value)[0];\n\t\t\t\t},\n\t\t\t\taddClass: function(value, inline)\n\t\t\t\t{\n\t\t\t\t\treturn $(this.inline.getInlines(inline)).addClass(value)[0];\n\t\t\t\t},\n\t\t\t\tremoveClass: function(value, inline)\n\t\t\t\t{\n\t\t\t\t\treturn $(this.inline.getInlines(inline)).removeClass(value)[0];\n\t\t\t\t},\n\t\t\t\tremoveAllClass: function(inline)\n\t\t\t\t{\n\t\t\t\t\treturn $(this.inline.getInlines(inline)).removeAttr('class')[0];\n\t\t\t\t},\n\t\t\t\treplaceAttr: function(inline, attr, value)\n\t\t\t\t{\n\t\t\t\t\tinline = this.inline.removeAttr(attr, this.inline.getInlines(inline));\n\n\t\t\t\t\treturn $(inline).attr(attr, value)[0];\n\t\t\t\t},\n\t\t\t\ttoggleAttr: function(attr, value, inline)\n\t\t\t\t{\n\t\t\t\t\tinline = this.inline.getInlines(inline);\n\n\t\t\t\t\tvar self = this;\n\t\t\t\t\tvar returned = [];\n\t\t\t\t\t$.each(inline, function(i,s)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar $el = $(s);\n\t\t\t\t\t\tif ($el.attr(attr))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturned.push(self.inline.removeAttr(attr, s));\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturned.push(self.inline.addAttr(attr, value, s));\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\n\t\t\t\t\treturn returned;\n\n\t\t\t\t},\n\t\t\t\taddAttr: function(attr, value, inline)\n\t\t\t\t{\n\t\t\t\t\treturn $(this.inline.getInlines(inline)).attr(attr, value)[0];\n\t\t\t\t},\n\t\t\t\tremoveAttr: function(attr, inline)\n\t\t\t\t{\n\t\t\t\t\treturn $(this.inline.getInlines(inline)).removeAttr(attr)[0];\n\t\t\t\t},\n\t\t\t\tremoveAllAttr: function(inline)\n\t\t\t\t{\n\t\t\t\t\tinline = this.inline.getInlines(inline);\n\n\t\t\t\t\tvar returned = [];\n\t\t\t\t\t$.each(inline, function(i, s)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (typeof s.attributes === 'undefined')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturned.push(s);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tvar $el = $(s);\n\t\t\t\t\t\tvar len = s.attributes.length;\n\t\t\t\t\t\tfor (var z = 0; z < len; z++)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$el.removeAttr(s.attributes[z].name);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturned.push($el[0]);\n\t\t\t\t\t});\n\n\t\t\t\t\treturn returned;\n\t\t\t\t},\n\t\t\t\tremoveFormat: function()\n\t\t\t\t{\n\t\t\t\t\tdocument.execCommand('removeFormat');\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =insert\n\t\tinsert: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tset: function(html)\n\t\t\t\t{\n\t\t\t\t\tthis.placeholder.hide();\n\n\t\t\t\t\tthis.code.set(html);\n\t\t\t\t\tthis.focus.end();\n\n\t\t\t\t\tthis.placeholder.enable();\n\t\t\t\t},\n\t\t\t\thtml: function(html, data)\n\t\t\t\t{\n\t\t\t\t\tthis.placeholder.hide();\n\t\t\t\t\tthis.core.editor().focus();\n\n\t\t\t\t\tvar block = this.selection.block();\n\t\t\t\t\tvar inline = this.selection.inline();\n\n\t\t\t\t\t// clean\n\t\t\t\t\tif (typeof data === 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\tdata = this.clean.getCurrentType(html, true);\n\t\t\t\t\t\thtml = this.clean.onPaste(html, data, true);\n\t\t\t\t\t}\n\n\t\t\t\t\thtml = $.parseHTML(html);\n\n\t\t\t\t\t// delete selected content\n\t\t\t\t\tvar sel = this.selection.get();\n\t\t\t\t\tvar range = this.selection.range(sel);\n\t\t\t\t\trange.deleteContents();\n\n\t\t\t\t\tthis.selection.update(sel, range);\n\n\t\t\t\t\t// insert list in list\n\t\t\t\t\tif (data.lists)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar $list = $(html);\n\t\t\t\t\t\tif ($list.length !== 0 && ($list[0].tagName === 'UL' || $list[0].tagName === 'OL'))\n\t\t\t\t\t\t{\n\n\t\t\t\t\t\t\tthis.insert.appendLists(block, $list);\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (data.blocks && block)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (this.utils.isSelectAll())\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.core.editor().html(html);\n\t\t\t\t\t\t\tthis.focus.end();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar breaked = this.utils.breakBlockTag();\n\t\t\t\t\t\t\tif (breaked === false)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tthis.insert.placeHtml(html);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t{\n    \t\t\t\t\t\t\tvar $last = $(html).children().last();\n\t\t\t\t\t\t\t\t$last.append(this.marker.get());\n\n\t\t\t\t\t\t\t\tif (breaked.type === 'start')\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tbreaked.$block.before(html);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tbreaked.$block.after(html);\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tthis.selection.restore();\n\t\t\t\t\t\t\t\tthis.core.editor().find('p').each(function()\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tif ($.trim(this.innerHTML) === '')\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t$(this).remove();\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tif (inline)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t// remove same tag inside\n\t\t\t\t\t\t\tvar $div = $(\"<div/>\").html(html);\n\t\t\t\t\t\t\t$div.find(inline.tagName.toLowerCase()).each(function()\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t$(this).contents().unwrap();\n\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\thtml = $div.html();\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (this.utils.isSelectAll())\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar $node = $(this.opts.emptyHtml);\n\t\t\t\t\t\t\tthis.core.editor().html('').append($node);\n\t\t\t\t\t\t\t$node.html(html);\n\t\t\t\t\t\t\tthis.caret.end($node);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.insert.placeHtml(html);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\n\t\t\t\t\tthis.utils.disableSelectAll();\n\t\t\t\t\tthis.linkify.format();\n\n\t\t\t\t\tif (data.pre)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.clean.cleanPre();\n\t\t\t\t\t}\n\n\t\t\t\t},\n\t\t\t\ttext: function(text)\n\t\t\t\t{\n\t\t\t\t\ttext = text.toString();\n\t\t\t\t\ttext = $.trim(text);\n\n\t\t\t\t\tvar tmp = document.createElement('div');\n\t\t\t\t\ttmp.innerHTML = text;\n\t\t\t\t\ttext = tmp.textContent || tmp.innerText;\n\n\t\t\t\t\tif (typeof text === 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.placeholder.hide();\n\t\t\t\t\tthis.core.editor().focus();\n\n\t\t\t\t\t// blocks\n\t\t\t\t\tvar blocks = this.selection.blocks();\n\n\t\t\t\t\t// nl to spaces\n\t\t\t\t\ttext = text.replace(/\\n/g, ' ');\n\n\t\t\t\t\t// select all\n\t\t\t\t\tif (this.utils.isSelectAll())\n\t\t\t\t\t{\n\t\t\t\t\t\tvar $node = $(this.opts.emptyHtml);\n\t\t\t\t\t\tthis.core.editor().html('').append($node);\n\t\t\t\t\t\t$node.html(text);\n\t\t\t\t\t\tthis.caret.end($node);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\t// insert\n\t\t\t\t\t\tvar sel = this.selection.get();\n\t\t\t\t\t\tvar node = document.createTextNode(text);\n\n\t\t\t\t\t\tif (sel.getRangeAt && sel.rangeCount)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar range = sel.getRangeAt(0);\n\t\t\t\t\t\t\trange.deleteContents();\n\t\t\t\t\t\t\trange.insertNode(node);\n\t\t\t\t\t\t\trange.setStartAfter(node);\n\t\t\t\t\t\t\trange.collapse(true);\n\n\t\t\t\t\t\t\tthis.selection.update(sel, range);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// wrap node if selected two or more block tags\n\t\t\t\t\t\tif (blocks.length > 1)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$(node).wrap('<p>');\n\t\t\t\t\t\t\tthis.caret.after(node);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.utils.disableSelectAll();\n\t\t\t\t\tthis.linkify.format();\n\t\t\t\t\tthis.clean.normalizeCurrentHeading();\n\n\t\t\t\t},\n\t\t\t\traw: function(html)\n\t\t\t\t{\n\t\t\t\t\tthis.placeholder.hide();\n\t\t\t\t\tthis.core.editor().focus();\n\n\t\t\t\t\tvar sel = this.selection.get();\n\n\t\t\t\t\tvar range = this.selection.range(sel);\n\t\t\t\t\trange.deleteContents();\n\n\t\t            var el = document.createElement(\"div\");\n\t\t            el.innerHTML = html;\n\n\t\t            var frag = document.createDocumentFragment(), node, lastNode;\n\t\t            while ((node = el.firstChild))\n\t\t            {\n\t\t                lastNode = frag.appendChild(node);\n\t\t            }\n\n\t\t            range.insertNode(frag);\n\n\t\t\t\t\tif (lastNode)\n\t\t\t\t\t{\n\t\t\t\t\t\trange = range.cloneRange();\n\t\t\t\t\t\trange.setStartAfter(lastNode);\n\t\t\t\t\t\trange.collapse(true);\n\t\t\t\t\t\tsel.removeAllRanges();\n\t\t\t\t\t\tsel.addRange(range);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tnode: function(node, deleteContent)\n\t\t\t\t{\n\t\t\t\t\tthis.placeholder.hide();\n\n\t\t\t\t\tif (typeof this.start !== 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.editor().focus();\n\t\t\t\t\t}\n\n\t\t\t\t\tnode = node[0] || node;\n\n\t\t\t\t\tvar block = this.selection.block();\n\t\t\t\t\tvar gap = this.utils.isBlockTag(node.tagName);\n\n\t\t\t\t\tif (this.utils.isSelectAll())\n\t\t\t\t\t{\n\t\t\t\t\t\tif (gap)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.core.editor().html(node);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.core.editor().html($('<p>').html(node));\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tthis.code.sync();\n\t\t\t\t\t}\n\t\t\t\t\telse if (gap && block)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar breaked = this.utils.breakBlockTag();\n\t\t\t\t\t\tif (breaked === false)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.insert.placeNode(node, deleteContent);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tif (breaked.type === 'start')\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tbreaked.$block.before(node);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tbreaked.$block.after(node);\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tthis.core.editor().find('p:empty').remove();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.insert.placeNode(node, deleteContent);\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.utils.disableSelectAll();\n\t\t\t\t\tthis.caret.end(node);\n\n\t\t\t\t\treturn node;\n\n\t\t\t\t},\n\t\t\t\tappendLists: function(block, $list)\n\t\t\t\t{\n\t\t\t\t\tvar $block = $(block);\n\t\t\t\t\tvar last;\n\t\t\t\t\tvar isEmpty = this.utils.isEmpty(block.innerHTML);\n\n\t\t\t\t\tif (isEmpty || this.utils.isEndOfElement(block))\n\t\t\t\t\t{\n\t\t\t\t\t\tlast = $block;\n\t\t\t\t\t\t$list.find('li').each(function()\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tlast.after(this);\n\t\t\t\t\t\t\tlast = $(this);\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\tif (isEmpty)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$block.remove();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse if (this.utils.isStartOfElement(block))\n\t\t\t\t\t{\n\t\t\t\t\t\t$list.find('li').each(function()\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$block.before(this);\n\t\t\t\t\t\t\tlast = $(this);\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t        var endOfNode = this.selection.extractEndOfNode(block);\n\n\t\t\t\t        $block.after($('<li>').append(endOfNode));\n\t\t\t\t        $block.append($list);\n\t\t\t\t\t\tlast = $list;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.marker.remove();\n\n\t\t\t\t\tif (last)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.caret.end(last);\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.linkify.format();\n\t\t\t\t},\n\t\t\t\tplaceHtml: function(html)\n\t\t\t\t{\n\t\t\t\t\tvar marker = document.createElement('span');\n\t\t\t\t\tmarker.id = 'redactor-insert-marker';\n\t\t\t\t\tmarker = this.insert.node(marker);\n\n\t\t\t\t\t$(marker).before(html);\n\t\t\t\t\tthis.selection.restore();\n\t\t\t\t\tthis.caret.after(marker);\n\t\t\t\t\t$(marker).remove();\n\t\t\t\t},\n\t\t\t\tplaceNode: function(node, deleteContent)\n\t\t\t\t{\n\t\t\t\t\tvar sel = this.selection.get();\n\t\t\t\t\tvar range = this.selection.range(sel);\n\n\t\t\t\t\tif (deleteContent !== false)\n\t\t\t\t\t{\n\t\t\t\t\t\trange.deleteContents();\n\t\t\t\t\t}\n\n\t\t\t\t\trange.insertNode(node);\n\t\t\t\t\trange.collapse(false);\n\n\t\t\t\t\tthis.selection.update(sel, range);\n\t\t\t\t},\n\t\t\t\tnodeToPoint: function(e, node)\n\t\t\t\t{\n\t\t\t\t\tthis.placeholder.hide();\n\n\t\t\t\t\tnode = node[0] || node;\n\n\t\t\t\t\tif (this.utils.isEmpty())\n\t\t\t\t\t{\n\t\t\t\t\t\tnode = (this.utils.isBlock(node)) ? node : $('<p />').append(node);\n\n\t\t\t\t\t\tthis.core.editor().html(node);\n\n\t\t\t\t\t\treturn node;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar range;\n\t\t\t\t\tvar x = e.clientX, y = e.clientY;\n\t\t\t\t\tif (document.caretPositionFromPoint)\n\t\t\t\t\t{\n\t\t\t\t\t    var pos = document.caretPositionFromPoint(x, y);\n\t\t\t\t\t    var sel = document.getSelection();\n\t\t\t\t\t    range = sel.getRangeAt(0);\n\t\t\t\t\t    range.setStart(pos.offsetNode, pos.offset);\n\t\t\t\t\t    range.collapse(true);\n\t\t\t\t\t    range.insertNode(node);\n\t\t\t\t\t}\n\t\t\t\t\telse if (document.caretRangeFromPoint)\n\t\t\t\t\t{\n\t\t\t\t\t    range = document.caretRangeFromPoint(x, y);\n\t\t\t\t\t    range.insertNode(node);\n\t\t\t\t\t}\n\t\t\t\t\telse if (typeof document.body.createTextRange !== \"undefined\")\n\t\t\t\t\t{\n\t\t\t\t        range = document.body.createTextRange();\n\t\t\t\t        range.moveToPoint(x, y);\n\t\t\t\t        var endRange = range.duplicate();\n\t\t\t\t        endRange.moveToPoint(x, y);\n\t\t\t\t        range.setEndPoint(\"EndToEnd\", endRange);\n\t\t\t\t        range.select();\n\t\t\t\t\t}\n\n\t\t\t\t\treturn node;\n\n\t\t\t\t},\n\n\t\t\t\t// #backward\n\t\t\t\tnodeToCaretPositionFromPoint: function(e, node)\n\t\t\t\t{\n\t\t\t\t\tthis.insert.nodeToPoint(e, node);\n\t\t\t\t},\n\t\t\t\tmarker: function()\n\t\t\t\t{\n\t\t\t\t\tthis.marker.insert();\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =keydown\n\t\tkeydown: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tinit: function(e)\n\t\t\t\t{\n\t\t\t\t\tif (this.rtePaste)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar key = e.which;\n\t\t\t\t\tvar arrow = (key >= 37 && key <= 40);\n\n\t\t\t\t\tthis.keydown.ctrl = e.ctrlKey || e.metaKey;\n\t\t\t\t\tthis.keydown.parent = this.selection.parent();\n\t\t\t\t\tthis.keydown.current = this.selection.current();\n\t\t\t\t\tthis.keydown.block = this.selection.block();\n\n\t\t\t        // detect tags\n\t\t\t\t\tthis.keydown.pre = this.utils.isTag(this.keydown.current, 'pre');\n\t\t\t\t\tthis.keydown.blockquote = this.utils.isTag(this.keydown.current, 'blockquote');\n\t\t\t\t\tthis.keydown.figcaption = this.utils.isTag(this.keydown.current, 'figcaption');\n\t\t\t\t\tthis.keydown.figure = this.utils.isTag(this.keydown.current, 'figure');\n\n\t\t\t\t\t// callback\n\t\t\t\t\tvar keydownStop = this.core.callback('keydown', e);\n\t\t\t\t\tif (keydownStop === false)\n\t\t\t\t\t{\n\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\t// shortcuts setup\n\t\t\t\t\tthis.shortcuts.init(e, key);\n\n\t\t\t\t\t// buffer\n\t\t\t\t\tthis.keydown.checkEvents(arrow, key);\n                    this.keydown.setupBuffer(e, key);\n\n\t\t\t\t\tif (this.utils.isSelectAll() && ( key === this.keyCode.ENTER || key === this.keyCode.BACKSPACE || key === this.keyCode.DELETE))\n\t\t\t\t\t{\n\t\t\t\t\t\te.preventDefault();\n\n\t\t\t\t\t\tthis.code.set(this.opts.emptyHtml);\n\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.keydown.addArrowsEvent(arrow);\n\t\t\t\t\tthis.keydown.setupSelectAll(e, key);\n\n\t\t\t\t\t// turn off enter key\n\t\t\t\t\tif (!this.opts.enterKey && key === this.keyCode.ENTER)\n\t\t\t\t\t{\n\t\t\t\t\t\te.preventDefault();\n\n\t\t\t\t\t\t// remove selected\n\t\t\t\t\t\tvar sel = this.selection.get();\n\t\t\t\t\t\tvar range = this.selection.range(sel);\n\n\t\t\t\t\t\tif (!range.collapsed)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\trange.deleteContents();\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\t// down\n\t\t\t\t\tif (this.opts.enterKey && key === this.keyCode.DOWN)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.keydown.onArrowDown();\n\t\t\t\t\t}\n\n\t\t\t\t\t// up\n\t\t\t\t\tif (this.opts.enterKey && key === this.keyCode.UP)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.keydown.onArrowUp();\n\t\t\t\t\t}\n\n\n\t\t\t\t\t// replace to p before / after the table or into body\n\t\t\t\t\tif ((this.opts.type === 'textarea' || this.opts.type === 'div') && this.keydown.current && this.keydown.current.nodeType === 3 && $(this.keydown.parent).hasClass('redactor-in'))\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.keydown.wrapToParagraph();\n\t\t\t\t\t}\n\n\t\t\t\t\t// on Shift+Space or Ctrl+Space\n\t\t\t\t\tif (key === this.keyCode.SPACE && (e.ctrlKey || e.shiftKey))\n\t\t\t\t\t{\n\t\t\t\t\t\te.preventDefault();\n\n\t\t\t\t\t\treturn this.keydown.onShiftSpace();\n\t\t\t\t\t}\n\n\t\t\t\t\t// on Shift+Enter or Ctrl+Enter\n\t\t\t\t\tif (key === this.keyCode.ENTER && (e.ctrlKey || e.shiftKey))\n\t\t\t\t\t{\n\t\t\t\t\t\te.preventDefault();\n\n\t\t\t\t\t\treturn this.keydown.onShiftEnter(e);\n\t\t\t\t\t}\n\n\t\t\t\t\t// on enter\n\t\t\t\t\tif (key === this.keyCode.ENTER && !e.shiftKey && !e.ctrlKey && !e.metaKey)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn this.keydown.onEnter(e);\n\t\t\t\t\t}\n\n\t\t\t\t\t// tab or cmd + [\n\t\t\t\t\tif (key === this.keyCode.TAB || e.metaKey && key === 221 || e.metaKey && key === 219)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn this.keydown.onTab(e, key);\n\t\t\t\t\t}\n\n\t\t\t\t\t// backspace & delete\n\t\t\t\t\tif (key === this.keyCode.BACKSPACE || key === this.keyCode.DELETE)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.keydown.onBackspaceAndDeleteBefore();\n\t\t\t\t\t}\n\n\n\t\t\t\t\tif (key === this.keyCode.DELETE)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar $next = $(this.keydown.block).next();\n\n\t\t\t\t\t\t// delete figure\n\t\t\t\t\t\tif (this.utils.isEndOfElement(this.keydown.block) && $next.length !== 0 && $next[0].tagName === 'FIGURE')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$next.remove();\n\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// append list (safari bug)\n\t\t\t\t\t\tvar tagLi = (this.keydown.block && this.keydown.block.tagName === 'LI') ? this.keydown.block : false;\n\t\t\t\t\t\tif (tagLi)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar $list = $(this.keydown.block).parents('ul, ol').last();\n\t\t\t\t\t\t\tvar $nextList = $list.next();\n\n\t\t\t\t\t\t\tif (this.utils.isRedactorParent($list) && this.utils.isEndOfElement($list) && $nextList.length !== 0\n\t\t\t\t\t\t\t\t&& ($nextList[0].tagName === 'UL' || $nextList[0].tagName === 'OL'))\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\te.preventDefault();\n\n\t\t\t\t\t\t\t\t$list.append($nextList.contents());\n\t\t\t\t\t\t\t\t$nextList.remove();\n\n\t\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// append pre\n\t\t\t\t\t\tif (this.utils.isEndOfElement(this.keydown.block) && $next.length !== 0 && $next[0].tagName === 'PRE')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$(this.keydown.block).append($next.text());\n\t\t\t\t\t\t\t$next.remove();\n\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}\n\n\t\t\t\t\t// image delete\n\t\t\t\t\tif (key === this.keyCode.DELETE && $('#redactor-image-box').length !== 0)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.image.remove();\n\t\t\t\t\t}\n\n\t\t\t\t\t// backspace\n\t\t\t\t\tif (key === this.keyCode.BACKSPACE)\n\t\t\t\t\t{\n\n\t\t\t\t\t\tif (this.detect.isFirefox())\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.line.removeOnBackspace(e);\n\t\t\t\t\t\t}\n\n                        // combine list after and before if paragraph is empty\n                        if (this.list.combineAfterAndBefore(this.keydown.block))\n                        {\n                            e.preventDefault();\n                            return;\n                        }\n\n\t\t\t\t\t\t// backspace as outdent\n\t\t\t\t\t\tvar block = this.selection.block();\n\t\t\t\t\t\tif (block && block.tagName === 'LI' && this.utils.isCollapsed() && this.utils.isStartOfElement())\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.indent.decrease();\n\t\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tthis.keydown.removeInvisibleSpace();\n\t\t\t\t\t\tthis.keydown.removeEmptyListInTable(e);\n\n\t\t\t\t\t}\n\n\t\t\t\t\tif (key === this.keyCode.BACKSPACE || key === this.keyCode.DELETE)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.keydown.onBackspaceAndDeleteAfter(e);\n\t\t\t\t\t}\n\n\t\t\t\t},\n\t\t\t\tonShiftSpace: function()\n\t\t\t\t{\n\t\t\t\t\tthis.buffer.set();\n\t\t\t\t\tthis.insert.raw('&nbsp;');\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\t\t\t\tonShiftEnter: function(e)\n\t\t\t\t{\n\t\t\t\t\tthis.buffer.set();\n\n\t\t\t\t\treturn (this.keydown.pre) ? this.keydown.insertNewLine(e) : this.insert.raw('<br>');\n\t\t\t\t},\n\t\t\t\tonBackspaceAndDeleteBefore: function()\n\t\t\t\t{\n\t\t\t\t\tthis.utils.saveScroll();\n\t\t\t\t},\n\t\t\t\tonBackspaceAndDeleteAfter: function(e)\n\t\t\t\t{\n\t\t\t\t\t// remove style tag\n\t\t\t\t\tsetTimeout($.proxy(function()\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.code.syncFire = false;\n\t\t\t\t\t\tthis.keydown.removeEmptyLists();\n\n\t\t\t\t\t\tthis.core.editor().find('*[style]').not('img, #redactor-image-box, #redactor-image-editter').removeAttr('style');\n\n\t\t\t\t\t\tthis.keydown.formatEmpty(e);\n\t\t\t\t\t\tthis.code.syncFire = true;\n\n\t\t\t\t\t}, this), 1);\n\t\t\t\t},\n\t\t\t\tonEnter: function(e)\n\t\t\t\t{\n\t\t\t\t\tvar stop = this.core.callback('enter', e);\n\t\t\t\t\tif (stop === false)\n\t\t\t\t\t{\n\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\t// blockquote exit\n\t\t\t\t\tif (this.keydown.blockquote && this.keydown.exitFromBlockquote(e) === true)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\t// pre\n\t\t\t\t\tif (this.keydown.pre)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn this.keydown.insertNewLine(e);\n\t\t\t\t\t}\n\t\t\t\t\t// blockquote & figcaption\n\t\t\t\t\telse if (this.keydown.blockquote || this.keydown.figcaption)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn this.keydown.insertBreakLine(e);\n\t\t\t\t\t}\n\t\t\t\t\t// figure\n\t\t\t\t\telse if (this.keydown.figure)\n\t\t\t\t\t{\n\t\t\t\t\t\tsetTimeout($.proxy(function()\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.keydown.replaceToParagraph('FIGURE');\n\n\t\t\t\t\t\t}, this), 1);\n\t\t\t\t\t}\n\t\t\t\t\t// paragraphs\n\t\t\t\t\telse if (this.keydown.block)\n\t\t\t\t\t{\n\t\t\t\t\t\tsetTimeout($.proxy(function()\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.keydown.replaceToParagraph('DIV');\n\n\t\t\t\t\t\t}, this), 1);\n\n\t\t\t\t\t\t// empty list exit\n\t\t\t\t\t\tif (this.keydown.block.tagName === 'LI')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar current = this.selection.current();\n\t\t\t\t\t\t\tvar $parent = $(current).closest('li', this.$editor[0]);\n\t\t\t\t\t\t\tvar $list = $parent.parents('ul,ol', this.$editor[0]).last();\n\n\t\t\t\t\t\t\tif ($parent.length !== 0 && this.utils.isEmpty($parent.html()) && $list.next().length === 0 && this.utils.isEmpty($list.find(\"li\").last().html()))\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t$list.find(\"li\").last().remove();\n\n\t\t\t\t\t\t\t\tvar node = $(this.opts.emptyHtml);\n\t\t\t\t\t\t\t\t$list.after(node);\n\t\t\t\t\t\t\t\tthis.caret.start(node);\n\n\t\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}\n\t\t\t\t\t// outside\n\t\t\t\t\telse if (!this.keydown.block)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn this.keydown.insertParagraph(e);\n\t\t\t\t\t}\n\n                    // firefox enter into inline element\n\t\t\t\t\tif (this.detect.isFirefox() && this.utils.isInline(this.keydown.parent))\n\t\t\t\t\t{\n                        this.keydown.insertBreakLine(e);\n                        return;\n                    }\n\n\t\t\t\t\t// remove inline tags in new-empty paragraph\n\t\t\t\t\tsetTimeout($.proxy(function()\n\t\t\t\t\t{\n\t\t\t\t\t\tvar inline = this.selection.inline();\n\t\t\t\t\t\tif (inline && this.utils.isEmpty(inline.innerHTML))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar parent = this.selection.block();\n\t\t\t\t\t\t\t$(inline).remove();\n\t\t\t\t\t\t\t//this.caret.start(parent);\n\n                            var range = document.createRange();\n                            range.setStart(parent, 0);\n\n                            var textNode = document.createTextNode('\\u200B');\n\n                            range.insertNode(textNode);\n                            range.setStartAfter(textNode);\n                            range.collapse(true);\n\n                            var sel = window.getSelection();\n            \t\t\t\tsel.removeAllRanges();\n            \t\t\t\tsel.addRange(range);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}, this), 1);\n\n\t\t\t\t},\n\t\t\t\tcheckEvents: function(arrow, key)\n\t\t\t\t{\n\t\t\t\t\tif (!arrow && (this.core.getEvent() === 'click' || this.core.getEvent() === 'arrow'))\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.addEvent(false);\n\n\t\t\t\t\t\tif (this.keydown.checkKeyEvents(key))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.buffer.set();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tcheckKeyEvents: function(key)\n\t\t\t\t{\n\t\t\t\t\tvar k = this.keyCode;\n\t\t\t\t\tvar keys = [k.BACKSPACE, k.DELETE, k.ENTER, k.ESC, k.TAB, k.CTRL, k.META, k.ALT, k.SHIFT];\n\n\t\t\t\t\treturn ($.inArray(key, keys) === -1) ? true : false;\n\n\t\t\t\t},\n\t\t\t\taddArrowsEvent: function(arrow)\n\t\t\t\t{\n\t\t\t\t\tif (!arrow)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif ((this.core.getEvent() === 'click' || this.core.getEvent() === 'arrow'))\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.addEvent(false);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t    this.core.addEvent('arrow');\n\t\t\t\t},\n\t\t\t\tsetupBuffer: function(e, key)\n\t\t\t\t{\n\t\t\t\t\tif (this.keydown.ctrl && key === 90 && !e.shiftKey && !e.altKey && this.opts.buffer.length) // z key\n\t\t\t\t\t{\n\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\tthis.buffer.undo();\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\t// redo\n\t\t\t\t\telse if (this.keydown.ctrl && key === 90 && e.shiftKey && !e.altKey && this.opts.rebuffer.length !== 0)\n\t\t\t\t\t{\n\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\tthis.buffer.redo();\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\telse if (!this.keydown.ctrl)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (key === this.keyCode.SPACE || key === this.keyCode.BACKSPACE || key === this.keyCode.DELETE || (key === this.keyCode.ENTER && !e.ctrlKey && !e.shiftKey))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.buffer.set();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\texitFromBlockquote: function(e)\n\t\t\t\t{\n\n\t\t\t\t\tif (!this.utils.isEndOfElement(this.keydown.blockquote))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar tmp = this.clean.removeSpacesHard($(this.keydown.blockquote).html());\n\t\t\t\t\tif (tmp.search(/(<br\\s?\\/?>){3}$/i) !== -1)\n\t\t\t\t\t{\n\t\t\t\t\t\te.preventDefault();\n\n\t\t\t\t\t\tvar $last = $(this.keydown.blockquote).children().last().prev();\n\n\t\t\t\t\t\t$last.prev().filter('br').remove();\n\t\t\t\t\t\t$last.filter('br').remove();\n\t\t\t\t\t\t$(this.keydown.blockquote).children().last().filter('br').remove();\n\t\t\t\t\t\t$(this.keydown.blockquote).children().last().filter('span').remove();\n\n\t\t\t\t\t\tvar node = $(this.opts.emptyHtml);\n\t\t\t\t\t\t$(this.keydown.blockquote).after(node);\n\t\t\t\t\t\tthis.caret.start(node);\n\n\t\t\t\t\t\treturn true;\n\n\t\t\t\t\t}\n\n\t\t\t\t\treturn;\n\n\t\t\t\t},\n\t\t\t\tonArrowDown: function()\n\t\t\t\t{\n\t\t\t\t\tvar tags = [this.keydown.blockquote, this.keydown.pre, this.keydown.figcaption];\n\n\t\t\t\t\tfor (var i = 0; i < tags.length; i++)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (tags[i])\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.keydown.insertAfterLastElement(tags[i]);\n\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tonArrowUp: function()\n\t\t\t\t{\n\t\t\t\t\tvar tags = [this.keydown.blockquote, this.keydown.pre, this.keydown.figcaption];\n\n\t\t\t\t\tfor (var i = 0; i < tags.length; i++)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (tags[i])\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.keydown.insertBeforeFirstElement(tags[i]);\n\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tinsertAfterLastElement: function(element)\n\t\t\t\t{\n\t\t\t\t\tif (!this.utils.isEndOfElement(element))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar last = this.core.editor().contents().last();\n\t\t\t\t\tvar $next = (element.tagName === 'FIGCAPTION') ? $(this.keydown.block).parent().next() : $(this.keydown.block).next();\n\n\t\t\t\t\tif ($next.length !== 0)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\telse if (last.length === 0 && last[0] !== element)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.caret.start(last);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tvar node = $(this.opts.emptyHtml);\n\n\t\t\t\t\t\tif (element.tagName === 'FIGCAPTION')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t    $(element).parent().after(node);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n    \t\t\t\t\t\t$(element).after(node);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tthis.caret.start(node);\n\t\t\t\t\t}\n\n\t\t\t\t},\n\t\t\t\tinsertBeforeFirstElement: function(element)\n\t\t\t\t{\n\t\t\t\t\tif (!this.utils.isStartOfElement())\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.core.editor().contents().length > 1 && this.core.editor().contents().first()[0] !== element)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar node = $(this.opts.emptyHtml);\n\t\t\t\t\t$(element).before(node);\n\t\t\t\t\tthis.caret.start(node);\n\n\t\t\t\t},\n\t\t\t\tonTab: function(e, key)\n\t\t\t\t{\n\t\t\t\t\tif (!this.opts.tabKey)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar isList = (this.keydown.block && this.keydown.block.tagName === 'LI')\n\t\t\t\t\tif (this.utils.isEmpty(this.code.get()) || (!isList && !this.keydown.pre && this.opts.tabAsSpaces === false))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\n\t\t\t\t\te.preventDefault();\n\t\t\t\t\tthis.buffer.set();\n\n                    var isListStart = (isList && this.utils.isStartOfElement(this.keydown.block));\n\t\t\t\t\tvar node;\n\n\t\t\t\t\tif (this.keydown.pre && !e.shiftKey)\n\t\t\t\t\t{\n\t\t\t\t\t\tnode = (this.opts.preSpaces) ? document.createTextNode(Array(this.opts.preSpaces + 1).join('\\u00a0')) : document.createTextNode('\\t');\n\t\t\t\t\t\tthis.insert.node(node);\n\t\t\t\t\t}\n\t\t\t\t\telse if (this.opts.tabAsSpaces !== false && !isListStart)\n\t\t\t\t\t{\n\t\t\t\t\t\tnode = document.createTextNode(Array(this.opts.tabAsSpaces + 1).join('\\u00a0'));\n\t\t\t\t\t\tthis.insert.node(node);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tif (e.metaKey && key === 219)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.indent.decrease();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (e.metaKey && key === 221)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.indent.increase();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (!e.shiftKey)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.indent.increase();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.indent.decrease();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\t\t\t\tsetupSelectAll: function(e, key)\n\t\t\t\t{\n\t\t\t\t\tif (this.keydown.ctrl && key === 65)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.utils.enableSelectAll();\n\t\t\t\t\t}\n\t\t\t\t\telse if (key !== this.keyCode.LEFT_WIN && !this.keydown.ctrl)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.utils.disableSelectAll();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tinsertNewLine: function(e)\n\t\t\t\t{\n\t\t\t\t\te.preventDefault();\n\n\t\t\t\t\tvar node = document.createTextNode('\\n');\n\n\t\t\t\t\tvar sel = this.selection.get();\n\t\t\t\t\tvar range = this.selection.range(sel);\n\n\t\t\t\t\trange.deleteContents();\n\t\t\t\t\trange.insertNode(node);\n\n\t\t\t\t\tthis.caret.after(node);\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\t\t\t\tinsertParagraph: function(e)\n\t\t\t\t{\n\t\t\t\t\te.preventDefault();\n\n\t\t\t\t\tvar p = document.createElement('p');\n\t\t\t\t\tp.innerHTML = this.opts.invisibleSpace;\n\n\t\t\t\t\tvar sel = this.selection.get();\n\t\t\t\t\tvar range = this.selection.range(sel);\n\n\t\t\t\t\trange.deleteContents();\n\t\t\t\t\trange.insertNode(p);\n\n\t\t\t\t\tthis.caret.start(p);\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\t\t\t\tinsertBreakLine: function(e)\n\t\t\t\t{\n\t\t\t\t\treturn this.keydown.insertBreakLineProcessing(e);\n\t\t\t\t},\n\t\t\t\tinsertDblBreakLine: function(e)\n\t\t\t\t{\n\t\t\t\t\treturn this.keydown.insertBreakLineProcessing(e, true);\n\t\t\t\t},\n\t\t\t\tinsertBreakLineProcessing: function(e, dbl)\n\t\t\t\t{\n\t\t\t\t\te.stopPropagation();\n\n\t\t\t\t\tvar br1 = document.createElement('br');\n\t\t\t\t\tthis.insert.node(br1);\n\n\t\t\t\t\tif (dbl === true)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar br2 = document.createElement('br');\n\t\t\t\t\t\tthis.insert.node(br2);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\n\t\t\t\t},\n\t\t\t\twrapToParagraph: function()\n\t\t\t\t{\n\t\t\t\t\tvar $current = $(this.keydown.current);\n\t\t\t\t\tvar\tnode = $('<p>').append($current.clone());\n\t\t\t\t\t$current.replaceWith(node);\n\n\n\t\t\t\t\tvar next = $(node).next();\n\t\t\t\t\tif (typeof(next[0]) !== 'undefined' && next[0].tagName === 'BR')\n\t\t\t\t\t{\n\t\t\t\t\t\tnext.remove();\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.caret.end(node);\n\n\t\t\t\t},\n\t\t\t\treplaceToParagraph: function(tag)\n\t\t\t\t{\n\t\t\t\t\tvar blockElem = this.selection.block();\n\t\t\t\t\tvar $prev = $(blockElem).prev();\n\n\t\t\t\t\tvar blockHtml = blockElem.innerHTML.replace(/<br\\s?\\/?>/gi, '');\n\t\t\t\t\tif (blockElem.tagName === tag && this.utils.isEmpty(blockHtml) && !$(blockElem).hasClass('redactor-in'))\n\t\t\t\t\t{\n\t\t\t\t\t\tvar p = document.createElement('p');\n\t\t\t\t\t\t$(blockElem).replaceWith(p);\n\n                        this.keydown.setCaretToParagraph(p);\n\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\t\t\t\t\telse if (blockElem.tagName === 'P')\n\t\t\t\t\t{\n\t\t\t\t\t\t$(blockElem).removeAttr('class').removeAttr('style');\n\n\t\t\t\t\t\t// fix #227\n\t\t\t\t\t\tif (this.detect.isIe() && this.utils.isEmpty(blockHtml) && this.utils.isInline(this.keydown.parent))\n                        {\n                            $(blockElem).on('input', $.proxy(function()\n                            {\n                                var parent = this.selection.parent();\n                                if (this.utils.isInline(parent))\n                                {\n                                    var html = $(parent).html();\n                                    $(blockElem).html(html);\n                                    this.caret.end(blockElem);\n                                }\n\n                                $(blockElem).off('keyup');\n\n                            }, this));\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\t\t\t\t\telse if ($prev.hasClass(this.opts.videoContainerClass))\n\t\t\t\t\t{\n    \t\t\t\t\t$prev.removeAttr('class');\n\n    \t\t\t\t\tvar p = document.createElement('p');\n\t\t\t\t\t\t$prev.replaceWith(p);\n\n\t\t\t\t\t\tthis.keydown.setCaretToParagraph(p);\n\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tsetCaretToParagraph: function(p)\n\t\t\t\t{\n                    var range = document.createRange();\n                    range.setStart(p, 0);\n\n                    var textNode = document.createTextNode('\\u200B');\n\n                    range.insertNode(textNode);\n                    range.setStartAfter(textNode);\n                    range.collapse(true);\n\n                    var sel = window.getSelection();\n    \t\t\t\tsel.removeAllRanges();\n    \t\t\t\tsel.addRange(range);\n\t\t\t\t},\n\t\t\t\tremoveInvisibleSpace: function()\n\t\t\t\t{\n\t\t\t\t\tvar $current = $(this.keydown.current);\n\t\t\t\t\tif ($current.text().search(/^\\u200B$/g) === 0)\n\t\t\t\t\t{\n\t\t\t\t\t\t$current.remove();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tremoveEmptyListInTable: function(e)\n\t\t\t\t{\n\t\t\t\t\tvar $current = $(this.keydown.current);\n\t\t\t\t\tvar $parent = $(this.keydown.parent);\n\t\t\t\t\tvar td = $current.closest('td', this.$editor[0]);\n\n\t\t\t\t\tif (td.length !== 0 && $current.closest('li', this.$editor[0]) && $parent.children('li').length === 1)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (!this.utils.isEmpty($current.text()))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\te.preventDefault();\n\n\t\t\t\t\t\t$current.remove();\n\t\t\t\t\t\t$parent.remove();\n\n\t\t\t\t\t\tthis.caret.start(td);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tremoveEmptyLists: function()\n\t\t\t\t{\n\t\t\t\t\tvar removeIt = function()\n\t\t\t\t\t{\n\t\t\t\t\t\tvar html = $.trim(this.innerHTML).replace(/\\/t\\/n/g, '');\n\t\t\t\t\t\tif (html === '')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$(this).remove();\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\n\t\t\t\t\tthis.core.editor().find('li').each(removeIt);\n\t\t\t\t\tthis.core.editor().find('ul, ol').each(removeIt);\n\t\t\t\t},\n\t\t\t\tformatEmpty: function(e)\n\t\t\t\t{\n\t\t\t\t\tvar html = $.trim(this.core.editor().html());\n\n\t\t\t\t\tif (!this.utils.isEmpty(html))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\te.preventDefault();\n\n\t\t\t\t\tif (this.opts.type === 'inline' || this.opts.type === 'pre')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.editor().html(this.marker.html());\n\t\t\t\t\t\tthis.selection.restore();\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.editor().html(this.opts.emptyHtml);\n\t\t\t\t\t\tthis.focus.start();\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =keyup\n\t\tkeyup: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tinit: function(e)\n\t\t\t\t{\n\n\t\t\t\t\tif (this.rtePaste)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar key = e.which;\n\t\t\t\t\tthis.keyup.block = this.selection.block();\n\t\t\t\t\tthis.keyup.current = this.selection.current();\n\t\t\t\t\tthis.keyup.parent = this.selection.parent();\n\n\t\t\t\t\t// callback\n\t\t\t\t\tvar stop = this.core.callback('keyup', e);\n\t\t\t\t\tif (stop === false)\n\t\t\t\t\t{\n\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n                    // replace a prev figure to paragraph if caret is before image\n                    if (key === this.keyCode.ENTER)\n                    {\n                        if (this.keyup.block && this.keyup.block.tagName === 'FIGURE')\n                        {\n                            var $prev = $(this.keyup.block).prev();\n                            if ($prev.length !== 0 && $prev[0].tagName === 'FIGURE')\n                            {\n                                var $newTag = this.utils.replaceToTag($prev, 'p');\n                                this.caret.start($newTag);\n                                return;\n                            }\n                        }\n                    }\n\n\t\t\t\t\t// replace figure to paragraph\n\t\t\t\t\tif (key === this.keyCode.BACKSPACE || key === this.keyCode.DELETE)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (this.utils.isSelectAll())\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.focus.start();\n\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\n\t\t\t\t\t\t// if caret before figure - delete image\n\t\t\t\t\t\tif (this.keyup.block && this.keydown.block && this.keyup.block.tagName === 'FIGURE' && this.utils.isStartOfElement(this.keydown.block))\n\t\t\t\t\t\t{\n    \t\t\t\t\t\te.preventDefault();\n\n                            this.selection.save();\n                            $(this.keyup.block).find('figcaption').remove();\n    \t\t\t\t\t\t$(this.keyup.block).find('img').first().remove();\n    \t\t\t\t\t\tthis.utils.replaceToTag(this.keyup.block, 'p');\n\n    \t\t\t\t\t\tvar $marker = this.marker.find();\n    \t\t\t\t\t\t$('html, body').animate({ scrollTop: $marker.position().top + 20 }, 500);\n\n    \t\t\t\t\t\tthis.selection.restore();\n    \t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\n\t\t\t\t\t\t// if paragraph does contain only image replace to figure\n\t\t\t\t\t\tif (this.keyup.block && this.keyup.block.tagName === 'P')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar isContainImage = $(this.keyup.block).find('img').length;\n\t\t\t\t\t\t\tvar text = $(this.keyup.block).text().replace(/\\u200B/g, '');\n\t\t\t\t\t\t\tif (text === '' && isContainImage !== 0)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tthis.utils.replaceToTag(this.keyup.block, 'figure');\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// if figure does not contain image - replace to paragraph\n\t\t\t\t\t\tif (this.keyup.block && this.keyup.block.tagName === 'FIGURE' && $(this.keyup.block).find('img').length === 0)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.selection.save();\n\t\t\t\t\t\t\tthis.utils.replaceToTag(this.keyup.block, 'p');\n\t\t\t\t\t\t\tthis.selection.restore();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\t// linkify\n\t\t\t\t\tif (this.linkify.isKey(key))\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.linkify.format();\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t};\n\t\t},\n\n\t\t// =lang\n\t\tlang: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tload: function()\n\t\t\t\t{\n\t\t\t\t\tthis.opts.curLang = this.opts.langs[this.opts.lang];\n\t\t\t\t},\n\t\t\t\tget: function(name)\n\t\t\t\t{\n\t\t\t\t\treturn (typeof this.opts.curLang[name] !== 'undefined') ? this.opts.curLang[name] : '';\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =line\n\t\tline: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tinsert: function()\n\t\t\t\t{\n\t\t\t\t\tthis.buffer.set();\n\n\t\t\t\t\t// insert\n\t\t\t\t\tthis.insert.html(this.line.getLineHtml());\n\n\t\t\t\t\t// find\n\t\t\t\t\tvar $hr = this.core.editor().find('#redactor-hr-tmp-id');\n\t\t\t\t\t$hr.removeAttr('id');\n\n\t\t\t\t\tthis.core.callback('insertedLine', $hr);\n\n\t\t\t\t\treturn $hr;\n\t\t\t\t},\n\t\t\t\tgetLineHtml: function()\n\t\t\t\t{\n\t\t\t\t\tvar html = '<hr id=\"redactor-hr-tmp-id\" />';\n\t\t\t\t\tif (!this.detect.isFirefox() && this.utils.isEmpty())\n\t\t\t\t\t{\n\t\t\t\t\t\thtml += '<p>' + this.opts.emptyHtml + '</p>';\n\t\t\t\t\t}\n\n\t\t\t\t\treturn html;\n\t\t\t\t},\n\t\t\t\t// ff only\n\t\t\t\tremoveOnBackspace: function(e)\n\t\t\t\t{\n\t\t\t\t\tif (!this.utils.isCollapsed())\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar $block = $(this.selection.block());\n\t\t\t\t\tif ($block.length === 0 || !this.utils.isStartOfElement($block))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\t// if hr is previous element\n\t\t\t\t\tvar $prev = $block.prev();\n\t\t\t\t\tif ($prev && $prev[0].tagName === 'HR')\n\t\t\t\t\t{\n\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\t$prev.remove();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =link\n\t\tlink: function()\n\t\t{\n\t\t\treturn {\n\n\t\t\t\t// public\n\t\t\t\tget: function()\n\t\t\t\t{\n\t\t\t\t\treturn $(this.selection.inlines('a'));\n\t\t\t\t},\n\t\t\t\tis: function()\n\t\t\t\t{\n\t\t\t\t\tvar nodes = this.selection.nodes() ;\n\t\t\t\t\tvar $link = $(this.selection.current()).closest('a', this.core.editor()[0]);\n\n\t\t\t\t\treturn ($link.length === 0 || nodes.length > 1) ? false : $link;\n\t\t\t\t},\n\t\t\t\tunlink: function(e)\n\t\t\t\t{\n\t\t\t\t\t// if call from clickable element\n\t\t\t\t\tif (typeof e !== 'undefined' && e.preventDefault)\n\t\t\t\t\t{\n\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t}\n\n\t\t\t\t\t// buffer\n\t\t\t\t\tthis.buffer.set();\n\n\t\t\t\t\tvar links = this.selection.inlines('a');\n\t\t\t\t\tif (links.length === 0)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar $links = this.link.replaceLinksToText(links);\n\n\t\t\t\t\tthis.observe.closeAllTooltip();\n\t\t\t\t\tthis.core.callback('deletedLink', $links);\n\n\t\t\t\t},\n\t\t\t\tinsert: function(link, cleaned)\n\t\t\t\t{\n\t\t\t\t\tvar $el = this.link.is();\n\n\t\t\t\t\tif (cleaned !== true)\n\t\t\t\t\t{\n\t\t\t\t\t\tlink = this.link.buildLinkFromObject($el, link);\n\t\t\t\t\t\tif (link === false)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\t// buffer\n\t\t\t\t\tthis.buffer.set();\n\n\t\t\t\t\t// callback\n\t\t\t\t\tlink = this.core.callback('beforeInsertingLink', link);\n\n\t\t\t\t\tif ($el === false)\n\t\t\t\t\t{\n\t\t\t\t\t\t// insert\n\t\t\t\t\t\t$el = $('<a />');\n\t\t\t\t\t\t$el = this.link.update($el, link);\n\t\t\t\t\t\t$el = $(this.insert.node($el));\n\n\t\t\t\t\t\tvar $parent = $el.parent();\n\t\t\t\t\t\tif (this.utils.isRedactorParent($parent) === false)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$el.wrap('<p>');\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// remove unlink wrapper\n\t\t\t\t\t\tif ($parent.hasClass('redactor-unlink'))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$parent.replaceWith(function(){\n\t\t\t\t\t\t\t\treturn $(this).contents();\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tthis.caret.after($el);\n\t\t\t\t\t\tthis.core.callback('insertedLink', $el);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\t// update\n\t\t\t\t\t\t$el = this.link.update($el, link);\n\t\t\t\t\t\tthis.caret.after($el);\n\t\t\t\t\t}\n\n\t\t\t\t},\n\t\t\t\tupdate: function($el, link)\n\t\t\t\t{\n\t\t\t\t\t$el.text(link.text);\n\t\t\t\t\t$el.attr('href', link.url);\n\n\t\t\t\t\tthis.link.target($el, link.target);\n\n\t\t\t\t\treturn $el;\n\n\t\t\t\t},\n\t\t\t\ttarget: function($el, target)\n\t\t\t\t{\n\t\t\t\t\treturn (target) ? $el.attr('target', '_blank') : $el.removeAttr('target');\n\t\t\t\t},\n\t\t\t\tshow: function(e)\n\t\t\t\t{\n\t\t\t\t\t// if call from clickable element\n\t\t\t\t\tif (typeof e !== 'undefined' && e.preventDefault)\n\t\t\t\t\t{\n\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t}\n\n\t\t\t\t\t// close tooltip\n\t\t\t\t\tthis.observe.closeAllTooltip();\n\n\t\t\t\t\t// is link\n\t\t\t\t\tvar $el = this.link.is();\n\n\t\t\t\t\t// build modal\n\t\t\t\t\tthis.link.buildModal($el);\n\n\t\t\t\t\t// build link\n\t\t\t\t\tvar link = this.link.buildLinkFromElement($el);\n\n\t\t\t\t\t// if link cut & paste inside editor browser added self host to a link\n\t\t\t\t\tlink.url = this.link.removeSelfHostFromUrl(link.url);\n\n                    // new tab target\n\t\t\t\t\tif (this.opts.linkNewTab && !$el)\n\t\t\t\t\t{\n    \t\t\t\t\tlink.target = true;\n\t\t\t\t\t}\n\n\t\t\t\t\t// set modal values\n\t\t\t\t\tthis.link.setModalValues(link);\n\n\t\t\t\t\t// show modal\n\t\t\t\t\tthis.modal.show();\n\n\t\t\t\t\t// focus\n\t\t\t\t\tif (this.detect.isDesktop())\n\t\t\t\t\t{\n\t\t\t\t\t\t$('#redactor-link-url').focus();\n\t\t\t\t\t}\n\t\t\t\t},\n\n\t\t\t\t// private\n\t\t\t\tsetModalValues: function(link)\n\t\t\t\t{\n\t\t\t\t\t$('#redactor-link-blank').prop('checked', link.target);\n\t\t\t\t\t$('#redactor-link-url').val(link.url);\n\t\t\t\t\t$('#redactor-link-url-text').val(link.text);\n\t\t\t\t},\n\t\t\t\tbuildModal: function($el)\n\t\t\t\t{\n\t\t\t\t\tthis.modal.load('link', this.lang.get(($el === false) ? 'link-insert' : 'link-edit'), 600);\n\n\t\t\t\t\t// button insert\n\t\t\t\t\tvar $btn = this.modal.getActionButton();\n\t\t\t\t\t$btn.text(this.lang.get(($el === false) ? 'insert' : 'save')).on('click', $.proxy(this.link.callback, this));\n\n\t\t\t\t},\n\t\t\t\tcallback: function()\n\t\t\t\t{\n\t\t\t\t\t// build link\n\t\t\t\t\tvar link = this.link.buildLinkFromModal();\n\t\t\t\t\tif (link === false)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\t// close\n\t\t\t\t\tthis.modal.close();\n\n\t\t\t\t\t// insert or update\n\t\t\t\t\tthis.link.insert(link, true);\n\t\t\t\t},\n\t\t\t\tcleanUrl: function(url)\n\t\t\t\t{\n\t\t\t\t\treturn (typeof url === 'undefined') ? '' : $.trim(url.replace(/[^\\W\\w\\D\\d+&\\'@#/%?=~_|!:,.;\\(\\)]/gi, ''));\n\t\t\t\t},\n\t\t\t\tcleanText: function(text)\n\t\t\t\t{\n\t\t\t\t\treturn (typeof text === 'undefined') ? '' :$.trim(text.replace(/(<([^>]+)>)/gi, ''));\n\t\t\t\t},\n\t\t\t\tgetText: function(link)\n\t\t\t\t{\n\t\t\t\t\treturn (link.text === '' && link.url !== '') ? this.link.truncateUrl(link.url.replace(/<|>/g, '')) : link.text;\n\t\t\t\t},\n\t\t\t\tisUrl: function(url)\n\t\t\t\t{\n\t\t\t\t\tvar pattern = '((xn--)?[\\\\W\\\\w\\\\D\\\\d]+(-[\\\\W\\\\w\\\\D\\\\d]+)*\\\\.)+[\\\\W\\\\w]{2,}';\n\n\t\t\t\t\tvar re1 = new RegExp('^(http|ftp|https)://' + pattern, 'i');\n\t\t\t\t\tvar re2 = new RegExp('^' + pattern, 'i');\n\t\t\t\t\tvar re3 = new RegExp('\\.(html|php)$', 'i');\n\t\t\t\t\tvar re4 = new RegExp('^/', 'i');\n\t\t\t\t\tvar re5 = new RegExp('^tel:(.*?)', 'i');\n\n\t\t\t\t\t// add protocol\n\t\t\t\t\tif (url.search(re1) === -1 && url.search(re2) !== -1 && url.search(re3) === -1)\n\t\t\t\t\t{\n\t\t\t\t\t\turl = 'http://' + url;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (url.search(re1) !== -1 || url.search(re3) !== -1 || url.search(re4) !== -1 || url.search(re5) !== -1)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn url;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\t\t\t\tisMailto: function(url)\n\t\t\t\t{\n\t\t\t\t\treturn (url.search('@') !== -1 && /(http|ftp|https):\\/\\//i.test(url) === false);\n\t\t\t\t},\n\t\t\t\tisEmpty: function(link)\n\t\t\t\t{\n\t\t\t\t\treturn (link.url === '' || (link.text === '' && link.url === ''));\n\t\t\t\t},\n\t\t\t\ttruncateUrl: function(url)\n\t\t\t\t{\n\t\t\t\t\treturn (url.length > this.opts.linkSize) ? url.substring(0, this.opts.linkSize) + '...' : url;\n\t\t\t\t},\n\t\t\t\tparse: function(link)\n\t\t\t\t{\n\t\t\t\t\t// mailto\n\t\t\t\t\tif (this.link.isMailto(link.url))\n\t\t\t\t\t{\n\t\t\t\t\t\tlink.url = 'mailto:' + link.url.replace('mailto:', '');\n\t\t\t\t\t}\n\t\t\t\t\t// url\n\t\t\t\t\telse if (link.url.search('#') !== 0)\n\t\t\t\t\t{\n\t\t\t\t\t\tlink.url = this.link.isUrl(link.url);\n\t\t\t\t\t}\n\n\t\t\t\t\t// empty url or text or isn't url\n\t\t\t\t\treturn (this.link.isEmpty(link) || link.url === false) ? false : link;\n\n\t\t\t\t},\n\t\t\t\tbuildLinkFromModal: function()\n\t\t\t\t{\n\t\t\t\t\tvar link = {};\n\n\t\t\t\t\t// url\n\t\t\t\t\tlink.url = this.link.cleanUrl($('#redactor-link-url').val());\n\n\t\t\t\t\t// text\n\t\t\t\t\tlink.text = this.link.cleanText($('#redactor-link-url-text').val());\n\t\t\t\t\tlink.text = this.link.getText(link);\n\n\t\t\t\t\t// target\n\t\t\t\t\tlink.target = ($('#redactor-link-blank').prop('checked')) ? true : false;\n\n\t\t\t\t\t// parse\n\t\t\t\t\treturn this.link.parse(link);\n\n\t\t\t\t},\n\t\t\t\tbuildLinkFromObject: function($el, link)\n\t\t\t\t{\n\t\t\t\t\t// url\n\t\t\t\t\tlink.url = this.link.cleanUrl(link.url);\n\n\t\t\t\t\t// text\n\t\t\t\t\tlink.text = (typeof link.text === 'undefined' && this.selection.is()) ? this.selection.text() : this.link.cleanText(link.text);\n\t\t\t\t\tlink.text = this.link.getText(link);\n\n\t\t\t\t\t// target\n\t\t\t\t\tlink.target = ($el === false) ? link.target : this.link.buildTarget($el);\n\n\t\t\t\t\t// parse\n\t\t\t\t\treturn this.link.parse(link);\n\n\t\t\t\t},\n\t\t\t\tbuildLinkFromElement: function($el)\n\t\t\t\t{\n\t\t\t\t\tvar link = {\n\t\t\t\t\t\turl: '',\n\t\t\t\t\t\ttext: (this.selection.is()) ? this.selection.text() : '',\n\t\t\t\t\t\ttarget: false\n\t\t\t\t\t};\n\n\t\t\t\t\tif ($el !== false)\n\t\t\t\t\t{\n\t\t\t\t\t\tlink.url = $el.attr('href');\n\t\t\t\t\t\tlink.text = $el.text();\n\t\t\t\t\t\tlink.target = this.link.buildTarget($el);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn link;\n\t\t\t\t},\n\t\t\t\tbuildTarget: function($el)\n\t\t\t\t{\n\t\t\t\t\treturn (typeof $el.attr('target') !== 'undefined' && $el.attr('target') === '_blank') ? true : false;\n\t\t\t\t},\n\t\t\t\tremoveSelfHostFromUrl: function(url)\n\t\t\t\t{\n\t\t\t\t\tvar href = self.location.href.replace('#', '').replace(/\\/$/i, '');\n\t\t\t\t\treturn url.replace(/^\\/\\#/, '#').replace(href, '').replace('mailto:', '');\n\t\t\t\t},\n\t\t\t\treplaceLinksToText: function(links)\n\t\t\t\t{\n\t\t\t\t\tvar $first;\n\t\t\t\t\tvar $links = $.each(links, function(i,s)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar $el = $(s);\n\t\t\t\t\t\tvar $unlinked = $('<span class=\"redactor-unlink\" />').append($el.contents());\n\t\t\t\t\t\t$el.replaceWith($unlinked);\n\n\t\t\t\t\t\tif (i === 0)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$first = $unlinked;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn $el;\n\t\t\t\t\t});\n\n\t\t\t\t\t// set caret after unlinked node\n\t\t\t\t\tif (links.length === 1 && this.selection.isCollapsed())\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.caret.after($first);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn $links;\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =linkify\n\t\tlinkify: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tisKey: function(key)\n\t\t\t\t{\n\t\t\t\t\treturn key === this.keyCode.ENTER || key === this.keyCode.SPACE;\n\t\t\t\t},\n\t\t\t\tisLink: function(node)\n\t\t\t\t{\n\t\t\t\t\treturn (node.nodeValue.match(this.opts.regexps.linkyoutube) || node.nodeValue.match(this.opts.regexps.linkvimeo) || node.nodeValue.match(this.opts.regexps.linkimage) || node.nodeValue.match(this.opts.regexps.url));\n\t\t\t\t},\n\t\t\t\tisFiltered: function(i, node)\n\t\t\t\t{\n\t\t\t\t\treturn node.nodeType === 3 && $.trim(node.nodeValue) !== \"\" && !$(node).parent().is(\"pre\") && (this.linkify.isLink(node));\n\t\t\t\t},\n\t\t\t\thandler: function(i, node)\n\t\t\t\t{\n\t\t\t\t\tvar $el = $(node);\n\t\t\t\t\tvar text = $el.text();\n\t\t\t\t\tvar html = text;\n\n\t\t\t\t\tif (html.match(this.opts.regexps.linkyoutube) || html.match(this.opts.regexps.linkvimeo))\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = this.linkify.convertVideoLinks(html);\n\t\t\t\t\t}\n\t\t\t\t\telse if (html.match(this.opts.regexps.linkimage))\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = this.linkify.convertImages(html);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = this.linkify.convertLinks(html);\n\t\t\t\t\t}\n\n\t\t\t\t\t$el.before(text.replace(text, html)).remove();\n\t\t\t\t},\n\t\t\t\tformat: function()\n\t\t\t\t{\n\t\t\t\t\tif (!this.opts.linkify || this.utils.isCurrentOrParent('pre'))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.core.editor().find(\":not(iframe,img,a,pre,.redactor-unlink)\").addBack().contents().filter($.proxy(this.linkify.isFiltered, this)).each($.proxy(this.linkify.handler, this));\n\n\t\t\t\t\t// collect\n\t\t\t\t\tvar $objects = this.core.editor().find('.redactor-linkify-object').each($.proxy(function(i,s)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar $el = $(s);\n\t\t\t\t\t\t$el.removeClass('redactor-linkify-object');\n\t\t\t\t\t\tif ($el.attr('class') === '')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$el.removeAttr('class');\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (s.tagName === 'DIV') // video container\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.linkify.breakBlockTag($el, 'video');\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (s.tagName === 'IMG') // image\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.linkify.breakBlockTag($el, 'image');\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (s.tagName === 'A')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.core.callback('insertedLink', $el);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn $el;\n\n\t\t\t\t\t}, this));\n\n\t\t\t\t\t// callback\n\t\t\t\t\tsetTimeout($.proxy(function()\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.code.sync();\n\t\t\t\t\t\tthis.core.callback('linkify', $objects);\n\n\t\t\t\t\t}, this), 100);\n\n\t\t\t\t},\n\t\t\t\tbreakBlockTag: function($el, type)\n\t\t\t\t{\n\t\t\t\t\tvar breaked = this.utils.breakBlockTag();\n\t\t\t\t\tif (breaked === false)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar $newBlock = $el;\n\t\t\t\t\tif (type === 'image')\n\t\t\t\t\t{\n\t\t\t\t\t\t$newBlock = $('<figure />').append($el);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (breaked.type === 'start')\n\t\t\t\t\t{\n\t\t\t\t\t\tbreaked.$block.before($newBlock);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tbreaked.$block.after($newBlock);\n\t\t\t\t\t}\n\n\n\t\t\t\t\tif (type === 'image')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.caret.after($newBlock);\n\t\t\t\t\t}\n\n\t\t\t\t},\n\t\t\t\tconvertVideoLinks: function(html)\n\t\t\t\t{\n\t\t\t\t\tvar iframeStart = '<div class=\"' + this.opts.videoContainerClass + ' redactor-linkify-object\"><iframe class=\"redactor-linkify-object\" width=\"500\" height=\"281\" src=\"';\n\t\t\t\t\tvar iframeEnd = '\" frameborder=\"0\" allowfullscreen></iframe></div>';\n\n\t\t\t\t\tif (html.match(this.opts.regexps.linkyoutube))\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = html.replace(this.opts.regexps.linkyoutube, iframeStart + '//www.youtube.com/embed/$1' + iframeEnd);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (html.match(this.opts.regexps.linkvimeo))\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = html.replace(this.opts.regexps.linkvimeo, iframeStart + '//player.vimeo.com/video/$2' + iframeEnd);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn html;\n\t\t\t\t},\n\t\t\t\tconvertImages: function(html)\n\t\t\t\t{\n\t\t\t\t\tvar matches = html.match(this.opts.regexps.linkimage);\n\t\t\t\t\tif (!matches)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn html;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn html.replace(html, '<img src=\"' + matches + '\" class=\"redactor-linkify-object\" />');\n\t\t\t\t},\n\t\t\t\tconvertLinks: function(html)\n\t\t\t\t{\n\t\t\t\t\tvar matches = html.match(this.opts.regexps.url);\n\t\t\t\t\tif (!matches)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn html;\n\t\t\t\t\t}\n\n\t\t\t\t\tmatches = $.grep(matches, function(v, k) { return $.inArray(v, matches) === k; });\n\n\t\t\t\t\tvar length = matches.length;\n\n\t\t\t\t\tfor (var i = 0; i < length; i++)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar href = matches[i], text = href;\n\t\t\t\t\t\tvar linkProtocol = (href.match(/(https?|ftp):\\/\\//i) !== null) ? '' : 'http://';\n\n\t\t\t\t\t\tif (text.length > this.opts.linkSize)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttext = text.substring(0, this.opts.linkSize) + '...';\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (text.search('%') === -1)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttext = decodeURIComponent(text);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tvar regexB = \"\\\\b\";\n\n\t\t\t\t\t\tif ($.inArray(href.slice(-1), [\"/\", \"&\", \"=\"]) !== -1)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tregexB = \"\";\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// escaping url\n\t\t\t\t\t\tvar regexp = new RegExp('(' + href.replace(/[\\-\\[\\]\\/\\{\\}\\(\\)\\*\\+\\?\\.\\\\\\^\\$\\|]/g, \"\\\\$&\") + regexB + ')', 'g');\n\n\t\t\t\t\t\thtml = html.replace(regexp, '<a href=\"' + linkProtocol + $.trim(href) + '\" class=\"redactor-linkify-object\">' + $.trim(text) + '</a>');\n\t\t\t\t\t}\n\n\t\t\t\t\treturn html;\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =list\n\t\tlist: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\ttoggle: function(cmd)\n\t\t\t\t{\n\t\t\t\t\tif (this.utils.inBlocks(['table', 'td', 'th', 'tr']))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar tag = (cmd === 'orderedlist' || cmd === 'ol') ? 'OL' : 'UL';\n\t\t\t\t\tcmd = (tag === 'OL') ? 'orderedlist' : 'unorderedlist'\n\n\t\t\t\t\tvar $list = $(this.selection.current()).parentsUntil('.redactor-in', 'ul, ol').first();\n\n\t\t\t\t\tthis.placeholder.hide();\n\t\t\t\t\tthis.buffer.set();\n\n\n\t\t\t\t\tif ($list.length !== 0 && $list[0].tagName === tag && this.utils.isRedactorParent($list))\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.selection.save();\n\n\t\t\t\t\t\t// remove list\n\t\t\t\t\t\t$list.find('ul, ol').each(function()\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar parent = $(this).closest('li');\n\t\t\t\t\t\t\t$(this).find('li').each(function()\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t$(parent).after(this);\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\t$list.find('ul, ol').remove();\n\t\t\t\t\t\t$list.find('li').each(function()\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn $(this).replaceWith(function()\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\treturn $('<p />').append($(this).contents());\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t});\n\n\n\t\t\t\t\t\t$list.replaceWith(function()\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn $(this).contents();\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\tthis.selection.restore();\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\n\t\t\t\t\tthis.selection.save();\n\n\t\t\t\t\tif ($list.length !== 0 && $list[0].tagName !== tag)\n\t\t\t\t\t{\n                        $list.each($.proxy(function(i,s)\n                        {\n                            this.utils.replaceToTag(s, tag);\n\n                        }, this));\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t    document.execCommand('insert' + cmd);\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.selection.restore();\n\n\t\t\t\t\tvar $insertedList = this.list.get();\n\t\t\t\t\tif (!$insertedList)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (!this.selection.block())\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tdocument.execCommand('formatblock', false, 'p');\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\t// clear span\n\t\t\t\t\t$insertedList.find('span').replaceWith(function()\n\t\t\t\t\t{\n\t\t\t\t\t\treturn $(this).contents();\n\t\t\t\t\t});\n\n\t\t\t\t\t// remove style\n\t\t\t\t\t$insertedList.find(this.opts.inlineTags.join(',')).each(function()\n\t\t\t\t\t{\n\t\t\t\t\t\t$(this).removeAttr('style');\n\t\t\t\t\t});\n\n\t\t\t\t\t// remove block-element list wrapper\n\t\t\t\t\tvar $listParent = $insertedList.parent();\n\t\t\t\t\tif (this.utils.isRedactorParent($listParent) && $listParent[0].tagName !== 'LI' && this.utils.isBlock($listParent))\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.selection.save();\n\n\t\t\t\t\t\t$listParent.replaceWith($listParent.contents());\n\n\t\t\t\t\t\tthis.selection.restore();\n\t\t\t\t\t}\n\n\t\t\t\t},\n\t\t\t\tget: function()\n\t\t\t\t{\n\t\t\t\t\tvar current = this.selection.current();\n\t\t\t\t\tvar $list = $(current).closest('ul, ol', this.core.editor()[0]);\n\n\t\t\t\t\treturn ($list.length === 0) ? false : $list;\n\t\t\t\t},\n\t\t\t\tcombineAfterAndBefore: function(block)\n\t\t\t\t{\n    \t\t\t\tvar $prev = $(block).prev();\n    \t\t\t\tvar $next = $(block).next();\n                    var isEmptyBlock = (block && block.tagName === 'P' && (block.innerHTML === '<br>' || block.innerHTML === ''));\n                    var isBlockWrapped = ($prev.closest('ol, ul', this.core.editor()[0]).length === 1 && $next.closest('ol, ul', this.core.editor()[0]).length === 1);\n\n                    if (isEmptyBlock && isBlockWrapped)\n                    {\n                        $prev.children('li').last().append(this.marker.get());\n                        $prev.append($next.contents());\n                        this.selection.restore();\n\n                        return true;\n                    }\n\n                    return false;\n\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =marker\n\t\tmarker: function()\n\t\t{\n\t\t\treturn {\n\n\t\t\t\t// public\n\t\t\t\tget: function(num)\n\t\t\t\t{\n\t\t\t\t\tnum = (typeof num === 'undefined') ? 1 : num;\n\n\t\t\t\t\tvar marker = document.createElement('span');\n\n\t\t\t\t\tmarker.id = 'selection-marker-' + num;\n\t\t\t\t\tmarker.className = 'redactor-selection-marker';\n\t\t\t\t\tmarker.innerHTML = this.opts.invisibleSpace;\n\n\t\t\t\t\treturn marker;\n\t\t\t\t},\n\t\t\t\thtml: function(num)\n\t\t\t\t{\n\t\t\t\t\treturn this.utils.getOuterHtml(this.marker.get(num));\n\t\t\t\t},\n\t\t\t\tfind: function(num)\n\t\t\t\t{\n\t\t\t\t\tnum = (typeof num === 'undefined') ? 1 : num;\n\n\t\t\t\t\treturn this.core.editor().find('span#selection-marker-' + num);\n\t\t\t\t},\n\t\t\t\tinsert: function()\n\t\t\t\t{\n\t\t\t\t\tvar sel = this.selection.get();\n\t\t\t\t\tvar range = this.selection.range(sel);\n\n\t\t\t\t\tthis.marker.insertNode(range, this.marker.get(1), true);\n\t\t\t\t\tif (range && range.collapsed === false)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.marker.insertNode(range, this.marker.get(2), false);\n\t\t\t\t\t}\n\n\t\t\t\t},\n\t\t\t\tremove: function()\n\t\t\t\t{\n\t\t\t\t\tthis.core.editor().find('.redactor-selection-marker').each(this.marker.iterateRemove);\n\t\t\t\t},\n\n\t\t\t\t// private\n\t\t\t\tinsertNode: function(range, node, collapse)\n\t\t\t\t{\n\t\t\t\t\tvar parent = this.selection.parent();\n\t\t\t\t\tif (range === null || $(parent).closest('.redactor-in').length === 0)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\trange = range.cloneRange();\n\n\t\t\t\t\ttry {\n\t\t\t\t\t\trange.collapse(collapse);\n\t\t\t\t\t\trange.insertNode(node);\n\t\t\t\t\t}\n\t\t\t\t\tcatch (e)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.focus.start();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\titerateRemove: function(i, el)\n\t\t\t\t{\n\t\t\t\t\tvar $el = $(el);\n\t\t\t\t\tvar text = $el.text().replace(/\\u200B/g, '');\n\n\t\t\t\t\treturn (text === '') ? $el.remove() : $el.replaceWith(function() { return $(this).contents(); });\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =modal\n\t\tmodal: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tcallbacks: {},\n\t\t\t\ttemplates: function()\n\t\t\t\t{\n\t\t\t\t\tthis.opts.modal = {\n\t\t\t\t\t\t'image-edit': String()\n\t\t\t\t\t\t+ '<div class=\"redactor-modal-tab redactor-group\" data-title=\"General\">'\n\t\t\t\t\t\t\t+ '<div id=\"redactor-image-preview\" class=\"redactor-modal-tab-side\">'\n\t\t\t\t\t\t\t+ '</div>'\n\t\t\t\t\t\t\t+ '<div class=\"redactor-modal-tab-area\">'\n\t\t\t\t\t\t\t\t+ '<section>'\n\t\t\t\t\t\t\t\t\t+ '<label>' + this.lang.get('title') + '</label>'\n\t\t\t\t\t\t\t\t\t+ '<input type=\"text\" id=\"redactor-image-title\" />'\n\t\t\t\t\t\t\t\t+ '</section>'\n\t\t\t\t\t\t\t\t+ '<section>'\n\t\t\t\t\t\t\t\t\t+ '<label>' + this.lang.get('caption') + '</label>'\n\t\t\t\t\t\t\t\t\t+ '<input type=\"text\" id=\"redactor-image-caption\" aria-label=\"' + this.lang.get('caption') + '\" />'\n\t\t\t\t\t\t\t\t+ '</section>'\n\t\t\t\t\t\t\t\t+ '<section>'\n\t\t\t\t\t\t\t\t\t+ '<label>' + this.lang.get('link') + '</label>'\n\t\t\t\t\t\t\t\t\t+ '<input type=\"text\" id=\"redactor-image-link\" aria-label=\"' + this.lang.get('link') + '\" />'\n\t\t\t\t\t\t\t\t+ '</section>'\n\t\t\t\t\t\t\t\t+ '<section>'\n        \t\t\t\t\t\t\t+ '<label class=\"redactor-image-position-option\">' + this.lang.get('image-position') + '</label>'\n        \t\t\t\t\t\t\t+ '<select class=\"redactor-image-position-option\" id=\"redactor-image-align\" aria-label=\"' + this.lang.get('image-position') + '\">'\n        \t\t\t\t\t\t\t\t+ '<option value=\"none\">' + this.lang.get('none') + '</option>'\n        \t\t\t\t\t\t\t\t+ '<option value=\"left\">' + this.lang.get('left') + '</option>'\n        \t\t\t\t\t\t\t\t+ '<option value=\"center\">' + this.lang.get('center') + '</option>'\n        \t\t\t\t\t\t\t\t+ '<option value=\"right\">' + this.lang.get('right') + '</option>'\n        \t\t\t\t\t\t\t+ '</select>'\n\t\t\t\t\t\t\t\t+ '</section>'\n\t\t\t\t\t\t\t\t+ '<section>'\n\t\t\t\t\t\t\t\t\t+ '<label class=\"checkbox\"><input type=\"checkbox\" id=\"redactor-image-link-blank\" aria-label=\"' + this.lang.get('link-in-new-tab') + '\"> ' + this.lang.get('link-in-new-tab') + '</label>'\n\t\t\t\t\t\t\t\t+ '</section>'\n\t\t\t\t\t\t\t\t+ '<section>'\n\t\t\t\t\t\t\t\t\t+ '<button id=\"redactor-modal-button-action\">' + this.lang.get('insert') + '</button>'\n\t\t\t\t\t\t\t\t\t+ '<button id=\"redactor-modal-button-cancel\">' + this.lang.get('cancel') + '</button>'\n\t\t\t\t\t\t\t\t\t+ '<button id=\"redactor-modal-button-delete\" class=\"redactor-modal-button-offset\">' + this.lang.get('delete') + '</button>'\n\t\t\t\t\t\t\t\t+ '</section>'\n\t\t\t\t\t\t\t+ '</div>'\n\t\t\t\t\t\t+ '</div>',\n\n\t\t\t\t\t\t'image': String()\n\t\t\t\t\t\t+ '<div class=\"redactor-modal-tab\" data-title=\"Upload\">'\n\t\t\t\t\t\t\t+ '<section>'\n\t\t\t\t\t\t\t\t+ '<div id=\"redactor-modal-image-droparea\"></div>'\n\t \t\t\t\t\t\t+ '</section>'\n \t\t\t\t\t\t+ '</div>',\n\n\t\t\t\t\t\t'file': String()\n\t\t\t\t\t\t+ '<div class=\"redactor-modal-tab\" data-title=\"Upload\">'\n\t\t\t\t\t\t\t+ '<section>'\n\t\t\t\t\t\t\t\t+ '<label>' + this.lang.get('filename') + ' <span class=\"desc\">(' + this.lang.get('optional') + ')</span></label>'\n\t\t\t\t\t\t\t\t+ '<input type=\"text\" id=\"redactor-filename\" aria-label=\"' + this.lang.get('filename') + '\" /><br><br>'\n\t\t\t\t\t\t\t+ '</section>'\n\t\t\t\t\t\t\t+ '<section>'\n\t\t\t\t\t\t\t\t+ '<div id=\"redactor-modal-file-upload\"></div>'\n\t\t\t\t\t\t\t+ '</section>'\n\t\t\t\t\t\t+ '</div>',\n\n\t\t\t\t\t\t'link': String()\n\t\t\t\t\t\t+ '<div class=\"redactor-modal-tab\" data-title=\"General\">'\n\t\t\t\t\t\t\t+ '<section>'\n\t\t\t\t\t\t\t\t+ '<label>URL</label>'\n\t\t\t\t\t\t\t\t+ '<input type=\"url\" id=\"redactor-link-url\" aria-label=\"URL\" />'\n\t\t\t\t\t\t\t+ '</section>'\n\t\t\t\t\t\t\t+ '<section>'\n\t\t\t\t\t\t\t\t+ '<label>' + this.lang.get('text') + '</label>'\n\t\t\t\t\t\t\t\t+ '<input type=\"text\" id=\"redactor-link-url-text\" aria-label=\"' + this.lang.get('text') + '\" />'\n\t\t\t\t\t\t\t+ '</section>'\n\t\t\t\t\t\t\t+ '<section>'\n\t\t\t\t\t\t\t\t+ '<label class=\"checkbox\"><input type=\"checkbox\" id=\"redactor-link-blank\"> ' + this.lang.get('link-in-new-tab') + '</label>'\n\t\t\t\t\t\t\t+ '</section>'\n\t\t\t\t\t\t\t+ '<section>'\n\t\t\t\t\t\t\t\t+ '<button id=\"redactor-modal-button-action\">' + this.lang.get('insert') + '</button>'\n\t\t\t\t\t\t\t\t+ '<button id=\"redactor-modal-button-cancel\">' + this.lang.get('cancel') + '</button>'\n\t\t\t\t\t\t\t+ '</section>'\n\t\t\t\t\t\t+ '</div>'\n\t\t\t\t\t};\n\n\t\t\t\t\t$.extend(this.opts, this.opts.modal);\n\n\t\t\t\t},\n\t\t\t\taddCallback: function(name, callback)\n\t\t\t\t{\n\t\t\t\t\tthis.modal.callbacks[name] = callback;\n\t\t\t\t},\n\t\t\t\taddTemplate: function(name, template)\n\t\t\t\t{\n\t\t\t\t\tthis.opts.modal[name] = template;\n\t\t\t\t},\n\t\t\t\tgetTemplate: function(name)\n\t\t\t\t{\n\t\t\t\t\treturn this.opts.modal[name];\n\t\t\t\t},\n\t\t\t\tgetModal: function()\n\t\t\t\t{\n\t\t\t\t\treturn this.$modalBody;\n\t\t\t\t},\n\t\t\t\tgetActionButton: function()\n\t\t\t\t{\n\t\t\t\t\treturn this.$modalBody.find('#redactor-modal-button-action');\n\t\t\t\t},\n\t\t\t\tgetCancelButton: function()\n\t\t\t\t{\n\t\t\t\t\treturn this.$modalBody.find('#redactor-modal-button-cancel');\n\t\t\t\t},\n\t\t\t\tgetDeleteButton: function()\n\t\t\t\t{\n\t\t\t\t\treturn this.$modalBody.find('#redactor-modal-button-delete');\n\t\t\t\t},\n\t\t\t\tload: function(templateName, title, width)\n\t\t\t\t{\n\t\t\t\t\tif (typeof this.$modalBox !== 'undefined' && this.$modalBox.hasClass('open'))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.modal.templateName = templateName;\n\t\t\t\t\tthis.modal.width = width;\n\n\t\t\t\t\tthis.modal.build();\n\t\t\t\t\tthis.modal.enableEvents();\n\t\t\t\t\tthis.modal.setTitle(title);\n\t\t\t\t\tthis.modal.setDraggable();\n\t\t\t\t\tthis.modal.setContent();\n\n\t\t\t\t\t// callbacks\n\t\t\t\t\tif (typeof this.modal.callbacks[templateName] !== 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.modal.callbacks[templateName].call(this);\n\t\t\t\t\t}\n\n\t\t\t\t},\n\t\t\t\tshow: function()\n\t\t\t\t{\n\n\t\t\t\t\tif (!this.detect.isDesktop())\n\t\t\t\t\t{\n\t\t\t\t\t\tdocument.activeElement.blur();\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.selection.save();\n\t\t\t\t\tthis.modal.buildTabber();\n\n\t\t\t\t\tif (this.detect.isMobile())\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.modal.width = '96%';\n\t\t\t\t\t}\n\n\t\t\t\t\t// resize\n\t\t\t\t\tsetTimeout($.proxy(this.modal.buildWidth, this), 0);\n\t\t\t\t\t$(window).on('resize.redactor-modal', $.proxy(this.modal.buildWidth, this));\n\n\n\t\t\t\t\tthis.$modalOverlay.redactorAnimation('fadeIn', {\n\t\t\t\t\t\tduration: 0.25\n\t\t\t\t\t});\n\n\t\t\t\t\tthis.$modalBox.addClass('open').show();\n\t\t\t\t\tthis.$modal.redactorAnimation('fadeIn', {\n\t\t\t\t\t\t\ttiming: 'cubic-bezier(0.175, 0.885, 0.320, 1.105)'\n\t\t\t\t\t\t},\n\t\t\t\t\t\t$.proxy(function()\n\t\t\t\t\t\t{\n\n\t\t\t\t\t\t\tthis.utils.saveScroll();\n\t\t\t\t\t\t\tthis.utils.disableBodyScroll();\n\n\t\t\t\t\t\t\t// modal shown callback\n\t\t\t\t\t\t\tthis.core.callback('modalOpened', this.modal.templateName, this.$modal);\n\n\t\t\t\t\t\t\t// fix bootstrap modal focus\n\t\t\t\t\t\t\t$(document).off('focusin.modal');\n\n\t\t\t\t\t\t\t// enter\n\t\t\t\t\t\t\tvar $elements = this.$modal.find('input[type=text],input[type=url],input[type=email]');\n\t\t\t\t\t\t\t$elements.on('keydown.redactor-modal', $.proxy(this.modal.setEnter, this));\n\n\t\t\t\t\t\t}, this)\n\t\t\t\t\t);\n\n\t\t\t\t},\n\t\t\t\tbuildWidth: function()\n\t\t\t\t{\n\t\t\t\t\tvar windowHeight = $(window).height();\n\t\t\t\t\tvar windowWidth = $(window).width();\n\n\t\t\t\t\tvar number = (typeof this.modal.width === 'number');\n\n\t\t\t\t\tif (!number && this.modal.width.match(/%$/))\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.$modal.css({ 'width': this.modal.width, 'margin-bottom': '16px' });\n\t\t\t\t\t}\n\t\t\t\t\telse if (parseInt(this.modal.width) > windowWidth)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.$modal.css({ 'width': '96%', 'margin-bottom': '2%' });\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tif (number)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.modal.width += 'px';\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tthis.$modal.css({ 'width': this.modal.width, 'margin-bottom': '16px' });\n\t\t\t\t\t}\n\n\t\t\t\t\t// margin top\n\t\t\t\t\tvar height = this.$modal.outerHeight();\n\t\t\t\t\tvar top = (windowHeight/2 - height/2) + 'px';\n\n\t\t\t\t\tif (this.detect.isMobile())\n\t\t\t\t\t{\n\t\t\t\t\t\ttop = '2%';\n\t\t\t\t\t}\n\t\t\t\t\telse if (height > windowHeight)\n\t\t\t\t\t{\n\t\t\t\t\t\ttop = '16px';\n\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.$modal.css('margin-top', top);\n\t\t\t\t},\n\t\t\t\tbuildTabber: function()\n\t\t\t\t{\n\t\t\t\t\tthis.modal.tabs = this.$modal.find('.redactor-modal-tab');\n\n\t\t\t\t\tif (this.modal.tabs.length < 2)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.modal.$tabsBox = $('<div id=\"redactor-modal-tabber\" />');\n\t\t\t\t\t$.each(this.modal.tabs, $.proxy(function(i,s)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar a = $('<a href=\"#\" rel=\"' + i + '\" />').text($(s).attr('data-title'));\n\n\t\t\t\t\t\ta.on('click', $.proxy(this.modal.showTab, this));\n\n\t\t\t\t\t\tif (i === 0)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ta.addClass('active');\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tthis.modal.$tabsBox.append(a);\n\n\t\t\t\t\t}, this));\n\n\t\t\t\t\tthis.$modalBody.prepend(this.modal.$tabsBox);\n\n\t\t\t\t},\n\t\t\t\tshowTab: function(e)\n\t\t\t\t{\n\t\t\t\t\te.preventDefault();\n\n\t\t\t\t\tvar $el = $(e.target);\n\t\t\t\t\tvar index = $el.attr('rel');\n\n\t\t\t\t\tthis.modal.tabs.hide();\n\t\t\t\t\tthis.modal.tabs.eq(index).show();\n\n\t\t\t\t\t$('#redactor-modal-tabber').find('a').removeClass('active');\n\t\t\t\t\t$el.addClass('active');\n\n\t\t\t\t\treturn false;\n\n\t\t\t\t},\n\t\t\t\tsetTitle: function(title)\n\t\t\t\t{\n\t\t\t\t\tthis.$modalHeader.html(title);\n\t\t\t\t},\n\t\t\t\tsetContent: function()\n\t\t\t\t{\n\t\t\t\t\tthis.$modalBody.html(this.modal.getTemplate(this.modal.templateName));\n\n\t\t\t\t\tthis.modal.getCancelButton().on('mousedown', $.proxy(this.modal.close, this));\n\t\t\t\t},\n\t\t\t\tsetDraggable: function()\n\t\t\t\t{\n\t\t\t\t\tif (typeof $.fn.draggable === 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.$modal.draggable({ handle: this.$modalHeader });\n\t\t\t\t\tthis.$modalHeader.css('cursor', 'move');\n\t\t\t\t},\n\t\t\t\tsetEnter: function(e)\n\t\t\t\t{\n\t\t\t\t\tif (e.which !== 13)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\te.preventDefault();\n\t\t\t\t\tthis.modal.getActionButton().click();\n\t\t\t\t},\n\t\t\t\tbuild: function()\n\t\t\t\t{\n\t\t\t\t\tthis.modal.buildOverlay();\n\n\t\t\t\t\tthis.$modalBox = $('<div id=\"redactor-modal-box\"/>').hide();\n\t\t\t\t\tthis.$modal = $('<div id=\"redactor-modal\" role=\"dialog\" />');\n\t\t\t\t\tthis.$modalHeader = $('<div id=\"redactor-modal-header\" />');\n\t\t\t\t\tthis.$modalClose = $('<button type=\"button\" id=\"redactor-modal-close\" aria-label=\"' + this.lang.get('close') + '\" />').html('&times;');\n\t\t\t\t\tthis.$modalBody = $('<div id=\"redactor-modal-body\" />');\n\n\t\t\t\t\tthis.$modal.append(this.$modalHeader);\n\t\t\t\t\tthis.$modal.append(this.$modalBody);\n\t\t\t\t\tthis.$modal.append(this.$modalClose);\n\t\t\t\t\tthis.$modalBox.append(this.$modal);\n\t\t\t\t\tthis.$modalBox.appendTo(document.body);\n\n\t\t\t\t},\n\t\t\t\tbuildOverlay: function()\n\t\t\t\t{\n\t\t\t\t\tthis.$modalOverlay = $('<div id=\"redactor-modal-overlay\">').hide();\n\t\t\t\t\t$('body').prepend(this.$modalOverlay);\n\t\t\t\t},\n\t\t\t\tenableEvents: function()\n\t\t\t\t{\n\t\t\t\t\tthis.$modalClose.on('mousedown.redactor-modal', $.proxy(this.modal.close, this));\n\t\t\t\t\t$(document).on('keyup.redactor-modal', $.proxy(this.modal.closeHandler, this));\n\t\t\t\t\tthis.core.editor().on('keyup.redactor-modal', $.proxy(this.modal.closeHandler, this));\n\t\t\t\t\tthis.$modalBox.on('click.redactor-modal', $.proxy(this.modal.close, this));\n\t\t\t\t},\n\t\t\t\tdisableEvents: function()\n\t\t\t\t{\n\t\t\t\t\tthis.$modalClose.off('mousedown.redactor-modal');\n\t\t\t\t\t$(document).off('keyup.redactor-modal');\n\t\t\t\t\tthis.core.editor().off('keyup.redactor-modal');\n\t\t\t\t\tthis.$modalBox.off('click.redactor-modal');\n\t\t\t\t\t$(window).off('resize.redactor-modal');\n\t\t\t\t},\n\t\t\t\tcloseHandler: function(e)\n\t\t\t\t{\n\t\t\t\t\tif (e.which !== this.keyCode.ESC)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.modal.close(false);\n\t\t\t\t},\n\t\t\t\tclose: function(e)\n\t\t\t\t{\n\t\t\t\t\tif (e)\n\t\t\t\t\t{\n\t\t\t\t\t\tif ($(e.target).attr('id') !== 'redactor-modal-button-cancel' && e.target !== this.$modalClose[0] && e.target !== this.$modalBox[0])\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!this.$modalBox)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\t// restore selection\n\t\t\t\t\tthis.selection.restore();\n\n\t\t\t\t\tthis.modal.disableEvents();\n\t\t\t\t\tthis.utils.enableBodyScroll();\n\t\t\t\t\tthis.utils.restoreScroll();\n\n\t\t\t\t\tthis.$modalOverlay.redactorAnimation('fadeOut', { duration: 0.4 }, $.proxy(function()\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.$modalOverlay.remove();\n\n\t\t\t\t\t}, this));\n\n\t\t\t\t\tthis.$modal.redactorAnimation('fadeOut', {\n\n\t\t\t\t\t\tduration: 0.3,\n\t\t\t\t\t\ttiming: 'cubic-bezier(0.175, 0.885, 0.320, 1.175)'\n\n\t\t\t\t\t}, $.proxy(function()\n\t\t\t\t\t{\n\t\t\t\t\t\tif (typeof this.$modalBox !== 'undefined')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.$modalBox.remove();\n\t\t\t\t\t\t\tthis.$modalBox = undefined;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t$(document.body).css('overflow', this.modal.bodyOveflow);\n\t\t\t\t\t\tthis.core.callback('modalClosed', this.modal.templateName);\n\n\t\t\t\t\t}, this));\n\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =observe\n\t\tobserve: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tload: function()\n\t\t\t\t{\n\t\t\t\t\tif (typeof this.opts.destroyed !== 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.observe.links();\n\t\t\t\t\tthis.observe.images();\n\n\t\t\t\t},\n\t\t\t\tisCurrent: function($el, $current)\n\t\t\t\t{\n\t\t\t\t\tif (typeof $current === 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\t$current = $(this.selection.current());\n\t\t\t\t\t}\n\n\t\t\t\t\treturn $current.is($el) || $current.parents($el).length > 0;\n\t\t\t\t},\n\t\t\t\ttoolbar: function()\n\t\t\t\t{\n\t\t\t\t\tthis.observe.buttons();\n\t\t\t\t\tthis.observe.dropdowns();\n\t\t\t\t},\n\t\t\t\tbuttons: function(e, btnName)\n\t\t\t\t{\n\t\t\t\t\tvar current = this.selection.current();\n\t\t\t\t\tvar parent = this.selection.parent();\n\n\t\t\t\t\tif (e !== false)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.button.setInactiveAll();\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.button.setInactiveAll(btnName);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (e === false && btnName !== 'html')\n\t\t\t\t\t{\n\t\t\t\t\t\tif ($.inArray(btnName, this.opts.activeButtons) !== -1)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.button.toggleActive(btnName);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!this.utils.isRedactorParent(current))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\t// disable line\n\t\t\t\t\tif (this.utils.isCurrentOrParentHeader() || this.utils.isCurrentOrParent(['table', 'pre', 'blockquote', 'li']))\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.button.disable('horizontalrule');\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.button.enable('horizontalrule');\n\t\t\t\t\t}\n\n\n\t\t\t\t\t$.each(this.opts.activeButtonsStates, $.proxy(function(key, value)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar parentEl = $(parent).closest(key, this.$editor[0]);\n\t\t\t\t\t\tvar currentEl = $(current).closest(key, this.$editor[0]);\n\n\t\t\t\t\t\tif (parentEl.length !== 0 && !this.utils.isRedactorParent(parentEl))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (!this.utils.isRedactorParent(currentEl))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (parentEl.length !== 0 || currentEl.closest(key, this.$editor[0]).length !== 0)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.button.setActive(value);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}, this));\n\n\t\t\t\t},\n\t\t\t\tdropdowns: function()\n\t\t\t\t{\n    \t\t\t\tvar finded = $('<div />').html(this.selection.html()).find('a').length;\n\t\t\t\t\tvar $current = $(this.selection.current());\n\t\t\t\t\tvar isRedactor = this.utils.isRedactorParent($current);\n\n\t\t\t\t\t$.each(this.opts.observe.dropdowns, $.proxy(function(key, value)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar observe = value.observe,\n\t\t\t\t\t\t\telement = observe.element,\n\t\t\t\t\t\t\t$item   = value.item,\n\t\t\t\t\t\t\tinValues = typeof observe.in !== 'undefined' ? observe.in : false,\n\t\t\t\t\t\t\toutValues = typeof observe.out !== 'undefined' ? observe.out : false;\n\n\t\t\t\t\t\tif (($current.closest(element).length > 0 && isRedactor) || (element === 'a' && finded !== 0))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.observe.setDropdownProperties($item, inValues, outValues);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.observe.setDropdownProperties($item, outValues, inValues);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}, this));\n\t\t\t\t},\n\t\t\t\tsetDropdownProperties: function($item, addProperties, deleteProperties)\n\t\t\t\t{\n\t\t\t\t\tif (deleteProperties && typeof deleteProperties.attr !== 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.observe.setDropdownAttr($item, deleteProperties.attr, true);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (typeof addProperties.attr !== 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.observe.setDropdownAttr($item, addProperties.attr);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (typeof addProperties.title !== 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\t$item.find('span').text(addProperties.title);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tsetDropdownAttr: function($item, properties, isDelete)\n\t\t\t\t{\n\t\t\t\t\t$.each(properties, function(key, value)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (key === 'class')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tif (!isDelete)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t$item.addClass(value);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t$item.removeClass(value);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tif (!isDelete)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t$item.attr(key, value);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t$item.removeAttr(key);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t\taddDropdown: function($item, btnName, btnObject)\n\t\t\t\t{\n\t\t\t\t\tif (typeof btnObject.observe === \"undefined\")\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tbtnObject.item = $item;\n\n\t\t\t\t\tthis.opts.observe.dropdowns.push(btnObject);\n\t\t\t\t},\n\t\t\t\timages: function()\n\t\t\t\t{\n                    if (this.opts.imageEditable)\n                    {\n                        this.core.editor().addClass('redactor-editor-img-edit');\n    \t\t\t\t\tthis.core.editor().find('img').each($.proxy(function(i, img)\n    \t\t\t\t\t{\n    \t\t\t\t\t\tvar $img = $(img);\n\n    \t\t\t\t\t\t// IE fix (when we clicked on an image and then press backspace IE does goes to image's url)\n    \t\t\t\t\t\t$img.closest('a', this.$editor[0]).on('click', function(e) { e.preventDefault(); });\n\n    \t\t\t\t\t\tthis.image.setEditable($img);\n\n\n    \t\t\t\t\t}, this));\n                    }\n\t\t\t\t},\n\t\t\t\tlinks: function()\n\t\t\t\t{\n\t\t\t\t\tif (this.opts.linkTooltip)\n\t\t\t\t\t{\n    \t\t\t\t\tthis.core.editor().find('a').each($.proxy(function(i, s)\n    \t\t\t\t\t{\n        \t\t\t\t\tvar $link = $(s);\n        \t\t\t\t\tif ($link.data('cached') !== true)\n        \t\t\t\t\t{\n            \t\t\t\t\t$link.data('cached', true);\n            \t\t\t\t\t$link.on('touchstart.redactor.' + this.uuid + ' click.redactor.' + this.uuid, $.proxy(this.observe.showTooltip, this));\n        \t\t\t\t\t}\n\n    \t\t\t\t\t}, this));\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tgetTooltipPosition: function($link)\n\t\t\t\t{\n\t\t\t\t\treturn $link.offset();\n\t\t\t\t},\n\t\t\t\tshowTooltip: function(e)\n\t\t\t\t{\n\t\t\t\t\tvar $el = $(e.target);\n\n\t\t\t\t\tif ($el[0].tagName === 'IMG')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif ($el[0].tagName !== 'A')\n\t\t\t\t\t{\n\t\t\t\t\t\t$el = $el.closest('a', this.$editor[0]);\n\t\t\t\t\t}\n\n\t\t\t\t\tif ($el[0].tagName !== 'A')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar $link = $el;\n\n\t\t\t\t\tvar pos = this.observe.getTooltipPosition($link);\n\t\t\t\t\tvar tooltip = $('<span class=\"redactor-link-tooltip\"></span>');\n\n\t\t\t\t\tvar href = $link.attr('href');\n\t\t\t\t\tif (href === undefined)\n\t\t\t\t\t{\n\t\t\t\t\t\thref = '';\n\t\t\t\t\t}\n\n\t\t\t\t\tif (href.length > 24)\n\t\t\t\t\t{\n\t\t\t\t\t\thref = href.substring(0, 24) + '...';\n\t\t\t\t\t}\n\n\t\t\t\t\tvar aLink = $('<a href=\"' + $link.attr('href') + '\" target=\"_blank\" />').html(href).addClass('redactor-link-tooltip-action');\n\t\t\t\t\tvar aEdit = $('<a href=\"#\" />').html(this.lang.get('edit')).on('click', $.proxy(this.link.show, this)).addClass('redactor-link-tooltip-action');\n\t\t\t\t\tvar aUnlink = $('<a href=\"#\" />').html(this.lang.get('unlink')).on('click', $.proxy(this.link.unlink, this)).addClass('redactor-link-tooltip-action');\n\n\t\t\t\t\ttooltip.append(aLink).append(' | ').append(aEdit).append(' | ').append(aUnlink);\n\n\t\t\t\t\tvar lineHeight = parseInt($link.css('line-height'), 10);\n                    var lineClicked = Math.ceil((e.pageY - pos.top)/lineHeight);\n                    var top = pos.top + lineClicked * lineHeight;\n\n\t\t\t\t\ttooltip.css({\n\t\t\t\t\t\ttop: top + 'px',\n\t\t\t\t\t\tleft: pos.left + 'px'\n\t\t\t\t\t});\n\n\t\t\t\t\t$('.redactor-link-tooltip').remove();\n\t\t\t\t\t$('body').append(tooltip);\n\n\t\t\t\t\tthis.core.editor().on('touchstart.redactor.' + this.uuid + ' click.redactor.' + this.uuid, $.proxy(this.observe.closeTooltip, this));\n\t\t\t\t\t$(document).on('touchstart.redactor.' + this.uuid + ' click.redactor.' + this.uuid, $.proxy(this.observe.closeTooltip, this));\n\t\t\t\t},\n\t\t\t\tcloseAllTooltip: function()\n\t\t\t\t{\n\t\t\t\t\t$('.redactor-link-tooltip').remove();\n\t\t\t\t},\n\t\t\t\tcloseTooltip: function(e)\n\t\t\t\t{\n\t\t\t\t\te = e.originalEvent || e;\n\n\t\t\t\t\tvar target = e.target;\n\t\t\t\t\tvar $parent = $(target).closest('a', this.$editor[0]);\n\t\t\t\t\tif ($parent.length !== 0 && $parent[0].tagName === 'A' && target.tagName !== 'A')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\telse if ((target.tagName === 'A' && this.utils.isRedactorParent(target)) || $(target).hasClass('redactor-link-tooltip-action'))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.observe.closeAllTooltip();\n\n\t\t\t\t\tthis.core.editor().off('touchstart.redactor.' + this.uuid + ' click.redactor.' + this.uuid, $.proxy(this.observe.closeTooltip, this));\n\t\t\t\t\t$(document).off('touchstart.redactor.' + this.uuid + ' click.redactor.' + this.uuid, $.proxy(this.observe.closeTooltip, this));\n\t\t\t\t}\n\n\t\t\t};\n\t\t},\n\n\t\t// =offset\n\t\toffset: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tget: function(node)\n\t\t\t\t{\n\t\t\t\t\tvar cloned = this.offset.clone(node);\n\t\t\t\t\tif (cloned === false)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn 0;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar div = document.createElement('div');\n\t\t\t\t\tdiv.appendChild(cloned.cloneContents());\n\t\t\t\t\tdiv.innerHTML = div.innerHTML.replace(/<img(.*?[^>])>$/gi, 'i');\n\n\t\t\t        var text = $.trim($(div).text()).replace(/[\\t\\n\\r\\n]/g, '').replace(/\\u200B/g, '');\n\n\t\t\t\t\treturn text.length;\n\n\t\t\t\t},\n\t\t\t\tclone: function(node)\n\t\t\t\t{\n\t\t\t\t\tvar sel = this.selection.get();\n\t\t\t\t\tvar range = this.selection.range(sel);\n\n\t\t\t\t\tif (range === null && typeof node === 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tnode = (typeof node === 'undefined') ? this.$editor : node;\n\t\t\t\t\tif (node === false)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tnode = node[0] || node;\n\n\t\t\t\t\tvar cloned = range.cloneRange();\n\t\t\t\t\tcloned.selectNodeContents(node);\n\t\t\t\t\tcloned.setEnd(range.endContainer, range.endOffset);\n\n\t\t\t\t\treturn cloned;\n\t\t\t\t},\n\t\t\t\tset: function(start, end)\n\t\t\t\t{\n\t\t\t\t\tend = (typeof end === 'undefined') ? start : end;\n\n\t\t\t\t\tif (!this.focus.is())\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.focus.start();\n\t\t\t\t\t}\n\n\t\t\t\t\tvar sel = this.selection.get();\n\t\t\t\t\tvar range = this.selection.range(sel);\n\t\t\t\t\tvar node, offset = 0;\n\t\t\t\t\tvar walker = document.createTreeWalker(this.$editor[0], NodeFilter.SHOW_TEXT, null, null);\n\n\t\t\t\t\twhile ((node = walker.nextNode()) !== null)\n\t\t\t\t\t{\n\t\t\t\t\t\toffset += node.nodeValue.length;\n\t\t\t\t\t\tif (offset > start)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\trange.setStart(node, node.nodeValue.length + start - offset);\n\t\t\t\t\t\t\tstart = Infinity;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (offset >= end)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\trange.setEnd(node, node.nodeValue.length + end - offset);\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\trange.collapse(false);\n\t\t\t\t\tthis.selection.update(sel, range);\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =paragraphize\n\t\tparagraphize: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tload: function(html)\n\t\t\t\t{\n\t\t\t\t\tif (this.opts.paragraphize === false || this.opts.type === 'inline' || this.opts.type === 'pre')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn html;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (html === '' || html === '<p></p>')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn this.opts.emptyHtml;\n\t\t\t\t\t}\n\n\t\t\t\t\thtml = html + \"\\n\";\n\n\t\t\t\t\tthis.paragraphize.safes = [];\n\t\t\t\t\tthis.paragraphize.z = 0;\n\n\t\t\t\t\t// before\n\t\t\t\t\thtml = html.replace(/(<br\\s?\\/?>){1,}\\n?<\\/blockquote>/gi, '</blockquote>');\n\t\t\t\t\thtml = html.replace(/<\\/pre>/gi, \"</pre>\\n\\n\");\n\t\t\t\t\thtml = html.replace(/<p>\\s<br><\\/p>/gi, '<p></p>');\n\n\t\t\t\t\thtml = this.paragraphize.getSafes(html);\n\n\t\t\t\t\thtml = html.replace('<br>', \"\\n\");\n\t\t\t\t\thtml = this.paragraphize.convert(html);\n\n\t\t\t\t\thtml = this.paragraphize.clear(html);\n\t\t\t\t\thtml = this.paragraphize.restoreSafes(html);\n\n\t\t\t\t\t// after\n\t\t\t\t\thtml = html.replace(new RegExp('<br\\\\s?/?>\\n?<(' + this.opts.paragraphizeBlocks.join('|') + ')(.*?[^>])>', 'gi'), '<p><br /></p>\\n<$1$2>');\n\n\t\t\t\t\treturn $.trim(html);\n\t\t\t\t},\n\t\t\t\tgetSafes: function(html)\n\t\t\t\t{\n\t\t\t\t\tvar $div = $('<div />').append(html);\n\n\t\t\t\t\t// remove paragraphs in blockquotes\n\t\t\t\t\t$div.find('blockquote p').replaceWith(function()\n\t\t\t\t\t{\n\t\t\t\t\t\treturn $(this).append('<br />').contents();\n\t\t\t\t\t});\n\n                    $div.find(this.opts.paragraphizeBlocks.join(', ')).each($.proxy(function(i,s)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.paragraphize.z++;\n\t\t\t\t\t\tthis.paragraphize.safes[this.paragraphize.z] = s.outerHTML;\n\n\t\t\t\t\t\treturn $(s).replaceWith(\"\\n#####replace\" + this.paragraphize.z + \"#####\\n\\n\");\n\n\n\t\t\t\t\t}, this));\n\n                    // deal with redactor selection markers\n                    $div.find('span.redactor-selection-marker').each($.proxy(function(i,s)\n                    {\n                        this.paragraphize.z++;\n                        this.paragraphize.safes[this.paragraphize.z] = s.outerHTML;\n\n                        return $(s).replaceWith(\"\\n#####replace\" + this.paragraphize.z + \"#####\\n\\n\");\n                    }, this));\n\n\t\t\t\t\treturn $div.html();\n\t\t\t\t},\n\t\t\t\trestoreSafes: function(html)\n\t\t\t\t{\n\t\t\t\t\t$.each(this.paragraphize.safes, function(i,s)\n\t\t\t\t\t{\n\t\t\t\t\t\ts = (typeof s !== 'undefined') ? s.replace(/\\$/g, '&#36;') : s;\n\t\t\t\t\t\thtml = html.replace('#####replace' + i + '#####', s);\n\n\t\t\t\t\t});\n\n\t\t\t\t\treturn html;\n\t\t\t\t},\n\t\t\t\tconvert: function(html)\n\t\t\t\t{\n\t\t\t\t\thtml = html.replace(/\\r\\n/g, \"xparagraphmarkerz\");\n\t\t\t\t\thtml = html.replace(/\\n/g, \"xparagraphmarkerz\");\n\t\t\t\t\thtml = html.replace(/\\r/g, \"xparagraphmarkerz\");\n\n\t\t\t\t\tvar re1 = /\\s+/g;\n\t\t\t\t\thtml = html.replace(re1, \" \");\n\t\t\t\t\thtml = $.trim(html);\n\n\t\t\t\t\tvar re2 = /xparagraphmarkerzxparagraphmarkerz/gi;\n\t\t\t\t\thtml = html.replace(re2, \"</p><p>\");\n\n\t\t\t\t\tvar re3 = /xparagraphmarkerz/gi;\n\t\t\t\t\thtml = html.replace(re3, \"<br>\");\n\n\t\t\t\t\thtml = '<p>' + html + '</p>';\n\n\t\t\t\t\thtml = html.replace(\"<p></p>\", \"\");\n\t\t\t\t\thtml = html.replace(\"\\r\\n\\r\\n\", \"\");\n\t\t\t\t\thtml = html.replace(/<\\/p><p>/g, \"</p>\\r\\n\\r\\n<p>\");\n\t\t\t\t\thtml = html.replace(new RegExp(\"<br\\\\s?/?></p>\", \"g\"), \"</p>\");\n\t\t\t\t\thtml = html.replace(new RegExp(\"<p><br\\\\s?/?>\", \"g\"), \"<p>\");\n\t\t\t\t\thtml = html.replace(new RegExp(\"<p><br\\\\s?/?>\", \"g\"), \"<p>\");\n\t\t\t\t\thtml = html.replace(new RegExp(\"<br\\\\s?/?></p>\", \"g\"), \"</p>\");\n\t\t\t\t\thtml = html.replace(/<p>&nbsp;<\\/p>/gi, \"\");\n\t\t\t\t\thtml = html.replace(/<p>\\s?<br>&nbsp;<\\/p>/gi, '');\n\t\t\t\t\thtml = html.replace(/<p>\\s?<br>/gi, '<p>');\n\n\t\t\t\t\treturn html;\n\t\t\t\t},\n\t\t\t\tclear: function(html)\n\t\t\t\t{\n\n\t\t\t\t\thtml = html.replace(/<p>(.*?)#####replace(.*?)#####\\s?<\\/p>/gi, '<p>$1</p>#####replace$2#####');\n\t\t\t\t\thtml = html.replace(/(<br\\s?\\/?>){2,}<\\/p>/gi, '</p>');\n\n\t\t\t\t\thtml = html.replace(new RegExp('</blockquote></p>', 'gi'), '</blockquote>');\n\t\t\t\t\thtml = html.replace(new RegExp('<p></blockquote>', 'gi'), '</blockquote>');\n\t\t\t\t\thtml = html.replace(new RegExp('<p><blockquote>', 'gi'), '<blockquote>');\n\t\t\t\t\thtml = html.replace(new RegExp('<blockquote></p>', 'gi'), '<blockquote>');\n\n\t\t\t\t\thtml = html.replace(new RegExp('<p><p ', 'gi'), '<p ');\n\t\t\t\t\thtml = html.replace(new RegExp('<p><p>', 'gi'), '<p>');\n\t\t\t\t\thtml = html.replace(new RegExp('</p></p>', 'gi'), '</p>');\n\t\t\t\t\thtml = html.replace(new RegExp('<p>\\\\s?</p>', 'gi'), '');\n\t\t\t\t\thtml = html.replace(new RegExp(\"\\n</p>\", 'gi'), '</p>');\n\t\t\t\t\thtml = html.replace(new RegExp('<p>\\t?\\t?\\n?<p>', 'gi'), '<p>');\n\t\t\t\t\thtml = html.replace(new RegExp('<p>\\t*</p>', 'gi'), '');\n\n\t\t\t\t\treturn html;\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =paste\n\t\tpaste: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tinit: function(e)\n\t\t\t\t{\n\t\t\t\t\tthis.rtePaste = true;\n\t\t\t\t\tvar pre = (this.opts.type === 'pre' || this.utils.isCurrentOrParent('pre')) ? true : false;\n\n\t\t\t\t\t// clipboard event\n\t\t\t\t\tif (this.detect.isDesktop())\n\t\t\t\t\t{\n    \t\t\t\t\tif (!this.paste.pre && this.opts.clipboardImageUpload && this.opts.imageUpload && this.paste.detectClipboardUpload(e))\n    \t\t\t\t\t{\n    \t\t\t\t\t\tif (this.detect.isIe())\n    \t\t\t\t\t\t{\n    \t\t\t\t\t\t\tsetTimeout($.proxy(this.paste.clipboardUpload, this), 100);\n    \t\t\t\t\t\t}\n\n    \t\t\t\t\t\treturn;\n    \t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.utils.saveScroll();\n\t\t\t\t\tthis.selection.save();\n\t\t\t\t\tthis.paste.createPasteBox(pre);\n\n\t\t\t\t\t$(window).on('scroll.redactor-freeze', $.proxy(function()\n\t\t\t\t\t{\n\t\t\t\t\t\t$(window).scrollTop(this.saveBodyScroll);\n\n\t\t\t\t\t}, this));\n\n\t\t\t\t\tsetTimeout($.proxy(function()\n\t\t\t\t\t{\n\t\t\t\t\t\tvar html = this.paste.getPasteBoxCode(pre);\n\n\t\t\t\t\t\t// buffer\n\t\t\t\t\t\tthis.buffer.set();\n\t\t\t\t\t\tthis.selection.restore();\n\n\t\t\t\t\t\tthis.utils.restoreScroll();\n\n\t\t\t\t\t\t// paste info\n\t\t\t\t\t\tvar data = this.clean.getCurrentType(html);\n\n\t\t\t\t\t\t// clean\n\t\t\t\t\t\thtml = this.clean.onPaste(html, data);\n\n\t\t\t\t\t\t// callback\n\t\t\t\t\t\tvar returned = this.core.callback('paste', html);\n\t\t\t\t\t\thtml = (typeof returned === 'undefined') ? html : returned;\n\n\t\t\t\t\t\tthis.paste.insert(html, data);\n\t\t\t\t\t\tthis.rtePaste = false;\n\n\t\t\t\t\t\t// clean pre breaklines\n\t\t\t\t\t\tif (pre)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.clean.cleanPre();\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t$(window).off('scroll.redactor-freeze');\n\n\t\t\t\t\t}, this), 1);\n\n\t\t\t\t},\n\t\t\t\tgetPasteBoxCode: function(pre)\n\t\t\t\t{\n\t\t\t\t\tvar html = (pre) ? this.$pasteBox.val() : this.$pasteBox.html();\n\t\t\t\t\tthis.$pasteBox.remove();\n\n\t\t\t\t\treturn html;\n\t\t\t\t},\n\t\t\t\tcreatePasteBox: function(pre)\n\t\t\t\t{\n\t\t\t\t\tvar css = { position: 'fixed', width: '1px', top: 0, left: '-9999px' };\n\n\t\t\t\t\tthis.$pasteBox = (pre) ? $('<textarea>').css(css) : $('<div>').attr('contenteditable', 'true').css(css);\n\t\t\t\t\tthis.paste.appendPasteBox();\n\t\t\t\t\tthis.$pasteBox.focus();\n\t\t\t\t},\n\t\t\t\tappendPasteBox: function()\n\t\t\t\t{\n\t\t\t\t\tif (this.detect.isIe())\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.box().append(this.$pasteBox);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\t// bootstrap modal\n\t\t\t\t\t\tvar $visibleModals = $('.modal-body:visible');\n\t\t\t\t\t\tif ($visibleModals.length > 0)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$visibleModals.append(this.$pasteBox);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$('body').prepend(this.$pasteBox);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tdetectClipboardUpload: function(e)\n\t\t\t\t{\n\t\t\t\t\te = e.originalEvent || e;\n\n\t\t\t\t\tvar clipboard = e.clipboardData;\n\n\t\t\t\t\tif (this.detect.isIe())\n\t\t\t\t\t{\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.detect.isFirefox())\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\t// prevent safari fake url\n\t\t\t\t\tvar types = clipboard.types;\n\t\t\t\t\tif (types.indexOf('public.tiff') !== -1)\n\t\t\t\t\t{\n\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\n\t\t\t\t\tif (!clipboard.items || !clipboard.items.length)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar file = clipboard.items[0].getAsFile();\n\t\t\t\t\tif (file === null)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar reader = new FileReader();\n\t\t\t\t\treader.readAsDataURL(file);\n\t\t\t\t\treader.onload = $.proxy(this.paste.insertFromClipboard, this);\n\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t\tclipboardUpload: function()\n\t\t\t\t{\n\t\t\t\t\tvar imgs = this.$editor.find('img');\n\t\t\t\t\t$.each(imgs, $.proxy(function(i,s)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (s.src.search(/^data\\:image/i) === -1)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tvar formData = !!window.FormData ? new FormData() : null;\n\t\t\t\t\t\tif (!window.FormData)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tthis.buffer.set();\n\n\t\t\t\t\t\tthis.upload.direct = true;\n\t\t\t\t\t\tthis.upload.type = 'image';\n\t\t\t\t\t\tthis.upload.url = this.opts.imageUpload;\n\t\t\t\t\t\tthis.upload.callback = $.proxy(function(data)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tif (this.detect.isIe())\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t$(s).wrap($('<figure />'));\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tvar $parent = $(s).parent();\n\t\t\t\t\t\t\t\tthis.utils.replaceToTag($parent, 'figure');\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\ts.src = data.url;\n\t\t\t\t\t\t\tthis.core.callback('imageUpload', $(s), data);\n\n\t\t\t\t\t\t}, this);\n\n\t\t\t\t\t\tvar blob = this.utils.dataURItoBlob(s.src);\n\n\t\t\t\t\t\tformData.append('clipboard', 1);\n\t\t\t\t\t\tformData.append(this.opts.imageUploadParam, blob);\n\n\t\t\t\t\t\tthis.progress.show();\n\t\t\t\t\t\tthis.upload.send(formData, false);\n\t\t\t\t\t\tthis.code.sync();\n\n\t\t\t\t\t}, this));\n\t\t\t\t},\n\t\t\t\tinsertFromClipboard: function(e)\n\t\t\t\t{\n\t\t\t\t\tvar formData = !!window.FormData ? new FormData() : null;\n\t\t\t\t\tif (!window.FormData)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.buffer.set();\n\n\t\t\t\t\tthis.upload.direct = true;\n\t\t\t\t\tthis.upload.type = 'image';\n\t\t\t\t\tthis.upload.url = this.opts.imageUpload;\n\t\t\t\t\tthis.upload.callback = this.image.insert;\n\n\t\t\t\t\tvar blob = this.utils.dataURItoBlob(e.target.result);\n\n\t\t\t\t\tformData.append('clipboard', 1);\n\t\t\t\t\tformData.append(this.opts.imageUploadParam, blob);\n\n\t\t\t\t\tthis.progress.show();\n\t\t\t\t\tthis.upload.send(formData, e);\n\t\t\t\t},\n\t\t\t\tinsert: function(html, data)\n\t\t\t\t{\n\t\t\t\t\tif (data.pre)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.insert.raw(html);\n\t\t\t\t\t}\n\t\t\t\t\telse if (data.text)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.insert.text(html);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.insert.html(html, data);\n\t\t\t\t\t}\n\n\t\t\t\t\t// Firefox Clipboard Observe\n\t\t\t\t\tif (this.detect.isFirefox() && this.opts.clipboardImageUpload)\n\t\t\t\t\t{\n\t\t\t\t\t\tsetTimeout($.proxy(this.paste.clipboardUpload, this), 100);\n\t\t\t\t\t}\n\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =placeholder\n\t\tplaceholder: function()\n\t\t{\n\t\t\treturn {\n\n\t\t\t\t// public\n\t\t\t\tenable: function()\n\t\t\t\t{\n\t\t\t\t\tsetTimeout($.proxy(function()\n\t\t\t\t\t{\n\t\t\t\t\t\treturn (this.placeholder.isEditorEmpty()) ? this.placeholder.show() : this.placeholder.hide();\n\n\t\t\t\t\t}, this), 5);\n\t\t\t\t},\n\t\t\t\tshow: function()\n\t\t\t\t{\n\t\t\t\t\tthis.core.editor().addClass('redactor-placeholder');\n\t\t\t\t},\n\t\t\t\tupdate: function(text)\n\t\t\t\t{\n\t\t\t\t\tthis.opts.placeholder = text;\n\t\t\t\t\tthis.core.editor().attr('placeholder', text);\n\t\t\t\t},\n\t\t\t\thide: function()\n\t\t\t\t{\n\t\t\t\t\tthis.core.editor().removeClass('redactor-placeholder');\n\t\t\t\t},\n\t\t\t\tis: function()\n\t\t\t\t{\n\t\t\t\t\treturn this.core.editor().hasClass('redactor-placeholder');\n\t\t\t\t},\n\n\n\t\t\t\t// private\n\t\t\t\tinit: function()\n\t\t\t\t{\n\t\t\t\t\tif (!this.placeholder.enabled())\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!this.utils.isEditorRelative())\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.utils.setEditorRelative();\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.placeholder.build();\n\t\t\t\t\tthis.placeholder.buildPosition();\n\t\t\t\t\tthis.placeholder.enable();\n\t\t\t\t\tthis.placeholder.enableEvents();\n\n\t\t\t\t},\n\t\t\t\tenabled: function()\n\t\t\t\t{\n\t\t\t\t\treturn (this.opts.placeholder) ? this.core.element().attr('placeholder', this.opts.placeholder) : this.placeholder.isAttr();\n\t\t\t\t},\n\t\t\t\tenableEvents: function()\n\t\t\t\t{\n\t\t\t\t\tthis.core.editor().on('keydown.redactor-placeholder.' + this.uuid, $.proxy(this.placeholder.enable, this));\n\t\t\t\t},\n\t\t\t\tdisableEvents: function()\n\t\t\t\t{\n\t\t\t\t\tthis.core.editor().off('.redactor-placeholder.' + this.uuid);\n\t\t\t\t},\n\t\t\t\tbuild: function()\n\t\t\t\t{\n\t\t\t\t\tthis.core.editor().attr('placeholder', this.core.element().attr('placeholder'));\n\t\t\t\t},\n\t\t\t\tbuildPosition: function()\n\t\t\t\t{\n\t\t\t\t\tvar $style = $('<style />');\n\t\t\t\t\t$style.addClass('redactor-placeholder-style-tag');\n\t\t\t\t\t$style.html('#' + this.core.id() + '.redactor-placeholder::after ' + this.placeholder.getPosition());\n\n\t\t\t\t\t$('head').append($style);\n\t\t\t\t},\n\t\t\t\tgetPosition: function()\n\t\t\t\t{\n\t\t\t\t\treturn '{ top: ' + this.core.editor().css('padding-top') + '; left: ' + this.core.editor().css('padding-left') + '; }';\n\t\t\t\t},\n\t\t\t\tisEditorEmpty: function()\n\t\t\t\t{\n\t\t\t\t\tvar html = $.trim(this.core.editor().html()).replace(/[\\t\\n]/g, '');\n\t\t\t\t\tvar states = ['', '<p></p>', '<p><br></p>'];\n\n\t\t\t\t\treturn ($.inArray(html, states) !== -1);\n\t\t\t\t},\n\t\t\t\tisAttr: function()\n\t\t\t\t{\n\t\t\t\t\treturn (typeof this.core.element().attr('placeholder') !== 'undefined' && this.core.element().attr('placeholder') !== '');\n\t\t\t\t},\n\t\t\t\tdestroy: function()\n\t\t\t\t{\n\t\t\t\t\tthis.core.editor().removeAttr('placeholder');\n\n\t\t\t\t\tthis.placeholder.hide();\n\t\t\t\t\tthis.placeholder.disableEvents();\n\n\t\t\t\t\t$('.redactor-placeholder-style-tag').remove();\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =progress\n\t\tprogress: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\t$box: null,\n\t\t\t\t$bar: null,\n\t\t\t\ttarget: document.body,  // or id selector\n\n\t\t\t\t// public\n\t\t\t\tshow: function()\n\t\t\t\t{\n\t\t\t\t\tif (!this.progress.is())\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.progress.build();\n\t\t\t\t\t\tthis.progress.$box.redactorAnimation('fadeIn');\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.progress.$box.show();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\thide: function()\n\t\t\t\t{\n\t\t\t\t\tif (this.progress.is())\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.progress.$box.redactorAnimation('fadeOut', { duration: 0.35 }, $.proxy(this.progress.destroy, this));\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tupdate: function(value)\n\t\t\t\t{\n\t\t\t\t\tthis.progress.show();\n\t\t\t\t\tthis.progress.$bar.css('width', value + '%');\n\t\t\t\t},\n\t\t\t\tis: function()\n\t\t\t\t{\n\t\t\t\t\treturn (this.progress.$box === null) ? false : true;\n\t\t\t\t},\n\n\t\t\t\t// private\n\t\t\t\tbuild: function()\n\t\t\t\t{\n\t\t\t\t\tthis.progress.$bar = $('<span />');\n\t\t\t\t\tthis.progress.$box = $('<div id=\"redactor-progress\" />');\n\n\t\t\t\t\tthis.progress.$box.append(this.progress.$bar);\n\t\t\t\t\t$(this.progress.target).append(this.progress.$box);\n\t\t\t\t},\n\t\t\t\tdestroy: function()\n\t\t\t\t{\n\t\t\t\t\tif (this.progress.is())\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.progress.$box.remove();\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.progress.$box = null;\n\t\t\t\t\tthis.progress.$bar = null;\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =selection\n\t\tselection: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tget: function()\n\t\t\t\t{\n\t\t\t\t\tif (window.getSelection)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn window.getSelection();\n\t\t\t\t\t}\n\t\t\t\t\telse if (document.selection && document.selection.type !== \"Control\")\n\t\t\t\t\t{\n\t\t\t\t\t\treturn document.selection;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn null;\n\t\t\t\t},\n\t\t\t\trange: function(sel)\n\t\t\t\t{\n\t\t\t\t\tif (typeof sel === 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\tsel = this.selection.get();\n\t\t\t\t\t}\n\n\t\t\t\t\tif (sel.getRangeAt && sel.rangeCount)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn sel.getRangeAt(0);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn null;\n\t\t\t\t},\n\t\t\t\tis: function()\n\t\t\t\t{\n\t\t\t\t\treturn (this.selection.isCollapsed()) ? false : true;\n\t\t\t\t},\n\t\t\t\tisRedactor: function()\n\t\t\t\t{\n\t\t\t\t\tvar range = this.selection.range();\n\n\t\t\t\t\tif (range !== null)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar el = range.startContainer.parentNode;\n\n\t\t\t\t\t\tif ($(el).hasClass('redactor-in') || $(el).parents('.redactor-in').length !== 0)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn true;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\t\t\t\tisCollapsed: function()\n\t\t\t\t{\n\t\t\t\t\tvar sel = this.selection.get();\n\n\t\t\t\t\treturn (sel === null) ? false : sel.isCollapsed;\n\t\t\t\t},\n\t\t\t\tupdate: function(sel, range)\n\t\t\t\t{\n\t\t\t\t\tif (range === null)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tsel.removeAllRanges();\n\t\t\t\t\tsel.addRange(range);\n\t\t\t\t},\n\t\t\t\tcurrent: function()\n\t\t\t\t{\n\t\t\t\t\tvar sel = this.selection.get();\n\n\t\t\t\t\treturn (sel === null) ? false : sel.anchorNode;\n\t\t\t\t},\n\t\t\t\tparent: function()\n\t\t\t\t{\n\t\t\t\t\tvar current = this.selection.current();\n\n\t\t\t\t\treturn (current === null) ? false : current.parentNode;\n\t\t\t\t},\n\t\t\t\tblock: function(node)\n\t\t\t\t{\n\t\t\t\t\tnode = node || this.selection.current();\n\n\t\t\t\t\twhile (node)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (this.utils.isBlockTag(node.tagName))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn ($(node).hasClass('redactor-in')) ? false : node;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tnode = node.parentNode;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\t\t\t\tinline: function(node)\n\t\t\t\t{\n\t\t\t\t\tnode = node || this.selection.current();\n\n\t\t\t\t\twhile (node)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (this.utils.isInlineTag(node.tagName))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn ($(node).hasClass('redactor-in')) ? false : node;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tnode = node.parentNode;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\t\t\t\telement: function(node)\n\t\t\t\t{\n\t\t\t\t\tif (!node)\n\t\t\t\t\t{\n\t\t\t\t\t\tnode = this.selection.current();\n\t\t\t\t\t}\n\n\t\t\t\t\twhile (node)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (node.nodeType === 1)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tif ($(node).hasClass('redactor-in'))\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\treturn node;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tnode = node.parentNode;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\t\t\t\tprev: function()\n\t\t\t\t{\n\t\t\t\t\tvar current = this.selection.current();\n\n\t\t\t\t\treturn (current === null) ? false : this.selection.current().previousSibling;\n\t\t\t\t},\n\t\t\t\tnext: function()\n\t\t\t\t{\n\t\t\t\t\tvar current = this.selection.current();\n\n\t\t\t\t\treturn (current === null) ? false : this.selection.current().nextSibling;\n\t\t\t\t},\n\t\t\t\tblocks: function(tag)\n\t\t\t\t{\n\t\t\t\t\tvar blocks = [];\n\t\t\t\t\tvar nodes = this.selection.nodes(tag);\n\n\t\t\t\t\t$.each(nodes, $.proxy(function(i,node)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (this.utils.isBlock(node))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tblocks.push(node);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}, this));\n\n\t\t\t\t\tvar block = this.selection.block();\n\t\t\t\t\tif (blocks.length === 0 && block === false)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn [];\n\t\t\t\t\t}\n\t\t\t\t\telse if (blocks.length === 0 && block !== false)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn [block];\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\treturn blocks;\n\t\t\t\t\t}\n\n\t\t\t\t},\n\t\t\t\tinlines: function(tag)\n\t\t\t\t{\n\t\t\t\t\tvar inlines = [];\n\t\t\t\t\tvar nodes = this.selection.nodes(tag);\n\n\t\t\t\t\t$.each(nodes, $.proxy(function(i,node)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (this.utils.isInline(node))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tinlines.push(node);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}, this));\n\n\t\t\t\t\tvar inline = this.selection.inline();\n\t\t\t\t\tif (inlines.length === 0 && inline === false)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn [];\n\t\t\t\t\t}\n\t\t\t\t\telse if (inlines.length === 0 && inline !== false)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn [inline];\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\treturn inlines;\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tnodes: function(tag)\n\t\t\t\t{\n\t\t\t\t\tvar filter = (typeof tag === 'undefined') ? [] : (($.isArray(tag)) ? tag : [tag]);\n\n\t\t\t\t\tvar sel = this.selection.get();\n\t\t\t\t\tvar range = this.selection.range(sel);\n\t\t\t\t\tif (this.utils.isCollapsed())\n\t\t\t\t\t{\n\t\t\t\t\t\treturn [this.selection.current()];\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tvar node = range.startContainer;\n\t\t\t\t\t\tvar endNode = range.endContainer;\n\n\t\t\t\t\t\t// single node\n\t\t\t\t\t\tif (node === endNode)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn [node];\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// iterate\n\t\t\t\t\t\tvar nodes = [];\n\t\t\t\t\t\twhile (node && node !== endNode)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tnodes.push(node = this.selection.nextNode(node));\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// partially selected nodes\n\t\t\t\t\t\tnode = range.startContainer;\n\t\t\t\t\t\twhile (node && node !== range.commonAncestorContainer)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tnodes.unshift(node);\n\t\t\t\t\t\t\tnode = node.parentNode;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// remove service nodes\n\t\t\t\t\t\tvar resultNodes = [];\n\t\t\t\t\t\t$.each(nodes, function(i,s)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar tagName = (s.nodeType !== 1) ? false : s.tagName.toLowerCase();\n\t\t\t\t\t\t\tif ($(s).hasClass('redactor-script-tag, redactor-selection-marker'))\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse if (tagName && filter.length !== 0 && $.inArray(tagName, filter) === -1)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tresultNodes.push(s);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\treturn (resultNodes.length === 0) ? [] : resultNodes;\n\t\t\t\t\t}\n\n\t\t\t\t},\n\t\t\t\tnextNode: function(node)\n\t\t\t\t{\n\t\t\t\t\tif (node.hasChildNodes())\n\t\t\t\t\t{\n\t\t\t\t\t\treturn node.firstChild;\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\twhile (node && !node.nextSibling)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tnode = node.parentNode;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (!node)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn null;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn node.nextSibling;\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tsave: function()\n\t\t\t\t{\n\t\t\t\t\tthis.marker.insert();\n\t\t\t\t\tthis.savedSel = this.core.editor().html();\n\t\t\t\t},\n\t\t\t\trestore: function(removeMarkers)\n\t\t\t\t{\n                    var node1 = this.marker.find(1);\n\t\t\t\t\tvar node2 = this.marker.find(2);\n\n\t\t\t\t\tif (this.detect.isFirefox())\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.editor().focus();\n\t\t\t\t\t}\n\n\t\t\t\t\tif (node1.length !== 0 && node2.length !== 0)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.caret.set(node1, node2);\n\t\t\t\t\t}\n\t\t\t\t\telse if (node1.length !== 0)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.caret.start(node1);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.editor().focus();\n\t\t\t\t\t}\n\n\t\t\t\t\tif (removeMarkers !== false)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.marker.remove();\n\t\t\t\t\t\tthis.savedSel = false;\n\t\t\t\t\t}\n\n\t\t\t\t},\n\t\t\t\tnode: function(node)\n\t\t\t\t{\n\t\t\t\t\t$(node).prepend(this.marker.get(1));\n\t\t\t\t\t$(node).append(this.marker.get(2));\n\n\t\t\t\t\tthis.selection.restore();\n\t\t\t\t},\n\t\t\t\tall: function()\n\t\t\t\t{\n\t\t\t\t\tthis.core.editor().focus();\n\n\t\t\t\t\tvar sel = this.selection.get();\n\t\t\t\t\tvar range = this.selection.range(sel);\n\n\t\t\t\t\trange.selectNodeContents(this.core.editor()[0]);\n\n\t\t\t\t\tthis.selection.update(sel, range);\n\t\t\t\t},\n\t\t\t\tremove: function()\n\t\t\t\t{\n\t\t\t\t\tthis.selection.get().removeAllRanges();\n\t\t\t\t},\n\t\t\t\treplace: function(html)\n\t\t\t\t{\n\t\t\t\t\tthis.insert.html(html);\n\t\t\t\t},\n\t\t\t\ttext: function()\n\t\t\t\t{\n\t\t\t\t\treturn this.selection.get().toString();\n\t\t\t\t},\n\t\t\t\thtml: function()\n\t\t\t\t{\n\t\t\t\t\tvar html = '';\n\t\t\t\t\tvar sel = this.selection.get();\n\n\t\t\t\t\tif (sel.rangeCount)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar container = document.createElement('div');\n\t\t\t\t\t\tvar len = sel.rangeCount;\n\t\t\t\t\t\tfor (var i = 0; i < len; ++i)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tcontainer.appendChild(sel.getRangeAt(i).cloneContents());\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\thtml = this.clean.onGet(container.innerHTML);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn html;\n\t\t\t\t},\n\t\t\t\textractEndOfNode: function(node)\n\t\t\t\t{\n\t\t\t\t\tvar sel = this.selection.get();\n\t\t\t\t\tvar range = this.selection.range(sel);\n\n\t\t\t        var clonedRange = range.cloneRange();\n\t\t\t        clonedRange.selectNodeContents(node);\n\t\t\t        clonedRange.setStart(range.endContainer, range.endOffset);\n\n\t\t\t        return clonedRange.extractContents();\n\t\t\t\t},\n\n\t\t\t\t// #backward\n\t\t\t\tremoveMarkers: function()\n\t\t\t\t{\n\t\t\t\t\tthis.marker.remove();\n\t\t\t\t},\n\t\t\t\tmarker: function(num)\n\t\t\t\t{\n\t\t\t\t\treturn this.marker.get(num);\n\t\t\t\t},\n\t\t\t\tmarkerHtml: function(num)\n\t\t\t\t{\n\t\t\t\t\treturn this.marker.html(num);\n\t\t\t\t}\n\n\t\t\t};\n\t\t},\n\n\t\t// =shortcuts\n\t\tshortcuts: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\t// based on https://github.com/jeresig/jquery.hotkeys\n\t\t\t\thotkeysSpecialKeys: {\n\t\t\t\t\t8: \"backspace\", 9: \"tab\", 10: \"return\", 13: \"return\", 16: \"shift\", 17: \"ctrl\", 18: \"alt\", 19: \"pause\",\n\t\t\t\t\t20: \"capslock\", 27: \"esc\", 32: \"space\", 33: \"pageup\", 34: \"pagedown\", 35: \"end\", 36: \"home\",\n\t\t\t\t\t37: \"left\", 38: \"up\", 39: \"right\", 40: \"down\", 45: \"insert\", 46: \"del\", 59: \";\", 61: \"=\",\n\t\t\t\t\t96: \"0\", 97: \"1\", 98: \"2\", 99: \"3\", 100: \"4\", 101: \"5\", 102: \"6\", 103: \"7\",\n\t\t\t\t\t104: \"8\", 105: \"9\", 106: \"*\", 107: \"+\", 109: \"-\", 110: \".\", 111 : \"/\",\n\t\t\t\t\t112: \"f1\", 113: \"f2\", 114: \"f3\", 115: \"f4\", 116: \"f5\", 117: \"f6\", 118: \"f7\", 119: \"f8\",\n\t\t\t\t\t120: \"f9\", 121: \"f10\", 122: \"f11\", 123: \"f12\", 144: \"numlock\", 145: \"scroll\", 173: \"-\", 186: \";\", 187: \"=\",\n\t\t\t\t\t188: \",\", 189: \"-\", 190: \".\", 191: \"/\", 192: \"`\", 219: \"[\", 220: \"\\\\\", 221: \"]\", 222: \"'\"\n\t\t\t\t},\n\t\t\t\thotkeysShiftNums: {\n\t\t\t\t\t\"`\": \"~\", \"1\": \"!\", \"2\": \"@\", \"3\": \"#\", \"4\": \"$\", \"5\": \"%\", \"6\": \"^\", \"7\": \"&\",\n\t\t\t\t\t\"8\": \"*\", \"9\": \"(\", \"0\": \")\", \"-\": \"_\", \"=\": \"+\", \";\": \": \", \"'\": \"\\\"\", \",\": \"<\",\n\t\t\t\t\t\".\": \">\",  \"/\": \"?\",  \"\\\\\": \"|\"\n\t\t\t\t},\n\t\t\t\tinit: function(e, key)\n\t\t\t\t{\n\t\t\t\t\t// disable browser's hot keys for bold and italic if shortcuts off\n\t\t\t\t\tif (this.opts.shortcuts === false)\n\t\t\t\t\t{\n\t\t\t\t\t\tif ((e.ctrlKey || e.metaKey) && (key === 66 || key === 73))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\t// build\n\t\t\t\t\t\t$.each(this.opts.shortcuts, $.proxy(function(str, command)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.shortcuts.build(e, str, command);\n\n\t\t\t\t\t\t}, this));\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tbuild: function(e, str, command)\n\t\t\t\t{\n\t\t\t\t\tvar handler = $.proxy(function()\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.shortcuts.buildHandler(command);\n\n\t\t\t\t\t}, this);\n\n\t\t\t\t\tvar keys = str.split(',');\n\t\t\t\t\tvar len = keys.length;\n\t\t\t\t\tfor (var i = 0; i < len; i++)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (typeof keys[i] === 'string')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.shortcuts.handler(e, $.trim(keys[i]), handler);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t},\n\t\t\t\tbuildHandler: function(command)\n\t\t\t\t{\n\t\t\t\t\tvar func;\n\t\t\t\t\tif (command.func.search(/\\./) !== '-1')\n\t\t\t\t\t{\n\t\t\t\t\t\tfunc = command.func.split('.');\n\t\t\t\t\t\tif (typeof this[func[0]] !== 'undefined')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis[func[0]][func[1]].apply(this, command.params);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis[command.func].apply(this, command.params);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\thandler: function(e, keys, origHandler)\n\t\t\t\t{\n\t\t\t\t\tkeys = keys.toLowerCase().split(\" \");\n\n\t\t\t\t\tvar special = this.shortcuts.hotkeysSpecialKeys[e.keyCode];\n\t\t\t\t\tvar character = String.fromCharCode(e.which).toLowerCase();\n\t\t\t\t\tvar modif = \"\", possible = {};\n\n\t\t\t\t\t$.each([ \"alt\", \"ctrl\", \"meta\", \"shift\"], function(index, specialKey)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (e[specialKey + 'Key'] && special !== specialKey)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tmodif += specialKey + '+';\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\n\n\t\t\t\t\tif (special)\n\t\t\t\t\t{\n\t\t\t\t\t\tpossible[modif + special] = true;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (character)\n\t\t\t\t\t{\n\t\t\t\t\t\tpossible[modif + character] = true;\n\t\t\t\t\t\tpossible[modif + this.shortcuts.hotkeysShiftNums[character]] = true;\n\n\t\t\t\t\t\t// \"$\" can be triggered as \"Shift+4\" or \"Shift+$\" or just \"$\"\n\t\t\t\t\t\tif (modif === \"shift+\")\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tpossible[this.shortcuts.hotkeysShiftNums[character]] = true;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tvar len = keys.length;\n\t\t\t\t\tfor (var i = 0; i < len; i++)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (possible[keys[i]])\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\t\treturn origHandler.apply(this, arguments);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =storage\n\t\tstorage: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tdata: [],\n\t\t\t\tadd: function(data)\n\t\t\t\t{\n\t\t\t\t\t// type, node, url, id\n\t\t\t\t\tdata.status = true;\n\t\t\t\t\tdata.url = decodeURI(this.link.removeSelfHostFromUrl(data.url));\n\n\t\t\t\t\tthis.storage.data[data.url] = data;\n\t\t\t\t},\n\t\t\t\tstatus: function(url, status)\n\t\t\t\t{\n\t\t\t\t\tthis.storage.data[decodeURI(url)].status = status;\n\t\t\t\t},\n\t\t\t\tobserve: function()\n\t\t\t\t{\n\t\t\t\t\tvar _this = this;\n\n\t\t\t\t\tvar $images = this.core.editor().find('[data-image]');\n\t\t\t\t\t$images.each(function(i, s)\n\t\t\t\t\t{\n\t\t\t\t\t\t_this.storage.add({ type: 'image', node: s, url: s.src, id: $(s).attr('data-image') });\n\t\t\t\t\t});\n\n\t\t\t\t\tvar $files = this.core.editor().find('[data-file]');\n\t\t\t\t\t$files.each(function(i, s)\n\t\t\t\t\t{\n\t\t\t\t\t\t_this.storage.add({ type: 'file', node: s, url: s.href, id: $(s).attr('data-file') });\n\t\t\t\t\t});\n\n\t\t\t\t\tvar $s3 = this.core.editor().find('[data-s3]');\n\t\t\t\t\t$s3.each(function(i, s)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar url = (s.tagName === 'IMG') ? s.src : s.href;\n\t\t\t\t\t\t_this.storage.add({ type: 's3', node: s, url: url, id: $(s).attr('data-s3') });\n\t\t\t\t\t});\n\n\t\t\t\t},\n\t\t\t\tchanges: function()\n\t\t\t\t{\n\t\t\t\t\tfor (var key in this.storage.data)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar data = this.storage.data[key];\n\t\t\t\t\t\tvar attr = (data.node.tagName === 'IMG') ? 'src' : 'href';\n\t\t\t\t\t\tvar $el = this.core.editor().find('[data-' + data.type + '][' + attr + '=\"' + data.url + '\"]');\n\n\t\t\t\t\t\tif ($el.length === 0)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.storage.status(data.url, false);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.storage.status(data.url, true);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\n\t\t\t\t\treturn this.storage.data;\n\t\t\t\t}\n\n\t\t\t};\n\t\t},\n\n\t\t// =toolbar\n\t\ttoolbar: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tbuild: function()\n\t\t\t\t{\n\t\t\t\t\tthis.button.hideButtons();\n\t\t\t\t\tthis.button.hideButtonsOnMobile();\n\n\t\t\t\t\tthis.$toolbar = this.toolbar.createContainer();\n\n\t\t\t\t\tthis.toolbar.append();\n\t\t\t\t\tthis.button.$toolbar = this.$toolbar;\n\t\t\t\t\tthis.button.setFormatting();\n\t\t\t\t\tthis.button.load(this.$toolbar);\n\t\t\t\t\tthis.toolbar.setFixed();\n\n\t\t\t\t},\n\t\t\t\tcreateContainer: function()\n\t\t\t\t{\n\t\t\t\t\treturn $('<ul>').addClass('redactor-toolbar').attr({ 'id': 'redactor-toolbar-' + this.uuid, 'role': 'toolbar' });\n\t\t\t\t},\n\t\t\t\tappend: function()\n\t\t\t\t{\n\t\t\t\t\tif (this.opts.toolbarExternal)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.$toolbar.addClass('redactor-toolbar-external');\n\t\t\t\t\t\t$(this.opts.toolbarExternal).html(this.$toolbar);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tif (this.opts.type === 'textarea')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.$box.prepend(this.$toolbar);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.$element.before(this.$toolbar);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tsetFixed: function()\n\t\t\t\t{\n\t\t\t\t\tif (!this.opts.toolbarFixed || this.opts.toolbarExternal)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.opts.toolbarFixedTarget !== document)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar $el = $(this.opts.toolbarFixedTarget);\n\t\t\t\t\t\tthis.toolbarOffsetTop = ($el.length === 0) ? 0 : this.core.box().offset().top - $el.offset().top;\n\t\t\t\t\t}\n\n\t\t\t\t\t// bootstrap modal fix\n\t\t\t\t\tvar late = (this.core.box().closest('.modal-body').length !== 0) ? 1000 : 0;\n\n\t\t\t\t\tsetTimeout($.proxy(function()\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.toolbar.observeScroll(false);\n\t\t\t\t\t\tif (this.detect.isDesktop())\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$(this.opts.toolbarFixedTarget).on('scroll.redactor.' + this.uuid, $.proxy(this.toolbar.observeScroll, this));\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar self = this;\n\t\t\t\t\t\t\t$(this.opts.toolbarFixedTarget).on('scroll.redactor.' + this.uuid, function()\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tself.core.toolbar().hide();\n\t\t\t\t\t\t\t\tclearTimeout($.data(this, \"scrollCheck\" ) );\n\t\t\t\t\t\t\t\t$.data( this, \"scrollCheck\", setTimeout(function()\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tself.core.toolbar().show();\n\t\t\t\t\t\t\t\t\tself.toolbar.observeScroll();\n\t\t\t\t\t\t\t\t}, 250) );\n\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}, this), late);\n\n\t\t\t\t},\n\t\t\t\tgetBoxTop: function()\n\t\t\t\t{\n\t\t\t\t\treturn (this.opts.toolbarFixedTarget === document) ? this.core.box().offset().top : this.toolbarOffsetTop;\n\t\t\t\t},\n\t\t\t\tobserveScroll: function(start)\n\t\t\t\t{\n\t\t\t\t\t// tolerance 0 if redactor in the hidden layer\n\t\t\t\t\tvar tolerance = 0;\n\n\t\t\t\t\tif (start !== false)\n\t\t\t\t\t{\n\t\t\t\t\t\ttolerance = (this.opts.toolbarFixedTarget === document) ? 20 : 0;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar scrollTop = $(this.opts.toolbarFixedTarget).scrollTop();\n\t\t\t\t\tvar boxTop = this.toolbar.getBoxTop();\n\n                    if (scrollTop === boxTop)\n                    {\n                        return;\n                    }\n\n\t\t\t\t\tif ((scrollTop + this.opts.toolbarFixedTopOffset + tolerance) > boxTop)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.toolbar.observeScrollEnable(scrollTop, boxTop);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.toolbar.observeScrollDisable();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tobserveScrollResize: function()\n\t\t\t\t{\n\t\t\t\t\tthis.$toolbar.css({\n\n\t\t\t\t\t\twidth: this.core.box().innerWidth(),\n\t\t\t\t\t\tleft: this.core.box().offset().left\n\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t\tobserveScrollEnable: function(scrollTop, boxTop)\n\t\t\t\t{\n\t\t\t\t\tif (typeof this.fullscreen !== 'undefined' && this.fullscreen.isOpened === false)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.toolbar.observeScrollDisable();\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar end = boxTop + this.core.box().outerHeight() - 32;\n\t\t\t\t\tvar width = this.core.box().innerWidth();\n\n\t\t\t\t\tvar position = (this.detect.isDesktop()) ? 'fixed' : 'absolute';\n\t\t\t\t\tvar top = (this.detect.isDesktop()) ? this.opts.toolbarFixedTopOffset : ($(this.opts.toolbarFixedTarget).scrollTop() - boxTop);\n\t\t\t\t\tvar left = (this.detect.isDesktop()) ? this.core.box().offset().left : 0;\n\n\t\t\t\t\tif (this.opts.toolbarFixedTarget !== document)\n\t\t\t\t\t{\n\t\t\t\t\t\t position = 'absolute';\n\t\t\t\t\t\t top = this.opts.toolbarFixedTopOffset + $(this.opts.toolbarFixedTarget).scrollTop() - boxTop;\n\t\t\t\t\t\t left = 0;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.$toolbar.addClass('toolbar-fixed-box');\n\n\t\t\t\t\tthis.$toolbar.css({\n\t\t\t\t\t\tposition: position,\n\t\t\t\t\t\twidth: width,\n\t\t\t\t\t\ttop: top,\n\t\t\t\t\t\tleft: left\n\t\t\t\t\t});\n\n\n\t\t\t\t\tif (scrollTop > end)\n\t\t\t\t\t{\n\t\t\t\t\t\t$('.redactor-dropdown-' + this.uuid + ':visible').hide();\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.toolbar.setDropdownsFixed();\n\n\t\t\t\t\tthis.$toolbar.css('visibility', (scrollTop < end) ? 'visible' : 'hidden');\n\t\t\t\t\t$(window).on('resize.redactor-toolbar.' + this.uuid, $.proxy(this.toolbar.observeScrollResize, this));\n\t\t\t\t},\n\t\t\t\tobserveScrollDisable: function()\n\t\t\t\t{\n\t\t\t\t\tthis.$toolbar.css({\n\t\t\t\t\t\tposition: 'relative',\n\t\t\t\t\t\twidth: 'auto',\n\t\t\t\t\t\ttop: 0,\n\t\t\t\t\t\tleft: 0,\n\t\t\t\t\t\tvisibility: 'visible'\n\t\t\t\t\t});\n\n\t\t\t\t\tthis.toolbar.unsetDropdownsFixed();\n\t\t\t\t\tthis.$toolbar.removeClass('toolbar-fixed-box');\n\t\t\t\t\t$(window).off('resize.redactor-toolbar.' + this.uuid);\n\t\t\t\t},\n\t\t\t\tsetDropdownsFixed: function()\n\t\t\t\t{\n\t\t\t\t\tvar position = (this.opts.toolbarFixedTarget === document && this.detect.isDesktop()) ? 'fixed' : 'absolute';\n\t\t\t\t\tthis.toolbar.setDropdownPosition(position);\n\t\t\t\t},\n\t\t\t\tunsetDropdownsFixed: function()\n\t\t\t\t{\n\t\t\t\t\tthis.toolbar.setDropdownPosition('absolute');\n\t\t\t\t},\n\t\t\t\tsetDropdownPosition: function(position)\n\t\t\t\t{\n\t\t\t\t\tvar self = this;\n\t\t\t\t\t$('.redactor-dropdown-' + this.uuid).each(function()\n\t\t\t\t\t{\n\t\t\t\t\t\tvar $el = $(this);\n\t\t\t\t\t\tvar $button = self.button.get($el.attr('rel'));\n\t\t\t\t\t\tvar top = (position === 'fixed') ? self.opts.toolbarFixedTopOffset : $button.offset().top;\n\n\t\t\t\t\t\t$el.css({ position: position, top: ($button.innerHeight() + top) + 'px' });\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =upload\n\t\tupload: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tinit: function(id, url, callback)\n\t\t\t\t{\n\t\t\t\t\tthis.upload.direct = false;\n\t\t\t\t\tthis.upload.callback = callback;\n\t\t\t\t\tthis.upload.url = url;\n\t\t\t\t\tthis.upload.$el = $(id);\n\t\t\t\t\tthis.upload.$droparea = $('<div id=\"redactor-droparea\" />');\n\n\t\t\t\t\tthis.upload.$placeholdler = $('<div id=\"redactor-droparea-placeholder\" />').text(this.lang.get('upload-label'));\n\t\t\t\t\tthis.upload.$input = $('<input type=\"file\" name=\"file\" />');\n\n\t\t\t\t\tthis.upload.$placeholdler.append(this.upload.$input);\n\t\t\t\t\tthis.upload.$droparea.append(this.upload.$placeholdler);\n\t\t\t\t\tthis.upload.$el.append(this.upload.$droparea);\n\n\t\t\t\t\tthis.upload.$droparea.off('redactor.upload');\n\t\t\t\t\tthis.upload.$input.off('redactor.upload');\n\n\t\t\t\t\tthis.upload.$droparea.on('dragover.redactor.upload', $.proxy(this.upload.onDrag, this));\n\t\t\t\t\tthis.upload.$droparea.on('dragleave.redactor.upload', $.proxy(this.upload.onDragLeave, this));\n\n\t\t\t\t\t// change\n\t\t\t\t\tthis.upload.$input.on('change.redactor.upload', $.proxy(function(e)\n\t\t\t\t\t{\n\t\t\t\t\t\te = e.originalEvent || e;\n\t\t\t\t\t\tthis.upload.traverseFile(this.upload.$input[0].files[0], e);\n\t\t\t\t\t}, this));\n\n\t\t\t\t\t// drop\n\t\t\t\t\tthis.upload.$droparea.on('drop.redactor.upload', $.proxy(function(e)\n\t\t\t\t\t{\n\t\t\t\t\t\te.preventDefault();\n\n\t\t\t\t\t\tthis.upload.$droparea.removeClass('drag-hover').addClass('drag-drop');\n\t\t\t\t\t\tthis.upload.onDrop(e);\n\n\t\t\t\t\t}, this));\n\t\t\t\t},\n\t\t\t\tdirectUpload: function(file, e)\n\t\t\t\t{\n\t\t\t\t\tthis.upload.direct = true;\n\t\t\t\t\tthis.upload.traverseFile(file, e);\n\t\t\t\t},\n\t\t\t\tonDrop: function(e)\n\t\t\t\t{\n\t\t\t\t\te = e.originalEvent || e;\n\t\t\t\t\tvar files = e.dataTransfer.files;\n\n\t\t\t\t\tif (this.opts.multipleImageUpload)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar len = files.length;\n\t\t\t\t\t\tfor (var i = 0; i < len; i++)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.upload.traverseFile(files[i], e);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.upload.traverseFile(files[0], e);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\ttraverseFile: function(file, e)\n\t\t\t\t{\n\t\t\t\t\tif (this.opts.s3)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.upload.setConfig(file);\n\t\t\t\t\t\tthis.uploads3.send(file, e);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar formData = !!window.FormData ? new FormData() : null;\n\t\t\t\t\tif (window.FormData)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.upload.setConfig(file);\n\n\t\t\t\t\t\tvar name = (this.upload.type === 'image') ? this.opts.imageUploadParam : this.opts.fileUploadParam;\n\t\t\t\t\t\tformData.append(name, file);\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.progress.show();\n\t\t\t\t\tthis.core.callback('uploadStart', e, formData);\n\t\t\t\t\tthis.upload.send(formData, e);\n\t\t\t\t},\n\t\t\t\tsetConfig: function(file)\n\t\t\t\t{\n\t\t\t\t\tthis.upload.getType(file);\n\n\t\t\t\t\tif (this.upload.direct)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.upload.url = (this.upload.type === 'image') ? this.opts.imageUpload : this.opts.fileUpload;\n\t\t\t\t\t\tthis.upload.callback = (this.upload.type === 'image') ? this.image.insert : this.file.insert;\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tgetType: function(file)\n\t\t\t\t{\n\t\t\t\t\tthis.upload.type = (this.opts.imageTypes.indexOf(file.type) === -1) ? 'file' : 'image';\n\n\t\t\t\t\tif (this.opts.imageUpload === null && this.opts.fileUpload !== null)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.upload.type = 'file';\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tgetHiddenFields: function(obj, fd)\n\t\t\t\t{\n\t\t\t\t\tif (obj === false || typeof obj !== 'object')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn fd;\n\t\t\t\t\t}\n\n\t\t\t\t\t$.each(obj, $.proxy(function(k, v)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (v !== null && v.toString().indexOf('#') === 0)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tv = $(v).val();\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tfd.append(k, v);\n\n\t\t\t\t\t}, this));\n\n\t\t\t\t\treturn fd;\n\n\t\t\t\t},\n\t\t\t\tsend: function(formData, e)\n\t\t\t\t{\n\t\t\t\t\t// append hidden fields\n\t\t\t\t\tif (this.upload.type === 'image')\n\t\t\t\t\t{\n\t\t\t\t\t\tformData = this.utils.appendFields(this.opts.imageUploadFields, formData);\n\t\t\t\t\t\tformData = this.utils.appendForms(this.opts.imageUploadForms, formData);\n\t\t\t\t\t\tformData = this.upload.getHiddenFields(this.upload.imageFields, formData);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tformData = this.utils.appendFields(this.opts.fileUploadFields, formData);\n\t\t\t\t\t\tformData = this.utils.appendForms(this.opts.fileUploadForms, formData);\n\t\t\t\t\t\tformData = this.upload.getHiddenFields(this.upload.fileFields, formData);\n\t\t\t\t\t}\n\n\t\t\t\t\tvar xhr = new XMLHttpRequest();\n\t\t\t\t\txhr.open('POST', this.upload.url);\n\t\t\t\t\txhr.setRequestHeader(\"X-Requested-With\", \"XMLHttpRequest\");\n\n\t\t\t\t\t// complete\n\t\t\t\t\txhr.onreadystatechange = $.proxy(function()\n\t\t\t\t\t{\n\t\t\t\t\t    if (xhr.readyState === 4)\n\t\t\t\t\t    {\n\t\t\t\t\t        var data = xhr.responseText;\n\n\t\t\t\t\t\t\tdata = data.replace(/^\\[/, '');\n\t\t\t\t\t\t\tdata = data.replace(/\\]$/, '');\n\n\t\t\t\t\t\t\tvar json;\n\t\t\t\t\t\t\ttry\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tjson = (typeof data === 'string' ? $.parseJSON(data) : data);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tcatch(err)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tjson = { error: true };\n\t\t\t\t\t\t\t}\n\n\n\t\t\t\t\t\t\tthis.progress.hide();\n\n\t\t\t\t\t\t\tif (!this.upload.direct)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tthis.upload.$droparea.removeClass('drag-drop');\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tthis.upload.callback(json, this.upload.direct, e);\n\t\t\t\t\t    }\n\t\t\t\t\t}, this);\n\n\t\t\t\t\txhr.send(formData);\n\t\t\t\t},\n\t\t\t\tonDrag: function(e)\n\t\t\t\t{\n\t\t\t\t\te.preventDefault();\n\t\t\t\t\tthis.upload.$droparea.addClass('drag-hover');\n\t\t\t\t},\n\t\t\t\tonDragLeave: function(e)\n\t\t\t\t{\n\t\t\t\t\te.preventDefault();\n\t\t\t\t\tthis.upload.$droparea.removeClass('drag-hover');\n\t\t\t\t},\n\t\t\t\tclearImageFields: function()\n\t\t\t\t{\n\t\t\t\t\tthis.upload.imageFields = {};\n\t\t\t\t},\n\t\t\t\taddImageFields: function(name, value)\n\t\t\t\t{\n\t\t\t\t\tthis.upload.imageFields[name] = value;\n\t\t\t\t},\n\t\t\t\tremoveImageFields: function(name)\n\t\t\t\t{\n\t\t\t\t\tdelete this.upload.imageFields[name];\n\t\t\t\t},\n\t\t\t\tclearFileFields: function()\n\t\t\t\t{\n\t\t\t\t\tthis.upload.fileFields = {};\n\t\t\t\t},\n\t\t\t\taddFileFields: function(name, value)\n\t\t\t\t{\n\t\t\t\t\tthis.upload.fileFields[name] = value;\n\t\t\t\t},\n\t\t\t\tremoveFileFields: function(name)\n\t\t\t\t{\n\t\t\t\t\tdelete this.upload.fileFields[name];\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =s3\n\t\tuploads3: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tsend: function(file, e)\n\t\t\t\t{\n\t\t\t\t\tthis.uploads3.executeOnSignedUrl(file, $.proxy(function(signedURL)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.uploads3.sendToS3(file, signedURL, e);\n\t\t\t\t\t}, this));\n\t\t\t\t},\n\t\t\t\texecuteOnSignedUrl: function(file, callback)\n\t\t\t\t{\n\t\t\t\t\tvar xhr = new XMLHttpRequest();\n\t\t\t\t\tvar mark = (this.opts.s3.search(/\\?/) === -1) ? '?' : '&';\n\n\t\t\t\t\txhr.open('GET', this.opts.s3 + mark + 'name=' + file.name + '&type=' + file.type, true);\n\n\t\t\t\t\t// hack to pass bytes through unprocessed.\n\t\t\t\t\tif (xhr.overrideMimeType)\n\t\t\t\t\t{\n\t\t\t\t\t\txhr.overrideMimeType('text/plain; charset=x-user-defined');\n\t\t\t\t\t}\n\n\t\t\t\t\tvar that = this;\n\t\t\t\t\txhr.onreadystatechange = function(e)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (this.readyState === 4 && this.status === 200)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthat.progress.show();\n\t\t\t\t\t\t\tcallback(decodeURIComponent(this.responseText));\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\n\t\t\t\t\txhr.send();\n\t\t\t\t},\n\t\t\t\tcreateCORSRequest: function(method, url)\n\t\t\t\t{\n\t\t\t\t\tvar xhr = new XMLHttpRequest();\n\t\t\t\t\tif (\"withCredentials\" in xhr)\n\t\t\t\t\t{\n\t\t\t\t\t\txhr.open(method, url, true);\n\t\t\t\t\t}\n\t\t\t\t\telse if (typeof XDomainRequest !== \"undefined\")\n\t\t\t\t\t{\n\t\t\t\t\t\txhr = new XDomainRequest();\n\t\t\t\t\t\txhr.open(method, url);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\txhr = null;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn xhr;\n\t\t\t\t},\n\t\t\t\tsendToS3: function(file, url, e)\n\t\t\t\t{\n\t\t\t\t\tvar xhr = this.uploads3.createCORSRequest('PUT', url);\n\t\t\t\t\tif (!xhr)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\txhr.onload = $.proxy(function()\n\t\t\t\t\t{\n\t\t\t\t\t\tvar json;\n\n\t\t\t\t\t\tthis.progress.hide();\n\n\t\t\t\t\t\tif (xhr.status !== 200)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t// error\n\t\t\t\t\t\t\tjson = { error: true };\n\t\t\t\t\t\t\tthis.upload.callback(json, this.upload.direct, xhr);\n\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tvar s3file = url.split('?');\n\n\t\t\t\t\t\tif (!s3file[0])\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t // url parsing is fail\n\t\t\t\t\t\t\t return false;\n\t\t\t\t\t\t}\n\n\n\t\t\t\t\t\tif (!this.upload.direct)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.upload.$droparea.removeClass('drag-drop');\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tjson = { url: s3file[0], id: s3file[0], s3: true };\n\t\t\t\t\t\tif (this.upload.type === 'file')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar arr = s3file[0].split('/');\n\t\t\t\t\t\t\tjson.name = arr[arr.length-1];\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tthis.upload.callback(json, this.upload.direct, e);\n\n\n\t\t\t\t\t}, this);\n\n\t\t\t\t\txhr.onerror = function() {};\n\t\t\t\t\txhr.upload.onprogress = function(e) {};\n\n\t\t\t\t\txhr.setRequestHeader('Content-Type', file.type);\n\t\t\t\t\txhr.setRequestHeader('x-amz-acl', 'public-read');\n\n\t\t\t\t\txhr.send(file);\n\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =utils\n\t\tutils: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tisEmpty: function(html)\n\t\t\t\t{\n\t\t\t\t\thtml = (typeof html === 'undefined') ? this.core.editor().html() : html;\n\n\t\t\t\t\thtml = html.replace(/[\\u200B-\\u200D\\uFEFF]/g, '');\n\t\t\t\t\thtml = html.replace(/&nbsp;/gi, '');\n\t\t\t\t\thtml = html.replace(/<\\/?br\\s?\\/?>/g, '');\n\t\t\t\t\thtml = html.replace(/\\s/g, '');\n\t\t\t\t\thtml = html.replace(/^<p>[^\\W\\w\\D\\d]*?<\\/p>$/i, '');\n\t\t\t\t\thtml = html.replace(/<iframe(.*?[^>])>$/i, 'iframe');\n\t\t\t\t\thtml = html.replace(/<source(.*?[^>])>$/i, 'source');\n\n\t\t\t\t\t// remove empty tags\n\t\t\t\t\thtml = html.replace(/<[^\\/>][^>]*><\\/[^>]+>/gi, '');\n\t\t\t\t\thtml = html.replace(/<[^\\/>][^>]*><\\/[^>]+>/gi, '');\n\n\t\t\t\t\thtml = $.trim(html);\n\n\t\t\t\t\treturn html === '';\n\t\t\t\t},\n\t\t\t\tisElement: function(obj)\n\t\t\t\t{\n\t\t\t\t\ttry {\n\t\t\t\t\t\t// Using W3 DOM2 (works for FF, Opera and Chrome)\n\t\t\t\t\t\treturn obj instanceof HTMLElement;\n\t\t\t\t\t}\n\t\t\t\t\tcatch(e)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn (typeof obj === \"object\") && (obj.nodeType === 1) && (typeof obj.style === \"object\") && (typeof obj.ownerDocument === \"object\");\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tstrpos: function(haystack, needle, offset)\n\t\t\t\t{\n\t\t\t\t\tvar i = haystack.indexOf(needle, offset);\n\t\t\t\t\treturn i >= 0 ? i : false;\n\t\t\t\t},\n\t\t\t\tdataURItoBlob: function(dataURI)\n\t\t\t\t{\n\t\t\t\t\tvar byteString;\n\t\t\t\t\tif (dataURI.split(',')[0].indexOf('base64') >= 0)\n\t\t\t\t\t{\n\t\t\t\t\t\tbyteString = atob(dataURI.split(',')[1]);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tbyteString = unescape(dataURI.split(',')[1]);\n\t\t\t\t\t}\n\n\t\t\t\t\tvar mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];\n\n\t\t\t\t\tvar ia = new Uint8Array(byteString.length);\n\t\t\t\t\tfor (var i = 0; i < byteString.length; i++)\n\t\t\t\t\t{\n\t\t\t\t\t\tia[i] = byteString.charCodeAt(i);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn new Blob([ia], { type:mimeString });\n\t\t\t\t},\n\t\t\t\tgetOuterHtml: function(el)\n\t\t\t\t{\n\t\t\t\t\treturn $('<div>').append($(el).eq(0).clone()).html();\n\t\t\t\t},\n\t\t\t\tcloneAttributes: function(from, to)\n\t\t\t\t{\n\t\t\t\t\tfrom = from[0] || from;\n\t\t\t\t\tto = $(to);\n\n\t\t\t\t\tvar attrs = from.attributes;\n\t\t\t\t\tvar len = attrs.length;\n\t\t\t\t\twhile (len--)\n\t\t\t\t\t{\n\t\t\t\t\t    var attr = attrs[len];\n\t\t\t\t\t    to.attr(attr.name, attr.value);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn to;\n\t\t\t\t},\n\t\t\t\tbreakBlockTag: function()\n\t\t\t\t{\n\t\t\t\t\tvar block = this.selection.block();\n\t\t\t\t\tif (!block)\n\t\t\t\t\t{\n    \t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar isEmpty = this.utils.isEmpty(block.innerHTML);\n\n\t\t\t\t\tvar tag = block.tagName.toLowerCase();\n\t\t\t\t\tif (tag === 'pre' || tag === 'li' || tag === 'td' || tag === 'th')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\n\t\t\t\t\tif (!isEmpty && this.utils.isStartOfElement(block))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn { $block: $(block), $next: $(block).next(), type: 'start' };\n\t\t\t\t\t}\n\t\t\t\t\telse if (!isEmpty && this.utils.isEndOfElement(block))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn { $block: $(block), $next: $(block).next(), type: 'end' };\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tvar endOfNode = this.selection.extractEndOfNode(block);\n\t\t\t\t\t\tvar $nextPart = $('<' + tag + ' />').append(endOfNode);\n\n\t\t\t\t\t\t$nextPart = this.utils.cloneAttributes(block, $nextPart);\n\t\t\t\t\t\t$(block).after($nextPart);\n\n\t\t\t\t\t\treturn { $block: $(block), $next: $nextPart, type: 'break' };\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\t// tag detection\n\t\t\t\tinBlocks: function(tags)\n\t\t\t\t{\n\t\t\t\t\ttags = ($.isArray(tags)) ? tags : [tags];\n\n\t\t\t\t\tvar blocks = this.selection.blocks();\n\t\t\t\t\tvar len = blocks.length;\n\t\t\t\t\tvar contains = false;\n\t\t\t\t\tfor (var i = 0; i < len; i++)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (blocks[i] !== false)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar tag = blocks[i].tagName.toLowerCase();\n\n\t\t\t\t\t\t\tif ($.inArray(tag, tags) !== -1)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tcontains = true;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\treturn contains;\n\n\t\t\t\t},\n\t\t\t\tinInlines: function(tags)\n\t\t\t\t{\n\t\t\t\t\ttags = ($.isArray(tags)) ? tags : [tags];\n\n\t\t\t\t\tvar inlines = this.selection.inlines();\n\t\t\t\t\tvar len = inlines.length;\n\t\t\t\t\tvar contains = false;\n\t\t\t\t\tfor (var i = 0; i < len; i++)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar tag = inlines[i].tagName.toLowerCase();\n\n\t\t\t\t\t\tif ($.inArray(tag, tags) !== -1)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tcontains = true;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\treturn contains;\n\n\t\t\t\t},\n\t\t\t\tisTag: function(current, tag)\n\t\t\t\t{\n\t\t\t\t\tvar element = $(current).closest(tag, this.core.editor()[0]);\n\t\t\t\t\tif (element.length === 1)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn element[0];\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\t\t\t\tisBlock: function(block)\n\t\t\t\t{\n\t\t\t\t\tif (block === null)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tblock = block[0] || block;\n\n\t\t\t\t\treturn block && this.utils.isBlockTag(block.tagName);\n\t\t\t\t},\n\t\t\t\tisBlockTag: function(tag)\n\t\t\t\t{\n\t\t\t\t\treturn (typeof tag === 'undefined') ? false : this.reIsBlock.test(tag);\n\t\t\t\t},\n\t\t\t\tisInline: function(inline)\n\t\t\t\t{\n\t\t\t\t\tinline = inline[0] || inline;\n\n\t\t\t\t\treturn inline && this.utils.isInlineTag(inline.tagName);\n\t\t\t\t},\n\t\t\t\tisInlineTag: function(tag)\n\t\t\t\t{\n\t\t\t\t\treturn (typeof tag === 'undefined') ? false : this.reIsInline.test(tag);\n\t\t\t\t},\n\t\t\t\t// parents detection\n\t\t\t\tisRedactorParent: function(el)\n\t\t\t\t{\n\t\t\t\t\tif (!el)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tif ($(el).parents('.redactor-in').length === 0 || $(el).hasClass('redactor-in'))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn el;\n\t\t\t\t},\n\t\t\t\tisCurrentOrParentHeader: function()\n\t\t\t\t{\n\t\t\t\t\treturn this.utils.isCurrentOrParent(['H1', 'H2', 'H3', 'H4', 'H5', 'H6']);\n\t\t\t\t},\n\t\t\t\tisCurrentOrParent: function(tagName)\n\t\t\t\t{\n\t\t\t\t\tvar parent = this.selection.parent();\n\t\t\t\t\tvar current = this.selection.current();\n\n\t\t\t\t\tif ($.isArray(tagName))\n\t\t\t\t\t{\n\t\t\t\t\t\tvar matched = 0;\n\t\t\t\t\t\t$.each(tagName, $.proxy(function(i, s)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tif (this.utils.isCurrentOrParentOne(current, parent, s))\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tmatched++;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}, this));\n\n\t\t\t\t\t\treturn (matched === 0) ? false : true;\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\treturn this.utils.isCurrentOrParentOne(current, parent, tagName);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tisCurrentOrParentOne: function(current, parent, tagName)\n\t\t\t\t{\n\t\t\t\t\ttagName = tagName.toUpperCase();\n\n\t\t\t\t\treturn parent && parent.tagName === tagName ? parent : current && current.tagName === tagName ? current : false;\n\t\t\t\t},\n\t\t\t\tisEditorRelative: function()\n\t\t\t\t{\n\t\t\t\t\tvar position = this.core.editor().css('position');\n\t\t\t\t\tvar arr = ['absolute', 'fixed', 'relative'];\n\n\t\t\t\t\treturn ($.inArray(arr, position) !== -1);\n\t\t\t\t},\n\t\t\t\tsetEditorRelative: function()\n\t\t\t\t{\n\t\t\t\t\tthis.core.editor().addClass('redactor-relative');\n\t\t\t\t},\n\t\t\t\t// scroll\n\t\t\t\tfreezeScroll: function()\n\t\t\t\t{\n\t\t\t\t\tthis.freezeScrollTop = $(document).scrollTop();\n\t\t\t\t\t$(document).scrollTop(this.freezeScrollTop);\n\t\t\t\t},\n\t\t\t\tunfreezeScroll: function()\n\t\t\t\t{\n\t\t\t\t\tif (typeof this.freezeScrollTop === 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\t$(document).scrollTop(this.freezeScrollTop);\n\t\t\t\t},\n\t\t\t\tsaveScroll: function()\n\t\t\t\t{\n\t\t\t\t\tthis.tmpScrollTop = $(document).scrollTop();\n\t\t\t\t},\n\t\t\t\trestoreScroll: function()\n\t\t\t\t{\n\t\t\t\t\tif (typeof this.tmpScrollTop === 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\t$(document).scrollTop(this.tmpScrollTop);\n\t\t\t\t},\n\t\t\t\tisStartOfElement: function(element)\n\t\t\t\t{\n\t\t\t\t\tif (typeof element === 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\telement = this.selection.block();\n\t\t\t\t\t\tif (!element)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\treturn (this.offset.get(element) === 0) ? true : false;\n\t\t\t\t},\n\t\t\t\tisEndOfElement: function(element)\n\t\t\t\t{\n\t\t\t\t\tif (typeof element === 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\telement = this.selection.block();\n\t\t\t\t\t\tif (!element)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tvar text = $.trim($(element).text()).replace(/[\\t\\n\\r\\n]/g, '').replace(/\\u200B/g, '');\n\t\t\t\t\tvar offset = this.offset.get(element);\n\n\t\t\t\t\treturn (offset === text.length) ? true : false;\n\t\t\t\t},\n\t\t\t\tremoveEmptyAttr: function(el, attr)\n\t\t\t\t{\n\t\t\t\t\tvar $el = $(el);\n\t\t\t\t\tif (typeof $el.attr(attr) === 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\n\t\t\t\t\tif ($el.attr(attr) === '')\n\t\t\t\t\t{\n\t\t\t\t\t\t$el.removeAttr(attr);\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\t\t\t\treplaceToTag: function(node, tag)\n\t\t\t\t{\n\t\t\t\t\tvar replacement;\n\t\t\t\t\t$(node).replaceWith(function()\n\t\t\t\t\t{\n\t\t\t\t\t\treplacement = $('<' + tag + ' />').append($(this).contents());\n\n\t\t\t\t\t\tfor (var i = 0; i < this.attributes.length; i++)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treplacement.attr(this.attributes[i].name, this.attributes[i].value);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn replacement;\n\t\t\t\t\t});\n\n\t\t\t\t\treturn replacement;\n\t\t\t\t},\n\t\t\t\t// select all\n\t\t\t\tisSelectAll: function()\n\t\t\t\t{\n\t\t\t\t\treturn this.selectAll;\n\t\t\t\t},\n\t\t\t\tenableSelectAll: function()\n\t\t\t\t{\n\t\t\t\t\tthis.selectAll = true;\n\t\t\t\t},\n\t\t\t\tdisableSelectAll: function()\n\t\t\t\t{\n\t\t\t\t\tthis.selectAll = false;\n\t\t\t\t},\n\t\t\t\tdisableBodyScroll: function()\n\t\t\t\t{\n\t\t\t\t\tvar $body = $('html');\n\t\t\t\t\tvar windowWidth = window.innerWidth;\n\t\t\t\t\tif (!windowWidth)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar documentElementRect = document.documentElement.getBoundingClientRect();\n\t\t\t\t\t\twindowWidth = documentElementRect.right - Math.abs(documentElementRect.left);\n\t\t\t\t\t}\n\n\t\t\t\t\tvar isOverflowing = document.body.clientWidth < windowWidth;\n\t\t\t\t\tvar scrollbarWidth = this.utils.measureScrollbar();\n\n\t\t\t\t\t$body.css('overflow', 'hidden');\n\t\t\t\t\tif (isOverflowing)\n\t\t\t\t\t{\n\t\t\t\t\t\t$body.css('padding-right', scrollbarWidth);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tmeasureScrollbar: function()\n\t\t\t\t{\n\t\t\t\t\tvar $body = $('body');\n\t\t\t\t\tvar scrollDiv = document.createElement('div');\n\t\t\t\t\tscrollDiv.className = 'redactor-scrollbar-measure';\n\n\t\t\t\t\t$body.append(scrollDiv);\n\t\t\t\t\tvar scrollbarWidth = scrollDiv.offsetWidth - scrollDiv.clientWidth;\n\t\t\t\t\t$body[0].removeChild(scrollDiv);\n\t\t\t\t\treturn scrollbarWidth;\n\t\t\t\t},\n\t\t\t\tenableBodyScroll: function()\n\t\t\t\t{\n\t\t\t\t\t$('html').css({ 'overflow': '', 'padding-right': '' });\n\t\t\t\t\t$('body').remove('redactor-scrollbar-measure');\n\t\t\t\t},\n\t\t\t\tappendFields: function(appendFields, data)\n\t\t\t\t{\n\t\t\t\t\tif (!appendFields)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn data;\n\t\t\t\t\t}\n\t\t\t\t\telse if (typeof appendFields === 'object')\n\t\t\t\t\t{\n    \t\t\t\t\t$.each(appendFields, function(k, v)\n    \t\t\t\t\t{\n    \t\t\t\t\t\tif (v !== null && v.toString().indexOf('#') === 0)\n    \t\t\t\t\t\t{\n        \t\t\t\t\t\tv = $(v).val();\n                            }\n\n    \t\t\t\t\t\tdata.append(k, v);\n\n    \t\t\t\t\t});\n\n    \t\t\t\t\treturn data;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar $fields = $(appendFields);\n\t\t\t\t\tif ($fields.length === 0)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn data;\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tvar str = '';\n\t\t\t\t\t\t$fields.each(function()\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tdata.append($(this).attr('name'), $(this).val());\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\treturn data;\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tappendForms: function(appendForms, data)\n\t\t\t\t{\n\t\t\t\t\tif (!appendForms)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn data;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar $forms = $(appendForms);\n\t\t\t\t\tif ($forms.length === 0)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn data;\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tvar formData = $forms.serializeArray();\n\n\t\t\t\t\t\t$.each(formData, function(z,f)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tdata.append(f.name, f.value);\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\treturn data;\n\t\t\t\t\t}\n\t\t\t\t},\n\n\t\t\t\t// #backward\n\t\t\t\tisCollapsed: function()\n\t\t\t\t{\n\t\t\t\t\treturn this.selection.isCollapsed();\n\t\t\t\t},\n\t\t\t\tisMobile: function()\n\t\t\t\t{\n\t\t\t\t\treturn this.detect.isMobile();\n\t\t\t\t},\n\t\t\t\tisDesktop: function()\n\t\t\t\t{\n\t\t\t\t\treturn this.detect.isDesktop();\n\t\t\t\t},\n\t\t\t\tisPad: function()\n\t\t\t\t{\n\t\t\t\t\treturn this.detect.isIpad();\n\t\t\t\t}\n\n\t\t\t};\n\t\t},\n\n\t\t// #backward\n\t\tbrowser: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\twebkit: function()\n\t\t\t\t{\n\t\t\t\t\treturn this.detect.isWebkit();\n\t\t\t\t},\n\t\t\t\tff: function()\n\t\t\t\t{\n\t\t\t\t\treturn this.detect.isFirefox();\n\t\t\t\t},\n\t\t\t\tie: function()\n\t\t\t\t{\n\t\t\t\t\treturn this.detect.isIe();\n\t\t\t\t}\n\t\t\t};\n\t\t}\n\t};\n\n\t$(window).on('load.tools.redactor', function()\n\t{\n\t\t$('[data-tools=\"redactor\"]').redactor();\n\t});\n\n\t// constructor\n\tRedactor.prototype.init.prototype = Redactor.prototype;\n\n})(jQuery);\n\n(function($)\n{\n\t$.fn.redactorAnimation = function(animation, options, callback)\n\t{\n\t\treturn this.each(function()\n\t\t{\n\t\t\tnew redactorAnimation(this, animation, options, callback);\n\t\t});\n\t};\n\n\tfunction redactorAnimation(element, animation, options, callback)\n\t{\n\t\t// default\n\t\tvar opts = {\n\t\t\tduration: 0.5,\n\t\t\titerate: 1,\n\t\t\tdelay: 0,\n\t\t\tprefix: 'redactor-',\n\t\t\ttiming: 'linear'\n\t\t};\n\n\t\tthis.animation = animation;\n\t\tthis.slide = (this.animation === 'slideDown' || this.animation === 'slideUp');\n\t\tthis.$element = $(element);\n\t\tthis.prefixes = ['', '-moz-', '-o-animation-', '-webkit-'];\n\t\tthis.queue = [];\n\n\t\t// options or callback\n\t\tif (typeof options === 'function')\n\t\t{\n\t\t\tcallback = options;\n\t\t\tthis.opts = opts;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.opts = $.extend(opts, options);\n\t\t}\n\n\t\t// slide\n\t\tif (this.slide)\n\t\t{\n\t\t\tthis.$element.height(this.$element.height());\n\t\t}\n\n\t\t// init\n\t\tthis.init(callback);\n\n\t}\n\n\tredactorAnimation.prototype = {\n\n\t\tinit: function(callback)\n\t\t{\n\t\t\tthis.queue.push(this.animation);\n\n\t\t\tthis.clean();\n\n\t\t\tif (this.animation === 'show')\n\t\t\t{\n\t\t\t\tthis.opts.timing = 'linear';\n\t\t\t\tthis.$element.removeClass('hide').show();\n\n\t\t\t\tif (typeof callback === 'function')\n\t\t\t\t{\n\t\t\t\t\tcallback(this);\n\t\t\t\t}\n\t\t\t}\n\t\t\telse if (this.animation === 'hide')\n\t\t\t{\n\t\t\t\tthis.opts.timing = 'linear';\n\t\t\t\tthis.$element.hide();\n\n\t\t\t\tif (typeof callback === 'function')\n\t\t\t\t{\n\t\t\t\t\tcallback(this);\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.animate(callback);\n\t\t\t}\n\n\t\t},\n\t\tanimate: function(callback)\n\t\t{\n\t\t\tthis.$element.addClass('animated').css('display', '').removeClass('hide');\n\t\t\tthis.$element.addClass(this.opts.prefix + this.queue[0]);\n\n\t\t\tthis.set(this.opts.duration + 's', this.opts.delay + 's', this.opts.iterate, this.opts.timing);\n\n\t\t\tvar _callback = (this.queue.length > 1) ? null : callback;\n\t\t\tthis.complete('AnimationEnd', $.proxy(function()\n\t\t\t{\n\t\t\t\tif (this.$element.hasClass(this.opts.prefix + this.queue[0]))\n\t\t\t\t{\n\t\t\t\t\tthis.clean();\n\t\t\t\t\tthis.queue.shift();\n\n\t\t\t\t\tif (this.queue.length)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.animate(callback);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t}, this), _callback);\n\t\t},\n\t\tset: function(duration, delay, iterate, timing)\n\t\t{\n\t\t\tvar len = this.prefixes.length;\n\n\t\t\twhile (len--)\n\t\t\t{\n\t\t\t\tthis.$element.css(this.prefixes[len] + 'animation-duration', duration);\n\t\t\t\tthis.$element.css(this.prefixes[len] + 'animation-delay', delay);\n\t\t\t\tthis.$element.css(this.prefixes[len] + 'animation-iteration-count', iterate);\n\t\t\t\tthis.$element.css(this.prefixes[len] + 'animation-timing-function', timing);\n\t\t\t}\n\n\t\t},\n\t\tclean: function()\n\t\t{\n\t\t\tthis.$element.removeClass('animated');\n\t\t\tthis.$element.removeClass(this.opts.prefix + this.queue[0]);\n\n\t\t\tthis.set('', '', '', '');\n\n\t\t},\n\t\tcomplete: function(type, make, callback)\n\t\t{\n\t\t\tthis.$element.one(type.toLowerCase() + ' webkit' + type + ' o' + type + ' MS' + type, $.proxy(function()\n\t\t\t{\n\t\t\t\tif (typeof make === 'function')\n\t\t\t\t{\n\t\t\t\t\tmake();\n\t\t\t\t}\n\n\t\t\t\tif (typeof callback === 'function')\n\t\t\t\t{\n\t\t\t\t\tcallback(this);\n\t\t\t\t}\n\n\t\t\t\t// hide\n\t\t\t\tvar effects = ['fadeOut', 'slideUp', 'zoomOut', 'slideOutUp', 'slideOutRight', 'slideOutLeft'];\n\t\t\t\tif ($.inArray(this.animation, effects) !== -1)\n\t\t\t\t{\n\t\t\t\t\tthis.$element.css('display', 'none');\n\t\t\t\t}\n\n\t\t\t\t// slide\n\t\t\t\tif (this.slide)\n\t\t\t\t{\n\t\t\t\t\tthis.$element.css('height', '');\n\t\t\t\t}\n\n\t\t\t}, this));\n\n\t\t}\n\t};\n\n})(jQuery);","(function($)\n{\n\t$.Redactor.prototype.codemirror = function()\n\t{\n\t\treturn {\n\t\t\tinit: function()\n\t\t\t{\n\t\t\t\tvar button = this.button.addFirst('html', 'HTML');\n\t\t\t\tthis.button.addCallback(button, this.codemirror.toggle);\n\n\t\t\t\tthis.codemirror.$textarea = $('<textarea />');\n\t\t\t\tthis.codemirror.$textarea.hide();\n\n\t\t\t\tif (this.opts.type === 'textarea')\n\t\t\t\t{\n\t\t\t\t\tthis.core.box().append(this.codemirror.$textarea);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tthis.core.box().after(this.codemirror.$textarea);\n\t\t\t\t}\n\n\t\t\t\tthis.core.element().on('destroy.callback.redactor', $.proxy(function()\n\t\t\t\t{\n\t\t\t\t\tthis.codemirror.$textarea.remove();\n\n\t\t\t\t}, this));\n\n\t\t\t\tvar settings = (typeof this.opts.codemirror !== 'undefined') ? this.opts.codemirror : { lineNumbers: true };\n\t\t\t\tthis.codemirror.editor = CodeMirror.fromTextArea(this.codemirror.$textarea[0], settings);\n\n\t\t\t\tthis.codemirror.$textarea.next('.CodeMirror').hide();\n\n\t\t\t},\n\t\t\ttoggle: function()\n\t\t\t{\n\t\t\t\treturn (this.codemirror.$textarea.hasClass('open')) ? this.codemirror.hide() : this.codemirror.show();\n\t\t\t},\n\t\t\tsetCaretOnShow: function()\n\t\t\t{\n\t\t\t\tthis.codemirror.offset = this.offset.get();\n\t\t\t\tvar scroll = $(window).scrollTop();\n\n\t\t\t\tvar\twidth = this.core.editor().innerWidth();\n\t\t\t\tvar height = this.core.editor().innerHeight();\n\n\t\t\t\t// caret position sync\n\t\t\t\tthis.codemirror.start = 0;\n\t\t\t\tthis.codemirror.end = 0;\n\t\t\t\tvar $editorDiv = $(\"<div/>\").append($.parseHTML(this.core.editor().html(), document, true));\n\t\t\t\tvar $selectionMarkers = $editorDiv.find(\".redactor-selection-marker\");\n\n\t\t\t\tif ($selectionMarkers.length > 0)\n\t\t\t\t{\n\t\t\t\t\tvar editorHtml = $editorDiv.html().replace(/&amp;/g, '&');\n\n\t\t\t\t\tif ($selectionMarkers.length === 1)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.codemirror.start = this.utils.strpos(editorHtml, $editorDiv.find(\"#selection-marker-1\").prop(\"outerHTML\"));\n\t\t\t\t\t\tthis.codemirror.end = this.codemirror.start;\n\t\t\t\t\t}\n\t\t\t\t\telse if ($selectionMarkers.length === 2)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.codemirror.start = this.utils.strpos(editorHtml, $editorDiv.find(\"#selection-marker-1\").prop(\"outerHTML\"));\n\t\t\t\t\t\tthis.codemirror.end = this.utils.strpos(editorHtml, $editorDiv.find(\"#selection-marker-2\").prop(\"outerHTML\")) - $editorDiv.find(\"#selection-marker-1\").prop(\"outerHTML\").toString().length;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t},\n\t\t\tsetCaretOnHide: function()\n\t\t\t{\n\t\t\t\tthis.codemirror.start = 0;\n\t\t\t\tthis.codemirror.end = 0;\n\n\t\t\t\tvar self = this;\n\t\t\t\tvar html = '';\n\t\t\t\tthis.codemirror.$textarea.next('.CodeMirror').each(function(i, el)\n\t\t\t\t{\n\t\t\t\t\tself.codemirror.selection = el.CodeMirror.listSelections();\n\n\t\t\t\t\tself.codemirror.start = el.CodeMirror.indexFromPos(self.codemirror.selection[0].anchor);\n\t\t\t\t\tself.codemirror.end = el.CodeMirror.indexFromPos(self.codemirror.selection[0].head);\n\n\t\t\t\t\thtml = el.CodeMirror.getValue();\n\t\t\t\t});\n\n\n\t\t\t\t// if selection starts from end\n\t\t\t\tif (this.codemirror.start > this.codemirror.end && this.codemirror.end > 0)\n\t\t\t\t{\n\t\t\t\t\tvar tempStart = this.codemirror.end;\n\t\t\t\t\tvar tempEnd = this.codemirror.start;\n\n\t\t\t\t\tthis.codemirror.start = tempStart;\n\t\t\t\t\tthis.codemirror.end = tempEnd;\n\t\t\t\t}\n\n\t\t\t\tthis.codemirror.start = this.codemirror.enlargeOffset(html, this.codemirror.start);\n\t\t\t\tthis.codemirror.end = this.codemirror.enlargeOffset(html, this.codemirror.end);\n\n\t\t\t\thtml = html.substr(0, this.codemirror.start) + this.marker.html(1)  + html.substr(this.codemirror.start);\n\n\t\t\t\tif (this.codemirror.end > this.codemirror.start)\n\t\t\t\t{\n\t\t\t\t\tvar markerLength = this.marker.html(1).toString().length;\n\n\t\t\t\t\thtml = html.substr(0, this.codemirror.end + markerLength) + this.marker.html(2) + html.substr(this.codemirror.end + markerLength);\n\t\t\t\t}\n\n\t\t\t\treturn html;\n\n\t\t\t},\n\t\t\thide: function()\n\t\t\t{\n\t\t\t\tvar code;\n\t\t\t\tthis.codemirror.$textarea.removeClass('open').next('.CodeMirror').hide();\n\t\t\t\tthis.codemirror.$textarea.next('.CodeMirror').off('.redactor-codemirror');\n\n\t\t\t\tcode = this.codemirror.setCaretOnHide(code);\n\t\t\t\tcode = this.paragraphize.load(code);\n\n\t\t\t\tthis.code.start(code);\n\t\t\t\tthis.button.enableAll();\n\t\t\t\tthis.core.editor().show().focus();\n\t\t\t\tthis.selection.restore();\n\n                this.core.callback('visual');\n\t\t\t},\n\t\t\tshow: function()\n\t\t\t{\n\t\t\t\tthis.selection.save();\n\t\t\t\tthis.codemirror.setCaretOnShow();\n\n\t\t\t\tvar height = this.core.editor().innerHeight();\n\t\t\t\tvar code = this.code.get();\n\n                // callback\n                code = this.core.callback('source', code);\n\n\t\t\t\tthis.core.editor().hide();\n\t\t\t\tthis.button.disableAll('html');\n\t\t\t\tthis.marker.remove();\n\n\t\t\t\tthis.codemirror.$textarea.val(code).height(height).addClass('open');\n\t\t\t\tthis.codemirror.$textarea.next('.CodeMirror').on('keyup.redactor-codemirror', $.proxy(function()\n\t\t\t\t{\n\t\t\t\t\tif (this.opts.type === 'textarea')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.codemirror.$textarea.next('.CodeMirror').each($.proxy(function(i, el)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.core.textarea().val(el.CodeMirror.getValue());\n\n\t\t\t\t\t\t}, this));\n\t\t\t\t\t}\n\n\t\t\t\t}, this));\n\n\t\t\t\tvar self = this;\n\t\t\t\tthis.codemirror.$textarea.next('.CodeMirror').each(function(i, el)\n\t\t\t\t{\n\t\t\t\t\t$(el).show();\n\t\t\t\t\tel.CodeMirror.setValue(code);\n\t\t\t\t\tel.CodeMirror.setSize('100%', height);\n\t\t\t\t\tel.CodeMirror.refresh();\n\n\t\t\t\t\tif (self.codemirror.start === self.codemirror.end)\n\t\t\t\t\t{\n\t\t\t\t\t\tel.CodeMirror.setCursor(el.CodeMirror.posFromIndex(self.codemirror.start).line, el.CodeMirror.posFromIndex(self.codemirror.end).ch);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tel.CodeMirror.setSelection({line: el.CodeMirror.posFromIndex(self.codemirror.start).line,\n\t\t\t\t\t\t\t\t\t\t\t\t\tch: el.CodeMirror.posFromIndex(self.codemirror.start).ch},\n\t\t\t\t\t\t\t\t\t\t\t\t  {line: el.CodeMirror.posFromIndex(self.codemirror.end).line,\n\t\t\t\t\t\t\t\t\t\t\t\t   ch:  el.CodeMirror.posFromIndex(self.codemirror.end).ch});\n\t\t\t\t\t}\n\n\t\t\t\t\tel.CodeMirror.focus();\n\t\t\t\t});\n\n\t\t\t},\n\t\t\tenlargeOffset: function(html, offset)\n\t\t\t{\n\t\t\t\tvar htmlLength = html.length;\n\t\t\t\tvar c = 0;\n\n\t\t\t\tif (html[offset] === '>')\n\t\t\t\t{\n\t\t\t\t\tc++;\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tfor(var i = offset; i <= htmlLength; i++)\n\t\t\t\t\t{\n\t\t\t\t\t\tc++;\n\n\t\t\t\t\t\tif (html[i] === '>')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (html[i] === '<' || i === htmlLength)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tc = 0;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\treturn offset + c;\n\t\t\t}\n\t\t};\n\t};\n})(jQuery);\n(function($)\n{\n\t$.Redactor.prototype.filemanager = function()\n\t{\n\t\treturn {\n\t\t\tlangs: {\n\t\t\t\ten: {\n\t\t\t\t\t\"upload\": \"Upload\",\n\t\t\t\t\t\"choose\": \"Choose\"\n\t\t\t\t}\n\t\t\t},\n\t\t\tinit: function()\n\t\t\t{\n\t\t\t\tif (!this.opts.fileManagerJson)\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthis.modal.addCallback('file', this.filemanager.load);\n\t\t\t},\n\t\t\tload: function()\n\t\t\t{\n\t\t\t\tvar $box = $('<div  style=\"overflow: auto; height: 300px; display: none;\" class=\"redactor-modal-tab\" data-title=\"Choose\">').hide();\n\t\t\t\tthis.modal.getModal().append($box);\n\n\n\t\t\t\t$.ajax({\n\t\t\t\t  dataType: \"json\",\n\t\t\t\t  cache: false,\n\t\t\t\t  url: this.opts.fileManagerJson,\n\t\t\t\t  success: $.proxy(function(data)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar ul = $('<ul id=\"redactor-modal-list\">');\n\t\t\t\t\t\t$.each(data, $.proxy(function(key, val)\n\t\t\t\t\t\t{\n\n\t\t\t\t\t\t\tvar a = $('<a href=\"#\" data-params=\"' + encodeURI(JSON.stringify(val)) + '\" class=\"redactor-file-manager-link\">' + val.title + ' <span style=\"font-size: 11px; color: #888;\">' + val.name + '</span> <span style=\"position: absolute; right: 10px; font-size: 11px; color: #888;\">(' + val.size + ')</span></a>');\n\t\t\t\t\t\t\tvar li = $('<li />');\n\n\t\t\t\t\t\t\ta.on('click', $.proxy(this.filemanager.insert, this));\n\n\t\t\t\t\t\t\tli.append(a);\n\t\t\t\t\t\t\tul.append(li);\n\n\t\t\t\t\t\t}, this));\n\n\t\t\t\t\t\t$box.append(ul);\n\n\n\t\t\t\t\t}, this)\n\t\t\t\t});\n\n\t\t\t},\n\t\t\tinsert: function(e)\n\t\t\t{\n\t\t\t\te.preventDefault();\n\n\t\t\t\tvar $el = $(e.target).closest('.redactor-file-manager-link');\n\t\t\t\tvar json = $.parseJSON(decodeURI($el.attr('data-params')));\n\n\t\t\t\tthis.file.insert(json, null);\n\t\t\t}\n\t\t};\n\t};\n})(jQuery);\n(function($)\n{\n\t$.Redactor.prototype.fullscreen = function()\n\t{\n\t\treturn {\n\t\t\tlangs: {\n\t\t\t\ten: {\n\t\t\t\t\t\"fullscreen\": \"Fullscreen\"\n\t\t\t\t}\n\t\t\t},\n\t\t\tinit: function()\n\t\t\t{\n\t\t\t\tthis.fullscreen.isOpen = false;\n\n\t\t\t\tvar button = this.button.add('fullscreen', this.lang.get('fullscreen'));\n\t\t\t\tthis.button.addCallback(button, this.fullscreen.toggle);\n\n\t\t\t\tif (this.opts.fullscreen)\n\t\t\t\t{\n\t\t\t\t\tthis.fullscreen.toggle();\n\t\t\t\t}\n\n\t\t\t},\n\t\t\tenable: function()\n\t\t\t{\n\t\t\t\tthis.fullscreen.isOpened = false;\n\t\t\t\tthis.button.setActive('fullscreen');\n\t\t\t\tthis.fullscreen.isOpen = true;\n\n\t\t\t\tif (!this.opts.fullscreen)\n\t\t\t\t{\n\t\t\t\t\tthis.selection.save();\n\t\t\t\t}\n\n\t\t\t\tif (this.opts.toolbarExternal)\n\t\t\t\t{\n\t\t\t\t\tthis.fullscreen.toolcss = {};\n\t\t\t\t\tthis.fullscreen.boxcss = {};\n\t\t\t\t\tthis.fullscreen.toolcss.width = this.$toolbar.css('width');\n\t\t\t\t\tthis.fullscreen.toolcss.top = this.$toolbar.css('top');\n\t\t\t\t\tthis.fullscreen.toolcss.position = this.$toolbar.css('position');\n\t\t\t\t\tthis.fullscreen.boxcss.top = this.$box.css('top');\n\t\t\t\t}\n\n\t\t\t\tthis.fullscreen.height = this.core.editor().height();\n\n\t\t\t\tif (this.opts.maxHeight)\n\t\t\t\t{\n\t\t\t\t\tthis.core.editor().css('max-height', '');\n\t\t\t\t}\n\n\t\t\t\tif (this.opts.minHeight)\n\t\t\t\t{\n\t\t\t\t\tthis.core.editor().css('min-height', '');\n\t\t\t\t}\n\n\t\t\t\tif (!this.$fullscreenPlaceholder)\n\t\t\t\t{\n\t\t\t\t\tthis.$fullscreenPlaceholder = $('<div/>');\n\t\t\t\t}\n\n\t\t\t\tthis.$fullscreenPlaceholder.insertAfter(this.$box);\n\n\t\t\t\tthis.core.box().appendTo(document.body);\n\t\t\t\tthis.core.box().addClass('redactor-box-fullscreen');\n\n\t\t\t\t$('body').addClass('redactor-body-fullscreen');\n\t\t\t\t$('body, html').css('overflow', 'hidden');\n\n\t\t\t\tthis.fullscreen.resize();\n\n\t\t\t\tif (!this.opts.fullscreen)\n\t\t\t\t{\n\t\t\t\t\tthis.selection.restore();\n\t\t\t\t}\n\n\t\t\t\tthis.toolbar.observeScrollDisable();\n\t\t\t\t$(window).on('resize.redactor-plugin-fullscreen', $.proxy(this.fullscreen.resize, this));\n\t\t\t\t$(document).scrollTop(0, 0);\n\n\t\t\t\tvar self = this;\n\t\t\t\tsetTimeout(function()\n\t\t\t\t{\n\t\t\t\t\tself.fullscreen.isOpened = true;\n\t\t\t\t}, 10);\n\n\t\t\t},\n\t\t\tdisable: function()\n\t\t\t{\n\t\t\t\tthis.button.setInactive('fullscreen');\n\t\t\t\tthis.fullscreen.isOpened = undefined;\n\t\t\t\tthis.fullscreen.isOpen = false;\n\t\t\t\tthis.selection.save();\n\n\t\t\t\t$(window).off('resize.redactor-plugin-fullscreen');\n\t\t\t\t$('body, html').css('overflow', '');\n\n\t\t\t\tthis.core.box().insertBefore(this.$fullscreenPlaceholder);\n\t\t\t\tthis.$fullscreenPlaceholder.remove();\n\n\t\t\t\tthis.core.box().removeClass('redactor-box-fullscreen').css({ width: 'auto', height: 'auto' });\n\t\t\t\tthis.core.box().removeClass('redactor-box-fullscreen');\n\n\t\t\t\tif (this.opts.toolbarExternal)\n\t\t\t\t{\n\t\t\t\t\tthis.core.box().css('top', this.fullscreen.boxcss.top);\n\t\t\t\t\tthis.core.toolbar().css({\n\t\t\t\t\t\t'width': this.fullscreen.toolcss.width,\n\t\t\t\t\t\t'top': this.fullscreen.toolcss.top,\n\t\t\t\t\t\t'position': this.fullscreen.toolcss.position\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tif (this.opts.minHeight)\n\t\t\t\t{\n\t\t\t\t\tthis.core.editor().css('minHeight', this.opts.minHeight);\n\t\t\t\t}\n\n\t\t\t\tif (this.opts.maxHeight)\n\t\t\t\t{\n\t\t\t\t\tthis.core.editor().css('maxHeight', this.opts.maxHeight);\n\t\t\t\t}\n\n\t\t\t\tthis.core.editor().css('height', 'auto');\n\t\t\t\tthis.selection.restore();\n\t\t\t},\n\t\t\ttoggle: function()\n\t\t\t{\n\t\t\t\treturn (this.fullscreen.isOpen) ? this.fullscreen.disable() : this.fullscreen.enable();\n\t\t\t},\n\t\t\tresize: function()\n\t\t\t{\n\t\t\t\tif (!this.fullscreen.isOpen)\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tvar toolbarHeight = this.button.toolbar().height();\n\t\t\t\tvar padding = parseInt(this.core.editor().css('padding-top')) + parseInt(this.core.editor().css('padding-bottom'));\n\t\t\t\tvar height = $(window).height() - toolbarHeight - padding;\n\n\t\t\t\tthis.core.box().width($(window).width()).height(height);\n\n\t\t\t\tif (this.opts.toolbarExternal)\n\t\t\t\t{\n\t\t\t\t\tthis.core.toolbar().css({\n\t\t\t\t\t\t'top': '0px',\n\t\t\t\t\t\t'position': 'absolute',\n\t\t\t\t\t\t'width': '100%'\n\t\t\t\t\t});\n\n\t\t\t\t\tthis.core.box().css('top', toolbarHeight + 'px');\n\t\t\t\t}\n\n\t\t\t\tthis.core.editor().height(height);\n\t\t\t}\n\t\t};\n\t};\n})(jQuery);\n(function($)\n{\n\t$.Redactor.prototype.imagemanager = function()\n\t{\n\t\treturn {\n\t\t\tlangs: {\n\t\t\t\ten: {\n\t\t\t\t\t\"upload\": \"Upload\",\n\t\t\t\t\t\"choose\": \"Choose\"\n\t\t\t\t}\n\t\t\t},\n\t\t\tinit: function()\n\t\t\t{\n\t\t\t\tif (!this.opts.imageManagerJson)\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthis.modal.addCallback('image', this.imagemanager.load);\n\t\t\t},\n\t\t\tload: function()\n\t\t\t{\n\t\t\t\tvar $box = $('<div style=\"overflow: auto; height: 300px; display: none;\" class=\"redactor-modal-tab\" data-title=\"Choose\">');\n\t\t\t\tthis.modal.getModal().append($box);\n\n\t\t\t\t$.ajax({\n\t\t\t\t\tdataType: \"json\",\n\t\t\t\t\tcache: false,\n\t\t\t\t\turl: this.opts.imageManagerJson,\n\t\t\t\t\tsuccess: $.proxy(function(data)\n\t\t\t\t\t{\n\t\t\t\t\t\t$.each(data, $.proxy(function(key, val)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t// title\n\t\t\t\t\t\t\tvar thumbtitle = '';\n\t\t\t\t\t\t\tif (typeof val.title !== 'undefined')\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tthumbtitle = val.title;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tvar img = $('<img src=\"' + val.thumb + '\"  data-params=\"' + encodeURI(JSON.stringify(val)) + '\" style=\"width: 100px; height: 75px; cursor: pointer;\" />');\n\t\t\t\t\t\t\t$box.append(img);\n\t\t\t\t\t\t\t$(img).click($.proxy(this.imagemanager.insert, this));\n\n\t\t\t\t\t\t}, this));\n\n\t\t\t\t\t}, this)\n\t\t\t\t});\n\n\n\t\t\t},\n\t\t\tinsert: function(e)\n\t\t\t{\n\t\t\t\tvar $el = $(e.target);\n\t\t\t\tvar json = $.parseJSON(decodeURI($el.attr('data-params')));\n\n\t\t\t\tthis.image.insert(json, null);\n\t\t\t}\n\t\t};\n\t};\n})(jQuery);\n/*\n\tRedactor II\n\tVersion 1.3.1\n\tUpdated: October 24, 2016\n\n\thttp://imperavi.com/redactor/\n\n\tCopyright (c) 2009-2016, Imperavi Oy.\n\tLicense: http://imperavi.com/redactor/license/\n\n\tUsage: $('#content').redactor();\n*/\n\n(function($)\n{\n\t'use strict';\n\n\tif (!Function.prototype.bind)\n\t{\n\t\tFunction.prototype.bind = function(scope)\n\t\t{\n\t\t\tvar fn = this;\n\t\t\treturn function()\n\t\t\t{\n\t\t\t\treturn fn.apply(scope);\n\t\t\t};\n\t\t};\n\t}\n\n\tvar uuid = 0;\n\n\t// Plugin\n\t$.fn.redactor = function(options)\n\t{\n\t\tvar val = [];\n\t\tvar args = Array.prototype.slice.call(arguments, 1);\n\n\t\tif (typeof options === 'string')\n\t\t{\n\t\t\tthis.each(function()\n\t\t\t{\n\t\t\t\tvar instance = $.data(this, 'redactor');\n\t\t\t\tvar func;\n\n\t\t\t\tif (options.search(/\\./) !== '-1')\n\t\t\t\t{\n\t\t\t\t\tfunc = options.split('.');\n\t\t\t\t\tif (typeof instance[func[0]] !== 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\tfunc = instance[func[0]][func[1]];\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tfunc = instance[options];\n\t\t\t\t}\n\n\t\t\t\tif (typeof instance !== 'undefined' && $.isFunction(func))\n\t\t\t\t{\n\t\t\t\t\tvar methodVal = func.apply(instance, args);\n\t\t\t\t\tif (methodVal !== undefined && methodVal !== instance)\n\t\t\t\t\t{\n\t\t\t\t\t\tval.push(methodVal);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t$.error('No such method \"' + options + '\" for Redactor');\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.each(function()\n\t\t\t{\n\t\t\t\t$.data(this, 'redactor', {});\n\t\t\t\t$.data(this, 'redactor', Redactor(this, options));\n\t\t\t});\n\t\t}\n\n\t\tif (val.length === 0)\n\t\t{\n\t\t\treturn this;\n\t\t}\n\t\telse if (val.length === 1)\n\t\t{\n\t\t\treturn val[0];\n\t\t}\n\t\telse\n\t\t{\n\t\t\treturn val;\n\t\t}\n\n\t};\n\n\t// Initialization\n\tfunction Redactor(el, options)\n\t{\n\t\treturn new Redactor.prototype.init(el, options);\n\t}\n\n\t// Options\n\t$.Redactor = Redactor;\n\t$.Redactor.VERSION = '1.3.1';\n\t$.Redactor.modules = ['air', 'autosave', 'block', 'buffer', 'build', 'button', 'caret', 'clean', 'code', 'core', 'detect', 'dropdown',\n\t\t\t\t\t\t  'events', 'file', 'focus', 'image', 'indent', 'inline', 'insert', 'keydown', 'keyup',\n\t\t\t\t\t\t  'lang', 'line', 'link', 'linkify', 'list', 'marker', 'modal', 'observe', 'offset', 'paragraphize', 'paste', 'placeholder',\n\t\t\t\t\t\t  'progress', 'selection', 'shortcuts', 'storage', 'toolbar', 'upload', 'uploads3', 'utils',\n\n\t\t\t\t\t\t  'browser' // deprecated\n\t\t\t\t\t\t  ];\n\n\t$.Redactor.settings = {};\n\t$.Redactor.opts = {\n\n\t\t// settings\n\t\tanimation: false,\n\t\tlang: 'en',\n\t\tdirection: 'ltr',\n\t\tspellcheck: true,\n\n\t\tfocus: false,\n\t\tfocusEnd: false,\n\n\t\tclickToEdit: false,\n\t\tstructure: false,\n\n\t\ttabindex: false,\n\n\t\tminHeight: false, // string\n\t\tmaxHeight: false, // string\n\n\t\tmaxWidth: false, // string\n\n\t\tplugins: false, // array\n\t\tcallbacks: {},\n\n\t\tplaceholder: false,\n\n\t\tlinkify: true,\n\t\tenterKey: true,\n\n\t\tpastePlainText: false,\n\t\tpasteImages: true,\n\t\tpasteLinks: true,\n\t\tpasteBlockTags: ['pre', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'table', 'tbody', 'thead', 'tfoot', 'th', 'tr', 'td', 'ul', 'ol', 'li', 'blockquote', 'p', 'figure', 'figcaption'],\n\t\tpasteInlineTags: ['br', 'strong', 'ins', 'code', 'del', 'span', 'samp', 'kbd', 'sup', 'sub', 'mark', 'var', 'cite', 'small', 'b', 'u', 'em', 'i'],\n\n\t\tpreClass: false, // string\n\t\tpreSpaces: 4, // or false\n\t\ttabAsSpaces: false, // true or number of spaces\n\t\ttabKey: true,\n\n\t\tautosave: false, // false or url\n\t\tautosaveName: false,\n\t\tautosaveFields: false,\n\n\t\timageUpload: null,\n\t\timageUploadParam: 'file',\n\t\timageUploadFields: false,\n\t\timageUploadForms: false,\n        imageTag: 'figure',\n        imageEditable: true,\n\t\timageCaption: true,\n\n\t\timagePosition: false,\n\t\timageResizable: false,\n\t\timageFloatMargin: '10px',\n\n\t\tdragImageUpload: true,\n\t\tmultipleImageUpload: true,\n\t\tclipboardImageUpload: true,\n\n\t\tfileUpload: null,\n\t\tfileUploadParam: 'file',\n\t\tfileUploadFields: false,\n\t\tfileUploadForms: false,\n\t\tdragFileUpload: true,\n\n\t\ts3: false,\n\n        linkNewTab: false,\n\t\tlinkTooltip: true,\n\t\tlinkNofollow: false,\n\t\tlinkSize: 30,\n\t\tpasteLinkTarget: false,\n\n\t\tvideoContainerClass: 'video-container',\n\n\t\ttoolbar: true,\n\t\ttoolbarFixed: true,\n\t\ttoolbarFixedTarget: document,\n\t\ttoolbarFixedTopOffset: 0, // pixels\n\t\ttoolbarExternal: false, // ID selector\n\n\t\tair: false,\n\t\tairWidth: false,\n\n\t\tformatting: ['p', 'blockquote', 'pre', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6'],\n\t\tformattingAdd: false,\n\n\t\tbuttons: ['format', 'bold', 'italic', 'deleted', 'lists', 'image', 'file', 'link'], // + 'horizontalrule', 'underline', 'ol', 'ul', 'indent', 'outdent'\n\n\t\tbuttonsHide: [],\n\t\tbuttonsHideOnMobile: [],\n\n\t\tscript: true,\n\t\tremoveComments: true,\n\t\treplaceTags: {\n\t\t\t'b': 'strong',\n\t\t\t'i': 'em',\n\t\t\t'strike': 'del'\n\t\t},\n\n\t\t// shortcuts\n\t\tshortcuts: {\n\t\t\t'ctrl+shift+m, meta+shift+m': { func: 'inline.removeFormat' },\n\t\t\t'ctrl+b, meta+b': { func: 'inline.format', params: ['bold'] },\n\t\t\t'ctrl+i, meta+i': { func: 'inline.format', params: ['italic'] },\n\t\t\t'ctrl+h, meta+h': { func: 'inline.format', params: ['superscript'] },\n\t\t\t'ctrl+l, meta+l': { func: 'inline.format', params: ['subscript'] },\n\t\t\t'ctrl+k, meta+k': { func: 'link.show' },\n\t\t\t'ctrl+shift+7':   { func: 'list.toggle', params: ['orderedlist'] },\n\t\t\t'ctrl+shift+8':   { func: 'list.toggle', params: ['unorderedlist'] }\n\t\t},\n\t\tshortcutsAdd: false,\n\n\t\tactiveButtons: ['deleted', 'italic', 'bold'],\n\t\tactiveButtonsStates: {\n\t\t\tb: 'bold',\n\t\t\tstrong: 'bold',\n\t\t\ti: 'italic',\n\t\t\tem: 'italic',\n\t\t\tdel: 'deleted',\n\t\t\tstrike: 'deleted'\n\t\t},\n\n\t\t// private lang\n\t\tlangs: {\n\t\t\ten: {\n\n\t\t\t\t\"format\": \"Format\",\n\t\t\t\t\"image\": \"Image\",\n\t\t\t\t\"file\": \"File\",\n\t\t\t\t\"link\": \"Link\",\n\t\t\t\t\"bold\": \"Bold\",\n\t\t\t\t\"italic\": \"Italic\",\n\t\t\t\t\"deleted\": \"Strikethrough\",\n\t\t\t\t\"underline\": \"Underline\",\n\t\t\t\t\"bold-abbr\": \"B\",\n\t\t\t\t\"italic-abbr\": \"I\",\n\t\t\t\t\"deleted-abbr\": \"S\",\n\t\t\t\t\"underline-abbr\": \"U\",\n\t\t\t\t\"lists\": \"Lists\",\n\t\t\t\t\"link-insert\": \"Insert link\",\n\t\t\t\t\"link-edit\": \"Edit link\",\n\t\t\t\t\"link-in-new-tab\": \"Open link in new tab\",\n\t\t\t\t\"unlink\": \"Unlink\",\n\t\t\t\t\"cancel\": \"Cancel\",\n\t\t\t\t\"close\": \"Close\",\n\t\t\t\t\"insert\": \"Insert\",\n\t\t\t\t\"save\": \"Save\",\n\t\t\t\t\"delete\": \"Delete\",\n\t\t\t\t\"text\": \"Text\",\n\t\t\t\t\"edit\": \"Edit\",\n\t\t\t\t\"title\": \"Title\",\n\t\t\t\t\"paragraph\": \"Normal text\",\n\t\t\t\t\"quote\": \"Quote\",\n\t\t\t\t\"code\": \"Code\",\n\t\t\t\t\"heading1\": \"Heading 1\",\n\t\t\t\t\"heading2\": \"Heading 2\",\n\t\t\t\t\"heading3\": \"Heading 3\",\n\t\t\t\t\"heading4\": \"Heading 4\",\n\t\t\t\t\"heading5\": \"Heading 5\",\n\t\t\t\t\"heading6\": \"Heading 6\",\n\t\t\t\t\"filename\": \"Name\",\n\t\t\t\t\"optional\": \"optional\",\n\t\t\t\t\"unorderedlist\": \"Unordered List\",\n\t\t\t\t\"orderedlist\": \"Ordered List\",\n\t\t\t\t\"outdent\": \"Outdent\",\n\t\t\t\t\"indent\": \"Indent\",\n\t\t\t\t\"horizontalrule\": \"Line\",\n\t\t\t\t\"upload-label\": \"Drop file here or \",\n\t\t\t\t\"caption\": \"Caption\",\n\n\t\t\t\t\"bulletslist\": \"Bullets\",\n\t\t\t\t\"numberslist\": \"Numbers\",\n\n\t\t\t\t\"image-position\": \"Position\",\n\t\t\t\t\"none\": \"None\",\n\t\t\t\t\"left\": \"Left\",\n\t\t\t\t\"right\": \"Right\",\n\t\t\t\t\"center\": \"Center\",\n\n\t\t\t\t\"accessibility-help-label\": \"Rich text editor\"\n\t\t\t}\n\t\t},\n\n\t\t// private\n\t\ttype: 'textarea', // textarea, div, inline, pre\n\t\tinline: false,\n\t\tbuffer: [],\n\t\trebuffer: [],\n\t\tinlineTags: ['a', 'span', 'strong', 'strike', 'b', 'u', 'em', 'i', 'code', 'del', 'ins', 'samp', 'kbd', 'sup', 'sub', 'mark', 'var', 'cite', 'small'],\n\t\tblockTags: ['pre', 'ul', 'ol', 'li', 'p', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6',  'dl', 'dt', 'dd', 'div', 'td', 'blockquote', 'output', 'figcaption', 'figure', 'address', 'section', 'header', 'footer', 'aside', 'article', 'iframe'],\n\t\tparagraphize: true,\n\t\tparagraphizeBlocks: ['table', 'div', 'pre', 'form', 'ul', 'ol', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'dl', 'blockquote', 'figcaption',\n\t\t\t\t\t\t\t'address', 'section', 'header', 'footer', 'aside', 'article', 'object', 'style', 'script', 'iframe', 'select', 'input', 'textarea',\n\t\t\t\t\t\t\t'button', 'option', 'map', 'area', 'math', 'hr', 'fieldset', 'legend', 'hgroup', 'nav', 'figure', 'details', 'menu', 'summary', 'p'],\n\t\temptyHtml: '<p>&#x200b;</p>',\n\t\tinvisibleSpace: '&#x200b;',\n\t\timageTypes: ['image/png', 'image/jpeg', 'image/gif'],\n\t\tuserAgent: navigator.userAgent.toLowerCase(),\n\t\tobserve: {\n\t\t\tdropdowns: []\n\t\t},\n\t\tregexps: {\n\t\t\tlinkyoutube: /https?:\\/\\/(?:[0-9A-Z-]+\\.)?(?:youtu\\.be\\/|youtube\\.com\\S*[^\\w\\-\\s])([\\w\\-]{11})(?=[^\\w\\-]|$)(?![?=&+%\\w.\\-]*(?:['\"][^<>]*>|<\\/a>))[?=&+%\\w.-]*/ig,\n\t\t\tlinkvimeo: /https?:\\/\\/(www\\.)?vimeo.com\\/(\\d+)($|\\/)/,\n\t\t\tlinkimage: /((https?|www)[^\\s]+\\.)(jpe?g|png|gif)(\\?[^\\s-]+)?/ig,\n\t\t\turl: /(https?:\\/\\/(?:www\\.|(?!www))[^\\s\\.]+\\.[^\\s]{2,}|www\\.[^\\s]+\\.[^\\s]{2,})/ig\n\t\t}\n\n\t};\n\n\t// Functionality\n\tRedactor.fn = $.Redactor.prototype = {\n\n\t\tkeyCode: {\n\t\t\tBACKSPACE: 8,\n\t\t\tDELETE: 46,\n\t\t\tUP: 38,\n\t\t\tDOWN: 40,\n\t\t\tENTER: 13,\n\t\t\tSPACE: 32,\n\t\t\tESC: 27,\n\t\t\tTAB: 9,\n\t\t\tCTRL: 17,\n\t\t\tMETA: 91,\n\t\t\tSHIFT: 16,\n\t\t\tALT: 18,\n\t\t\tRIGHT: 39,\n\t\t\tLEFT: 37,\n\t\t\tLEFT_WIN: 91\n\t\t},\n\n\t\t// =init\n\t\tinit: function(el, options)\n\t\t{\n\t\t\tthis.$element = $(el);\n\t\t\tthis.uuid = uuid++;\n\n\t\t\tthis.loadOptions(options);\n\t\t\tthis.loadModules();\n\n\t\t\t// click to edit\n\t\t\tif (this.opts.clickToEdit && !this.$element.hasClass('redactor-click-to-edit'))\n\t\t\t{\n\t\t\t\treturn this.loadToEdit(options);\n\t\t\t}\n\t\t\telse if (this.$element.hasClass('redactor-click-to-edit'))\n\t\t\t{\n\t\t\t\tthis.$element.removeClass('redactor-click-to-edit');\n\t\t\t}\n\n\t\t\t// block & inline test tag regexp\n\t\t\tthis.reIsBlock = new RegExp('^(' + this.opts.blockTags.join('|' ).toUpperCase() + ')$', 'i');\n\t\t\tthis.reIsInline = new RegExp('^(' + this.opts.inlineTags.join('|' ).toUpperCase() + ')$', 'i');\n\n\t\t\t// set up drag upload\n\t\t\tthis.opts.dragImageUpload = (this.opts.imageUpload === null) ? false : this.opts.dragImageUpload;\n\t\t\tthis.opts.dragFileUpload = (this.opts.fileUpload === null) ? false : this.opts.dragFileUpload;\n\n\t\t\t// formatting storage\n\t\t\tthis.formatting = {};\n\n\t\t\t// load lang\n\t\t\tthis.lang.load();\n\n\t\t\t// extend shortcuts\n\t\t\t$.extend(this.opts.shortcuts, this.opts.shortcutsAdd);\n\n\t\t\t// set editor\n\t\t\tthis.$editor = this.$element;\n\n\t\t\t// detect type of editor\n\t\t\tthis.detectType();\n\n\t\t\t// start callback\n\t\t\tthis.core.callback('start');\n\t\t\tthis.core.callback('startToEdit');\n\n\t\t\t// build\n\t\t\tthis.start = true;\n\t\t\tthis.build.start();\n\n\t\t},\n\t\tdetectType: function()\n\t\t{\n\t\t\tif (this.build.isInline() || this.opts.inline)\n\t\t\t{\n\t\t\t\tthis.opts.type = 'inline';\n\t\t\t}\n\t\t\telse if (this.build.isTag('DIV'))\n\t\t\t{\n\t\t\t\tthis.opts.type = 'div';\n\t\t\t}\n\t\t\telse if (this.build.isTag('PRE'))\n\t\t\t{\n\t\t\t\tthis.opts.type = 'pre';\n\t\t\t}\n\t\t},\n\t\tloadToEdit: function(options)\n\t\t{\n\n\t\t\tthis.$element.on('click.redactor-click-to-edit', $.proxy(function()\n\t\t\t{\n\t\t\t\tthis.initToEdit(options);\n\n\t\t\t}, this));\n\n\t\t\tthis.$element.addClass('redactor-click-to-edit');\n\n\t\t\treturn;\n\t\t},\n\t\tinitToEdit: function(options)\n\t\t{\n\t\t\t$.extend(options.callbacks,  {\n\t\t\t\tstartToEdit: function()\n\t\t\t\t{\n\t\t\t\t\tthis.insert.node(this.marker.get(), false);\n\t\t\t\t},\n\t\t\t\tinitToEdit: function()\n\t\t\t\t{\n\t\t\t\t\tthis.selection.restore();\n\t\t\t\t\tthis.clickToCancelStorage = this.code.get();\n\n\t\t\t\t\t// cancel\n\t\t\t\t\t$(this.opts.clickToCancel).off('.redactor-click-to-edit');\n\t\t\t\t\t$(this.opts.clickToCancel).show().on('click.redactor-click-to-edit', $.proxy(function(e)\n\t\t\t\t\t{\n\t\t\t\t\t\te.preventDefault();\n\n\t\t\t\t\t\tthis.core.destroy();\n\t\t\t\t\t\tthis.events.syncFire = false;\n\t\t\t\t\t\tthis.$element.html(this.clickToCancelStorage);\n\t\t\t\t\t\tthis.core.callback('cancel', this.clickToCancelStorage);\n\t\t\t\t\t\tthis.events.syncFire = true;\n\t\t\t\t\t\tthis.clickToCancelStorage = '';\n\t\t\t\t\t\t$(this.opts.clickToCancel).hide();\n\t\t\t\t\t\t$(this.opts.clickToSave).hide();\n\n\t\t\t\t\t\tthis.$element.on('click.redactor-click-to-edit', $.proxy(function()\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.initToEdit(options);\n\t\t\t\t\t\t}, this));\n\n\t\t\t\t\t\tthis.$element.addClass('redactor-click-to-edit');\n\n\t\t\t\t\t}, this));\n\n\t\t\t\t\t// save\n\t\t\t\t\t$(this.opts.clickToSave).off('.redactor-click-to-edit');\n\t\t\t\t\t$(this.opts.clickToSave).show().on('click.redactor-click-to-edit', $.proxy(function(e)\n\t\t\t\t\t{\n\t\t\t\t\t\te.preventDefault();\n\n\t\t\t\t\t\tthis.core.destroy();\n\t\t\t\t\t\tthis.core.callback('save', this.code.get());\n\t\t\t\t\t\t$(this.opts.clickToCancel).hide();\n\t\t\t\t\t\t$(this.opts.clickToSave).hide();\n\t\t\t\t\t\tthis.$element.on('click.redactor-click-to-edit', $.proxy(function()\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.initToEdit(options);\n\t\t\t\t\t\t}, this));\n\t\t\t\t\t\tthis.$element.addClass('redactor-click-to-edit');\n\n\t\t\t\t\t}, this));\n\t\t\t\t}\n\n\t\t\t});\n\n\t\t\tthis.$element.redactor(options);\n\t\t\tthis.$element.off('.redactor-click-to-edit');\n\n\t\t},\n\t\tloadOptions: function(options)\n\t\t{\n\t\t\tvar settings = {};\n\n\t\t\t// check namespace\n\t\t\tif (typeof $.Redactor.settings.namespace !== 'undefined')\n\t\t\t{\n\t\t\t\t if (this.$element.hasClass($.Redactor.settings.namespace))\n\t\t\t\t {\n\t\t\t\t\t settings = $.Redactor.settings;\n\t\t\t\t }\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tsettings = $.Redactor.settings;\n\t\t\t}\n\n\t\t\tthis.opts = $.extend(\n\t\t\t\t{},\n\t\t\t\t$.extend(true, {}, $.Redactor.opts),\n\t\t\t\t$.extend(true, {}, settings),\n\t\t\t\tthis.$element.data(),\n\t\t\t\toptions\n\t\t\t);\n\n\t\t},\n\t\tgetModuleMethods: function(object)\n\t\t{\n\t\t\treturn Object.getOwnPropertyNames(object).filter(function(property)\n\t\t\t{\n\t\t\t\treturn typeof object[property] === 'function';\n\t\t\t});\n\t\t},\n\t\tloadModules: function()\n\t\t{\n\t\t\tvar len = $.Redactor.modules.length;\n\t\t\tfor (var i = 0; i < len; i++)\n\t\t\t{\n\t\t\t\tthis.bindModuleMethods($.Redactor.modules[i]);\n\t\t\t}\n\t\t},\n\t\tbindModuleMethods: function(module)\n\t\t{\n\t\t\tif (typeof this[module] === 'undefined')\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// init module\n\t\t\tthis[module] = this[module]();\n\n\t\t\tvar methods = this.getModuleMethods(this[module]);\n\t\t\tvar len = methods.length;\n\n\t\t\t// bind methods\n\t\t\tfor (var z = 0; z < len; z++)\n\t\t\t{\n\t\t\t\tthis[module][methods[z]] = this[module][methods[z]].bind(this);\n\t\t\t}\n\t\t},\n\n\t\t// =air\n\t\tair: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tenabled: false,\n\t\t\t\tcollapsed: function()\n\t\t\t\t{\n\t\t\t\t\tif (this.opts.air)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.selection.get().collapseToStart();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tcollapsedEnd: function()\n\t\t\t\t{\n\t\t\t\t\tif (this.opts.air)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.selection.get().collapseToEnd();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tbuild: function()\n\t\t\t\t{\n\t\t\t\t\tif (this.detect.isMobile())\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.button.hideButtons();\n\t\t\t\t\tthis.button.hideButtonsOnMobile();\n\n\t\t\t\t\tif (this.opts.buttons.length === 0)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.$air = this.air.createContainer();\n\n\t\t\t\t\tif (this.opts.airWidth !== false)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.$air.css('width', this.opts.airWidth);\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.air.append();\n\t\t\t\t\tthis.button.$toolbar = this.$air;\n\t\t\t\t\tthis.button.setFormatting();\n\t\t\t\t\tthis.button.load(this.$air);\n\n\t\t\t\t\tthis.core.editor().on('mouseup.redactor', this, $.proxy(function(e)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (this.selection.text() !== '')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.air.show(e);\n\t\t\t\t\t\t}\n\t\t\t\t\t}, this));\n\n\t\t\t\t},\n\t\t\t\tappend: function()\n\t\t\t\t{\n\t\t\t\t\tthis.$air.appendTo('body');\n\t\t\t\t},\n\t\t\t\tcreateContainer: function()\n\t\t\t\t{\n\t\t\t\t\treturn $('<ul>').addClass('redactor-air').attr({ 'id': 'redactor-air-' + this.uuid, 'role': 'toolbar' }).hide();\n\t\t\t\t},\n\t\t\t\tshow: function (e)\n\t\t\t\t{\n\t\t\t\t\tthis.marker.remove();\n\t\t\t\t\tthis.selection.save();\n\t\t\t\t\tthis.selection.restore(false);\n\n\t\t\t\t\t$('.redactor-air').hide();\n\n\t\t\t\t\tvar leftFix = 0;\n\t\t\t\t\tvar width = this.$air.innerWidth();\n\n\t\t\t\t\tif ($(window).width() < (e.clientX + width))\n\t\t\t\t\t{\n\t\t\t\t\t\tleftFix = 200;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.$air.css({\n\t\t\t\t\t\tleft: (e.clientX - leftFix) + 'px',\n\t\t\t\t\t\ttop: (e.clientY + 10 + $(document).scrollTop()) + 'px'\n\t\t\t\t\t}).show();\n\n\t\t\t\t\tthis.air.enabled = true;\n\t\t\t\t\tthis.air.bindHide();\n\t\t\t\t},\n\t\t\t\tbindHide: function()\n\t\t\t\t{\n\t\t\t\t\t$(document).on('mousedown.redactor-air.' + this.uuid, $.proxy(function(e)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar dropdown = $(e.target).closest('.redactor-dropdown').length;\n\n\t\t\t\t\t\tif ($(e.target).closest(this.$air).length === 0 && dropdown === 0)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar hide = this.air.hide(e);\n\t\t\t\t\t\t\tif (hide !== false)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tthis.marker.remove();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}, this)).on('keydown.redactor-air.' + this.uuid, $.proxy(function(e)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar key = e.which;\n\t\t\t\t\t\tif ((!this.utils.isRedactorParent(e.target) && !$(e.target).hasClass('redactor-in')) || $(e.target).closest('#redactor-modal').length !== 0)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (key === this.keyCode.ESC)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.selection.get().collapseToStart();\n\t\t\t\t\t\t\tthis.marker.remove();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (key === this.keyCode.BACKSPACE || key === this.keyCode.DELETE)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar sel = this.selection.get();\n\t\t\t\t\t\t\tvar range = this.selection.range(sel);\n\t\t\t\t\t\t\trange.deleteContents();\n\t\t\t\t\t\t\tthis.marker.remove();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (key === this.keyCode.ENTER)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.selection.get().collapseToEnd();\n\t\t\t\t\t\t\tthis.marker.remove();\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (this.air.enabled)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.air.hide(e);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.selection.get().collapseToStart();\n\t\t\t\t\t\t\tthis.marker.remove();\n\t\t\t\t\t\t}\n\n\n\t\t\t\t\t}, this));\n\t\t\t\t},\n\t\t\t\thide: function(e)\n\t\t\t\t{\n\t\t\t\t\tvar ctrl = e.ctrlKey || e.metaKey || (e.shiftKey && e.altKey);\n\t\t\t\t\tif (ctrl)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.button.setInactiveAll();\n\t\t\t\t\tthis.$air.fadeOut(100);\n\t\t\t\t\tthis.air.enabled = false;\n\t\t\t\t\t$(document).off('mousedown.redactor-air.' + this.uuid);\n\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =autosave\n\t\tautosave: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tenabled: false,\n\t\t\t\thtml: false,\n\t\t\t\tinit: function()\n\t\t\t\t{\n\t\t\t\t\tif (!this.opts.autosave)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.autosave.enabled = true;\n\t\t\t\t\tthis.autosave.name = (this.opts.autosaveName) ? this.opts.autosaveName : this.$textarea.attr('name');\n\n\t\t\t\t},\n\t\t\t\tis: function()\n\t\t\t\t{\n\t\t\t\t\treturn this.autosave.enabled;\n\t\t\t\t},\n\t\t\t\tsend: function()\n\t\t\t\t{\n\t\t\t\t\tif (!this.opts.autosave)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.autosave.source = this.code.get();\n\n\t\t\t\t\tif (this.autosave.html === this.autosave.source)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\t// data\n\t\t\t\t\tvar data = {};\n\t\t\t\t\tdata.name = this.autosave.name;\n\t\t\t\t\tdata[this.autosave.name] = this.autosave.source;\n\t\t\t\t\tdata = this.autosave.getHiddenFields(data);\n\n\t\t\t\t\t// ajax\n\t\t\t\t\tvar jsxhr = $.ajax({\n\t\t\t\t\t\turl: this.opts.autosave,\n\t\t\t\t\t\ttype: 'post',\n\t\t\t\t\t\tdata: data\n\t\t\t\t\t});\n\n\t\t\t\t\tjsxhr.done(this.autosave.success);\n\t\t\t\t},\n\t\t\t\tgetHiddenFields: function(data)\n\t\t\t\t{\n\t\t\t\t\tif (this.opts.autosaveFields === false || typeof this.opts.autosaveFields !== 'object')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn data;\n\t\t\t\t\t}\n\n\t\t\t\t\t$.each(this.opts.autosaveFields, $.proxy(function(k, v)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (v !== null && v.toString().indexOf('#') === 0)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tv = $(v).val();\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tdata[k] = v;\n\n\t\t\t\t\t}, this));\n\n\t\t\t\t\treturn data;\n\n\t\t\t\t},\n\t\t\t\tsuccess: function(data)\n\t\t\t\t{\n\t\t\t\t\tvar json;\n\t\t\t\t\ttry\n\t\t\t\t\t{\n\t\t\t\t\t\tjson = $.parseJSON(data);\n\t\t\t\t\t}\n\t\t\t\t\tcatch(e)\n\t\t\t\t\t{\n\t\t\t\t\t\t//data has already been parsed\n\t\t\t\t\t\tjson = data;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar callbackName = (typeof json.error === 'undefined') ? 'autosave' :  'autosaveError';\n\n\t\t\t\t\tthis.core.callback(callbackName, this.autosave.name, json);\n\t\t\t\t\tthis.autosave.html = this.autosave.source;\n\t\t\t\t},\n\t\t\t\tdisable: function()\n\t\t\t\t{\n\t\t\t\t\tthis.autosave.enabled = false;\n\n\t\t\t\t\tclearInterval(this.autosaveTimeout);\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =block\n\t\tblock: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tformat: function(tag, attr, value, type)\n\t\t\t\t{\n\t\t\t\t\ttag = (tag === 'quote') ? 'blockquote' : tag;\n\n\t\t\t\t\tthis.block.tags = ['p', 'blockquote', 'pre', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'div', 'figure'];\n\t\t\t\t\tif ($.inArray(tag, this.block.tags) === -1)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (tag === 'p' && typeof attr === 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\t// remove all\n\t\t\t\t\t\tattr = 'class';\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.placeholder.hide();\n\t\t\t\t\tthis.buffer.set();\n\n\t\t\t\t\treturn (this.utils.isCollapsed()) ? this.block.formatCollapsed(tag, attr, value, type) : this.block.formatUncollapsed(tag, attr, value, type);\n\t\t\t\t},\n\t\t\t\tformatCollapsed: function(tag, attr, value, type)\n\t\t\t\t{\n\t\t\t\t\tthis.selection.save();\n\n\t\t\t\t\tvar block = this.selection.block();\n\t\t\t\t\tvar currentTag = block.tagName.toLowerCase();\n\t\t\t\t\tif ($.inArray(currentTag, this.block.tags) === -1)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.selection.restore();\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (currentTag === tag)\n\t\t\t\t\t{\n\t\t\t\t\t\ttag = 'p';\n\t\t\t\t\t}\n\n\t\t\t\t\tvar replaced = this.utils.replaceToTag(block, tag);\n\n\t\t\t\t\tif (typeof attr === 'object')\n\t\t\t\t\t{\n\t\t\t\t\t\ttype = value;\n\t\t\t\t\t\tfor (var key in attr)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treplaced = this.block.setAttr(replaced, key, attr[key], type);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\treplaced = this.block.setAttr(replaced, attr, value, type);\n\t\t\t\t\t}\n\n\n\t\t\t\t\t// trim pre\n\t\t\t\t\tif (tag === 'pre' && replaced.length === 1)\n\t\t\t\t\t{\n\t\t\t\t\t\t$(replaced).html($.trim($(replaced).html()));\n\t\t\t\t\t}\n\n\n\t\t\t\t\tthis.selection.restore();\n\t\t\t\t\tthis.block.removeInlineTags(replaced);\n\n\t\t\t\t\treturn replaced;\n\t\t\t\t},\n\t\t\t\tformatUncollapsed: function(tag, attr, value, type)\n\t\t\t\t{\n\t\t\t\t\tthis.selection.save();\n\n\t\t\t\t\tvar replaced = [];\n\t\t\t\t\tvar blocks = this.selection.blocks();\n\n                    if (blocks[0] && $(blocks[0]).hasClass('redactor-in'))\n                    {\n                        blocks = $(blocks[0]).find(this.opts.blockTags.join(', '));\n\t\t\t\t\t}\n\n\t\t\t\t\tvar len = blocks.length;\n\t\t\t\t\tfor (var i = 0; i < len; i++)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar currentTag = blocks[i].tagName.toLowerCase();\n\n\t\t\t\t\t\tif ($.inArray(currentTag, this.block.tags) !== -1 && currentTag !== 'figure')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar block = this.utils.replaceToTag(blocks[i], tag);\n\n\t\t\t\t\t\t\tif (typeof attr === 'object')\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\ttype = value;\n\t\t\t\t\t\t\t\tfor (var key in attr)\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tblock = this.block.setAttr(block, key, attr[key], type);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tblock = this.block.setAttr(block, attr, value, type);\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\treplaced.push(block);\n\t\t\t\t\t\t\tthis.block.removeInlineTags(block);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.selection.restore();\n\n\t\t\t\t\t// combine pre\n\t\t\t\t\tif (tag === 'pre' && replaced.length !== 0)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar first = replaced[0];\n\t\t\t\t\t\t$.each(replaced, function(i,s)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tif (i !== 0)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t$(first).append(\"\\n\" + $.trim(s.html()));\n\t\t\t\t\t\t\t\t$(s).remove();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\treplaced = [];\n\t\t\t\t\t\treplaced.push(first);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn replaced;\n\t\t\t\t},\n\t\t\t\tremoveInlineTags: function(node)\n\t\t\t\t{\n\t\t\t\t\tnode = node[0] || node;\n\n\t\t\t\t\tvar tags = this.opts.inlineTags;\n\t\t\t\t\tvar blocks = ['PRE', 'H1', 'H2', 'H3', 'H4', 'H5', 'H6'];\n\n\t\t\t\t\tif ($.inArray(node.tagName, blocks) === - 1)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (node.tagName !== 'PRE')\n\t\t\t\t\t{\n\t\t\t\t\t\tvar index = tags.indexOf('a');\n\t\t\t\t\t\ttags.splice(index, 1);\n\t\t\t\t\t}\n\n\t\t\t\t\t$(node).find(tags.join(',')).not('.redactor-selection-marker').contents().unwrap();\n\t\t\t\t},\n\t\t\t\tsetAttr: function(block, attr, value, type)\n\t\t\t\t{\n\t\t\t\t\tif (typeof attr === 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn block;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar func = (typeof type === 'undefined') ? 'replace' : type;\n\n\t\t\t\t\tif (attr === 'class')\n\t\t\t\t\t{\n\t\t\t\t\t\tblock = this.block[func + 'Class'](value, block);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tif (func === 'remove')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tblock = this.block[func + 'Attr'](attr, block);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (func === 'removeAll')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tblock = this.block[func + 'Attr'](attr, block);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tblock = this.block[func + 'Attr'](attr, value, block);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\treturn block;\n\n\t\t\t\t},\n\t\t\t\tgetBlocks: function(block)\n\t\t\t\t{\n\t\t\t\t\treturn (typeof block === 'undefined') ? this.selection.blocks() : block;\n\t\t\t\t},\n\t\t\t\treplaceClass: function(value, block)\n\t\t\t\t{\n\t\t\t\t\treturn $(this.block.getBlocks(block)).removeAttr('class').addClass(value)[0];\n\t\t\t\t},\n\t\t\t\ttoggleClass: function(value, block)\n\t\t\t\t{\n\t\t\t\t\treturn $(this.block.getBlocks(block)).toggleClass(value)[0];\n\t\t\t\t},\n\t\t\t\taddClass: function(value, block)\n\t\t\t\t{\n\t\t\t\t\treturn $(this.block.getBlocks(block)).addClass(value)[0];\n\t\t\t\t},\n\t\t\t\tremoveClass: function(value, block)\n\t\t\t\t{\n\t\t\t\t\treturn $(this.block.getBlocks(block)).removeClass(value)[0];\n\t\t\t\t},\n\t\t\t\tremoveAllClass: function(block)\n\t\t\t\t{\n\t\t\t\t\treturn $(this.block.getBlocks(block)).removeAttr('class')[0];\n\t\t\t\t},\n\t\t\t\treplaceAttr: function(attr, value, block)\n\t\t\t\t{\n\t\t\t\t\tblock = this.block.removeAttr(attr, block);\n\n\t\t\t\t\treturn $(block).attr(attr, value)[0];\n\t\t\t\t},\n\t\t\t\ttoggleAttr: function(attr, value, block)\n\t\t\t\t{\n\t\t\t\t\tblock = this.block.getBlocks(block);\n\n\t\t\t\t\tvar self = this;\n\t\t\t\t\tvar returned = [];\n\t\t\t\t\t$.each(block, function(i,s)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar $el = $(s);\n\t\t\t\t\t\tif ($el.attr(attr))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturned.push(self.block.removeAttr(attr, s));\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturned.push(self.block.addAttr(attr, value, s));\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\n\t\t\t\t\treturn returned;\n\n\t\t\t\t},\n\t\t\t\taddAttr: function(attr, value, block)\n\t\t\t\t{\n\t\t\t\t\treturn $(this.block.getBlocks(block)).attr(attr, value)[0];\n\t\t\t\t},\n\t\t\t\tremoveAttr: function(attr, block)\n\t\t\t\t{\n\t\t\t\t\treturn $(this.block.getBlocks(block)).removeAttr(attr)[0];\n\t\t\t\t},\n\t\t\t\tremoveAllAttr: function(block)\n\t\t\t\t{\n\t\t\t\t\tblock = this.block.getBlocks(block);\n\n\t\t\t\t\tvar returned = [];\n\t\t\t\t\t$.each(block, function(i,s)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (typeof s.attributes === 'undefined')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturned.push(s);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tvar $el = $(s);\n\t\t\t\t\t\tvar len = s.attributes.length;\n\t\t\t\t\t\tfor (var z = 0; z < len; z++)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$el.removeAttr(s.attributes[z].name);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturned.push($el[0]);\n\t\t\t\t\t});\n\n\t\t\t\t\treturn returned;\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// buffer\n\t\tbuffer: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tset: function(type)\n\t\t\t\t{\n    \t\t\t\tif (typeof type === 'undefined')\n                    {\n                        this.buffer.clear();\n                    }\n\n\t\t\t\t\tif (typeof type === 'undefined' || type === 'undo')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.buffer.setUndo();\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.buffer.setRedo();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tsetUndo: function()\n\t\t\t\t{\n\t\t\t\t\tthis.selection.save();\n\n\t\t\t\t\tvar last = this.opts.buffer[this.opts.buffer.length-1];\n\t\t\t\t\tvar current = this.core.editor().html();\n\t\t\t\t\tif (last !== current)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.opts.buffer.push(current);\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.selection.restore();\n\t\t\t\t},\n\t\t\t\tsetRedo: function()\n\t\t\t\t{\n\t\t\t\t\tthis.selection.save();\n\t\t\t\t\tthis.opts.rebuffer.push(this.core.editor().html());\n\t\t\t\t\tthis.selection.restore();\n\t\t\t\t},\n\t\t\t\tgetUndo: function()\n\t\t\t\t{\n\t\t\t\t\tthis.core.editor().html(this.opts.buffer.pop());\n\t\t\t\t},\n\t\t\t\tgetRedo: function()\n\t\t\t\t{\n\t\t\t\t\tthis.core.editor().html(this.opts.rebuffer.pop());\n\t\t\t\t},\n\t\t\t\tadd: function()\n\t\t\t\t{\n\t\t\t\t\tthis.opts.buffer.push(this.core.editor().html());\n\t\t\t\t},\n\t\t\t\tundo: function()\n\t\t\t\t{\n\t\t\t\t\tif (this.opts.buffer.length === 0)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.buffer.set('redo');\n\t\t\t\t\tthis.buffer.getUndo();\n\n\t\t\t\t\tthis.selection.restore();\n\t\t\t\t},\n\t\t\t\tredo: function()\n\t\t\t\t{\n\t\t\t\t\tif (this.opts.rebuffer.length === 0)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.buffer.set('undo');\n\t\t\t\t\tthis.buffer.getRedo();\n\n\t\t\t\t\tthis.selection.restore();\n\t\t\t\t},\n\t\t\t\tclear: function()\n\t\t\t\t{\n    \t\t\t\tthis.opts.rebuffer = [];\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =build\n\t\tbuild: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tstart: function()\n\t\t\t\t{\n\t\t\t\t\tif (this.opts.type === 'inline')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.opts.type = 'inline';\n\t\t\t\t\t}\n\t\t\t\t\telse if (this.opts.type === 'div')\n\t\t\t\t\t{\n\t\t\t\t\t\t// empty\n\t\t\t\t\t\tvar html = $.trim(this.$editor.html());\n\t\t\t\t\t\tif (html === '')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.$editor.html(this.opts.emptyHtml);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse if (this.opts.type === 'textarea')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.build.startTextarea();\n\t\t\t\t\t}\n\n\t\t\t\t\t// set in\n\t\t\t\t\tthis.build.setIn();\n\n\t\t\t\t\t// set id\n\t\t\t\t\tthis.build.setId();\n\n\t\t\t\t\t// enable\n\t\t\t\t\tthis.build.enableEditor();\n\n\t\t\t\t\t// options\n\t\t\t\t\tthis.build.setOptions();\n\n\t\t\t\t\t// call\n\t\t\t\t\tthis.build.callEditor();\n\n\t\t\t\t},\n\t\t\t\tcreateContainerBox: function()\n\t\t\t\t{\n\t\t\t\t\tthis.$box = $('<div class=\"redactor-box\" role=\"application\" />');\n\t\t\t\t},\n\t\t\t\tsetIn: function()\n\t\t\t\t{\n\t\t\t\t\tthis.core.editor().addClass('redactor-in');\n\t\t\t\t},\n\t\t\t\tsetId: function()\n\t\t\t\t{\n\t\t\t\t\tvar id = (this.opts.type === 'textarea') ? 'redactor-uuid-' + this.uuid : this.$element.attr('id');\n\n\t\t\t\t\tthis.core.editor().attr('id', (typeof id === 'undefined') ? 'redactor-uuid-' + this.uuid : id);\n\t\t\t\t},\n\t\t\t\tgetName: function()\n\t\t\t\t{\n\t\t\t\t\tvar name = this.$element.attr('name');\n\n\t\t\t\t\treturn (typeof name === 'undefined') ? 'content-' + this.uuid : name;\n\t\t\t\t},\n\t\t\t\tloadFromTextarea: function()\n\t\t\t\t{\n\t\t\t\t\tthis.$editor = $('<div />');\n\n\t\t\t\t\t// textarea\n\t\t\t\t\tthis.$textarea = this.$element;\n\t\t\t\t\tthis.$element.attr('name', this.build.getName());\n\n\t\t\t\t\t// place\n\t\t\t\t\tthis.$box.insertAfter(this.$element).append(this.$editor).append(this.$element);\n\t\t\t\t\tthis.$editor.addClass('redactor-editor');\n\t\t\t\t\tthis.$element.hide();\n\n\t\t\t\t\tthis.$box.prepend('<span class=\"redactor-voice-label\" id=\"redactor-voice-' + this.uuid +'\" aria-hidden=\"false\">' + this.lang.get('accessibility-help-label') + '</span>');\n\t\t\t\t\tthis.$editor.attr({ 'aria-labelledby': 'redactor-voice-' + this.uuid, 'role': 'presentation' });\n\t\t\t\t},\n\t\t\t\tstartTextarea: function()\n\t\t\t\t{\n\t\t\t\t\tthis.build.createContainerBox();\n\n\t\t\t\t\t// load\n\t\t\t\t\tthis.build.loadFromTextarea();\n\n\t\t\t\t\t// set code\n\t\t\t\t\tthis.code.start(this.core.textarea().val());\n\n\t\t\t\t\t// set value\n\t\t\t\t\tthis.core.textarea().val(this.clean.onSync(this.$editor.html()));\n\t\t\t\t},\n\t\t\t\tisTag: function(tag)\n\t\t\t\t{\n\t\t\t\t\treturn (this.$element[0].tagName === tag);\n\t\t\t\t},\n\t\t\t\tisInline: function()\n\t\t\t\t{\n\t\t\t\t\treturn (!this.build.isTag('TEXTAREA') && !this.build.isTag('DIV') && !this.build.isTag('PRE'));\n\t\t\t\t},\n\t\t\t\tenableEditor: function()\n\t\t\t\t{\n\t\t\t\t\tthis.core.editor().attr({ 'contenteditable': true });\n\t\t\t\t},\n\t\t\t\tsetOptions: function()\n\t\t\t\t{\n\t\t\t\t\t// inline\n\t\t\t\t\tif (this.opts.type === 'inline')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.opts.enterKey = false;\n\t\t\t\t\t}\n\n\t\t\t\t\t// inline & pre\n\t\t\t\t\tif (this.opts.type === 'inline' || this.opts.type === 'pre')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.opts.toolbarMobile = false;\n\t\t\t\t\t\tthis.opts.toolbar = false;\n\t\t\t\t\t\tthis.opts.air = false;\n\t\t\t\t\t\tthis.opts.linkify = false;\n\n\t\t\t\t\t}\n\n\t\t\t\t\t// spellcheck\n\t\t\t\t\tthis.core.editor().attr('spellcheck', this.opts.spellcheck);\n\n\t\t\t\t\t// structure\n\t\t\t\t\tif (this.opts.structure)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.editor().addClass('redactor-structure');\n\t\t\t\t\t}\n\n\t\t\t\t\t// options sets only in textarea mode\n\t\t\t\t\tif (this.opts.type !== 'textarea')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\t// direction\n\t\t\t\t\tthis.core.box().attr('dir', this.opts.direction);\n\t\t\t\t\tthis.core.editor().attr('dir', this.opts.direction);\n\n\t\t\t\t\t// tabindex\n\t\t\t\t\tif (this.opts.tabindex)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.editor().attr('tabindex', this.opts.tabindex);\n\t\t\t\t\t}\n\n\t\t\t\t\t// min height\n\t\t\t\t\tif (this.opts.minHeight)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.editor().css('min-height', this.opts.minHeight);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.editor().css('min-height', '40px');\n\t\t\t\t\t}\n\n\t\t\t\t\t// max height\n\t\t\t\t\tif (this.opts.maxHeight)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.editor().css('max-height', this.opts.maxHeight);\n\t\t\t\t\t}\n\n\t\t\t\t\t// max width\n\t\t\t\t\tif (this.opts.maxWidth)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.editor().css({ 'max-width': this.opts.maxWidth, 'margin': 'auto' });\n\t\t\t\t\t}\n\n\t\t\t\t},\n\t\t\t\tcallEditor: function()\n\t\t\t\t{\n\t\t\t\t\tthis.build.disableBrowsersEditing();\n\n\t\t\t\t\tthis.events.init();\n\t\t\t\t\tthis.build.setHelpers();\n\n\t\t\t\t\t// init buttons\n\t\t\t\t\tif (this.opts.toolbar || this.opts.air)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.toolbarsButtons = this.button.init();\n\t\t\t\t\t}\n\n\t\t\t\t\t// load toolbar\n\t\t\t\t\tif (this.opts.air)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.air.build();\n\t\t\t\t\t}\n\t\t\t\t\telse if (this.opts.toolbar)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.toolbar.build();\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.detect.isMobile() && this.opts.toolbarMobile && this.opts.air)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.opts.toolbar = true;\n\t\t\t\t\t\tthis.toolbar.build();\n\t\t\t\t\t}\n\n\t\t\t\t\t// observe dropdowns\n\t\t\t\t\tif (this.opts.air || this.opts.toolbar)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.editor().on('mouseup.redactor-observe.' + this.uuid + ' keyup.redactor-observe.' + this.uuid + ' focus.redactor-observe.' + this.uuid + ' touchstart.redactor-observe.' + this.uuid, $.proxy(this.observe.toolbar, this));\n\t\t\t\t\t\tthis.core.element().on('blur.callback.redactor', $.proxy(function()\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.button.setInactiveAll();\n\n\t\t\t\t\t\t}, this));\n\t\t\t\t\t}\n\n\t\t\t\t\t// modal templates init\n\t\t\t\t\tthis.modal.templates();\n\n\t\t\t\t\t// plugins\n\t\t\t\t\tthis.build.plugins();\n\n\t\t\t\t\t// autosave\n\t\t\t\t\tthis.autosave.init();\n\n\t\t\t\t\t// sync code\n\t\t\t\t\tthis.code.html = this.code.cleaned(this.core.editor().html());\n\n\t\t\t\t\t// init callback\n\t\t\t\t\tthis.core.callback('init');\n\t\t\t\t\tthis.core.callback('initToEdit');\n\n\t\t\t\t\t// get images & files list\n\t\t\t\t\tthis.storage.observe();\n\n\t\t\t\t\t// started\n\t\t\t\t\tthis.start = false;\n\n\t\t\t\t},\n\t\t\t\tsetHelpers: function()\n\t\t\t\t{\n\t\t\t\t\t// linkify\n\t\t\t\t\tif (this.opts.linkify)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.linkify.format();\n\t\t\t\t\t}\n\n\t\t\t\t\t// placeholder\n\t\t\t\t\tthis.placeholder.init();\n\n\t\t\t\t\t// focus\n\t\t\t\t\tif (this.opts.focus)\n\t\t\t\t\t{\n\t\t\t\t\t\tsetTimeout(this.focus.start, 100);\n\t\t\t\t\t}\n\t\t\t\t\telse if (this.opts.focusEnd)\n\t\t\t\t\t{\n\t\t\t\t\t\tsetTimeout(this.focus.end, 100);\n\t\t\t\t\t}\n\n\t\t\t\t},\n\t\t\t\tdisableBrowsersEditing: function()\n\t\t\t\t{\n\t\t\t\t\ttry {\n\t\t\t\t\t\t// FF fix\n\t\t\t\t\t\tdocument.execCommand('enableObjectResizing', false, false);\n\t\t\t\t\t\tdocument.execCommand('enableInlineTableEditing', false, false);\n\t\t\t\t\t\t// IE prevent converting links\n\t\t\t\t\t\tdocument.execCommand(\"AutoUrlDetect\", false, false);\n\t\t\t\t\t} catch (e) {}\n\t\t\t\t},\n\t\t\t\tplugins: function()\n\t\t\t\t{\n\t\t\t\t\tif (!this.opts.plugins)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\t$.each(this.opts.plugins, $.proxy(function(i, s)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar func = (typeof RedactorPlugins !== 'undefined' && typeof RedactorPlugins[s] !== 'undefined') ? RedactorPlugins : Redactor.fn;\n\n\t\t\t\t\t\tif (!$.isFunction(func[s]))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tthis[s] = func[s]();\n\n\t\t\t\t\t\t// get methods\n\t\t\t\t\t\tvar methods = this.getModuleMethods(this[s]);\n\t\t\t\t\t\tvar len = methods.length;\n\n\t\t\t\t\t\t// bind methods\n\t\t\t\t\t\tfor (var z = 0; z < len; z++)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis[s][methods[z]] = this[s][methods[z]].bind(this);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// append lang\n\t\t\t\t\t\tif (typeof this[s].langs !== 'undefined')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar lang = {};\n\t\t\t\t\t\t\tif (typeof this[s].langs[this.opts.lang] !== 'undefined')\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tlang = this[s].langs[this.opts.lang];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse if (typeof this[s].langs[this.opts.lang] === 'undefined' && typeof this[s].langs.en !== 'undefined')\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tlang = this[s].langs.en;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t// extend\n\t\t\t\t\t\t\tvar self = this;\n\t\t\t\t\t\t\t$.each(lang, function(i,s)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tif (typeof self.opts.curLang[i] === 'undefined')\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tself.opts.curLang[i] = s;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// init\n\t\t\t\t\t\tif ($.isFunction(this[s].init))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis[s].init();\n\t\t\t\t\t\t}\n\n\n\t\t\t\t\t}, this));\n\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =button\n\t\tbutton: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\ttoolbar: function()\n\t\t\t\t{\n\t\t\t\t\treturn (typeof this.button.$toolbar === 'undefined' || !this.button.$toolbar) ? this.$toolbar : this.button.$toolbar;\n\t\t\t\t},\n\t\t\t\tinit: function()\n\t\t\t\t{\n\t\t\t\t\treturn {\n\t\t\t\t\t\tformat:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: this.lang.get('format'),\n\t\t\t\t\t\t\tdropdown:\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tp:\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\ttitle: this.lang.get('paragraph'),\n\t\t\t\t\t\t\t\t\tfunc: 'block.format'\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\tblockquote:\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\ttitle: this.lang.get('quote'),\n\t\t\t\t\t\t\t\t\tfunc: 'block.format'\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\tpre:\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\ttitle: this.lang.get('code'),\n\t\t\t\t\t\t\t\t\tfunc: 'block.format'\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\th1:\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\ttitle: this.lang.get('heading1'),\n\t\t\t\t\t\t\t\t\tfunc: 'block.format'\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\th2:\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\ttitle: this.lang.get('heading2'),\n\t\t\t\t\t\t\t\t\tfunc: 'block.format'\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\th3:\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\ttitle: this.lang.get('heading3'),\n\t\t\t\t\t\t\t\t\tfunc: 'block.format'\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\th4:\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\ttitle: this.lang.get('heading4'),\n\t\t\t\t\t\t\t\t\tfunc: 'block.format'\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\th5:\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\ttitle: this.lang.get('heading5'),\n\t\t\t\t\t\t\t\t\tfunc: 'block.format'\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\th6:\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\ttitle: this.lang.get('heading6'),\n\t\t\t\t\t\t\t\t\tfunc: 'block.format'\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},\n\t\t\t\t\t\tbold:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: this.lang.get('bold-abbr'),\n\t\t\t\t\t\t\tlabel: this.lang.get('bold'),\n\t\t\t\t\t\t\tfunc: 'inline.format'\n\t\t\t\t\t\t},\n\t\t\t\t\t\titalic:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: this.lang.get('italic-abbr'),\n\t\t\t\t\t\t\tlabel: this.lang.get('italic'),\n\t\t\t\t\t\t\tfunc: 'inline.format'\n\t\t\t\t\t\t},\n\t\t\t\t\t\tdeleted:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: this.lang.get('deleted-abbr'),\n\t\t\t\t\t\t\tlabel: this.lang.get('deleted'),\n\t\t\t\t\t\t\tfunc: 'inline.format'\n\t\t\t\t\t\t},\n\t\t\t\t\t\tunderline:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: this.lang.get('underline-abbr'),\n\t\t\t\t\t\t\tlabel: this.lang.get('underline'),\n\t\t\t\t\t\t\tfunc: 'inline.format'\n\t\t\t\t\t\t},\n\t\t\t\t\t\tlists:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: this.lang.get('lists'),\n\t\t\t\t\t\t\tdropdown:\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tunorderedlist:\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\ttitle: '&bull; ' + this.lang.get('unorderedlist'),\n\t\t\t\t\t\t\t\t\tfunc: 'list.toggle'\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\torderedlist:\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\ttitle: '1. ' + this.lang.get('orderedlist'),\n\t\t\t\t\t\t\t\t\tfunc: 'list.toggle'\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\toutdent:\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\ttitle: '< ' + this.lang.get('outdent'),\n\t\t\t\t\t\t\t\t\tfunc: 'indent.decrease',\n\t\t\t\t\t\t\t\t\tobserve: {\n\t\t\t\t\t\t\t\t\t\telement: 'li',\n\t\t\t\t\t\t\t\t\t\tout: {\n\t\t\t\t\t\t\t\t\t\t\tattr: {\n\t\t\t\t\t\t\t\t\t\t\t\t'class': 'redactor-dropdown-link-inactive',\n\t\t\t\t\t\t\t\t\t\t\t\t'aria-disabled': true\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\tindent:\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\ttitle: '> ' + this.lang.get('indent'),\n\t\t\t\t\t\t\t\t\tfunc: 'indent.increase',\n\t\t\t\t\t\t\t\t\tobserve: {\n\t\t\t\t\t\t\t\t\t\telement: 'li',\n\t\t\t\t\t\t\t\t\t\tout: {\n\t\t\t\t\t\t\t\t\t\t\tattr: {\n\t\t\t\t\t\t\t\t\t\t\t\t'class': 'redactor-dropdown-link-inactive',\n\t\t\t\t\t\t\t\t\t\t\t\t'aria-disabled': true\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},\n\t\t\t\t\t\tul:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: '&bull; ' + this.lang.get('bulletslist'),\n\t\t\t\t\t\t\tfunc: 'list.toggle'\n\t\t\t\t\t\t},\n\t\t\t\t\t\tol:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: '1. ' + this.lang.get('numberslist'),\n\t\t\t\t\t\t\tfunc: 'list.toggle'\n\t\t\t\t\t\t},\n\t\t\t\t\t\toutdent:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: this.lang.get('outdent'),\n\t\t\t\t\t\t\tfunc: 'indent.decrease'\n\t\t\t\t\t\t},\n\t\t\t\t\t\tindent:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: this.lang.get('indent'),\n\t\t\t\t\t\t\tfunc: 'indent.increase'\n\t\t\t\t\t\t},\n\t\t\t\t\t\timage:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: this.lang.get('image'),\n\t\t\t\t\t\t\tfunc: 'image.show'\n\t\t\t\t\t\t},\n\t\t\t\t\t\tfile:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: this.lang.get('file'),\n\t\t\t\t\t\t\tfunc: 'file.show'\n\t\t\t\t\t\t},\n\t\t\t\t\t\tlink:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: this.lang.get('link'),\n\t\t\t\t\t\t\tdropdown:\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tlink:\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\ttitle: this.lang.get('link-insert'),\n\t\t\t\t\t\t\t\t\tfunc: 'link.show',\n\t\t\t\t\t\t\t\t\tobserve: {\n\t\t\t\t\t\t\t\t\t\telement: 'a',\n\t\t\t\t\t\t\t\t\t\tin: {\n\t\t\t\t\t\t\t\t\t\t\ttitle: this.lang.get('link-edit'),\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\tout: {\n\t\t\t\t\t\t\t\t\t\t\ttitle: this.lang.get('link-insert')\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\tunlink:\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\ttitle: this.lang.get('unlink'),\n\t\t\t\t\t\t\t\t\tfunc: 'link.unlink',\n\t\t\t\t\t\t\t\t\tobserve: {\n\t\t\t\t\t\t\t\t\t\telement: 'a',\n\t\t\t\t\t\t\t\t\t\tout: {\n\t\t\t\t\t\t\t\t\t\t\tattr: {\n\t\t\t\t\t\t\t\t\t\t\t\t'class': 'redactor-dropdown-link-inactive',\n\t\t\t\t\t\t\t\t\t\t\t\t'aria-disabled': true\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},\n\t\t\t\t\t\thorizontalrule:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: this.lang.get('horizontalrule'),\n\t\t\t\t\t\t\tfunc: 'line.insert'\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\t\t\t\t},\n\t\t\t\tsetFormatting: function()\n\t\t\t\t{\n\t\t\t\t\t$.each(this.toolbarsButtons.format.dropdown, $.proxy(function (i, s)\n\t\t\t\t\t{\n\t\t\t\t\t\tif ($.inArray(i, this.opts.formatting) === -1)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tdelete this.toolbarsButtons.format.dropdown[i];\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}, this));\n\n\t\t\t\t},\n\t\t\t\thideButtons: function()\n\t\t\t\t{\n\t\t\t\t\tif (this.opts.buttonsHide.length !== 0)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.button.hideButtonsSlicer(this.opts.buttonsHide);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\thideButtonsOnMobile: function()\n\t\t\t\t{\n\t\t\t\t\tif (this.detect.isMobile() && this.opts.buttonsHideOnMobile.length !== 0)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.button.hideButtonsSlicer(this.opts.buttonsHideOnMobile);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\thideButtonsSlicer: function(buttons)\n\t\t\t\t{\n\t\t\t\t\t$.each(buttons, $.proxy(function(i, s)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar index = this.opts.buttons.indexOf(s);\n\t\t\t\t\t\tif (index !== -1)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t    this.opts.buttons.splice(index, 1);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}, this));\n\t\t\t\t},\n\t\t\t\tload: function($toolbar)\n\t\t\t\t{\n\t\t\t\t\tthis.button.buttons = [];\n\n\t\t\t\t\t$.each(this.opts.buttons, $.proxy(function(i, btnName)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (!this.toolbarsButtons[btnName]\n\t\t\t\t\t\t\t|| (btnName === 'file' && !this.file.is())\n\t\t\t\t\t\t\t|| (btnName === 'image' && !this.image.is()))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t$toolbar.append($('<li>').append(this.button.build(btnName, this.toolbarsButtons[btnName])));\n\n\t\t\t\t\t}, this));\n\t\t\t\t},\n\t\t\t\tbuild: function(btnName, btnObject)\n\t\t\t\t{\n\t\t\t\t\tif (this.opts.toolbar === false)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar $button = $('<a href=\"javascript:void(null);\" class=\"re-button re-' + btnName + '\" title=\"' + btnObject.title + '\" rel=\"' + btnName + '\" />').html(btnObject.title);\n\t\t\t\t\t$button.attr({ 'role': 'button', 'aria-label': btnObject.title, 'tabindex': '-1' });\n\n\t\t\t\t\tif (typeof btnObject.label !== 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\t$button.attr('aria-label', btnObject.label);\n\t\t\t\t\t\t$button.attr('title', btnObject.label);\n\t\t\t\t\t}\n\n\t\t\t\t\t// click\n\t\t\t\t\tif (btnObject.func || btnObject.command || btnObject.dropdown)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.button.setEvent($button, btnName, btnObject);\n\t\t\t\t\t}\n\n\t\t\t\t\t// dropdown\n\t\t\t\t\tif (btnObject.dropdown)\n\t\t\t\t\t{\n\t\t\t\t\t\t$button.addClass('redactor-toolbar-link-dropdown').attr('aria-haspopup', true);\n\n\t\t\t\t\t\tvar $dropdown = $('<ul class=\"redactor-dropdown redactor-dropdown-' + this.uuid + ' redactor-dropdown-box-' + btnName + '\" style=\"display: none;\">');\n\t\t\t\t\t\t$button.data('dropdown', $dropdown);\n\t\t\t\t\t\tthis.dropdown.build(btnName, $dropdown, btnObject.dropdown);\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.button.buttons.push($button);\n\n\t\t\t\t\treturn $button;\n\t\t\t\t},\n\t\t\t\tgetButtons: function()\n\t\t\t\t{\n\t\t\t\t\treturn this.button.toolbar().find('a.re-button');\n\t\t\t\t},\n\t\t\t\tgetButtonsKeys: function()\n\t\t\t\t{\n\t\t\t\t\treturn this.button.buttons;\n\t\t\t\t},\n\t\t\t\tsetEvent: function($button, btnName, btnObject)\n\t\t\t\t{\n\t\t\t\t\t$button.on('mousedown', $.proxy(function(e)\n\t\t\t\t\t{\n\t\t\t\t\t\te.preventDefault();\n\n\t\t\t\t\t\tif ($button.hasClass('redactor-button-disabled'))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tvar type = 'func';\n\t\t\t\t\t\tvar callback = btnObject.func;\n\n\t\t\t\t\t\tif (btnObject.command)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttype = 'command';\n\t\t\t\t\t\t\tcallback = btnObject.command;\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (btnObject.dropdown)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttype = 'dropdown';\n\t\t\t\t\t\t\tcallback = false;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tthis.button.toggle(e, btnName, type, callback);\n\n\t\t\t\t\t\treturn false;\n\n\t\t\t\t\t}, this));\n\t\t\t\t},\n\t\t\t\ttoggle: function(e, btnName, type, callback, args)\n\t\t\t\t{\n\n\t\t\t\t\tif (this.detect.isIe() || !this.detect.isDesktop())\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.utils.freezeScroll();\n\t\t\t\t\t\te.returnValue = false;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (type === 'command')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.inline.format(callback);\n\t\t\t\t\t}\n\t\t\t\t\telse if (type === 'dropdown')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.dropdown.show(e, btnName);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.button.clickCallback(e, callback, btnName, args);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (type !== 'dropdown')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.dropdown.hideAll(false);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.opts.air && type !== 'dropdown')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.air.hide(e);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.detect.isIe() || !this.detect.isDesktop())\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.utils.unfreezeScroll();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tclickCallback: function(e, callback, btnName, args)\n\t\t\t\t{\n\t\t\t\t\tvar func;\n\n\t\t\t\t\targs = (typeof args === 'undefined') ? btnName : args;\n\n\t\t\t\t\tif ($.isFunction(callback))\n\t\t\t\t\t{\n\t\t\t\t\t\tcallback.call(this, btnName);\n\t\t\t\t\t}\n\t\t\t\t\telse if (callback.search(/\\./) !== '-1')\n\t\t\t\t\t{\n\t\t\t\t\t\tfunc = callback.split('.');\n\t\t\t\t\t\tif (typeof this[func[0]] === 'undefined')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (typeof args === 'object')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis[func[0]][func[1]].apply(this, args);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis[func[0]][func[1]].call(this, args);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\n\t\t\t\t\t\tif (typeof args === 'object')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis[callback].apply(this, args);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis[callback].call(this, args);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.observe.buttons(e, btnName);\n\n\t\t\t\t},\n\t\t\t\tall: function()\n\t\t\t\t{\n\t\t\t\t\treturn this.button.buttons;\n\t\t\t\t},\n\t\t\t\tget: function(key)\n\t\t\t\t{\n\t\t\t\t\tif (this.opts.toolbar === false)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn this.button.toolbar().find('a.re-' + key);\n\t\t\t\t},\n\t\t\t\tset: function(key, title)\n\t\t\t\t{\n\t\t\t\t\tif (this.opts.toolbar === false)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar $btn = this.button.toolbar().find('a.re-' + key);\n\n\t\t\t\t\t$btn.html(title).attr('aria-label', title);\n\n\t\t\t\t\treturn $btn;\n\t\t\t\t},\n\t\t\t\tadd: function(key, title)\n\t\t\t\t{\n\t\t\t\t\tif (this.button.isAdded(key) !== true)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn $();\n\t\t\t\t\t}\n\n\t\t\t\t\tvar btn = this.button.build(key, { title: title });\n\n\t\t\t\t\tthis.button.toolbar().append($('<li>').append(btn));\n\n\t\t\t\t\treturn btn;\n\t\t\t\t},\n\t\t\t\taddFirst: function(key, title)\n\t\t\t\t{\n\t\t\t\t\tif (this.button.isAdded(key) !== true)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn $();\n\t\t\t\t\t}\n\n\t\t\t\t\tvar btn = this.button.build(key, { title: title });\n\n\t\t\t\t\tthis.button.toolbar().prepend($('<li>').append(btn));\n\n\t\t\t\t\treturn btn;\n\t\t\t\t},\n\t\t\t\taddAfter: function(afterkey, key, title)\n\t\t\t\t{\n\t\t\t\t\tif (this.button.isAdded(key) !== true)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn $();\n\t\t\t\t\t}\n\n\t\t\t\t\tvar btn = this.button.build(key, { title: title });\n\t\t\t\t\tvar $btn = this.button.get(afterkey);\n\n\t\t\t\t\tif ($btn.length !== 0)\n\t\t\t\t\t{\n\t\t\t\t\t\t$btn.parent().after($('<li>').append(btn));\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.button.toolbar().append($('<li>').append(btn));\n\t\t\t\t\t}\n\n\t\t\t\t\treturn btn;\n\t\t\t\t},\n\t\t\t\taddBefore: function(beforekey, key, title)\n\t\t\t\t{\n\t\t\t\t\tif (this.button.isAdded(key) !== true)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn $();\n\t\t\t\t\t}\n\n\t\t\t\t\tvar btn = this.button.build(key, { title: title });\n\t\t\t\t\tvar $btn = this.button.get(beforekey);\n\n\t\t\t\t\tif ($btn.length !== 0)\n\t\t\t\t\t{\n\t\t\t\t\t\t$btn.parent().before($('<li>').append(btn));\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.button.toolbar().append($('<li>').append(btn));\n\t\t\t\t\t}\n\n\t\t\t\t\treturn btn;\n\t\t\t\t},\n\t\t\t\tisAdded: function(key)\n\t\t\t\t{\n\t                var index = this.opts.buttonsHideOnMobile.indexOf(key);\n                    if (this.opts.toolbar === false || (index !== -1 && this.detect.isMobile()))\n                    {\n\t\t\t\t\t    return false;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t\tsetIcon: function($btn, icon)\n\t\t\t\t{\n\t\t\t\t\t$btn.html(icon);\n\t\t\t\t},\n\t\t\t\taddCallback: function($btn, callback)\n\t\t\t\t{\n\t\t\t\t\tif (typeof $btn === 'undefined' || this.opts.toolbar === false)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar type = (callback === 'dropdown') ? 'dropdown' : 'func';\n\t\t\t\t\tvar key = $btn.attr('rel');\n\t\t\t\t\t$btn.on('mousedown', $.proxy(function(e)\n\t\t\t\t\t{\n\t\t\t\t\t\tif ($btn.hasClass('redactor-button-disabled'))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tthis.button.toggle(e, key, type, callback);\n\n\t\t\t\t\t}, this));\n\t\t\t\t},\n\t\t\t\taddDropdown: function($btn, dropdown)\n\t\t\t\t{\n\t\t\t\t\tif (this.opts.toolbar === false)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\t$btn.addClass('redactor-toolbar-link-dropdown').attr('aria-haspopup', true);\n\n\t\t\t\t\tvar key = $btn.attr('rel');\n\t\t\t\t\tthis.button.addCallback($btn, 'dropdown');\n\n\t\t\t\t\tvar $dropdown = $('<div class=\"redactor-dropdown redactor-dropdown-' + this.uuid + ' redactor-dropdown-box-' + key + '\" style=\"display: none;\">');\n\t\t\t\t\t$btn.data('dropdown', $dropdown);\n\n\t\t\t\t\t// build dropdown\n\t\t\t\t\tif (dropdown)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.dropdown.build(key, $dropdown, dropdown);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn $dropdown;\n\t\t\t\t},\n\t\t\t\tsetActive: function(key)\n\t\t\t\t{\n\t\t\t\t\tthis.button.get(key).addClass('redactor-act');\n\t\t\t\t},\n\t\t\t\tsetInactive: function(key)\n\t\t\t\t{\n\t\t\t\t\tthis.button.get(key).removeClass('redactor-act');\n\t\t\t\t},\n\t\t\t\tsetInactiveAll: function(key)\n\t\t\t\t{\n\t\t\t\t\tvar $btns = this.button.toolbar().find('a.re-button');\n\n\t\t\t\t\tif (typeof key !== 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\t$btns = $btns.not('.re-' + key);\n\t\t\t\t\t}\n\n\t\t\t\t\t$btns.removeClass('redactor-act');\n\t\t\t\t},\n\t\t\t\tdisable: function(key)\n\t\t\t\t{\n\t\t\t\t\tthis.button.get(key).addClass('redactor-button-disabled');\n\t\t\t\t},\n\t\t\t\tenable: function(key)\n\t\t\t\t{\n\t\t\t\t\tthis.button.get(key).removeClass('redactor-button-disabled');\n\t\t\t\t},\n\t\t\t\tdisableAll: function(key)\n\t\t\t\t{\n\t\t\t\t\tvar $btns = this.button.toolbar().find('a.re-button');\n\t\t\t\t\tif (typeof key !== 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\t$btns = $btns.not('.re-' + key);\n\t\t\t\t\t}\n\n\t\t\t\t\t$btns.addClass('redactor-button-disabled');\n\t\t\t\t},\n\t\t\t\tenableAll: function()\n\t\t\t\t{\n\t\t\t\t\tthis.button.toolbar().find('a.re-button').removeClass('redactor-button-disabled');\n\t\t\t\t},\n\t\t\t\tremove: function(key)\n\t\t\t\t{\n\t\t\t\t\tthis.button.get(key).remove();\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =caret\n\t\tcaret: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tset: function(node1, node2, end)\n\t\t\t\t{\n\t\t\t\t\tthis.core.editor().focus();\n\n\t\t\t\t\tend = (typeof end === 'undefined') ? 0 : 1;\n\n\t\t\t\t\tnode1 = node1[0] || node1;\n\t\t\t\t\tnode2 = node2[0] || node2;\n\n\t\t\t\t\tvar sel = this.selection.get();\n\t\t\t\t\tvar range = this.selection.range(sel);\n\n\t\t\t\t\ttry\n\t\t\t\t\t{\n\t\t\t\t\t\trange.setStart(node1, 0);\n\t\t\t\t\t\trange.setEnd(node2, end);\n\t\t\t\t\t}\n\t\t\t\t\tcatch (e) {}\n\n\t\t\t\t\tthis.selection.update(sel, range);\n\t\t\t\t},\n\t\t\t\tprepare: function(node)\n\t\t\t\t{\n\t\t\t\t\t// firefox focus\n\t\t\t\t\tif (this.detect.isFirefox() && typeof this.start !== 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.editor().focus();\n\t\t\t\t\t}\n\n\t\t\t\t\treturn node[0] || node;\n\t\t\t\t},\n\t\t\t\tstart: function(node)\n\t\t\t\t{\n\n\t\t\t\t\tvar sel, range;\n\t\t\t\t\tnode = this.caret.prepare(node);\n\n\t\t\t\t\tif (!node)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (node.tagName === 'BR')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn this.caret.before(node);\n\t\t\t\t\t}\n\n\t\t\t\t\t// empty or inline tag\n\t\t\t\t\tvar inline = this.utils.isInlineTag(node.tagName);\n\t\t\t\t\tif (node.innerHTML === '' || inline)\n\t\t\t\t\t{\n                        sel = window.getSelection();\n\t\t\t\t\t    range = document.createRange();\n\t\t\t\t\t\tvar textNode = document.createTextNode('\\u200B');\n\n\t\t\t\t\t\trange.setStart(node, 0);\n\t\t\t\t\t\trange.insertNode(textNode);\n\t\t\t\t\t\trange.setStartAfter(textNode);\n\t\t\t\t\t\trange.collapse(true);\n\n\t\t\t\t\t\tsel.removeAllRanges();\n\t\t\t\t\t\tsel.addRange(range);\n\n\t\t\t\t\t\t// remove invisible text node\n\t\t\t\t\t\tif (!inline)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.core.editor().on('keydown.redactor-remove-textnode', function()\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t$(textNode).remove();\n\t\t\t\t\t\t\t\t$(this).off('keydown.redactor-remove-textnode');\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t// block tag\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tsel = window.getSelection();\n\t\t\t\t\t\tsel.removeAllRanges();\n\n\t\t\t\t\t\trange = document.createRange();\n\t\t\t\t\t\trange.selectNodeContents(node);\n\t\t\t\t\t\trange.collapse(true);\n\t\t\t\t\t\tsel.addRange(range);\n\t\t\t\t\t}\n\n\n\t\t\t\t},\n\t\t\t\tend: function(node)\n\t\t\t\t{\n\t\t\t\t\tvar sel, range;\n\t\t\t\t\tnode = this.caret.prepare(node);\n\n\t\t\t\t\tif (!node)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\t// empty node\n\t\t\t\t\tif (node.tagName !== 'BR' && node.innerHTML === '')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn this.caret.start(node);\n\t\t\t\t\t}\n\n\t\t\t\t\t// br\n\t\t\t\t\tif (node.tagName === 'BR')\n\t\t\t\t\t{\n\t\t\t\t\t\tvar space = document.createElement('span');\n\t\t\t\t\t\tspace.className = 'redactor-invisible-space';\n\t\t\t\t\t\tspace.innerHTML = '&#x200b;';\n\n\t\t\t\t\t\t$(node).after(space);\n\n\t\t\t\t\t\tsel = window.getSelection();\n\t\t\t\t\t\tsel.removeAllRanges();\n\n\t\t\t\t\t\trange = document.createRange();\n\n\t\t\t\t\t\trange.setStartBefore(space);\n\t\t\t\t\t\trange.setEndBefore(space);\n\t\t\t\t\t\tsel.addRange(range);\n\n\t\t\t\t\t\t$(space).replaceWith(function()\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn $(this).contents();\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (node.lastChild && node.lastChild.nodeType === 1)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn this.caret.after(node.lastChild);\n\t\t\t\t\t}\n\n\t\t\t\t\tsel = window.getSelection();\n\t\t\t\t\tsel.removeAllRanges();\n\n\t\t\t\t\trange = document.createRange();\n\t\t\t\t\trange.selectNodeContents(node);\n\t\t\t\t\trange.collapse(false);\n\t\t\t\t\tsel.addRange(range);\n\t\t\t\t},\n\t\t\t\tafter: function(node)\n\t\t\t\t{\n\t\t\t\t\tvar sel, range;\n\t\t\t\t\tnode = this.caret.prepare(node);\n\n\n\t\t\t\t\tif (!node)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (node.tagName === 'BR')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn this.caret.end(node);\n\t\t\t\t\t}\n\n\t\t\t\t\t// block tag\n\t\t\t\t\tif (this.utils.isBlockTag(node.tagName))\n\t\t\t\t\t{\n\t\t\t\t\t\tvar next = this.caret.next(node);\n\n\t\t\t\t\t\tif (typeof next === 'undefined')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.caret.end(node);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t// table\n\t\t\t\t\t\t\tif (next.tagName === 'TABLE')\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tnext = $(next).find('th, td').first()[0];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t// list\n\t\t\t\t\t\t\telse if (next.tagName === 'UL' || next.tagName === 'OL')\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tnext = $(next).find('li').first()[0];\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tthis.caret.start(next);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\t// inline tag\n\t\t\t\t\tvar textNode = document.createTextNode('\\u200B');\n\n\t\t\t\t\tsel = window.getSelection();\n\t\t\t\t\tsel.removeAllRanges();\n\n\t\t\t\t\trange = document.createRange();\n\t\t\t\t\trange.setStartAfter(node);\n\t\t\t\t\trange.insertNode(textNode);\n\t\t\t\t\trange.setStartAfter(textNode);\n\t\t\t\t\trange.collapse(true);\n\n\t\t\t\t\tsel.addRange(range);\n\n\t\t\t\t},\n\t\t\t\tbefore: function(node)\n\t\t\t\t{\n\t\t\t\t\tvar sel, range;\n\t\t\t\t\tnode = this.caret.prepare(node);\n\n\n\t\t\t\t\tif (!node)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\t// block tag\n\t\t\t\t\tif (this.utils.isBlockTag(node.tagName))\n\t\t\t\t\t{\n\t\t\t\t\t\tvar prev = this.caret.prev(node);\n\n\t\t\t\t\t\tif (typeof prev === 'undefined')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.caret.start(node);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t// table\n\t\t\t\t\t\t\tif (prev.tagName === 'TABLE')\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tprev = $(prev).find('th, td').last()[0];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t// list\n\t\t\t\t\t\t\telse if (prev.tagName === 'UL' || prev.tagName === 'OL')\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tprev = $(prev).find('li').last()[0];\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tthis.caret.end(prev);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\t// inline tag\n\t\t\t\t\tsel = window.getSelection();\n\t\t\t\t\tsel.removeAllRanges();\n\n\t\t\t\t\trange = document.createRange();\n\n\t\t\t        range.setStartBefore(node);\n\t\t\t        range.collapse(true);\n\n\t\t\t        sel.addRange(range);\n\t\t\t\t},\n\t\t\t\tnext: function(node)\n\t\t\t\t{\n\t\t\t\t\tvar $next = $(node).next();\n\t\t\t\t\tif ($next.hasClass('redactor-script-tag, redactor-selection-marker'))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn $next.next()[0];\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\treturn $next[0];\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tprev: function(node)\n\t\t\t\t{\n\t\t\t\t\tvar $prev = $(node).prev();\n\t\t\t\t\tif ($prev.hasClass('redactor-script-tag, redactor-selection-marker'))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn $prev.prev()[0];\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\treturn $prev[0];\n\t\t\t\t\t}\n\t\t\t\t},\n\n\t\t\t\t// #backward\n\t\t\t\toffset: function(node)\n\t\t\t\t{\n\t\t\t\t\treturn this.offset.get(node);\n\t\t\t\t}\n\n\t\t\t};\n\t\t},\n\n\t\t// =clean\n\t\tclean: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tonSet: function(html)\n\t\t\t\t{\n\t\t\t\t\thtml = this.clean.savePreCode(html);\n\t\t\t\t\thtml = this.clean.saveFormTags(html);\n\n\t\t\t\t\t// convert script tag\n\t\t\t\t\tif (this.opts.script)\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = html.replace(/<script(.*?[^>]?)>([\\w\\W]*?)<\\/script>/gi, '<pre class=\"redactor-script-tag\" $1>$2</pre>');\n\t\t\t\t\t}\n\n\t\t\t\t\t// converting entity\n\t\t\t\t\thtml = html.replace(/\\$/g, '&#36;');\n\t\t\t\t\thtml = html.replace(/&amp;/g, '&');\n\n\t\t\t\t\t// replace special characters in links\n\t\t\t\t\thtml = html.replace(/<a href=\"(.*?[^>]?)(.*?[^>]?)\">/gi, '<a href=\"$1&reg$2\">');\n\n\t\t\t\t\t// save markers\n\t\t\t\t\thtml = html.replace(/<span(.*?[^>]?)id=\"selection-marker-1\"(.*?[^>]?)><\\/span>/gi, '[[[marker1]]]');\n\t\t\t\t\thtml = html.replace(/<span(.*?[^>]?)id=\"selection-marker-2\"(.*?[^>]?)><\\/span>/gi, '[[[marker2]]]');\n\n\t\t\t\t\t// replace tags\n\t\t\t\t\tvar self = this;\n\t\t\t\t\tvar $div = $(\"<div/>\").html($.parseHTML(html, document, true));\n\n\t\t\t\t\tvar replacement = this.opts.replaceTags;\n\t\t\t\t\tif (replacement)\n\t\t\t\t\t{\n                        var keys = Object.keys(this.opts.replaceTags);\n    \t\t\t\t\t$div.find(keys.join(',')).each(function(i,s)\n    \t\t\t\t\t{\n    \t\t\t\t\t\tself.utils.replaceToTag(s, replacement[s.tagName.toLowerCase()]);\n    \t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\thtml = $div.html();\n\n\t\t\t\t\t// remove tags\n\t\t\t\t\tvar tags = ['font', 'html', 'head', 'link', 'body', 'meta', 'applet'];\n\t\t\t\t\tif (!this.opts.script)\n\t\t\t\t\t{\n\t\t\t\t\t\ttags.push('script');\n\t\t\t\t\t}\n\n\t\t\t\t\thtml = this.clean.stripTags(html, tags);\n\n\t\t\t\t\t// remove html comments\n\t\t\t\t\tif (this.opts.removeComments)\n\t\t\t\t\t{\n\t\t\t\t\t    html = html.replace(/<!--[\\s\\S]*?-->/gi, '');\n\t\t\t\t\t}\n\n\t\t\t\t\t// paragraphize\n\t\t\t\t\thtml = this.paragraphize.load(html);\n\n\t\t\t\t\t// restore markers\n\t\t\t\t\thtml = html.replace('[[[marker1]]]', '<span id=\"selection-marker-1\" class=\"redactor-selection-marker\"></span>');\n\t\t\t\t\thtml = html.replace('[[[marker2]]]', '<span id=\"selection-marker-2\" class=\"redactor-selection-marker\"></span>');\n\n\t\t\t\t\t// empty\n\t\t\t\t\tif (html.search(/^(||\\s||<br\\s?\\/?>||&nbsp;)$/i) !== -1)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn this.opts.emptyHtml;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn html;\n\t\t\t\t},\n\t\t\t\tonGet: function(html)\n\t\t\t\t{\n\t\t\t\t\treturn this.clean.onSync(html);\n\t\t\t\t},\n\t\t\t\tonSync: function(html)\n\t\t\t\t{\n\t\t\t\t\t// remove invisible spaces\n\t\t\t\t\thtml = html.replace(/\\u200B/g, '');\n\t\t\t\t\thtml = html.replace(/&#x200b;/gi, '');\n\t\t\t\t\t//html = html.replace(/&nbsp;&nbsp;/gi, '&nbsp;');\n\n\t\t\t\t\tif (html.search(/^<p>(||\\s||<br\\s?\\/?>||&nbsp;)<\\/p>$/i) !== -1)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn '';\n\t\t\t\t\t}\n\n\n\t\t\t\t\t// remove image resize\n\t\t\t\t\thtml = html.replace(/<span(.*?)id=\"redactor-image-box\"(.*?[^>])>([\\w\\W]*?)<img(.*?)><\\/span>/gi, '$3<img$4>');\n\t\t\t\t\thtml = html.replace(/<span(.*?)id=\"redactor-image-resizer\"(.*?[^>])>(.*?)<\\/span>/gi, '');\n\t\t\t\t\thtml = html.replace(/<span(.*?)id=\"redactor-image-editter\"(.*?[^>])>(.*?)<\\/span>/gi, '');\n\t\t\t\t\thtml = html.replace(/<img(.*?)style=\"(.*?)opacity: 0\\.5;(.*?)\"(.*?)>/gi, '<img$1style=\"$2$3\"$4>');\n\n\t\t\t\t\tvar $div = $(\"<div/>\").html($.parseHTML(html, document, true));\n\n\t\t\t\t\t// remove empty atributes\n\t\t\t\t\t$div.find('*[style=\"\"]').removeAttr('style');\n\t\t\t\t\t$div.find('*[class=\"\"]').removeAttr('class');\n\t\t\t\t\t$div.find('*[rel=\"\"]').removeAttr('rel');\n\n\t\t\t\t\t// remove markers\n\t\t\t\t\t$div.find('.redactor-invisible-space').each(function()\n\t\t\t\t\t{\n\t\t\t\t\t\t$(this).contents().unwrap();\n\t\t\t\t\t});\n\n\t\t\t\t\t// remove span without attributes\n\t\t\t\t    $div.find('span').each(function()\n\t\t\t\t\t{\n    \t\t\t\t\tif (this.attributes.length === 0)\n    \t\t\t\t\t{\n\t\t\t\t\t\t    $(this).contents().unwrap();\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\n\t\t\t\t\t// remove rel attribute from img\n\t\t\t\t\t$div.find('img').removeAttr('rel');\n\n\t\t\t\t\t$div.find('.redactor-selection-marker, #redactor-insert-marker').remove();\n\n\t\t\t\t\thtml = $div.html();\n\n\t\t\t\t\t// reconvert script tag\n\t\t\t\t\tif (this.opts.script)\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = html.replace(/<pre class=\"redactor-script-tag\"(.*?[^>]?)>([\\w\\W]*?)<\\/pre>/gi, '<script$1>$2</script>');\n\t\t\t\t\t}\n\n\t\t\t\t\t// restore form tag\n\t\t\t\t\thtml = this.clean.restoreFormTags(html);\n\n\t\t\t\t\t// remove br in|of li/header tags\n\t\t\t\t\thtml = html.replace(new RegExp('<br\\\\s?/?></h', 'gi'), '</h');\n\t\t\t\t\thtml = html.replace(new RegExp('<br\\\\s?/?></li>', 'gi'), '</li>');\n\t\t\t\t\thtml = html.replace(new RegExp('</li><br\\\\s?/?>', 'gi'), '</li>');\n\n\n\t\t\t\t\t// pre class\n\t\t\t\t\thtml = html.replace(/<pre>/gi, \"<pre>\\n\");\n\t\t\t\t\tif (this.opts.preClass)\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = html.replace(/<pre>/gi, '<pre class=\"' + this.opts.preClass + '\">');\n\t\t\t\t\t}\n\n\t\t\t\t\t// link nofollow\n\t\t\t\t\tif (this.opts.linkNofollow)\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = html.replace(/<a(.*?)rel=\"nofollow\"(.*?[^>])>/gi, '<a$1$2>');\n\t\t\t\t\t\thtml = html.replace(/<a(.*?[^>])>/gi, '<a$1 rel=\"nofollow\">');\n\t\t\t\t\t}\n\n\t\t\t\t\t// replace special characters\n\t\t\t\t\tvar chars = {\n\t\t\t\t\t\t'\\u2122': '&trade;',\n\t\t\t\t\t\t'\\u00a9': '&copy;',\n\t\t\t\t\t\t'\\u2026': '&hellip;',\n\t\t\t\t\t\t'\\u2014': '&mdash;',\n\t\t\t\t\t\t'\\u2010': '&dash;'\n\t\t\t\t\t};\n\n\t\t\t\t\t$.each(chars, function(i,s)\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = html.replace(new RegExp(i, 'g'), s);\n\t\t\t\t\t});\n\n\t\t\t\t\thtml = html.replace(/&amp;/g, '&');\n\n\t\t\t\t\t// remove empty paragpraphs\n\t\t\t\t\thtml = html.replace(/<p><\\/p>/gi, \"\");\n\n\t\t\t\t\t// remove new lines\n                    html = html.replace(/\\n{2,}/g, \"\\n\");\n\n\t\t\t\t\treturn html;\n\t\t\t\t},\n\t\t\t\tonPaste: function(html, data, insert)\n\t\t\t\t{\n\t\t\t\t\t// if paste event\n\t\t\t\t\tif (insert !== true)\n\t\t\t\t\t{\n    \t\t\t\t\t// remove google docs markers\n                        html = html.replace(/<b\\sid=\"internal-source-marker(.*?)\">([\\w\\W]*?)<\\/b>/gi, \"$2\");\n    \t\t\t\t\thtml = html.replace(/<b(.*?)id=\"docs-internal-guid(.*?)\">([\\w\\W]*?)<\\/b>/gi, \"$3\");\n\n                        // google docs styles\n                        html = html.replace(/<span[^>]*(font-style: italic; font-weight: bold|font-weight: bold; font-style: italic)[^>]*>([\\w\\W]*?)<\\/span>/gi, '<b><i>$2</i></b>');\n                        html = html.replace(/<span[^>]*(font-style: italic; font-weight: 700|font-weight: 700; font-style: italic)[^>]*>([\\w\\W]*?)<\\/span>/gi, '<b><i>$2</i></b>');\n                        html = html.replace(/<span[^>]*font-style: italic[^>]*>([\\w\\W]*?)<\\/span>/gi, '<i>$1</i>');\n                        html = html.replace(/<span[^>]*font-weight: bold[^>]*>([\\w\\W]*?)<\\/span>/gi, '<b>$1</b>');\n                        html = html.replace(/<span[^>]*font-weight: 700[^>]*>([\\w\\W]*?)<\\/span>/gi, '<b>$1</b>');\n\n\t\t\t\t\t\tvar msword = this.clean.isHtmlMsWord(html);\n\t\t\t\t\t\tif (msword)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\thtml = this.clean.cleanMsWord(html);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\thtml = $.trim(html);\n\n\t\t\t\t\tif (data.pre)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (this.opts.preSpaces)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\thtml = html.replace(/\\t/g, new Array(this.opts.preSpaces + 1).join(' '));\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = this.clean.replaceBrToNl(html);\n\t\t\t\t\t\thtml = this.clean.removeTagsInsidePre(html);\n\t\t\t\t\t}\n\n\t\t\t\t\t// if paste event\n\t\t\t\t\tif (insert !== true)\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = this.clean.removeSpans(html);\n\t\t\t\t\t\thtml = this.clean.removeEmptyInlineTags(html);\n\n\n\t\t\t\t\t\tif (data.encode === false)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\thtml = html.replace(/&/g, '&amp;');\n\t\t\t\t\t\t\thtml = this.clean.convertTags(html, data);\n\t\t\t\t\t\t\thtml = this.clean.getPlainText(html);\n\t\t\t\t\t\t\thtml = this.clean.reconvertTags(html, data);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}\n\n\t\t\t\t\tif (data.text)\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = this.clean.replaceNbspToSpaces(html);\n\t\t\t\t\t\thtml = this.clean.getPlainText(html);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (data.lists)\n\t\t\t\t\t{\n    \t\t\t\t\thtml = html.replace(\"\\n\", '<br>');\n    \t\t\t\t}\n\n\t\t\t\t\tif (data.encode)\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = this.clean.encodeHtml(html);\n\t\t\t\t\t}\n\n\n\t\t\t\t\tif (data.paragraphize)\n\t\t\t\t\t{\n\n\t\t\t\t\t\thtml = this.paragraphize.load(html);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn html;\n\n\t\t\t\t},\n\t\t\t\tgetCurrentType: function(html, insert)\n\t\t\t\t{\n\t\t\t\t\tvar blocks = this.selection.blocks();\n\n\t\t\t\t\tvar data = {\n\t\t\t\t\t\ttext: false,\n\t\t\t\t\t\tencode: false,\n\t\t\t\t\t\tparagraphize: true,\n\t\t\t\t\t\tline: this.clean.isHtmlLine(html),\n\t\t\t\t\t\tblocks: this.clean.isHtmlBlocked(html),\n\t\t\t\t\t\tpre: false,\n\t\t\t\t\t\tlists: false,\n\t\t\t\t\t\tblock: true,\n\t\t\t\t\t\tinline: true,\n\t\t\t\t\t\tlinks: true,\n\t\t\t\t\t\timages: true\n\t\t\t\t\t};\n\n\t\t\t\t\tif (blocks.length === 1 && this.utils.isCurrentOrParent(['h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'a', 'figcaption']))\n\t\t\t\t\t{\n\t\t\t\t\t\tdata.text = true;\n\t\t\t\t\t\tdata.paragraphize = false;\n\t\t\t\t\t\tdata.inline = false;\n\t\t\t\t\t\tdata.images = false;\n\t\t\t\t\t\tdata.links = false;\n\t\t\t\t\t\tdata.line = true;\n\t\t\t\t\t}\n\t\t\t\t\telse if (this.opts.type === 'inline' || this.opts.enterKey === false)\n\t\t\t\t\t{\n\t\t\t\t\t\tdata.paragraphize = false;\n\t\t\t\t\t\tdata.block = false;\n\t\t\t\t\t\tdata.line = true;\n\t\t\t\t\t}\n\t\t\t\t\telse if (blocks.length === 1 && this.utils.isCurrentOrParent(['li']))\n\t\t\t\t\t{\n\t\t\t\t\t\tdata.lists = true;\n\t\t\t\t\t\tdata.block = false;\n\t\t\t\t\t\tdata.paragraphize = false;\n\t\t\t\t\t\tdata.images = false;\n\t\t\t\t\t}\n\t\t\t\t\telse if (blocks.length === 1 && this.utils.isCurrentOrParent(['th', 'td', 'blockquote']))\n\t\t\t\t\t{\n\t\t\t\t\t\tdata.block = false;\n\t\t\t\t\t\tdata.paragraphize = false;\n\n\t\t\t\t\t}\n\t\t\t\t\telse if (this.opts.type === 'pre' || (blocks.length === 1 && this.utils.isCurrentOrParent('pre')))\n\t\t\t\t\t{\n\t\t\t\t\t\tdata.inline = false;\n\t\t\t\t\t\tdata.block = false;\n\t\t\t\t\t\tdata.encode = true;\n\t\t\t\t\t\tdata.pre = true;\n\t\t\t\t\t\tdata.paragraphize = false;\n\t\t\t\t\t\tdata.images = false;\n\t\t\t\t\t\tdata.links = false;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (data.line === true)\n\t\t\t\t\t{\n\t\t\t\t\t\tdata.paragraphize = false;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (insert === true)\n\t\t\t\t\t{\n\t\t\t\t\t\tdata.text = false;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn data;\n\n\t\t\t\t},\n\t\t\t\tisHtmlBlocked: function(html)\n\t\t\t\t{\n\t\t\t\t\tvar match1 = html.match(new RegExp('</(' + this.opts.blockTags.join('|' ).toUpperCase() + ')>', 'gi'));\n\t\t\t\t\tvar match2 = html.match(new RegExp('<hr(.*?[^>])>', 'gi'));\n\n\t\t\t\t\treturn (match1 === null && match2 === null) ? false : true;\n\t\t\t\t},\n\t\t\t\tisHtmlLine: function(html)\n\t\t\t\t{\n\t\t\t\t\tif (this.clean.isHtmlBlocked(html))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar matchBR = html.match(/<br\\s?\\/?>/gi);\n\t\t\t\t\tvar matchNL = html.match(/\\n/gi);\n\n\t\t\t\t\treturn (!matchBR && !matchNL) ? true : false;\n\t\t\t\t},\n\t\t\t\tisHtmlMsWord: function(html)\n\t\t\t\t{\n\t\t\t\t\treturn html.match(/class=\"?Mso|style=\"[^\"]*\\bmso-|style='[^'']*\\bmso-|w:WordDocument/i);\n\t\t\t\t},\n\t\t\t\tremoveEmptyInlineTags: function(html)\n\t\t\t\t{\n\t\t\t\t\tvar tags = this.opts.inlineTags;\n\t\t\t\t\tvar len = tags.length;\n\t\t\t\t\tfor (var i = 0; i < len; i++)\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = html.replace(new RegExp('<' + tags[i] + '[^>]*>(\\s\\n|\\t)?</' + tags[i] + '>', 'gi'), '');\n\t\t\t\t\t}\n\n\t\t\t\t\treturn html;\n\t\t\t\t},\n\t\t\t\tremoveSpans: function(html)\n\t\t\t\t{\n\t\t\t\t\thtml = html.replace(/<\\/span>/gi, '');\n\t\t\t\t\thtml = html.replace(/<span[^>]*>/gi, '');\n\n\t\t\t\t\treturn html;\n\t\t\t\t},\n\t\t\t\tcleanMsWord: function(html)\n\t\t\t\t{\n    \t\t\t\thtml = html.replace(/<!--[\\s\\S]*?-->/g, \"\");\n    \t\t\t\thtml = html.replace(/<o:p>[\\s\\S]*?<\\/o:p>/gi, '');\n\t\t\t\t\thtml = html.replace(/\\n/g, \" \");\n\t\t\t\t\thtml = html.replace(/<br\\s?\\/?>|<\\/p>|<\\/div>|<\\/li>|<\\/td>/gi, '\\n\\n');\n\n\t\t\t\t\t// lists\n\t\t\t\t\tvar $div = $(\"<div/>\").html(html);\n\n\t\t\t\t\tvar lastList = false;\n\t\t\t\t\tvar lastLevel = 1;\n\t\t\t\t\tvar listsIds = [];\n\n\t\t\t\t\t$div.find(\"p[style]\").each(function()\n\t\t\t\t\t{\n\t\t\t\t\t\tvar matches = $(this).attr('style').match(/mso\\-list\\:l([0-9]+)\\slevel([0-9]+)/);\n\n\t\t\t\t\t\tif (matches)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar currentList = parseInt(matches[1]);\n\t\t\t\t\t\t\tvar currentLevel = parseInt(matches[2]);\n\t\t\t\t\t\t\tvar listType = $(this).html().match(/^[\\w]+\\./) ? \"ol\" : \"ul\";\n\n\t\t\t\t\t\t\tvar $li = $(\"<li/>\").html($(this).html());\n\n\t\t\t\t\t\t\t$li.html($li.html().replace(/^([\\w\\.]+)</, '<'));\n\t\t\t\t\t\t\t$li.find(\"span:first\").remove();\n\n\t\t\t\t\t\t\tif (currentLevel == 1 && $.inArray(currentList, listsIds) == -1)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tvar $list = $(\"<\" + listType + \"/>\").attr({\"data-level\": currentLevel, \"data-list\": currentList}).html($li);\n\t\t\t\t\t\t\t\t$(this).replaceWith($list);\n\n\t\t\t\t\t\t\t\tlastList = currentList;\n\t\t\t\t\t\t\t\tlistsIds.push(currentList);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tif (currentLevel > lastLevel)\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tvar $prevList = $div.find('[data-level=\"' + lastLevel + '\"][data-list=\"' + lastList + '\"]');\n\t\t\t\t\t\t\t\t\tvar $lastList = $prevList;\n\n\t\t\t\t\t\t\t\t\tfor(var i = lastLevel; i < currentLevel; i++)\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t$list = $(\"<\" + listType + \"/>\");\n\t\t\t\t\t\t\t\t\t\t$list.appendTo($lastList.find(\"li\").last());\n\n\t\t\t\t\t\t\t\t\t\t$lastList = $list;\n\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t$lastList.attr({\"data-level\": currentLevel, \"data-list\": currentList}).html($li);\n\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tvar $prevList = $div.find('[data-level=\"' + currentLevel + '\"][data-list=\"' + currentList + '\"]').last();\n\n\t\t\t\t\t\t\t\t\t$prevList.append($li);\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tlastLevel = currentLevel;\n\t\t\t\t\t\t\t\tlastList = currentList;\n\n\t\t\t\t\t\t\t\t$(this).remove();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\n\t\t\t\t\t$div.find('[data-level][data-list]').removeAttr('data-level data-list');\n\t\t\t\t\thtml = $div.html();\n\n\t\t\t\t\treturn html;\n\t\t\t\t},\n\t\t\t\treplaceNbspToSpaces: function(html)\n\t\t\t\t{\n\t\t\t\t\treturn html.replace('&nbsp;', ' ');\n\t\t\t\t},\n\t\t\t\treplaceBrToNl: function(html)\n\t\t\t\t{\n\t\t\t\t\treturn html.replace(/<br\\s?\\/?>/gi, '\\n');\n\t\t\t\t},\n\t\t\t\treplaceNlToBr: function(html)\n\t\t\t\t{\n\t\t\t\t\treturn html.replace(/\\n/g, '<br />');\n\t\t\t\t},\n\t\t\t\tconvertTags: function(html, data)\n\t\t\t\t{\n                    var $div = $('<div>').html(html);\n\n                    // remove iframe\n\t\t\t\t\t$div.find('iframe').remove();\n\n\t\t\t\t\t// link target & attrs\n\t\t\t\t\tvar $links = $div.find('a');\n\t\t\t\t\t$links.removeAttr('style');\n\t\t\t\t\tif (this.opts.pasteLinkTarget !== false)\n\t\t\t\t\t{\n    \t\t\t\t\t$links.attr('target', this.opts.pasteLinkTarget);\n\t\t\t\t\t}\n\n\t\t\t\t\thtml = $div.html();\n\n\n                    // links & images\n\t\t\t\t\tif (data.links && this.opts.pasteLinks)\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = html.replace(/<a(.*?)href=\"(.*?[^>])\"(.*?[^>])>(.*?)<\\/a>/gi, '##%a$1href=\"$2\"$3%##$4##%/a%##');\n\t\t\t\t\t}\n\n\t\t\t\t\tif (data.images && this.opts.pasteImages)\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = html.replace(/<img(.*?)src=\"(.*?)\"(.*?[^>])>/gi, '##%img$1src=\"$2\"$3%##');\n\t\t\t\t\t}\n\n\t\t\t\t\t// plain text\n\t\t\t\t\tif (this.opts.pastePlainText)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn html;\n\t\t\t\t\t}\n\n\n\n\t\t\t\t\t// all tags\n\t\t\t\t\tvar blockTags = (data.lists) ? ['ul', 'ol', 'li'] : this.opts.pasteBlockTags;\n\n\t\t\t\t\tvar tags;\n\t\t\t\t\tif (data.block || data.lists)\n\t\t\t\t\t{\n\t\t\t\t\t\ttags = (data.inline) ? blockTags.concat(this.opts.pasteInlineTags) : blockTags;\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\ttags = (data.inline) ? this.opts.pasteInlineTags : [];\n\t\t\t\t\t}\n\n\n\t\t\t\t\tvar len = tags.length;\n\t\t\t\t\tfor (var i = 0; i < len; i++)\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = html.replace(new RegExp('<\\/' + tags[i] + '>', 'gi'), '###/' + tags[i] + '###');\n\n\t\t\t\t\t\tif (tags[i] === 'td' || tags[i] === 'th')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\thtml = html.replace(new RegExp('<' + tags[i] + '(.*?[^>])((colspan|rowspan)=\"(.*?[^>])\")?(.*?[^>])>', 'gi'), '###' + tags[i] + ' $2###');\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\thtml = html.replace(new RegExp('<' + tags[i] + '[^>]*>', 'gi'), '###' + tags[i] + '###');\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\treturn html;\n\n\t\t\t\t},\n\t\t\t\treconvertTags: function(html, data)\n\t\t\t\t{\n\t\t\t\t\t// links & images\n\t\t\t\t\tif ((data.links && this.opts.pasteLinks) || (data.images && this.opts.pasteImages))\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = html.replace(new RegExp('##%', 'gi'), '<');\n\t\t\t\t\t\thtml = html.replace(new RegExp('%##', 'gi'), '>');\n                    }\n\n\t\t\t\t\t// plain text\n\t\t\t\t\tif (this.opts.pastePlainText)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn html;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar blockTags = (data.lists) ? ['ul', 'ol', 'li'] : this.opts.pasteBlockTags;\n\n\t\t\t\t\tvar tags;\n\t\t\t\t\tif (data.block || data.lists)\n\t\t\t\t\t{\n\t\t\t\t\t\ttags = (data.inline) ? blockTags.concat(this.opts.pasteInlineTags) : blockTags;\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\ttags = (data.inline) ? this.opts.pasteInlineTags : [];\n\t\t\t\t\t}\n\n\t\t\t\t\tvar len = tags.length;\n\t\t\t\t\tfor (var i = 0; i < len; i++)\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = html.replace(new RegExp('###\\/' + tags[i] + '###', 'gi'), '</' + tags[i] + '>');\n\t\t\t\t\t\thtml = html.replace(new RegExp('###' + tags[i] + '###', 'gi'), '<' + tags[i] + '>');\n                    }\n\n\t\t\t\t\tfor (var i = 0; i < len; i++)\n\t\t\t\t\t{\n                        if (tags[i] === 'td' || tags[i] === 'th')\n                        {\n\t\t\t\t\t\t    html = html.replace(new RegExp('###' + tags[i] + '\\s?(.*?[^#])###', 'gi'), '<' + tags[i] + '$1>');\n                        }\n                    }\n\n\t\t\t\t\treturn html;\n\n\t\t\t\t},\n\t\t\t\tcleanPre: function(block)\n\t\t\t\t{\n\t\t\t\t\tblock = (typeof block === 'undefined') ? $(this.selection.block()).closest('pre', this.core.editor()[0]) : block;\n\n\t\t\t\t\t$(block).find('br').replaceWith(function()\n\t\t\t\t\t{\n\t\t\t\t\t\treturn document.createTextNode('\\n');\n\t\t\t\t\t});\n\n\t\t\t\t\t$(block).find('p').replaceWith(function()\n\t\t\t\t\t{\n\t\t\t\t\t\treturn $(this).contents();\n\t\t\t\t\t});\n\n\t\t\t\t},\n\t\t\t\tremoveTagsInsidePre: function(html)\n\t\t\t\t{\n\t\t\t\t\tvar $div = $('<div />').append(html);\n\t\t\t\t\t$div.find('pre').replaceWith(function()\n\t\t\t\t\t{\n\t\t\t\t\t\tvar str = $(this).html();\n\t\t\t\t\t\tstr = str.replace(/<br\\s?\\/?>|<\\/p>|<\\/div>|<\\/li>|<\\/td>/gi, '\\n');\n\t\t\t\t\t\tstr = str.replace(/(<([^>]+)>)/gi, '');\n\n\t\t\t\t\t\treturn $('<pre />').append(str);\n\t\t\t\t\t});\n\n\t\t\t\t\thtml = $div.html();\n\t\t\t\t\t$div.remove();\n\n\t\t\t\t\treturn html;\n\n\t\t\t\t},\n\t\t\t\tgetPlainText: function(html)\n\t\t\t\t{\n\t\t\t\t\thtml = html.replace(/<!--[\\s\\S]*?-->/gi, '');\n\t\t\t\t\thtml = html.replace(/<style[\\s\\S]*?style>/gi, '');\n\t\t\t\t\thtml = html.replace(/<\\/p>|<\\/div>|<\\/li>|<\\/td>/gi, '\\n');\n\t\t\t\t\thtml = html.replace(/<\\/H[1-6]>/gi, '\\n\\n');\n\n\t\t\t\t\tvar tmp = document.createElement('div');\n\t\t\t\t\ttmp.innerHTML = html;\n\t\t\t\t\thtml = tmp.textContent || tmp.innerText;\n\n\t\t\t\t\treturn $.trim(html);\n\t\t\t\t},\n\t\t\t\tsavePreCode: function(html)\n\t\t\t\t{\n\t\t\t\t\thtml = this.clean.savePreFormatting(html);\n\t\t\t\t\thtml = this.clean.saveCodeFormatting(html);\n\t\t\t\t\thtml = this.clean.restoreSelectionMarkers(html);\n\n\t\t\t\t\treturn html;\n\t\t\t\t},\n\t\t\t\tsavePreFormatting: function(html)\n\t\t\t\t{\n\t\t\t\t\tvar pre = html.match(/<pre(.*?)>([\\w\\W]*?)<\\/pre>/gi);\n\t\t\t\t\tif (pre === null)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn html;\n\t\t\t\t\t}\n\n\t\t\t\t\t$.each(pre, $.proxy(function(i,s)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar arr = s.match(/<pre(.*?)>([\\w\\W]*?)<\\/pre>/i);\n\n\t\t\t\t\t\tarr[2] = arr[2].replace(/<br\\s?\\/?>/g, '\\n');\n\t\t\t\t\t\tarr[2] = arr[2].replace(/&nbsp;/g, ' ');\n\n\t\t\t\t\t\tif (this.opts.preSpaces)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tarr[2] = arr[2].replace(/\\t/g, new Array(this.opts.preSpaces + 1).join(' '));\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tarr[2] = this.clean.encodeEntities(arr[2]);\n\n\t\t\t\t\t\t// $ fix\n\t\t\t\t\t\tarr[2] = arr[2].replace(/\\$/g, '&#36;');\n\n\t\t\t\t\t\thtml = html.replace(s, '<pre' + arr[1] + '>' + arr[2] + '</pre>');\n\n\t\t\t\t\t}, this));\n\n\t\t\t\t\treturn html;\n\t\t\t\t},\n\t\t\t\tsaveCodeFormatting: function(html)\n\t\t\t\t{\n\t\t\t\t\tvar code = html.match(/<code(.*?)>([\\w\\W]*?)<\\/code>/gi);\n\t\t\t\t\tif (code === null)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn html;\n\t\t\t\t\t}\n\n\t\t\t\t\t$.each(code, $.proxy(function(i,s)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar arr = s.match(/<code(.*?)>([\\w\\W]*?)<\\/code>/i);\n\n\t\t\t\t\t\tarr[2] = arr[2].replace(/&nbsp;/g, ' ');\n\t\t\t\t\t\tarr[2] = this.clean.encodeEntities(arr[2]);\n\t\t\t\t\t\tarr[2] = arr[2].replace(/\\$/g, '&#36;');\n\n\t\t\t\t\t\thtml = html.replace(s, '<code' + arr[1] + '>' + arr[2] + '</code>');\n\n\t\t\t\t\t}, this));\n\n\t\t\t\t\treturn html;\n\t\t\t\t},\n\t\t\t\trestoreSelectionMarkers: function(html)\n\t\t\t\t{\n\t\t\t\t\thtml = html.replace(/&lt;span id=&quot;selection-marker-([0-9])&quot; class=&quot;redactor-selection-marker&quot;&gt;&lt;\\/span&gt;/g, '<span id=\"selection-marker-$1\" class=\"redactor-selection-marker\"></span>');\n\n\t\t\t\t\treturn html;\n\t\t\t\t},\n\t\t\t\tsaveFormTags: function(html)\n\t\t\t\t{\n\t\t\t\t\treturn html.replace(/<form(.*?)>([\\w\\W]*?)<\\/form>/gi, '<section$1 rel=\"redactor-form-tag\">$2</section>');\n\t\t\t\t},\n\t\t\t\trestoreFormTags: function(html)\n\t\t\t\t{\n\t\t\t\t\treturn html.replace(/<section(.*?) rel=\"redactor-form-tag\"(.*?)>([\\w\\W]*?)<\\/section>/gi, '<form$1$2>$3</form>');\n\t\t\t\t},\n\t\t\t\tencodeHtml: function(html)\n\t\t\t\t{\n\t\t\t\t\thtml = html.replace(//g, '\"');\n\t\t\t\t\thtml = html.replace(//g, '\"');\n\t\t\t\t\thtml = html.replace(//g, '\\'');\n\t\t\t\t\thtml = html.replace(//g, '\\'');\n\t\t\t\t\thtml = this.clean.encodeEntities(html);\n\n\t\t\t\t\treturn html;\n\t\t\t\t},\n\t\t\t\tencodeEntities: function(str)\n\t\t\t\t{\n\t\t\t\t\tstr = String(str).replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&quot;/g, '\"');\n\t\t\t\t\tstr = str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\"/g, '&quot;');\n\n\t\t\t\t\treturn str;\n\t\t\t\t},\n\t\t\t\tstripTags: function(input, denied)\n\t\t\t\t{\n\t\t\t\t\tif (typeof denied === 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn input.replace(/(<([^>]+)>)/gi, '');\n\t\t\t\t\t}\n\n\t\t\t\t    var tags = /<\\/?([a-z][a-z0-9]*)\\b[^>]*>/gi;\n\n\t\t\t\t    return input.replace(tags, function ($0, $1)\n\t\t\t\t    {\n\t\t\t\t        return denied.indexOf($1.toLowerCase()) === -1 ? $0 : '';\n\t\t\t\t    });\n\t\t\t\t},\n\t\t\t\tremoveMarkers: function(html)\n\t\t\t\t{\n\t\t\t\t\treturn html.replace(/<span(.*?[^>]?)class=\"redactor-selection-marker\"(.*?[^>]?)>([\\w\\W]*?)<\\/span>/gi, '');\n\t\t\t\t},\n\t\t\t\tremoveSpaces: function(html)\n\t\t\t\t{\n\t\t\t\t\thtml = $.trim(html);\n\t\t\t\t\thtml = html.replace(/\\n/g, '');\n\t\t\t\t\thtml = html.replace(/[\\t]*/g, '');\n\t\t\t\t\thtml = html.replace(/\\n\\s*\\n/g, \"\\n\");\n\t\t\t\t\thtml = html.replace(/^[\\s\\n]*/g, ' ');\n\t\t\t\t\thtml = html.replace(/[\\s\\n]*$/g, ' ');\n\t\t\t\t\thtml = html.replace( />\\s{2,}</g, '> <'); // between inline tags can be only one space\n\t\t\t\t\thtml = html.replace(/\\n\\n/g, \"\\n\");\n\t\t\t\t\thtml = html.replace(/\\u200B/g, '');\n\n\t\t\t\t\treturn html;\n\t\t\t\t},\n\t\t\t\tremoveSpacesHard: function(html)\n\t\t\t\t{\n\t\t\t\t\thtml = $.trim(html);\n\t\t\t\t\thtml = html.replace(/\\n/g, '');\n\t\t\t\t\thtml = html.replace(/[\\t]*/g, '');\n\t\t\t\t\thtml = html.replace(/\\n\\s*\\n/g, \"\\n\");\n\t\t\t\t\thtml = html.replace(/^[\\s\\n]*/g, '');\n\t\t\t\t\thtml = html.replace(/[\\s\\n]*$/g, '');\n\t\t\t\t\thtml = html.replace( />\\s{2,}</g, '><');\n\t\t\t\t\thtml = html.replace(/\\n\\n/g, \"\\n\");\n\t\t\t\t\thtml = html.replace(/\\u200B/g, '');\n\n\t\t\t\t\treturn html;\n\t\t\t\t},\n\t\t\t\tnormalizeCurrentHeading: function()\n\t\t\t\t{\n\t\t\t\t\tvar heading = this.selection.block();\n\t\t\t\t\tif (this.utils.isCurrentOrParentHeader() && heading)\n\t\t\t\t\t{\n\t\t\t\t\t\theading.normalize();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =code\n\t\tcode: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tsyncFire: true,\n\t\t\t\thtml: false,\n\t\t\t\tstart: function(html)\n\t\t\t\t{\n\t\t\t\t\thtml = $.trim(html);\n\t\t\t\t\thtml = html.replace(/^(<span id=\"selection-marker-1\" class=\"redactor-selection-marker\"><\\/span>)/, '');\n\n\t\t\t\t\t// clean\n\t\t\t\t\tif (this.opts.type === 'textarea')\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = this.clean.onSet(html);\n\t\t\t\t\t}\n\t\t\t\t\telse if (this.opts.type === 'div' && html === '')\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = this.opts.emptyHtml;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.events.stopDetectChanges();\n\t\t\t\t\tthis.core.editor().html(html);\n\t\t\t\t\tthis.observe.load();\n\t\t\t\t\tthis.events.startDetectChanges();\n\t\t\t\t},\n\t\t\t\tset: function(html, options)\n\t\t\t\t{\n\t\t\t\t\thtml = $.trim(html);\n\n\n                    options = options || {};\n\n                    // start\n                    if (options.start)\n                    {\n                        this.start = options.start;\n                    }\n\n\t\t\t\t\t// clean\n\t\t\t\t\tif (this.opts.type === 'textarea')\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = this.clean.onSet(html);\n\t\t\t\t\t}\n\t\t\t\t\telse if (this.opts.type === 'div' && html === '')\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = this.opts.emptyHtml;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.core.editor().html(html);\n\n\t\t\t\t\tif (this.opts.type === 'textarea')\n\t\t\t\t\t{\n    \t\t\t\t\tthis.code.sync();\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.placeholder.enable();\n\t\t\t\t},\n\t\t\t\tget: function()\n\t\t\t\t{\n\t\t\t\t\tif (this.opts.type === 'textarea')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn this.core.textarea().val();\n                    }\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tvar html = this.core.editor().html();\n\n\t\t\t\t\t\t// clean\n\t\t\t\t\t\thtml = this.clean.onGet(html);\n\n\t\t\t\t\t\treturn html;\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tsync: function()\n\t\t\t\t{\n\t\t\t\t\tif (!this.code.syncFire)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar html = this.core.editor().html();\n\t\t\t\t\tvar htmlCleaned = this.code.cleaned(html);\n\n\t\t\t\t\t// is there a need to synchronize\n\t\t\t\t\tif (this.code.isSync(htmlCleaned))\n\t\t\t\t\t{\n\t\t\t\t\t\t// do not sync\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\t// save code\n\t\t\t\t\tthis.code.html = htmlCleaned;\n\n\t\t\t\t\tif (this.opts.type !== 'textarea')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.callback('sync', html);\n\t\t\t\t\t\tthis.core.callback('change', html);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.opts.type === 'textarea')\n\t\t\t\t\t{\n\t\t\t\t\t\tsetTimeout($.proxy(function()\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.code.startSync(html);\n\n\t\t\t\t\t\t}, this), 10);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tstartSync: function(html)\n\t\t\t\t{\n\t\t\t\t\t// before clean callback\n\t\t\t\t\thtml = this.core.callback('syncBefore', html);\n\n\t\t\t\t\t// clean\n\t\t\t\t\thtml = this.clean.onSync(html);\n\n\t\t\t\t\t// set code\n\t\t\t\t\tthis.core.textarea().val(html);\n\n\t\t\t\t\t// after sync callback\n\t\t\t\t\tthis.core.callback('sync', html);\n\n\t\t\t\t\t// change callback\n\t\t\t\t\tif (this.start === false)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.callback('change', html);\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.start = false;\n\t\t\t\t},\n\t\t\t\tisSync: function(htmlCleaned)\n\t\t\t\t{\n\t\t\t\t\tvar html = (this.code.html !== false) ? this.code.html : false;\n\n\t\t\t\t\treturn (html !== false && html === htmlCleaned);\n\t\t\t\t},\n\t\t\t\tcleaned: function(html)\n\t\t\t\t{\n\t\t\t\t\thtml = html.replace(/\\u200B/g, '');\n\t\t\t\t\treturn this.clean.removeMarkers(html);\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =core\n\t\tcore: function()\n\t\t{\n\t\t\treturn {\n\n\t\t\t\tid: function()\n\t\t\t\t{\n\t\t\t\t\treturn this.$editor.attr('id');\n\t\t\t\t},\n\t\t\t\telement: function()\n\t\t\t\t{\n\t\t\t\t\treturn this.$element;\n\t\t\t\t},\n\t\t\t\teditor: function()\n\t\t\t\t{\n\t\t\t\t\treturn (typeof this.$editor === 'undefined') ? $() : this.$editor;\n\t\t\t\t},\n\t\t\t\ttextarea: function()\n\t\t\t\t{\n\t\t\t\t\treturn this.$textarea;\n\t\t\t\t},\n\t\t\t\tbox: function()\n\t\t\t\t{\n\t\t\t\t\treturn (this.opts.type === 'textarea') ? this.$box : this.$element;\n\t\t\t\t},\n\t\t\t\ttoolbar: function()\n\t\t\t\t{\n\t\t\t\t\treturn (this.$toolbar) ? this.$toolbar : false;\n\t\t\t\t},\n\t\t\t\tair: function()\n\t\t\t\t{\n\t\t\t\t\treturn (this.$air) ? this.$air : false;\n\t\t\t\t},\n\t\t\t\tobject: function()\n\t\t\t\t{\n\t\t\t\t\treturn $.extend({}, this);\n\t\t\t\t},\n\t\t\t\tstructure: function()\n\t\t\t\t{\n\t\t\t\t\tthis.core.editor().toggleClass('redactor-structure');\n\t\t\t\t},\n\t\t\t\taddEvent: function(name)\n\t\t\t\t{\n\t\t\t\t\tthis.core.event = name;\n\t\t\t\t},\n\t\t\t\tgetEvent: function()\n\t\t\t\t{\n\t\t\t\t\treturn this.core.event;\n\t\t\t\t},\n\t\t\t\tcallback: function(type, e, data)\n\t\t\t\t{\n\t\t\t\t\tvar eventNamespace = 'redactor';\n\t\t\t\t\tvar returnValue = false;\n\t\t\t\t\tvar events = $._data(this.core.element()[0], 'events');\n\n\t\t\t\t\t// on callback\n\t\t\t\t\tif (typeof events !== 'undefined' && typeof events[type] !== 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\tvar len = events[type].length;\n\t\t\t\t\t\tfor (var i = 0; i < len; i++)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar namespace = events[type][i].namespace;\n\t\t\t\t\t\t\tif (namespace === 'callback.' + eventNamespace)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tvar handler = events[type][i].handler;\n\t\t\t\t\t\t\t\tvar args = (typeof data === 'undefined') ? [e] : [e, data];\n\t\t\t\t\t\t\t\treturnValue = (typeof args === 'undefined') ? handler.call(this, e) : handler.call(this, e, args);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (returnValue)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn returnValue;\n\t\t\t\t\t}\n\n\t\t\t\t\t// no callback\n\t\t\t\t\tif (typeof this.opts.callbacks[type] === 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn (typeof data === 'undefined') ? e : data;\n\t\t\t\t\t}\n\n\t\t\t\t\t// callback\n\t\t\t\t\tvar callback = this.opts.callbacks[type];\n\n\t\t\t\t\tif ($.isFunction(callback))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn (typeof data === 'undefined') ? callback.call(this, e) : callback.call(this, e, data);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\treturn (typeof data === 'undefined') ? e : data;\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tdestroy: function()\n\t\t\t\t{\n\t\t\t\t\tthis.opts.destroyed = true;\n\n\t\t\t\t\tthis.core.callback('destroy');\n\n\t\t\t\t\t// placeholder\n\t\t\t\t\tthis.placeholder.destroy();\n\n\t\t\t\t\t// progress\n\t\t\t\t\tthis.progress.destroy();\n\n\t\t\t\t\t// help label\n\t\t\t\t\t$('#redactor-voice-' + this.uuid).remove();\n\n\t\t\t\t\tthis.core.editor().removeClass('redactor-in redactor-structure redactor-editor-img-edit');\n\n\t\t\t\t\t// caret service\n\t\t\t\t\tthis.core.editor().off('keydown.redactor-remove-textnode');\n\n\t\t\t\t\t// observer\n\t\t\t\t\tthis.core.editor().off('.redactor-observe.' + this.uuid);\n\n\t\t\t\t\t// off events and remove data\n\t\t\t\t\tthis.$element.off('.redactor').removeData('redactor');\n\t\t\t\t\tthis.core.editor().off('.redactor');\n\n\t\t\t\t\t$(document).off('.redactor-dropdown');\n\t\t\t\t\t$(document).off('.redactor-air.' + this.uuid);\n\t\t\t\t\t$(document).off('mousedown.redactor-blur.' + this.uuid);\n\t\t\t\t\t$(document).off('mousedown.redactor.' + this.uuid);\n\t\t\t\t\t$(document).off('touchstart.redactor.' + this.uuid + ' click.redactor.' + this.uuid);\n\t\t\t\t\t$(window).off('.redactor-toolbar.' + this.uuid);\n\t\t\t\t\t$(window).off('touchmove.redactor.' + this.uuid);\n\t\t\t\t\t$(\"body\").off('scroll.redactor.' + this.uuid);\n\n\t\t\t\t\t$(this.opts.toolbarFixedTarget).off('scroll.redactor.' + this.uuid);\n\n\t\t\t\t\t// plugins events\n\t\t\t\t\tvar self = this;\n\t\t\t\t\tif (this.opts.plugins !== false)\n\t\t\t\t\t{\n\t\t\t\t\t\t$.each(this.opts.plugins, function(i,s)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$(window).off('.redactor-plugin-' + s);\n\t\t\t\t\t\t\t$(document).off('.redactor-plugin-' + s);\n\t\t\t\t\t\t\t$(\"body\").off('.redactor-plugin-' + s);\n\t\t\t\t\t\t\tself.core.editor().off('.redactor-plugin-' + s);\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\t// click to edit\n\t\t\t\t\tthis.$element.off('click.redactor-click-to-edit');\n\t\t\t\t\tthis.$element.removeClass('redactor-click-to-edit');\n\n\t\t\t\t\t// common\n\t\t\t\t\tthis.core.editor().removeClass('redactor-editor');\n\t\t\t\t\tthis.core.editor().removeAttr('contenteditable');\n\n\t\t\t\t\tvar html = this.code.get();\n\n\t\t\t\t\tif (this.opts.toolbar && this.$toolbar)\n\t\t\t\t\t{\n\t\t\t\t\t\t// dropdowns off\n\t\t\t\t\t\tthis.$toolbar.find('a').each(function()\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar $el = $(this);\n\t\t\t\t\t\t\tif ($el.data('dropdown'))\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t$el.data('dropdown').remove();\n\t\t\t\t\t\t\t\t$el.data('dropdown', {});\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.opts.type === 'textarea')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.$box.after(this.$element);\n\t\t\t\t\t\tthis.$box.remove();\n\t\t\t\t\t\tthis.$element.val(html).show();\n\t\t\t\t\t}\n\n\t\t\t\t\t// air\n\t\t\t\t\tif (this.opts.air)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.$air.remove();\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.opts.toolbar && this.$toolbar)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.$toolbar.remove();\n\t\t\t\t\t}\n\n\t\t\t\t\t// modal\n\t\t\t\t\tif (this.$modalBox)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.$modalBox.remove();\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.$modalOverlay)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.$modalOverlay.remove();\n\t\t\t\t\t}\n\n\t\t\t\t\t// hide link's tooltip\n\t\t\t\t\t$('.redactor-link-tooltip').remove();\n\n\t\t\t\t\t// autosave\n\t\t\t\t\tclearInterval(this.autosaveTimeout);\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =detect\n\t\tdetect: function()\n\t\t{\n\t\t\treturn {\n\n\t\t\t\t// public\n\t\t\t\tisWebkit: function()\n\t\t\t\t{\n\t\t\t\t\treturn /webkit/.test(this.opts.userAgent);\n\t\t\t\t},\n\t\t\t\tisFirefox: function()\n\t\t\t\t{\n\t\t\t\t\treturn this.opts.userAgent.indexOf('firefox') > -1;\n\t\t\t\t},\n\t\t\t\tisIe: function(v)\n\t\t\t\t{\n                    if (document.documentMode || /Edge/.test(navigator.userAgent))\n                    {\n                        return 'edge';\n                    }\n\n\t\t\t\t\tvar ie;\n\t\t\t\t\tie = RegExp('msie' + (!isNaN(v)?('\\\\s'+v):''), 'i').test(navigator.userAgent);\n\n\t\t\t\t\tif (!ie)\n\t\t\t\t\t{\n\t\t\t\t\t\tie = !!navigator.userAgent.match(/Trident.*rv[ :]*11\\./);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn ie;\n\t\t\t\t},\n\t\t\t\tisMobile: function()\n\t\t\t\t{\n\t\t\t\t\treturn /(iPhone|iPod|BlackBerry|Android)/.test(navigator.userAgent);\n\t\t\t\t},\n\t\t\t\tisDesktop: function()\n\t\t\t\t{\n\t\t\t\t\treturn !/(iPhone|iPod|iPad|BlackBerry|Android)/.test(navigator.userAgent);\n\t\t\t\t},\n\t\t\t\tisIpad: function()\n\t\t\t\t{\n\t\t\t\t\treturn /iPad/.test(navigator.userAgent);\n\t\t\t\t}\n\n\t\t\t};\n\t\t},\n\n\t\t// =dropdown\n\t\tdropdown: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tactive: false,\n\t\t\t\tbutton: false,\n\t\t\t\tkey: false,\n\t\t\t\tposition: [],\n\t\t\t\tgetDropdown: function()\n\t\t\t\t{\n\t\t\t\t\treturn this.dropdown.active;\n\t\t\t\t},\n\t\t\t\tbuild: function(name, $dropdown, dropdownObject)\n\t\t\t\t{\n\t\t\t\t\tdropdownObject = this.dropdown.buildFormatting(name, dropdownObject);\n\n\t\t\t\t\t$.each(dropdownObject, $.proxy(function(btnName, btnObject)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar $item = this.dropdown.buildItem(btnName, btnObject);\n\n\t\t\t\t\t\tthis.observe.addDropdown($item, btnName, btnObject);\n\t\t\t\t\t\t$dropdown.attr('rel', name).append($item);\n\n\t\t\t\t\t}, this));\n\t\t\t\t},\n\t\t\t\tbuildFormatting: function(name, dropdownObject)\n\t\t\t\t{\n\t\t\t\t\tif (name !== 'format' || this.opts.formattingAdd === false)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn dropdownObject;\n\t\t\t\t\t}\n\n\t\t\t\t\t$.each(this.opts.formattingAdd, $.proxy(function(i,s)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar type = (this.utils.isBlockTag(s.args[0])) ? 'block' : 'inline';\n\n\t\t\t\t\t\tdropdownObject[i] = {\n\t\t\t\t\t\t\tfunc: (type === 'block') ? 'block.format' : 'inline.format',\n\t\t\t\t\t\t\targs: s.args,\n\t\t\t\t\t\t\ttitle: s.title\n\t\t\t\t\t\t};\n\n\t\t\t\t\t}, this));\n\n\t\t\t\t\treturn dropdownObject;\n\t\t\t\t},\n\t\t\t\tbuildItem: function(btnName, btnObject)\n\t\t\t\t{\n\t\t\t\t\tvar $itemContainer = $('<li />');\n\t\t\t\t\tif (typeof btnObject.classname !== 'undefined')\n\t\t\t\t\t{\n    \t\t\t\t\t$itemContainer.addClass(btnObject.classname);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (btnName.search(/^divider/i) !== -1)\n\t\t\t\t\t{\n    \t\t\t\t\t$itemContainer.addClass('redactor-dropdown-divider');\n\n    \t\t\t\t\treturn $itemContainer;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar $item = $('<a href=\"#\" class=\"redactor-dropdown-' + btnName + '\" role=\"button\" />');\n\t\t\t\t\tvar $itemSpan = $('<span />').html(btnObject.title);\n\n\t\t\t\t\t$item.append($itemSpan);\n\t\t\t\t\t$item.on('mousedown', $.proxy(function(e)\n\t\t\t\t\t{\n\t\t\t\t\t\te.preventDefault();\n\n\t\t\t\t\t\tthis.dropdown.buildClick(e, btnName, btnObject);\n\n\t\t\t\t\t}, this));\n\n\t\t\t\t\t$itemContainer.append($item);\n\n\t\t\t\t\treturn $itemContainer;\n\n\t\t\t\t},\n\t\t\t\tbuildClick: function(e, btnName, btnObject)\n\t\t\t\t{\n\t\t\t\t\tif ($(e.target).hasClass('redactor-dropdown-link-inactive'))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar command = this.dropdown.buildCommand(btnObject);\n\n\t\t\t\t\tif (typeof btnObject.args !== ' undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.button.toggle(e, btnName, command.type, command.callback, btnObject.args);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.button.toggle(e, btnName, command.type, command.callback);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tbuildCommand: function(btnObject)\n\t\t\t\t{\n\t\t\t\t\tvar command = {};\n\t\t\t\t\tcommand.type = 'func';\n\t\t\t\t\tcommand.callback = btnObject.func;\n\n\t\t\t\t\tif (btnObject.command)\n\t\t\t\t\t{\n\t\t\t\t\t\tcommand.type = 'command';\n\t\t\t\t\t\tcommand.callback = btnObject.command;\n\t\t\t\t\t}\n\t\t\t\t\telse if (btnObject.dropdown)\n\t\t\t\t\t{\n\t\t\t\t\t\tcommand.type = 'dropdown';\n\t\t\t\t\t\tcommand.callback = btnObject.dropdown;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn command;\n\t\t\t\t},\n\t\t\t\tshow: function(e, key)\n\t\t\t\t{\n\t\t\t\t\tif (this.detect.isDesktop())\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.editor().focus();\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.dropdown.hideAll(false, key);\n\n\t\t\t\t\tthis.dropdown.key = key;\n\t\t\t\t\tthis.dropdown.button = this.button.get(this.dropdown.key);\n\n\t\t\t\t\tif (this.dropdown.button.hasClass('dropact'))\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.dropdown.hide();\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\t// re append\n\t\t\t\t\tthis.dropdown.active = this.dropdown.button.data('dropdown').appendTo(document.body);\n\n\t\t\t\t\t// callback\n\t\t\t\t\tthis.core.callback('dropdownShow', { dropdown: this.dropdown.active, key: this.dropdown.key, button: this.dropdown.button });\n\n\t\t\t\t\t// set button\n\t\t\t\t\tthis.button.setActive(this.dropdown.key);\n\t\t\t\t\tthis.dropdown.button.addClass('dropact');\n\n\t\t\t\t\t// position\n\t\t\t\t\tthis.dropdown.getButtonPosition();\n\n\t\t\t\t\t// show\n\t\t\t\t\tif (this.button.toolbar().hasClass('toolbar-fixed-box') && this.detect.isDesktop())\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.dropdown.showIsFixedToolbar();\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.dropdown.showIsUnFixedToolbar();\n\t\t\t\t\t}\n\n\t\t\t\t\t// disable scroll whan dropdown scroll\n\t\t\t\t\tif (this.detect.isDesktop() && !this.detect.isFirefox())\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.dropdown.active.on('mouseover.redactor-dropdown', $.proxy(this.utils.disableBodyScroll, this));\n\t\t\t\t\t\tthis.dropdown.active.on('mousedown.redactor-dropdown', $.proxy(this.utils.enableBodyScroll, this));\n\t\t\t\t\t}\n\n\t\t\t\t\te.stopPropagation();\n\n\t\t\t\t},\n\t\t\t\tshowIsFixedToolbar: function()\n\t\t\t\t{\n\t\t\t\t\tvar top = this.dropdown.button.position().top + this.dropdown.button.innerHeight() + this.opts.toolbarFixedTopOffset;\n\n\t\t\t\t\tvar position = 'fixed';\n\t\t\t\t\tif (this.opts.toolbarFixedTarget !== document)\n\t\t\t\t\t{\n\t\t\t\t\t\ttop = (this.dropdown.button.innerHeight() + this.$toolbar.offset().top) + this.opts.toolbarFixedTopOffset;\n\t\t\t\t\t\tposition = 'absolute';\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.dropdown.active.css({\n\n\t\t\t\t\t\tposition: position,\n\t\t\t\t\t\tleft: this.dropdown.position.left + 'px',\n\t\t\t\t\t\ttop: top + 'px'\n\n\t\t\t\t\t}).show();\n\n\t\t\t\t\t// animate\n\t\t\t\t\tthis.dropdown.active.redactorAnimation('slideDown', { duration: 0.2 }, $.proxy(function()\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.dropdown.enableCallback();\n\t\t\t\t\t\tthis.dropdown.enableEvents();\n\n\t\t\t\t\t}, this));\n\t\t\t\t},\n\t\t\t\tshowIsUnFixedToolbar: function()\n\t\t\t\t{\n\t\t\t\t\tthis.dropdown.active.css({\n\n\t\t\t\t\t\tposition: 'absolute',\n\t\t\t\t\t\tleft: this.dropdown.position.left + 'px',\n\t\t\t\t\t\ttop: (this.dropdown.button.innerHeight() + this.dropdown.position.top) + 'px'\n\n\t\t\t\t\t}).show();\n\n\t\t\t\t\t// animate\n\t\t\t\t\tthis.dropdown.active.redactorAnimation(((this.opts.animation) ? 'slideDown' : 'show'), { duration: 0.2 }, $.proxy(function()\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.dropdown.enableCallback();\n\t\t\t\t\t\tthis.dropdown.enableEvents();\n\n\t\t\t\t\t}, this));\n\t\t\t\t},\n\t\t\t\tenableEvents: function()\n\t\t\t\t{\n\t\t\t\t\t$(document).on('mousedown.redactor-dropdown', $.proxy(this.dropdown.hideAll, this));\n\t\t\t\t\tthis.core.editor().on('touchstart.redactor-dropdown', $.proxy(this.dropdown.hideAll, this));\n\t\t\t\t\t$(document).on('keyup.redactor-dropdown', $.proxy(this.dropdown.closeHandler, this));\n\t\t\t\t},\n\t\t\t\tenableCallback: function()\n\t\t\t\t{\n\t\t\t\t\tthis.core.callback('dropdownShown', { dropdown: this.dropdown.active, key: this.dropdown.key, button: this.dropdown.button });\n\t\t\t\t},\n\t\t\t\tgetButtonPosition: function()\n\t\t\t\t{\n\t\t\t\t\tthis.dropdown.position = this.dropdown.button.offset();\n\n\t\t\t\t\t// fix right placement\n\t\t\t\t\tvar dropdownWidth = this.dropdown.active.width();\n\t\t\t\t\tif ((this.dropdown.position.left + dropdownWidth) > $(document).width())\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.dropdown.position.left = Math.max(0, this.dropdown.position.left - dropdownWidth + parseInt(this.dropdown.button.innerWidth()));\n\t\t\t\t\t}\n\n\t\t\t\t},\n\t\t\t\tcloseHandler: function(e)\n\t\t\t\t{\n\t\t\t\t\tif (e.which !== this.keyCode.ESC)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.dropdown.hideAll(e);\n\t\t\t\t\tthis.core.editor().focus();\n\t\t\t\t},\n\t\t\t\thideAll: function(e, key)\n\t\t\t\t{\n\t\t\t\t\tif (this.detect.isDesktop())\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.utils.enableBodyScroll();\n\t\t\t\t\t}\n\n\t\t\t\t\tif (e !== false && $(e.target).closest('.redactor-dropdown').length !== 0)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar $buttons = (typeof key === 'undefined') ? this.button.toolbar().find('a.dropact') : this.button.toolbar().find('a.dropact').not('.re-' + key);\n\t\t\t\t\tvar $elements = (typeof key === 'undefined') ? $('.redactor-dropdown-' + this.uuid) : $('.redactor-dropdown-' + this.uuid).not('.redactor-dropdown-box-' + key);\n\n\t\t\t\t\tif ($elements.length !== 0)\n\t\t\t\t\t{\n\t\t\t\t\t\t$(document).off('.redactor-dropdown');\n\t\t\t\t\t\tthis.core.editor().off('.redactor-dropdown');\n\n\t\t\t\t\t\t$.each($elements, $.proxy(function(i,s)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar $el = $(s);\n\n\t\t\t\t\t\t\tthis.core.callback('dropdownHide', $el);\n\n\t\t\t\t\t\t\t$el.hide();\n\t\t\t\t\t\t\t$el.off('mouseover mouseout').off('.redactor-dropdown');\n\n\t\t\t\t\t\t}, this));\n\n\t\t\t\t\t\t$buttons .removeClass('redactor-act dropact');\n\t\t\t\t\t}\n\n\t\t\t\t},\n\t\t\t\thide: function ()\n\t\t\t\t{\n\t\t\t\t\tif (this.dropdown.active === false)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.detect.isDesktop())\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.utils.enableBodyScroll();\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.dropdown.active.redactorAnimation(((this.opts.animation) ? 'slideUp' : 'hide'), { duration: 0.2 }, $.proxy(function()\n\t\t\t\t\t{\n\t\t\t\t\t\t$(document).off('.redactor-dropdown');\n\t\t\t\t\t\tthis.core.editor().off('.redactor-dropdown');\n\n\t\t\t\t\t\tthis.dropdown.hideOut();\n\n\n\t\t\t\t\t}, this));\n\t\t\t\t},\n\t\t\t\thideOut: function()\n\t\t\t\t{\n\t\t\t\t\tthis.core.callback('dropdownHide', this.dropdown.active);\n\n\t\t\t\t\tthis.dropdown.button.removeClass('redactor-act dropact');\n\t\t\t\t\tthis.dropdown.active.off('mouseover mouseout').off('.redactor-dropdown');\n\t\t\t\t\tthis.dropdown.button = false;\n\t\t\t\t\tthis.dropdown.key = false;\n\t\t\t\t\tthis.dropdown.active = false;\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =events\n\t\tevents: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tfocused: false,\n\t\t\t\tblured: true,\n\t\t\t\tdropImage: false,\n\t\t\t\tstopChanges: false,\n\t\t\t\tstopDetectChanges: function()\n\t\t\t\t{\n\t\t\t\t\tthis.events.stopChanges = true;\n\t\t\t\t},\n\t\t\t\tstartDetectChanges: function()\n\t\t\t\t{\n\t\t\t\t\tvar self = this;\n\t\t\t\t\tsetTimeout(function()\n\t\t\t\t\t{\n\t\t\t\t\t\tself.events.stopChanges = false;\n\t\t\t\t\t}, 1);\n\t\t\t\t},\n\t\t\t\tdragover: function(e)\n\t\t\t\t{\n\t\t\t\t\te.preventDefault();\n\t\t\t\t\te.stopPropagation();\n\n\t\t\t\t\tif (e.target.tagName === 'IMG')\n\t\t\t\t\t{\n\t\t\t\t\t\t$(e.target).addClass('redactor-image-dragover');\n\t\t\t\t\t}\n\n\t\t\t\t},\n\t\t\t\tdragleave: function(e)\n\t\t\t\t{\n\t\t\t\t\t// remove image dragover\n\t\t\t\t\tthis.core.editor().find('img').removeClass('redactor-image-dragover');\n\t\t\t\t},\n\t\t\t\tdrop: function(e)\n\t\t\t\t{\n\t\t\t\t\te = e.originalEvent || e;\n\n\t\t\t\t\t// remove image dragover\n\t\t\t\t\tthis.core.editor().find('img').removeClass('redactor-image-dragover');\n\n\t\t\t\t\tif (this.opts.type === 'inline' || this.opts.type === 'pre')\n\t\t\t\t\t{\n\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (window.FormData === undefined || !e.dataTransfer)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (e.dataTransfer.files.length === 0)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn this.events.onDrop(e);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.events.onDropUpload(e);\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.core.callback('drop', e);\n\n\t\t\t\t},\n\t\t\t\tclick: function(e)\n\t\t\t\t{\n\t\t\t\t\tvar event = this.core.getEvent();\n\t\t\t\t\tvar type = (event === 'click' || event === 'arrow') ? false : 'click';\n\n\t\t\t\t\tthis.core.addEvent(type);\n\t\t\t\t\tthis.utils.disableSelectAll();\n\t\t\t\t\tthis.core.callback('click', e);\n\t\t\t\t},\n\t\t\t\tfocus: function(e)\n\t\t\t\t{\n\t\t\t\t\tif (this.rtePaste)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.events.isCallback('focus'))\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.callback('focus', e);\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.events.focused = true;\n\t\t\t\t\tthis.events.blured = false;\n\n\t\t\t\t\t// tab\n\t\t\t\t\tif (this.selection.current() === false)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar sel = this.selection.get();\n\t\t\t\t\t\tvar range = this.selection.range(sel);\n\n\t\t\t\t\t\trange.setStart(this.core.editor()[0], 0);\n\t\t\t\t\t\trange.setEnd(this.core.editor()[0], 0);\n\t\t\t\t\t\tthis.selection.update(sel, range);\n\t\t\t\t\t}\n\n\t\t\t\t},\n\t\t\t\tblur: function(e)\n\t\t\t\t{\n\t\t\t\t\tif (this.start || this.rtePaste)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif ($(e.target).closest('#' + this.core.id() + ', .redactor-toolbar, .redactor-dropdown, #redactor-modal-box').length !== 0)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!this.events.blured && this.events.isCallback('blur'))\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.callback('blur', e);\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.events.focused = false;\n\t\t\t\t\tthis.events.blured = true;\n\t\t\t\t},\n\t\t\t\ttouchImageEditing: function()\n\t\t\t\t{\n\t\t\t\t\tvar scrollTimer = -1;\n\t\t\t\t\tthis.events.imageEditing = false;\n\t\t\t\t\t$(window).on('touchmove.redactor.' + this.uuid, $.proxy(function()\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.events.imageEditing = true;\n\t\t\t\t\t\tif (scrollTimer !== -1)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tclearTimeout(scrollTimer);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tscrollTimer = setTimeout($.proxy(function()\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.events.imageEditing = false;\n\n\t\t\t\t\t\t}, this), 500);\n\n\t\t\t\t\t}, this));\n\t\t\t\t},\n\t\t\t\tinit: function()\n\t\t\t\t{\n\t\t\t\t\tthis.core.editor().on('dragover.redactor dragenter.redactor', $.proxy(this.events.dragover, this));\n\t\t\t\t\tthis.core.editor().on('dragleave.redactor', $.proxy(this.events.dragleave, this));\n\t\t\t\t\tthis.core.editor().on('drop.redactor', $.proxy(this.events.drop, this));\n\t\t\t\t\tthis.core.editor().on('click.redactor', $.proxy(this.events.click, this));\n\t\t\t\t\tthis.core.editor().on('paste.redactor', $.proxy(this.paste.init, this));\n\t\t\t\t\tthis.core.editor().on('keydown.redactor', $.proxy(this.keydown.init, this));\n\t\t\t\t\tthis.core.editor().on('keyup.redactor', $.proxy(this.keyup.init, this));\n\t\t\t\t\tthis.core.editor().on('focus.redactor', $.proxy(this.events.focus, this));\n\n\t\t\t\t\t$(document).on('mousedown.redactor-blur.' + this.uuid, $.proxy(this.events.blur, this));\n\n\t\t\t\t\tthis.events.touchImageEditing();\n\n\t\t\t\t\tthis.events.createObserver();\n\t\t\t\t\tthis.events.setupObserver();\n\n\t\t\t\t},\n\t\t\t\tcreateObserver: function()\n\t\t\t\t{\n\t\t\t\t\tvar self = this;\n\t\t\t\t\tthis.events.observer = new MutationObserver(function(mutations)\n\t\t\t\t\t{\n\t\t\t\t\t\tmutations.forEach($.proxy(self.events.iterateObserver, self));\n\t\t\t\t\t});\n\n\t\t\t\t},\n\t\t\t\titerateObserver: function(mutation)\n\t\t\t\t{\n\n\t\t\t\t\tvar stop = false;\n\n\t\t\t\t\t// target\n\t\t\t\t\tif (((this.opts.type === 'textarea' || this.opts.type === 'div')\n\t\t\t\t\t    && (!this.detect.isFirefox() && mutation.target === this.core.editor()[0]))\n\t\t\t\t\t    || (mutation.attributeName === 'class' && mutation.target === this.core.editor()[0])\n                    )\n\t\t\t\t\t{\n\t\t\t\t\t\tstop = true;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!stop)\n\t\t\t\t\t{\n    \t\t\t\t\tthis.observe.load();\n\t\t\t\t\t\tthis.events.changeHandler();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tsetupObserver: function()\n\t\t\t\t{\n\t\t\t\t\tthis.events.observer.observe(this.core.editor()[0], {\n\t\t\t\t\t\t attributes: true,\n\t\t\t\t\t\t subtree: true,\n\t\t\t\t\t\t childList: true,\n\t\t\t\t\t\t characterData: true,\n\t\t\t\t\t\t characterDataOldValue: true\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t\tchangeHandler: function()\n\t\t\t\t{\n\t\t\t\t\tif (this.events.stopChanges)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.code.sync();\n\n\t\t\t\t\t// autosave\n\t\t\t\t\tif (this.autosave.is())\n\t\t\t\t\t{\n\t\t\t\t\t\tclearTimeout(this.autosaveTimeout);\n\t\t\t\t\t\tthis.autosaveTimeout = setTimeout($.proxy(this.autosave.send, this), 300);\n\t\t\t\t\t}\n\n\t\t\t\t},\n\t\t\t\tonDropUpload: function(e)\n\t\t\t\t{\n\t\t\t\t\te.preventDefault();\n\t\t\t\t\te.stopPropagation();\n\n\t\t\t\t\tif ((!this.opts.dragImageUpload && !this.opts.dragFileUpload) || (this.opts.imageUpload === null && this.opts.fileUpload === null))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (e.target.tagName === 'IMG')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.events.dropImage = e.target;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar files = e.dataTransfer.files;\n\t\t\t\t\tthis.upload.directUpload(files[0], e);\n\t\t\t\t},\n\t\t\t\tonDrop: function(e)\n\t\t\t\t{\n\t\t\t\t\tthis.core.callback('drop', e);\n\t\t\t\t},\n\t\t\t\tisCallback: function(name)\n\t\t\t\t{\n\t\t\t\t\treturn (typeof this.opts.callbacks[name] !== 'undefined' && $.isFunction(this.opts.callbacks[name]));\n\t\t\t\t},\n\n\t\t\t\t// #backward\n\t\t\t\tstopDetect: function()\n\t\t\t\t{\n\t\t\t\t\tthis.events.stopDetectChanges();\n\t\t\t\t},\n\t\t\t\tstartDetect: function()\n\t\t\t\t{\n\t\t\t\t\tthis.events.startDetectChanges();\n\t\t\t\t}\n\n\t\t\t};\n\t\t},\n\n\t\t// =file\n\t\tfile: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tis: function()\n\t\t\t\t{\n\t\t\t\t\treturn !(!this.opts.fileUpload || !this.opts.fileUpload && !this.opts.s3);\n\t\t\t\t},\n\t\t\t\tshow: function()\n\t\t\t\t{\n\t\t\t\t\t// build modal\n\t\t\t\t\tthis.modal.load('file', this.lang.get('file'), 700);\n\n\t\t\t\t\t// build upload\n\t\t\t\t\tthis.upload.init('#redactor-modal-file-upload', this.opts.fileUpload, this.file.insert);\n\n\t\t\t\t\t// set selected text\n\t\t\t\t\t$('#redactor-filename').val(this.selection.get().toString());\n\n\t\t\t\t\t// show\n\t\t\t\t\tthis.modal.show();\n\t\t\t\t},\n\t\t\t\tinsert: function(json, direct, e)\n\t\t\t\t{\n\t\t\t\t\t// error callback\n\t\t\t\t\tif (typeof json.error !== 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.modal.close();\n\t\t\t\t\t\tthis.core.callback('fileUploadError', json);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.file.release(e, direct);\n\n\t\t\t\t\t// prepare\n\t\t\t\t\tthis.buffer.set();\n\t\t\t\t\tthis.air.collapsed();\n\n\t\t\t\t\t// get\n\t\t\t\t\tvar text = this.file.text(json);\n\t\t\t\t\tvar $link = $('<a />').attr('href', json.url).text(text);\n\t\t\t\t\tvar id = (typeof json.id === 'undefined') ? '' : json.id;\n\t\t\t\t\tvar type = (typeof json.s3 === 'undefined') ? 'file' : 's3';\n\n\t\t\t\t\t// set id\n\t\t\t\t\t$link.attr('data-' + type, id);\n\n\t\t\t\t\t// insert\n\t\t\t\t\t$link = $(this.insert.node($link));\n\n\t\t\t\t\t// focus\n\t\t\t\t\tthis.caret.after($link);\n\n\t\t\t\t\t// callback\n\t\t\t\t\tthis.storage.add({ type: type, node: $link[0], url: $link[0].href, id: id });\n\n\t\t\t\t\tif (direct !== null)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.callback('fileUpload', $link, json);\n\t\t\t\t\t}\n\n\t\t\t\t},\n\t\t\t\trelease: function(e, direct)\n\t\t\t\t{\n\t\t\t\t\tif (direct)\n\t\t\t\t\t{\n\t\t\t\t\t\t// drag and drop upload\n\t\t\t\t\t\tthis.marker.remove();\n\t\t\t\t\t\tthis.insert.nodeToPoint(e, this.marker.get());\n\t\t\t\t\t\tthis.selection.restore();\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\t// upload from modal\n\t\t\t\t\t\tthis.modal.close();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\ttext: function(json)\n\t\t\t\t{\n\t\t\t\t\tvar text = $('#redactor-filename').val();\n\n\t\t\t\t\treturn (typeof text === 'undefined' || text === '') ? json.name : text;\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =focus\n\t\tfocus: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tstart: function()\n\t\t\t\t{\n\t\t\t\t\tthis.core.editor().focus();\n\n\t\t\t\t\tif (this.opts.type === 'inline')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar $first = this.focus.first();\n\t\t\t\t\tif ($first !== false)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.caret.start($first);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tend: function()\n\t\t\t\t{\n\t\t\t\t\tthis.core.editor().focus();\n\n\t\t\t\t\tvar last = (this.opts.inline) ? this.core.editor() : this.focus.last();\n\t\t\t\t\tif (last.length === 0)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\t// get inline last node\n\t\t\t\t\tvar lastNode = this.focus.lastChild(last);\n\t\t\t\t\tif (!this.detect.isWebkit() && lastNode !== false)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.caret.end(lastNode);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tvar sel = this.selection.get();\n\t\t\t\t\t\tvar range = this.selection.range(sel);\n\n\t\t\t\t\t\tif (range !== null)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\trange.selectNodeContents(last[0]);\n\t\t\t\t\t\t\trange.collapse(false);\n\n\t\t\t\t\t\t\tthis.selection.update(sel, range);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.caret.end(last);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t},\n\t\t\t\tfirst: function()\n\t\t\t\t{\n\t\t\t\t\tvar $first = this.core.editor().children().first();\n\t\t\t\t\tif ($first.length === 0 && ($first[0].length === 0 || $first[0].tagName === 'BR' || $first[0].tagName === 'HR' || $first[0].nodeType === 3))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tif ($first[0].tagName === 'UL' || $first[0].tagName === 'OL')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn $first.find('li').first();\n\t\t\t\t\t}\n\n\t\t\t\t\treturn $first;\n\n\t\t\t\t},\n\t\t\t\tlast: function()\n\t\t\t\t{\n\t\t\t\t\treturn this.core.editor().children().last();\n\t\t\t\t},\n\t\t\t\tlastChild: function(last)\n\t\t\t\t{\n\t\t\t\t\tvar lastNode = last[0].lastChild;\n\n\t\t\t\t\treturn (lastNode !== null && this.utils.isInlineTag(lastNode.tagName)) ? lastNode : false;\n\t\t\t\t},\n\t\t\t\tis: function()\n\t\t\t\t{\n\t\t\t\t\treturn (this.core.editor()[0] === document.activeElement);\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =image\n\t\timage: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tis: function()\n\t\t\t\t{\n\t\t\t\t\treturn !(!this.opts.imageUpload || !this.opts.imageUpload && !this.opts.s3);\n\t\t\t\t},\n\t\t\t\tshow: function()\n\t\t\t\t{\n\t\t\t\t\t// build modal\n\t\t\t\t\tthis.modal.load('image', this.lang.get('image'), 700);\n\n\t\t\t\t\t// build upload\n\t\t\t\t\tthis.upload.init('#redactor-modal-image-droparea', this.opts.imageUpload, this.image.insert);\n\t\t\t\t\tthis.modal.show();\n\n\t\t\t\t},\n\t\t\t\tinsert: function(json, direct, e)\n\t\t\t\t{\n\t\t\t\t\tvar $img;\n\n\t\t\t\t\t// error callback\n\t\t\t\t\tif (typeof json.error !== 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.modal.close();\n\t\t\t\t\t\tthis.events.dropImage = false;\n\t\t\t\t\t\tthis.core.callback('imageUploadError', json, e);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\t// change image\n\t\t\t\t\tif (this.events.dropImage !== false)\n\t\t\t\t\t{\n\t\t\t\t\t\t$img = $(this.events.dropImage);\n\n\t\t\t\t\t\tthis.core.callback('imageDelete', $img[0].src, $img);\n\n\t\t\t\t\t\t$img.attr('src', json.url);\n\n\t\t\t\t\t\tthis.events.dropImage = false;\n\t\t\t\t\t\tthis.core.callback('imageUpload', $img, json);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.placeholder.hide();\n\t\t\t\t\tvar $figure = $('<' + this.opts.imageTag + '>');\n\n\t\t\t\t\t$img = $('<img>');\n\t\t\t\t\t$img.attr('src', json.url);\n\n\t\t\t\t\t// set id\n\t\t\t\t\tvar id = (typeof json.id === 'undefined') ? '' : json.id;\n\t\t\t\t\tvar type = (typeof json.s3 === 'undefined') ? 'image' : 's3';\n\t\t\t\t\t$img.attr('data-' + type, id);\n\n\t\t\t\t\t$figure.append($img);\n\n\t\t\t\t\tvar pre = this.utils.isTag(this.selection.current(), 'pre');\n\n\t\t\t\t\tif (direct)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.air.collapsed();\n\t\t\t\t\t\tthis.marker.remove();\n\n\t\t\t\t\t\tvar node = this.insert.nodeToPoint(e, this.marker.get());\n\t\t\t\t\t\tvar $next = $(node).next();\n\n\t\t\t\t\t\tthis.selection.restore();\n\n\t\t\t\t\t\t// buffer\n\t\t\t\t\t\tthis.buffer.set();\n\n\t\t\t\t\t\t// insert\n\t\t\t\t\t\tif (typeof $next !== 'undefined' && $next.length !== 0 && $next[0].tagName === 'IMG')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t// delete callback\n\t\t\t\t\t\t\tthis.core.callback('imageDelete', $next[0].src, $next);\n\n\t\t\t\t\t\t\t// replace\n\t\t\t\t\t\t\t$next.closest('figure, p', this.core.editor()[0]).replaceWith($figure);\n\t\t\t\t\t\t\tthis.caret.after($figure);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tif (pre)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t$(pre).after($figure);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tthis.insert.node($figure);\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tthis.caret.after($figure);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.modal.close();\n\n\t\t\t\t\t\t// buffer\n\t\t\t\t\t\tthis.buffer.set();\n\n\t\t\t\t\t\t// insert\n\t\t\t\t\t\tthis.air.collapsed();\n\n\t\t\t\t\t\tif (pre)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$(pre).after($figure);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.insert.node($figure);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tthis.caret.after($figure);\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.events.dropImage = false;\n\n\t\t\t\t\tthis.storage.add({ type: type, node: $img[0], url: $img[0].src, id: id });\n\n\t\t\t\t\tif (direct !== null)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.callback('imageUpload', $img, json);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tsetEditable: function($image)\n\t\t\t\t{\n\t\t\t\t\t$image.on('dragstart', function(e)\n\t\t\t\t\t{\n\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t});\n\n                    if (this.opts.imageResizable)\n                    {\n    \t\t\t\t\tvar handler = $.proxy(function(e)\n    \t\t\t\t\t{\n    \t\t\t\t\t\tthis.observe.image = $image;\n    \t\t\t\t\t\tthis.image.resizer = this.image.loadEditableControls($image);\n\n    \t\t\t\t\t\t$(document).on('mousedown.redactor-image-resize-hide.' + this.uuid, $.proxy(this.image.hideResize, this));\n                            this.image.resizer.on('mousedown.redactor touchstart.redactor', $.proxy(function(e)\n    \t\t\t\t\t\t{\n    \t\t\t\t\t\t\tthis.image.setResizable(e, $image);\n    \t\t\t\t\t\t}, this));\n\n    \t\t\t\t\t}, this);\n\n    \t\t\t\t\t$image.off('mousedown.redactor').on('mousedown.redactor', $.proxy(this.image.hideResize, this));\n    \t\t\t\t\t$image.off('click.redactor touchstart.redactor').on('click.redactor touchstart.redactor', handler);\n                    }\n                    else\n                    {\n    \t\t\t\t\t$image.off('click.redactor touchstart.redactor').on('click.redactor touchstart.redactor', $.proxy(function(e)\n    \t\t\t\t\t{\n    \t\t\t\t\t\tsetTimeout($.proxy(function()\n    \t\t\t\t\t\t{\n    \t\t\t\t\t\t\tthis.image.showEdit($image);\n\n    \t\t\t\t\t\t}, this), 200);\n\n    \t\t\t\t\t}, this));\n                    }\n\n\t\t\t\t},\n\t\t\t\tsetResizable: function(e, $image)\n\t\t\t\t{\n\t\t\t\t\te.preventDefault();\n\n\t\t\t\t    this.image.resizeHandle = {\n\t\t\t\t        x : e.pageX,\n\t\t\t\t        y : e.pageY,\n\t\t\t\t        el : $image,\n\t\t\t\t        ratio: $image.width() / $image.height(),\n\t\t\t\t        h: $image.height()\n\t\t\t\t    };\n\n\t\t\t\t    e = e.originalEvent || e;\n\n\t\t\t\t    if (e.targetTouches)\n\t\t\t\t    {\n\t\t\t\t         this.image.resizeHandle.x = e.targetTouches[0].pageX;\n\t\t\t\t         this.image.resizeHandle.y = e.targetTouches[0].pageY;\n\t\t\t\t    }\n\n\t\t\t\t\tthis.image.startResize();\n\n\n\t\t\t\t},\n\t\t\t\tstartResize: function()\n\t\t\t\t{\n\t\t\t\t\t$(document).on('mousemove.redactor-image-resize touchmove.redactor-image-resize', $.proxy(this.image.moveResize, this));\n\t\t\t\t\t$(document).on('mouseup.redactor-image-resize touchend.redactor-image-resize', $.proxy(this.image.stopResize, this));\n\t\t\t\t},\n\t\t\t\tmoveResize: function(e)\n\t\t\t\t{\n\t\t\t\t\te.preventDefault();\n\n\t\t\t\t\te = e.originalEvent || e;\n\n\t\t\t\t\tvar height = this.image.resizeHandle.h;\n\n\t\t            if (e.targetTouches) height += (e.targetTouches[0].pageY -  this.image.resizeHandle.y);\n\t\t            else height += (e.pageY -  this.image.resizeHandle.y);\n\n\t\t\t\t\tvar width = Math.round(height * this.image.resizeHandle.ratio);\n\n\t\t\t\t\tif (height < 50 || width < 100) return;\n\n\t\t\t\t\tvar height = Math.round(this.image.resizeHandle.el.width() / this.image.resizeHandle.ratio);\n\n\t\t\t\t\tthis.image.resizeHandle.el.attr({width: width, height: height});\n\t\t            this.image.resizeHandle.el.width(width);\n\t\t            this.image.resizeHandle.el.height(height);\n\n\t\t            this.code.sync();\n\t\t\t\t},\n\t\t\t\tstopResize: function()\n\t\t\t\t{\n\t\t\t\t\tthis.handle = false;\n\t\t\t\t\t$(document).off('.redactor-image-resize');\n\n\t\t\t\t\tthis.image.hideResize();\n\t\t\t\t},\n                hideResize: function(e)\n\t\t\t\t{\n\t\t\t\t\tif (e && $(e.target).closest('#redactor-image-box', this.$editor[0]).length !== 0) return;\n\t\t\t\t\tif (e && e.target.tagName == 'IMG')\n\t\t\t\t\t{\n\t\t\t\t\t\tvar $image = $(e.target);\n\t\t\t\t\t}\n\n\t\t\t\t\tvar imageBox = this.$editor.find('#redactor-image-box');\n\t\t\t\t\tif (imageBox.length === 0) return;\n\n\t\t\t\t\t$('#redactor-image-editter').remove();\n\t\t\t\t\t$('#redactor-image-resizer').remove();\n\n\t\t\t\t\timageBox.find('img').css({\n\t\t\t\t\t\tmarginTop: imageBox[0].style.marginTop,\n\t\t\t\t\t\tmarginBottom: imageBox[0].style.marginBottom,\n\t\t\t\t\t\tmarginLeft: imageBox[0].style.marginLeft,\n\t\t\t\t\t\tmarginRight: imageBox[0].style.marginRight\n\t\t\t\t\t});\n\n\t\t\t\t\timageBox.css('margin', '');\n\t\t\t\t\timageBox.find('img').css('opacity', '');\n\t\t\t\t\timageBox.replaceWith(function()\n\t\t\t\t\t{\n\t\t\t\t\t\treturn $(this).contents();\n\t\t\t\t\t});\n\n\t\t\t\t\t$(document).off('mousedown.redactor-image-resize-hide.' + this.uuid);\n\n\n\t\t\t\t\tif (typeof this.image.resizeHandle !== 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.image.resizeHandle.el.attr('rel', this.image.resizeHandle.el.attr('style'));\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tloadResizableControls: function($image, imageBox)\n\t\t\t\t{\n\t\t\t\t\tif (this.opts.imageResizable && !this.detect.isMobile())\n\t\t\t\t\t{\n\t\t\t\t\t\tvar imageResizer = $('<span id=\"redactor-image-resizer\" data-redactor=\"verified\"></span>');\n\n\t\t\t\t\t\tif (!this.detect.isDesktop())\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\timageResizer.css({ width: '15px', height: '15px' });\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\timageResizer.attr('contenteditable', false);\n\t\t\t\t\t\timageBox.append(imageResizer);\n\t\t\t\t\t\timageBox.append($image);\n\n\t\t\t\t\t\treturn imageResizer;\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\timageBox.append($image);\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tloadEditableControls: function($image)\n\t\t\t\t{\n\t\t\t\t\tvar imageBox = $('<span id=\"redactor-image-box\" data-redactor=\"verified\">');\n\t\t\t\t\timageBox.css('float', $image.css('float')).attr('contenteditable', false);\n\n\t\t\t\t\tif ($image[0].style.margin != 'auto')\n\t\t\t\t\t{\n\t\t\t\t\t\timageBox.css({\n\t\t\t\t\t\t\tmarginTop: $image[0].style.marginTop,\n\t\t\t\t\t\t\tmarginBottom: $image[0].style.marginBottom,\n\t\t\t\t\t\t\tmarginLeft: $image[0].style.marginLeft,\n\t\t\t\t\t\t\tmarginRight: $image[0].style.marginRight\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\t$image.css('margin', '');\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\timageBox.css({ 'display': 'block', 'margin': 'auto' });\n\t\t\t\t\t}\n\n\t\t\t\t\t$image.css('opacity', '.5').after(imageBox);\n\n\n\t\t\t\t\tif (this.opts.imageEditable)\n\t\t\t\t\t{\n\t\t\t\t\t\t// editter\n\t\t\t\t\t\tthis.image.editter = $('<span id=\"redactor-image-editter\" data-redactor=\"verified\">' + this.lang.get('edit') + '</span>');\n\t\t\t\t\t\tthis.image.editter.attr('contenteditable', false);\n\t\t\t\t\t\tthis.image.editter.on('click', $.proxy(function()\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.image.showEdit($image);\n\t\t\t\t\t\t}, this));\n\n\t\t\t\t\t\timageBox.append(this.image.editter);\n\n\t\t\t\t\t\t// position correction\n\t\t\t\t\t\tvar editerWidth = this.image.editter.innerWidth();\n\t\t\t\t\t\tthis.image.editter.css('margin-left', '-' + editerWidth/2 + 'px');\n\t\t\t\t\t}\n\n\t\t\t\t\treturn this.image.loadResizableControls($image, imageBox);\n\n\t\t\t\t},\n\t\t\t\tshowEdit: function($image)\n\t\t\t\t{\n\t\t\t\t\tif (this.events.imageEditing)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.observe.image = $image;\n\n\t\t\t\t\tvar $link = $image.closest('a', this.$editor[0]);\n\n\t\t\t\t\tthis.modal.load('image-edit', this.lang.get('edit'), 705);\n\n\t\t\t\t\tthis.image.buttonDelete = this.modal.getDeleteButton().text(this.lang.get('delete'));\n\t\t\t\t\tthis.image.buttonSave = this.modal.getActionButton().text(this.lang.get('save'));\n\n\t\t\t\t\tthis.image.buttonDelete.on('click', $.proxy(this.image.remove, this));\n\t\t\t\t\tthis.image.buttonSave.on('click', $.proxy(this.image.update, this));\n\n\t\t\t\t\tif (this.opts.imageCaption === false)\n\t\t\t\t\t{\n\t\t\t\t\t\t$('#redactor-image-caption').val('').hide().prev().hide();\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tvar $parent = $image.closest(this.opts.imageTag, this.$editor[0]);\n\t\t\t\t\t\tvar $ficaption = $parent.find('figcaption');\n\t\t\t\t\t\tif ($ficaption !== 0)\n\t\t\t\t\t\t{\n\n\t\t\t\t\t\t\t$('#redactor-image-caption').val($ficaption.text()).show();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!this.opts.imagePosition)\n\t\t\t\t\t{\n    \t\t\t\t\t$('.redactor-image-position-option').hide();\n    \t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tvar floatValue = ($image.css('display') == 'block' && $image.css('float') == 'none') ? 'center' : $image.css('float');\n\t\t\t\t\t\t$('#redactor-image-align').val(floatValue);\n\t\t\t\t\t}\n\n\t\t\t\t\t$('#redactor-image-preview').html($('<img src=\"' + $image.attr('src') + '\" style=\"max-width: 100%;\">'));\n\t\t\t\t\t$('#redactor-image-title').val($image.attr('alt'));\n\n\t\t\t\t\tvar $redactorImageLink = $('#redactor-image-link');\n\t\t\t\t\t$redactorImageLink.attr('href', $image.attr('src'));\n\t\t\t\t\tif ($link.length !== 0)\n\t\t\t\t\t{\n\t\t\t\t\t\t$redactorImageLink.val($link.attr('href'));\n\t\t\t\t\t\tif ($link.attr('target') === '_blank')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$('#redactor-image-link-blank').prop('checked', true);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\t// hide link's tooltip\n\t\t\t\t\t$('.redactor-link-tooltip').remove();\n\n\t\t\t\t\tthis.modal.show();\n\n\t\t\t\t\t// focus\n\t\t\t\t\tif (this.detect.isDesktop())\n\t\t\t\t\t{\n\t\t\t\t\t\t$('#redactor-image-title').focus();\n\t\t\t\t\t}\n\n\t\t\t\t},\n\t\t\t\tupdate: function()\n\t\t\t\t{\n\t\t\t\t\tvar $image = this.observe.image;\n\t\t\t\t\tvar $link = $image.closest('a', this.core.editor()[0]);\n\n\t\t\t\t\tvar title = $('#redactor-image-title').val().replace(/(<([^>]+)>)/ig,\"\");\n\t\t\t\t\t$image.attr('alt', title).attr('title', title);\n\n                    this.image.setFloating($image);\n\n\t\t\t\t\t// as link\n\t\t\t\t\tvar link = $.trim($('#redactor-image-link').val()).replace(/(<([^>]+)>)/ig,\"\");\n\t\t\t\t\tif (link !== '')\n\t\t\t\t\t{\n\t\t\t\t\t\t// test url (add protocol)\n\t\t\t\t\t\tvar pattern = '((xn--)?[a-z0-9]+(-[a-z0-9]+)*\\\\.)+[a-z]{2,}';\n\t\t\t\t\t\tvar re = new RegExp('^(http|ftp|https)://' + pattern, 'i');\n\t\t\t\t\t\tvar re2 = new RegExp('^' + pattern, 'i');\n\n\t\t\t\t\t\tif (link.search(re) === -1 && link.search(re2) === 0 && this.opts.linkProtocol)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tlink = this.opts.linkProtocol + '://' + link;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tvar target = ($('#redactor-image-link-blank').prop('checked')) ? true : false;\n\n\t\t\t\t\t\tif ($link.length === 0)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar a = $('<a href=\"' + link + '\" id=\"redactor-img-tmp\">' + this.utils.getOuterHtml($image) + '</a>');\n\t\t\t\t\t\t\tif (target)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\ta.attr('target', '_blank');\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t$image = $image.replaceWith(a);\n\t\t\t\t\t\t\t$link = this.core.editor().find('#redactor-img-tmp');\n\t\t\t\t\t\t\t$link.removeAttr('id');\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$link.attr('href', link);\n\t\t\t\t\t\t\tif (target)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t$link.attr('target', '_blank');\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t$link.removeAttr('target');\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse if ($link.length !== 0)\n\t\t\t\t\t{\n\t\t\t\t\t\t$link.replaceWith(this.utils.getOuterHtml($image));\n\t\t\t\t\t}\n\n                    this.image.addCaption($image, $link);\n\t\t\t\t\tthis.modal.close();\n\n\t\t\t\t\t// buffer\n\t\t\t\t\tthis.buffer.set();\n\n\t\t\t\t},\n\t\t\t\tsetFloating: function($image)\n\t\t\t\t{\n\t\t\t\t\tvar floating = $('#redactor-image-align').val();\n\n\t\t\t\t\tvar imageFloat = '';\n\t\t\t\t\tvar imageDisplay = '';\n\t\t\t\t\tvar imageMargin = '';\n\n\t\t\t\t\tswitch (floating)\n\t\t\t\t\t{\n\t\t\t\t\t\tcase 'left':\n\t\t\t\t\t\t\timageFloat = 'left';\n\t\t\t\t\t\t\timageMargin = '0 ' + this.opts.imageFloatMargin + ' ' + this.opts.imageFloatMargin + ' 0';\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t\tcase 'right':\n\t\t\t\t\t\t\timageFloat = 'right';\n\t\t\t\t\t\t\timageMargin = '0 0 ' + this.opts.imageFloatMargin + ' ' + this.opts.imageFloatMargin;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t\tcase 'center':\n\t\t\t\t\t\t\timageDisplay = 'block';\n\t\t\t\t\t\t\timageMargin = 'auto';\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\n\t\t\t\t\t$image.css({ 'float': imageFloat, display: imageDisplay, margin: imageMargin });\n\t\t\t\t\t$image.attr('rel', $image.attr('style'));\n\t\t\t\t},\n\t\t\t\taddCaption: function($image, $link)\n\t\t\t\t{\n                    var caption = $('#redactor-image-caption').val();\n\n                    var $target = ($link.length !== 0) ? $link : $image;\n\t\t\t\t\tvar $figcaption = $target.next();\n\n\t\t\t\t\tif ($figcaption.length === 0 || $figcaption[0].tagName !== 'FIGCAPTION')\n\t\t\t\t\t{\n\t\t\t\t\t\t$figcaption = false;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (caption !== '')\n\t\t\t\t\t{\n\t\t\t\t\t\tif ($figcaption === false)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$figcaption = $('<figcaption />').text(caption);\n\t\t\t\t\t\t\t$target.after($figcaption);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$figcaption.text(caption);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse if ($figcaption !== false)\n\t\t\t\t\t{\n\t\t\t\t\t\t$figcaption.remove();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tremove: function(e, $image, index)\n\t\t\t\t{\n\t\t\t\t\t$image = (typeof $image === 'undefined') ? $(this.observe.image) : $image;\n\n\t\t\t\t\t// delete from modal\n\t\t\t\t\tif (typeof e !== 'boolean')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.buffer.set();\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.events.stopDetectChanges();\n\n\t\t\t\t\tvar $link = $image.closest('a', this.core.editor()[0]);\n\t\t\t\t\tvar $figure = $image.closest(this.opts.imageTag, this.core.editor()[0]);\n\t\t\t\t\tvar $parent = $image.parent();\n\n\t\t\t\t\tif ($('#redactor-image-box').length !== 0)\n\t\t\t\t\t{\n\t\t\t\t\t\t$parent = $('#redactor-image-box').parent();\n\t\t\t\t\t}\n\n\t\t\t\t\tvar $next;\n\t\t\t\t\tif ($figure.length !== 0)\n\t\t\t\t\t{\n\t\t\t\t\t\t$next = $figure.next();\n\t\t\t\t\t\t$figure.remove();\n\t\t\t\t\t}\n\t\t\t\t\telse if ($link.length !== 0)\n\t\t\t\t\t{\n\t\t\t\t\t\t$parent = $link.parent();\n\t\t\t\t\t\t$link.remove();\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\t$image.remove();\n\t\t\t\t\t}\n\n\t\t\t\t\t$('#redactor-image-box').remove();\n\n\t\t\t\t\tif (e !== false)\n\t\t\t\t\t{\n\t\t\t\t\t\tif ($figure.length !== 0 && $next.length !== 0)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.caret.start($next);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if ($parent.length !== 0)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.caret.start($parent);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (typeof e !== 'boolean')\n\t\t\t\t\t{\n\n\t\t\t\t\t\tthis.modal.close();\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.utils.restoreScroll();\n\t\t\t\t\tthis.observe.image = false;\n\t\t\t\t\tthis.events.startDetectChanges();\n\t\t\t\t\tthis.placeholder.enable();\n\t\t\t\t\tthis.code.sync();\n\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =indent\n\t\tindent: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tincrease: function()\n\t\t\t\t{\n\t\t\t\t\tif (!this.list.get())\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar $current = $(this.selection.current()).closest('li');\n\t\t\t\t\tvar $list = $current.closest('ul, ol', this.core.editor()[0]);\n\n\t\t\t\t\tvar $li = $current.closest('li');\n\t\t\t\t\tvar $prev = $li.prev();\n\t\t\t\t\tif ($prev.length === 0 || $prev[0].tagName !== 'LI')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.buffer.set();\n\n\n\t\t\t\t\tif (this.utils.isCollapsed())\n\t\t\t\t\t{\n\t\t\t\t\t\tvar listTag = $list[0].tagName;\n\t\t\t\t\t\tvar $newList = $('<' + listTag + ' />');\n\n\t\t\t\t\t\tthis.selection.save();\n\n\t\t\t\t\t\t$newList.append($current);\n\t\t\t\t\t\t$prev.append($newList);\n\n\t\t\t\t\t\tthis.selection.restore();\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tdocument.execCommand('indent');\n\n\t\t\t\t\t\t// normalize\n\t\t\t\t\t\tthis.selection.save();\n\t\t\t\t\t\tthis.indent.removeEmpty();\n\t\t\t\t\t\tthis.indent.normalize();\n\t\t\t\t\t\tthis.selection.restore();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tdecrease: function()\n\t\t\t\t{\n\t\t\t\t\tif (!this.list.get())\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar $current = $(this.selection.current()).closest('li');\n\t\t\t\t\tvar $list = $current.closest('ul, ol', this.core.editor()[0]);\n\n\t\t\t\t\tthis.buffer.set();\n\n\t\t\t\t\tdocument.execCommand('outdent');\n\n\n\t\t\t\t\tvar $item = $(this.selection.current()).closest('li', this.core.editor()[0]);\n\n\t\t\t\t\tif (this.utils.isCollapsed())\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.indent.repositionItem($item);\n\t\t\t\t\t}\n\n\n\t\t\t\t\tif ($item.length === 0)\n\t\t\t\t\t{\n\t\t\t\t\t\tdocument.execCommand('formatblock', false, 'p');\n\t\t\t\t\t\t$item = $(this.selection.current());\n\t\t\t\t\t\tvar $next = $item.next();\n\t\t\t\t\t\tif ($next.length !== 0 && $next[0].tagName === 'BR')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$next.remove();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\t// normalize\n\t\t\t\t\tthis.selection.save();\n\t\t\t\t\tthis.indent.removeEmpty();\n\t\t\t\t\tthis.indent.normalize();\n\t\t\t\t\tthis.selection.restore();\n\n\t\t\t\t},\n\t\t\t\trepositionItem: function($item)\n\t\t\t\t{\n\t\t\t\t\tvar $prev = $item.prev();\n\t\t\t\t\tif ($prev.length !== 0 && $prev[0].tagName !== 'LI')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.selection.save();\n\t\t\t\t\t\tvar $li = $item.parents('li', this.core.editor()[0]);\n\t\t\t\t\t\t$li.after($item);\n\t\t\t\t\t\tthis.selection.restore();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tnormalize: function()\n\t\t\t\t{\n\t\t\t\t\tthis.core.editor().find('li').each($.proxy(function(i,s)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar $el = $(s);\n\n\t\t\t\t\t\t// remove style\n\t\t\t\t\t\t$el.find(this.opts.inlineTags.join(',')).each(function()\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$(this).removeAttr('style');\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\tvar $parent = $el.parent();\n\t\t\t\t\t\tif ($parent.length !== 0 && $parent[0].tagName === 'LI')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$parent.after($el);\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tvar $next = $el.next();\n\t\t\t\t\t\tif ($next.length !== 0 && ($next[0].tagName === 'UL' || $next[0].tagName === 'OL'))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$el.append($next);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}, this));\n\n\t\t\t\t},\n\t\t\t\tremoveEmpty: function($list)\n\t\t\t\t{\n\t\t\t\t\tvar $lists = this.core.editor().find('ul, ol');\n\t\t\t\t\tvar $items = this.core.editor().find('li');\n\n\t\t\t\t\t$items.each($.proxy(function(i, s)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.indent.removeItemEmpty(s);\n\n\t\t\t\t\t}, this));\n\n\t\t\t\t\t$lists.each($.proxy(function(i, s)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.indent.removeItemEmpty(s);\n\n\t\t\t\t\t}, this));\n\n\t\t\t\t\t$items.each($.proxy(function(i, s)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.indent.removeItemEmpty(s);\n\n\t\t\t\t\t}, this));\n\t\t\t\t},\n\t\t\t\tremoveItemEmpty: function(s)\n\t\t\t\t{\n\t\t\t\t\tvar html = s.innerHTML.replace(/[\\t\\s\\n]/g, '');\n\t\t\t\t\thtml = html.replace(/<span><\\/span>/g, '');\n\n\t\t\t\t\tif (html === '')\n\t\t\t\t\t{\n\t\t\t\t\t\t$(s).remove();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =inline\n\t\tinline: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tformat: function(tag, attr, value, type)\n\t\t\t\t{\n\t\t\t\t\ttag = tag.toLowerCase();\n\n\t\t\t\t\t// Stop formatting pre\n\t\t\t\t\tif (this.utils.isCurrentOrParent(['PRE']))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar tags = ['b', 'bold', 'i', 'italic', 'underline', 'strikethrough', 'deleted', 'superscript', 'subscript'];\n\t\t\t\t\tvar replaced = ['strong', 'strong', 'em', 'em', 'u', 'del', 'del', 'sup', 'sub'];\n\n\t\t\t\t\tfor (var i = 0; i < tags.length; i++)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (tag === tags[i])\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttag = replaced[i];\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.placeholder.hide();\n\t\t\t\t\tthis.buffer.set();\n\n\t\t\t\t\tif (this.utils.isCollapsed())\n\t\t\t\t\t{\n    \t\t\t\t\tthis.inline.formatCollapsed(tag, attr, value, type);\n    \t\t\t\t}\n    \t\t\t\telse\n    \t\t\t\t{\n    \t\t\t\t\tthis.inline.formatUncollapsed(tag, attr, value, type);\n    \t\t\t\t}\n\t\t\t\t},\n\t\t\t\tformatUncollapsed: function(tag, attr, value, type)\n\t\t\t\t{\n    \t\t\t\tvar self = this;\n    \t\t\t\tvar inlines = this.inline.inlines();\n    \t\t\t\tvar current = this.selection.current();\n    \t\t\t\tif (current)\n    \t\t\t\t{\n    \t\t\t\t    inlines.push(current);\n    \t\t\t\t}\n\n    \t\t\t\tthis.selection.save();\n\n\t\t\t\t\t// save del tag\n\t\t\t\t\tif (tag !== 'del')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.editor().find('del').each(function(i,s)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tself.utils.replaceToTag(s, 'deline');\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\t// save u tag\n\t\t\t\t\tif (tag !== 'u')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.editor().find('u').each(function(i,s)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tself.utils.replaceToTag(s, 'inline');\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n    \t\t\t\t$.each(inlines, function()\n    \t\t\t\t{\n        \t\t\t\tif (this.nodeType === 1)\n        \t\t\t\t{\n            \t\t\t\tvar currentTag = this.tagName.toLowerCase();\n            \t\t\t\tif (currentTag === tag)\n            \t\t\t\t{\n                                var $el = self.utils.replaceToTag(this, 'strike');\n                                $el.addClass('redactor-converted');\n              \t\t\t\t}\n          \t\t\t\t}\n    \t\t\t\t});\n\n    \t\t\t\tthis.selection.restore();\n\n    \t\t\t\tdocument.execCommand('strikethrough');\n\n    \t\t\t\tvar formatting = true;\n    \t\t\t\tvar parent = this.selection.parent();\n    \t\t\t\tif (parent === false || parent.tagName !== 'STRIKE')\n    \t\t\t\t{\n                        formatting = false;\n    \t\t\t\t}\n\n                    this.selection.save();\n                    if (tag !== 'u')\n    \t\t\t\t{\n        \t\t\t\tthis.core.editor().find('u').replaceWith(function()\n    \t\t\t\t\t{\n    \t\t\t\t\t\treturn $(this).contents();\n    \t\t\t\t\t});\n    \t\t\t\t}\n    \t\t\t\tthis.core.editor().find('strike').each(function()\n    \t\t\t\t{\n        \t\t\t\tvar $el = self.utils.replaceToTag(this, tag);\n        \t\t\t\tif (formatting)\n        \t\t\t\t{\n                            self.inline.setAttr($el, attr, value, type);\n                        }\n    \t\t\t\t});\n                    this.core.editor().find('.redactor-converted').each(function()\n    \t\t\t\t{\n        \t\t\t\tvar currentTag = this.tagName.toLowerCase();\n                        if (currentTag !== tag || formatting === false)\n                        {\n                            $(this).replaceWith(function()\n        \t\t\t\t\t{\n        \t\t\t\t\t\treturn $(this).contents();\n        \t\t\t\t\t});\n                        }\n                        $(this).removeClass('redactor-converted');\n    \t\t\t\t});\n                    // restore del tag\n\t\t\t\t\tif (tag !== 'del')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.editor().find('deline').each(function(i,s)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tself.utils.replaceToTag(s, 'del');\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n                    // restore u tag\n\t\t\t\t\tif (tag !== 'u')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.editor().find('inline').each(function(i,s)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tself.utils.replaceToTag(s, 'u');\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n    \t\t\t\tthis.selection.restore();\n\n                },\n                inlines: function()\n                {\n        \t\t\tvar inlines = [];\n        \t\t\tvar nodes = this.inline.nodes();\n\n        \t\t\t$.each(nodes, $.proxy(function(i,node)\n        \t\t\t{\n        \t\t\t\tif (this.utils.isInline(node))\n        \t\t\t\t{\n        \t\t\t\t\tinlines.push(node);\n        \t\t\t\t}\n\n        \t\t\t}, this));\n\n        \t\t\tvar inline = this.selection.inline();\n        \t\t\tif (inline === false && inlines.length === 0)\n        \t\t\t{\n        \t\t\t\treturn [];\n        \t\t\t}\n        \t\t\telse if (inline !== false && inlines.length === 0)\n        \t\t\t{\n        \t\t\t\treturn [inline];\n        \t\t\t}\n        \t\t\telse\n        \t\t\t{\n        \t\t\t\treturn inlines;\n        \t\t\t}\n                },\n                nodes: function()\n                {\n                    var sel = document.getSelection();\n\n                    if (!sel.rangeCount || sel.isCollapsed || !sel.getRangeAt(0).commonAncestorContainer)\n                    {\n                        return [];\n                    }\n\n                    var range = sel.getRangeAt(0);\n\n                    if (range.commonAncestorContainer.nodeType === 3)\n                    {\n                        var toRet = [];\n                        var currNode = range.commonAncestorContainer;\n                        while (currNode.parentNode && currNode.parentNode.childNodes.length === 1)\n                        {\n                            toRet.push(currNode.parentNode);\n                            currNode = currNode.parentNode;\n                        }\n\n                        return toRet;\n                    }\n\n                    return [].filter.call(range.commonAncestorContainer.getElementsByTagName('*'), function (el)\n                    {\n                        return (typeof sel.containsNode === 'function') ? sel.containsNode(el, true) : true;\n                    });\n                },\n\t\t\t\tformatCollapsed: function(tag, attr, value, type)\n\t\t\t\t{\n    \t\t\t\tvar inline = this.selection.inline();\n    \t\t\t\tif (inline)\n\t\t\t\t\t{\n                        var currentTag = inline.tagName.toLowerCase();\n                        if (currentTag === tag)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t// empty = remove\n\t\t\t\t\t\t\tif (this.utils.isEmpty(inline.innerHTML))\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tthis.caret.after(inline);\n\t\t\t\t\t\t\t\t$(inline).remove();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t// not empty = break\n\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tvar $first = this.inline.insertBreakpoint(inline, currentTag);\n\t\t\t\t\t\t\t\tthis.caret.after($first);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n                        else if ($(inline).closest(tag).length === 0)\n                        {\n\t\t\t\t\t\t\tthis.inline.insertInline(tag, attr, value, type);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n    \t\t\t\t\t\tthis.caret.start(inline);\n\t\t\t\t\t\t}\n    \t\t\t\t}\n    \t\t\t\telse\n    \t\t\t\t{\n                        this.inline.insertInline(tag, attr, value, type);\n    \t\t\t\t}\n\n\t\t\t\t},\n                insertBreakpoint: function(inline, currentTag)\n\t\t\t\t{\n\t\t\t\t\tvar breakpoint = document.createElement('span');\n\t\t\t\t\tbreakpoint.id = 'redactor-inline-breakpoint';\n\t\t\t\t\tbreakpoint = this.insert.node(breakpoint);\n\n\t\t\t\t\tvar end = this.utils.isEndOfElement(inline);\n\t\t\t\t\tvar code = this.utils.getOuterHtml(inline);\n\t\t\t\t\tvar endTag = (end) ? '' : '<' + currentTag + '>';\n\n\t\t\t\t\tcode = code.replace(/<span\\sid=\"redactor-inline-breakpoint\"><\\/span>/i, '</' + currentTag + '>' + endTag);\n\t\t\t\t\tvar $code = $(code);\n\t\t\t\t\t$(inline).replaceWith($code);\n\n\t\t\t\t\tif (endTag !== '')\n\t\t\t\t\t{\n    \t\t\t\t\tthis.utils.cloneAttributes(inline, $code.last());\n\t\t\t\t\t}\n\n\t\t\t\t\treturn $code.first();\n\t\t\t\t},\n\t\t\t\tinsertInline: function(tag, attr, value, type)\n\t\t\t\t{\n\t\t\t\t\tvar node = document.createElement(tag);\n\t\t\t\t\tnode = this.inline.setAttr(node, attr, value, type);\n\n\t\t\t\t\tthis.insert.node(node);\n\t\t\t\t\tthis.caret.start(node);\n\t\t\t\t},\n                setAttr: function(inline, attr, value, type)\n\t\t\t\t{\n\t\t\t\t\tif (typeof attr === 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn inline;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar func = (typeof type === 'undefined') ? 'toggle' : type;\n\n\t\t\t\t\tif (attr === 'class')\n\t\t\t\t\t{\n\t\t\t\t\t\tinline = this.inline[func + 'Class'](value, inline);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tif (func === 'remove')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tinline = this.inline[func + 'Attr'](attr, inline);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (func === 'removeAll')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tinline = this.inline[func + 'Attr'](inline);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tinline = this.inline[func + 'Attr'](attr, value, inline);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\treturn inline;\n\t\t\t\t},\n                getInlines: function(inline)\n\t\t\t\t{\n\t\t\t\t\treturn (typeof inline === 'undefined') ? this.selection.inlines() : inline;\n\t\t\t\t},\n\t\t\t\tupdate: function(tag, attr, value, type)\n\t\t\t\t{\n\t\t\t\t\tvar inlines = this.selection.inlines();\n\t\t\t\t\tvar result = [];\n\t\t\t\t\tvar self = this;\n\n\t\t\t\t\t$.each(inlines, function(i,s)\n\t\t\t\t\t{\n\t\t\t\t\t\tif ($.isArray(tag))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tif ($.inArray(s.tagName.toLowerCase(), tag) === -1)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tif (tag !== '*' && s.tagName.toLowerCase() !== tag)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tresult.push(self.inline.setAttr(s, attr, value, type));\n\n\t\t\t\t\t});\n\n\t\t\t\t\treturn result;\n\n\t\t\t\t},\n\t\t\t\treplaceClass: function(value, inline)\n\t\t\t\t{\n\t\t\t\t\treturn $(this.inline.getInlines(inline)).removeAttr('class').addClass(value)[0];\n\t\t\t\t},\n\t\t\t\ttoggleClass: function(value, inline)\n\t\t\t\t{\n\t\t\t\t\treturn $(this.inline.getInlines(inline)).toggleClass(value)[0];\n\t\t\t\t},\n\t\t\t\taddClass: function(value, inline)\n\t\t\t\t{\n\t\t\t\t\treturn $(this.inline.getInlines(inline)).addClass(value)[0];\n\t\t\t\t},\n\t\t\t\tremoveClass: function(value, inline)\n\t\t\t\t{\n\t\t\t\t\treturn $(this.inline.getInlines(inline)).removeClass(value)[0];\n\t\t\t\t},\n\t\t\t\tremoveAllClass: function(inline)\n\t\t\t\t{\n\t\t\t\t\treturn $(this.inline.getInlines(inline)).removeAttr('class')[0];\n\t\t\t\t},\n\t\t\t\treplaceAttr: function(inline, attr, value)\n\t\t\t\t{\n\t\t\t\t\tinline = this.inline.removeAttr(attr, this.inline.getInlines(inline));\n\n\t\t\t\t\treturn $(inline).attr(attr, value)[0];\n\t\t\t\t},\n\t\t\t\ttoggleAttr: function(attr, value, inline)\n\t\t\t\t{\n\t\t\t\t\tinline = this.inline.getInlines(inline);\n\n\t\t\t\t\tvar self = this;\n\t\t\t\t\tvar returned = [];\n\t\t\t\t\t$.each(inline, function(i,s)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar $el = $(s);\n\t\t\t\t\t\tif ($el.attr(attr))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturned.push(self.inline.removeAttr(attr, s));\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturned.push(self.inline.addAttr(attr, value, s));\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\n\t\t\t\t\treturn returned;\n\n\t\t\t\t},\n\t\t\t\taddAttr: function(attr, value, inline)\n\t\t\t\t{\n\t\t\t\t\treturn $(this.inline.getInlines(inline)).attr(attr, value)[0];\n\t\t\t\t},\n\t\t\t\tremoveAttr: function(attr, inline)\n\t\t\t\t{\n\t\t\t\t\treturn $(this.inline.getInlines(inline)).removeAttr(attr)[0];\n\t\t\t\t},\n\t\t\t\tremoveAllAttr: function(inline)\n\t\t\t\t{\n\t\t\t\t\tinline = this.inline.getInlines(inline);\n\n\t\t\t\t\tvar returned = [];\n\t\t\t\t\t$.each(inline, function(i, s)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (typeof s.attributes === 'undefined')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturned.push(s);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tvar $el = $(s);\n\t\t\t\t\t\tvar len = s.attributes.length;\n\t\t\t\t\t\tfor (var z = 0; z < len; z++)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$el.removeAttr(s.attributes[z].name);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturned.push($el[0]);\n\t\t\t\t\t});\n\n\t\t\t\t\treturn returned;\n\t\t\t\t},\n\t\t\t\tremoveFormat: function()\n\t\t\t\t{\n\t\t\t\t\tdocument.execCommand('removeFormat');\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =insert\n\t\tinsert: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tset: function(html)\n\t\t\t\t{\n\t\t\t\t\tthis.placeholder.hide();\n\n\t\t\t\t\tthis.code.set(html);\n\t\t\t\t\tthis.focus.end();\n\n\t\t\t\t\tthis.placeholder.enable();\n\t\t\t\t},\n\t\t\t\thtml: function(html, data)\n\t\t\t\t{\n\t\t\t\t\tthis.placeholder.hide();\n\t\t\t\t\tthis.core.editor().focus();\n\n\t\t\t\t\tvar block = this.selection.block();\n\t\t\t\t\tvar inline = this.selection.inline();\n\n\t\t\t\t\t// clean\n\t\t\t\t\tif (typeof data === 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\tdata = this.clean.getCurrentType(html, true);\n\t\t\t\t\t\thtml = this.clean.onPaste(html, data, true);\n\t\t\t\t\t}\n\n\t\t\t\t\thtml = $.parseHTML(html);\n\n\t\t\t\t\t// delete selected content\n\t\t\t\t\tvar sel = this.selection.get();\n\t\t\t\t\tvar range = this.selection.range(sel);\n\t\t\t\t\trange.deleteContents();\n\n\t\t\t\t\tthis.selection.update(sel, range);\n\n\t\t\t\t\t// insert list in list\n\t\t\t\t\tif (data.lists)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar $list = $(html);\n\t\t\t\t\t\tif ($list.length !== 0 && ($list[0].tagName === 'UL' || $list[0].tagName === 'OL'))\n\t\t\t\t\t\t{\n\n\t\t\t\t\t\t\tthis.insert.appendLists(block, $list);\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (data.blocks && block)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (this.utils.isSelectAll())\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.core.editor().html(html);\n\t\t\t\t\t\t\tthis.focus.end();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar breaked = this.utils.breakBlockTag();\n\t\t\t\t\t\t\tif (breaked === false)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tthis.insert.placeHtml(html);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t{\n    \t\t\t\t\t\t\tvar $last = $(html).children().last();\n\t\t\t\t\t\t\t\t$last.append(this.marker.get());\n\n\t\t\t\t\t\t\t\tif (breaked.type === 'start')\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tbreaked.$block.before(html);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tbreaked.$block.after(html);\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tthis.selection.restore();\n\t\t\t\t\t\t\t\tthis.core.editor().find('p').each(function()\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tif ($.trim(this.innerHTML) === '')\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t$(this).remove();\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tif (inline)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t// remove same tag inside\n\t\t\t\t\t\t\tvar $div = $(\"<div/>\").html(html);\n\t\t\t\t\t\t\t$div.find(inline.tagName.toLowerCase()).each(function()\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t$(this).contents().unwrap();\n\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\thtml = $div.html();\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (this.utils.isSelectAll())\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar $node = $(this.opts.emptyHtml);\n\t\t\t\t\t\t\tthis.core.editor().html('').append($node);\n\t\t\t\t\t\t\t$node.html(html);\n\t\t\t\t\t\t\tthis.caret.end($node);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.insert.placeHtml(html);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\n\t\t\t\t\tthis.utils.disableSelectAll();\n\t\t\t\t\tthis.linkify.format();\n\n\t\t\t\t\tif (data.pre)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.clean.cleanPre();\n\t\t\t\t\t}\n\n\t\t\t\t},\n\t\t\t\ttext: function(text)\n\t\t\t\t{\n\t\t\t\t\ttext = text.toString();\n\t\t\t\t\ttext = $.trim(text);\n\n\t\t\t\t\tvar tmp = document.createElement('div');\n\t\t\t\t\ttmp.innerHTML = text;\n\t\t\t\t\ttext = tmp.textContent || tmp.innerText;\n\n\t\t\t\t\tif (typeof text === 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.placeholder.hide();\n\t\t\t\t\tthis.core.editor().focus();\n\n\t\t\t\t\t// blocks\n\t\t\t\t\tvar blocks = this.selection.blocks();\n\n\t\t\t\t\t// nl to spaces\n\t\t\t\t\ttext = text.replace(/\\n/g, ' ');\n\n\t\t\t\t\t// select all\n\t\t\t\t\tif (this.utils.isSelectAll())\n\t\t\t\t\t{\n\t\t\t\t\t\tvar $node = $(this.opts.emptyHtml);\n\t\t\t\t\t\tthis.core.editor().html('').append($node);\n\t\t\t\t\t\t$node.html(text);\n\t\t\t\t\t\tthis.caret.end($node);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\t// insert\n\t\t\t\t\t\tvar sel = this.selection.get();\n\t\t\t\t\t\tvar node = document.createTextNode(text);\n\n\t\t\t\t\t\tif (sel.getRangeAt && sel.rangeCount)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar range = sel.getRangeAt(0);\n\t\t\t\t\t\t\trange.deleteContents();\n\t\t\t\t\t\t\trange.insertNode(node);\n\t\t\t\t\t\t\trange.setStartAfter(node);\n\t\t\t\t\t\t\trange.collapse(true);\n\n\t\t\t\t\t\t\tthis.selection.update(sel, range);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// wrap node if selected two or more block tags\n\t\t\t\t\t\tif (blocks.length > 1)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$(node).wrap('<p>');\n\t\t\t\t\t\t\tthis.caret.after(node);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.utils.disableSelectAll();\n\t\t\t\t\tthis.linkify.format();\n\t\t\t\t\tthis.clean.normalizeCurrentHeading();\n\n\t\t\t\t},\n\t\t\t\traw: function(html)\n\t\t\t\t{\n\t\t\t\t\tthis.placeholder.hide();\n\t\t\t\t\tthis.core.editor().focus();\n\n\t\t\t\t\tvar sel = this.selection.get();\n\n\t\t\t\t\tvar range = this.selection.range(sel);\n\t\t\t\t\trange.deleteContents();\n\n\t\t            var el = document.createElement(\"div\");\n\t\t            el.innerHTML = html;\n\n\t\t            var frag = document.createDocumentFragment(), node, lastNode;\n\t\t            while ((node = el.firstChild))\n\t\t            {\n\t\t                lastNode = frag.appendChild(node);\n\t\t            }\n\n\t\t            range.insertNode(frag);\n\n\t\t\t\t\tif (lastNode)\n\t\t\t\t\t{\n\t\t\t\t\t\trange = range.cloneRange();\n\t\t\t\t\t\trange.setStartAfter(lastNode);\n\t\t\t\t\t\trange.collapse(true);\n\t\t\t\t\t\tsel.removeAllRanges();\n\t\t\t\t\t\tsel.addRange(range);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tnode: function(node, deleteContent)\n\t\t\t\t{\n\t\t\t\t\tthis.placeholder.hide();\n\n\t\t\t\t\tif (typeof this.start !== 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.editor().focus();\n\t\t\t\t\t}\n\n\t\t\t\t\tnode = node[0] || node;\n\n\t\t\t\t\tvar block = this.selection.block();\n\t\t\t\t\tvar gap = this.utils.isBlockTag(node.tagName);\n\n\t\t\t\t\tif (this.utils.isSelectAll())\n\t\t\t\t\t{\n\t\t\t\t\t\tif (gap)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.core.editor().html(node);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.core.editor().html($('<p>').html(node));\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tthis.code.sync();\n\t\t\t\t\t}\n\t\t\t\t\telse if (gap && block)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar breaked = this.utils.breakBlockTag();\n\t\t\t\t\t\tif (breaked === false)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.insert.placeNode(node, deleteContent);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tif (breaked.type === 'start')\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tbreaked.$block.before(node);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tbreaked.$block.after(node);\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tthis.core.editor().find('p:empty').remove();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.insert.placeNode(node, deleteContent);\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.utils.disableSelectAll();\n\t\t\t\t\tthis.caret.end(node);\n\n\t\t\t\t\treturn node;\n\n\t\t\t\t},\n\t\t\t\tappendLists: function(block, $list)\n\t\t\t\t{\n\t\t\t\t\tvar $block = $(block);\n\t\t\t\t\tvar last;\n\t\t\t\t\tvar isEmpty = this.utils.isEmpty(block.innerHTML);\n\n\t\t\t\t\tif (isEmpty || this.utils.isEndOfElement(block))\n\t\t\t\t\t{\n\t\t\t\t\t\tlast = $block;\n\t\t\t\t\t\t$list.find('li').each(function()\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tlast.after(this);\n\t\t\t\t\t\t\tlast = $(this);\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\tif (isEmpty)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$block.remove();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse if (this.utils.isStartOfElement(block))\n\t\t\t\t\t{\n\t\t\t\t\t\t$list.find('li').each(function()\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$block.before(this);\n\t\t\t\t\t\t\tlast = $(this);\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t        var endOfNode = this.selection.extractEndOfNode(block);\n\n\t\t\t\t        $block.after($('<li>').append(endOfNode));\n\t\t\t\t        $block.append($list);\n\t\t\t\t\t\tlast = $list;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.marker.remove();\n\n\t\t\t\t\tif (last)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.caret.end(last);\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.linkify.format();\n\t\t\t\t},\n\t\t\t\tplaceHtml: function(html)\n\t\t\t\t{\n\t\t\t\t\tvar marker = document.createElement('span');\n\t\t\t\t\tmarker.id = 'redactor-insert-marker';\n\t\t\t\t\tmarker = this.insert.node(marker);\n\n\t\t\t\t\t$(marker).before(html);\n\t\t\t\t\tthis.selection.restore();\n\t\t\t\t\tthis.caret.after(marker);\n\t\t\t\t\t$(marker).remove();\n\t\t\t\t},\n\t\t\t\tplaceNode: function(node, deleteContent)\n\t\t\t\t{\n\t\t\t\t\tvar sel = this.selection.get();\n\t\t\t\t\tvar range = this.selection.range(sel);\n\n\t\t\t\t\tif (deleteContent !== false)\n\t\t\t\t\t{\n\t\t\t\t\t\trange.deleteContents();\n\t\t\t\t\t}\n\n\t\t\t\t\trange.insertNode(node);\n\t\t\t\t\trange.collapse(false);\n\n\t\t\t\t\tthis.selection.update(sel, range);\n\t\t\t\t},\n\t\t\t\tnodeToPoint: function(e, node)\n\t\t\t\t{\n\t\t\t\t\tthis.placeholder.hide();\n\n\t\t\t\t\tnode = node[0] || node;\n\n\t\t\t\t\tif (this.utils.isEmpty())\n\t\t\t\t\t{\n\t\t\t\t\t\tnode = (this.utils.isBlock(node)) ? node : $('<p />').append(node);\n\n\t\t\t\t\t\tthis.core.editor().html(node);\n\n\t\t\t\t\t\treturn node;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar range;\n\t\t\t\t\tvar x = e.clientX, y = e.clientY;\n\t\t\t\t\tif (document.caretPositionFromPoint)\n\t\t\t\t\t{\n\t\t\t\t\t    var pos = document.caretPositionFromPoint(x, y);\n\t\t\t\t\t    var sel = document.getSelection();\n\t\t\t\t\t    range = sel.getRangeAt(0);\n\t\t\t\t\t    range.setStart(pos.offsetNode, pos.offset);\n\t\t\t\t\t    range.collapse(true);\n\t\t\t\t\t    range.insertNode(node);\n\t\t\t\t\t}\n\t\t\t\t\telse if (document.caretRangeFromPoint)\n\t\t\t\t\t{\n\t\t\t\t\t    range = document.caretRangeFromPoint(x, y);\n\t\t\t\t\t    range.insertNode(node);\n\t\t\t\t\t}\n\t\t\t\t\telse if (typeof document.body.createTextRange !== \"undefined\")\n\t\t\t\t\t{\n\t\t\t\t        range = document.body.createTextRange();\n\t\t\t\t        range.moveToPoint(x, y);\n\t\t\t\t        var endRange = range.duplicate();\n\t\t\t\t        endRange.moveToPoint(x, y);\n\t\t\t\t        range.setEndPoint(\"EndToEnd\", endRange);\n\t\t\t\t        range.select();\n\t\t\t\t\t}\n\n\t\t\t\t\treturn node;\n\n\t\t\t\t},\n\n\t\t\t\t// #backward\n\t\t\t\tnodeToCaretPositionFromPoint: function(e, node)\n\t\t\t\t{\n\t\t\t\t\tthis.insert.nodeToPoint(e, node);\n\t\t\t\t},\n\t\t\t\tmarker: function()\n\t\t\t\t{\n\t\t\t\t\tthis.marker.insert();\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =keydown\n\t\tkeydown: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tinit: function(e)\n\t\t\t\t{\n\t\t\t\t\tif (this.rtePaste)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar key = e.which;\n\t\t\t\t\tvar arrow = (key >= 37 && key <= 40);\n\n\t\t\t\t\tthis.keydown.ctrl = e.ctrlKey || e.metaKey;\n\t\t\t\t\tthis.keydown.parent = this.selection.parent();\n\t\t\t\t\tthis.keydown.current = this.selection.current();\n\t\t\t\t\tthis.keydown.block = this.selection.block();\n\n\t\t\t        // detect tags\n\t\t\t\t\tthis.keydown.pre = this.utils.isTag(this.keydown.current, 'pre');\n\t\t\t\t\tthis.keydown.blockquote = this.utils.isTag(this.keydown.current, 'blockquote');\n\t\t\t\t\tthis.keydown.figcaption = this.utils.isTag(this.keydown.current, 'figcaption');\n\t\t\t\t\tthis.keydown.figure = this.utils.isTag(this.keydown.current, 'figure');\n\n\t\t\t\t\t// callback\n\t\t\t\t\tvar keydownStop = this.core.callback('keydown', e);\n\t\t\t\t\tif (keydownStop === false)\n\t\t\t\t\t{\n\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\t// shortcuts setup\n\t\t\t\t\tthis.shortcuts.init(e, key);\n\n\t\t\t\t\t// buffer\n\t\t\t\t\tthis.keydown.checkEvents(arrow, key);\n                    this.keydown.setupBuffer(e, key);\n\n\t\t\t\t\tif (this.utils.isSelectAll() && ( key === this.keyCode.ENTER || key === this.keyCode.BACKSPACE || key === this.keyCode.DELETE))\n\t\t\t\t\t{\n\t\t\t\t\t\te.preventDefault();\n\n\t\t\t\t\t\tthis.code.set(this.opts.emptyHtml);\n\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.keydown.addArrowsEvent(arrow);\n\t\t\t\t\tthis.keydown.setupSelectAll(e, key);\n\n\t\t\t\t\t// turn off enter key\n\t\t\t\t\tif (!this.opts.enterKey && key === this.keyCode.ENTER)\n\t\t\t\t\t{\n\t\t\t\t\t\te.preventDefault();\n\n\t\t\t\t\t\t// remove selected\n\t\t\t\t\t\tvar sel = this.selection.get();\n\t\t\t\t\t\tvar range = this.selection.range(sel);\n\n\t\t\t\t\t\tif (!range.collapsed)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\trange.deleteContents();\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\t// down\n\t\t\t\t\tif (this.opts.enterKey && key === this.keyCode.DOWN)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.keydown.onArrowDown();\n\t\t\t\t\t}\n\n\t\t\t\t\t// up\n\t\t\t\t\tif (this.opts.enterKey && key === this.keyCode.UP)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.keydown.onArrowUp();\n\t\t\t\t\t}\n\n\n\t\t\t\t\t// replace to p before / after the table or into body\n\t\t\t\t\tif ((this.opts.type === 'textarea' || this.opts.type === 'div') && this.keydown.current && this.keydown.current.nodeType === 3 && $(this.keydown.parent).hasClass('redactor-in'))\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.keydown.wrapToParagraph();\n\t\t\t\t\t}\n\n\t\t\t\t\t// on Shift+Space or Ctrl+Space\n\t\t\t\t\tif (key === this.keyCode.SPACE && (e.ctrlKey || e.shiftKey))\n\t\t\t\t\t{\n\t\t\t\t\t\te.preventDefault();\n\n\t\t\t\t\t\treturn this.keydown.onShiftSpace();\n\t\t\t\t\t}\n\n\t\t\t\t\t// on Shift+Enter or Ctrl+Enter\n\t\t\t\t\tif (key === this.keyCode.ENTER && (e.ctrlKey || e.shiftKey))\n\t\t\t\t\t{\n\t\t\t\t\t\te.preventDefault();\n\n\t\t\t\t\t\treturn this.keydown.onShiftEnter(e);\n\t\t\t\t\t}\n\n\t\t\t\t\t// on enter\n\t\t\t\t\tif (key === this.keyCode.ENTER && !e.shiftKey && !e.ctrlKey && !e.metaKey)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn this.keydown.onEnter(e);\n\t\t\t\t\t}\n\n\t\t\t\t\t// tab or cmd + [\n\t\t\t\t\tif (key === this.keyCode.TAB || e.metaKey && key === 221 || e.metaKey && key === 219)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn this.keydown.onTab(e, key);\n\t\t\t\t\t}\n\n\t\t\t\t\t// backspace & delete\n\t\t\t\t\tif (key === this.keyCode.BACKSPACE || key === this.keyCode.DELETE)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.keydown.onBackspaceAndDeleteBefore();\n\t\t\t\t\t}\n\n\n\t\t\t\t\tif (key === this.keyCode.DELETE)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar $next = $(this.keydown.block).next();\n\n\t\t\t\t\t\t// delete figure\n\t\t\t\t\t\tif (this.utils.isEndOfElement(this.keydown.block) && $next.length !== 0 && $next[0].tagName === 'FIGURE')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$next.remove();\n\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// append list (safari bug)\n\t\t\t\t\t\tvar tagLi = (this.keydown.block && this.keydown.block.tagName === 'LI') ? this.keydown.block : false;\n\t\t\t\t\t\tif (tagLi)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar $list = $(this.keydown.block).parents('ul, ol').last();\n\t\t\t\t\t\t\tvar $nextList = $list.next();\n\n\t\t\t\t\t\t\tif (this.utils.isRedactorParent($list) && this.utils.isEndOfElement($list) && $nextList.length !== 0\n\t\t\t\t\t\t\t\t&& ($nextList[0].tagName === 'UL' || $nextList[0].tagName === 'OL'))\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\te.preventDefault();\n\n\t\t\t\t\t\t\t\t$list.append($nextList.contents());\n\t\t\t\t\t\t\t\t$nextList.remove();\n\n\t\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// append pre\n\t\t\t\t\t\tif (this.utils.isEndOfElement(this.keydown.block) && $next.length !== 0 && $next[0].tagName === 'PRE')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$(this.keydown.block).append($next.text());\n\t\t\t\t\t\t\t$next.remove();\n\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}\n\n\t\t\t\t\t// image delete\n\t\t\t\t\tif (key === this.keyCode.DELETE && $('#redactor-image-box').length !== 0)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.image.remove();\n\t\t\t\t\t}\n\n\t\t\t\t\t// backspace\n\t\t\t\t\tif (key === this.keyCode.BACKSPACE)\n\t\t\t\t\t{\n\n\t\t\t\t\t\tif (this.detect.isFirefox())\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.line.removeOnBackspace(e);\n\t\t\t\t\t\t}\n\n                        // combine list after and before if paragraph is empty\n                        if (this.list.combineAfterAndBefore(this.keydown.block))\n                        {\n                            e.preventDefault();\n                            return;\n                        }\n\n\t\t\t\t\t\t// backspace as outdent\n\t\t\t\t\t\tvar block = this.selection.block();\n\t\t\t\t\t\tif (block && block.tagName === 'LI' && this.utils.isCollapsed() && this.utils.isStartOfElement())\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.indent.decrease();\n\t\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tthis.keydown.removeInvisibleSpace();\n\t\t\t\t\t\tthis.keydown.removeEmptyListInTable(e);\n\n\t\t\t\t\t}\n\n\t\t\t\t\tif (key === this.keyCode.BACKSPACE || key === this.keyCode.DELETE)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.keydown.onBackspaceAndDeleteAfter(e);\n\t\t\t\t\t}\n\n\t\t\t\t},\n\t\t\t\tonShiftSpace: function()\n\t\t\t\t{\n\t\t\t\t\tthis.buffer.set();\n\t\t\t\t\tthis.insert.raw('&nbsp;');\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\t\t\t\tonShiftEnter: function(e)\n\t\t\t\t{\n\t\t\t\t\tthis.buffer.set();\n\n\t\t\t\t\treturn (this.keydown.pre) ? this.keydown.insertNewLine(e) : this.insert.raw('<br>');\n\t\t\t\t},\n\t\t\t\tonBackspaceAndDeleteBefore: function()\n\t\t\t\t{\n\t\t\t\t\tthis.utils.saveScroll();\n\t\t\t\t},\n\t\t\t\tonBackspaceAndDeleteAfter: function(e)\n\t\t\t\t{\n\t\t\t\t\t// remove style tag\n\t\t\t\t\tsetTimeout($.proxy(function()\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.code.syncFire = false;\n\t\t\t\t\t\tthis.keydown.removeEmptyLists();\n\n\t\t\t\t\t\tthis.core.editor().find('*[style]').not('img, #redactor-image-box, #redactor-image-editter').removeAttr('style');\n\n\t\t\t\t\t\tthis.keydown.formatEmpty(e);\n\t\t\t\t\t\tthis.code.syncFire = true;\n\n\t\t\t\t\t}, this), 1);\n\t\t\t\t},\n\t\t\t\tonEnter: function(e)\n\t\t\t\t{\n\t\t\t\t\tvar stop = this.core.callback('enter', e);\n\t\t\t\t\tif (stop === false)\n\t\t\t\t\t{\n\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\t// blockquote exit\n\t\t\t\t\tif (this.keydown.blockquote && this.keydown.exitFromBlockquote(e) === true)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\t// pre\n\t\t\t\t\tif (this.keydown.pre)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn this.keydown.insertNewLine(e);\n\t\t\t\t\t}\n\t\t\t\t\t// blockquote & figcaption\n\t\t\t\t\telse if (this.keydown.blockquote || this.keydown.figcaption)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn this.keydown.insertBreakLine(e);\n\t\t\t\t\t}\n\t\t\t\t\t// figure\n\t\t\t\t\telse if (this.keydown.figure)\n\t\t\t\t\t{\n\t\t\t\t\t\tsetTimeout($.proxy(function()\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.keydown.replaceToParagraph('FIGURE');\n\n\t\t\t\t\t\t}, this), 1);\n\t\t\t\t\t}\n\t\t\t\t\t// paragraphs\n\t\t\t\t\telse if (this.keydown.block)\n\t\t\t\t\t{\n\t\t\t\t\t\tsetTimeout($.proxy(function()\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.keydown.replaceToParagraph('DIV');\n\n\t\t\t\t\t\t}, this), 1);\n\n\t\t\t\t\t\t// empty list exit\n\t\t\t\t\t\tif (this.keydown.block.tagName === 'LI')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar current = this.selection.current();\n\t\t\t\t\t\t\tvar $parent = $(current).closest('li', this.$editor[0]);\n\t\t\t\t\t\t\tvar $list = $parent.parents('ul,ol', this.$editor[0]).last();\n\n\t\t\t\t\t\t\tif ($parent.length !== 0 && this.utils.isEmpty($parent.html()) && $list.next().length === 0 && this.utils.isEmpty($list.find(\"li\").last().html()))\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t$list.find(\"li\").last().remove();\n\n\t\t\t\t\t\t\t\tvar node = $(this.opts.emptyHtml);\n\t\t\t\t\t\t\t\t$list.after(node);\n\t\t\t\t\t\t\t\tthis.caret.start(node);\n\n\t\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}\n\t\t\t\t\t// outside\n\t\t\t\t\telse if (!this.keydown.block)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn this.keydown.insertParagraph(e);\n\t\t\t\t\t}\n\n                    // firefox enter into inline element\n\t\t\t\t\tif (this.detect.isFirefox() && this.utils.isInline(this.keydown.parent))\n\t\t\t\t\t{\n                        this.keydown.insertBreakLine(e);\n                        return;\n                    }\n\n\t\t\t\t\t// remove inline tags in new-empty paragraph\n\t\t\t\t\tsetTimeout($.proxy(function()\n\t\t\t\t\t{\n\t\t\t\t\t\tvar inline = this.selection.inline();\n\t\t\t\t\t\tif (inline && this.utils.isEmpty(inline.innerHTML))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar parent = this.selection.block();\n\t\t\t\t\t\t\t$(inline).remove();\n\t\t\t\t\t\t\t//this.caret.start(parent);\n\n                            var range = document.createRange();\n                            range.setStart(parent, 0);\n\n                            var textNode = document.createTextNode('\\u200B');\n\n                            range.insertNode(textNode);\n                            range.setStartAfter(textNode);\n                            range.collapse(true);\n\n                            var sel = window.getSelection();\n            \t\t\t\tsel.removeAllRanges();\n            \t\t\t\tsel.addRange(range);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}, this), 1);\n\n\t\t\t\t},\n\t\t\t\tcheckEvents: function(arrow, key)\n\t\t\t\t{\n\t\t\t\t\tif (!arrow && (this.core.getEvent() === 'click' || this.core.getEvent() === 'arrow'))\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.addEvent(false);\n\n\t\t\t\t\t\tif (this.keydown.checkKeyEvents(key))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.buffer.set();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tcheckKeyEvents: function(key)\n\t\t\t\t{\n\t\t\t\t\tvar k = this.keyCode;\n\t\t\t\t\tvar keys = [k.BACKSPACE, k.DELETE, k.ENTER, k.ESC, k.TAB, k.CTRL, k.META, k.ALT, k.SHIFT];\n\n\t\t\t\t\treturn ($.inArray(key, keys) === -1) ? true : false;\n\n\t\t\t\t},\n\t\t\t\taddArrowsEvent: function(arrow)\n\t\t\t\t{\n\t\t\t\t\tif (!arrow)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif ((this.core.getEvent() === 'click' || this.core.getEvent() === 'arrow'))\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.addEvent(false);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t    this.core.addEvent('arrow');\n\t\t\t\t},\n\t\t\t\tsetupBuffer: function(e, key)\n\t\t\t\t{\n\t\t\t\t\tif (this.keydown.ctrl && key === 90 && !e.shiftKey && !e.altKey && this.opts.buffer.length) // z key\n\t\t\t\t\t{\n\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\tthis.buffer.undo();\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\t// redo\n\t\t\t\t\telse if (this.keydown.ctrl && key === 90 && e.shiftKey && !e.altKey && this.opts.rebuffer.length !== 0)\n\t\t\t\t\t{\n\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\tthis.buffer.redo();\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\telse if (!this.keydown.ctrl)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (key === this.keyCode.SPACE || key === this.keyCode.BACKSPACE || key === this.keyCode.DELETE || (key === this.keyCode.ENTER && !e.ctrlKey && !e.shiftKey))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.buffer.set();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\texitFromBlockquote: function(e)\n\t\t\t\t{\n\n\t\t\t\t\tif (!this.utils.isEndOfElement(this.keydown.blockquote))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar tmp = this.clean.removeSpacesHard($(this.keydown.blockquote).html());\n\t\t\t\t\tif (tmp.search(/(<br\\s?\\/?>){3}$/i) !== -1)\n\t\t\t\t\t{\n\t\t\t\t\t\te.preventDefault();\n\n\t\t\t\t\t\tvar $last = $(this.keydown.blockquote).children().last().prev();\n\n\t\t\t\t\t\t$last.prev().filter('br').remove();\n\t\t\t\t\t\t$last.filter('br').remove();\n\t\t\t\t\t\t$(this.keydown.blockquote).children().last().filter('br').remove();\n\t\t\t\t\t\t$(this.keydown.blockquote).children().last().filter('span').remove();\n\n\t\t\t\t\t\tvar node = $(this.opts.emptyHtml);\n\t\t\t\t\t\t$(this.keydown.blockquote).after(node);\n\t\t\t\t\t\tthis.caret.start(node);\n\n\t\t\t\t\t\treturn true;\n\n\t\t\t\t\t}\n\n\t\t\t\t\treturn;\n\n\t\t\t\t},\n\t\t\t\tonArrowDown: function()\n\t\t\t\t{\n\t\t\t\t\tvar tags = [this.keydown.blockquote, this.keydown.pre, this.keydown.figcaption];\n\n\t\t\t\t\tfor (var i = 0; i < tags.length; i++)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (tags[i])\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.keydown.insertAfterLastElement(tags[i]);\n\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tonArrowUp: function()\n\t\t\t\t{\n\t\t\t\t\tvar tags = [this.keydown.blockquote, this.keydown.pre, this.keydown.figcaption];\n\n\t\t\t\t\tfor (var i = 0; i < tags.length; i++)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (tags[i])\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.keydown.insertBeforeFirstElement(tags[i]);\n\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tinsertAfterLastElement: function(element)\n\t\t\t\t{\n\t\t\t\t\tif (!this.utils.isEndOfElement(element))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar last = this.core.editor().contents().last();\n\t\t\t\t\tvar $next = (element.tagName === 'FIGCAPTION') ? $(this.keydown.block).parent().next() : $(this.keydown.block).next();\n\n\t\t\t\t\tif ($next.length !== 0)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\telse if (last.length === 0 && last[0] !== element)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.caret.start(last);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tvar node = $(this.opts.emptyHtml);\n\n\t\t\t\t\t\tif (element.tagName === 'FIGCAPTION')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t    $(element).parent().after(node);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n    \t\t\t\t\t\t$(element).after(node);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tthis.caret.start(node);\n\t\t\t\t\t}\n\n\t\t\t\t},\n\t\t\t\tinsertBeforeFirstElement: function(element)\n\t\t\t\t{\n\t\t\t\t\tif (!this.utils.isStartOfElement())\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.core.editor().contents().length > 1 && this.core.editor().contents().first()[0] !== element)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar node = $(this.opts.emptyHtml);\n\t\t\t\t\t$(element).before(node);\n\t\t\t\t\tthis.caret.start(node);\n\n\t\t\t\t},\n\t\t\t\tonTab: function(e, key)\n\t\t\t\t{\n\t\t\t\t\tif (!this.opts.tabKey)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar isList = (this.keydown.block && this.keydown.block.tagName === 'LI')\n\t\t\t\t\tif (this.utils.isEmpty(this.code.get()) || (!isList && !this.keydown.pre && this.opts.tabAsSpaces === false))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\n\t\t\t\t\te.preventDefault();\n\t\t\t\t\tthis.buffer.set();\n\n                    var isListStart = (isList && this.utils.isStartOfElement(this.keydown.block));\n\t\t\t\t\tvar node;\n\n\t\t\t\t\tif (this.keydown.pre && !e.shiftKey)\n\t\t\t\t\t{\n\t\t\t\t\t\tnode = (this.opts.preSpaces) ? document.createTextNode(Array(this.opts.preSpaces + 1).join('\\u00a0')) : document.createTextNode('\\t');\n\t\t\t\t\t\tthis.insert.node(node);\n\t\t\t\t\t}\n\t\t\t\t\telse if (this.opts.tabAsSpaces !== false && !isListStart)\n\t\t\t\t\t{\n\t\t\t\t\t\tnode = document.createTextNode(Array(this.opts.tabAsSpaces + 1).join('\\u00a0'));\n\t\t\t\t\t\tthis.insert.node(node);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tif (e.metaKey && key === 219)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.indent.decrease();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (e.metaKey && key === 221)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.indent.increase();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (!e.shiftKey)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.indent.increase();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.indent.decrease();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\t\t\t\tsetupSelectAll: function(e, key)\n\t\t\t\t{\n\t\t\t\t\tif (this.keydown.ctrl && key === 65)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.utils.enableSelectAll();\n\t\t\t\t\t}\n\t\t\t\t\telse if (key !== this.keyCode.LEFT_WIN && !this.keydown.ctrl)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.utils.disableSelectAll();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tinsertNewLine: function(e)\n\t\t\t\t{\n\t\t\t\t\te.preventDefault();\n\n\t\t\t\t\tvar node = document.createTextNode('\\n');\n\n\t\t\t\t\tvar sel = this.selection.get();\n\t\t\t\t\tvar range = this.selection.range(sel);\n\n\t\t\t\t\trange.deleteContents();\n\t\t\t\t\trange.insertNode(node);\n\n\t\t\t\t\tthis.caret.after(node);\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\t\t\t\tinsertParagraph: function(e)\n\t\t\t\t{\n\t\t\t\t\te.preventDefault();\n\n\t\t\t\t\tvar p = document.createElement('p');\n\t\t\t\t\tp.innerHTML = this.opts.invisibleSpace;\n\n\t\t\t\t\tvar sel = this.selection.get();\n\t\t\t\t\tvar range = this.selection.range(sel);\n\n\t\t\t\t\trange.deleteContents();\n\t\t\t\t\trange.insertNode(p);\n\n\t\t\t\t\tthis.caret.start(p);\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\t\t\t\tinsertBreakLine: function(e)\n\t\t\t\t{\n\t\t\t\t\treturn this.keydown.insertBreakLineProcessing(e);\n\t\t\t\t},\n\t\t\t\tinsertDblBreakLine: function(e)\n\t\t\t\t{\n\t\t\t\t\treturn this.keydown.insertBreakLineProcessing(e, true);\n\t\t\t\t},\n\t\t\t\tinsertBreakLineProcessing: function(e, dbl)\n\t\t\t\t{\n\t\t\t\t\te.stopPropagation();\n\n\t\t\t\t\tvar br1 = document.createElement('br');\n\t\t\t\t\tthis.insert.node(br1);\n\n\t\t\t\t\tif (dbl === true)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar br2 = document.createElement('br');\n\t\t\t\t\t\tthis.insert.node(br2);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\n\t\t\t\t},\n\t\t\t\twrapToParagraph: function()\n\t\t\t\t{\n\t\t\t\t\tvar $current = $(this.keydown.current);\n\t\t\t\t\tvar\tnode = $('<p>').append($current.clone());\n\t\t\t\t\t$current.replaceWith(node);\n\n\n\t\t\t\t\tvar next = $(node).next();\n\t\t\t\t\tif (typeof(next[0]) !== 'undefined' && next[0].tagName === 'BR')\n\t\t\t\t\t{\n\t\t\t\t\t\tnext.remove();\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.caret.end(node);\n\n\t\t\t\t},\n\t\t\t\treplaceToParagraph: function(tag)\n\t\t\t\t{\n\t\t\t\t\tvar blockElem = this.selection.block();\n\t\t\t\t\tvar $prev = $(blockElem).prev();\n\n\t\t\t\t\tvar blockHtml = blockElem.innerHTML.replace(/<br\\s?\\/?>/gi, '');\n\t\t\t\t\tif (blockElem.tagName === tag && this.utils.isEmpty(blockHtml) && !$(blockElem).hasClass('redactor-in'))\n\t\t\t\t\t{\n\t\t\t\t\t\tvar p = document.createElement('p');\n\t\t\t\t\t\t$(blockElem).replaceWith(p);\n\n                        this.keydown.setCaretToParagraph(p);\n\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\t\t\t\t\telse if (blockElem.tagName === 'P')\n\t\t\t\t\t{\n\t\t\t\t\t\t$(blockElem).removeAttr('class').removeAttr('style');\n\n\t\t\t\t\t\t// fix #227\n\t\t\t\t\t\tif (this.detect.isIe() && this.utils.isEmpty(blockHtml) && this.utils.isInline(this.keydown.parent))\n                        {\n                            $(blockElem).on('input', $.proxy(function()\n                            {\n                                var parent = this.selection.parent();\n                                if (this.utils.isInline(parent))\n                                {\n                                    var html = $(parent).html();\n                                    $(blockElem).html(html);\n                                    this.caret.end(blockElem);\n                                }\n\n                                $(blockElem).off('keyup');\n\n                            }, this));\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\t\t\t\t\telse if ($prev.hasClass(this.opts.videoContainerClass))\n\t\t\t\t\t{\n    \t\t\t\t\t$prev.removeAttr('class');\n\n    \t\t\t\t\tvar p = document.createElement('p');\n\t\t\t\t\t\t$prev.replaceWith(p);\n\n\t\t\t\t\t\tthis.keydown.setCaretToParagraph(p);\n\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tsetCaretToParagraph: function(p)\n\t\t\t\t{\n                    var range = document.createRange();\n                    range.setStart(p, 0);\n\n                    var textNode = document.createTextNode('\\u200B');\n\n                    range.insertNode(textNode);\n                    range.setStartAfter(textNode);\n                    range.collapse(true);\n\n                    var sel = window.getSelection();\n    \t\t\t\tsel.removeAllRanges();\n    \t\t\t\tsel.addRange(range);\n\t\t\t\t},\n\t\t\t\tremoveInvisibleSpace: function()\n\t\t\t\t{\n\t\t\t\t\tvar $current = $(this.keydown.current);\n\t\t\t\t\tif ($current.text().search(/^\\u200B$/g) === 0)\n\t\t\t\t\t{\n\t\t\t\t\t\t$current.remove();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tremoveEmptyListInTable: function(e)\n\t\t\t\t{\n\t\t\t\t\tvar $current = $(this.keydown.current);\n\t\t\t\t\tvar $parent = $(this.keydown.parent);\n\t\t\t\t\tvar td = $current.closest('td', this.$editor[0]);\n\n\t\t\t\t\tif (td.length !== 0 && $current.closest('li', this.$editor[0]) && $parent.children('li').length === 1)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (!this.utils.isEmpty($current.text()))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\te.preventDefault();\n\n\t\t\t\t\t\t$current.remove();\n\t\t\t\t\t\t$parent.remove();\n\n\t\t\t\t\t\tthis.caret.start(td);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tremoveEmptyLists: function()\n\t\t\t\t{\n\t\t\t\t\tvar removeIt = function()\n\t\t\t\t\t{\n\t\t\t\t\t\tvar html = $.trim(this.innerHTML).replace(/\\/t\\/n/g, '');\n\t\t\t\t\t\tif (html === '')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$(this).remove();\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\n\t\t\t\t\tthis.core.editor().find('li').each(removeIt);\n\t\t\t\t\tthis.core.editor().find('ul, ol').each(removeIt);\n\t\t\t\t},\n\t\t\t\tformatEmpty: function(e)\n\t\t\t\t{\n\t\t\t\t\tvar html = $.trim(this.core.editor().html());\n\n\t\t\t\t\tif (!this.utils.isEmpty(html))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\te.preventDefault();\n\n\t\t\t\t\tif (this.opts.type === 'inline' || this.opts.type === 'pre')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.editor().html(this.marker.html());\n\t\t\t\t\t\tthis.selection.restore();\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.editor().html(this.opts.emptyHtml);\n\t\t\t\t\t\tthis.focus.start();\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =keyup\n\t\tkeyup: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tinit: function(e)\n\t\t\t\t{\n\n\t\t\t\t\tif (this.rtePaste)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar key = e.which;\n\t\t\t\t\tthis.keyup.block = this.selection.block();\n\t\t\t\t\tthis.keyup.current = this.selection.current();\n\t\t\t\t\tthis.keyup.parent = this.selection.parent();\n\n\t\t\t\t\t// callback\n\t\t\t\t\tvar stop = this.core.callback('keyup', e);\n\t\t\t\t\tif (stop === false)\n\t\t\t\t\t{\n\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n                    // replace a prev figure to paragraph if caret is before image\n                    if (key === this.keyCode.ENTER)\n                    {\n                        if (this.keyup.block && this.keyup.block.tagName === 'FIGURE')\n                        {\n                            var $prev = $(this.keyup.block).prev();\n                            if ($prev.length !== 0 && $prev[0].tagName === 'FIGURE')\n                            {\n                                var $newTag = this.utils.replaceToTag($prev, 'p');\n                                this.caret.start($newTag);\n                                return;\n                            }\n                        }\n                    }\n\n\t\t\t\t\t// replace figure to paragraph\n\t\t\t\t\tif (key === this.keyCode.BACKSPACE || key === this.keyCode.DELETE)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (this.utils.isSelectAll())\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.focus.start();\n\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\n\t\t\t\t\t\t// if caret before figure - delete image\n\t\t\t\t\t\tif (this.keyup.block && this.keydown.block && this.keyup.block.tagName === 'FIGURE' && this.utils.isStartOfElement(this.keydown.block))\n\t\t\t\t\t\t{\n    \t\t\t\t\t\te.preventDefault();\n\n                            this.selection.save();\n                            $(this.keyup.block).find('figcaption').remove();\n    \t\t\t\t\t\t$(this.keyup.block).find('img').first().remove();\n    \t\t\t\t\t\tthis.utils.replaceToTag(this.keyup.block, 'p');\n\n    \t\t\t\t\t\tvar $marker = this.marker.find();\n    \t\t\t\t\t\t$('html, body').animate({ scrollTop: $marker.position().top + 20 }, 500);\n\n    \t\t\t\t\t\tthis.selection.restore();\n    \t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\n\t\t\t\t\t\t// if paragraph does contain only image replace to figure\n\t\t\t\t\t\tif (this.keyup.block && this.keyup.block.tagName === 'P')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar isContainImage = $(this.keyup.block).find('img').length;\n\t\t\t\t\t\t\tvar text = $(this.keyup.block).text().replace(/\\u200B/g, '');\n\t\t\t\t\t\t\tif (text === '' && isContainImage !== 0)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tthis.utils.replaceToTag(this.keyup.block, 'figure');\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// if figure does not contain image - replace to paragraph\n\t\t\t\t\t\tif (this.keyup.block && this.keyup.block.tagName === 'FIGURE' && $(this.keyup.block).find('img').length === 0)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.selection.save();\n\t\t\t\t\t\t\tthis.utils.replaceToTag(this.keyup.block, 'p');\n\t\t\t\t\t\t\tthis.selection.restore();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\t// linkify\n\t\t\t\t\tif (this.linkify.isKey(key))\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.linkify.format();\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t};\n\t\t},\n\n\t\t// =lang\n\t\tlang: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tload: function()\n\t\t\t\t{\n\t\t\t\t\tthis.opts.curLang = this.opts.langs[this.opts.lang];\n\t\t\t\t},\n\t\t\t\tget: function(name)\n\t\t\t\t{\n\t\t\t\t\treturn (typeof this.opts.curLang[name] !== 'undefined') ? this.opts.curLang[name] : '';\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =line\n\t\tline: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tinsert: function()\n\t\t\t\t{\n\t\t\t\t\tthis.buffer.set();\n\n\t\t\t\t\t// insert\n\t\t\t\t\tthis.insert.html(this.line.getLineHtml());\n\n\t\t\t\t\t// find\n\t\t\t\t\tvar $hr = this.core.editor().find('#redactor-hr-tmp-id');\n\t\t\t\t\t$hr.removeAttr('id');\n\n\t\t\t\t\tthis.core.callback('insertedLine', $hr);\n\n\t\t\t\t\treturn $hr;\n\t\t\t\t},\n\t\t\t\tgetLineHtml: function()\n\t\t\t\t{\n\t\t\t\t\tvar html = '<hr id=\"redactor-hr-tmp-id\" />';\n\t\t\t\t\tif (!this.detect.isFirefox() && this.utils.isEmpty())\n\t\t\t\t\t{\n\t\t\t\t\t\thtml += '<p>' + this.opts.emptyHtml + '</p>';\n\t\t\t\t\t}\n\n\t\t\t\t\treturn html;\n\t\t\t\t},\n\t\t\t\t// ff only\n\t\t\t\tremoveOnBackspace: function(e)\n\t\t\t\t{\n\t\t\t\t\tif (!this.utils.isCollapsed())\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar $block = $(this.selection.block());\n\t\t\t\t\tif ($block.length === 0 || !this.utils.isStartOfElement($block))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\t// if hr is previous element\n\t\t\t\t\tvar $prev = $block.prev();\n\t\t\t\t\tif ($prev && $prev[0].tagName === 'HR')\n\t\t\t\t\t{\n\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\t$prev.remove();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =link\n\t\tlink: function()\n\t\t{\n\t\t\treturn {\n\n\t\t\t\t// public\n\t\t\t\tget: function()\n\t\t\t\t{\n\t\t\t\t\treturn $(this.selection.inlines('a'));\n\t\t\t\t},\n\t\t\t\tis: function()\n\t\t\t\t{\n\t\t\t\t\tvar nodes = this.selection.nodes() ;\n\t\t\t\t\tvar $link = $(this.selection.current()).closest('a', this.core.editor()[0]);\n\n\t\t\t\t\treturn ($link.length === 0 || nodes.length > 1) ? false : $link;\n\t\t\t\t},\n\t\t\t\tunlink: function(e)\n\t\t\t\t{\n\t\t\t\t\t// if call from clickable element\n\t\t\t\t\tif (typeof e !== 'undefined' && e.preventDefault)\n\t\t\t\t\t{\n\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t}\n\n\t\t\t\t\t// buffer\n\t\t\t\t\tthis.buffer.set();\n\n\t\t\t\t\tvar links = this.selection.inlines('a');\n\t\t\t\t\tif (links.length === 0)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar $links = this.link.replaceLinksToText(links);\n\n\t\t\t\t\tthis.observe.closeAllTooltip();\n\t\t\t\t\tthis.core.callback('deletedLink', $links);\n\n\t\t\t\t},\n\t\t\t\tinsert: function(link, cleaned)\n\t\t\t\t{\n\t\t\t\t\tvar $el = this.link.is();\n\n\t\t\t\t\tif (cleaned !== true)\n\t\t\t\t\t{\n\t\t\t\t\t\tlink = this.link.buildLinkFromObject($el, link);\n\t\t\t\t\t\tif (link === false)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\t// buffer\n\t\t\t\t\tthis.buffer.set();\n\n\t\t\t\t\t// callback\n\t\t\t\t\tlink = this.core.callback('beforeInsertingLink', link);\n\n\t\t\t\t\tif ($el === false)\n\t\t\t\t\t{\n\t\t\t\t\t\t// insert\n\t\t\t\t\t\t$el = $('<a />');\n\t\t\t\t\t\t$el = this.link.update($el, link);\n\t\t\t\t\t\t$el = $(this.insert.node($el));\n\n\t\t\t\t\t\tvar $parent = $el.parent();\n\t\t\t\t\t\tif (this.utils.isRedactorParent($parent) === false)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$el.wrap('<p>');\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// remove unlink wrapper\n\t\t\t\t\t\tif ($parent.hasClass('redactor-unlink'))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$parent.replaceWith(function(){\n\t\t\t\t\t\t\t\treturn $(this).contents();\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tthis.caret.after($el);\n\t\t\t\t\t\tthis.core.callback('insertedLink', $el);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\t// update\n\t\t\t\t\t\t$el = this.link.update($el, link);\n\t\t\t\t\t\tthis.caret.after($el);\n\t\t\t\t\t}\n\n\t\t\t\t},\n\t\t\t\tupdate: function($el, link)\n\t\t\t\t{\n\t\t\t\t\t$el.text(link.text);\n\t\t\t\t\t$el.attr('href', link.url);\n\n\t\t\t\t\tthis.link.target($el, link.target);\n\n\t\t\t\t\treturn $el;\n\n\t\t\t\t},\n\t\t\t\ttarget: function($el, target)\n\t\t\t\t{\n\t\t\t\t\treturn (target) ? $el.attr('target', '_blank') : $el.removeAttr('target');\n\t\t\t\t},\n\t\t\t\tshow: function(e)\n\t\t\t\t{\n\t\t\t\t\t// if call from clickable element\n\t\t\t\t\tif (typeof e !== 'undefined' && e.preventDefault)\n\t\t\t\t\t{\n\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t}\n\n\t\t\t\t\t// close tooltip\n\t\t\t\t\tthis.observe.closeAllTooltip();\n\n\t\t\t\t\t// is link\n\t\t\t\t\tvar $el = this.link.is();\n\n\t\t\t\t\t// build modal\n\t\t\t\t\tthis.link.buildModal($el);\n\n\t\t\t\t\t// build link\n\t\t\t\t\tvar link = this.link.buildLinkFromElement($el);\n\n\t\t\t\t\t// if link cut & paste inside editor browser added self host to a link\n\t\t\t\t\tlink.url = this.link.removeSelfHostFromUrl(link.url);\n\n                    // new tab target\n\t\t\t\t\tif (this.opts.linkNewTab && !$el)\n\t\t\t\t\t{\n    \t\t\t\t\tlink.target = true;\n\t\t\t\t\t}\n\n\t\t\t\t\t// set modal values\n\t\t\t\t\tthis.link.setModalValues(link);\n\n\t\t\t\t\t// show modal\n\t\t\t\t\tthis.modal.show();\n\n\t\t\t\t\t// focus\n\t\t\t\t\tif (this.detect.isDesktop())\n\t\t\t\t\t{\n\t\t\t\t\t\t$('#redactor-link-url').focus();\n\t\t\t\t\t}\n\t\t\t\t},\n\n\t\t\t\t// private\n\t\t\t\tsetModalValues: function(link)\n\t\t\t\t{\n\t\t\t\t\t$('#redactor-link-blank').prop('checked', link.target);\n\t\t\t\t\t$('#redactor-link-url').val(link.url);\n\t\t\t\t\t$('#redactor-link-url-text').val(link.text);\n\t\t\t\t},\n\t\t\t\tbuildModal: function($el)\n\t\t\t\t{\n\t\t\t\t\tthis.modal.load('link', this.lang.get(($el === false) ? 'link-insert' : 'link-edit'), 600);\n\n\t\t\t\t\t// button insert\n\t\t\t\t\tvar $btn = this.modal.getActionButton();\n\t\t\t\t\t$btn.text(this.lang.get(($el === false) ? 'insert' : 'save')).on('click', $.proxy(this.link.callback, this));\n\n\t\t\t\t},\n\t\t\t\tcallback: function()\n\t\t\t\t{\n\t\t\t\t\t// build link\n\t\t\t\t\tvar link = this.link.buildLinkFromModal();\n\t\t\t\t\tif (link === false)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\t// close\n\t\t\t\t\tthis.modal.close();\n\n\t\t\t\t\t// insert or update\n\t\t\t\t\tthis.link.insert(link, true);\n\t\t\t\t},\n\t\t\t\tcleanUrl: function(url)\n\t\t\t\t{\n\t\t\t\t\treturn (typeof url === 'undefined') ? '' : $.trim(url.replace(/[^\\W\\w\\D\\d+&\\'@#/%?=~_|!:,.;\\(\\)]/gi, ''));\n\t\t\t\t},\n\t\t\t\tcleanText: function(text)\n\t\t\t\t{\n\t\t\t\t\treturn (typeof text === 'undefined') ? '' :$.trim(text.replace(/(<([^>]+)>)/gi, ''));\n\t\t\t\t},\n\t\t\t\tgetText: function(link)\n\t\t\t\t{\n\t\t\t\t\treturn (link.text === '' && link.url !== '') ? this.link.truncateUrl(link.url.replace(/<|>/g, '')) : link.text;\n\t\t\t\t},\n\t\t\t\tisUrl: function(url)\n\t\t\t\t{\n\t\t\t\t\tvar pattern = '((xn--)?[\\\\W\\\\w\\\\D\\\\d]+(-[\\\\W\\\\w\\\\D\\\\d]+)*\\\\.)+[\\\\W\\\\w]{2,}';\n\n\t\t\t\t\tvar re1 = new RegExp('^(http|ftp|https)://' + pattern, 'i');\n\t\t\t\t\tvar re2 = new RegExp('^' + pattern, 'i');\n\t\t\t\t\tvar re3 = new RegExp('\\.(html|php)$', 'i');\n\t\t\t\t\tvar re4 = new RegExp('^/', 'i');\n\t\t\t\t\tvar re5 = new RegExp('^tel:(.*?)', 'i');\n\n\t\t\t\t\t// add protocol\n\t\t\t\t\tif (url.search(re1) === -1 && url.search(re2) !== -1 && url.search(re3) === -1)\n\t\t\t\t\t{\n\t\t\t\t\t\turl = 'http://' + url;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (url.search(re1) !== -1 || url.search(re3) !== -1 || url.search(re4) !== -1 || url.search(re5) !== -1)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn url;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\t\t\t\tisMailto: function(url)\n\t\t\t\t{\n\t\t\t\t\treturn (url.search('@') !== -1 && /(http|ftp|https):\\/\\//i.test(url) === false);\n\t\t\t\t},\n\t\t\t\tisEmpty: function(link)\n\t\t\t\t{\n\t\t\t\t\treturn (link.url === '' || (link.text === '' && link.url === ''));\n\t\t\t\t},\n\t\t\t\ttruncateUrl: function(url)\n\t\t\t\t{\n\t\t\t\t\treturn (url.length > this.opts.linkSize) ? url.substring(0, this.opts.linkSize) + '...' : url;\n\t\t\t\t},\n\t\t\t\tparse: function(link)\n\t\t\t\t{\n\t\t\t\t\t// mailto\n\t\t\t\t\tif (this.link.isMailto(link.url))\n\t\t\t\t\t{\n\t\t\t\t\t\tlink.url = 'mailto:' + link.url.replace('mailto:', '');\n\t\t\t\t\t}\n\t\t\t\t\t// url\n\t\t\t\t\telse if (link.url.search('#') !== 0)\n\t\t\t\t\t{\n\t\t\t\t\t\tlink.url = this.link.isUrl(link.url);\n\t\t\t\t\t}\n\n\t\t\t\t\t// empty url or text or isn't url\n\t\t\t\t\treturn (this.link.isEmpty(link) || link.url === false) ? false : link;\n\n\t\t\t\t},\n\t\t\t\tbuildLinkFromModal: function()\n\t\t\t\t{\n\t\t\t\t\tvar link = {};\n\n\t\t\t\t\t// url\n\t\t\t\t\tlink.url = this.link.cleanUrl($('#redactor-link-url').val());\n\n\t\t\t\t\t// text\n\t\t\t\t\tlink.text = this.link.cleanText($('#redactor-link-url-text').val());\n\t\t\t\t\tlink.text = this.link.getText(link);\n\n\t\t\t\t\t// target\n\t\t\t\t\tlink.target = ($('#redactor-link-blank').prop('checked')) ? true : false;\n\n\t\t\t\t\t// parse\n\t\t\t\t\treturn this.link.parse(link);\n\n\t\t\t\t},\n\t\t\t\tbuildLinkFromObject: function($el, link)\n\t\t\t\t{\n\t\t\t\t\t// url\n\t\t\t\t\tlink.url = this.link.cleanUrl(link.url);\n\n\t\t\t\t\t// text\n\t\t\t\t\tlink.text = (typeof link.text === 'undefined' && this.selection.is()) ? this.selection.text() : this.link.cleanText(link.text);\n\t\t\t\t\tlink.text = this.link.getText(link);\n\n\t\t\t\t\t// target\n\t\t\t\t\tlink.target = ($el === false) ? link.target : this.link.buildTarget($el);\n\n\t\t\t\t\t// parse\n\t\t\t\t\treturn this.link.parse(link);\n\n\t\t\t\t},\n\t\t\t\tbuildLinkFromElement: function($el)\n\t\t\t\t{\n\t\t\t\t\tvar link = {\n\t\t\t\t\t\turl: '',\n\t\t\t\t\t\ttext: (this.selection.is()) ? this.selection.text() : '',\n\t\t\t\t\t\ttarget: false\n\t\t\t\t\t};\n\n\t\t\t\t\tif ($el !== false)\n\t\t\t\t\t{\n\t\t\t\t\t\tlink.url = $el.attr('href');\n\t\t\t\t\t\tlink.text = $el.text();\n\t\t\t\t\t\tlink.target = this.link.buildTarget($el);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn link;\n\t\t\t\t},\n\t\t\t\tbuildTarget: function($el)\n\t\t\t\t{\n\t\t\t\t\treturn (typeof $el.attr('target') !== 'undefined' && $el.attr('target') === '_blank') ? true : false;\n\t\t\t\t},\n\t\t\t\tremoveSelfHostFromUrl: function(url)\n\t\t\t\t{\n\t\t\t\t\tvar href = self.location.href.replace('#', '').replace(/\\/$/i, '');\n\t\t\t\t\treturn url.replace(/^\\/\\#/, '#').replace(href, '').replace('mailto:', '');\n\t\t\t\t},\n\t\t\t\treplaceLinksToText: function(links)\n\t\t\t\t{\n\t\t\t\t\tvar $first;\n\t\t\t\t\tvar $links = $.each(links, function(i,s)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar $el = $(s);\n\t\t\t\t\t\tvar $unlinked = $('<span class=\"redactor-unlink\" />').append($el.contents());\n\t\t\t\t\t\t$el.replaceWith($unlinked);\n\n\t\t\t\t\t\tif (i === 0)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$first = $unlinked;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn $el;\n\t\t\t\t\t});\n\n\t\t\t\t\t// set caret after unlinked node\n\t\t\t\t\tif (links.length === 1 && this.selection.isCollapsed())\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.caret.after($first);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn $links;\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =linkify\n\t\tlinkify: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tisKey: function(key)\n\t\t\t\t{\n\t\t\t\t\treturn key === this.keyCode.ENTER || key === this.keyCode.SPACE;\n\t\t\t\t},\n\t\t\t\tisLink: function(node)\n\t\t\t\t{\n\t\t\t\t\treturn (node.nodeValue.match(this.opts.regexps.linkyoutube) || node.nodeValue.match(this.opts.regexps.linkvimeo) || node.nodeValue.match(this.opts.regexps.linkimage) || node.nodeValue.match(this.opts.regexps.url));\n\t\t\t\t},\n\t\t\t\tisFiltered: function(i, node)\n\t\t\t\t{\n\t\t\t\t\treturn node.nodeType === 3 && $.trim(node.nodeValue) !== \"\" && !$(node).parent().is(\"pre\") && (this.linkify.isLink(node));\n\t\t\t\t},\n\t\t\t\thandler: function(i, node)\n\t\t\t\t{\n\t\t\t\t\tvar $el = $(node);\n\t\t\t\t\tvar text = $el.text();\n\t\t\t\t\tvar html = text;\n\n\t\t\t\t\tif (html.match(this.opts.regexps.linkyoutube) || html.match(this.opts.regexps.linkvimeo))\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = this.linkify.convertVideoLinks(html);\n\t\t\t\t\t}\n\t\t\t\t\telse if (html.match(this.opts.regexps.linkimage))\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = this.linkify.convertImages(html);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = this.linkify.convertLinks(html);\n\t\t\t\t\t}\n\n\t\t\t\t\t$el.before(text.replace(text, html)).remove();\n\t\t\t\t},\n\t\t\t\tformat: function()\n\t\t\t\t{\n\t\t\t\t\tif (!this.opts.linkify || this.utils.isCurrentOrParent('pre'))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.core.editor().find(\":not(iframe,img,a,pre,.redactor-unlink)\").addBack().contents().filter($.proxy(this.linkify.isFiltered, this)).each($.proxy(this.linkify.handler, this));\n\n\t\t\t\t\t// collect\n\t\t\t\t\tvar $objects = this.core.editor().find('.redactor-linkify-object').each($.proxy(function(i,s)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar $el = $(s);\n\t\t\t\t\t\t$el.removeClass('redactor-linkify-object');\n\t\t\t\t\t\tif ($el.attr('class') === '')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$el.removeAttr('class');\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (s.tagName === 'DIV') // video container\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.linkify.breakBlockTag($el, 'video');\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (s.tagName === 'IMG') // image\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.linkify.breakBlockTag($el, 'image');\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (s.tagName === 'A')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.core.callback('insertedLink', $el);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn $el;\n\n\t\t\t\t\t}, this));\n\n\t\t\t\t\t// callback\n\t\t\t\t\tsetTimeout($.proxy(function()\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.code.sync();\n\t\t\t\t\t\tthis.core.callback('linkify', $objects);\n\n\t\t\t\t\t}, this), 100);\n\n\t\t\t\t},\n\t\t\t\tbreakBlockTag: function($el, type)\n\t\t\t\t{\n\t\t\t\t\tvar breaked = this.utils.breakBlockTag();\n\t\t\t\t\tif (breaked === false)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar $newBlock = $el;\n\t\t\t\t\tif (type === 'image')\n\t\t\t\t\t{\n\t\t\t\t\t\t$newBlock = $('<figure />').append($el);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (breaked.type === 'start')\n\t\t\t\t\t{\n\t\t\t\t\t\tbreaked.$block.before($newBlock);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tbreaked.$block.after($newBlock);\n\t\t\t\t\t}\n\n\n\t\t\t\t\tif (type === 'image')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.caret.after($newBlock);\n\t\t\t\t\t}\n\n\t\t\t\t},\n\t\t\t\tconvertVideoLinks: function(html)\n\t\t\t\t{\n\t\t\t\t\tvar iframeStart = '<div class=\"' + this.opts.videoContainerClass + ' redactor-linkify-object\"><iframe class=\"redactor-linkify-object\" width=\"500\" height=\"281\" src=\"';\n\t\t\t\t\tvar iframeEnd = '\" frameborder=\"0\" allowfullscreen></iframe></div>';\n\n\t\t\t\t\tif (html.match(this.opts.regexps.linkyoutube))\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = html.replace(this.opts.regexps.linkyoutube, iframeStart + '//www.youtube.com/embed/$1' + iframeEnd);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (html.match(this.opts.regexps.linkvimeo))\n\t\t\t\t\t{\n\t\t\t\t\t\thtml = html.replace(this.opts.regexps.linkvimeo, iframeStart + '//player.vimeo.com/video/$2' + iframeEnd);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn html;\n\t\t\t\t},\n\t\t\t\tconvertImages: function(html)\n\t\t\t\t{\n\t\t\t\t\tvar matches = html.match(this.opts.regexps.linkimage);\n\t\t\t\t\tif (!matches)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn html;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn html.replace(html, '<img src=\"' + matches + '\" class=\"redactor-linkify-object\" />');\n\t\t\t\t},\n\t\t\t\tconvertLinks: function(html)\n\t\t\t\t{\n\t\t\t\t\tvar matches = html.match(this.opts.regexps.url);\n\t\t\t\t\tif (!matches)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn html;\n\t\t\t\t\t}\n\n\t\t\t\t\tmatches = $.grep(matches, function(v, k) { return $.inArray(v, matches) === k; });\n\n\t\t\t\t\tvar length = matches.length;\n\n\t\t\t\t\tfor (var i = 0; i < length; i++)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar href = matches[i], text = href;\n\t\t\t\t\t\tvar linkProtocol = (href.match(/(https?|ftp):\\/\\//i) !== null) ? '' : 'http://';\n\n\t\t\t\t\t\tif (text.length > this.opts.linkSize)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttext = text.substring(0, this.opts.linkSize) + '...';\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (text.search('%') === -1)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttext = decodeURIComponent(text);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tvar regexB = \"\\\\b\";\n\n\t\t\t\t\t\tif ($.inArray(href.slice(-1), [\"/\", \"&\", \"=\"]) !== -1)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tregexB = \"\";\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// escaping url\n\t\t\t\t\t\tvar regexp = new RegExp('(' + href.replace(/[\\-\\[\\]\\/\\{\\}\\(\\)\\*\\+\\?\\.\\\\\\^\\$\\|]/g, \"\\\\$&\") + regexB + ')', 'g');\n\n\t\t\t\t\t\thtml = html.replace(regexp, '<a href=\"' + linkProtocol + $.trim(href) + '\" class=\"redactor-linkify-object\">' + $.trim(text) + '</a>');\n\t\t\t\t\t}\n\n\t\t\t\t\treturn html;\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =list\n\t\tlist: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\ttoggle: function(cmd)\n\t\t\t\t{\n\t\t\t\t\tif (this.utils.inBlocks(['table', 'td', 'th', 'tr']))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar tag = (cmd === 'orderedlist' || cmd === 'ol') ? 'OL' : 'UL';\n\t\t\t\t\tcmd = (tag === 'OL') ? 'orderedlist' : 'unorderedlist'\n\n\t\t\t\t\tvar $list = $(this.selection.current()).parentsUntil('.redactor-in', 'ul, ol').first();\n\n\t\t\t\t\tthis.placeholder.hide();\n\t\t\t\t\tthis.buffer.set();\n\n\n\t\t\t\t\tif ($list.length !== 0 && $list[0].tagName === tag && this.utils.isRedactorParent($list))\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.selection.save();\n\n\t\t\t\t\t\t// remove list\n\t\t\t\t\t\t$list.find('ul, ol').each(function()\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar parent = $(this).closest('li');\n\t\t\t\t\t\t\t$(this).find('li').each(function()\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t$(parent).after(this);\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\t$list.find('ul, ol').remove();\n\t\t\t\t\t\t$list.find('li').each(function()\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn $(this).replaceWith(function()\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\treturn $('<p />').append($(this).contents());\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t});\n\n\n\t\t\t\t\t\t$list.replaceWith(function()\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn $(this).contents();\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\tthis.selection.restore();\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\n\t\t\t\t\tthis.selection.save();\n\n\t\t\t\t\tif ($list.length !== 0 && $list[0].tagName !== tag)\n\t\t\t\t\t{\n                        $list.each($.proxy(function(i,s)\n                        {\n                            this.utils.replaceToTag(s, tag);\n\n                        }, this));\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t    document.execCommand('insert' + cmd);\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.selection.restore();\n\n\t\t\t\t\tvar $insertedList = this.list.get();\n\t\t\t\t\tif (!$insertedList)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (!this.selection.block())\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tdocument.execCommand('formatblock', false, 'p');\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\t// clear span\n\t\t\t\t\t$insertedList.find('span').replaceWith(function()\n\t\t\t\t\t{\n\t\t\t\t\t\treturn $(this).contents();\n\t\t\t\t\t});\n\n\t\t\t\t\t// remove style\n\t\t\t\t\t$insertedList.find(this.opts.inlineTags.join(',')).each(function()\n\t\t\t\t\t{\n\t\t\t\t\t\t$(this).removeAttr('style');\n\t\t\t\t\t});\n\n\t\t\t\t\t// remove block-element list wrapper\n\t\t\t\t\tvar $listParent = $insertedList.parent();\n\t\t\t\t\tif (this.utils.isRedactorParent($listParent) && $listParent[0].tagName !== 'LI' && this.utils.isBlock($listParent))\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.selection.save();\n\n\t\t\t\t\t\t$listParent.replaceWith($listParent.contents());\n\n\t\t\t\t\t\tthis.selection.restore();\n\t\t\t\t\t}\n\n\t\t\t\t},\n\t\t\t\tget: function()\n\t\t\t\t{\n\t\t\t\t\tvar current = this.selection.current();\n\t\t\t\t\tvar $list = $(current).closest('ul, ol', this.core.editor()[0]);\n\n\t\t\t\t\treturn ($list.length === 0) ? false : $list;\n\t\t\t\t},\n\t\t\t\tcombineAfterAndBefore: function(block)\n\t\t\t\t{\n    \t\t\t\tvar $prev = $(block).prev();\n    \t\t\t\tvar $next = $(block).next();\n                    var isEmptyBlock = (block && block.tagName === 'P' && (block.innerHTML === '<br>' || block.innerHTML === ''));\n                    var isBlockWrapped = ($prev.closest('ol, ul', this.core.editor()[0]).length === 1 && $next.closest('ol, ul', this.core.editor()[0]).length === 1);\n\n                    if (isEmptyBlock && isBlockWrapped)\n                    {\n                        $prev.children('li').last().append(this.marker.get());\n                        $prev.append($next.contents());\n                        this.selection.restore();\n\n                        return true;\n                    }\n\n                    return false;\n\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =marker\n\t\tmarker: function()\n\t\t{\n\t\t\treturn {\n\n\t\t\t\t// public\n\t\t\t\tget: function(num)\n\t\t\t\t{\n\t\t\t\t\tnum = (typeof num === 'undefined') ? 1 : num;\n\n\t\t\t\t\tvar marker = document.createElement('span');\n\n\t\t\t\t\tmarker.id = 'selection-marker-' + num;\n\t\t\t\t\tmarker.className = 'redactor-selection-marker';\n\t\t\t\t\tmarker.innerHTML = this.opts.invisibleSpace;\n\n\t\t\t\t\treturn marker;\n\t\t\t\t},\n\t\t\t\thtml: function(num)\n\t\t\t\t{\n\t\t\t\t\treturn this.utils.getOuterHtml(this.marker.get(num));\n\t\t\t\t},\n\t\t\t\tfind: function(num)\n\t\t\t\t{\n\t\t\t\t\tnum = (typeof num === 'undefined') ? 1 : num;\n\n\t\t\t\t\treturn this.core.editor().find('span#selection-marker-' + num);\n\t\t\t\t},\n\t\t\t\tinsert: function()\n\t\t\t\t{\n\t\t\t\t\tvar sel = this.selection.get();\n\t\t\t\t\tvar range = this.selection.range(sel);\n\n\t\t\t\t\tthis.marker.insertNode(range, this.marker.get(1), true);\n\t\t\t\t\tif (range && range.collapsed === false)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.marker.insertNode(range, this.marker.get(2), false);\n\t\t\t\t\t}\n\n\t\t\t\t},\n\t\t\t\tremove: function()\n\t\t\t\t{\n\t\t\t\t\tthis.core.editor().find('.redactor-selection-marker').each(this.marker.iterateRemove);\n\t\t\t\t},\n\n\t\t\t\t// private\n\t\t\t\tinsertNode: function(range, node, collapse)\n\t\t\t\t{\n\t\t\t\t\tvar parent = this.selection.parent();\n\t\t\t\t\tif (range === null || $(parent).closest('.redactor-in').length === 0)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\trange = range.cloneRange();\n\n\t\t\t\t\ttry {\n\t\t\t\t\t\trange.collapse(collapse);\n\t\t\t\t\t\trange.insertNode(node);\n\t\t\t\t\t}\n\t\t\t\t\tcatch (e)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.focus.start();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\titerateRemove: function(i, el)\n\t\t\t\t{\n\t\t\t\t\tvar $el = $(el);\n\t\t\t\t\tvar text = $el.text().replace(/\\u200B/g, '');\n\n\t\t\t\t\treturn (text === '') ? $el.remove() : $el.replaceWith(function() { return $(this).contents(); });\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =modal\n\t\tmodal: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tcallbacks: {},\n\t\t\t\ttemplates: function()\n\t\t\t\t{\n\t\t\t\t\tthis.opts.modal = {\n\t\t\t\t\t\t'image-edit': String()\n\t\t\t\t\t\t+ '<div class=\"redactor-modal-tab redactor-group\" data-title=\"General\">'\n\t\t\t\t\t\t\t+ '<div id=\"redactor-image-preview\" class=\"redactor-modal-tab-side\">'\n\t\t\t\t\t\t\t+ '</div>'\n\t\t\t\t\t\t\t+ '<div class=\"redactor-modal-tab-area\">'\n\t\t\t\t\t\t\t\t+ '<section>'\n\t\t\t\t\t\t\t\t\t+ '<label>' + this.lang.get('title') + '</label>'\n\t\t\t\t\t\t\t\t\t+ '<input type=\"text\" id=\"redactor-image-title\" />'\n\t\t\t\t\t\t\t\t+ '</section>'\n\t\t\t\t\t\t\t\t+ '<section>'\n\t\t\t\t\t\t\t\t\t+ '<label>' + this.lang.get('caption') + '</label>'\n\t\t\t\t\t\t\t\t\t+ '<input type=\"text\" id=\"redactor-image-caption\" aria-label=\"' + this.lang.get('caption') + '\" />'\n\t\t\t\t\t\t\t\t+ '</section>'\n\t\t\t\t\t\t\t\t+ '<section>'\n\t\t\t\t\t\t\t\t\t+ '<label>' + this.lang.get('link') + '</label>'\n\t\t\t\t\t\t\t\t\t+ '<input type=\"text\" id=\"redactor-image-link\" aria-label=\"' + this.lang.get('link') + '\" />'\n\t\t\t\t\t\t\t\t+ '</section>'\n\t\t\t\t\t\t\t\t+ '<section>'\n        \t\t\t\t\t\t\t+ '<label class=\"redactor-image-position-option\">' + this.lang.get('image-position') + '</label>'\n        \t\t\t\t\t\t\t+ '<select class=\"redactor-image-position-option\" id=\"redactor-image-align\" aria-label=\"' + this.lang.get('image-position') + '\">'\n        \t\t\t\t\t\t\t\t+ '<option value=\"none\">' + this.lang.get('none') + '</option>'\n        \t\t\t\t\t\t\t\t+ '<option value=\"left\">' + this.lang.get('left') + '</option>'\n        \t\t\t\t\t\t\t\t+ '<option value=\"center\">' + this.lang.get('center') + '</option>'\n        \t\t\t\t\t\t\t\t+ '<option value=\"right\">' + this.lang.get('right') + '</option>'\n        \t\t\t\t\t\t\t+ '</select>'\n\t\t\t\t\t\t\t\t+ '</section>'\n\t\t\t\t\t\t\t\t+ '<section>'\n\t\t\t\t\t\t\t\t\t+ '<label class=\"checkbox\"><input type=\"checkbox\" id=\"redactor-image-link-blank\" aria-label=\"' + this.lang.get('link-in-new-tab') + '\"> ' + this.lang.get('link-in-new-tab') + '</label>'\n\t\t\t\t\t\t\t\t+ '</section>'\n\t\t\t\t\t\t\t\t+ '<section>'\n\t\t\t\t\t\t\t\t\t+ '<button id=\"redactor-modal-button-action\">' + this.lang.get('insert') + '</button>'\n\t\t\t\t\t\t\t\t\t+ '<button id=\"redactor-modal-button-cancel\">' + this.lang.get('cancel') + '</button>'\n\t\t\t\t\t\t\t\t\t+ '<button id=\"redactor-modal-button-delete\" class=\"redactor-modal-button-offset\">' + this.lang.get('delete') + '</button>'\n\t\t\t\t\t\t\t\t+ '</section>'\n\t\t\t\t\t\t\t+ '</div>'\n\t\t\t\t\t\t+ '</div>',\n\n\t\t\t\t\t\t'image': String()\n\t\t\t\t\t\t+ '<div class=\"redactor-modal-tab\" data-title=\"Upload\">'\n\t\t\t\t\t\t\t+ '<section>'\n\t\t\t\t\t\t\t\t+ '<div id=\"redactor-modal-image-droparea\"></div>'\n\t \t\t\t\t\t\t+ '</section>'\n \t\t\t\t\t\t+ '</div>',\n\n\t\t\t\t\t\t'file': String()\n\t\t\t\t\t\t+ '<div class=\"redactor-modal-tab\" data-title=\"Upload\">'\n\t\t\t\t\t\t\t+ '<section>'\n\t\t\t\t\t\t\t\t+ '<label>' + this.lang.get('filename') + ' <span class=\"desc\">(' + this.lang.get('optional') + ')</span></label>'\n\t\t\t\t\t\t\t\t+ '<input type=\"text\" id=\"redactor-filename\" aria-label=\"' + this.lang.get('filename') + '\" /><br><br>'\n\t\t\t\t\t\t\t+ '</section>'\n\t\t\t\t\t\t\t+ '<section>'\n\t\t\t\t\t\t\t\t+ '<div id=\"redactor-modal-file-upload\"></div>'\n\t\t\t\t\t\t\t+ '</section>'\n\t\t\t\t\t\t+ '</div>',\n\n\t\t\t\t\t\t'link': String()\n\t\t\t\t\t\t+ '<div class=\"redactor-modal-tab\" data-title=\"General\">'\n\t\t\t\t\t\t\t+ '<section>'\n\t\t\t\t\t\t\t\t+ '<label>URL</label>'\n\t\t\t\t\t\t\t\t+ '<input type=\"url\" id=\"redactor-link-url\" aria-label=\"URL\" />'\n\t\t\t\t\t\t\t+ '</section>'\n\t\t\t\t\t\t\t+ '<section>'\n\t\t\t\t\t\t\t\t+ '<label>' + this.lang.get('text') + '</label>'\n\t\t\t\t\t\t\t\t+ '<input type=\"text\" id=\"redactor-link-url-text\" aria-label=\"' + this.lang.get('text') + '\" />'\n\t\t\t\t\t\t\t+ '</section>'\n\t\t\t\t\t\t\t+ '<section>'\n\t\t\t\t\t\t\t\t+ '<label class=\"checkbox\"><input type=\"checkbox\" id=\"redactor-link-blank\"> ' + this.lang.get('link-in-new-tab') + '</label>'\n\t\t\t\t\t\t\t+ '</section>'\n\t\t\t\t\t\t\t+ '<section>'\n\t\t\t\t\t\t\t\t+ '<button id=\"redactor-modal-button-action\">' + this.lang.get('insert') + '</button>'\n\t\t\t\t\t\t\t\t+ '<button id=\"redactor-modal-button-cancel\">' + this.lang.get('cancel') + '</button>'\n\t\t\t\t\t\t\t+ '</section>'\n\t\t\t\t\t\t+ '</div>'\n\t\t\t\t\t};\n\n\t\t\t\t\t$.extend(this.opts, this.opts.modal);\n\n\t\t\t\t},\n\t\t\t\taddCallback: function(name, callback)\n\t\t\t\t{\n\t\t\t\t\tthis.modal.callbacks[name] = callback;\n\t\t\t\t},\n\t\t\t\taddTemplate: function(name, template)\n\t\t\t\t{\n\t\t\t\t\tthis.opts.modal[name] = template;\n\t\t\t\t},\n\t\t\t\tgetTemplate: function(name)\n\t\t\t\t{\n\t\t\t\t\treturn this.opts.modal[name];\n\t\t\t\t},\n\t\t\t\tgetModal: function()\n\t\t\t\t{\n\t\t\t\t\treturn this.$modalBody;\n\t\t\t\t},\n\t\t\t\tgetActionButton: function()\n\t\t\t\t{\n\t\t\t\t\treturn this.$modalBody.find('#redactor-modal-button-action');\n\t\t\t\t},\n\t\t\t\tgetCancelButton: function()\n\t\t\t\t{\n\t\t\t\t\treturn this.$modalBody.find('#redactor-modal-button-cancel');\n\t\t\t\t},\n\t\t\t\tgetDeleteButton: function()\n\t\t\t\t{\n\t\t\t\t\treturn this.$modalBody.find('#redactor-modal-button-delete');\n\t\t\t\t},\n\t\t\t\tload: function(templateName, title, width)\n\t\t\t\t{\n\t\t\t\t\tif (typeof this.$modalBox !== 'undefined' && this.$modalBox.hasClass('open'))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.modal.templateName = templateName;\n\t\t\t\t\tthis.modal.width = width;\n\n\t\t\t\t\tthis.modal.build();\n\t\t\t\t\tthis.modal.enableEvents();\n\t\t\t\t\tthis.modal.setTitle(title);\n\t\t\t\t\tthis.modal.setDraggable();\n\t\t\t\t\tthis.modal.setContent();\n\n\t\t\t\t\t// callbacks\n\t\t\t\t\tif (typeof this.modal.callbacks[templateName] !== 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.modal.callbacks[templateName].call(this);\n\t\t\t\t\t}\n\n\t\t\t\t},\n\t\t\t\tshow: function()\n\t\t\t\t{\n\n\t\t\t\t\tif (!this.detect.isDesktop())\n\t\t\t\t\t{\n\t\t\t\t\t\tdocument.activeElement.blur();\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.selection.save();\n\t\t\t\t\tthis.modal.buildTabber();\n\n\t\t\t\t\tif (this.detect.isMobile())\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.modal.width = '96%';\n\t\t\t\t\t}\n\n\t\t\t\t\t// resize\n\t\t\t\t\tsetTimeout($.proxy(this.modal.buildWidth, this), 0);\n\t\t\t\t\t$(window).on('resize.redactor-modal', $.proxy(this.modal.buildWidth, this));\n\n\n\t\t\t\t\tthis.$modalOverlay.redactorAnimation('fadeIn', {\n\t\t\t\t\t\tduration: 0.25\n\t\t\t\t\t});\n\n\t\t\t\t\tthis.$modalBox.addClass('open').show();\n\t\t\t\t\tthis.$modal.redactorAnimation('fadeIn', {\n\t\t\t\t\t\t\ttiming: 'cubic-bezier(0.175, 0.885, 0.320, 1.105)'\n\t\t\t\t\t\t},\n\t\t\t\t\t\t$.proxy(function()\n\t\t\t\t\t\t{\n\n\t\t\t\t\t\t\tthis.utils.saveScroll();\n\t\t\t\t\t\t\tthis.utils.disableBodyScroll();\n\n\t\t\t\t\t\t\t// modal shown callback\n\t\t\t\t\t\t\tthis.core.callback('modalOpened', this.modal.templateName, this.$modal);\n\n\t\t\t\t\t\t\t// fix bootstrap modal focus\n\t\t\t\t\t\t\t$(document).off('focusin.modal');\n\n\t\t\t\t\t\t\t// enter\n\t\t\t\t\t\t\tvar $elements = this.$modal.find('input[type=text],input[type=url],input[type=email]');\n\t\t\t\t\t\t\t$elements.on('keydown.redactor-modal', $.proxy(this.modal.setEnter, this));\n\n\t\t\t\t\t\t}, this)\n\t\t\t\t\t);\n\n\t\t\t\t},\n\t\t\t\tbuildWidth: function()\n\t\t\t\t{\n\t\t\t\t\tvar windowHeight = $(window).height();\n\t\t\t\t\tvar windowWidth = $(window).width();\n\n\t\t\t\t\tvar number = (typeof this.modal.width === 'number');\n\n\t\t\t\t\tif (!number && this.modal.width.match(/%$/))\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.$modal.css({ 'width': this.modal.width, 'margin-bottom': '16px' });\n\t\t\t\t\t}\n\t\t\t\t\telse if (parseInt(this.modal.width) > windowWidth)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.$modal.css({ 'width': '96%', 'margin-bottom': '2%' });\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tif (number)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.modal.width += 'px';\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tthis.$modal.css({ 'width': this.modal.width, 'margin-bottom': '16px' });\n\t\t\t\t\t}\n\n\t\t\t\t\t// margin top\n\t\t\t\t\tvar height = this.$modal.outerHeight();\n\t\t\t\t\tvar top = (windowHeight/2 - height/2) + 'px';\n\n\t\t\t\t\tif (this.detect.isMobile())\n\t\t\t\t\t{\n\t\t\t\t\t\ttop = '2%';\n\t\t\t\t\t}\n\t\t\t\t\telse if (height > windowHeight)\n\t\t\t\t\t{\n\t\t\t\t\t\ttop = '16px';\n\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.$modal.css('margin-top', top);\n\t\t\t\t},\n\t\t\t\tbuildTabber: function()\n\t\t\t\t{\n\t\t\t\t\tthis.modal.tabs = this.$modal.find('.redactor-modal-tab');\n\n\t\t\t\t\tif (this.modal.tabs.length < 2)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.modal.$tabsBox = $('<div id=\"redactor-modal-tabber\" />');\n\t\t\t\t\t$.each(this.modal.tabs, $.proxy(function(i,s)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar a = $('<a href=\"#\" rel=\"' + i + '\" />').text($(s).attr('data-title'));\n\n\t\t\t\t\t\ta.on('click', $.proxy(this.modal.showTab, this));\n\n\t\t\t\t\t\tif (i === 0)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ta.addClass('active');\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tthis.modal.$tabsBox.append(a);\n\n\t\t\t\t\t}, this));\n\n\t\t\t\t\tthis.$modalBody.prepend(this.modal.$tabsBox);\n\n\t\t\t\t},\n\t\t\t\tshowTab: function(e)\n\t\t\t\t{\n\t\t\t\t\te.preventDefault();\n\n\t\t\t\t\tvar $el = $(e.target);\n\t\t\t\t\tvar index = $el.attr('rel');\n\n\t\t\t\t\tthis.modal.tabs.hide();\n\t\t\t\t\tthis.modal.tabs.eq(index).show();\n\n\t\t\t\t\t$('#redactor-modal-tabber').find('a').removeClass('active');\n\t\t\t\t\t$el.addClass('active');\n\n\t\t\t\t\treturn false;\n\n\t\t\t\t},\n\t\t\t\tsetTitle: function(title)\n\t\t\t\t{\n\t\t\t\t\tthis.$modalHeader.html(title);\n\t\t\t\t},\n\t\t\t\tsetContent: function()\n\t\t\t\t{\n\t\t\t\t\tthis.$modalBody.html(this.modal.getTemplate(this.modal.templateName));\n\n\t\t\t\t\tthis.modal.getCancelButton().on('mousedown', $.proxy(this.modal.close, this));\n\t\t\t\t},\n\t\t\t\tsetDraggable: function()\n\t\t\t\t{\n\t\t\t\t\tif (typeof $.fn.draggable === 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.$modal.draggable({ handle: this.$modalHeader });\n\t\t\t\t\tthis.$modalHeader.css('cursor', 'move');\n\t\t\t\t},\n\t\t\t\tsetEnter: function(e)\n\t\t\t\t{\n\t\t\t\t\tif (e.which !== 13)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\te.preventDefault();\n\t\t\t\t\tthis.modal.getActionButton().click();\n\t\t\t\t},\n\t\t\t\tbuild: function()\n\t\t\t\t{\n\t\t\t\t\tthis.modal.buildOverlay();\n\n\t\t\t\t\tthis.$modalBox = $('<div id=\"redactor-modal-box\"/>').hide();\n\t\t\t\t\tthis.$modal = $('<div id=\"redactor-modal\" role=\"dialog\" />');\n\t\t\t\t\tthis.$modalHeader = $('<div id=\"redactor-modal-header\" />');\n\t\t\t\t\tthis.$modalClose = $('<button type=\"button\" id=\"redactor-modal-close\" aria-label=\"' + this.lang.get('close') + '\" />').html('&times;');\n\t\t\t\t\tthis.$modalBody = $('<div id=\"redactor-modal-body\" />');\n\n\t\t\t\t\tthis.$modal.append(this.$modalHeader);\n\t\t\t\t\tthis.$modal.append(this.$modalBody);\n\t\t\t\t\tthis.$modal.append(this.$modalClose);\n\t\t\t\t\tthis.$modalBox.append(this.$modal);\n\t\t\t\t\tthis.$modalBox.appendTo(document.body);\n\n\t\t\t\t},\n\t\t\t\tbuildOverlay: function()\n\t\t\t\t{\n\t\t\t\t\tthis.$modalOverlay = $('<div id=\"redactor-modal-overlay\">').hide();\n\t\t\t\t\t$('body').prepend(this.$modalOverlay);\n\t\t\t\t},\n\t\t\t\tenableEvents: function()\n\t\t\t\t{\n\t\t\t\t\tthis.$modalClose.on('mousedown.redactor-modal', $.proxy(this.modal.close, this));\n\t\t\t\t\t$(document).on('keyup.redactor-modal', $.proxy(this.modal.closeHandler, this));\n\t\t\t\t\tthis.core.editor().on('keyup.redactor-modal', $.proxy(this.modal.closeHandler, this));\n\t\t\t\t\tthis.$modalBox.on('click.redactor-modal', $.proxy(this.modal.close, this));\n\t\t\t\t},\n\t\t\t\tdisableEvents: function()\n\t\t\t\t{\n\t\t\t\t\tthis.$modalClose.off('mousedown.redactor-modal');\n\t\t\t\t\t$(document).off('keyup.redactor-modal');\n\t\t\t\t\tthis.core.editor().off('keyup.redactor-modal');\n\t\t\t\t\tthis.$modalBox.off('click.redactor-modal');\n\t\t\t\t\t$(window).off('resize.redactor-modal');\n\t\t\t\t},\n\t\t\t\tcloseHandler: function(e)\n\t\t\t\t{\n\t\t\t\t\tif (e.which !== this.keyCode.ESC)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.modal.close(false);\n\t\t\t\t},\n\t\t\t\tclose: function(e)\n\t\t\t\t{\n\t\t\t\t\tif (e)\n\t\t\t\t\t{\n\t\t\t\t\t\tif ($(e.target).attr('id') !== 'redactor-modal-button-cancel' && e.target !== this.$modalClose[0] && e.target !== this.$modalBox[0])\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!this.$modalBox)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\t// restore selection\n\t\t\t\t\tthis.selection.restore();\n\n\t\t\t\t\tthis.modal.disableEvents();\n\t\t\t\t\tthis.utils.enableBodyScroll();\n\t\t\t\t\tthis.utils.restoreScroll();\n\n\t\t\t\t\tthis.$modalOverlay.redactorAnimation('fadeOut', { duration: 0.4 }, $.proxy(function()\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.$modalOverlay.remove();\n\n\t\t\t\t\t}, this));\n\n\t\t\t\t\tthis.$modal.redactorAnimation('fadeOut', {\n\n\t\t\t\t\t\tduration: 0.3,\n\t\t\t\t\t\ttiming: 'cubic-bezier(0.175, 0.885, 0.320, 1.175)'\n\n\t\t\t\t\t}, $.proxy(function()\n\t\t\t\t\t{\n\t\t\t\t\t\tif (typeof this.$modalBox !== 'undefined')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.$modalBox.remove();\n\t\t\t\t\t\t\tthis.$modalBox = undefined;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t$(document.body).css('overflow', this.modal.bodyOveflow);\n\t\t\t\t\t\tthis.core.callback('modalClosed', this.modal.templateName);\n\n\t\t\t\t\t}, this));\n\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =observe\n\t\tobserve: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tload: function()\n\t\t\t\t{\n\t\t\t\t\tif (typeof this.opts.destroyed !== 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.observe.links();\n\t\t\t\t\tthis.observe.images();\n\n\t\t\t\t},\n\t\t\t\tisCurrent: function($el, $current)\n\t\t\t\t{\n\t\t\t\t\tif (typeof $current === 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\t$current = $(this.selection.current());\n\t\t\t\t\t}\n\n\t\t\t\t\treturn $current.is($el) || $current.parents($el).length > 0;\n\t\t\t\t},\n\t\t\t\ttoolbar: function()\n\t\t\t\t{\n\t\t\t\t\tthis.observe.buttons();\n\t\t\t\t\tthis.observe.dropdowns();\n\t\t\t\t},\n\t\t\t\tbuttons: function(e, btnName)\n\t\t\t\t{\n\t\t\t\t\tvar current = this.selection.current();\n\t\t\t\t\tvar parent = this.selection.parent();\n\n\t\t\t\t\tif (e !== false)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.button.setInactiveAll();\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.button.setInactiveAll(btnName);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (e === false && btnName !== 'html')\n\t\t\t\t\t{\n\t\t\t\t\t\tif ($.inArray(btnName, this.opts.activeButtons) !== -1)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.button.toggleActive(btnName);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!this.utils.isRedactorParent(current))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\t// disable line\n\t\t\t\t\tif (this.utils.isCurrentOrParentHeader() || this.utils.isCurrentOrParent(['table', 'pre', 'blockquote', 'li']))\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.button.disable('horizontalrule');\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.button.enable('horizontalrule');\n\t\t\t\t\t}\n\n\n\t\t\t\t\t$.each(this.opts.activeButtonsStates, $.proxy(function(key, value)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar parentEl = $(parent).closest(key, this.$editor[0]);\n\t\t\t\t\t\tvar currentEl = $(current).closest(key, this.$editor[0]);\n\n\t\t\t\t\t\tif (parentEl.length !== 0 && !this.utils.isRedactorParent(parentEl))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (!this.utils.isRedactorParent(currentEl))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (parentEl.length !== 0 || currentEl.closest(key, this.$editor[0]).length !== 0)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.button.setActive(value);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}, this));\n\n\t\t\t\t},\n\t\t\t\tdropdowns: function()\n\t\t\t\t{\n    \t\t\t\tvar finded = $('<div />').html(this.selection.html()).find('a').length;\n\t\t\t\t\tvar $current = $(this.selection.current());\n\t\t\t\t\tvar isRedactor = this.utils.isRedactorParent($current);\n\n\t\t\t\t\t$.each(this.opts.observe.dropdowns, $.proxy(function(key, value)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar observe = value.observe,\n\t\t\t\t\t\t\telement = observe.element,\n\t\t\t\t\t\t\t$item   = value.item,\n\t\t\t\t\t\t\tinValues = typeof observe.in !== 'undefined' ? observe.in : false,\n\t\t\t\t\t\t\toutValues = typeof observe.out !== 'undefined' ? observe.out : false;\n\n\t\t\t\t\t\tif (($current.closest(element).length > 0 && isRedactor) || (element === 'a' && finded !== 0))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.observe.setDropdownProperties($item, inValues, outValues);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.observe.setDropdownProperties($item, outValues, inValues);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}, this));\n\t\t\t\t},\n\t\t\t\tsetDropdownProperties: function($item, addProperties, deleteProperties)\n\t\t\t\t{\n\t\t\t\t\tif (deleteProperties && typeof deleteProperties.attr !== 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.observe.setDropdownAttr($item, deleteProperties.attr, true);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (typeof addProperties.attr !== 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.observe.setDropdownAttr($item, addProperties.attr);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (typeof addProperties.title !== 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\t$item.find('span').text(addProperties.title);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tsetDropdownAttr: function($item, properties, isDelete)\n\t\t\t\t{\n\t\t\t\t\t$.each(properties, function(key, value)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (key === 'class')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tif (!isDelete)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t$item.addClass(value);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t$item.removeClass(value);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tif (!isDelete)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t$item.attr(key, value);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t$item.removeAttr(key);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t\taddDropdown: function($item, btnName, btnObject)\n\t\t\t\t{\n\t\t\t\t\tif (typeof btnObject.observe === \"undefined\")\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tbtnObject.item = $item;\n\n\t\t\t\t\tthis.opts.observe.dropdowns.push(btnObject);\n\t\t\t\t},\n\t\t\t\timages: function()\n\t\t\t\t{\n                    if (this.opts.imageEditable)\n                    {\n                        this.core.editor().addClass('redactor-editor-img-edit');\n    \t\t\t\t\tthis.core.editor().find('img').each($.proxy(function(i, img)\n    \t\t\t\t\t{\n    \t\t\t\t\t\tvar $img = $(img);\n\n    \t\t\t\t\t\t// IE fix (when we clicked on an image and then press backspace IE does goes to image's url)\n    \t\t\t\t\t\t$img.closest('a', this.$editor[0]).on('click', function(e) { e.preventDefault(); });\n\n    \t\t\t\t\t\tthis.image.setEditable($img);\n\n\n    \t\t\t\t\t}, this));\n                    }\n\t\t\t\t},\n\t\t\t\tlinks: function()\n\t\t\t\t{\n\t\t\t\t\tif (this.opts.linkTooltip)\n\t\t\t\t\t{\n    \t\t\t\t\tthis.core.editor().find('a').each($.proxy(function(i, s)\n    \t\t\t\t\t{\n        \t\t\t\t\tvar $link = $(s);\n        \t\t\t\t\tif ($link.data('cached') !== true)\n        \t\t\t\t\t{\n            \t\t\t\t\t$link.data('cached', true);\n            \t\t\t\t\t$link.on('touchstart.redactor.' + this.uuid + ' click.redactor.' + this.uuid, $.proxy(this.observe.showTooltip, this));\n        \t\t\t\t\t}\n\n    \t\t\t\t\t}, this));\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tgetTooltipPosition: function($link)\n\t\t\t\t{\n\t\t\t\t\treturn $link.offset();\n\t\t\t\t},\n\t\t\t\tshowTooltip: function(e)\n\t\t\t\t{\n\t\t\t\t\tvar $el = $(e.target);\n\n\t\t\t\t\tif ($el[0].tagName === 'IMG')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif ($el[0].tagName !== 'A')\n\t\t\t\t\t{\n\t\t\t\t\t\t$el = $el.closest('a', this.$editor[0]);\n\t\t\t\t\t}\n\n\t\t\t\t\tif ($el[0].tagName !== 'A')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar $link = $el;\n\n\t\t\t\t\tvar pos = this.observe.getTooltipPosition($link);\n\t\t\t\t\tvar tooltip = $('<span class=\"redactor-link-tooltip\"></span>');\n\n\t\t\t\t\tvar href = $link.attr('href');\n\t\t\t\t\tif (href === undefined)\n\t\t\t\t\t{\n\t\t\t\t\t\thref = '';\n\t\t\t\t\t}\n\n\t\t\t\t\tif (href.length > 24)\n\t\t\t\t\t{\n\t\t\t\t\t\thref = href.substring(0, 24) + '...';\n\t\t\t\t\t}\n\n\t\t\t\t\tvar aLink = $('<a href=\"' + $link.attr('href') + '\" target=\"_blank\" />').html(href).addClass('redactor-link-tooltip-action');\n\t\t\t\t\tvar aEdit = $('<a href=\"#\" />').html(this.lang.get('edit')).on('click', $.proxy(this.link.show, this)).addClass('redactor-link-tooltip-action');\n\t\t\t\t\tvar aUnlink = $('<a href=\"#\" />').html(this.lang.get('unlink')).on('click', $.proxy(this.link.unlink, this)).addClass('redactor-link-tooltip-action');\n\n\t\t\t\t\ttooltip.append(aLink).append(' | ').append(aEdit).append(' | ').append(aUnlink);\n\n\t\t\t\t\tvar lineHeight = parseInt($link.css('line-height'), 10);\n                    var lineClicked = Math.ceil((e.pageY - pos.top)/lineHeight);\n                    var top = pos.top + lineClicked * lineHeight;\n\n\t\t\t\t\ttooltip.css({\n\t\t\t\t\t\ttop: top + 'px',\n\t\t\t\t\t\tleft: pos.left + 'px'\n\t\t\t\t\t});\n\n\t\t\t\t\t$('.redactor-link-tooltip').remove();\n\t\t\t\t\t$('body').append(tooltip);\n\n\t\t\t\t\tthis.core.editor().on('touchstart.redactor.' + this.uuid + ' click.redactor.' + this.uuid, $.proxy(this.observe.closeTooltip, this));\n\t\t\t\t\t$(document).on('touchstart.redactor.' + this.uuid + ' click.redactor.' + this.uuid, $.proxy(this.observe.closeTooltip, this));\n\t\t\t\t},\n\t\t\t\tcloseAllTooltip: function()\n\t\t\t\t{\n\t\t\t\t\t$('.redactor-link-tooltip').remove();\n\t\t\t\t},\n\t\t\t\tcloseTooltip: function(e)\n\t\t\t\t{\n\t\t\t\t\te = e.originalEvent || e;\n\n\t\t\t\t\tvar target = e.target;\n\t\t\t\t\tvar $parent = $(target).closest('a', this.$editor[0]);\n\t\t\t\t\tif ($parent.length !== 0 && $parent[0].tagName === 'A' && target.tagName !== 'A')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\telse if ((target.tagName === 'A' && this.utils.isRedactorParent(target)) || $(target).hasClass('redactor-link-tooltip-action'))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.observe.closeAllTooltip();\n\n\t\t\t\t\tthis.core.editor().off('touchstart.redactor.' + this.uuid + ' click.redactor.' + this.uuid, $.proxy(this.observe.closeTooltip, this));\n\t\t\t\t\t$(document).off('touchstart.redactor.' + this.uuid + ' click.redactor.' + this.uuid, $.proxy(this.observe.closeTooltip, this));\n\t\t\t\t}\n\n\t\t\t};\n\t\t},\n\n\t\t// =offset\n\t\toffset: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tget: function(node)\n\t\t\t\t{\n\t\t\t\t\tvar cloned = this.offset.clone(node);\n\t\t\t\t\tif (cloned === false)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn 0;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar div = document.createElement('div');\n\t\t\t\t\tdiv.appendChild(cloned.cloneContents());\n\t\t\t\t\tdiv.innerHTML = div.innerHTML.replace(/<img(.*?[^>])>$/gi, 'i');\n\n\t\t\t        var text = $.trim($(div).text()).replace(/[\\t\\n\\r\\n]/g, '').replace(/\\u200B/g, '');\n\n\t\t\t\t\treturn text.length;\n\n\t\t\t\t},\n\t\t\t\tclone: function(node)\n\t\t\t\t{\n\t\t\t\t\tvar sel = this.selection.get();\n\t\t\t\t\tvar range = this.selection.range(sel);\n\n\t\t\t\t\tif (range === null && typeof node === 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tnode = (typeof node === 'undefined') ? this.$editor : node;\n\t\t\t\t\tif (node === false)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tnode = node[0] || node;\n\n\t\t\t\t\tvar cloned = range.cloneRange();\n\t\t\t\t\tcloned.selectNodeContents(node);\n\t\t\t\t\tcloned.setEnd(range.endContainer, range.endOffset);\n\n\t\t\t\t\treturn cloned;\n\t\t\t\t},\n\t\t\t\tset: function(start, end)\n\t\t\t\t{\n\t\t\t\t\tend = (typeof end === 'undefined') ? start : end;\n\n\t\t\t\t\tif (!this.focus.is())\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.focus.start();\n\t\t\t\t\t}\n\n\t\t\t\t\tvar sel = this.selection.get();\n\t\t\t\t\tvar range = this.selection.range(sel);\n\t\t\t\t\tvar node, offset = 0;\n\t\t\t\t\tvar walker = document.createTreeWalker(this.$editor[0], NodeFilter.SHOW_TEXT, null, null);\n\n\t\t\t\t\twhile ((node = walker.nextNode()) !== null)\n\t\t\t\t\t{\n\t\t\t\t\t\toffset += node.nodeValue.length;\n\t\t\t\t\t\tif (offset > start)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\trange.setStart(node, node.nodeValue.length + start - offset);\n\t\t\t\t\t\t\tstart = Infinity;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (offset >= end)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\trange.setEnd(node, node.nodeValue.length + end - offset);\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\trange.collapse(false);\n\t\t\t\t\tthis.selection.update(sel, range);\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =paragraphize\n\t\tparagraphize: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tload: function(html)\n\t\t\t\t{\n\t\t\t\t\tif (this.opts.paragraphize === false || this.opts.type === 'inline' || this.opts.type === 'pre')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn html;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (html === '' || html === '<p></p>')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn this.opts.emptyHtml;\n\t\t\t\t\t}\n\n\t\t\t\t\thtml = html + \"\\n\";\n\n\t\t\t\t\tthis.paragraphize.safes = [];\n\t\t\t\t\tthis.paragraphize.z = 0;\n\n\t\t\t\t\t// before\n\t\t\t\t\thtml = html.replace(/(<br\\s?\\/?>){1,}\\n?<\\/blockquote>/gi, '</blockquote>');\n\t\t\t\t\thtml = html.replace(/<\\/pre>/gi, \"</pre>\\n\\n\");\n\t\t\t\t\thtml = html.replace(/<p>\\s<br><\\/p>/gi, '<p></p>');\n\n\t\t\t\t\thtml = this.paragraphize.getSafes(html);\n\n\t\t\t\t\thtml = html.replace('<br>', \"\\n\");\n\t\t\t\t\thtml = this.paragraphize.convert(html);\n\n\t\t\t\t\thtml = this.paragraphize.clear(html);\n\t\t\t\t\thtml = this.paragraphize.restoreSafes(html);\n\n\t\t\t\t\t// after\n\t\t\t\t\thtml = html.replace(new RegExp('<br\\\\s?/?>\\n?<(' + this.opts.paragraphizeBlocks.join('|') + ')(.*?[^>])>', 'gi'), '<p><br /></p>\\n<$1$2>');\n\n\t\t\t\t\treturn $.trim(html);\n\t\t\t\t},\n\t\t\t\tgetSafes: function(html)\n\t\t\t\t{\n\t\t\t\t\tvar $div = $('<div />').append(html);\n\n\t\t\t\t\t// remove paragraphs in blockquotes\n\t\t\t\t\t$div.find('blockquote p').replaceWith(function()\n\t\t\t\t\t{\n\t\t\t\t\t\treturn $(this).append('<br />').contents();\n\t\t\t\t\t});\n\n                    $div.find(this.opts.paragraphizeBlocks.join(', ')).each($.proxy(function(i,s)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.paragraphize.z++;\n\t\t\t\t\t\tthis.paragraphize.safes[this.paragraphize.z] = s.outerHTML;\n\n\t\t\t\t\t\treturn $(s).replaceWith(\"\\n#####replace\" + this.paragraphize.z + \"#####\\n\\n\");\n\n\n\t\t\t\t\t}, this));\n\n                    // deal with redactor selection markers\n                    $div.find('span.redactor-selection-marker').each($.proxy(function(i,s)\n                    {\n                        this.paragraphize.z++;\n                        this.paragraphize.safes[this.paragraphize.z] = s.outerHTML;\n\n                        return $(s).replaceWith(\"\\n#####replace\" + this.paragraphize.z + \"#####\\n\\n\");\n                    }, this));\n\n\t\t\t\t\treturn $div.html();\n\t\t\t\t},\n\t\t\t\trestoreSafes: function(html)\n\t\t\t\t{\n\t\t\t\t\t$.each(this.paragraphize.safes, function(i,s)\n\t\t\t\t\t{\n\t\t\t\t\t\ts = (typeof s !== 'undefined') ? s.replace(/\\$/g, '&#36;') : s;\n\t\t\t\t\t\thtml = html.replace('#####replace' + i + '#####', s);\n\n\t\t\t\t\t});\n\n\t\t\t\t\treturn html;\n\t\t\t\t},\n\t\t\t\tconvert: function(html)\n\t\t\t\t{\n\t\t\t\t\thtml = html.replace(/\\r\\n/g, \"xparagraphmarkerz\");\n\t\t\t\t\thtml = html.replace(/\\n/g, \"xparagraphmarkerz\");\n\t\t\t\t\thtml = html.replace(/\\r/g, \"xparagraphmarkerz\");\n\n\t\t\t\t\tvar re1 = /\\s+/g;\n\t\t\t\t\thtml = html.replace(re1, \" \");\n\t\t\t\t\thtml = $.trim(html);\n\n\t\t\t\t\tvar re2 = /xparagraphmarkerzxparagraphmarkerz/gi;\n\t\t\t\t\thtml = html.replace(re2, \"</p><p>\");\n\n\t\t\t\t\tvar re3 = /xparagraphmarkerz/gi;\n\t\t\t\t\thtml = html.replace(re3, \"<br>\");\n\n\t\t\t\t\thtml = '<p>' + html + '</p>';\n\n\t\t\t\t\thtml = html.replace(\"<p></p>\", \"\");\n\t\t\t\t\thtml = html.replace(\"\\r\\n\\r\\n\", \"\");\n\t\t\t\t\thtml = html.replace(/<\\/p><p>/g, \"</p>\\r\\n\\r\\n<p>\");\n\t\t\t\t\thtml = html.replace(new RegExp(\"<br\\\\s?/?></p>\", \"g\"), \"</p>\");\n\t\t\t\t\thtml = html.replace(new RegExp(\"<p><br\\\\s?/?>\", \"g\"), \"<p>\");\n\t\t\t\t\thtml = html.replace(new RegExp(\"<p><br\\\\s?/?>\", \"g\"), \"<p>\");\n\t\t\t\t\thtml = html.replace(new RegExp(\"<br\\\\s?/?></p>\", \"g\"), \"</p>\");\n\t\t\t\t\thtml = html.replace(/<p>&nbsp;<\\/p>/gi, \"\");\n\t\t\t\t\thtml = html.replace(/<p>\\s?<br>&nbsp;<\\/p>/gi, '');\n\t\t\t\t\thtml = html.replace(/<p>\\s?<br>/gi, '<p>');\n\n\t\t\t\t\treturn html;\n\t\t\t\t},\n\t\t\t\tclear: function(html)\n\t\t\t\t{\n\n\t\t\t\t\thtml = html.replace(/<p>(.*?)#####replace(.*?)#####\\s?<\\/p>/gi, '<p>$1</p>#####replace$2#####');\n\t\t\t\t\thtml = html.replace(/(<br\\s?\\/?>){2,}<\\/p>/gi, '</p>');\n\n\t\t\t\t\thtml = html.replace(new RegExp('</blockquote></p>', 'gi'), '</blockquote>');\n\t\t\t\t\thtml = html.replace(new RegExp('<p></blockquote>', 'gi'), '</blockquote>');\n\t\t\t\t\thtml = html.replace(new RegExp('<p><blockquote>', 'gi'), '<blockquote>');\n\t\t\t\t\thtml = html.replace(new RegExp('<blockquote></p>', 'gi'), '<blockquote>');\n\n\t\t\t\t\thtml = html.replace(new RegExp('<p><p ', 'gi'), '<p ');\n\t\t\t\t\thtml = html.replace(new RegExp('<p><p>', 'gi'), '<p>');\n\t\t\t\t\thtml = html.replace(new RegExp('</p></p>', 'gi'), '</p>');\n\t\t\t\t\thtml = html.replace(new RegExp('<p>\\\\s?</p>', 'gi'), '');\n\t\t\t\t\thtml = html.replace(new RegExp(\"\\n</p>\", 'gi'), '</p>');\n\t\t\t\t\thtml = html.replace(new RegExp('<p>\\t?\\t?\\n?<p>', 'gi'), '<p>');\n\t\t\t\t\thtml = html.replace(new RegExp('<p>\\t*</p>', 'gi'), '');\n\n\t\t\t\t\treturn html;\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =paste\n\t\tpaste: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tinit: function(e)\n\t\t\t\t{\n\t\t\t\t\tthis.rtePaste = true;\n\t\t\t\t\tvar pre = (this.opts.type === 'pre' || this.utils.isCurrentOrParent('pre')) ? true : false;\n\n\t\t\t\t\t// clipboard event\n\t\t\t\t\tif (this.detect.isDesktop())\n\t\t\t\t\t{\n    \t\t\t\t\tif (!this.paste.pre && this.opts.clipboardImageUpload && this.opts.imageUpload && this.paste.detectClipboardUpload(e))\n    \t\t\t\t\t{\n    \t\t\t\t\t\tif (this.detect.isIe())\n    \t\t\t\t\t\t{\n    \t\t\t\t\t\t\tsetTimeout($.proxy(this.paste.clipboardUpload, this), 100);\n    \t\t\t\t\t\t}\n\n    \t\t\t\t\t\treturn;\n    \t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.utils.saveScroll();\n\t\t\t\t\tthis.selection.save();\n\t\t\t\t\tthis.paste.createPasteBox(pre);\n\n\t\t\t\t\t$(window).on('scroll.redactor-freeze', $.proxy(function()\n\t\t\t\t\t{\n\t\t\t\t\t\t$(window).scrollTop(this.saveBodyScroll);\n\n\t\t\t\t\t}, this));\n\n\t\t\t\t\tsetTimeout($.proxy(function()\n\t\t\t\t\t{\n\t\t\t\t\t\tvar html = this.paste.getPasteBoxCode(pre);\n\n\t\t\t\t\t\t// buffer\n\t\t\t\t\t\tthis.buffer.set();\n\t\t\t\t\t\tthis.selection.restore();\n\n\t\t\t\t\t\tthis.utils.restoreScroll();\n\n\t\t\t\t\t\t// paste info\n\t\t\t\t\t\tvar data = this.clean.getCurrentType(html);\n\n\t\t\t\t\t\t// clean\n\t\t\t\t\t\thtml = this.clean.onPaste(html, data);\n\n\t\t\t\t\t\t// callback\n\t\t\t\t\t\tvar returned = this.core.callback('paste', html);\n\t\t\t\t\t\thtml = (typeof returned === 'undefined') ? html : returned;\n\n\t\t\t\t\t\tthis.paste.insert(html, data);\n\t\t\t\t\t\tthis.rtePaste = false;\n\n\t\t\t\t\t\t// clean pre breaklines\n\t\t\t\t\t\tif (pre)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.clean.cleanPre();\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t$(window).off('scroll.redactor-freeze');\n\n\t\t\t\t\t}, this), 1);\n\n\t\t\t\t},\n\t\t\t\tgetPasteBoxCode: function(pre)\n\t\t\t\t{\n\t\t\t\t\tvar html = (pre) ? this.$pasteBox.val() : this.$pasteBox.html();\n\t\t\t\t\tthis.$pasteBox.remove();\n\n\t\t\t\t\treturn html;\n\t\t\t\t},\n\t\t\t\tcreatePasteBox: function(pre)\n\t\t\t\t{\n\t\t\t\t\tvar css = { position: 'fixed', width: '1px', top: 0, left: '-9999px' };\n\n\t\t\t\t\tthis.$pasteBox = (pre) ? $('<textarea>').css(css) : $('<div>').attr('contenteditable', 'true').css(css);\n\t\t\t\t\tthis.paste.appendPasteBox();\n\t\t\t\t\tthis.$pasteBox.focus();\n\t\t\t\t},\n\t\t\t\tappendPasteBox: function()\n\t\t\t\t{\n\t\t\t\t\tif (this.detect.isIe())\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.box().append(this.$pasteBox);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\t// bootstrap modal\n\t\t\t\t\t\tvar $visibleModals = $('.modal-body:visible');\n\t\t\t\t\t\tif ($visibleModals.length > 0)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$visibleModals.append(this.$pasteBox);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$('body').prepend(this.$pasteBox);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tdetectClipboardUpload: function(e)\n\t\t\t\t{\n\t\t\t\t\te = e.originalEvent || e;\n\n\t\t\t\t\tvar clipboard = e.clipboardData;\n\n\t\t\t\t\tif (this.detect.isIe())\n\t\t\t\t\t{\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.detect.isFirefox())\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\t// prevent safari fake url\n\t\t\t\t\tvar types = clipboard.types;\n\t\t\t\t\tif (types.indexOf('public.tiff') !== -1)\n\t\t\t\t\t{\n\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\n\t\t\t\t\tif (!clipboard.items || !clipboard.items.length)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar file = clipboard.items[0].getAsFile();\n\t\t\t\t\tif (file === null)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar reader = new FileReader();\n\t\t\t\t\treader.readAsDataURL(file);\n\t\t\t\t\treader.onload = $.proxy(this.paste.insertFromClipboard, this);\n\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t\tclipboardUpload: function()\n\t\t\t\t{\n\t\t\t\t\tvar imgs = this.$editor.find('img');\n\t\t\t\t\t$.each(imgs, $.proxy(function(i,s)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (s.src.search(/^data\\:image/i) === -1)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tvar formData = !!window.FormData ? new FormData() : null;\n\t\t\t\t\t\tif (!window.FormData)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tthis.buffer.set();\n\n\t\t\t\t\t\tthis.upload.direct = true;\n\t\t\t\t\t\tthis.upload.type = 'image';\n\t\t\t\t\t\tthis.upload.url = this.opts.imageUpload;\n\t\t\t\t\t\tthis.upload.callback = $.proxy(function(data)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tif (this.detect.isIe())\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t$(s).wrap($('<figure />'));\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tvar $parent = $(s).parent();\n\t\t\t\t\t\t\t\tthis.utils.replaceToTag($parent, 'figure');\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\ts.src = data.url;\n\t\t\t\t\t\t\tthis.core.callback('imageUpload', $(s), data);\n\n\t\t\t\t\t\t}, this);\n\n\t\t\t\t\t\tvar blob = this.utils.dataURItoBlob(s.src);\n\n\t\t\t\t\t\tformData.append('clipboard', 1);\n\t\t\t\t\t\tformData.append(this.opts.imageUploadParam, blob);\n\n\t\t\t\t\t\tthis.progress.show();\n\t\t\t\t\t\tthis.upload.send(formData, false);\n\t\t\t\t\t\tthis.code.sync();\n\n\t\t\t\t\t}, this));\n\t\t\t\t},\n\t\t\t\tinsertFromClipboard: function(e)\n\t\t\t\t{\n\t\t\t\t\tvar formData = !!window.FormData ? new FormData() : null;\n\t\t\t\t\tif (!window.FormData)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.buffer.set();\n\n\t\t\t\t\tthis.upload.direct = true;\n\t\t\t\t\tthis.upload.type = 'image';\n\t\t\t\t\tthis.upload.url = this.opts.imageUpload;\n\t\t\t\t\tthis.upload.callback = this.image.insert;\n\n\t\t\t\t\tvar blob = this.utils.dataURItoBlob(e.target.result);\n\n\t\t\t\t\tformData.append('clipboard', 1);\n\t\t\t\t\tformData.append(this.opts.imageUploadParam, blob);\n\n\t\t\t\t\tthis.progress.show();\n\t\t\t\t\tthis.upload.send(formData, e);\n\t\t\t\t},\n\t\t\t\tinsert: function(html, data)\n\t\t\t\t{\n\t\t\t\t\tif (data.pre)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.insert.raw(html);\n\t\t\t\t\t}\n\t\t\t\t\telse if (data.text)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.insert.text(html);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.insert.html(html, data);\n\t\t\t\t\t}\n\n\t\t\t\t\t// Firefox Clipboard Observe\n\t\t\t\t\tif (this.detect.isFirefox() && this.opts.clipboardImageUpload)\n\t\t\t\t\t{\n\t\t\t\t\t\tsetTimeout($.proxy(this.paste.clipboardUpload, this), 100);\n\t\t\t\t\t}\n\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =placeholder\n\t\tplaceholder: function()\n\t\t{\n\t\t\treturn {\n\n\t\t\t\t// public\n\t\t\t\tenable: function()\n\t\t\t\t{\n\t\t\t\t\tsetTimeout($.proxy(function()\n\t\t\t\t\t{\n\t\t\t\t\t\treturn (this.placeholder.isEditorEmpty()) ? this.placeholder.show() : this.placeholder.hide();\n\n\t\t\t\t\t}, this), 5);\n\t\t\t\t},\n\t\t\t\tshow: function()\n\t\t\t\t{\n\t\t\t\t\tthis.core.editor().addClass('redactor-placeholder');\n\t\t\t\t},\n\t\t\t\tupdate: function(text)\n\t\t\t\t{\n\t\t\t\t\tthis.opts.placeholder = text;\n\t\t\t\t\tthis.core.editor().attr('placeholder', text);\n\t\t\t\t},\n\t\t\t\thide: function()\n\t\t\t\t{\n\t\t\t\t\tthis.core.editor().removeClass('redactor-placeholder');\n\t\t\t\t},\n\t\t\t\tis: function()\n\t\t\t\t{\n\t\t\t\t\treturn this.core.editor().hasClass('redactor-placeholder');\n\t\t\t\t},\n\n\n\t\t\t\t// private\n\t\t\t\tinit: function()\n\t\t\t\t{\n\t\t\t\t\tif (!this.placeholder.enabled())\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!this.utils.isEditorRelative())\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.utils.setEditorRelative();\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.placeholder.build();\n\t\t\t\t\tthis.placeholder.buildPosition();\n\t\t\t\t\tthis.placeholder.enable();\n\t\t\t\t\tthis.placeholder.enableEvents();\n\n\t\t\t\t},\n\t\t\t\tenabled: function()\n\t\t\t\t{\n\t\t\t\t\treturn (this.opts.placeholder) ? this.core.element().attr('placeholder', this.opts.placeholder) : this.placeholder.isAttr();\n\t\t\t\t},\n\t\t\t\tenableEvents: function()\n\t\t\t\t{\n\t\t\t\t\tthis.core.editor().on('keydown.redactor-placeholder.' + this.uuid, $.proxy(this.placeholder.enable, this));\n\t\t\t\t},\n\t\t\t\tdisableEvents: function()\n\t\t\t\t{\n\t\t\t\t\tthis.core.editor().off('.redactor-placeholder.' + this.uuid);\n\t\t\t\t},\n\t\t\t\tbuild: function()\n\t\t\t\t{\n\t\t\t\t\tthis.core.editor().attr('placeholder', this.core.element().attr('placeholder'));\n\t\t\t\t},\n\t\t\t\tbuildPosition: function()\n\t\t\t\t{\n\t\t\t\t\tvar $style = $('<style />');\n\t\t\t\t\t$style.addClass('redactor-placeholder-style-tag');\n\t\t\t\t\t$style.html('#' + this.core.id() + '.redactor-placeholder::after ' + this.placeholder.getPosition());\n\n\t\t\t\t\t$('head').append($style);\n\t\t\t\t},\n\t\t\t\tgetPosition: function()\n\t\t\t\t{\n\t\t\t\t\treturn '{ top: ' + this.core.editor().css('padding-top') + '; left: ' + this.core.editor().css('padding-left') + '; }';\n\t\t\t\t},\n\t\t\t\tisEditorEmpty: function()\n\t\t\t\t{\n\t\t\t\t\tvar html = $.trim(this.core.editor().html()).replace(/[\\t\\n]/g, '');\n\t\t\t\t\tvar states = ['', '<p></p>', '<p><br></p>'];\n\n\t\t\t\t\treturn ($.inArray(html, states) !== -1);\n\t\t\t\t},\n\t\t\t\tisAttr: function()\n\t\t\t\t{\n\t\t\t\t\treturn (typeof this.core.element().attr('placeholder') !== 'undefined' && this.core.element().attr('placeholder') !== '');\n\t\t\t\t},\n\t\t\t\tdestroy: function()\n\t\t\t\t{\n\t\t\t\t\tthis.core.editor().removeAttr('placeholder');\n\n\t\t\t\t\tthis.placeholder.hide();\n\t\t\t\t\tthis.placeholder.disableEvents();\n\n\t\t\t\t\t$('.redactor-placeholder-style-tag').remove();\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =progress\n\t\tprogress: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\t$box: null,\n\t\t\t\t$bar: null,\n\t\t\t\ttarget: document.body,  // or id selector\n\n\t\t\t\t// public\n\t\t\t\tshow: function()\n\t\t\t\t{\n\t\t\t\t\tif (!this.progress.is())\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.progress.build();\n\t\t\t\t\t\tthis.progress.$box.redactorAnimation('fadeIn');\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.progress.$box.show();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\thide: function()\n\t\t\t\t{\n\t\t\t\t\tif (this.progress.is())\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.progress.$box.redactorAnimation('fadeOut', { duration: 0.35 }, $.proxy(this.progress.destroy, this));\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tupdate: function(value)\n\t\t\t\t{\n\t\t\t\t\tthis.progress.show();\n\t\t\t\t\tthis.progress.$bar.css('width', value + '%');\n\t\t\t\t},\n\t\t\t\tis: function()\n\t\t\t\t{\n\t\t\t\t\treturn (this.progress.$box === null) ? false : true;\n\t\t\t\t},\n\n\t\t\t\t// private\n\t\t\t\tbuild: function()\n\t\t\t\t{\n\t\t\t\t\tthis.progress.$bar = $('<span />');\n\t\t\t\t\tthis.progress.$box = $('<div id=\"redactor-progress\" />');\n\n\t\t\t\t\tthis.progress.$box.append(this.progress.$bar);\n\t\t\t\t\t$(this.progress.target).append(this.progress.$box);\n\t\t\t\t},\n\t\t\t\tdestroy: function()\n\t\t\t\t{\n\t\t\t\t\tif (this.progress.is())\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.progress.$box.remove();\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.progress.$box = null;\n\t\t\t\t\tthis.progress.$bar = null;\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =selection\n\t\tselection: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tget: function()\n\t\t\t\t{\n\t\t\t\t\tif (window.getSelection)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn window.getSelection();\n\t\t\t\t\t}\n\t\t\t\t\telse if (document.selection && document.selection.type !== \"Control\")\n\t\t\t\t\t{\n\t\t\t\t\t\treturn document.selection;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn null;\n\t\t\t\t},\n\t\t\t\trange: function(sel)\n\t\t\t\t{\n\t\t\t\t\tif (typeof sel === 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\tsel = this.selection.get();\n\t\t\t\t\t}\n\n\t\t\t\t\tif (sel.getRangeAt && sel.rangeCount)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn sel.getRangeAt(0);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn null;\n\t\t\t\t},\n\t\t\t\tis: function()\n\t\t\t\t{\n\t\t\t\t\treturn (this.selection.isCollapsed()) ? false : true;\n\t\t\t\t},\n\t\t\t\tisRedactor: function()\n\t\t\t\t{\n\t\t\t\t\tvar range = this.selection.range();\n\n\t\t\t\t\tif (range !== null)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar el = range.startContainer.parentNode;\n\n\t\t\t\t\t\tif ($(el).hasClass('redactor-in') || $(el).parents('.redactor-in').length !== 0)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn true;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\t\t\t\tisCollapsed: function()\n\t\t\t\t{\n\t\t\t\t\tvar sel = this.selection.get();\n\n\t\t\t\t\treturn (sel === null) ? false : sel.isCollapsed;\n\t\t\t\t},\n\t\t\t\tupdate: function(sel, range)\n\t\t\t\t{\n\t\t\t\t\tif (range === null)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tsel.removeAllRanges();\n\t\t\t\t\tsel.addRange(range);\n\t\t\t\t},\n\t\t\t\tcurrent: function()\n\t\t\t\t{\n\t\t\t\t\tvar sel = this.selection.get();\n\n\t\t\t\t\treturn (sel === null) ? false : sel.anchorNode;\n\t\t\t\t},\n\t\t\t\tparent: function()\n\t\t\t\t{\n\t\t\t\t\tvar current = this.selection.current();\n\n\t\t\t\t\treturn (current === null) ? false : current.parentNode;\n\t\t\t\t},\n\t\t\t\tblock: function(node)\n\t\t\t\t{\n\t\t\t\t\tnode = node || this.selection.current();\n\n\t\t\t\t\twhile (node)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (this.utils.isBlockTag(node.tagName))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn ($(node).hasClass('redactor-in')) ? false : node;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tnode = node.parentNode;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\t\t\t\tinline: function(node)\n\t\t\t\t{\n\t\t\t\t\tnode = node || this.selection.current();\n\n\t\t\t\t\twhile (node)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (this.utils.isInlineTag(node.tagName))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn ($(node).hasClass('redactor-in')) ? false : node;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tnode = node.parentNode;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\t\t\t\telement: function(node)\n\t\t\t\t{\n\t\t\t\t\tif (!node)\n\t\t\t\t\t{\n\t\t\t\t\t\tnode = this.selection.current();\n\t\t\t\t\t}\n\n\t\t\t\t\twhile (node)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (node.nodeType === 1)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tif ($(node).hasClass('redactor-in'))\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\treturn node;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tnode = node.parentNode;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\t\t\t\tprev: function()\n\t\t\t\t{\n\t\t\t\t\tvar current = this.selection.current();\n\n\t\t\t\t\treturn (current === null) ? false : this.selection.current().previousSibling;\n\t\t\t\t},\n\t\t\t\tnext: function()\n\t\t\t\t{\n\t\t\t\t\tvar current = this.selection.current();\n\n\t\t\t\t\treturn (current === null) ? false : this.selection.current().nextSibling;\n\t\t\t\t},\n\t\t\t\tblocks: function(tag)\n\t\t\t\t{\n\t\t\t\t\tvar blocks = [];\n\t\t\t\t\tvar nodes = this.selection.nodes(tag);\n\n\t\t\t\t\t$.each(nodes, $.proxy(function(i,node)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (this.utils.isBlock(node))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tblocks.push(node);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}, this));\n\n\t\t\t\t\tvar block = this.selection.block();\n\t\t\t\t\tif (blocks.length === 0 && block === false)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn [];\n\t\t\t\t\t}\n\t\t\t\t\telse if (blocks.length === 0 && block !== false)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn [block];\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\treturn blocks;\n\t\t\t\t\t}\n\n\t\t\t\t},\n\t\t\t\tinlines: function(tag)\n\t\t\t\t{\n\t\t\t\t\tvar inlines = [];\n\t\t\t\t\tvar nodes = this.selection.nodes(tag);\n\n\t\t\t\t\t$.each(nodes, $.proxy(function(i,node)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (this.utils.isInline(node))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tinlines.push(node);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}, this));\n\n\t\t\t\t\tvar inline = this.selection.inline();\n\t\t\t\t\tif (inlines.length === 0 && inline === false)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn [];\n\t\t\t\t\t}\n\t\t\t\t\telse if (inlines.length === 0 && inline !== false)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn [inline];\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\treturn inlines;\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tnodes: function(tag)\n\t\t\t\t{\n\t\t\t\t\tvar filter = (typeof tag === 'undefined') ? [] : (($.isArray(tag)) ? tag : [tag]);\n\n\t\t\t\t\tvar sel = this.selection.get();\n\t\t\t\t\tvar range = this.selection.range(sel);\n\t\t\t\t\tif (this.utils.isCollapsed())\n\t\t\t\t\t{\n\t\t\t\t\t\treturn [this.selection.current()];\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tvar node = range.startContainer;\n\t\t\t\t\t\tvar endNode = range.endContainer;\n\n\t\t\t\t\t\t// single node\n\t\t\t\t\t\tif (node === endNode)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn [node];\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// iterate\n\t\t\t\t\t\tvar nodes = [];\n\t\t\t\t\t\twhile (node && node !== endNode)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tnodes.push(node = this.selection.nextNode(node));\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// partially selected nodes\n\t\t\t\t\t\tnode = range.startContainer;\n\t\t\t\t\t\twhile (node && node !== range.commonAncestorContainer)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tnodes.unshift(node);\n\t\t\t\t\t\t\tnode = node.parentNode;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// remove service nodes\n\t\t\t\t\t\tvar resultNodes = [];\n\t\t\t\t\t\t$.each(nodes, function(i,s)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar tagName = (s.nodeType !== 1) ? false : s.tagName.toLowerCase();\n\t\t\t\t\t\t\tif ($(s).hasClass('redactor-script-tag, redactor-selection-marker'))\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse if (tagName && filter.length !== 0 && $.inArray(tagName, filter) === -1)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tresultNodes.push(s);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\treturn (resultNodes.length === 0) ? [] : resultNodes;\n\t\t\t\t\t}\n\n\t\t\t\t},\n\t\t\t\tnextNode: function(node)\n\t\t\t\t{\n\t\t\t\t\tif (node.hasChildNodes())\n\t\t\t\t\t{\n\t\t\t\t\t\treturn node.firstChild;\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\twhile (node && !node.nextSibling)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tnode = node.parentNode;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (!node)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn null;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn node.nextSibling;\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tsave: function()\n\t\t\t\t{\n\t\t\t\t\tthis.marker.insert();\n\t\t\t\t\tthis.savedSel = this.core.editor().html();\n\t\t\t\t},\n\t\t\t\trestore: function(removeMarkers)\n\t\t\t\t{\n                    var node1 = this.marker.find(1);\n\t\t\t\t\tvar node2 = this.marker.find(2);\n\n\t\t\t\t\tif (this.detect.isFirefox())\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.editor().focus();\n\t\t\t\t\t}\n\n\t\t\t\t\tif (node1.length !== 0 && node2.length !== 0)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.caret.set(node1, node2);\n\t\t\t\t\t}\n\t\t\t\t\telse if (node1.length !== 0)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.caret.start(node1);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.editor().focus();\n\t\t\t\t\t}\n\n\t\t\t\t\tif (removeMarkers !== false)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.marker.remove();\n\t\t\t\t\t\tthis.savedSel = false;\n\t\t\t\t\t}\n\n\t\t\t\t},\n\t\t\t\tnode: function(node)\n\t\t\t\t{\n\t\t\t\t\t$(node).prepend(this.marker.get(1));\n\t\t\t\t\t$(node).append(this.marker.get(2));\n\n\t\t\t\t\tthis.selection.restore();\n\t\t\t\t},\n\t\t\t\tall: function()\n\t\t\t\t{\n\t\t\t\t\tthis.core.editor().focus();\n\n\t\t\t\t\tvar sel = this.selection.get();\n\t\t\t\t\tvar range = this.selection.range(sel);\n\n\t\t\t\t\trange.selectNodeContents(this.core.editor()[0]);\n\n\t\t\t\t\tthis.selection.update(sel, range);\n\t\t\t\t},\n\t\t\t\tremove: function()\n\t\t\t\t{\n\t\t\t\t\tthis.selection.get().removeAllRanges();\n\t\t\t\t},\n\t\t\t\treplace: function(html)\n\t\t\t\t{\n\t\t\t\t\tthis.insert.html(html);\n\t\t\t\t},\n\t\t\t\ttext: function()\n\t\t\t\t{\n\t\t\t\t\treturn this.selection.get().toString();\n\t\t\t\t},\n\t\t\t\thtml: function()\n\t\t\t\t{\n\t\t\t\t\tvar html = '';\n\t\t\t\t\tvar sel = this.selection.get();\n\n\t\t\t\t\tif (sel.rangeCount)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar container = document.createElement('div');\n\t\t\t\t\t\tvar len = sel.rangeCount;\n\t\t\t\t\t\tfor (var i = 0; i < len; ++i)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tcontainer.appendChild(sel.getRangeAt(i).cloneContents());\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\thtml = this.clean.onGet(container.innerHTML);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn html;\n\t\t\t\t},\n\t\t\t\textractEndOfNode: function(node)\n\t\t\t\t{\n\t\t\t\t\tvar sel = this.selection.get();\n\t\t\t\t\tvar range = this.selection.range(sel);\n\n\t\t\t        var clonedRange = range.cloneRange();\n\t\t\t        clonedRange.selectNodeContents(node);\n\t\t\t        clonedRange.setStart(range.endContainer, range.endOffset);\n\n\t\t\t        return clonedRange.extractContents();\n\t\t\t\t},\n\n\t\t\t\t// #backward\n\t\t\t\tremoveMarkers: function()\n\t\t\t\t{\n\t\t\t\t\tthis.marker.remove();\n\t\t\t\t},\n\t\t\t\tmarker: function(num)\n\t\t\t\t{\n\t\t\t\t\treturn this.marker.get(num);\n\t\t\t\t},\n\t\t\t\tmarkerHtml: function(num)\n\t\t\t\t{\n\t\t\t\t\treturn this.marker.html(num);\n\t\t\t\t}\n\n\t\t\t};\n\t\t},\n\n\t\t// =shortcuts\n\t\tshortcuts: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\t// based on https://github.com/jeresig/jquery.hotkeys\n\t\t\t\thotkeysSpecialKeys: {\n\t\t\t\t\t8: \"backspace\", 9: \"tab\", 10: \"return\", 13: \"return\", 16: \"shift\", 17: \"ctrl\", 18: \"alt\", 19: \"pause\",\n\t\t\t\t\t20: \"capslock\", 27: \"esc\", 32: \"space\", 33: \"pageup\", 34: \"pagedown\", 35: \"end\", 36: \"home\",\n\t\t\t\t\t37: \"left\", 38: \"up\", 39: \"right\", 40: \"down\", 45: \"insert\", 46: \"del\", 59: \";\", 61: \"=\",\n\t\t\t\t\t96: \"0\", 97: \"1\", 98: \"2\", 99: \"3\", 100: \"4\", 101: \"5\", 102: \"6\", 103: \"7\",\n\t\t\t\t\t104: \"8\", 105: \"9\", 106: \"*\", 107: \"+\", 109: \"-\", 110: \".\", 111 : \"/\",\n\t\t\t\t\t112: \"f1\", 113: \"f2\", 114: \"f3\", 115: \"f4\", 116: \"f5\", 117: \"f6\", 118: \"f7\", 119: \"f8\",\n\t\t\t\t\t120: \"f9\", 121: \"f10\", 122: \"f11\", 123: \"f12\", 144: \"numlock\", 145: \"scroll\", 173: \"-\", 186: \";\", 187: \"=\",\n\t\t\t\t\t188: \",\", 189: \"-\", 190: \".\", 191: \"/\", 192: \"`\", 219: \"[\", 220: \"\\\\\", 221: \"]\", 222: \"'\"\n\t\t\t\t},\n\t\t\t\thotkeysShiftNums: {\n\t\t\t\t\t\"`\": \"~\", \"1\": \"!\", \"2\": \"@\", \"3\": \"#\", \"4\": \"$\", \"5\": \"%\", \"6\": \"^\", \"7\": \"&\",\n\t\t\t\t\t\"8\": \"*\", \"9\": \"(\", \"0\": \")\", \"-\": \"_\", \"=\": \"+\", \";\": \": \", \"'\": \"\\\"\", \",\": \"<\",\n\t\t\t\t\t\".\": \">\",  \"/\": \"?\",  \"\\\\\": \"|\"\n\t\t\t\t},\n\t\t\t\tinit: function(e, key)\n\t\t\t\t{\n\t\t\t\t\t// disable browser's hot keys for bold and italic if shortcuts off\n\t\t\t\t\tif (this.opts.shortcuts === false)\n\t\t\t\t\t{\n\t\t\t\t\t\tif ((e.ctrlKey || e.metaKey) && (key === 66 || key === 73))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\t// build\n\t\t\t\t\t\t$.each(this.opts.shortcuts, $.proxy(function(str, command)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.shortcuts.build(e, str, command);\n\n\t\t\t\t\t\t}, this));\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tbuild: function(e, str, command)\n\t\t\t\t{\n\t\t\t\t\tvar handler = $.proxy(function()\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.shortcuts.buildHandler(command);\n\n\t\t\t\t\t}, this);\n\n\t\t\t\t\tvar keys = str.split(',');\n\t\t\t\t\tvar len = keys.length;\n\t\t\t\t\tfor (var i = 0; i < len; i++)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (typeof keys[i] === 'string')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.shortcuts.handler(e, $.trim(keys[i]), handler);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t},\n\t\t\t\tbuildHandler: function(command)\n\t\t\t\t{\n\t\t\t\t\tvar func;\n\t\t\t\t\tif (command.func.search(/\\./) !== '-1')\n\t\t\t\t\t{\n\t\t\t\t\t\tfunc = command.func.split('.');\n\t\t\t\t\t\tif (typeof this[func[0]] !== 'undefined')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis[func[0]][func[1]].apply(this, command.params);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis[command.func].apply(this, command.params);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\thandler: function(e, keys, origHandler)\n\t\t\t\t{\n\t\t\t\t\tkeys = keys.toLowerCase().split(\" \");\n\n\t\t\t\t\tvar special = this.shortcuts.hotkeysSpecialKeys[e.keyCode];\n\t\t\t\t\tvar character = String.fromCharCode(e.which).toLowerCase();\n\t\t\t\t\tvar modif = \"\", possible = {};\n\n\t\t\t\t\t$.each([ \"alt\", \"ctrl\", \"meta\", \"shift\"], function(index, specialKey)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (e[specialKey + 'Key'] && special !== specialKey)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tmodif += specialKey + '+';\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\n\n\t\t\t\t\tif (special)\n\t\t\t\t\t{\n\t\t\t\t\t\tpossible[modif + special] = true;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (character)\n\t\t\t\t\t{\n\t\t\t\t\t\tpossible[modif + character] = true;\n\t\t\t\t\t\tpossible[modif + this.shortcuts.hotkeysShiftNums[character]] = true;\n\n\t\t\t\t\t\t// \"$\" can be triggered as \"Shift+4\" or \"Shift+$\" or just \"$\"\n\t\t\t\t\t\tif (modif === \"shift+\")\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tpossible[this.shortcuts.hotkeysShiftNums[character]] = true;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tvar len = keys.length;\n\t\t\t\t\tfor (var i = 0; i < len; i++)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (possible[keys[i]])\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\t\treturn origHandler.apply(this, arguments);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =storage\n\t\tstorage: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tdata: [],\n\t\t\t\tadd: function(data)\n\t\t\t\t{\n\t\t\t\t\t// type, node, url, id\n\t\t\t\t\tdata.status = true;\n\t\t\t\t\tdata.url = decodeURI(this.link.removeSelfHostFromUrl(data.url));\n\n\t\t\t\t\tthis.storage.data[data.url] = data;\n\t\t\t\t},\n\t\t\t\tstatus: function(url, status)\n\t\t\t\t{\n\t\t\t\t\tthis.storage.data[decodeURI(url)].status = status;\n\t\t\t\t},\n\t\t\t\tobserve: function()\n\t\t\t\t{\n\t\t\t\t\tvar _this = this;\n\n\t\t\t\t\tvar $images = this.core.editor().find('[data-image]');\n\t\t\t\t\t$images.each(function(i, s)\n\t\t\t\t\t{\n\t\t\t\t\t\t_this.storage.add({ type: 'image', node: s, url: s.src, id: $(s).attr('data-image') });\n\t\t\t\t\t});\n\n\t\t\t\t\tvar $files = this.core.editor().find('[data-file]');\n\t\t\t\t\t$files.each(function(i, s)\n\t\t\t\t\t{\n\t\t\t\t\t\t_this.storage.add({ type: 'file', node: s, url: s.href, id: $(s).attr('data-file') });\n\t\t\t\t\t});\n\n\t\t\t\t\tvar $s3 = this.core.editor().find('[data-s3]');\n\t\t\t\t\t$s3.each(function(i, s)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar url = (s.tagName === 'IMG') ? s.src : s.href;\n\t\t\t\t\t\t_this.storage.add({ type: 's3', node: s, url: url, id: $(s).attr('data-s3') });\n\t\t\t\t\t});\n\n\t\t\t\t},\n\t\t\t\tchanges: function()\n\t\t\t\t{\n\t\t\t\t\tfor (var key in this.storage.data)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar data = this.storage.data[key];\n\t\t\t\t\t\tvar attr = (data.node.tagName === 'IMG') ? 'src' : 'href';\n\t\t\t\t\t\tvar $el = this.core.editor().find('[data-' + data.type + '][' + attr + '=\"' + data.url + '\"]');\n\n\t\t\t\t\t\tif ($el.length === 0)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.storage.status(data.url, false);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.storage.status(data.url, true);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\n\t\t\t\t\treturn this.storage.data;\n\t\t\t\t}\n\n\t\t\t};\n\t\t},\n\n\t\t// =toolbar\n\t\ttoolbar: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tbuild: function()\n\t\t\t\t{\n\t\t\t\t\tthis.button.hideButtons();\n\t\t\t\t\tthis.button.hideButtonsOnMobile();\n\n\t\t\t\t\tthis.$toolbar = this.toolbar.createContainer();\n\n\t\t\t\t\tthis.toolbar.append();\n\t\t\t\t\tthis.button.$toolbar = this.$toolbar;\n\t\t\t\t\tthis.button.setFormatting();\n\t\t\t\t\tthis.button.load(this.$toolbar);\n\t\t\t\t\tthis.toolbar.setFixed();\n\n\t\t\t\t},\n\t\t\t\tcreateContainer: function()\n\t\t\t\t{\n\t\t\t\t\treturn $('<ul>').addClass('redactor-toolbar').attr({ 'id': 'redactor-toolbar-' + this.uuid, 'role': 'toolbar' });\n\t\t\t\t},\n\t\t\t\tappend: function()\n\t\t\t\t{\n\t\t\t\t\tif (this.opts.toolbarExternal)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.$toolbar.addClass('redactor-toolbar-external');\n\t\t\t\t\t\t$(this.opts.toolbarExternal).html(this.$toolbar);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tif (this.opts.type === 'textarea')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.$box.prepend(this.$toolbar);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.$element.before(this.$toolbar);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tsetFixed: function()\n\t\t\t\t{\n\t\t\t\t\tif (!this.opts.toolbarFixed || this.opts.toolbarExternal)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.opts.toolbarFixedTarget !== document)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar $el = $(this.opts.toolbarFixedTarget);\n\t\t\t\t\t\tthis.toolbarOffsetTop = ($el.length === 0) ? 0 : this.core.box().offset().top - $el.offset().top;\n\t\t\t\t\t}\n\n\t\t\t\t\t// bootstrap modal fix\n\t\t\t\t\tvar late = (this.core.box().closest('.modal-body').length !== 0) ? 1000 : 0;\n\n\t\t\t\t\tsetTimeout($.proxy(function()\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.toolbar.observeScroll(false);\n\t\t\t\t\t\tif (this.detect.isDesktop())\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$(this.opts.toolbarFixedTarget).on('scroll.redactor.' + this.uuid, $.proxy(this.toolbar.observeScroll, this));\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar self = this;\n\t\t\t\t\t\t\t$(this.opts.toolbarFixedTarget).on('scroll.redactor.' + this.uuid, function()\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tself.core.toolbar().hide();\n\t\t\t\t\t\t\t\tclearTimeout($.data(this, \"scrollCheck\" ) );\n\t\t\t\t\t\t\t\t$.data( this, \"scrollCheck\", setTimeout(function()\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tself.core.toolbar().show();\n\t\t\t\t\t\t\t\t\tself.toolbar.observeScroll();\n\t\t\t\t\t\t\t\t}, 250) );\n\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}, this), late);\n\n\t\t\t\t},\n\t\t\t\tgetBoxTop: function()\n\t\t\t\t{\n\t\t\t\t\treturn (this.opts.toolbarFixedTarget === document) ? this.core.box().offset().top : this.toolbarOffsetTop;\n\t\t\t\t},\n\t\t\t\tobserveScroll: function(start)\n\t\t\t\t{\n\t\t\t\t\t// tolerance 0 if redactor in the hidden layer\n\t\t\t\t\tvar tolerance = 0;\n\n\t\t\t\t\tif (start !== false)\n\t\t\t\t\t{\n\t\t\t\t\t\ttolerance = (this.opts.toolbarFixedTarget === document) ? 20 : 0;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar scrollTop = $(this.opts.toolbarFixedTarget).scrollTop();\n\t\t\t\t\tvar boxTop = this.toolbar.getBoxTop();\n\n                    if (scrollTop === boxTop)\n                    {\n                        return;\n                    }\n\n\t\t\t\t\tif ((scrollTop + this.opts.toolbarFixedTopOffset + tolerance) > boxTop)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.toolbar.observeScrollEnable(scrollTop, boxTop);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.toolbar.observeScrollDisable();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tobserveScrollResize: function()\n\t\t\t\t{\n\t\t\t\t\tthis.$toolbar.css({\n\n\t\t\t\t\t\twidth: this.core.box().innerWidth(),\n\t\t\t\t\t\tleft: this.core.box().offset().left\n\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t\tobserveScrollEnable: function(scrollTop, boxTop)\n\t\t\t\t{\n\t\t\t\t\tif (typeof this.fullscreen !== 'undefined' && this.fullscreen.isOpened === false)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.toolbar.observeScrollDisable();\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar end = boxTop + this.core.box().outerHeight() - 32;\n\t\t\t\t\tvar width = this.core.box().innerWidth();\n\n\t\t\t\t\tvar position = (this.detect.isDesktop()) ? 'fixed' : 'absolute';\n\t\t\t\t\tvar top = (this.detect.isDesktop()) ? this.opts.toolbarFixedTopOffset : ($(this.opts.toolbarFixedTarget).scrollTop() - boxTop);\n\t\t\t\t\tvar left = (this.detect.isDesktop()) ? this.core.box().offset().left : 0;\n\n\t\t\t\t\tif (this.opts.toolbarFixedTarget !== document)\n\t\t\t\t\t{\n\t\t\t\t\t\t position = 'absolute';\n\t\t\t\t\t\t top = this.opts.toolbarFixedTopOffset + $(this.opts.toolbarFixedTarget).scrollTop() - boxTop;\n\t\t\t\t\t\t left = 0;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.$toolbar.addClass('toolbar-fixed-box');\n\n\t\t\t\t\tthis.$toolbar.css({\n\t\t\t\t\t\tposition: position,\n\t\t\t\t\t\twidth: width,\n\t\t\t\t\t\ttop: top,\n\t\t\t\t\t\tleft: left\n\t\t\t\t\t});\n\n\n\t\t\t\t\tif (scrollTop > end)\n\t\t\t\t\t{\n\t\t\t\t\t\t$('.redactor-dropdown-' + this.uuid + ':visible').hide();\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.toolbar.setDropdownsFixed();\n\n\t\t\t\t\tthis.$toolbar.css('visibility', (scrollTop < end) ? 'visible' : 'hidden');\n\t\t\t\t\t$(window).on('resize.redactor-toolbar.' + this.uuid, $.proxy(this.toolbar.observeScrollResize, this));\n\t\t\t\t},\n\t\t\t\tobserveScrollDisable: function()\n\t\t\t\t{\n\t\t\t\t\tthis.$toolbar.css({\n\t\t\t\t\t\tposition: 'relative',\n\t\t\t\t\t\twidth: 'auto',\n\t\t\t\t\t\ttop: 0,\n\t\t\t\t\t\tleft: 0,\n\t\t\t\t\t\tvisibility: 'visible'\n\t\t\t\t\t});\n\n\t\t\t\t\tthis.toolbar.unsetDropdownsFixed();\n\t\t\t\t\tthis.$toolbar.removeClass('toolbar-fixed-box');\n\t\t\t\t\t$(window).off('resize.redactor-toolbar.' + this.uuid);\n\t\t\t\t},\n\t\t\t\tsetDropdownsFixed: function()\n\t\t\t\t{\n\t\t\t\t\tvar position = (this.opts.toolbarFixedTarget === document && this.detect.isDesktop()) ? 'fixed' : 'absolute';\n\t\t\t\t\tthis.toolbar.setDropdownPosition(position);\n\t\t\t\t},\n\t\t\t\tunsetDropdownsFixed: function()\n\t\t\t\t{\n\t\t\t\t\tthis.toolbar.setDropdownPosition('absolute');\n\t\t\t\t},\n\t\t\t\tsetDropdownPosition: function(position)\n\t\t\t\t{\n\t\t\t\t\tvar self = this;\n\t\t\t\t\t$('.redactor-dropdown-' + this.uuid).each(function()\n\t\t\t\t\t{\n\t\t\t\t\t\tvar $el = $(this);\n\t\t\t\t\t\tvar $button = self.button.get($el.attr('rel'));\n\t\t\t\t\t\tvar top = (position === 'fixed') ? self.opts.toolbarFixedTopOffset : $button.offset().top;\n\n\t\t\t\t\t\t$el.css({ position: position, top: ($button.innerHeight() + top) + 'px' });\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =upload\n\t\tupload: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tinit: function(id, url, callback)\n\t\t\t\t{\n\t\t\t\t\tthis.upload.direct = false;\n\t\t\t\t\tthis.upload.callback = callback;\n\t\t\t\t\tthis.upload.url = url;\n\t\t\t\t\tthis.upload.$el = $(id);\n\t\t\t\t\tthis.upload.$droparea = $('<div id=\"redactor-droparea\" />');\n\n\t\t\t\t\tthis.upload.$placeholdler = $('<div id=\"redactor-droparea-placeholder\" />').text(this.lang.get('upload-label'));\n\t\t\t\t\tthis.upload.$input = $('<input type=\"file\" name=\"file\" />');\n\n\t\t\t\t\tthis.upload.$placeholdler.append(this.upload.$input);\n\t\t\t\t\tthis.upload.$droparea.append(this.upload.$placeholdler);\n\t\t\t\t\tthis.upload.$el.append(this.upload.$droparea);\n\n\t\t\t\t\tthis.upload.$droparea.off('redactor.upload');\n\t\t\t\t\tthis.upload.$input.off('redactor.upload');\n\n\t\t\t\t\tthis.upload.$droparea.on('dragover.redactor.upload', $.proxy(this.upload.onDrag, this));\n\t\t\t\t\tthis.upload.$droparea.on('dragleave.redactor.upload', $.proxy(this.upload.onDragLeave, this));\n\n\t\t\t\t\t// change\n\t\t\t\t\tthis.upload.$input.on('change.redactor.upload', $.proxy(function(e)\n\t\t\t\t\t{\n\t\t\t\t\t\te = e.originalEvent || e;\n\t\t\t\t\t\tthis.upload.traverseFile(this.upload.$input[0].files[0], e);\n\t\t\t\t\t}, this));\n\n\t\t\t\t\t// drop\n\t\t\t\t\tthis.upload.$droparea.on('drop.redactor.upload', $.proxy(function(e)\n\t\t\t\t\t{\n\t\t\t\t\t\te.preventDefault();\n\n\t\t\t\t\t\tthis.upload.$droparea.removeClass('drag-hover').addClass('drag-drop');\n\t\t\t\t\t\tthis.upload.onDrop(e);\n\n\t\t\t\t\t}, this));\n\t\t\t\t},\n\t\t\t\tdirectUpload: function(file, e)\n\t\t\t\t{\n\t\t\t\t\tthis.upload.direct = true;\n\t\t\t\t\tthis.upload.traverseFile(file, e);\n\t\t\t\t},\n\t\t\t\tonDrop: function(e)\n\t\t\t\t{\n\t\t\t\t\te = e.originalEvent || e;\n\t\t\t\t\tvar files = e.dataTransfer.files;\n\n\t\t\t\t\tif (this.opts.multipleImageUpload)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar len = files.length;\n\t\t\t\t\t\tfor (var i = 0; i < len; i++)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.upload.traverseFile(files[i], e);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.upload.traverseFile(files[0], e);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\ttraverseFile: function(file, e)\n\t\t\t\t{\n\t\t\t\t\tif (this.opts.s3)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.upload.setConfig(file);\n\t\t\t\t\t\tthis.uploads3.send(file, e);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar formData = !!window.FormData ? new FormData() : null;\n\t\t\t\t\tif (window.FormData)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.upload.setConfig(file);\n\n\t\t\t\t\t\tvar name = (this.upload.type === 'image') ? this.opts.imageUploadParam : this.opts.fileUploadParam;\n\t\t\t\t\t\tformData.append(name, file);\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.progress.show();\n\t\t\t\t\tthis.core.callback('uploadStart', e, formData);\n\t\t\t\t\tthis.upload.send(formData, e);\n\t\t\t\t},\n\t\t\t\tsetConfig: function(file)\n\t\t\t\t{\n\t\t\t\t\tthis.upload.getType(file);\n\n\t\t\t\t\tif (this.upload.direct)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.upload.url = (this.upload.type === 'image') ? this.opts.imageUpload : this.opts.fileUpload;\n\t\t\t\t\t\tthis.upload.callback = (this.upload.type === 'image') ? this.image.insert : this.file.insert;\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tgetType: function(file)\n\t\t\t\t{\n\t\t\t\t\tthis.upload.type = (this.opts.imageTypes.indexOf(file.type) === -1) ? 'file' : 'image';\n\n\t\t\t\t\tif (this.opts.imageUpload === null && this.opts.fileUpload !== null)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.upload.type = 'file';\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tgetHiddenFields: function(obj, fd)\n\t\t\t\t{\n\t\t\t\t\tif (obj === false || typeof obj !== 'object')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn fd;\n\t\t\t\t\t}\n\n\t\t\t\t\t$.each(obj, $.proxy(function(k, v)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (v !== null && v.toString().indexOf('#') === 0)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tv = $(v).val();\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tfd.append(k, v);\n\n\t\t\t\t\t}, this));\n\n\t\t\t\t\treturn fd;\n\n\t\t\t\t},\n\t\t\t\tsend: function(formData, e)\n\t\t\t\t{\n\t\t\t\t\t// append hidden fields\n\t\t\t\t\tif (this.upload.type === 'image')\n\t\t\t\t\t{\n\t\t\t\t\t\tformData = this.utils.appendFields(this.opts.imageUploadFields, formData);\n\t\t\t\t\t\tformData = this.utils.appendForms(this.opts.imageUploadForms, formData);\n\t\t\t\t\t\tformData = this.upload.getHiddenFields(this.upload.imageFields, formData);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tformData = this.utils.appendFields(this.opts.fileUploadFields, formData);\n\t\t\t\t\t\tformData = this.utils.appendForms(this.opts.fileUploadForms, formData);\n\t\t\t\t\t\tformData = this.upload.getHiddenFields(this.upload.fileFields, formData);\n\t\t\t\t\t}\n\n\t\t\t\t\tvar xhr = new XMLHttpRequest();\n\t\t\t\t\txhr.open('POST', this.upload.url);\n\t\t\t\t\txhr.setRequestHeader(\"X-Requested-With\", \"XMLHttpRequest\");\n\n\t\t\t\t\t// complete\n\t\t\t\t\txhr.onreadystatechange = $.proxy(function()\n\t\t\t\t\t{\n\t\t\t\t\t    if (xhr.readyState === 4)\n\t\t\t\t\t    {\n\t\t\t\t\t        var data = xhr.responseText;\n\n\t\t\t\t\t\t\tdata = data.replace(/^\\[/, '');\n\t\t\t\t\t\t\tdata = data.replace(/\\]$/, '');\n\n\t\t\t\t\t\t\tvar json;\n\t\t\t\t\t\t\ttry\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tjson = (typeof data === 'string' ? $.parseJSON(data) : data);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tcatch(err)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tjson = { error: true };\n\t\t\t\t\t\t\t}\n\n\n\t\t\t\t\t\t\tthis.progress.hide();\n\n\t\t\t\t\t\t\tif (!this.upload.direct)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tthis.upload.$droparea.removeClass('drag-drop');\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tthis.upload.callback(json, this.upload.direct, e);\n\t\t\t\t\t    }\n\t\t\t\t\t}, this);\n\n\t\t\t\t\txhr.send(formData);\n\t\t\t\t},\n\t\t\t\tonDrag: function(e)\n\t\t\t\t{\n\t\t\t\t\te.preventDefault();\n\t\t\t\t\tthis.upload.$droparea.addClass('drag-hover');\n\t\t\t\t},\n\t\t\t\tonDragLeave: function(e)\n\t\t\t\t{\n\t\t\t\t\te.preventDefault();\n\t\t\t\t\tthis.upload.$droparea.removeClass('drag-hover');\n\t\t\t\t},\n\t\t\t\tclearImageFields: function()\n\t\t\t\t{\n\t\t\t\t\tthis.upload.imageFields = {};\n\t\t\t\t},\n\t\t\t\taddImageFields: function(name, value)\n\t\t\t\t{\n\t\t\t\t\tthis.upload.imageFields[name] = value;\n\t\t\t\t},\n\t\t\t\tremoveImageFields: function(name)\n\t\t\t\t{\n\t\t\t\t\tdelete this.upload.imageFields[name];\n\t\t\t\t},\n\t\t\t\tclearFileFields: function()\n\t\t\t\t{\n\t\t\t\t\tthis.upload.fileFields = {};\n\t\t\t\t},\n\t\t\t\taddFileFields: function(name, value)\n\t\t\t\t{\n\t\t\t\t\tthis.upload.fileFields[name] = value;\n\t\t\t\t},\n\t\t\t\tremoveFileFields: function(name)\n\t\t\t\t{\n\t\t\t\t\tdelete this.upload.fileFields[name];\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =s3\n\t\tuploads3: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tsend: function(file, e)\n\t\t\t\t{\n\t\t\t\t\tthis.uploads3.executeOnSignedUrl(file, $.proxy(function(signedURL)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.uploads3.sendToS3(file, signedURL, e);\n\t\t\t\t\t}, this));\n\t\t\t\t},\n\t\t\t\texecuteOnSignedUrl: function(file, callback)\n\t\t\t\t{\n\t\t\t\t\tvar xhr = new XMLHttpRequest();\n\t\t\t\t\tvar mark = (this.opts.s3.search(/\\?/) === -1) ? '?' : '&';\n\n\t\t\t\t\txhr.open('GET', this.opts.s3 + mark + 'name=' + file.name + '&type=' + file.type, true);\n\n\t\t\t\t\t// hack to pass bytes through unprocessed.\n\t\t\t\t\tif (xhr.overrideMimeType)\n\t\t\t\t\t{\n\t\t\t\t\t\txhr.overrideMimeType('text/plain; charset=x-user-defined');\n\t\t\t\t\t}\n\n\t\t\t\t\tvar that = this;\n\t\t\t\t\txhr.onreadystatechange = function(e)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (this.readyState === 4 && this.status === 200)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthat.progress.show();\n\t\t\t\t\t\t\tcallback(decodeURIComponent(this.responseText));\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\n\t\t\t\t\txhr.send();\n\t\t\t\t},\n\t\t\t\tcreateCORSRequest: function(method, url)\n\t\t\t\t{\n\t\t\t\t\tvar xhr = new XMLHttpRequest();\n\t\t\t\t\tif (\"withCredentials\" in xhr)\n\t\t\t\t\t{\n\t\t\t\t\t\txhr.open(method, url, true);\n\t\t\t\t\t}\n\t\t\t\t\telse if (typeof XDomainRequest !== \"undefined\")\n\t\t\t\t\t{\n\t\t\t\t\t\txhr = new XDomainRequest();\n\t\t\t\t\t\txhr.open(method, url);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\txhr = null;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn xhr;\n\t\t\t\t},\n\t\t\t\tsendToS3: function(file, url, e)\n\t\t\t\t{\n\t\t\t\t\tvar xhr = this.uploads3.createCORSRequest('PUT', url);\n\t\t\t\t\tif (!xhr)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\txhr.onload = $.proxy(function()\n\t\t\t\t\t{\n\t\t\t\t\t\tvar json;\n\n\t\t\t\t\t\tthis.progress.hide();\n\n\t\t\t\t\t\tif (xhr.status !== 200)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t// error\n\t\t\t\t\t\t\tjson = { error: true };\n\t\t\t\t\t\t\tthis.upload.callback(json, this.upload.direct, xhr);\n\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tvar s3file = url.split('?');\n\n\t\t\t\t\t\tif (!s3file[0])\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t // url parsing is fail\n\t\t\t\t\t\t\t return false;\n\t\t\t\t\t\t}\n\n\n\t\t\t\t\t\tif (!this.upload.direct)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.upload.$droparea.removeClass('drag-drop');\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tjson = { url: s3file[0], id: s3file[0], s3: true };\n\t\t\t\t\t\tif (this.upload.type === 'file')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar arr = s3file[0].split('/');\n\t\t\t\t\t\t\tjson.name = arr[arr.length-1];\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tthis.upload.callback(json, this.upload.direct, e);\n\n\n\t\t\t\t\t}, this);\n\n\t\t\t\t\txhr.onerror = function() {};\n\t\t\t\t\txhr.upload.onprogress = function(e) {};\n\n\t\t\t\t\txhr.setRequestHeader('Content-Type', file.type);\n\t\t\t\t\txhr.setRequestHeader('x-amz-acl', 'public-read');\n\n\t\t\t\t\txhr.send(file);\n\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\t// =utils\n\t\tutils: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\tisEmpty: function(html)\n\t\t\t\t{\n\t\t\t\t\thtml = (typeof html === 'undefined') ? this.core.editor().html() : html;\n\n\t\t\t\t\thtml = html.replace(/[\\u200B-\\u200D\\uFEFF]/g, '');\n\t\t\t\t\thtml = html.replace(/&nbsp;/gi, '');\n\t\t\t\t\thtml = html.replace(/<\\/?br\\s?\\/?>/g, '');\n\t\t\t\t\thtml = html.replace(/\\s/g, '');\n\t\t\t\t\thtml = html.replace(/^<p>[^\\W\\w\\D\\d]*?<\\/p>$/i, '');\n\t\t\t\t\thtml = html.replace(/<iframe(.*?[^>])>$/i, 'iframe');\n\t\t\t\t\thtml = html.replace(/<source(.*?[^>])>$/i, 'source');\n\n\t\t\t\t\t// remove empty tags\n\t\t\t\t\thtml = html.replace(/<[^\\/>][^>]*><\\/[^>]+>/gi, '');\n\t\t\t\t\thtml = html.replace(/<[^\\/>][^>]*><\\/[^>]+>/gi, '');\n\n\t\t\t\t\thtml = $.trim(html);\n\n\t\t\t\t\treturn html === '';\n\t\t\t\t},\n\t\t\t\tisElement: function(obj)\n\t\t\t\t{\n\t\t\t\t\ttry {\n\t\t\t\t\t\t// Using W3 DOM2 (works for FF, Opera and Chrome)\n\t\t\t\t\t\treturn obj instanceof HTMLElement;\n\t\t\t\t\t}\n\t\t\t\t\tcatch(e)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn (typeof obj === \"object\") && (obj.nodeType === 1) && (typeof obj.style === \"object\") && (typeof obj.ownerDocument === \"object\");\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tstrpos: function(haystack, needle, offset)\n\t\t\t\t{\n\t\t\t\t\tvar i = haystack.indexOf(needle, offset);\n\t\t\t\t\treturn i >= 0 ? i : false;\n\t\t\t\t},\n\t\t\t\tdataURItoBlob: function(dataURI)\n\t\t\t\t{\n\t\t\t\t\tvar byteString;\n\t\t\t\t\tif (dataURI.split(',')[0].indexOf('base64') >= 0)\n\t\t\t\t\t{\n\t\t\t\t\t\tbyteString = atob(dataURI.split(',')[1]);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tbyteString = unescape(dataURI.split(',')[1]);\n\t\t\t\t\t}\n\n\t\t\t\t\tvar mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];\n\n\t\t\t\t\tvar ia = new Uint8Array(byteString.length);\n\t\t\t\t\tfor (var i = 0; i < byteString.length; i++)\n\t\t\t\t\t{\n\t\t\t\t\t\tia[i] = byteString.charCodeAt(i);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn new Blob([ia], { type:mimeString });\n\t\t\t\t},\n\t\t\t\tgetOuterHtml: function(el)\n\t\t\t\t{\n\t\t\t\t\treturn $('<div>').append($(el).eq(0).clone()).html();\n\t\t\t\t},\n\t\t\t\tcloneAttributes: function(from, to)\n\t\t\t\t{\n\t\t\t\t\tfrom = from[0] || from;\n\t\t\t\t\tto = $(to);\n\n\t\t\t\t\tvar attrs = from.attributes;\n\t\t\t\t\tvar len = attrs.length;\n\t\t\t\t\twhile (len--)\n\t\t\t\t\t{\n\t\t\t\t\t    var attr = attrs[len];\n\t\t\t\t\t    to.attr(attr.name, attr.value);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn to;\n\t\t\t\t},\n\t\t\t\tbreakBlockTag: function()\n\t\t\t\t{\n\t\t\t\t\tvar block = this.selection.block();\n\t\t\t\t\tif (!block)\n\t\t\t\t\t{\n    \t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar isEmpty = this.utils.isEmpty(block.innerHTML);\n\n\t\t\t\t\tvar tag = block.tagName.toLowerCase();\n\t\t\t\t\tif (tag === 'pre' || tag === 'li' || tag === 'td' || tag === 'th')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\n\t\t\t\t\tif (!isEmpty && this.utils.isStartOfElement(block))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn { $block: $(block), $next: $(block).next(), type: 'start' };\n\t\t\t\t\t}\n\t\t\t\t\telse if (!isEmpty && this.utils.isEndOfElement(block))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn { $block: $(block), $next: $(block).next(), type: 'end' };\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tvar endOfNode = this.selection.extractEndOfNode(block);\n\t\t\t\t\t\tvar $nextPart = $('<' + tag + ' />').append(endOfNode);\n\n\t\t\t\t\t\t$nextPart = this.utils.cloneAttributes(block, $nextPart);\n\t\t\t\t\t\t$(block).after($nextPart);\n\n\t\t\t\t\t\treturn { $block: $(block), $next: $nextPart, type: 'break' };\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\t// tag detection\n\t\t\t\tinBlocks: function(tags)\n\t\t\t\t{\n\t\t\t\t\ttags = ($.isArray(tags)) ? tags : [tags];\n\n\t\t\t\t\tvar blocks = this.selection.blocks();\n\t\t\t\t\tvar len = blocks.length;\n\t\t\t\t\tvar contains = false;\n\t\t\t\t\tfor (var i = 0; i < len; i++)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (blocks[i] !== false)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvar tag = blocks[i].tagName.toLowerCase();\n\n\t\t\t\t\t\t\tif ($.inArray(tag, tags) !== -1)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tcontains = true;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\treturn contains;\n\n\t\t\t\t},\n\t\t\t\tinInlines: function(tags)\n\t\t\t\t{\n\t\t\t\t\ttags = ($.isArray(tags)) ? tags : [tags];\n\n\t\t\t\t\tvar inlines = this.selection.inlines();\n\t\t\t\t\tvar len = inlines.length;\n\t\t\t\t\tvar contains = false;\n\t\t\t\t\tfor (var i = 0; i < len; i++)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar tag = inlines[i].tagName.toLowerCase();\n\n\t\t\t\t\t\tif ($.inArray(tag, tags) !== -1)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tcontains = true;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\treturn contains;\n\n\t\t\t\t},\n\t\t\t\tisTag: function(current, tag)\n\t\t\t\t{\n\t\t\t\t\tvar element = $(current).closest(tag, this.core.editor()[0]);\n\t\t\t\t\tif (element.length === 1)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn element[0];\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\t\t\t\tisBlock: function(block)\n\t\t\t\t{\n\t\t\t\t\tif (block === null)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tblock = block[0] || block;\n\n\t\t\t\t\treturn block && this.utils.isBlockTag(block.tagName);\n\t\t\t\t},\n\t\t\t\tisBlockTag: function(tag)\n\t\t\t\t{\n\t\t\t\t\treturn (typeof tag === 'undefined') ? false : this.reIsBlock.test(tag);\n\t\t\t\t},\n\t\t\t\tisInline: function(inline)\n\t\t\t\t{\n\t\t\t\t\tinline = inline[0] || inline;\n\n\t\t\t\t\treturn inline && this.utils.isInlineTag(inline.tagName);\n\t\t\t\t},\n\t\t\t\tisInlineTag: function(tag)\n\t\t\t\t{\n\t\t\t\t\treturn (typeof tag === 'undefined') ? false : this.reIsInline.test(tag);\n\t\t\t\t},\n\t\t\t\t// parents detection\n\t\t\t\tisRedactorParent: function(el)\n\t\t\t\t{\n\t\t\t\t\tif (!el)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\tif ($(el).parents('.redactor-in').length === 0 || $(el).hasClass('redactor-in'))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn el;\n\t\t\t\t},\n\t\t\t\tisCurrentOrParentHeader: function()\n\t\t\t\t{\n\t\t\t\t\treturn this.utils.isCurrentOrParent(['H1', 'H2', 'H3', 'H4', 'H5', 'H6']);\n\t\t\t\t},\n\t\t\t\tisCurrentOrParent: function(tagName)\n\t\t\t\t{\n\t\t\t\t\tvar parent = this.selection.parent();\n\t\t\t\t\tvar current = this.selection.current();\n\n\t\t\t\t\tif ($.isArray(tagName))\n\t\t\t\t\t{\n\t\t\t\t\t\tvar matched = 0;\n\t\t\t\t\t\t$.each(tagName, $.proxy(function(i, s)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tif (this.utils.isCurrentOrParentOne(current, parent, s))\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tmatched++;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}, this));\n\n\t\t\t\t\t\treturn (matched === 0) ? false : true;\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\treturn this.utils.isCurrentOrParentOne(current, parent, tagName);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tisCurrentOrParentOne: function(current, parent, tagName)\n\t\t\t\t{\n\t\t\t\t\ttagName = tagName.toUpperCase();\n\n\t\t\t\t\treturn parent && parent.tagName === tagName ? parent : current && current.tagName === tagName ? current : false;\n\t\t\t\t},\n\t\t\t\tisEditorRelative: function()\n\t\t\t\t{\n\t\t\t\t\tvar position = this.core.editor().css('position');\n\t\t\t\t\tvar arr = ['absolute', 'fixed', 'relative'];\n\n\t\t\t\t\treturn ($.inArray(arr, position) !== -1);\n\t\t\t\t},\n\t\t\t\tsetEditorRelative: function()\n\t\t\t\t{\n\t\t\t\t\tthis.core.editor().addClass('redactor-relative');\n\t\t\t\t},\n\t\t\t\t// scroll\n\t\t\t\tfreezeScroll: function()\n\t\t\t\t{\n\t\t\t\t\tthis.freezeScrollTop = $(document).scrollTop();\n\t\t\t\t\t$(document).scrollTop(this.freezeScrollTop);\n\t\t\t\t},\n\t\t\t\tunfreezeScroll: function()\n\t\t\t\t{\n\t\t\t\t\tif (typeof this.freezeScrollTop === 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\t$(document).scrollTop(this.freezeScrollTop);\n\t\t\t\t},\n\t\t\t\tsaveScroll: function()\n\t\t\t\t{\n\t\t\t\t\tthis.tmpScrollTop = $(document).scrollTop();\n\t\t\t\t},\n\t\t\t\trestoreScroll: function()\n\t\t\t\t{\n\t\t\t\t\tif (typeof this.tmpScrollTop === 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\t$(document).scrollTop(this.tmpScrollTop);\n\t\t\t\t},\n\t\t\t\tisStartOfElement: function(element)\n\t\t\t\t{\n\t\t\t\t\tif (typeof element === 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\telement = this.selection.block();\n\t\t\t\t\t\tif (!element)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\treturn (this.offset.get(element) === 0) ? true : false;\n\t\t\t\t},\n\t\t\t\tisEndOfElement: function(element)\n\t\t\t\t{\n\t\t\t\t\tif (typeof element === 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\telement = this.selection.block();\n\t\t\t\t\t\tif (!element)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tvar text = $.trim($(element).text()).replace(/[\\t\\n\\r\\n]/g, '').replace(/\\u200B/g, '');\n\t\t\t\t\tvar offset = this.offset.get(element);\n\n\t\t\t\t\treturn (offset === text.length) ? true : false;\n\t\t\t\t},\n\t\t\t\tremoveEmptyAttr: function(el, attr)\n\t\t\t\t{\n\t\t\t\t\tvar $el = $(el);\n\t\t\t\t\tif (typeof $el.attr(attr) === 'undefined')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\n\t\t\t\t\tif ($el.attr(attr) === '')\n\t\t\t\t\t{\n\t\t\t\t\t\t$el.removeAttr(attr);\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\t\t\t\treplaceToTag: function(node, tag)\n\t\t\t\t{\n\t\t\t\t\tvar replacement;\n\t\t\t\t\t$(node).replaceWith(function()\n\t\t\t\t\t{\n\t\t\t\t\t\treplacement = $('<' + tag + ' />').append($(this).contents());\n\n\t\t\t\t\t\tfor (var i = 0; i < this.attributes.length; i++)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treplacement.attr(this.attributes[i].name, this.attributes[i].value);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn replacement;\n\t\t\t\t\t});\n\n\t\t\t\t\treturn replacement;\n\t\t\t\t},\n\t\t\t\t// select all\n\t\t\t\tisSelectAll: function()\n\t\t\t\t{\n\t\t\t\t\treturn this.selectAll;\n\t\t\t\t},\n\t\t\t\tenableSelectAll: function()\n\t\t\t\t{\n\t\t\t\t\tthis.selectAll = true;\n\t\t\t\t},\n\t\t\t\tdisableSelectAll: function()\n\t\t\t\t{\n\t\t\t\t\tthis.selectAll = false;\n\t\t\t\t},\n\t\t\t\tdisableBodyScroll: function()\n\t\t\t\t{\n\t\t\t\t\tvar $body = $('html');\n\t\t\t\t\tvar windowWidth = window.innerWidth;\n\t\t\t\t\tif (!windowWidth)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar documentElementRect = document.documentElement.getBoundingClientRect();\n\t\t\t\t\t\twindowWidth = documentElementRect.right - Math.abs(documentElementRect.left);\n\t\t\t\t\t}\n\n\t\t\t\t\tvar isOverflowing = document.body.clientWidth < windowWidth;\n\t\t\t\t\tvar scrollbarWidth = this.utils.measureScrollbar();\n\n\t\t\t\t\t$body.css('overflow', 'hidden');\n\t\t\t\t\tif (isOverflowing)\n\t\t\t\t\t{\n\t\t\t\t\t\t$body.css('padding-right', scrollbarWidth);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tmeasureScrollbar: function()\n\t\t\t\t{\n\t\t\t\t\tvar $body = $('body');\n\t\t\t\t\tvar scrollDiv = document.createElement('div');\n\t\t\t\t\tscrollDiv.className = 'redactor-scrollbar-measure';\n\n\t\t\t\t\t$body.append(scrollDiv);\n\t\t\t\t\tvar scrollbarWidth = scrollDiv.offsetWidth - scrollDiv.clientWidth;\n\t\t\t\t\t$body[0].removeChild(scrollDiv);\n\t\t\t\t\treturn scrollbarWidth;\n\t\t\t\t},\n\t\t\t\tenableBodyScroll: function()\n\t\t\t\t{\n\t\t\t\t\t$('html').css({ 'overflow': '', 'padding-right': '' });\n\t\t\t\t\t$('body').remove('redactor-scrollbar-measure');\n\t\t\t\t},\n\t\t\t\tappendFields: function(appendFields, data)\n\t\t\t\t{\n\t\t\t\t\tif (!appendFields)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn data;\n\t\t\t\t\t}\n\t\t\t\t\telse if (typeof appendFields === 'object')\n\t\t\t\t\t{\n    \t\t\t\t\t$.each(appendFields, function(k, v)\n    \t\t\t\t\t{\n    \t\t\t\t\t\tif (v !== null && v.toString().indexOf('#') === 0)\n    \t\t\t\t\t\t{\n        \t\t\t\t\t\tv = $(v).val();\n                            }\n\n    \t\t\t\t\t\tdata.append(k, v);\n\n    \t\t\t\t\t});\n\n    \t\t\t\t\treturn data;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar $fields = $(appendFields);\n\t\t\t\t\tif ($fields.length === 0)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn data;\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tvar str = '';\n\t\t\t\t\t\t$fields.each(function()\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tdata.append($(this).attr('name'), $(this).val());\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\treturn data;\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tappendForms: function(appendForms, data)\n\t\t\t\t{\n\t\t\t\t\tif (!appendForms)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn data;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar $forms = $(appendForms);\n\t\t\t\t\tif ($forms.length === 0)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn data;\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tvar formData = $forms.serializeArray();\n\n\t\t\t\t\t\t$.each(formData, function(z,f)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tdata.append(f.name, f.value);\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\treturn data;\n\t\t\t\t\t}\n\t\t\t\t},\n\n\t\t\t\t// #backward\n\t\t\t\tisCollapsed: function()\n\t\t\t\t{\n\t\t\t\t\treturn this.selection.isCollapsed();\n\t\t\t\t},\n\t\t\t\tisMobile: function()\n\t\t\t\t{\n\t\t\t\t\treturn this.detect.isMobile();\n\t\t\t\t},\n\t\t\t\tisDesktop: function()\n\t\t\t\t{\n\t\t\t\t\treturn this.detect.isDesktop();\n\t\t\t\t},\n\t\t\t\tisPad: function()\n\t\t\t\t{\n\t\t\t\t\treturn this.detect.isIpad();\n\t\t\t\t}\n\n\t\t\t};\n\t\t},\n\n\t\t// #backward\n\t\tbrowser: function()\n\t\t{\n\t\t\treturn {\n\t\t\t\twebkit: function()\n\t\t\t\t{\n\t\t\t\t\treturn this.detect.isWebkit();\n\t\t\t\t},\n\t\t\t\tff: function()\n\t\t\t\t{\n\t\t\t\t\treturn this.detect.isFirefox();\n\t\t\t\t},\n\t\t\t\tie: function()\n\t\t\t\t{\n\t\t\t\t\treturn this.detect.isIe();\n\t\t\t\t}\n\t\t\t};\n\t\t}\n\t};\n\n\t$(window).on('load.tools.redactor', function()\n\t{\n\t\t$('[data-tools=\"redactor\"]').redactor();\n\t});\n\n\t// constructor\n\tRedactor.prototype.init.prototype = Redactor.prototype;\n\n})(jQuery);\n\n(function($)\n{\n\t$.fn.redactorAnimation = function(animation, options, callback)\n\t{\n\t\treturn this.each(function()\n\t\t{\n\t\t\tnew redactorAnimation(this, animation, options, callback);\n\t\t});\n\t};\n\n\tfunction redactorAnimation(element, animation, options, callback)\n\t{\n\t\t// default\n\t\tvar opts = {\n\t\t\tduration: 0.5,\n\t\t\titerate: 1,\n\t\t\tdelay: 0,\n\t\t\tprefix: 'redactor-',\n\t\t\ttiming: 'linear'\n\t\t};\n\n\t\tthis.animation = animation;\n\t\tthis.slide = (this.animation === 'slideDown' || this.animation === 'slideUp');\n\t\tthis.$element = $(element);\n\t\tthis.prefixes = ['', '-moz-', '-o-animation-', '-webkit-'];\n\t\tthis.queue = [];\n\n\t\t// options or callback\n\t\tif (typeof options === 'function')\n\t\t{\n\t\t\tcallback = options;\n\t\t\tthis.opts = opts;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.opts = $.extend(opts, options);\n\t\t}\n\n\t\t// slide\n\t\tif (this.slide)\n\t\t{\n\t\t\tthis.$element.height(this.$element.height());\n\t\t}\n\n\t\t// init\n\t\tthis.init(callback);\n\n\t}\n\n\tredactorAnimation.prototype = {\n\n\t\tinit: function(callback)\n\t\t{\n\t\t\tthis.queue.push(this.animation);\n\n\t\t\tthis.clean();\n\n\t\t\tif (this.animation === 'show')\n\t\t\t{\n\t\t\t\tthis.opts.timing = 'linear';\n\t\t\t\tthis.$element.removeClass('hide').show();\n\n\t\t\t\tif (typeof callback === 'function')\n\t\t\t\t{\n\t\t\t\t\tcallback(this);\n\t\t\t\t}\n\t\t\t}\n\t\t\telse if (this.animation === 'hide')\n\t\t\t{\n\t\t\t\tthis.opts.timing = 'linear';\n\t\t\t\tthis.$element.hide();\n\n\t\t\t\tif (typeof callback === 'function')\n\t\t\t\t{\n\t\t\t\t\tcallback(this);\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.animate(callback);\n\t\t\t}\n\n\t\t},\n\t\tanimate: function(callback)\n\t\t{\n\t\t\tthis.$element.addClass('animated').css('display', '').removeClass('hide');\n\t\t\tthis.$element.addClass(this.opts.prefix + this.queue[0]);\n\n\t\t\tthis.set(this.opts.duration + 's', this.opts.delay + 's', this.opts.iterate, this.opts.timing);\n\n\t\t\tvar _callback = (this.queue.length > 1) ? null : callback;\n\t\t\tthis.complete('AnimationEnd', $.proxy(function()\n\t\t\t{\n\t\t\t\tif (this.$element.hasClass(this.opts.prefix + this.queue[0]))\n\t\t\t\t{\n\t\t\t\t\tthis.clean();\n\t\t\t\t\tthis.queue.shift();\n\n\t\t\t\t\tif (this.queue.length)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.animate(callback);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t}, this), _callback);\n\t\t},\n\t\tset: function(duration, delay, iterate, timing)\n\t\t{\n\t\t\tvar len = this.prefixes.length;\n\n\t\t\twhile (len--)\n\t\t\t{\n\t\t\t\tthis.$element.css(this.prefixes[len] + 'animation-duration', duration);\n\t\t\t\tthis.$element.css(this.prefixes[len] + 'animation-delay', delay);\n\t\t\t\tthis.$element.css(this.prefixes[len] + 'animation-iteration-count', iterate);\n\t\t\t\tthis.$element.css(this.prefixes[len] + 'animation-timing-function', timing);\n\t\t\t}\n\n\t\t},\n\t\tclean: function()\n\t\t{\n\t\t\tthis.$element.removeClass('animated');\n\t\t\tthis.$element.removeClass(this.opts.prefix + this.queue[0]);\n\n\t\t\tthis.set('', '', '', '');\n\n\t\t},\n\t\tcomplete: function(type, make, callback)\n\t\t{\n\t\t\tthis.$element.one(type.toLowerCase() + ' webkit' + type + ' o' + type + ' MS' + type, $.proxy(function()\n\t\t\t{\n\t\t\t\tif (typeof make === 'function')\n\t\t\t\t{\n\t\t\t\t\tmake();\n\t\t\t\t}\n\n\t\t\t\tif (typeof callback === 'function')\n\t\t\t\t{\n\t\t\t\t\tcallback(this);\n\t\t\t\t}\n\n\t\t\t\t// hide\n\t\t\t\tvar effects = ['fadeOut', 'slideUp', 'zoomOut', 'slideOutUp', 'slideOutRight', 'slideOutLeft'];\n\t\t\t\tif ($.inArray(this.animation, effects) !== -1)\n\t\t\t\t{\n\t\t\t\t\tthis.$element.css('display', 'none');\n\t\t\t\t}\n\n\t\t\t\t// slide\n\t\t\t\tif (this.slide)\n\t\t\t\t{\n\t\t\t\t\tthis.$element.css('height', '');\n\t\t\t\t}\n\n\t\t\t}, this));\n\n\t\t}\n\t};\n\n})(jQuery);\n(function($)\n{\n\t$.Redactor.prototype.source = function()\n\t{\n\t\treturn {\n\t\t\tinit: function()\n\t\t\t{\n\t\t\t\tvar button = this.button.addFirst('html', 'HTML');\n\t\t\t\tthis.button.addCallback(button, this.source.toggle);\n\n\t\t\t\tvar style = {\n\t\t\t\t\t'width': '100%',\n\t\t\t\t\t'margin': '0',\n\t\t\t\t\t'background': '#111',\n\t\t\t\t\t'box-sizing': 'border-box',\n\t\t\t\t\t'color': 'rgba(255, 255, 255, .8)',\n\t\t\t\t\t'font-size': '14px',\n\t\t\t\t\t'outline': 'none',\n\t\t\t\t\t'padding': '16px',\n\t\t\t\t\t'line-height': '22px',\n\t\t\t\t\t'font-family': 'Menlo, Monaco, Consolas, \"Courier New\", monospace'\n\t\t\t\t};\n\n\t\t\t\tthis.source.$textarea = $('<textarea />');\n\t\t\t\tthis.source.$textarea.css(style).hide();\n\n\t\t\t\tif (this.opts.type === 'textarea')\n\t\t\t\t{\n\t\t\t\t\tthis.core.box().append(this.source.$textarea);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tthis.core.box().after(this.source.$textarea);\n\t\t\t\t}\n\n\t\t\t\tthis.core.element().on('destroy.callback.redactor', $.proxy(function()\n\t\t\t\t{\n\t\t\t\t\tthis.source.$textarea.remove();\n\n\t\t\t\t}, this));\n\n\t\t\t},\n\t\t\ttoggle: function()\n\t\t\t{\n\t\t\t\treturn (this.source.$textarea.hasClass('open')) ? this.source.hide() : this.source.show();\n\t\t\t},\n\t\t\tsetCaretOnShow: function()\n\t\t\t{\n\t\t\t\tthis.source.offset = this.offset.get();\n\t\t\t\tvar scroll = $(window).scrollTop();\n\n\t\t\t\tvar\twidth = this.core.editor().innerWidth();\n\t\t\t\tvar height = this.core.editor().innerHeight();\n\n\t\t\t\t// caret position sync\n\t\t\t\tthis.source.start = 0;\n\t\t\t\tthis.source.end = 0;\n\t\t\t\tvar $editorDiv = $(\"<div/>\").append($.parseHTML(this.core.editor().html(), document, true));\n\t\t\t\tvar $selectionMarkers = $editorDiv.find(\"span.redactor-selection-marker\");\n\n\t\t\t\tif ($selectionMarkers.length > 0)\n\t\t\t\t{\n\t\t\t\t\tvar editorHtml = $editorDiv.html().replace(/&amp;/g, '&');\n\n\t\t\t\t\tif ($selectionMarkers.length === 1)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.source.start = this.utils.strpos(editorHtml, $editorDiv.find(\"#selection-marker-1\").prop(\"outerHTML\"));\n\t\t\t\t\t\tthis.source.end = this.source.start;\n\t\t\t\t\t}\n\t\t\t\t\telse if ($selectionMarkers.length === 2)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.source.start = this.utils.strpos(editorHtml, $editorDiv.find(\"#selection-marker-1\").prop(\"outerHTML\"));\n\t\t\t\t\t\tthis.source.end = this.utils.strpos(editorHtml, $editorDiv.find(\"#selection-marker-2\").prop(\"outerHTML\")) - $editorDiv.find(\"#selection-marker-1\").prop(\"outerHTML\").toString().length;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t},\n\t\t\tsetCaretOnHide: function(html)\n\t\t\t{\n\t\t\t    this.source.start = this.source.$textarea.get(0).selectionStart;\n\t\t\t\tthis.source.end = this.source.$textarea.get(0).selectionEnd;\n\n\t\t\t\t// if selection starts from end\n\t\t\t\tif (this.source.start > this.source.end && this.source.end > 0)\n\t\t\t\t{\n\t\t\t\t\tvar tempStart = this.source.end;\n\t\t\t\t\tvar tempEnd = this.source.start;\n\n\t\t\t\t\tthis.source.start = tempStart;\n\t\t\t\t\tthis.source.end = tempEnd;\n\t\t\t\t}\n\n\t\t\t\tthis.source.start = this.source.enlargeOffset(html, this.source.start);\n\t\t\t\tthis.source.end = this.source.enlargeOffset(html, this.source.end);\n\n\t\t\t\thtml = html.substr(0, this.source.start) + this.marker.html(1) + html.substr(this.source.start);\n\n\t\t\t\tif (this.source.end > this.source.start)\n\t\t\t\t{\n\t\t\t\t\tvar markerLength = this.marker.html(1).toString().length;\n\n\t\t\t\t\thtml = html.substr(0, this.source.end + markerLength) + this.marker.html(2) + html.substr(this.source.end + markerLength);\n\t\t\t\t}\n\n\n\t\t\t\treturn html;\n\n\t\t\t},\n\t\t\thide: function()\n\t\t\t{\n\t\t\t\tthis.source.$textarea.removeClass('open').hide();\n\t\t\t\tthis.source.$textarea.off('.redactor-source');\n\n\t\t\t\tvar code = this.source.$textarea.val();\n\n\t\t\t\tcode = this.paragraphize.load(code);\n\t\t\t\tcode = this.source.setCaretOnHide(code);\n\n\t\t\t\tthis.code.start(code);\n\t\t\t\tthis.button.enableAll();\n\t\t\t\tthis.core.editor().show().focus();\n\t\t\t\tthis.selection.restore();\n\n                this.core.callback('visual');\n\t\t\t},\n\t\t\tshow: function()\n\t\t\t{\n\t\t\t\tthis.selection.save();\n\t\t\t\tthis.source.setCaretOnShow();\n\n\t\t\t\tvar height = this.core.editor().innerHeight();\n\t\t\t\tvar code = this.code.get();\n\n                // callback\n                code = this.core.callback('source', code);\n\n\t\t\t\tthis.core.editor().hide();\n\t\t\t\tthis.button.disableAll('html');\n\t\t\t\tthis.source.$textarea.val(code).height(height).addClass('open').show();\n\t\t\t\tthis.source.$textarea.on('keyup.redactor-source', $.proxy(function()\n\t\t\t\t{\n\t\t\t\t\tif (this.opts.type === 'textarea')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.textarea().val(this.source.$textarea.val());\n\t\t\t\t\t}\n\n\t\t\t\t}, this));\n\n\t\t\t\tthis.marker.remove();\n\n\t\t\t\t$(window).scrollTop(scroll);\n\n\t\t\t\tif (this.source.$textarea[0].setSelectionRange)\n\t\t\t\t{\n\t\t\t\t\tthis.source.$textarea[0].setSelectionRange(this.source.start, this.source.end);\n\t\t\t\t}\n\n\t\t\t\tthis.source.$textarea[0].scrollTop = 0;\n\n\t\t\t\tsetTimeout($.proxy(function()\n\t\t\t\t{\n\t\t\t\t\tthis.source.$textarea.focus();\n\n\t\t\t\t}, this), 0);\n\t\t\t},\n\t\t\tenlargeOffset: function(html, offset)\n\t\t\t{\n\t\t\t\tvar htmlLength = html.length;\n\t\t\t\tvar c = 0;\n\n\t\t\t\tif (html[offset] === '>')\n\t\t\t\t{\n\t\t\t\t\tc++;\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tfor(var i = offset; i <= htmlLength; i++)\n\t\t\t\t\t{\n\t\t\t\t\t\tc++;\n\n\t\t\t\t\t\tif (html[i] === '>')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (html[i] === '<' || i === htmlLength)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tc = 0;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\treturn offset + c;\n\t\t\t}\n\t\t};\n\t};\n})(jQuery);\n(function($)\n{\n\t$.Redactor.prototype.table = function()\n\t{\n\t\treturn {\n\t\t\tlangs: {\n\t\t\t\ten: {\n\t\t\t\t\t\"table\": \"Table\",\n\t\t\t\t\t\"insert-table\": \"Insert table\",\n\t\t\t\t\t\"insert-row-above\": \"Insert row above\",\n\t\t\t\t\t\"insert-row-below\": \"Insert row below\",\n\t\t\t\t\t\"insert-column-left\": \"Insert column left\",\n\t\t\t\t\t\"insert-column-right\": \"Insert column right\",\n\t\t\t\t\t\"add-head\": \"Add head\",\n\t\t\t\t\t\"delete-head\": \"Delete head\",\n\t\t\t\t\t\"delete-column\": \"Delete column\",\n\t\t\t\t\t\"delete-row\": \"Delete row\",\n\t\t\t\t\t\"delete-table\": \"Delete table\"\n\t\t\t\t}\n\t\t\t},\n\t\t\tinit: function()\n\t\t\t{\n\t\t\t\tvar dropdown = {};\n\n\t\t\t\tdropdown.insert_table = {\n\t\t\t\t\ttitle: this.lang.get('insert-table'),\n\t\t\t\t\tfunc: this.table.insert,\n\t\t\t\t\tobserve: {\n\t\t\t\t\t\telement: 'table',\n\t\t\t\t\t\tin: {\n\t\t\t\t\t\t\tattr: {\n\t\t\t\t\t\t\t\t'class': 'redactor-dropdown-link-inactive',\n\t\t\t\t\t\t\t\t'aria-disabled': true,\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\tdropdown.insert_row_above = {\n\t\t\t\t\ttitle: this.lang.get('insert-row-above'),\n\t\t\t\t\tfunc: this.table.addRowAbove,\n\t\t\t\t\tobserve: {\n\t\t\t\t\t\telement: 'table',\n\t\t\t\t\t\tout: {\n\t\t\t\t\t\t\tattr: {\n\t\t\t\t\t\t\t\t'class': 'redactor-dropdown-link-inactive',\n\t\t\t\t\t\t\t\t'aria-disabled': true,\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\tdropdown.insert_row_below = {\n\t\t\t\t\ttitle: this.lang.get('insert-row-below'),\n\t\t\t\t\tfunc: this.table.addRowBelow,\n\t\t\t\t\tobserve: {\n\t\t\t\t\t\telement: 'table',\n\t\t\t\t\t\tout: {\n\t\t\t\t\t\t\tattr: {\n\t\t\t\t\t\t\t\t'class': 'redactor-dropdown-link-inactive',\n\t\t\t\t\t\t\t\t'aria-disabled': true,\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\tdropdown.insert_column_left = {\n\t\t\t\t\ttitle: this.lang.get('insert-column-left'),\n\t\t\t\t\tfunc: this.table.addColumnLeft,\n\t\t\t\t\tobserve: {\n\t\t\t\t\t\telement: 'table',\n\t\t\t\t\t\tout: {\n\t\t\t\t\t\t\tattr: {\n\t\t\t\t\t\t\t\t'class': 'redactor-dropdown-link-inactive',\n\t\t\t\t\t\t\t\t'aria-disabled': true,\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\tdropdown.insert_column_right = {\n\t\t\t\t\ttitle: this.lang.get('insert-column-right'),\n\t\t\t\t\tfunc: this.table.addColumnRight,\n\t\t\t\t\tobserve: {\n\t\t\t\t\t\telement: 'table',\n\t\t\t\t\t\tout: {\n\t\t\t\t\t\t\tattr: {\n\t\t\t\t\t\t\t\t'class': 'redactor-dropdown-link-inactive',\n\t\t\t\t\t\t\t\t'aria-disabled': true,\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\tdropdown.add_head = {\n\t\t\t\t\ttitle: this.lang.get('add-head'),\n\t\t\t\t\tfunc: this.table.addHead,\n\t\t\t\t\tobserve: {\n\t\t\t\t\t\telement: 'table',\n\t\t\t\t\t\tout: {\n\t\t\t\t\t\t\tattr: {\n\t\t\t\t\t\t\t\t'class': 'redactor-dropdown-link-inactive',\n\t\t\t\t\t\t\t\t'aria-disabled': true,\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\tdropdown.delete_head = {\n\t\t\t\t\ttitle: this.lang.get('delete-head'),\n\t\t\t\t\tfunc: this.table.deleteHead,\n\t\t\t\t\tobserve: {\n\t\t\t\t\t\telement: 'table',\n\t\t\t\t\t\tout: {\n\t\t\t\t\t\t\tattr: {\n\t\t\t\t\t\t\t\t'class': 'redactor-dropdown-link-inactive',\n\t\t\t\t\t\t\t\t'aria-disabled': true,\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\tdropdown.delete_column = {\n    \t\t\t\ttitle: this.lang.get('delete-column'),\n    \t\t\t\tfunc: this.table.deleteColumn,\n    \t\t\t\tobserve: {\n    \t\t\t\t\telement: 'table',\n    \t\t\t\t\tout: {\n    \t\t\t\t\t\tattr: {\n    \t\t\t\t\t\t\t'class': 'redactor-dropdown-link-inactive',\n    \t\t\t\t\t\t\t'aria-disabled': true,\n    \t\t\t\t\t\t}\n    \t\t\t\t\t}\n    \t\t\t\t}\n    \t\t\t};\n\n\t\t\t\tdropdown.delete_row = {\n\t\t\t\t\ttitle: this.lang.get('delete-row'),\n\t\t\t\t\tfunc: this.table.deleteRow,\n\t\t\t\t\tobserve: {\n\t\t\t\t\t\telement: 'table',\n\t\t\t\t\t\tout: {\n\t\t\t\t\t\t\tattr: {\n\t\t\t\t\t\t\t\t'class': 'redactor-dropdown-link-inactive',\n\t\t\t\t\t\t\t\t'aria-disabled': true,\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\tdropdown.delete_table = {\n\t\t\t\t\ttitle: this.lang.get('delete-table'),\n\t\t\t\t\tfunc: this.table.deleteTable,\n\t\t\t\t\tobserve: {\n\t\t\t\t\t\telement: 'table',\n\t\t\t\t\t\tout: {\n\t\t\t\t\t\t\tattr: {\n\t\t\t\t\t\t\t\t'class': 'redactor-dropdown-link-inactive',\n\t\t\t\t\t\t\t\t'aria-disabled': true,\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t};\n\n\n\t\t\t\tvar button = this.button.addBefore('link', 'table', this.lang.get('table'));\n\t\t\t\tthis.button.addDropdown(button, dropdown);\n\t\t\t},\n\t\t\tinsert: function()\n\t\t\t{\n\t\t\t\tif (this.table.getTable())\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthis.placeholder.hide();\n\n\t\t\t\tvar rows = 2;\n\t\t\t\tvar columns = 3;\n\t\t\t\tvar $tableBox = $('<div>');\n\t\t\t\tvar $table = $('<table />');\n\n\n\t\t\t\tfor (var i = 0; i < rows; i++)\n\t\t\t\t{\n\t\t\t\t\tvar $row = $('<tr>');\n\n\t\t\t\t\tfor (var z = 0; z < columns; z++)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar $column = $('<td>' + this.opts.invisibleSpace + '</td>');\n\n\t\t\t\t\t\t// set the focus to the first td\n\t\t\t\t\t\tif (i === 0 && z === 0)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$column.append(this.marker.get());\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t$($row).append($column);\n\t\t\t\t\t}\n\n\t\t\t\t\t$table.append($row);\n\t\t\t\t}\n\n\t\t\t\t$tableBox.append($table);\n\t\t\t\tvar html = $tableBox.html();\n\n\t\t\t\tthis.buffer.set();\n\n\t\t\t\tvar current = this.selection.current();\n\t\t\t\tif ($(current).closest('li', this.core.editor()[0]).length !== 0)\n\t\t\t\t{\n\t\t\t\t\t$(current).closest('ul, ol').first().after(html);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tthis.air.collapsed();\n\t\t\t\t\tthis.insert.html(html);\n\t\t\t\t}\n\n\t\t\t\tthis.selection.restore();\n\t\t\t\tthis.core.callback('insertedTable', $table);\n\t\t\t},\n\t\t\tgetTable: function()\n\t\t\t{\n\t\t\t\tvar $table = $(this.selection.current()).closest('table');\n\n\t\t\t\tif (!this.utils.isRedactorParent($table))\n\t\t\t\t{\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\tif ($table.size() === 0)\n\t\t\t\t{\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\treturn $table;\n\t\t\t},\n\t\t\trestoreAfterDelete: function($table)\n\t\t\t{\n\t\t\t\tthis.selection.restore();\n\t\t\t\t$table.find('span.redactor-selection-marker').remove();\n\n\t\t\t},\n\t\t\tdeleteTable: function()\n\t\t\t{\n\t\t\t\tvar $table = this.table.getTable();\n\t\t\t\tif (!$table)\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthis.buffer.set();\n\n\n\t\t\t\tvar $next = $table.next();\n\t\t\t\tif (!this.opts.linebreaks && $next.length !== 0)\n\t\t\t\t{\n\t\t\t\t\tthis.caret.start($next);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tthis.caret.after($table);\n\t\t\t\t}\n\n\n\t\t\t\t$table.remove();\n\n\n\t\t\t},\n\t\t\tdeleteRow: function()\n\t\t\t{\n\t\t\t\tvar $table = this.table.getTable();\n\t\t\t\tif (!$table)\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tvar $current = $(this.selection.current());\n\n\t\t\t\tthis.buffer.set();\n\n\t\t\t\tvar $current_tr = $current.closest('tr');\n\t\t\t\tvar $focus_tr = $current_tr.prev().length ? $current_tr.prev() : $current_tr.next();\n\t\t\t\tif ($focus_tr.length)\n\t\t\t\t{\n\t\t\t\t\tvar $focus_td = $focus_tr.children('td, th').first();\n\t\t\t\t\tif ($focus_td.length)\n\t\t\t\t\t{\n\t\t\t\t\t\t$focus_td.prepend(this.marker.get());\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t$current_tr.remove();\n\t\t\t\tthis.table.restoreAfterDelete($table);\n\t\t\t},\n\t\t\tdeleteColumn: function()\n\t\t\t{\n\t\t\t\tvar $table = this.table.getTable();\n\t\t\t\tif (!$table)\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthis.buffer.set();\n\n\t\t\t\tvar $current = $(this.selection.current());\n\t\t\t\tvar $current_td = $current.closest('td, th');\n\t\t\t\tvar index = $current_td[0].cellIndex;\n\n\t\t\t\t$table.find('tr').each($.proxy(function(i, elem)\n\t\t\t\t{\n\t\t\t\t\tvar $elem = $(elem);\n\t\t\t\t\tvar focusIndex = index - 1 < 0 ? index + 1 : index - 1;\n\t\t\t\t\tif (i === 0)\n\t\t\t\t\t{\n\t\t\t\t\t\t$elem.find('td, th').eq(focusIndex).prepend(this.marker.get());\n\t\t\t\t\t}\n\n\t\t\t\t\t$elem.find('td, th').eq(index).remove();\n\n\t\t\t\t}, this));\n\n\t\t\t\tthis.table.restoreAfterDelete($table);\n\t\t\t},\n\t\t\taddHead: function()\n\t\t\t{\n\t\t\t\tvar $table = this.table.getTable();\n\t\t\t\tif (!$table)\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthis.buffer.set();\n\n\t\t\t\tif ($table.find('thead').size() !== 0)\n\t\t\t\t{\n\t\t\t\t\tthis.table.deleteHead();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tvar tr = $table.find('tr').first().clone();\n\t\t\t\ttr.find('td').replaceWith($.proxy(function()\n\t\t\t\t{\n\t\t\t\t\treturn $('<th>').html(this.opts.invisibleSpace);\n\t\t\t\t}, this));\n\n\t\t\t\t$thead = $('<thead></thead>').append(tr);\n\t\t\t\t$table.prepend($thead);\n\n\n\n\t\t\t},\n\t\t\tdeleteHead: function()\n\t\t\t{\n\t\t\t\tvar $table = this.table.getTable();\n\t\t\t\tif (!$table)\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tvar $thead = $table.find('thead');\n\t\t\t\tif ($thead.size() === 0)\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthis.buffer.set();\n\n\t\t\t\t$thead.remove();\n\n\t\t\t},\n\t\t\taddRowAbove: function()\n\t\t\t{\n\t\t\t\tthis.table.addRow('before');\n\t\t\t},\n\t\t\taddRowBelow: function()\n\t\t\t{\n\t\t\t\tthis.table.addRow('after');\n\t\t\t},\n\t\t\taddColumnLeft: function()\n\t\t\t{\n\t\t\t\tthis.table.addColumn('before');\n\t\t\t},\n\t\t\taddColumnRight: function()\n\t\t\t{\n\t\t\t\tthis.table.addColumn('after');\n\t\t\t},\n\t\t\taddRow: function(type)\n\t\t\t{\n\t\t\t\tvar $table = this.table.getTable();\n\t\t\t\tif (!$table)\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthis.buffer.set();\n\n\t\t\t\tvar $current = $(this.selection.current());\n\t\t\t\tvar $current_tr = $current.closest('tr');\n\t\t\t\tvar new_tr = $current_tr.clone();\n\n\t\t\t\tnew_tr.find('th').replaceWith(function()\n\t\t\t\t{\n\t\t\t\t\tvar $td = $('<td>');\n\t\t\t\t\t$td[0].attributes = this.attributes;\n\n\t\t\t\t\treturn $td.append($(this).contents());\n\t\t\t\t});\n\n\t\t\t\tnew_tr.find('td').html(this.opts.invisibleSpace);\n\n\t\t\t\tif (type === 'after')\n\t\t\t\t{\n\t\t\t\t\t$current_tr.after(new_tr);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t$current_tr.before(new_tr);\n\t\t\t\t}\n\n\n\t\t\t},\n\t\t\taddColumn: function (type)\n\t\t\t{\n\t\t\t\tvar $table = this.table.getTable();\n\t\t\t\tif (!$table)\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tvar index = 0;\n\t\t\t\tvar current = $(this.selection.current());\n\n\t\t\t\tthis.buffer.set();\n\n\t\t\t\tvar $current_tr = current.closest('tr');\n\t\t\t\tvar $current_td = current.closest('td, th');\n\n\t\t\t\t$current_tr.find('td, th').each($.proxy(function(i, elem)\n\t\t\t\t{\n\t\t\t\t\tif ($(elem)[0] === $current_td[0])\n\t\t\t\t\t{\n\t\t\t\t\t\tindex = i;\n\t\t\t\t\t}\n\n\t\t\t\t}, this));\n\n\t\t\t\t$table.find('tr').each($.proxy(function(i, elem)\n\t\t\t\t{\n\t\t\t\t\tvar $current = $(elem).find('td, th').eq(index);\n\n\t\t\t\t\tvar td = $current.clone();\n\t\t\t\t\ttd.html(this.opts.invisibleSpace);\n\n\t\t\t\t\tif (type === 'after')\n\t\t\t\t\t{\n\t\t\t\t\t\t$current.after(td);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\t$current.before(td);\n\t\t\t\t\t}\n\n\t\t\t\t}, this));\n\n\n\t\t\t}\n\t\t};\n\t};\n})(jQuery);\n//# sourceMappingURL=all.js.map\n","(function($)\n{\n\t$.Redactor.prototype.codemirror = function()\n\t{\n\t\treturn {\n\t\t\tinit: function()\n\t\t\t{\n\t\t\t\tvar button = this.button.addFirst('html', 'HTML');\n\t\t\t\tthis.button.addCallback(button, this.codemirror.toggle);\n\n\t\t\t\tthis.codemirror.$textarea = $('<textarea />');\n\t\t\t\tthis.codemirror.$textarea.hide();\n\n\t\t\t\tif (this.opts.type === 'textarea')\n\t\t\t\t{\n\t\t\t\t\tthis.core.box().append(this.codemirror.$textarea);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tthis.core.box().after(this.codemirror.$textarea);\n\t\t\t\t}\n\n\t\t\t\tthis.core.element().on('destroy.callback.redactor', $.proxy(function()\n\t\t\t\t{\n\t\t\t\t\tthis.codemirror.$textarea.remove();\n\n\t\t\t\t}, this));\n\n\t\t\t\tvar settings = (typeof this.opts.codemirror !== 'undefined') ? this.opts.codemirror : { lineNumbers: true };\n\t\t\t\tthis.codemirror.editor = CodeMirror.fromTextArea(this.codemirror.$textarea[0], settings);\n\n\t\t\t\tthis.codemirror.$textarea.next('.CodeMirror').hide();\n\n\t\t\t},\n\t\t\ttoggle: function()\n\t\t\t{\n\t\t\t\treturn (this.codemirror.$textarea.hasClass('open')) ? this.codemirror.hide() : this.codemirror.show();\n\t\t\t},\n\t\t\tsetCaretOnShow: function()\n\t\t\t{\n\t\t\t\tthis.codemirror.offset = this.offset.get();\n\t\t\t\tvar scroll = $(window).scrollTop();\n\n\t\t\t\tvar\twidth = this.core.editor().innerWidth();\n\t\t\t\tvar height = this.core.editor().innerHeight();\n\n\t\t\t\t// caret position sync\n\t\t\t\tthis.codemirror.start = 0;\n\t\t\t\tthis.codemirror.end = 0;\n\t\t\t\tvar $editorDiv = $(\"<div/>\").append($.parseHTML(this.core.editor().html(), document, true));\n\t\t\t\tvar $selectionMarkers = $editorDiv.find(\".redactor-selection-marker\");\n\n\t\t\t\tif ($selectionMarkers.length > 0)\n\t\t\t\t{\n\t\t\t\t\tvar editorHtml = $editorDiv.html().replace(/&amp;/g, '&');\n\n\t\t\t\t\tif ($selectionMarkers.length === 1)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.codemirror.start = this.utils.strpos(editorHtml, $editorDiv.find(\"#selection-marker-1\").prop(\"outerHTML\"));\n\t\t\t\t\t\tthis.codemirror.end = this.codemirror.start;\n\t\t\t\t\t}\n\t\t\t\t\telse if ($selectionMarkers.length === 2)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.codemirror.start = this.utils.strpos(editorHtml, $editorDiv.find(\"#selection-marker-1\").prop(\"outerHTML\"));\n\t\t\t\t\t\tthis.codemirror.end = this.utils.strpos(editorHtml, $editorDiv.find(\"#selection-marker-2\").prop(\"outerHTML\")) - $editorDiv.find(\"#selection-marker-1\").prop(\"outerHTML\").toString().length;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t},\n\t\t\tsetCaretOnHide: function()\n\t\t\t{\n\t\t\t\tthis.codemirror.start = 0;\n\t\t\t\tthis.codemirror.end = 0;\n\n\t\t\t\tvar self = this;\n\t\t\t\tvar html = '';\n\t\t\t\tthis.codemirror.$textarea.next('.CodeMirror').each(function(i, el)\n\t\t\t\t{\n\t\t\t\t\tself.codemirror.selection = el.CodeMirror.listSelections();\n\n\t\t\t\t\tself.codemirror.start = el.CodeMirror.indexFromPos(self.codemirror.selection[0].anchor);\n\t\t\t\t\tself.codemirror.end = el.CodeMirror.indexFromPos(self.codemirror.selection[0].head);\n\n\t\t\t\t\thtml = el.CodeMirror.getValue();\n\t\t\t\t});\n\n\n\t\t\t\t// if selection starts from end\n\t\t\t\tif (this.codemirror.start > this.codemirror.end && this.codemirror.end > 0)\n\t\t\t\t{\n\t\t\t\t\tvar tempStart = this.codemirror.end;\n\t\t\t\t\tvar tempEnd = this.codemirror.start;\n\n\t\t\t\t\tthis.codemirror.start = tempStart;\n\t\t\t\t\tthis.codemirror.end = tempEnd;\n\t\t\t\t}\n\n\t\t\t\tthis.codemirror.start = this.codemirror.enlargeOffset(html, this.codemirror.start);\n\t\t\t\tthis.codemirror.end = this.codemirror.enlargeOffset(html, this.codemirror.end);\n\n\t\t\t\thtml = html.substr(0, this.codemirror.start) + this.marker.html(1)  + html.substr(this.codemirror.start);\n\n\t\t\t\tif (this.codemirror.end > this.codemirror.start)\n\t\t\t\t{\n\t\t\t\t\tvar markerLength = this.marker.html(1).toString().length;\n\n\t\t\t\t\thtml = html.substr(0, this.codemirror.end + markerLength) + this.marker.html(2) + html.substr(this.codemirror.end + markerLength);\n\t\t\t\t}\n\n\t\t\t\treturn html;\n\n\t\t\t},\n\t\t\thide: function()\n\t\t\t{\n\t\t\t\tvar code;\n\t\t\t\tthis.codemirror.$textarea.removeClass('open').next('.CodeMirror').hide();\n\t\t\t\tthis.codemirror.$textarea.next('.CodeMirror').off('.redactor-codemirror');\n\n\t\t\t\tcode = this.codemirror.setCaretOnHide(code);\n\t\t\t\tcode = this.paragraphize.load(code);\n\n\t\t\t\tthis.code.start(code);\n\t\t\t\tthis.button.enableAll();\n\t\t\t\tthis.core.editor().show().focus();\n\t\t\t\tthis.selection.restore();\n\n                this.core.callback('visual');\n\t\t\t},\n\t\t\tshow: function()\n\t\t\t{\n\t\t\t\tthis.selection.save();\n\t\t\t\tthis.codemirror.setCaretOnShow();\n\n\t\t\t\tvar height = this.core.editor().innerHeight();\n\t\t\t\tvar code = this.code.get();\n\n                // callback\n                code = this.core.callback('source', code);\n\n\t\t\t\tthis.core.editor().hide();\n\t\t\t\tthis.button.disableAll('html');\n\t\t\t\tthis.marker.remove();\n\n\t\t\t\tthis.codemirror.$textarea.val(code).height(height).addClass('open');\n\t\t\t\tthis.codemirror.$textarea.next('.CodeMirror').on('keyup.redactor-codemirror', $.proxy(function()\n\t\t\t\t{\n\t\t\t\t\tif (this.opts.type === 'textarea')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.codemirror.$textarea.next('.CodeMirror').each($.proxy(function(i, el)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.core.textarea().val(el.CodeMirror.getValue());\n\n\t\t\t\t\t\t}, this));\n\t\t\t\t\t}\n\n\t\t\t\t}, this));\n\n\t\t\t\tvar self = this;\n\t\t\t\tthis.codemirror.$textarea.next('.CodeMirror').each(function(i, el)\n\t\t\t\t{\n\t\t\t\t\t$(el).show();\n\t\t\t\t\tel.CodeMirror.setValue(code);\n\t\t\t\t\tel.CodeMirror.setSize('100%', height);\n\t\t\t\t\tel.CodeMirror.refresh();\n\n\t\t\t\t\tif (self.codemirror.start === self.codemirror.end)\n\t\t\t\t\t{\n\t\t\t\t\t\tel.CodeMirror.setCursor(el.CodeMirror.posFromIndex(self.codemirror.start).line, el.CodeMirror.posFromIndex(self.codemirror.end).ch);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tel.CodeMirror.setSelection({line: el.CodeMirror.posFromIndex(self.codemirror.start).line,\n\t\t\t\t\t\t\t\t\t\t\t\t\tch: el.CodeMirror.posFromIndex(self.codemirror.start).ch},\n\t\t\t\t\t\t\t\t\t\t\t\t  {line: el.CodeMirror.posFromIndex(self.codemirror.end).line,\n\t\t\t\t\t\t\t\t\t\t\t\t   ch:  el.CodeMirror.posFromIndex(self.codemirror.end).ch});\n\t\t\t\t\t}\n\n\t\t\t\t\tel.CodeMirror.focus();\n\t\t\t\t});\n\n\t\t\t},\n\t\t\tenlargeOffset: function(html, offset)\n\t\t\t{\n\t\t\t\tvar htmlLength = html.length;\n\t\t\t\tvar c = 0;\n\n\t\t\t\tif (html[offset] === '>')\n\t\t\t\t{\n\t\t\t\t\tc++;\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tfor(var i = offset; i <= htmlLength; i++)\n\t\t\t\t\t{\n\t\t\t\t\t\tc++;\n\n\t\t\t\t\t\tif (html[i] === '>')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (html[i] === '<' || i === htmlLength)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tc = 0;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\treturn offset + c;\n\t\t\t}\n\t\t};\n\t};\n})(jQuery);","(function($)\n{\n\t$.Redactor.prototype.filemanager = function()\n\t{\n\t\treturn {\n\t\t\tlangs: {\n\t\t\t\ten: {\n\t\t\t\t\t\"upload\": \"Upload\",\n\t\t\t\t\t\"choose\": \"Choose\"\n\t\t\t\t}\n\t\t\t},\n\t\t\tinit: function()\n\t\t\t{\n\t\t\t\tif (!this.opts.fileManagerJson)\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthis.modal.addCallback('file', this.filemanager.load);\n\t\t\t},\n\t\t\tload: function()\n\t\t\t{\n\t\t\t\tvar $box = $('<div  style=\"overflow: auto; height: 300px; display: none;\" class=\"redactor-modal-tab\" data-title=\"Choose\">').hide();\n\t\t\t\tthis.modal.getModal().append($box);\n\n\n\t\t\t\t$.ajax({\n\t\t\t\t  dataType: \"json\",\n\t\t\t\t  cache: false,\n\t\t\t\t  url: this.opts.fileManagerJson,\n\t\t\t\t  success: $.proxy(function(data)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar ul = $('<ul id=\"redactor-modal-list\">');\n\t\t\t\t\t\t$.each(data, $.proxy(function(key, val)\n\t\t\t\t\t\t{\n\n\t\t\t\t\t\t\tvar a = $('<a href=\"#\" data-params=\"' + encodeURI(JSON.stringify(val)) + '\" class=\"redactor-file-manager-link\">' + val.title + ' <span style=\"font-size: 11px; color: #888;\">' + val.name + '</span> <span style=\"position: absolute; right: 10px; font-size: 11px; color: #888;\">(' + val.size + ')</span></a>');\n\t\t\t\t\t\t\tvar li = $('<li />');\n\n\t\t\t\t\t\t\ta.on('click', $.proxy(this.filemanager.insert, this));\n\n\t\t\t\t\t\t\tli.append(a);\n\t\t\t\t\t\t\tul.append(li);\n\n\t\t\t\t\t\t}, this));\n\n\t\t\t\t\t\t$box.append(ul);\n\n\n\t\t\t\t\t}, this)\n\t\t\t\t});\n\n\t\t\t},\n\t\t\tinsert: function(e)\n\t\t\t{\n\t\t\t\te.preventDefault();\n\n\t\t\t\tvar $el = $(e.target).closest('.redactor-file-manager-link');\n\t\t\t\tvar json = $.parseJSON(decodeURI($el.attr('data-params')));\n\n\t\t\t\tthis.file.insert(json, null);\n\t\t\t}\n\t\t};\n\t};\n})(jQuery);","(function($)\n{\n\t$.Redactor.prototype.fullscreen = function()\n\t{\n\t\treturn {\n\t\t\tlangs: {\n\t\t\t\ten: {\n\t\t\t\t\t\"fullscreen\": \"Fullscreen\"\n\t\t\t\t}\n\t\t\t},\n\t\t\tinit: function()\n\t\t\t{\n\t\t\t\tthis.fullscreen.isOpen = false;\n\n\t\t\t\tvar button = this.button.add('fullscreen', this.lang.get('fullscreen'));\n\t\t\t\tthis.button.addCallback(button, this.fullscreen.toggle);\n\n\t\t\t\tif (this.opts.fullscreen)\n\t\t\t\t{\n\t\t\t\t\tthis.fullscreen.toggle();\n\t\t\t\t}\n\n\t\t\t},\n\t\t\tenable: function()\n\t\t\t{\n\t\t\t\tthis.fullscreen.isOpened = false;\n\t\t\t\tthis.button.setActive('fullscreen');\n\t\t\t\tthis.fullscreen.isOpen = true;\n\n\t\t\t\tif (!this.opts.fullscreen)\n\t\t\t\t{\n\t\t\t\t\tthis.selection.save();\n\t\t\t\t}\n\n\t\t\t\tif (this.opts.toolbarExternal)\n\t\t\t\t{\n\t\t\t\t\tthis.fullscreen.toolcss = {};\n\t\t\t\t\tthis.fullscreen.boxcss = {};\n\t\t\t\t\tthis.fullscreen.toolcss.width = this.$toolbar.css('width');\n\t\t\t\t\tthis.fullscreen.toolcss.top = this.$toolbar.css('top');\n\t\t\t\t\tthis.fullscreen.toolcss.position = this.$toolbar.css('position');\n\t\t\t\t\tthis.fullscreen.boxcss.top = this.$box.css('top');\n\t\t\t\t}\n\n\t\t\t\tthis.fullscreen.height = this.core.editor().height();\n\n\t\t\t\tif (this.opts.maxHeight)\n\t\t\t\t{\n\t\t\t\t\tthis.core.editor().css('max-height', '');\n\t\t\t\t}\n\n\t\t\t\tif (this.opts.minHeight)\n\t\t\t\t{\n\t\t\t\t\tthis.core.editor().css('min-height', '');\n\t\t\t\t}\n\n\t\t\t\tif (!this.$fullscreenPlaceholder)\n\t\t\t\t{\n\t\t\t\t\tthis.$fullscreenPlaceholder = $('<div/>');\n\t\t\t\t}\n\n\t\t\t\tthis.$fullscreenPlaceholder.insertAfter(this.$box);\n\n\t\t\t\tthis.core.box().appendTo(document.body);\n\t\t\t\tthis.core.box().addClass('redactor-box-fullscreen');\n\n\t\t\t\t$('body').addClass('redactor-body-fullscreen');\n\t\t\t\t$('body, html').css('overflow', 'hidden');\n\n\t\t\t\tthis.fullscreen.resize();\n\n\t\t\t\tif (!this.opts.fullscreen)\n\t\t\t\t{\n\t\t\t\t\tthis.selection.restore();\n\t\t\t\t}\n\n\t\t\t\tthis.toolbar.observeScrollDisable();\n\t\t\t\t$(window).on('resize.redactor-plugin-fullscreen', $.proxy(this.fullscreen.resize, this));\n\t\t\t\t$(document).scrollTop(0, 0);\n\n\t\t\t\tvar self = this;\n\t\t\t\tsetTimeout(function()\n\t\t\t\t{\n\t\t\t\t\tself.fullscreen.isOpened = true;\n\t\t\t\t}, 10);\n\n\t\t\t},\n\t\t\tdisable: function()\n\t\t\t{\n\t\t\t\tthis.button.setInactive('fullscreen');\n\t\t\t\tthis.fullscreen.isOpened = undefined;\n\t\t\t\tthis.fullscreen.isOpen = false;\n\t\t\t\tthis.selection.save();\n\n\t\t\t\t$(window).off('resize.redactor-plugin-fullscreen');\n\t\t\t\t$('body, html').css('overflow', '');\n\n\t\t\t\tthis.core.box().insertBefore(this.$fullscreenPlaceholder);\n\t\t\t\tthis.$fullscreenPlaceholder.remove();\n\n\t\t\t\tthis.core.box().removeClass('redactor-box-fullscreen').css({ width: 'auto', height: 'auto' });\n\t\t\t\tthis.core.box().removeClass('redactor-box-fullscreen');\n\n\t\t\t\tif (this.opts.toolbarExternal)\n\t\t\t\t{\n\t\t\t\t\tthis.core.box().css('top', this.fullscreen.boxcss.top);\n\t\t\t\t\tthis.core.toolbar().css({\n\t\t\t\t\t\t'width': this.fullscreen.toolcss.width,\n\t\t\t\t\t\t'top': this.fullscreen.toolcss.top,\n\t\t\t\t\t\t'position': this.fullscreen.toolcss.position\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tif (this.opts.minHeight)\n\t\t\t\t{\n\t\t\t\t\tthis.core.editor().css('minHeight', this.opts.minHeight);\n\t\t\t\t}\n\n\t\t\t\tif (this.opts.maxHeight)\n\t\t\t\t{\n\t\t\t\t\tthis.core.editor().css('maxHeight', this.opts.maxHeight);\n\t\t\t\t}\n\n\t\t\t\tthis.core.editor().css('height', 'auto');\n\t\t\t\tthis.selection.restore();\n\t\t\t},\n\t\t\ttoggle: function()\n\t\t\t{\n\t\t\t\treturn (this.fullscreen.isOpen) ? this.fullscreen.disable() : this.fullscreen.enable();\n\t\t\t},\n\t\t\tresize: function()\n\t\t\t{\n\t\t\t\tif (!this.fullscreen.isOpen)\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tvar toolbarHeight = this.button.toolbar().height();\n\t\t\t\tvar padding = parseInt(this.core.editor().css('padding-top')) + parseInt(this.core.editor().css('padding-bottom'));\n\t\t\t\tvar height = $(window).height() - toolbarHeight - padding;\n\n\t\t\t\tthis.core.box().width($(window).width()).height(height);\n\n\t\t\t\tif (this.opts.toolbarExternal)\n\t\t\t\t{\n\t\t\t\t\tthis.core.toolbar().css({\n\t\t\t\t\t\t'top': '0px',\n\t\t\t\t\t\t'position': 'absolute',\n\t\t\t\t\t\t'width': '100%'\n\t\t\t\t\t});\n\n\t\t\t\t\tthis.core.box().css('top', toolbarHeight + 'px');\n\t\t\t\t}\n\n\t\t\t\tthis.core.editor().height(height);\n\t\t\t}\n\t\t};\n\t};\n})(jQuery);","(function($)\n{\n\t$.Redactor.prototype.imagemanager = function()\n\t{\n\t\treturn {\n\t\t\tlangs: {\n\t\t\t\ten: {\n\t\t\t\t\t\"upload\": \"Upload\",\n\t\t\t\t\t\"choose\": \"Choose\"\n\t\t\t\t}\n\t\t\t},\n\t\t\tinit: function()\n\t\t\t{\n\t\t\t\tif (!this.opts.imageManagerJson)\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthis.modal.addCallback('image', this.imagemanager.load);\n\t\t\t},\n\t\t\tload: function()\n\t\t\t{\n\t\t\t\tvar $box = $('<div style=\"overflow: auto; height: 300px; display: none;\" class=\"redactor-modal-tab\" data-title=\"Choose\">');\n\t\t\t\tthis.modal.getModal().append($box);\n\n\t\t\t\t$.ajax({\n\t\t\t\t\tdataType: \"json\",\n\t\t\t\t\tcache: false,\n\t\t\t\t\turl: this.opts.imageManagerJson,\n\t\t\t\t\tsuccess: $.proxy(function(data)\n\t\t\t\t\t{\n\t\t\t\t\t\t$.each(data, $.proxy(function(key, val)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t// title\n\t\t\t\t\t\t\tvar thumbtitle = '';\n\t\t\t\t\t\t\tif (typeof val.title !== 'undefined')\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tthumbtitle = val.title;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tvar img = $('<img src=\"' + val.thumb + '\"  data-params=\"' + encodeURI(JSON.stringify(val)) + '\" style=\"width: 100px; height: 75px; cursor: pointer;\" />');\n\t\t\t\t\t\t\t$box.append(img);\n\t\t\t\t\t\t\t$(img).click($.proxy(this.imagemanager.insert, this));\n\n\t\t\t\t\t\t}, this));\n\n\t\t\t\t\t}, this)\n\t\t\t\t});\n\n\n\t\t\t},\n\t\t\tinsert: function(e)\n\t\t\t{\n\t\t\t\tvar $el = $(e.target);\n\t\t\t\tvar json = $.parseJSON(decodeURI($el.attr('data-params')));\n\t\t\t\tthis.image.insert(json, null);\n\t\t\t}\n\t\t};\n\t};\n})(jQuery);","(function($)\n{\n\t$.Redactor.prototype.inlinestyle = function()\n\t{\n\t\treturn {\n\t\t\tlangs: {\n\t\t\t\ten: {\n\t\t\t\t\t\"style\": \"Style\"\n\t\t\t\t}\n\t\t\t},\n\t\t\tinit: function()\n\t\t\t{\n\t\t\t\tvar tags = {\n\t\t\t\t\t\"marked\": {\n\t\t\t\t\t\ttitle: \"Marked\",\n\t\t\t\t\t\targs: ['mark']\n\t\t\t\t\t},\n\t\t\t\t\t\"code\": {\n\t\t\t\t\t\ttitle: \"Code\",\n\t\t\t\t\t\targs: ['code']\n\t\t\t\t\t},\n\t\t\t\t\t\"sample\": {\n\t\t\t\t\t\ttitle: \"Sample\",\n\t\t\t\t\t\targs: ['samp']\n\t\t\t\t\t},\n\t\t\t\t\t\"variable\": {\n\t\t\t\t\t\ttitle: \"Variable\",\n\t\t\t\t\t\targs: ['var']\n\t\t\t\t\t},\n\t\t\t\t\t\"shortcut\": {\n\t\t\t\t\t\ttitle: \"Shortcut\",\n\t\t\t\t\t\targs: ['kbd']\n\t\t\t\t\t},\n\t\t\t\t\t\"cite\": {\n\t\t\t\t\t\ttitle: \"Cite\",\n\t\t\t\t\t\targs: ['cite']\n\t\t\t\t\t},\n\t\t\t\t\t\"sup\": {\n\t\t\t\t\t\ttitle: \"Superscript\",\n\t\t\t\t\t\targs: ['sup']\n\t\t\t\t\t},\n\t\t\t\t\t\"sub\": {\n\t\t\t\t\t\ttitle: \"Subscript\",\n\t\t\t\t\t\targs: ['sub']\n\t\t\t\t\t}\n\t\t\t\t};\n\n\n\t\t\t\tvar that = this;\n\t\t\t\tvar dropdown = {};\n\n\t\t\t\t$.each(tags, function(i, s)\n\t\t\t\t{\n\t\t\t\t\tdropdown[i] = { title: s.title, func: 'inline.format', args: s.args };\n\t\t\t\t});\n\n\n\t\t\t\tvar button = this.button.addAfter('format', 'inline', this.lang.get('style'));\n\t\t\t\tthis.button.addDropdown(button, dropdown);\n\n\t\t\t}\n\n\n\t\t};\n\t};\n})(jQuery);","(function($)\n{\n\t$.Redactor.prototype.source = function()\n\t{\n\t\treturn {\n\t\t\tinit: function()\n\t\t\t{\n\t\t\t\tvar button = this.button.addFirst('html', 'HTML');\n\t\t\t\tthis.button.addCallback(button, this.source.toggle);\n\n\t\t\t\tvar style = {\n\t\t\t\t\t'width': '100%',\n\t\t\t\t\t'margin': '0',\n\t\t\t\t\t'background': '#111',\n\t\t\t\t\t'box-sizing': 'border-box',\n\t\t\t\t\t'color': 'rgba(255, 255, 255, .8)',\n\t\t\t\t\t'font-size': '14px',\n\t\t\t\t\t'outline': 'none',\n\t\t\t\t\t'padding': '16px',\n\t\t\t\t\t'line-height': '22px',\n\t\t\t\t\t'font-family': 'Menlo, Monaco, Consolas, \"Courier New\", monospace'\n\t\t\t\t};\n\n\t\t\t\tthis.source.$textarea = $('<textarea />');\n\t\t\t\tthis.source.$textarea.css(style).hide();\n\n\t\t\t\tif (this.opts.type === 'textarea')\n\t\t\t\t{\n\t\t\t\t\tthis.core.box().append(this.source.$textarea);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tthis.core.box().after(this.source.$textarea);\n\t\t\t\t}\n\n\t\t\t\tthis.core.element().on('destroy.callback.redactor', $.proxy(function()\n\t\t\t\t{\n\t\t\t\t\tthis.source.$textarea.remove();\n\n\t\t\t\t}, this));\n\n\t\t\t},\n\t\t\ttoggle: function()\n\t\t\t{\n\t\t\t\treturn (this.source.$textarea.hasClass('open')) ? this.source.hide() : this.source.show();\n\t\t\t},\n\t\t\tsetCaretOnShow: function()\n\t\t\t{\n\t\t\t\tthis.source.offset = this.offset.get();\n\t\t\t\tvar scroll = $(window).scrollTop();\n\n\t\t\t\tvar\twidth = this.core.editor().innerWidth();\n\t\t\t\tvar height = this.core.editor().innerHeight();\n\n\t\t\t\t// caret position sync\n\t\t\t\tthis.source.start = 0;\n\t\t\t\tthis.source.end = 0;\n\t\t\t\tvar $editorDiv = $(\"<div/>\").append($.parseHTML(this.core.editor().html(), document, true));\n\t\t\t\tvar $selectionMarkers = $editorDiv.find(\"span.redactor-selection-marker\");\n\n\t\t\t\tif ($selectionMarkers.length > 0)\n\t\t\t\t{\n\t\t\t\t\tvar editorHtml = $editorDiv.html().replace(/&amp;/g, '&');\n\n\t\t\t\t\tif ($selectionMarkers.length === 1)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.source.start = this.utils.strpos(editorHtml, $editorDiv.find(\"#selection-marker-1\").prop(\"outerHTML\"));\n\t\t\t\t\t\tthis.source.end = this.source.start;\n\t\t\t\t\t}\n\t\t\t\t\telse if ($selectionMarkers.length === 2)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.source.start = this.utils.strpos(editorHtml, $editorDiv.find(\"#selection-marker-1\").prop(\"outerHTML\"));\n\t\t\t\t\t\tthis.source.end = this.utils.strpos(editorHtml, $editorDiv.find(\"#selection-marker-2\").prop(\"outerHTML\")) - $editorDiv.find(\"#selection-marker-1\").prop(\"outerHTML\").toString().length;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t},\n\t\t\tsetCaretOnHide: function(html)\n\t\t\t{\n\t\t\t    this.source.start = this.source.$textarea.get(0).selectionStart;\n\t\t\t\tthis.source.end = this.source.$textarea.get(0).selectionEnd;\n\n\t\t\t\t// if selection starts from end\n\t\t\t\tif (this.source.start > this.source.end && this.source.end > 0)\n\t\t\t\t{\n\t\t\t\t\tvar tempStart = this.source.end;\n\t\t\t\t\tvar tempEnd = this.source.start;\n\n\t\t\t\t\tthis.source.start = tempStart;\n\t\t\t\t\tthis.source.end = tempEnd;\n\t\t\t\t}\n\n\t\t\t\tthis.source.start = this.source.enlargeOffset(html, this.source.start);\n\t\t\t\tthis.source.end = this.source.enlargeOffset(html, this.source.end);\n\n\t\t\t\thtml = html.substr(0, this.source.start) + this.marker.html(1) + html.substr(this.source.start);\n\n\t\t\t\tif (this.source.end > this.source.start)\n\t\t\t\t{\n\t\t\t\t\tvar markerLength = this.marker.html(1).toString().length;\n\n\t\t\t\t\thtml = html.substr(0, this.source.end + markerLength) + this.marker.html(2) + html.substr(this.source.end + markerLength);\n\t\t\t\t}\n\n\n\t\t\t\treturn html;\n\n\t\t\t},\n\t\t\thide: function()\n\t\t\t{\n\t\t\t\tthis.source.$textarea.removeClass('open').hide();\n\t\t\t\tthis.source.$textarea.off('.redactor-source');\n\n\t\t\t\tvar code = this.source.$textarea.val();\n\n\t\t\t\tcode = this.paragraphize.load(code);\n\t\t\t\tcode = this.source.setCaretOnHide(code);\n\n\t\t\t\tthis.code.start(code);\n\t\t\t\tthis.button.enableAll();\n\t\t\t\tthis.core.editor().show().focus();\n\t\t\t\tthis.selection.restore();\n\n                this.core.callback('visual');\n\t\t\t},\n\t\t\tshow: function()\n\t\t\t{\n\t\t\t\tthis.selection.save();\n\t\t\t\tthis.source.setCaretOnShow();\n\n\t\t\t\tvar height = this.core.editor().innerHeight();\n\t\t\t\tvar code = this.code.get();\n\n                // callback\n                code = this.core.callback('source', code);\n\n\t\t\t\tthis.core.editor().hide();\n\t\t\t\tthis.button.disableAll('html');\n\t\t\t\tthis.source.$textarea.val(code).height(height).addClass('open').show();\n\t\t\t\tthis.source.$textarea.on('keyup.redactor-source', $.proxy(function()\n\t\t\t\t{\n\t\t\t\t\tif (this.opts.type === 'textarea')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.core.textarea().val(this.source.$textarea.val());\n\t\t\t\t\t}\n\n\t\t\t\t}, this));\n\n\t\t\t\tthis.marker.remove();\n\n\t\t\t\t$(window).scrollTop(scroll);\n\n\t\t\t\tif (this.source.$textarea[0].setSelectionRange)\n\t\t\t\t{\n\t\t\t\t\tthis.source.$textarea[0].setSelectionRange(this.source.start, this.source.end);\n\t\t\t\t}\n\n\t\t\t\tthis.source.$textarea[0].scrollTop = 0;\n\n\t\t\t\tsetTimeout($.proxy(function()\n\t\t\t\t{\n\t\t\t\t\tthis.source.$textarea.focus();\n\n\t\t\t\t}, this), 0);\n\t\t\t},\n\t\t\tenlargeOffset: function(html, offset)\n\t\t\t{\n\t\t\t\tvar htmlLength = html.length;\n\t\t\t\tvar c = 0;\n\n\t\t\t\tif (html[offset] === '>')\n\t\t\t\t{\n\t\t\t\t\tc++;\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tfor(var i = offset; i <= htmlLength; i++)\n\t\t\t\t\t{\n\t\t\t\t\t\tc++;\n\n\t\t\t\t\t\tif (html[i] === '>')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (html[i] === '<' || i === htmlLength)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tc = 0;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\treturn offset + c;\n\t\t\t}\n\t\t};\n\t};\n})(jQuery);","(function($)\n{\n\t$.Redactor.prototype.table = function()\n\t{\n\t\treturn {\n\t\t\tlangs: {\n\t\t\t\ten: {\n\t\t\t\t\t\"table\": \"Table\",\n\t\t\t\t\t\"insert-table\": \"Insert table\",\n\t\t\t\t\t\"insert-row-above\": \"Insert row above\",\n\t\t\t\t\t\"insert-row-below\": \"Insert row below\",\n\t\t\t\t\t\"insert-column-left\": \"Insert column left\",\n\t\t\t\t\t\"insert-column-right\": \"Insert column right\",\n\t\t\t\t\t\"add-head\": \"Add head\",\n\t\t\t\t\t\"delete-head\": \"Delete head\",\n\t\t\t\t\t\"delete-column\": \"Delete column\",\n\t\t\t\t\t\"delete-row\": \"Delete row\",\n\t\t\t\t\t\"delete-table\": \"Delete table\"\n\t\t\t\t}\n\t\t\t},\n\t\t\tinit: function()\n\t\t\t{\n\t\t\t\tvar dropdown = {};\n\n\t\t\t\tdropdown.insert_table = {\n\t\t\t\t\ttitle: this.lang.get('insert-table'),\n\t\t\t\t\tfunc: this.table.insert,\n\t\t\t\t\tobserve: {\n\t\t\t\t\t\telement: 'table',\n\t\t\t\t\t\tin: {\n\t\t\t\t\t\t\tattr: {\n\t\t\t\t\t\t\t\t'class': 'redactor-dropdown-link-inactive',\n\t\t\t\t\t\t\t\t'aria-disabled': true,\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\tdropdown.insert_row_above = {\n\t\t\t\t\ttitle: this.lang.get('insert-row-above'),\n\t\t\t\t\tfunc: this.table.addRowAbove,\n\t\t\t\t\tobserve: {\n\t\t\t\t\t\telement: 'table',\n\t\t\t\t\t\tout: {\n\t\t\t\t\t\t\tattr: {\n\t\t\t\t\t\t\t\t'class': 'redactor-dropdown-link-inactive',\n\t\t\t\t\t\t\t\t'aria-disabled': true,\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\tdropdown.insert_row_below = {\n\t\t\t\t\ttitle: this.lang.get('insert-row-below'),\n\t\t\t\t\tfunc: this.table.addRowBelow,\n\t\t\t\t\tobserve: {\n\t\t\t\t\t\telement: 'table',\n\t\t\t\t\t\tout: {\n\t\t\t\t\t\t\tattr: {\n\t\t\t\t\t\t\t\t'class': 'redactor-dropdown-link-inactive',\n\t\t\t\t\t\t\t\t'aria-disabled': true,\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\tdropdown.insert_column_left = {\n\t\t\t\t\ttitle: this.lang.get('insert-column-left'),\n\t\t\t\t\tfunc: this.table.addColumnLeft,\n\t\t\t\t\tobserve: {\n\t\t\t\t\t\telement: 'table',\n\t\t\t\t\t\tout: {\n\t\t\t\t\t\t\tattr: {\n\t\t\t\t\t\t\t\t'class': 'redactor-dropdown-link-inactive',\n\t\t\t\t\t\t\t\t'aria-disabled': true,\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\tdropdown.insert_column_right = {\n\t\t\t\t\ttitle: this.lang.get('insert-column-right'),\n\t\t\t\t\tfunc: this.table.addColumnRight,\n\t\t\t\t\tobserve: {\n\t\t\t\t\t\telement: 'table',\n\t\t\t\t\t\tout: {\n\t\t\t\t\t\t\tattr: {\n\t\t\t\t\t\t\t\t'class': 'redactor-dropdown-link-inactive',\n\t\t\t\t\t\t\t\t'aria-disabled': true,\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\tdropdown.add_head = {\n\t\t\t\t\ttitle: this.lang.get('add-head'),\n\t\t\t\t\tfunc: this.table.addHead,\n\t\t\t\t\tobserve: {\n\t\t\t\t\t\telement: 'table',\n\t\t\t\t\t\tout: {\n\t\t\t\t\t\t\tattr: {\n\t\t\t\t\t\t\t\t'class': 'redactor-dropdown-link-inactive',\n\t\t\t\t\t\t\t\t'aria-disabled': true,\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\tdropdown.delete_head = {\n\t\t\t\t\ttitle: this.lang.get('delete-head'),\n\t\t\t\t\tfunc: this.table.deleteHead,\n\t\t\t\t\tobserve: {\n\t\t\t\t\t\telement: 'table',\n\t\t\t\t\t\tout: {\n\t\t\t\t\t\t\tattr: {\n\t\t\t\t\t\t\t\t'class': 'redactor-dropdown-link-inactive',\n\t\t\t\t\t\t\t\t'aria-disabled': true,\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\tdropdown.delete_column = {\n    \t\t\t\ttitle: this.lang.get('delete-column'),\n    \t\t\t\tfunc: this.table.deleteColumn,\n    \t\t\t\tobserve: {\n    \t\t\t\t\telement: 'table',\n    \t\t\t\t\tout: {\n    \t\t\t\t\t\tattr: {\n    \t\t\t\t\t\t\t'class': 'redactor-dropdown-link-inactive',\n    \t\t\t\t\t\t\t'aria-disabled': true,\n    \t\t\t\t\t\t}\n    \t\t\t\t\t}\n    \t\t\t\t}\n    \t\t\t};\n\n\t\t\t\tdropdown.delete_row = {\n\t\t\t\t\ttitle: this.lang.get('delete-row'),\n\t\t\t\t\tfunc: this.table.deleteRow,\n\t\t\t\t\tobserve: {\n\t\t\t\t\t\telement: 'table',\n\t\t\t\t\t\tout: {\n\t\t\t\t\t\t\tattr: {\n\t\t\t\t\t\t\t\t'class': 'redactor-dropdown-link-inactive',\n\t\t\t\t\t\t\t\t'aria-disabled': true,\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\tdropdown.delete_table = {\n\t\t\t\t\ttitle: this.lang.get('delete-table'),\n\t\t\t\t\tfunc: this.table.deleteTable,\n\t\t\t\t\tobserve: {\n\t\t\t\t\t\telement: 'table',\n\t\t\t\t\t\tout: {\n\t\t\t\t\t\t\tattr: {\n\t\t\t\t\t\t\t\t'class': 'redactor-dropdown-link-inactive',\n\t\t\t\t\t\t\t\t'aria-disabled': true,\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t};\n\n\n\t\t\t\tvar button = this.button.addBefore('link', 'table', this.lang.get('table'));\n\t\t\t\tthis.button.addDropdown(button, dropdown);\n\t\t\t},\n\t\t\tinsert: function()\n\t\t\t{\n\t\t\t\tif (this.table.getTable())\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthis.placeholder.hide();\n\n\t\t\t\tvar rows = 2;\n\t\t\t\tvar columns = 3;\n\t\t\t\tvar $tableBox = $('<div>');\n\t\t\t\tvar $table = $('<table />');\n\n\n\t\t\t\tfor (var i = 0; i < rows; i++)\n\t\t\t\t{\n\t\t\t\t\tvar $row = $('<tr>');\n\n\t\t\t\t\tfor (var z = 0; z < columns; z++)\n\t\t\t\t\t{\n\t\t\t\t\t\tvar $column = $('<td>' + this.opts.invisibleSpace + '</td>');\n\n\t\t\t\t\t\t// set the focus to the first td\n\t\t\t\t\t\tif (i === 0 && z === 0)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$column.append(this.marker.get());\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t$($row).append($column);\n\t\t\t\t\t}\n\n\t\t\t\t\t$table.append($row);\n\t\t\t\t}\n\n\t\t\t\t$tableBox.append($table);\n\t\t\t\tvar html = $tableBox.html();\n\n\t\t\t\tthis.buffer.set();\n\n\t\t\t\tvar current = this.selection.current();\n\t\t\t\tif ($(current).closest('li', this.core.editor()[0]).length !== 0)\n\t\t\t\t{\n\t\t\t\t\t$(current).closest('ul, ol').first().after(html);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tthis.air.collapsed();\n\t\t\t\t\tthis.insert.html(html);\n\t\t\t\t}\n\n\t\t\t\tthis.selection.restore();\n\t\t\t\tthis.core.callback('insertedTable', $table);\n\t\t\t},\n\t\t\tgetTable: function()\n\t\t\t{\n\t\t\t\tvar $table = $(this.selection.current()).closest('table');\n\n\t\t\t\tif (!this.utils.isRedactorParent($table))\n\t\t\t\t{\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\tif ($table.size() === 0)\n\t\t\t\t{\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\treturn $table;\n\t\t\t},\n\t\t\trestoreAfterDelete: function($table)\n\t\t\t{\n\t\t\t\tthis.selection.restore();\n\t\t\t\t$table.find('span.redactor-selection-marker').remove();\n\n\t\t\t},\n\t\t\tdeleteTable: function()\n\t\t\t{\n\t\t\t\tvar $table = this.table.getTable();\n\t\t\t\tif (!$table)\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthis.buffer.set();\n\n\n\t\t\t\tvar $next = $table.next();\n\t\t\t\tif (!this.opts.linebreaks && $next.length !== 0)\n\t\t\t\t{\n\t\t\t\t\tthis.caret.start($next);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tthis.caret.after($table);\n\t\t\t\t}\n\n\n\t\t\t\t$table.remove();\n\n\n\t\t\t},\n\t\t\tdeleteRow: function()\n\t\t\t{\n\t\t\t\tvar $table = this.table.getTable();\n\t\t\t\tif (!$table)\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tvar $current = $(this.selection.current());\n\n\t\t\t\tthis.buffer.set();\n\n\t\t\t\tvar $current_tr = $current.closest('tr');\n\t\t\t\tvar $focus_tr = $current_tr.prev().length ? $current_tr.prev() : $current_tr.next();\n\t\t\t\tif ($focus_tr.length)\n\t\t\t\t{\n\t\t\t\t\tvar $focus_td = $focus_tr.children('td, th').first();\n\t\t\t\t\tif ($focus_td.length)\n\t\t\t\t\t{\n\t\t\t\t\t\t$focus_td.prepend(this.marker.get());\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t$current_tr.remove();\n\t\t\t\tthis.table.restoreAfterDelete($table);\n\t\t\t},\n\t\t\tdeleteColumn: function()\n\t\t\t{\n\t\t\t\tvar $table = this.table.getTable();\n\t\t\t\tif (!$table)\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthis.buffer.set();\n\n\t\t\t\tvar $current = $(this.selection.current());\n\t\t\t\tvar $current_td = $current.closest('td, th');\n\t\t\t\tvar index = $current_td[0].cellIndex;\n\n\t\t\t\t$table.find('tr').each($.proxy(function(i, elem)\n\t\t\t\t{\n\t\t\t\t\tvar $elem = $(elem);\n\t\t\t\t\tvar focusIndex = index - 1 < 0 ? index + 1 : index - 1;\n\t\t\t\t\tif (i === 0)\n\t\t\t\t\t{\n\t\t\t\t\t\t$elem.find('td, th').eq(focusIndex).prepend(this.marker.get());\n\t\t\t\t\t}\n\n\t\t\t\t\t$elem.find('td, th').eq(index).remove();\n\n\t\t\t\t}, this));\n\n\t\t\t\tthis.table.restoreAfterDelete($table);\n\t\t\t},\n\t\t\taddHead: function()\n\t\t\t{\n\t\t\t\tvar $table = this.table.getTable();\n\t\t\t\tif (!$table)\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthis.buffer.set();\n\n\t\t\t\tif ($table.find('thead').size() !== 0)\n\t\t\t\t{\n\t\t\t\t\tthis.table.deleteHead();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tvar tr = $table.find('tr').first().clone();\n\t\t\t\ttr.find('td').replaceWith($.proxy(function()\n\t\t\t\t{\n\t\t\t\t\treturn $('<th>').html(this.opts.invisibleSpace);\n\t\t\t\t}, this));\n\n\t\t\t\t$thead = $('<thead></thead>').append(tr);\n\t\t\t\t$table.prepend($thead);\n\n\n\n\t\t\t},\n\t\t\tdeleteHead: function()\n\t\t\t{\n\t\t\t\tvar $table = this.table.getTable();\n\t\t\t\tif (!$table)\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tvar $thead = $table.find('thead');\n\t\t\t\tif ($thead.size() === 0)\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthis.buffer.set();\n\n\t\t\t\t$thead.remove();\n\n\t\t\t},\n\t\t\taddRowAbove: function()\n\t\t\t{\n\t\t\t\tthis.table.addRow('before');\n\t\t\t},\n\t\t\taddRowBelow: function()\n\t\t\t{\n\t\t\t\tthis.table.addRow('after');\n\t\t\t},\n\t\t\taddColumnLeft: function()\n\t\t\t{\n\t\t\t\tthis.table.addColumn('before');\n\t\t\t},\n\t\t\taddColumnRight: function()\n\t\t\t{\n\t\t\t\tthis.table.addColumn('after');\n\t\t\t},\n\t\t\taddRow: function(type)\n\t\t\t{\n\t\t\t\tvar $table = this.table.getTable();\n\t\t\t\tif (!$table)\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthis.buffer.set();\n\n\t\t\t\tvar $current = $(this.selection.current());\n\t\t\t\tvar $current_tr = $current.closest('tr');\n\t\t\t\tvar new_tr = $current_tr.clone();\n\n\t\t\t\tnew_tr.find('th').replaceWith(function()\n\t\t\t\t{\n\t\t\t\t\tvar $td = $('<td>');\n\t\t\t\t\t$td[0].attributes = this.attributes;\n\n\t\t\t\t\treturn $td.append($(this).contents());\n\t\t\t\t});\n\n\t\t\t\tnew_tr.find('td').html(this.opts.invisibleSpace);\n\n\t\t\t\tif (type === 'after')\n\t\t\t\t{\n\t\t\t\t\t$current_tr.after(new_tr);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t$current_tr.before(new_tr);\n\t\t\t\t}\n\n\n\t\t\t},\n\t\t\taddColumn: function (type)\n\t\t\t{\n\t\t\t\tvar $table = this.table.getTable();\n\t\t\t\tif (!$table)\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tvar index = 0;\n\t\t\t\tvar current = $(this.selection.current());\n\n\t\t\t\tthis.buffer.set();\n\n\t\t\t\tvar $current_tr = current.closest('tr');\n\t\t\t\tvar $current_td = current.closest('td, th');\n\n\t\t\t\t$current_tr.find('td, th').each($.proxy(function(i, elem)\n\t\t\t\t{\n\t\t\t\t\tif ($(elem)[0] === $current_td[0])\n\t\t\t\t\t{\n\t\t\t\t\t\tindex = i;\n\t\t\t\t\t}\n\n\t\t\t\t}, this));\n\n\t\t\t\t$table.find('tr').each($.proxy(function(i, elem)\n\t\t\t\t{\n\t\t\t\t\tvar $current = $(elem).find('td, th').eq(index);\n\n\t\t\t\t\tvar td = $current.clone();\n\t\t\t\t\ttd.html(this.opts.invisibleSpace);\n\n\t\t\t\t\tif (type === 'after')\n\t\t\t\t\t{\n\t\t\t\t\t\t$current.after(td);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\t$current.before(td);\n\t\t\t\t\t}\n\n\t\t\t\t}, this));\n\n\n\t\t\t}\n\t\t};\n\t};\n})(jQuery);"],"sourceRoot":"/source/"}